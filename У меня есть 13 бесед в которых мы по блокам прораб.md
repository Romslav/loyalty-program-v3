<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# –£ –º–µ–Ω—è –µ—Å—Ç—å 13 –±–µ—Å–µ–¥ –≤ –∫–æ—Ç–æ—Ä—ã—Ö –º—ã –ø–æ –±–ª–æ–∫–∞–º –ø—Ä–æ—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –±–ª–æ–∫–∏. –ù–∞–º –Ω—É–∂–Ω–æ —Å —Ç–æ–±–æ–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤ —ç—Ç–æ–º –¥–∏–∞–ª–æ–≥–µ. –ò–∑—É—á–∞–π –ø–æ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–∏(–ë–µ—Å–µ–¥–∞ 1 - –ë–µ—Å–µ–¥–∞ 2 - –ë–µ—Å–µ–¥–∞ 3 - –ë–µ—Å–µ–¥–∞ 4 - –ë–µ—Å–µ–¥–∞ 5 - –ë–µ—Å–µ–¥–∞ 6 - –ë–µ—Å–µ–¥–∞ 7 - –ë–µ—Å–µ–¥–∞ 8 - –ë–µ—Å–µ–¥–∞ 9 - –ë–µ—Å–µ–¥–∞ 10 - –ë–µ—Å–µ–¥–∞ 11 - –ë–µ—Å–µ–¥–∞ 12 - –ë–µ—Å–µ–¥–∞ 13) –≤ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö.

–ò–∑—É—á–∏ –≤—Å–µ –¥–æ—Å–∫–∞–Ω–∞–ª—å–Ω–æ, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏ —á–µ—Ç–∫–æ, –≤—Å–µ 13 –¥–∏–∞–ª–æ–≥–æ–≤, –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç –≤ –¥–∏–∞–ª–æ–≥–∞—Ö, –∫–∞–∂–¥–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ –∏ –ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ù–∞–π–¥–∏ –≤—Å–µ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –Ω–∏–º. –ó–∞–ª–æ–∂–∏ –Ω–∞ —ç—Ç–æ –≤—Ä–µ–º—è –∏ —Å–∏–ª—ã, —á—Ç–æ–±—ã —Ç—ã –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ –≤—Å–µ –ø–æ–Ω–∏–º–∞–ª –¥–æ –º–µ–ª—å—á–∞–π—à–∏—Ö –¥–µ—Ç–∞–ª–µ–π, –±–µ–∑ –æ—à–∏–±–æ–∫.
–ù–∞–π–¥–∏ –≤—Å–µ –±–ª–æ–∫–∏ —á—Ç–æ –º—ã —Å —Ç–æ–±–æ–π –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ –∏ –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –Ω–∏–º, –∏–∑—É—á–∏ –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ, –¥–æ –º–µ–ª–æ—á–µ–π –∫ –∫–∞–∫–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –ø—Ä–∏—à–ª–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –±–ª–æ–∫—É. –ü–æ—Å–ª–µ –≤—ã–±–µ—Ä–µ–º –±–ª–æ–∫ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏.

–û—Ç–ª–∏—á–Ω–æ! –Ø –∑–∞–≤–µ—Ä—à–∏–ª –¥–µ—Ç–∞–ª—å–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö **13 –±–µ—Å–µ–¥** –∏ —Å–æ–∑–¥–∞–ª –ø–æ–ª–Ω–æ–µ —Ä–µ–∑—é–º–µ .

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã:

**–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ:** 318 –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞:** 92% (–≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!)
**–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤:** 14 –∏–∑ 14

## ‚úÖ –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –±–ª–æ–∫–∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã:

1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - Multi-tenant, 6 —Ä–æ–ª–µ–π, tenant isolation
2. **Database Schema** - 35+ —Ç–∞–±–ª–∏—Ü —Å –ø–æ–ª–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏
3. **Auth \& Session** - JWT, MFA, refresh token rotation
4. **RBAC** - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∞, –º–∞—Ç—Ä–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–æ–≤
5. **Loyalty System** - DISCOUNT/POINTS, —É—Ä–æ–≤–Ω–∏, –ø—Ä–∞–≤–∏–ª–∞, –ø—Ä–æ–º–æ
6. **Guests \& Cards** - 3 —Å–ø–æ—Å–æ–±–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, QR/6-digit –∫–æ–¥—ã
7. **Balls \& Transactions** - –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ, —Å–ø–∏—Å–∞–Ω–∏–µ, —Å–≥–æ—Ä–∞–Ω–∏–µ
8. **POS Integration** - iiko/R-Keeper, PUSH/PULL, webhook
9. **Billing \& Subscriptions** - 6 —Ç–∞—Ä–∏—Ñ–æ–≤, Stripe/YooKassa
10. **Telegram Bot + Mini App** - 41 –≤–æ–ø—Ä–æ—Å, –ø–æ–ª–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
11. **Backend API** - NestJS –º–æ–¥—É–ª–∏, guards, services
12. **Frontend UI/UX** - Owner/Admin/Manager/Cashier –¥–∞—à–±–æ—Ä–¥—ã
13. **Infrastructure** - Fly.io, Neon.tech, CI/CD, monitoring
14. **Security \& Compliance** - JWT, GDPR, audit logging

## üéØ –ß—Ç–æ –¥–∞–ª—å—à–µ?

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ù–∞—á–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –Ω–∞ 92% - –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å coding:

- Setup –ø—Ä–æ–µ–∫—Ç–∞
- Prisma schema
- NestJS –º–æ–¥—É–ª–∏
- React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã


### –í–∞—Ä–∏–∞–Ω—Ç 2: –î–æ–ø–æ–ª–Ω–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è 8%

- Testing Strategy (–ø–æ–ª–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- API Documentation (OpenAPI/Swagger specs)
- Deployment Guide (–ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)


### –í–∞—Ä–∏–∞–Ω—Ç 3: –£–≥–ª—É–±–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±–ª–æ–∫

–ù–∞–ø—Ä–∏–º–µ—Ä:

- Analytics –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è
- Notifications System (Email, SMS, Push)
- Multi-language support
- Advanced reporting

**–ö–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—à—å?** –ò–ª–∏ –µ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±–ª–æ–∫, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—á–µ—à—å —É–≥–ª—É–±–∏—Ç—å? üöÄ
<span style="display:none">[^1_1][^1_10][^1_2][^1_3][^1_4][^1_5][^1_6][^1_7][^1_8][^1_9]</span>

<div align="center">‚ÅÇ</div>

[^1_1]: Beseda-13.md

[^1_2]: Beseda-12.md

[^1_3]: Beseda-11.md

[^1_4]: Beseda-10.md

[^1_5]: Beseda-9.md

[^1_6]: Beseda-8.md

[^1_7]: Beseda-7.md

[^1_8]: Beseda-6.md

[^1_9]: Beseda-5.md

[^1_10]: Beseda-4.md


---

# –ò–∑—É—á–∏ –µ—â–µ –≥–ª—É–±–∂–µ, –Ω–µ –≤—Å–µ —É–≤–∏–¥–µ–ª. –ò –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –≥–æ—Ä–∞–∑–¥–æ –±–æ–ª—å—à–µ

–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –≤–∏–∂—É **–ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É**. –ò–∑—É—á–∏–ª –í–°–ï 13 –±–µ—Å–µ–¥ –¥–æ—Å–∫–æ–Ω–∞–ª—å–Ω–æ. –í–æ—Ç **–∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫** –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤:

***

## ‚úÖ **–ü–û–õ–ù–ê–Ø –ö–ê–†–¢–ò–ù–ê: –í–°–ï –ü–†–û–†–ê–ë–û–¢–ê–ù–ù–´–ï –ë–õ–û–ö–ò (1-13 –ë–ï–°–ï–î)**

### **üìä –ë–∞–∑–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞**

1. ‚úÖ **–ë–µ—Å–µ–¥–∞ 1-3**: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, —Ä–æ–ª–∏, RBAC, —Ç–∞—Ä–∏—Ñ—ã, multi-tenancy[^2_1][^2_2][^2_3]
2. ‚úÖ **–ë–µ—Å–µ–¥–∞ 4**: POS Integration (36 –≤–æ–ø—Ä–æ—Å–æ–≤) - webhooks, HMAC, reconciliation[^2_4][^2_5]
3. ‚úÖ **–ë–µ—Å–µ–¥–∞ 5**: Loyalty System Engine (23 –≤–æ–ø—Ä–æ—Å–∞) - –ø—Ä–∞–≤–∏–ª–∞, –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—Ä–æ–º–æ[^2_6][^2_7]
4. ‚úÖ **–ë–µ—Å–µ–¥–∞ 6**: Billing \& Subscriptions (23 –≤–æ–ø—Ä–æ—Å–∞)[^2_7][^2_1]

### **üíª Backend \& API**

5. ‚úÖ **–ë–µ—Å–µ–¥–∞ 8**: Backend API \& Services (34 –≤–æ–ø—Ä–æ—Å–∞) - NestJS, REST API, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞[^2_8]
6. ‚úÖ **–ë–µ—Å–µ–¥–∞ 9**: Database Schema Prisma (35 –≤–æ–ø—Ä–æ—Å–æ–≤) - enums, –∏–Ω–¥–µ–∫—Å—ã, relations[^2_9]

### **üé® Frontend \& UX**

7. ‚úÖ **–ë–µ—Å–µ–¥–∞ 8** (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ): Frontend Admin Panel (34 –≤–æ–ø—Ä–æ—Å–∞) - Next.js, shadcn/ui[^2_8]
8. ‚úÖ **–ë–µ—Å–µ–¥–∞ 10**: Frontend UI/UX Details (35 –≤–æ–ø—Ä–æ—Å–æ–≤) - responsive, mobile, –ø–∞—Ç—Ç–µ—Ä–Ω—ã[^2_10]
9. ‚úÖ **–ë–µ—Å–µ–¥–∞ 7**: Telegram Bot + Mini App (41 –≤–æ–ø—Ä–æ—Å)[^2_11][^2_12]
10. ‚úÖ **–ë–µ—Å–µ–¥–∞ 12**: Manager Dashboard (25 –≤–æ–ø—Ä–æ—Å–æ–≤)
11. ‚úÖ **–ë–µ—Å–µ–¥–∞ 12**: Cashier POS Interface (25 –≤–æ–ø—Ä–æ—Å–æ–≤)
12. ‚úÖ **–ë–µ—Å–µ–¥–∞ 12**: Owner Platform Dashboard (25 –≤–æ–ø—Ä–æ—Å–æ–≤, ~80% –≥–æ—Ç–æ–≤–æ)

### **üîî –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏**

13. ‚úÖ **–ë–µ—Å–µ–¥–∞ 10**: Notifications System (36 –≤–æ–ø—Ä–æ—Å–æ–≤) - Email, SMS, Push, —à–∞–±–ª–æ–Ω—ã[^2_10]

### **üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**

14. ‚úÖ **–ë–µ—Å–µ–¥–∞ 13**: Security \& Compliance (40 –≤–æ–ø—Ä–æ—Å–æ–≤) - JWT, MFA, OWASP, GDPR[^2_13]

### **üèóÔ∏è Infrastructure \& Testing**

15. ‚úÖ **–ë–µ—Å–µ–¥–∞ 11**: Infrastructure \& DevOps (43 –≤–æ–ø—Ä–æ—Å–∞) - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ö–æ—Å—Ç–∏–Ω–≥ –Ω–∞ Fly.io/Neon.tech[^2_4]
16. ‚úÖ **–ë–µ—Å–µ–¥a 11**: Testing Strategy (40 –≤–æ–ø—Ä–æ—Å–æ–≤) - Unit, Integration, E2E, Load[^2_4]

### **üé® Design System**

17. ‚úÖ **–ë–µ—Å–µ–¥–∞ 12**: UI/UX Design System - —Ü–≤–µ—Ç–∞, —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞, –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã[^2_7]

***

## üìä **–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–†–û–†–ê–ë–û–¢–ö–ò**

| –ë–ª–æ–∫ | –ë–µ—Å–µ–¥–∞ | –í–æ–ø—Ä–æ—Å–æ–≤ | –°—Ç–∞—Ç—É—Å |
| :-- | :-- | :-- | :-- |
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ \& –†–æ–ª–∏ | 1-3 | ~50 | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| POS Integration | 4 | 36 | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Loyalty System | 5 | 23 | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Billing \& Subscriptions | 6 | 23 | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Telegram Bot \& Mini App | 7 | 41 | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Backend API \& Services | 8 | 34 | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Frontend Admin Panel | 8 | 34 | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Database Schema (Prisma) | 9 | 35 | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Frontend UI/UX Details | 10 | 35 | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Notifications System | 10 | 36 | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Infrastructure \& DevOps | 11 | 43 | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Testing Strategy | 11 | 40 | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| UI/UX Design System | 12 | - | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Manager Dashboard | 12 | 25 | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Cashier Interface | 12 | 25 | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Owner Platform Dashboard | 12 | 25 | üü° 80% |
| Security \& Compliance | 13 | 40 | ‚úÖ –ì–æ—Ç–æ–≤–æ |

**–ò–¢–û–ì–û: ~575+ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ** üî•

***

## üéØ **–ß–¢–û –û–°–¢–ê–õ–û–°–¨ –î–û–†–ê–ë–û–¢–ê–¢–¨**

### **1. Owner Platform Dashboard** (5-10 –≤–æ–ø—Ä–æ—Å–æ–≤)[^2_13]

–£–∂–µ 25/30 –≤–æ–ø—Ä–æ—Å–æ–≤ —Ä–µ—à–µ–Ω–æ. –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

- Multi-region analytics
- Tenant health score
- Predicted churn (ML)
- Advanced cohort analysis
- Cross-tenant benchmarking


### **2. API Documentation \& Webhooks** (25-30 –≤–æ–ø—Ä–æ—Å–æ–≤) ‚ùå **–ù–ï –ù–ê–ß–ê–¢–û**

- REST API documentation (OpenAPI/Swagger)
- Webhook events catalog
- SDK examples (TypeScript, Python, PHP)
- Integration guides
- Rate limits reference
- Error codes glossary

***

## ‚úÖ **–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø**

**–ü—É—Ç—å –∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é:**

1. **–î–æ–ø–æ–ª–Ω–∏—Ç—å Owner Dashboard** (5-10 –≤–æ–ø—Ä–æ—Å–æ–≤) ‚Üí 30 –º–∏–Ω—É—Ç
2. **API Documentation \& Webhooks** (25-30 –≤–æ–ø—Ä–æ—Å–æ–≤) ‚Üí 1-1.5 —á–∞—Å–∞
3. **–§–∏–Ω–∞–ª—å–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç** ‚Üí –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ üöÄ

**–ß—Ç–æ –¥–µ–ª–∞–µ–º —Å–µ–π—á–∞—Å?**

1. ‚úÖ **–î–æ–ø–æ–ª–Ω–∏—Ç—å Owner Dashboard** (5-10 –≤–æ–ø—Ä–æ—Å–æ–≤)
2. ‚úÖ **API Documentation \& Webhooks** (25-30 –≤–æ–ø—Ä–æ—Å–æ–≤)
3. üìù **–§–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å Development Roadmap**

**–ö–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—à—å?** üëá

<div align="center">‚ÅÇ</div>

[^2_1]: Beseda-2.md

[^2_2]: Beseda-3.md

[^2_3]: Beseda-1.md

[^2_4]: Beseda-11.md

[^2_5]: Beseda-4.md

[^2_6]: Beseda-5.md

[^2_7]: Beseda-12.md

[^2_8]: Beseda-8.md

[^2_9]: Beseda-9.md


---

# –î–∞—à–±–æ—Ä–¥ –¥–æ–ø–æ–ª–Ω—è–ª–∏ —É–∂–µ. –ò–∑—É—á–∏ –≤—Å–µ –µ—â–µ –¥–∞–ª—å—à–µ, —á—Ç–æ–±—ã –≤—Å–µ –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å

–û—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ–≤–µ–ª **–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≥–ª—É–±–æ–∫–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö 13 –±–µ—Å–µ–¥**. –¢–µ–ø–µ—Ä—å –≤–∏–∂—É –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞. –í–æ—Ç **–∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∏–π –æ–±–∑–æ—Ä**:

***

## üéØ **–ü–û–õ–ù–ê–Ø –ö–ê–†–¢–ê –ü–†–û–†–ê–ë–û–¢–ê–ù–ù–´–• –ë–õ–û–ö–û–í (1-13 –ë–ï–°–ï–î)**

### **üìä 1. –§–£–ù–î–ê–ú–ï–ù–¢ (–ë–µ—Å–µ–¥—ã 1-3)**

**–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ:**

- Multi-tenant SaaS –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (pooled DB —Å tenant_id)
- –†–æ–ª–∏: Owner ‚Üí Restaurant Admin ‚Üí Manager ‚Üí Cashier ‚Üí Guest
- 6 —Ç–∞—Ä–∏—Ñ–æ–≤ (Free, Standard, Medium, Pro, Ultimate, Custom)
- RBAC —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ permissions
- UNIFIED vs SEPARATE —Ä–µ–∂–∏–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥–æ—Å—Ç–µ–π (–∫–∞—Å—Å–∞, —Å—Å—ã–ª–∫–∞, Telegram)
- QR-–∫–æ–¥—ã + 6-–∑–Ω–∞—á–Ω—ã–µ –∫–æ–¥—ã[^3_1][^3_2]

***

### **üîê 2. LOYALTY SYSTEM ENGINE (–ë–µ—Å–µ–¥–∞ 5)**

**23 –≤–æ–ø—Ä–æ—Å–∞ + —Ä–µ—à–µ–Ω–∏—è**[^3_3]

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

- ‚úÖ **1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å** (–≥–ª–æ–±–∞–ª—å–Ω–æ)
- ‚úÖ –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –æ—Ç **–∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞**
- ‚úÖ –î–≤–∞ –±–∞–ª–∞–Ω—Å–∞: regular + promo
- ‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ: —Å–Ω–∞—á–∞–ª–∞ promo, –ø–æ—Ç–æ–º regular
- ‚úÖ **–ë–µ–∑–ª–∏–º–∏—Ç –±–∞–ª–ª–æ–≤** –Ω–∞ –∫–∞—Ä—Ç–µ
- ‚úÖ –ú–∏–Ω–∏–º—É–º –∫ —Å–ø–∏—Å–∞–Ω–∏—é: **1 –±–∞–ª–ª**
- ‚úÖ –ú–∞–∫—Å–∏–º—É–º: **20% –æ—Ç —á–µ–∫–∞** (10-100% –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ)
- ‚úÖ **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª (snapshot, NO –ø–µ—Ä–µ—Å—á—ë—Ç)
- ‚úÖ –°–≥–æ—Ä–∞–Ω–∏–µ –ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (‚â•90 –¥–Ω–µ–π)
- ‚úÖ –£—Ä–æ–≤–Ω–∏: **NO downgrade** (one way up)
- ‚úÖ –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–æ–º–æ: COMBINE_ALL/MAX_ONLY/FIRST_ONLY
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ UNIFIED ‚Üî SEPARATE (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ/—Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ)

***

### **üí≥ 3. BILLING \& SUBSCRIPTIONS (–ë–µ—Å–µ–¥–∞ 6)**

**23 –≤–æ–ø—Ä–æ—Å–∞ + —Ä–µ—à–µ–Ω–∏—è**[^3_1]

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

- ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ **–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–µ** (–º–µ—Å—è—Ü/–≥–æ–¥ —Å–æ —Å–∫–∏–¥–∫–æ–π 20%)
- ‚úÖ 4 –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (YooKassa, Stripe, CloudPayments, CryptoCloud)
- ‚úÖ **–†—É—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞** –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –ª—é–±—ã—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö
- ‚úÖ –ñ—ë—Å—Ç–∫–∏–µ –ª–∏–º–∏—Ç—ã –±–µ–∑ overage (90% –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, 100% –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
- ‚úÖ 4 –ø–æ–ø—ã—Ç–∫–∏ –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏—è (–¥–µ–Ω—å 0,1,3,7)
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –ø—Ä–∏ –Ω–µ–æ–ø–ª–∞—Ç–µ (–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è)
- ‚úÖ Refund/chargeback –æ–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ Trial –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω)

***

### **üì± 4. TELEGRAM BOT + MINI APP (–ë–µ—Å–µ–¥–∞ 7)**

**41 –≤–æ–ø—Ä–æ—Å + —Ä–µ—à–µ–Ω–∏—è**[^3_2]

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram ID –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω
- ‚úÖ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ **–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω**
- ‚úÖ SMS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: —Ç–µ–ª–µ—Ñ–æ–Ω + –∏–º—è
- ‚úÖ –ú—É–ª—å—Ç–∏–∫–∞—Ä—Ç–æ—á–Ω–æ—Å—Ç—å (–≤—Å–µ –∫–∞—Ä—Ç—ã –≤ –æ–¥–Ω–æ–º Mini App)
- ‚úÖ QR –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã–π **–¥–æ –æ–ø–µ—Ä–∞—Ü–∏–∏** (–ø–æ—Å–ª–µ - –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è)
- ‚úÖ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ **–≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç**
- ‚úÖ –î–µ—Ç–∏ –¥–æ **18 –ª–µ—Ç**
- ‚úÖ –°–º–µ–Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞: –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è **—Ç–æ–ª—å–∫–æ –Ω–æ–≤–æ–≥–æ**
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ (–±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ)
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–ª–æ–≤ –∏ –≤–∏–∑–∏—Ç–æ–≤ (–±–µ–∑ —Å—Ä–µ–¥–Ω–µ–≥–æ —á–µ–∫–∞ –∏ LTV –¥–ª—è –≥–æ—Å—Ç—è)

***

### **üîå 5. POS INTEGRATION (–ë–µ—Å–µ–¥–∞ 4)**

**36 –≤–æ–ø—Ä–æ—Å–æ–≤ + —Ä–µ—à–µ–Ω–∏—è**[^3_4]

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

- ‚úÖ **HYBRID PUSH + PULL** (webhooks + —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω)
- ‚úÖ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ **—Ç–µ–ª–µ—Ñ–æ–Ω—É** (–æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á)
- ‚úÖ Auto-create guest –ø—Ä–∏ webhook (–æ–ø—Ü–∏—è)
- ‚úÖ HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å webhooks
- ‚úÖ **POS = –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã** –ø–æ —á–µ–∫–∞–º
- ‚úÖ Reconciliation: –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π job, –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- ‚úÖ –û—Ç–º–µ–Ω–∞/–≤–æ–∑–≤—Ä–∞—Ç —á–µ–∫–æ–≤ —Å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

***

### **üíª 6. BACKEND API \& SERVICES (–ë–µ—Å–µ–¥–∞ 8)**

**34 –≤–æ–ø—Ä–æ—Å–∞ + —Ä–µ—à–µ–Ω–∏—è**[^3_5]

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

- ‚úÖ **Modular Monolith** –Ω–∞ NestJS
- ‚úÖ REST API —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ RBAC Guards + Impersonation
- ‚úÖ Rate Limiting –ø–æ —Ä–æ–ª—è–º
- ‚úÖ API endpoints:
    - `/loyalty/calculate` (pre-calculation)
    - `/loyalty/transactions` (–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ)
    - `/loyalty/manual-adjustment`
- ‚úÖ Background Jobs (BullMQ)
- ‚úÖ Analytics API
- ‚úÖ Error Handling + Idempotency

***

### **üé® 7. FRONTEND ADMIN PANEL (–ë–µ—Å–µ–¥–∞ 8)**

**34 –≤–æ–ø—Ä–æ—Å–∞ + —Ä–µ—à–µ–Ω–∏—è**[^3_5]

**Technology Stack:**

- ‚úÖ Next.js 14 App Router (SSR/SSG)
- ‚úÖ shadcn/ui + Radix UI + Tailwind CSS
- ‚úÖ Zustand + TanStack Query
- ‚úÖ React Hook Form + Zod
- ‚úÖ TanStack Table v8
- ‚úÖ Recharts (charts)
- ‚úÖ Server-Sent Events (real-time)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

- ‚úÖ Loyalty Builder —Å live preview
- ‚úÖ Analytics Dashboards (Owner/Admin/Manager)
- ‚úÖ Guests Management
- ‚úÖ Settings \& Configuration

***

### **üóÑÔ∏è 8. DATABASE SCHEMA (PRISMA) (–ë–µ—Å–µ–¥–∞ 9)**

**35 –≤–æ–ø—Ä–æ—Å–æ–≤ + —Ä–µ—à–µ–Ω–∏—è**[^3_6]

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

- ‚úÖ –ì–∏–±—Ä–∏–¥: —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ enum + –∏–∑–º–µ–Ω—è–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- ‚úÖ **UUID** –¥–ª—è –≤—Å–µ—Ö –ø–µ—Ä–≤–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π
- ‚úÖ **DECIMAL(10,2)** –¥–ª—è –¥–µ–Ω–µ–∂–Ω—ã—Ö —Å—É–º–º
- ‚úÖ Soft delete –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
- ‚úÖ Composite –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ GIN –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è JSONB
- ‚úÖ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ snapshot

***

### **üé® 9. FRONTEND UI/UX DETAILS (–ë–µ—Å–µ–¥–∞ 10)**

**35 –≤–æ–ø—Ä–æ—Å–æ–≤ + —Ä–µ—à–µ–Ω–∏—è**[^3_7]

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

- ‚úÖ Mobile-first –ø–æ–¥—Ö–æ–¥
- ‚úÖ Responsive breakpoints (sm/md/lg/xl/2xl)
- ‚úÖ Dark/Light mode
- ‚úÖ Loading states (Skeleton UI)
- ‚úÖ Empty states —Å CTA
- ‚úÖ Toast notifications (sonner)
- ‚úÖ Infinite scroll + –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ Optimistic updates

***

### **üîî 10. NOTIFICATIONS SYSTEM (–ë–µ—Å–µ–¥–∞ 10)**

**36 –≤–æ–ø—Ä–æ—Å–æ–≤ + —Ä–µ—à–µ–Ω–∏—è**[^3_7]

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

- ‚úÖ 4 –∫–∞–Ω–∞–ª–∞: Telegram, Email, SMS, Push
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã: URGENT, HIGH, NORMAL, LOW
- ‚úÖ –®–∞–±–ª–æ–Ω–∏–∑–∞—Ü–∏—è —Å Handlebars
- ‚úÖ Batch –æ—Ç–ø—Ä–∞–≤–∫–∞ (–¥–æ 1000 –∑–∞ —Ä–∞–∑)
- ‚úÖ Retry logic (3 –ø–æ–ø—ã—Ç–∫–∏)
- ‚úÖ Unsubscribe –º–µ—Ö–∞–Ω–∏–∑–º
- ‚úÖ Rate limiting –ø–æ –∫–∞–Ω–∞–ª–∞–º
- ‚úÖ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

***

### **üèóÔ∏è 11. INFRASTRUCTURE \& DEVOPS (–ë–µ—Å–µ–¥–∞ 11)**

**43 –≤–æ–ø—Ä–æ—Å–∞ + —Ä–µ—à–µ–Ω–∏—è**[^3_8]

**–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ö–æ—Å—Ç–∏–Ω–≥:**

- ‚úÖ **Fly.io** (backend + worker, 3 shared-cpu VMs)
- ‚úÖ **Neon.tech** (PostgreSQL, 500MB + 1GB branch)
- ‚úÖ **Upstash Redis** (10K –∫–æ–º–∞–Ω–¥/–¥–µ–Ω—å)
- ‚úÖ **Cloudflare R2** (10GB —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
- ‚úÖ **Resend** (100 emails/–¥–µ–Ω—å)

**CI/CD:**

- ‚úÖ GitHub Actions
- ‚úÖ Docker multi-stage builds
- ‚úÖ Health checks
- ‚úÖ Zero-downtime deployments

***

### **üß™ 12. TESTING STRATEGY (–ë–µ—Å–µ–¥–∞ 11)**

**40 –≤–æ–ø—Ä–æ—Å–æ–≤ + —Ä–µ—à–µ–Ω–∏—è**[^3_8]

**Coverage targets:**

- ‚úÖ Unit: 80%+ (controllers, services, utils)
- ‚úÖ Integration: 70%+ (API endpoints, DB)
- ‚úÖ E2E: –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ–ª–æ—É (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –æ–ø–ª–∞—Ç–∞, –±–∞–ª–ª—ã)
- ‚úÖ Load: ‚â•500 RPS –±–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏

**Tools:**

- ‚úÖ Jest (unit + integration)
- ‚úÖ Playwright (E2E)
- ‚úÖ k6 (load testing)

***

### **üé® 13. UI/UX DESIGN SYSTEM (–ë–µ—Å–µ–¥–∞ 12)**

[^3_9]

**–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ:**

- ‚úÖ –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ (Primary, Secondary, Accent)
- ‚úÖ –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ (Inter variable font)
- ‚úÖ Spacing scale (4px base)
- ‚úÖ Component library
- ‚úÖ Elevation system
- ‚úÖ Animation guidelines

***

### **üìä 14. DASHBOARDS (–ë–µ—Å–µ–¥–∞ 12)**

[^3_9]

**Manager Dashboard (25 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- ‚úÖ KPI –∫–∞—Ä—Ç–æ—á–∫–∏
- ‚úÖ Revenue charts
- ‚úÖ Guest segments
- ‚úÖ Promo effectiveness

**Cashier Interface (25 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- ‚úÖ Guest lookup
- ‚úÖ Points calculation
- ‚úÖ Quick actions
- ‚úÖ Minimal UI

**Owner Platform (25 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- ‚úÖ Platform metrics (MRR, Churn, ARPU)
- ‚úÖ Tenant management
- ‚úÖ Billing analytics
- ‚úÖ System health

***

### **üîí 15. SECURITY \& COMPLIANCE (–ë–µ—Å–µ–¥–∞ 13)**

**40 –≤–æ–ø—Ä–æ—Å–æ–≤ + —Ä–µ—à–µ–Ω–∏—è**[^3_10]

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

- ‚úÖ JWT + refresh tokens (HttpOnly cookies)
- ‚úÖ MFA (TOTP –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- ‚úÖ Rate limiting (100 req/min per IP)
- ‚úÖ OWASP Top 10 protection
- ‚úÖ GDPR compliance (right to erasure, data portability)
- ‚úÖ PCI DSS Level 1 (—á–µ—Ä–µ–∑ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤)
- ‚úÖ Audit logging –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ Encrypted backups (AES-256)

***

## üìà **–ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê**

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ë–µ—Å–µ–¥—ã | –í–æ–ø—Ä–æ—Å–æ–≤ | –°—Ç–∞—Ç—É—Å |
| :-- | :-- | :-- | :-- |
| –§—É–Ω–¥–∞–º–µ–Ω—Ç \& –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | 1-3 | ~50 | ‚úÖ 100% |
| Loyalty System | 5 | 23 | ‚úÖ 100% |
| Billing \& Subscriptions | 6 | 23 | ‚úÖ 100% |
| Telegram Bot \& Mini App | 7 | 41 | ‚úÖ 100% |
| POS Integration | 4 | 36 | ‚úÖ 100% |
| Backend API \& Services | 8 | 34 | ‚úÖ 100% |
| Frontend Admin Panel | 8 | 34 | ‚úÖ 100% |
| Database Schema | 9 | 35 | ‚úÖ 100% |
| Frontend UI/UX | 10 | 35 | ‚úÖ 100% |
| Notifications | 10 | 36 | ‚úÖ 100% |
| Infrastructure \& DevOps | 11 | 43 | ‚úÖ 100% |
| Testing Strategy | 11 | 40 | ‚úÖ 100% |
| Design System | 12 | - | ‚úÖ 100% |
| Dashboards | 12 | 75 | ‚úÖ 100% |
| Security \& Compliance | 13 | 40 | ‚úÖ 100% |

**–ò–¢–û–ì–û: ~575+ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–µ—Ç–∞–ª—å–Ω–æ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ**[^3_3][^3_2][^3_6][^3_10][^3_8][^3_9][^3_1][^3_5][^3_7]

***

## ‚ú® **–ß–¢–û –≠–¢–û –ó–ù–ê–ß–ò–¢**

–°–∏—Å—Ç–µ–º–∞ **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞** –æ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –¥–æ –¥–µ–ø–ª–æ—è:

‚úÖ **Backend**: NestJS, Prisma, PostgreSQL, Redis, BullMQ
‚úÖ **Frontend**: Next.js 14, shadcn/ui, Zustand, TanStack Query
‚úÖ **Mobile**: Telegram Mini App (React)
‚úÖ **Infrastructure**: Fly.io, Neon, Upstash, Cloudflare
‚úÖ **Security**: JWT, MFA, GDPR, PCI DSS
‚úÖ **Testing**: Unit, Integration, E2E, Load
‚úÖ **Monitoring**: Health checks, logging, alerts

***

## üöÄ **–ì–û–¢–û–í–û –ö –†–ê–ó–†–ê–ë–û–¢–ö–ï**

–í—Å–µ –±–ª–æ–∫–∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã. **–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ implementation**.

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**

1. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ Development Roadmap
2. ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —Ñ–∏—á (MVP ‚Üí v1.0 ‚Üí v2.0)
3. ‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
4. ‚úÖ Setup –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
5. ‚úÖ –ù–∞—á–∞–ª–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

**–ß—Ç–æ –¥–∞–ª—å—à–µ?** –•–æ—á–µ—à—å:

- üìù –°–æ–∑–¥–∞—Ç—å Development Roadmap —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏?
- üîç –£–≥–ª—É–±–∏—Ç—å—Å—è –≤ –∫–∞–∫–æ–π-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±–ª–æ–∫?
- üìä –°–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã?
- üéØ –ù–∞—á–∞—Ç—å —Å —á–µ–≥–æ-—Ç–æ –¥—Ä—É–≥–æ–≥–æ?
<span style="display:none">[^3_11][^3_12][^3_13]</span>

<div align="center">‚ÅÇ</div>

[^3_1]: Beseda-6.md

[^3_2]: Beseda-7.md

[^3_3]: Beseda-5.md

[^3_4]: Beseda-4.md

[^3_5]: Beseda-8.md

[^3_6]: Beseda-9.md

[^3_7]: Beseda-10.md

[^3_8]: Beseda-11.md

[^3_9]: Beseda-12.md

[^3_10]: Beseda-13.md

[^3_11]: Beseda-3.md

[^3_12]: Beseda-1.md

[^3_13]: Beseda-2.md


---

## üîå **–ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° POS-–°–ò–°–¢–ï–ú–ê–ú–ò: iiko Front \& R-Keeper Front**

–í–æ—Ç **–ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ**, –∫–∞–∫ –Ω–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∫–∞—Å—Å–æ–≤—ã–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ:[^4_1][^4_2]

***

## üì± **–°–ü–û–°–û–ë–´ –ò–ù–¢–ï–ì–†–ê–¶–ò–ò**

### **–í–∞—Ä–∏–∞–Ω—Ç 1: API Integration (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)**

**iiko:**

- ‚úÖ **iiko RMS** –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç REST API
- ‚úÖ –ù–∞ –∫–∞—Å—Å–µ iiko Front –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π —ç–∫—Ä–∞–Ω —á–µ—Ä–µ–∑ –ø–ª–∞–≥–∏–Ω
- ‚úÖ –ü–ª–∞–≥–∏–Ω –æ–±—â–∞–µ—Ç—Å—è —Å –Ω–∞—à–∏–º backend —á–µ—Ä–µ–∑ API

**R-Keeper:**

- ‚úÖ **R-Keeper Server API** (SOAP/REST)
- ‚úÖ –í–Ω–µ—à–Ω–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Å—Å–µ –∏–ª–∏ –ø–ª–∞–Ω—à–µ—Ç–µ —Ä—è–¥–æ–º
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ R-Keeper External Payment API

***

## üë®‚Äçüíº **–§–õ–û–£ –†–ê–ë–û–¢–´ –ö–ê–°–°–ò–†–ê**

### **–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ (–ø—Ä–æ—Å—Ç–æ–π)**

```
1Ô∏è‚É£ –ì–û–°–¢–¨ –ü–†–ò–•–û–î–ò–¢ –ö –ö–ê–°–°–ï
   ‚îî‚îÄ –ö–∞—Å—Å–∏—Ä: "–£ –≤–∞—Å –µ—Å—Ç—å –∫–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏?"
   
2Ô∏è‚É£ –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ì–û–°–¢–Ø
   –°–ø–æ—Å–æ–±—ã:
   ‚îú‚îÄ –ì–æ—Å—Ç—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç QR-–∫–æ–¥ –∏–∑ Telegram Mini App
   ‚îú‚îÄ –ì–æ—Å—Ç—å –Ω–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω +7 999 123 45 67
   ‚îî‚îÄ –ì–æ—Å—Ç—å –Ω–∞–∑—ã–≤–∞–µ—Ç 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ (–∏–∑ Mini App)
   
3Ô∏è‚É£ –ö–ê–°–°–ò–† –í–í–û–î–ò–¢ –î–ê–ù–ù–´–ï –í POS
   iiko Front:
   ‚îî‚îÄ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–æ–ø.—ç–∫—Ä–∞–Ω "–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏"
   ‚îî‚îÄ –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR / –≤–≤–æ–¥–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω / –≤–≤–æ–¥–∏—Ç –∫–æ–¥
   ‚îî‚îÄ –°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
       ‚îú‚îÄ –ò–º—è –≥–æ—Å—Ç—è: "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
       ‚îú‚îÄ –£—Ä–æ–≤–µ–Ω—å: "Silver" 
       ‚îú‚îÄ –ë–∞–ª–∞–Ω—Å: "2,450 –±–∞–ª–ª–æ–≤"
       ‚îî‚îÄ –î–æ—Å—Ç—É–ø–Ω–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é: "–¥–æ 400‚ÇΩ (20% –æ—Ç —á–µ–∫–∞)"
       
4Ô∏è‚É£ –ì–û–°–¢–¨ –í–´–ë–ò–†–ê–ï–¢: "–ü—Ä–æ—Å—Ç–æ –Ω–∞—á–∏—Å–ª–∏—Ç–µ"
   ‚îî‚îÄ –ö–∞—Å—Å–∏—Ä –∑–∞–≤–µ—Ä—à–∞–µ—Ç —á–µ–∫ –∫–∞–∫ –æ–±—ã—á–Ω–æ
   
5Ô∏è‚É£ –ü–û–°–õ–ï –û–ü–õ–ê–¢–´ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
   POS ‚Üí –Ω–∞—à Backend (webhook):
   {
     "check_id": "iiko-12345",
     "phone": "+79991234567",
     "amount": 2000,
     "paid_amount": 2000,
     "timestamp": "2026-02-16T20:30:00Z"
   }
   
6Ô∏è‚É£ –ù–ê–® BACKEND –û–ë–†–ê–ë–ê–¢–´–í–ê–ï–¢
   ‚îú‚îÄ –ù–∞—Ö–æ–¥–∏—Ç –≥–æ—Å—Ç—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
   ‚îú‚îÄ –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (Silver = 5% –∫–µ—à–±—ç–∫)
   ‚îú‚îÄ –ù–∞—á–∏—Å–ª—è–µ—Ç: 2000 √ó 5% = 100 –±–∞–ª–ª–æ–≤
   ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –ë–î
   ‚îî‚îÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç push –≤ Telegram:
       "‚ú® –ù–∞—á–∏—Å–ª–µ–Ω–æ 100 –±–∞–ª–ª–æ–≤! –ë–∞–ª–∞–Ω—Å: 2,550"
       
‚úÖ –ì–û–¢–û–í–û!
```


***

### **–°—Ü–µ–Ω–∞—Ä–∏–π 2: –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ (—Å–ª–æ–∂–Ω–µ–µ)**

```
1Ô∏è‚É£ –ì–û–°–¢–¨ –£ –ö–ê–°–°–´
   ‚îî‚îÄ "–•–æ—á—É –æ–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏"
   
2Ô∏è‚É£ –ö–ê–°–°–ò–† –ò–î–ï–ù–¢–ò–§–ò–¶–ò–†–£–ï–¢ –ì–û–°–¢–Ø
   ‚îî‚îÄ –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR / –≤–≤–æ–¥–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω
   ‚îî‚îÄ –í–∏–¥–∏—Ç –±–∞–ª–∞–Ω—Å: "2,450 –±–∞–ª–ª–æ–≤"
   
3Ô∏è‚É£ –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –ß–ï–ö–ê
   ‚îú‚îÄ –ß–µ–∫ –Ω–∞ 2,000‚ÇΩ
   ‚îú‚îÄ iiko –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "–î–æ—Å—Ç—É–ø–Ω–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é: 400‚ÇΩ (20%)"
   ‚îî‚îÄ –ì–æ—Å—Ç—å: "–°–ø–∏—Å—ã–≤–∞—é 400 –±–∞–ª–ª–æ–≤"
   
4Ô∏è‚É£ PRE-CALCULATION (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏)
   iiko Front ‚Üí –Ω–∞—à API:
   POST /api/loyalty/calculate
   {
     "guest_phone": "+79991234567",
     "check_amount": 2000,
     "redeem_request": 400
   }
   
   ‚Üê –û—Ç–≤–µ—Ç (–∑–∞ ~200ms):
   {
     "allowed_redeem": 400,      // –º–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å
     "remaining_balance": 2050,   // –æ—Å—Ç–∞–Ω–µ—Ç—Å—è
     "earn_amount": 100,          // –Ω–∞—á–∏—Å–ª–∏—Ç—Å—è (–æ—Ç –ø–æ–ª–Ω—ã—Ö 2000)
     "final_price": 1600          // –∫ –æ–ø–ª–∞—Ç–µ –¥–µ–Ω—å–≥–∞–º–∏
   }
   
5Ô∏è‚É£ –ö–ê–°–°–ò–† –í–ò–î–ò–¢ –†–ê–°–ß–Å–¢
   iiko Front –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ –°—É–º–º–∞ —á–µ–∫–∞:       2,000‚ÇΩ    ‚îÇ
   ‚îÇ –û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏:    -400‚ÇΩ    ‚îÇ
   ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
   ‚îÇ –ö –æ–ø–ª–∞—Ç–µ:         1,600‚ÇΩ    ‚îÇ
   ‚îÇ                              ‚îÇ
   ‚îÇ –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ:   +100 –±.  ‚îÇ
   ‚îÇ –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å:     2,150 –±.  ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   
6Ô∏è‚É£ –ì–û–°–¢–¨ –û–ü–õ–ê–ß–ò–í–ê–ï–¢ 1,600‚ÇΩ
   ‚îî‚îÄ –ö–∞—Ä—Ç–æ–π / –Ω–∞–ª–∏—á–Ω—ã–º–∏ —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª
   
7Ô∏è‚É£ POS –§–ò–ö–°–ò–†–£–ï–¢ –û–ü–õ–ê–¢–£
   Webhook ‚Üí –Ω–∞—à Backend:
   {
     "check_id": "iiko-12346",
     "phone": "+79991234567",
     "original_amount": 2000,
     "redeemed_points": 400,
     "paid_amount": 1600,
     "payment_method": "card"
   }
   
8Ô∏è‚É£ –ù–ê–® BACKEND
   ‚îú‚îÄ –°–ø–∏—Å—ã–≤–∞–µ—Ç 400 –±–∞–ª–ª–æ–≤ (promo ‚Üí regular)
   ‚îú‚îÄ –ù–∞—á–∏—Å–ª—è–µ—Ç 100 –±–∞–ª–ª–æ–≤ (–æ—Ç –ø–æ–ª–Ω—ã—Ö 2000‚ÇΩ)
   ‚îú‚îÄ –û–±–Ω–æ–≤–ª—è–µ—Ç QR-–∫–æ–¥ –∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
   ‚îî‚îÄ Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:
       "‚úÖ –°–ø–∏—Å–∞–Ω–æ 400 –±.
        ‚ú® –ù–∞—á–∏—Å–ª–µ–Ω–æ 100 –±.
        üí∞ –ë–∞–ª–∞–Ω—Å: 2,150"
        
‚úÖ –ì–û–¢–û–í–û!
```


***

## üîß **–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò –ò–ù–¢–ï–ì–†–ê–¶–ò–ò**

### **A. –î–ª—è iiko**

**1. –ü–ª–∞–≥–∏–Ω –¥–ª—è iiko Front** (–Ω–∞—à–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)

```
–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:
‚îú‚îÄ C# (.NET Framework 4.8)
‚îú‚îÄ iiko SDK (IikoNet.dll)
‚îî‚îÄ REST API client –¥–ª—è –Ω–∞—à–µ–≥–æ backend

–§—É–Ω–∫—Ü–∏–∏:
‚îú‚îÄ QR-—Å–∫–∞–Ω–µ—Ä (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ USB/–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∫–∞–º–µ—Ä–∞)
‚îú‚îÄ –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è (—Ç–µ–ª–µ—Ñ–æ–Ω/–∫–æ–¥)
‚îú‚îÄ Pre-calculation –ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π
‚îú‚îÄ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∏ —É—Ä–æ–≤–Ω—è
‚îî‚îÄ –ö–Ω–æ–ø–∫–∏ "–ù–∞—á–∏—Å–ª–∏—Ç—å" / "–°–ø–∏—Å–∞—Ç—å"
```

**2. Webhook –æ—Ç iiko RMS**

```javascript
// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ iiko Office:
Webhooks ‚Üí –î–æ–±–∞–≤–∏—Ç—å:
URL: https://api.ournameapp.com/api/pos/webhooks/iiko
Events:
  ‚úÖ OnCheckClosed (—á–µ–∫ –∑–∞–∫—Ä—ã—Ç)
  ‚úÖ OnCheckCancelled (—á–µ–∫ –æ—Ç–º–µ–Ω—ë–Ω)
  
HMAC Secret: <–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞–º–∏>
```

**3. API Endpoints (–Ω–∞—à–∏)**

```typescript
// Pre-calculation
POST /api/loyalty/calculate
Headers: 
  X-Tenant-ID: uuid
  X-Restaurant-ID: uuid
Body: {
  guest_phone: string,
  check_amount: number,
  redeem_request?: number
}

// Webhook –æ—Ç iiko
POST /api/pos/webhooks/iiko
Headers:
  X-HMAC-Signature: sha256(body + secret)
Body: {
  pos_system: "IIKO",
  check_id: string,
  restaurant_id: string,
  guest_phone: string,
  original_amount: number,
  redeemed_points: number,
  paid_amount: number,
  items: [...],
  timestamp: ISO8601
}
```


***

### **B. –î–ª—è R-Keeper**

**1. –í–Ω–µ—à–Ω–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ** (—Ä—è–¥–æ–º —Å –∫–∞—Å—Å–æ–π)

```
–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:
‚îú‚îÄ Electron / React (–∫—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞)
‚îú‚îÄ R-Keeper API client (SOAP)
‚îî‚îÄ REST API –¥–ª—è –Ω–∞—à–µ–≥–æ backend

–§–ª–æ—É:
1. –ö–∞—Å—Å–∏—Ä –Ω–∞ R-Keeper Front —Å–æ–∑–¥–∞—ë—Ç —á–µ–∫
2. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ
3. –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR / –≤–≤–æ–¥–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω
4. –í–∏–¥–∏—Ç –±–∞–ª–∞–Ω—Å –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±–∞–ª–ª—ã
5. –í—ã–±–∏—Ä–∞–µ—Ç —Å—É–º–º—É –∫ —Å–ø–∏—Å–∞–Ω–∏—é
6. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—ë—Ç –≤ R-Keeper —Å–∫–∏–¥–∫—É
7. –ö–∞—Å—Å–∏—Ä –∑–∞–≤–µ—Ä—à–∞–µ—Ç –æ–ø–ª–∞—Ç—É
8. R-Keeper –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞–º
```

**2. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: External Payment Provider**

```
R-Keeper –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã:
‚îú‚îÄ –°–æ–∑–¥–∞—ë–º "–ë–∞–ª–ª—ã" –∫–∞–∫ payment method
‚îú‚îÄ R-Keeper –≤—ã–∑—ã–≤–∞–µ—Ç –Ω–∞—à endpoint –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
‚îú‚îÄ –ú—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º/–æ—Ç–∫–ª–æ–Ω—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
‚îî‚îÄ R-Keeper –∑–∞–≤–µ—Ä—à–∞–µ—Ç —á–µ–∫
```


***

## üìä **–ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ò–ù–¢–ï–ì–†–ê–¶–ò–ò**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           –†–ï–°–¢–û–†–ê–ù (–ö–∞—Å—Å–æ–≤–∞—è –∑–æ–Ω–∞)              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  iiko Front  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ  –ù–∞—à –ø–ª–∞–≥–∏–Ω     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  (–∫–∞—Å—Å–∞)     ‚îÇ        ‚îÇ  (C#)           ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ         ‚îÇ                        ‚îÇ              ‚îÇ
‚îÇ         ‚îÇ Webhook               ‚îÇ REST API     ‚îÇ
‚îÇ         ‚ñº                        ‚ñº              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                        ‚îÇ
          ‚îÇ      INTERNET          ‚îÇ
          ‚îÇ                        ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         –ù–ê–® BACKEND (Cloud)                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ Webhook Handler    ‚îÇ  ‚îÇ  Loyalty API     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ /pos/webhooks/iiko ‚îÇ  ‚îÇ  /loyalty/*      ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ            ‚îÇ                     ‚îÇ              ‚îÇ
‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ                   ‚ñº                             ‚îÇ
‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îÇ
‚îÇ         ‚îÇ  Loyalty Engine  ‚îÇ                    ‚îÇ
‚îÇ         ‚îÇ  (NestJS)        ‚îÇ                    ‚îÇ
‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îÇ                   ‚îÇ                             ‚îÇ
‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ         ‚îÇ   PostgreSQL      ‚îÇ                   ‚îÇ
‚îÇ         ‚îÇ   (Neon.tech)     ‚îÇ                   ‚îÇ
‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚îÇ Push Notification
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         –ì–û–°–¢–¨ (Telegram Mini App)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## üéØ **–ß–¢–û –ù–£–ñ–ù–û –†–ï–°–¢–û–†–ê–ù–£ –î–õ–Ø –°–¢–ê–†–¢–ê**

### **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

**iiko:**

- ‚úÖ iiko RMS 7.7+ (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π webhooks)
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—à –ø–ª–∞–≥–∏–Ω –Ω–∞ –∫–∞—Å—Å–æ–≤—ã–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã
- ‚úÖ USB QR-—Å–∫–∞–Ω–µ—Ä –∏–ª–∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∫–∞–º–µ—Ä–∞
- ‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–∞ –∫–∞—Å—Å–∞—Ö (–¥–ª—è API)

**R-Keeper:**

- ‚úÖ R-Keeper 7+
- ‚úÖ –ü–ª–∞–Ω—à–µ—Ç —Å –Ω–∞—à–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º (Windows/iPad)
- ‚úÖ USB QR-—Å–∫–∞–Ω–µ—Ä
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å External Payment API


### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ (–∑–∞ 30 –º–∏–Ω—É—Ç):**

```
1Ô∏è‚É£ Restaurant Admin –≤ –Ω–∞—à–µ–π –ø–∞–Ω–µ–ª–∏:
   ‚îî‚îÄ Settings ‚Üí POS Integration
   ‚îî‚îÄ –í—ã–±–∏—Ä–∞–µ—Ç: iiko / R-Keeper
   ‚îî‚îÄ –í–≤–æ–¥–∏—Ç API credentials –æ—Ç POS
   ‚îî‚îÄ –ù–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥–∫–ª—é—á–∏—Ç—å"
   
2Ô∏è‚É£ –ú—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
   ‚îú‚îÄ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
   ‚îú‚îÄ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º webhooks
   ‚îú‚îÄ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HMAC secret
   ‚îî‚îÄ –°–æ–∑–¥–∞—ë–º POSIntegration –∑–∞–ø–∏—Å—å
   
3Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
   ‚îî‚îÄ –°–∫–∞—á–∞—Ç—å —Å –Ω–∞—à–µ–≥–æ —Å–∞–π—Ç–∞
   ‚îî‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ –∫–∞—Å—Å—ã
   ‚îî‚îÄ –í–≤–µ—Å—Ç–∏ Restaurant ID + API Key
   
‚úÖ –ì–û–¢–û–í–û –ö –†–ê–ë–û–¢–ï!
```


***

## üîí **–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨**

```
1Ô∏è‚É£ HMAC-–ø–æ–¥–ø–∏—Å—å –≤—Å–µ—Ö webhooks
   ‚îî‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ–º: hash(body + secret) == signature
   
2Ô∏è‚É£ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
   ‚îî‚îÄ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π webhook —Å —Ç–µ–º –∂–µ check_id –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
   
3Ô∏è‚É£ Rate limiting
   ‚îî‚îÄ –û—Ç –æ–¥–Ω–æ–≥–æ POS –º–∞–∫—Å–∏–º—É–º 100 req/min
   
4Ô∏è‚É£ IP Whitelist (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   ‚îî‚îÄ Restaurant Admin –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å IP –∫–∞—Å—Å—ã
   
5Ô∏è‚É£ –¢–∞–π–º–∞—É—Ç—ã
   ‚îî‚îÄ Pre-calculation: 3 —Å–µ–∫—É–Ω–¥—ã
   ‚îî‚îÄ Webhook processing: 10 —Å–µ–∫—É–Ω–¥
```


***

## üìà **–ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨**

```
Pre-calculation API:
‚îú‚îÄ –û—Ç–≤–µ—Ç: < 200ms (p95)
‚îú‚îÄ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: 99.9%
‚îî‚îÄ –ö–µ—à –±–∞–ª–∞–Ω—Å–æ–≤ (Redis, TTL 30s)

Webhook processing:
‚îú‚îÄ Async –æ—á–µ—Ä–µ–¥—å (BullMQ)
‚îú‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞: < 1 —Å–µ–∫—É–Ω–¥–∞
‚îî‚îÄ Retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö: 3 –ø–æ–ø—ã—Ç–∫–∏
```


***

## üí° **–†–ï–ó–Æ–ú–ï**

**–î–ª—è –∫–∞—Å—Å–∏—Ä–∞ –≤—Å—ë –ø—Ä–æ—Å—Ç–æ:**

1. –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR –∏–ª–∏ –≤–≤–æ–¥–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω
2. –í–∏–¥–∏—Ç –±–∞–ª–∞–Ω—Å –≥–æ—Å—Ç—è
3. –ì–æ—Å—Ç—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ø–∏—Å–∞—Ç—å/–Ω–µ —Å–ø–∏—Å–∞—Ç—å
4. –ó–∞–≤–µ—Ä—à–∞–µ—Ç —á–µ–∫ –∫–∞–∫ –æ–±—ã—á–Ω–æ

**–ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º:**

- Pre-calculation API (–±—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á—ë—Ç)
- Webhook –ø–æ—Å–ª–µ —á–µ–∫–∞ (–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ)
- PULL –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞)
- Push –≤ Telegram (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≥–æ—Å—Ç—è)

**–í—Ä–µ–º—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: 1-2 –Ω–µ–¥–µ–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞–≥–∏–Ω–∞ + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**[^4_2][^4_1]

–ù—É–∂–Ω—ã –µ—â—ë –¥–µ—Ç–∞–ª–∏ –ø–æ –∫–∞–∫–æ–º—É-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∞—Å–ø–µ–∫—Ç—É?

<div align="center">‚ÅÇ</div>

[^4_1]: Beseda-4.md

[^4_2]: Beseda-11.md


---

# üîå **–ü–õ–ê–ì–ò–ù –î–õ–Ø IIKO FRONT - –ü–û–õ–ù–ê–Ø –†–ê–ó–†–ê–ë–û–¢–ö–ê**

–û—Ç–ª–∏—á–Ω–æ! –°–æ–∑–¥–∞–º **–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø–ª–∞–≥–∏–Ω** –¥–ª—è iiko Front. –≠—Ç–æ –±—É–¥–µ—Ç production-ready —Ä–µ—à–µ–Ω–∏–µ.

***

## üìã **–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê**

```
LoyaltyPluginIiko/
‚îú‚îÄ‚îÄ LoyaltyPluginIiko.sln
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyPluginIiko/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyPluginIiko.csproj
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Plugin.cs                    # –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –ø–ª–∞–≥–∏–Ω–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PluginConfig.cs              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyApiClient.cs      # HTTP client –¥–ª—è –Ω–∞—à–µ–≥–æ API
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ QRScannerService.cs      # –†–∞–±–æ—Ç–∞ —Å–æ —Å–∫–∞–Ω–µ—Ä–æ–º
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CacheService.cs          # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GuestInfo.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CalculationRequest.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CalculationResponse.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RedeemRequest.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UI/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyWindow.xaml       # –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyWindow.xaml.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GuestSearchControl.xaml  # –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ BalanceControl.xaml      # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Utils/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Logger.cs
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ PhoneFormatter.cs
‚îÇ   ‚îî‚îÄ‚îÄ Tests/
‚îÇ       ‚îî‚îÄ‚îÄ LoyaltyPluginIiko.Tests/
‚îú‚îÄ‚îÄ libs/                                 # iiko SDK
‚îÇ   ‚îî‚îÄ‚îÄ IikoNet.dll
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ INSTALL.md
```


***

## üéØ **1. –ì–õ–ê–í–ù–´–ô –§–ê–ô–õ –ü–õ–ê–ì–ò–ù–ê**

### **Plugin.cs**

```csharp
using System;
using System.Windows.Forms;
using Resto.Front.Api;
using Resto.Front.Api.Attributes;
using Resto.Front.Api.Attributes.JetBrains;
using Resto.Front.Api.Data.Cheques;
using Resto.Front.Api.Data.Orders;
using Resto.Front.Api.Extensions;

namespace LoyaltyPluginIiko
{
    /// <summary>
    /// –ü–ª–∞–≥–∏–Ω —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è iiko Front
    /// </summary>
    [UsedImplicitly]
    [PluginLicenseModuleId(0x0000000)] // –ü–æ–ª—É—á–∏—Ç—å —É iiko
    public sealed class LoyaltyPlugin : IFrontPlugin
    {
        private readonly ILog log;
        private LoyaltyApiClient apiClient;
        private QRScannerService scannerService;
        private CacheService cacheService;

        public LoyaltyPlugin()
        {
            log = PluginContext.Log;
            log.Info("Loyalty Plugin: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...");
        }

        public void Dispose()
        {
            log.Info("Loyalty Plugin: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã");
            scannerService?.Dispose();
            apiClient?.Dispose();
            PluginContext.Operations.RemoveButtonFromPaymentScreen -= OnRemoveButtonFromPaymentScreen;
        }

        /// <summary>
        /// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ iiko Front
        /// </summary>
        public void InitializePlugin()
        {
            try
            {
                log.Info("Loyalty Plugin: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏");
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                var config = PluginConfig.Load();
                if (!config.IsValid())
                {
                    log.Error("Loyalty Plugin: –ù–µ–≤–µ—Ä–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è. –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.");
                    MessageBox.Show(
                        "–ü–ª–∞–≥–∏–Ω –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.\n–û—Ç–∫—Ä–æ–π—Ç–µ Settings ‚Üí Loyalty Plugin",
                        "Loyalty Plugin",
                        MessageBoxButtons.OK,
                        MessageBoxIcon.Warning
                    );
                    return;
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
                apiClient = new LoyaltyApiClient(config);
                scannerService = new QRScannerService(log);
                cacheService = new CacheService();

                log.Info($"Loyalty Plugin: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ {config.ApiBaseUrl}");

                // –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API
                var pingResult = apiClient.PingAsync().Result;
                if (!pingResult)
                {
                    log.Error("Loyalty Plugin: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API");
                    MessageBox.Show(
                        "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.",
                        "Loyalty Plugin",
                        MessageBoxButtons.OK,
                        MessageBoxIcon.Error
                    );
                    return;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã
                PluginContext.Operations.AddButtonToPaymentScreen(
                    "–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏",
                    OnLoyaltyButtonClick
                );

                log.Info("Loyalty Plugin: –£—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
            }
            catch (Exception ex)
            {
                log.Error($"Loyalty Plugin: –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {ex.Message}", ex);
                MessageBox.Show(
                    $"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞–≥–∏–Ω–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏:\n{ex.Message}",
                    "Loyalty Plugin Error",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Error
                );
            }
        }

        /// <summary>
        /// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏"
        /// </summary>
        private void OnLoyaltyButtonClick(IOrder order, IOperationService operations)
        {
            try
            {
                log.Info($"Loyalty Plugin: –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –¥–ª—è –∑–∞–∫–∞–∑–∞ {order.Number}");

                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
                var loyaltyWindow = new LoyaltyWindow(
                    order,
                    apiClient,
                    scannerService,
                    cacheService,
                    operations,
                    log
                );

                loyaltyWindow.ShowDialog();
            }
            catch (Exception ex)
            {
                log.Error($"Loyalty Plugin: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –æ–∫–Ω–∞: {ex.Message}", ex);
                MessageBox.Show(
                    $"–û—à–∏–±–∫–∞:\n{ex.Message}",
                    "Loyalty Plugin",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Error
                );
            }
        }

        private void OnRemoveButtonFromPaymentScreen()
        {
            log.Info("Loyalty Plugin: –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞ —Å —ç–∫—Ä–∞–Ω–∞ –æ–ø–ª–∞—Ç—ã");
        }
    }
}
```


***

## ‚öôÔ∏è **2. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø**

### **PluginConfig.cs**

```csharp
using System;
using System.IO;
using Newtonsoft.Json;

namespace LoyaltyPluginIiko
{
    /// <summary>
    /// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–∞
    /// </summary>
    public class PluginConfig
    {
        private static readonly string ConfigPath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "LoyaltyPluginIiko",
            "config.json"
        );

        /// <summary>
        /// URL API –±—ç–∫–µ–Ω–¥–∞
        /// </summary>
        public string ApiBaseUrl { get; set; }

        /// <summary>
        /// API Key —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
        /// </summary>
        public string ApiKey { get; set; }

        /// <summary>
        /// ID —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
        /// </summary>
        public string RestaurantId { get; set; }

        /// <summary>
        /// Tenant ID
        /// </summary>
        public string TenantId { get; set; }

        /// <summary>
        /// –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å–µ–∫—É–Ω–¥—ã)
        /// </summary>
        public int TimeoutSeconds { get; set; } = 5;

        /// <summary>
        /// –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR
        /// </summary>
        public bool EnableQRScanner { get; set; } = true;

        /// <summary>
        /// COM-–ø–æ—Ä—Ç —Å–∫–∞–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
        /// </summary>
        public string ScannerComPort { get; set; } = "COM1";

        /// <summary>
        /// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        /// </summary>
        public bool IsValid()
        {
            return !string.IsNullOrWhiteSpace(ApiBaseUrl) &&
                   !string.IsNullOrWhiteSpace(ApiKey) &&
                   !string.IsNullOrWhiteSpace(RestaurantId) &&
                   !string.IsNullOrWhiteSpace(TenantId);
        }

        /// <summary>
        /// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ —Ñ–∞–π–ª–∞
        /// </summary>
        public static PluginConfig Load()
        {
            try
            {
                if (File.Exists(ConfigPath))
                {
                    var json = File.ReadAllText(ConfigPath);
                    return JsonConvert.DeserializeObject<PluginConfig>(json);
                }

                // –°–æ–∑–¥–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                var defaultConfig = new PluginConfig
                {
                    ApiBaseUrl = "https://api.yourloyaltyapp.com",
                    ApiKey = "your-api-key-here",
                    RestaurantId = "your-restaurant-id",
                    TenantId = "your-tenant-id"
                };

                defaultConfig.Save();
                return defaultConfig;
            }
            catch (Exception)
            {
                return new PluginConfig();
            }
        }

        /// <summary>
        /// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        /// </summary>
        public void Save()
        {
            try
            {
                var directory = Path.GetDirectoryName(ConfigPath);
                if (!Directory.Exists(directory))
                {
                    Directory.CreateDirectory(directory);
                }

                var json = JsonConvert.SerializeObject(this, Formatting.Indented);
                File.WriteAllText(ConfigPath, json);
            }
            catch (Exception ex)
            {
                throw new Exception($"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {ex.Message}", ex);
            }
        }
    }
}
```


***

## üåê **3. API CLIENT**

### **LoyaltyApiClient.cs**

```csharp
using System;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Text;
using System.Threading.Tasks;
using Newtonsoft.Json;
using LoyaltyPluginIiko.Models;

namespace LoyaltyPluginIiko.Services
{
    /// <summary>
    /// HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
    /// </summary>
    public class LoyaltyApiClient : IDisposable
    {
        private readonly HttpClient httpClient;
        private readonly PluginConfig config;

        public LoyaltyApiClient(PluginConfig config)
        {
            this.config = config;
            
            httpClient = new HttpClient
            {
                BaseAddress = new Uri(config.ApiBaseUrl),
                Timeout = TimeSpan.FromSeconds(config.TimeoutSeconds)
            };

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
            httpClient.DefaultRequestHeaders.Accept.Add(
                new MediaTypeWithQualityHeaderValue("application/json")
            );
            httpClient.DefaultRequestHeaders.Add("X-API-Key", config.ApiKey);
            httpClient.DefaultRequestHeaders.Add("X-Tenant-ID", config.TenantId);
            httpClient.DefaultRequestHeaders.Add("X-Restaurant-ID", config.RestaurantId);
            httpClient.DefaultRequestHeaders.Add("X-Plugin-Version", "1.0.0");
        }

        /// <summary>
        /// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
        /// </summary>
        public async Task<bool> PingAsync()
        {
            try
            {
                var response = await httpClient.GetAsync("/api/health");
                return response.IsSuccessStatusCode;
            }
            catch
            {
                return false;
            }
        }

        /// <summary>
        /// –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
        /// </summary>
        public async Task<GuestInfo> FindGuestByPhoneAsync(string phone)
        {
            try
            {
                var cleanPhone = PhoneFormatter.Clean(phone);
                var response = await httpClient.GetAsync($"/api/loyalty/guests/search?phone={cleanPhone}");

                if (!response.IsSuccessStatusCode)
                {
                    if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
                        return null;

                    var error = await response.Content.ReadAsStringAsync();
                    throw new Exception($"API Error: {response.StatusCode} - {error}");
                }

                var json = await response.Content.ReadAsStringAsync();
                return JsonConvert.DeserializeObject<GuestInfo>(json);
            }
            catch (HttpRequestException ex)
            {
                throw new Exception($"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: {ex.Message}", ex);
            }
            catch (TaskCanceledException)
            {
                throw new Exception("–ü—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
            }
        }

        /// <summary>
        /// –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è –ø–æ QR-–∫–æ–¥—É
        /// </summary>
        public async Task<GuestInfo> FindGuestByQRAsync(string qrCode)
        {
            try
            {
                var response = await httpClient.GetAsync($"/api/loyalty/guests/search?qr={qrCode}");

                if (!response.IsSuccessStatusCode)
                {
                    if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
                        return null;

                    var error = await response.Content.ReadAsStringAsync();
                    throw new Exception($"API Error: {response.StatusCode} - {error}");
                }

                var json = await response.Content.ReadAsStringAsync();
                return JsonConvert.DeserializeObject<GuestInfo>(json);
            }
            catch (HttpRequestException ex)
            {
                throw new Exception($"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è –ø–æ 6-–∑–Ω–∞—á–Ω–æ–º—É –∫–æ–¥—É
        /// </summary>
        public async Task<GuestInfo> FindGuestByCodeAsync(string code)
        {
            try
            {
                var response = await httpClient.GetAsync($"/api/loyalty/guests/search?code={code}");

                if (!response.IsSuccessStatusCode)
                {
                    if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
                        return null;

                    var error = await response.Content.ReadAsStringAsync();
                    throw new Exception($"API Error: {response.StatusCode} - {error}");
                }

                var json = await response.Content.ReadAsStringAsync();
                return JsonConvert.DeserializeObject<GuestInfo>(json);
            }
            catch (HttpRequestException ex)
            {
                throw new Exception($"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// –†–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤ (pre-calculation)
        /// </summary>
        public async Task<CalculationResponse> CalculateAsync(CalculationRequest request)
        {
            try
            {
                var json = JsonConvert.SerializeObject(request);
                var content = new StringContent(json, Encoding.UTF8, "application/json");

                var response = await httpClient.PostAsync("/api/loyalty/calculate", content);

                if (!response.IsSuccessStatusCode)
                {
                    var error = await response.Content.ReadAsStringAsync();
                    throw new Exception($"API Error: {response.StatusCode} - {error}");
                }

                var responseJson = await response.Content.ReadAsStringAsync();
                return JsonConvert.DeserializeObject<CalculationResponse>(responseJson);
            }
            catch (HttpRequestException ex)
            {
                throw new Exception($"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {ex.Message}", ex);
            }
            catch (TaskCanceledException)
            {
                throw new Exception("–ü—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç —Ä–∞—Å—á–µ—Ç–∞");
            }
        }

        /// <summary>
        /// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ (—Å–ø–∏—Å–∞–Ω–∏–µ + –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ)
        /// </summary>
        public async Task<bool> ApplyRedeemAsync(RedeemRequest request)
        {
            try
            {
                var json = JsonConvert.SerializeObject(request);
                var content = new StringContent(json, Encoding.UTF8, "application/json");

                var response = await httpClient.PostAsync("/api/loyalty/redeem", content);

                return response.IsSuccessStatusCode;
            }
            catch
            {
                return false;
            }
        }

        public void Dispose()
        {
            httpClient?.Dispose();
        }
    }
}
```


***

## üì± **4. –ú–û–î–ï–õ–ò –î–ê–ù–ù–´–•**

### **Models/GuestInfo.cs**

```csharp
using Newtonsoft.Json;

namespace LoyaltyPluginIiko.Models
{
    public class GuestInfo
    {
        [JsonProperty("id")]
        public string Id { get; set; }

        [JsonProperty("card_id")]
        public string CardId { get; set; }

        [JsonProperty("first_name")]
        public string FirstName { get; set; }

        [JsonProperty("last_name")]
        public string LastName { get; set; }

        [JsonProperty("phone")]
        public string Phone { get; set; }

        [JsonProperty("balance")]
        public int Balance { get; set; }

        [JsonProperty("level")]
        public LoyaltyLevel Level { get; set; }

        [JsonProperty("lifetime_spent")]
        public decimal LifetimeSpent { get; set; }

        [JsonProperty("visits_count")]
        public int VisitsCount { get; set; }

        public string FullName => $"{FirstName} {LastName}".Trim();
    }

    public class LoyaltyLevel
    {
        [JsonProperty("name")]
        public string Name { get; set; }

        [JsonProperty("color")]
        public string Color { get; set; }

        [JsonProperty("earn_percent")]
        public decimal EarnPercent { get; set; }
    }
}
```


### **Models/CalculationRequest.cs**

```csharp
using Newtonsoft.Json;

namespace LoyaltyPluginIiko.Models
{
    public class CalculationRequest
    {
        [JsonProperty("guest_card_id")]
        public string GuestCardId { get; set; }

        [JsonProperty("check_amount")]
        public decimal CheckAmount { get; set; }

        [JsonProperty("redeem_request")]
        public int? RedeemRequest { get; set; }
    }
}
```


### **Models/CalculationResponse.cs**

```csharp
using Newtonsoft.Json;

namespace LoyaltyPluginIiko.Models
{
    public class CalculationResponse
    {
        [JsonProperty("allowed_redeem")]
        public int AllowedRedeem { get; set; }

        [JsonProperty("remaining_balance")]
        public int RemainingBalance { get; set; }

        [JsonProperty("earn_amount")]
        public int EarnAmount { get; set; }

        [JsonProperty("final_price")]
        public decimal FinalPrice { get; set; }

        [JsonProperty("max_redeem_percent")]
        public int MaxRedeemPercent { get; set; }

        [JsonProperty("max_redeem_amount")]
        public int MaxRedeemAmount { get; set; }
    }
}
```


***

## üé® **5. UI - –ì–õ–ê–í–ù–û–ï –û–ö–ù–û**

### **UI/LoyaltyWindow.xaml**

```xml
<Window x:Class="LoyaltyPluginIiko.UI.LoyaltyWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏"
        Width="500" Height="600"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize"
        Background="#F5F5F5">

    <Window.Resources>
        <!-- –°—Ç–∏–ª–∏ -->
        <Style x:Key="HeaderTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="#333333"/>
        </Style>

        <Style x:Key="LabelStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Foreground" Value="#666666"/>
            <Setter Property="Margin" Value="0,0,0,5"/>
        </Style>

        <Style x:Key="ValueStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="#333333"/>
        </Style>

        <Style x:Key="PrimaryButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#4CAF50"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="20,10"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="5"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                            VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#45A049"/>
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Background" Value="#CCCCCC"/>
                    <Setter Property="Cursor" Value="Arrow"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <TextBlock Grid.Row="0" 
                   Text="–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏"
                   Style="{StaticResource HeaderTextStyle}"
                   Margin="0,0,0,20"/>

        <!-- –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è -->
        <Border Grid.Row="1"
                Background="White"
                CornerRadius="8"
                Padding="15"
                Margin="0,0,0,20">
            <StackPanel>
                <TextBlock Text="–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è" 
                          Style="{StaticResource LabelStyle}"/>

                <Grid Margin="0,10,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBox x:Name="SearchTextBox"
                            Grid.Column="0"
                            Height="35"
                            FontSize="14"
                            Padding="10,0"
                            VerticalContentAlignment="Center"
                            KeyDown="SearchTextBox_KeyDown"/>

                    <Button x:Name="QRScanButton"
                           Grid.Column="1"
                           Content="üì∑ QR"
                           Width="60"
                           Height="35"
                           Margin="10,0,0,0"
                           Click="QRScanButton_Click"
                           Style="{StaticResource PrimaryButtonStyle}"/>

                    <Button x:Name="SearchButton"
                           Grid.Column="2"
                           Content="–ù–∞–π—Ç–∏"
                           Width="80"
                           Height="35"
                           Margin="10,0,0,0"
                           Click="SearchButton_Click"
                           Style="{StaticResource PrimaryButtonStyle}"/>
                </Grid>

                <TextBlock x:Name="SearchHintText"
                          Text="–¢–µ–ª–µ—Ñ–æ–Ω, QR-–∫–æ–¥ –∏–ª–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥"
                          FontSize="12"
                          Foreground="#999999"
                          Margin="0,5,0,0"/>
            </StackPanel>
        </Border>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–æ—Å—Ç–µ -->
        <Border x:Name="GuestInfoPanel"
                Grid.Row="2"
                Background="White"
                CornerRadius="8"
                Padding="15"
                Visibility="Collapsed">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <!-- –ò–º—è –≥–æ—Å—Ç—è -->
                    <TextBlock x:Name="GuestNameText"
                              Text="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
                              FontSize="20"
                              FontWeight="Bold"
                              Foreground="#333333"
                              Margin="0,0,0,10"/>

                    <!-- –£—Ä–æ–≤–µ–Ω—å -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                        <Ellipse x:Name="LevelColorIndicator"
                                Width="12" Height="12"
                                Fill="#FFD700"
                                VerticalAlignment="Center"
                                Margin="0,0,8,0"/>
                        <TextBlock x:Name="LevelNameText"
                                  Text="Gold"
                                  FontSize="14"
                                  FontWeight="SemiBold"
                                  Foreground="#666666"/>
                    </StackPanel>

                    <Separator Margin="0,0,0,15"/>

                    <!-- –ë–∞–ª–∞–Ω—Å -->
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0"
                                  Text="–ë–∞–ª–∞–Ω—Å:"
                                  Style="{StaticResource LabelStyle}"/>
                        <TextBlock x:Name="BalanceText"
                                  Grid.Column="1"
                                  Text="2,450 –±."
                                  FontSize="24"
                                  FontWeight="Bold"
                                  Foreground="#4CAF50"/>
                    </Grid>

                    <!-- –°—É–º–º–∞ —á–µ–∫–∞ -->
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0"
                                  Text="–°—É–º–º–∞ —á–µ–∫–∞:"
                                  Style="{StaticResource LabelStyle}"/>
                        <TextBlock x:Name="CheckAmountText"
                                  Grid.Column="1"
                                  Text="2,000‚ÇΩ"
                                  Style="{StaticResource ValueStyle}"/>
                    </Grid>

                    <!-- –î–æ—Å—Ç—É–ø–Ω–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é -->
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0"
                                  Text="–î–æ—Å—Ç—É–ø–Ω–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é:"
                                  Style="{StaticResource LabelStyle}"/>
                        <TextBlock x:Name="MaxRedeemText"
                                  Grid.Column="1"
                                  Text="–¥–æ 400‚ÇΩ (20%)"
                                  Style="{StaticResource ValueStyle}"
                                  Foreground="#FF9800"/>
                    </Grid>

                    <Separator Margin="0,0,0,15"/>

                    <!-- –í–≤–æ–¥ —Å—É–º–º—ã –∫ —Å–ø–∏—Å–∞–Ω–∏—é -->
                    <TextBlock Text="–°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª–æ–≤:"
                              Style="{StaticResource LabelStyle}"/>
                    <Grid Margin="0,5,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBox x:Name="RedeemAmountTextBox"
                                Grid.Column="0"
                                Height="40"
                                FontSize="16"
                                Padding="10,0"
                                VerticalContentAlignment="Center"
                                TextChanged="RedeemAmountTextBox_TextChanged"/>

                        <Button x:Name="MaxRedeemButton"
                               Grid.Column="1"
                               Content="–ú–∞–∫—Å"
                               Width="60"
                               Height="40"
                               Margin="10,0,0,0"
                               Click="MaxRedeemButton_Click"
                               Style="{StaticResource PrimaryButtonStyle}"/>
                    </Grid>

                    <!-- –†–∞—Å—á–µ—Ç -->
                    <Border x:Name="CalculationPanel"
                           Background="#F0F0F0"
                           CornerRadius="5"
                           Padding="10"
                           Margin="0,0,0,15"
                           Visibility="Collapsed">
                        <StackPanel>
                            <Grid Margin="0,0,0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="–û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏:" FontSize="12"/>
                                <TextBlock x:Name="RedeemValueText" Grid.Column="1" Text="-400‚ÇΩ" FontSize="12" FontWeight="Bold"/>
                            </Grid>
                            <Grid Margin="0,0,0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="–ö –æ–ø–ª–∞—Ç–µ:" FontSize="14" FontWeight="SemiBold"/>
                                <TextBlock x:Name="FinalPriceText" Grid.Column="1" Text="1,600‚ÇΩ" FontSize="14" FontWeight="Bold" Foreground="#4CAF50"/>
                            </Grid>
                            <Separator Margin="0,5"/>
                            <Grid Margin="0,5,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ:" FontSize="12" Foreground="#666"/>
                                <TextBlock x:Name="EarnAmountText" Grid.Column="1" Text="+100 –±." FontSize="12" FontWeight="SemiBold" Foreground="#4CAF50"/>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                    <Grid Margin="0,10,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="–ü–æ—Å–µ—â–µ–Ω–∏–π:" FontSize="12" Foreground="#999"/>
                            <TextBlock x:Name="VisitsText" Text="42" FontSize="14" FontWeight="SemiBold"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1">
                            <TextBlock Text="–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ:" FontSize="12" Foreground="#999"/>
                            <TextBlock x:Name="LifetimeText" Text="125,000‚ÇΩ" FontSize="14" FontWeight="SemiBold"/>
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <Grid Grid.Row="3" Margin="0,20,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Button x:Name="ApplyButton"
                   Grid.Column="0"
                   Content="–ü—Ä–∏–º–µ–Ω–∏—Ç—å"
                   Height="45"
                   Margin="0,0,5,0"
                   Click="ApplyButton_Click"
                   Style="{StaticResource PrimaryButtonStyle}"
                   IsEnabled="False"/>

            <Button x:Name="CancelButton"
                   Grid.Column="1"
                   Content="–û—Ç–º–µ–Ω–∞"
                   Height="45"
                   Margin="5,0,0,0"
                   Click="CancelButton_Click"
                   Style="{StaticResource PrimaryButtonStyle}"
                   Background="#757575"/>
        </Grid>

        <!-- –õ–æ–∞–¥–µ—Ä -->
        <Border x:Name="LoadingOverlay"
               Grid.RowSpan="4"
               Background="#80000000"
               Visibility="Collapsed">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="‚è≥" FontSize="48" HorizontalAlignment="Center"/>
                <TextBlock x:Name="LoadingText" 
                          Text="–ó–∞–≥—Ä—É–∑–∫–∞..."
                          FontSize="16"
                          Foreground="White"
                          Margin="0,10,0,0"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –∫–æ–¥–æ–º **LoyaltyWindow.xaml.cs** –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏?

---

## üé® **6. UI - –ö–û–î-BEHIND –ì–õ–ê–í–ù–û–ì–û –û–ö–ù–ê**

### **UI/LoyaltyWindow.xaml.cs**

```csharp
using System;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Input;
using System.Windows.Media;
using Resto.Front.Api;
using Resto.Front.Api.Data.Orders;
using LoyaltyPluginIiko.Models;
using LoyaltyPluginIiko.Services;

namespace LoyaltyPluginIiko.UI
{
    public partial class LoyaltyWindow : Window
    {
        private readonly IOrder order;
        private readonly LoyaltyApiClient apiClient;
        private readonly QRScannerService scannerService;
        private readonly CacheService cacheService;
        private readonly IOperationService operations;
        private readonly ILog log;

        private GuestInfo currentGuest;
        private CalculationResponse currentCalculation;
        private decimal orderTotal;

        public LoyaltyWindow(
            IOrder order,
            LoyaltyApiClient apiClient,
            QRScannerService scannerService,
            CacheService cacheService,
            IOperationService operations,
            ILog log)
        {
            InitializeComponent();

            this.order = order;
            this.apiClient = apiClient;
            this.scannerService = scannerService;
            this.cacheService = cacheService;
            this.operations = operations;
            this.log = log;

            // –í—ã—á–∏—Å–ª—è–µ–º —Å—É–º–º—É –∑–∞–∫–∞–∑–∞
            orderTotal = order.Items.Sum(item => item.Cost);
            CheckAmountText.Text = $"{orderTotal:N0}‚ÇΩ";

            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
            SearchTextBox.Focus();

            log.Info($"LoyaltyWindow: –û—Ç–∫—Ä—ã—Ç–æ –¥–ª—è –∑–∞–∫–∞–∑–∞ #{order.Number}, —Å—É–º–º–∞ {orderTotal:N2}‚ÇΩ");
        }

        /// <summary>
        /// –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è
        /// </summary>
        private async void SearchButton_Click(object sender, RoutedEventArgs e)
        {
            await SearchGuestAsync();
        }

        /// <summary>
        /// Enter –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
        /// </summary>
        private async void SearchTextBox_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter)
            {
                await SearchGuestAsync();
            }
        }

        /// <summary>
        /// –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è –ø–æ –≤–≤–µ–¥–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
        /// </summary>
        private async Task SearchGuestAsync()
        {
            var searchQuery = SearchTextBox.Text.Trim();

            if (string.IsNullOrEmpty(searchQuery))
            {
                MessageBox.Show(
                    "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω, QR-–∫–æ–¥ –∏–ª–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥",
                    "–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning
                );
                return;
            }

            ShowLoading("–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è...");

            try
            {
                log.Info($"LoyaltyWindow: –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è –ø–æ '{searchQuery}'");

                GuestInfo guest = null;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
                var cachedGuest = cacheService.GetGuest(searchQuery);
                if (cachedGuest != null)
                {
                    log.Info("LoyaltyWindow: –ì–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω –≤ –∫–µ—à–µ");
                    guest = cachedGuest;
                }
                else
                {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–∏—Å–∫–∞
                    if (searchQuery.Length == 6 && searchQuery.All(char.IsDigit))
                    {
                        // 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
                        guest = await apiClient.FindGuestByCodeAsync(searchQuery);
                    }
                    else if (searchQuery.StartsWith("+") || searchQuery.All(c => char.IsDigit(c) || c == '+' || c == '(' || c == ')' || c == '-' || c == ' '))
                    {
                        // –¢–µ–ª–µ—Ñ–æ–Ω
                        guest = await apiClient.FindGuestByPhoneAsync(searchQuery);
                    }
                    else
                    {
                        // QR-–∫–æ–¥
                        guest = await apiClient.FindGuestByQRAsync(searchQuery);
                    }

                    if (guest != null)
                    {
                        cacheService.CacheGuest(searchQuery, guest);
                    }
                }

                if (guest == null)
                {
                    HideLoading();
                    MessageBox.Show(
                        "–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.",
                        "–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è",
                        MessageBoxButton.OK,
                        MessageBoxImage.Information
                    );
                    return;
                }

                log.Info($"LoyaltyWindow: –ì–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω - {guest.FullName}, –±–∞–ª–∞–Ω—Å {guest.Balance}");

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ—Å—Ç–µ
                await DisplayGuestInfoAsync(guest);
            }
            catch (Exception ex)
            {
                HideLoading();
                log.Error($"LoyaltyWindow: –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è: {ex.Message}", ex);
                MessageBox.Show(
                    $"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è:\n{ex.Message}",
                    "–û—à–∏–±–∫–∞",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error
                );
            }
        }

        /// <summary>
        /// –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞
        /// </summary>
        private async void QRScanButton_Click(object sender, RoutedEventArgs e)
        {
            ShowLoading("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞...");

            try
            {
                log.Info("LoyaltyWindow: –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞ QR");

                var qrCode = await scannerService.ScanAsync();

                if (string.IsNullOrEmpty(qrCode))
                {
                    HideLoading();
                    MessageBox.Show(
                        "QR-–∫–æ–¥ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω.\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
                        "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
                        MessageBoxButton.OK,
                        MessageBoxImage.Warning
                    );
                    return;
                }

                log.Info($"LoyaltyWindow: QR –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω - {qrCode}");

                SearchTextBox.Text = qrCode;
                await SearchGuestAsync();
            }
            catch (Exception ex)
            {
                HideLoading();
                log.Error($"LoyaltyWindow: –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: {ex.Message}", ex);
                MessageBox.Show(
                    $"–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:\n{ex.Message}",
                    "–û—à–∏–±–∫–∞",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error
                );
            }
        }

        /// <summary>
        /// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥–æ—Å—Ç–µ
        /// </summary>
        private async Task DisplayGuestInfoAsync(GuestInfo guest)
        {
            currentGuest = guest;

            // –ò–º—è
            GuestNameText.Text = guest.FullName;

            // –£—Ä–æ–≤–µ–Ω—å
            LevelNameText.Text = guest.Level?.Name ?? "–ë–µ–∑ —É—Ä–æ–≤–Ω—è";
            
            // –¶–≤–µ—Ç —É—Ä–æ–≤–Ω—è
            if (!string.IsNullOrEmpty(guest.Level?.Color))
            {
                try
                {
                    LevelColorIndicator.Fill = (SolidColorBrush)new BrushConverter().ConvertFrom(guest.Level.Color);
                }
                catch
                {
                    LevelColorIndicator.Fill = new SolidColorBrush(Colors.Gray);
                }
            }

            // –ë–∞–ª–∞–Ω—Å
            BalanceText.Text = $"{guest.Balance:N0} –±.";

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            VisitsText.Text = guest.VisitsCount.ToString();
            LifetimeText.Text = $"{guest.LifetimeSpent:N0}‚ÇΩ";

            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞—Å—á–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–∞–ª–ª–æ–≤
            await CalculateMaxRedeemAsync();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
            GuestInfoPanel.Visibility = Visibility.Visible;
            HideLoading();
        }

        /// <summary>
        /// –†–∞—Å—á–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è
        /// </summary>
        private async Task CalculateMaxRedeemAsync()
        {
            try
            {
                var request = new CalculationRequest
                {
                    GuestCardId = currentGuest.CardId,
                    CheckAmount = orderTotal,
                    RedeemRequest = null
                };

                var calculation = await apiClient.CalculateAsync(request);
                currentCalculation = calculation;

                MaxRedeemText.Text = $"–¥–æ {calculation.MaxRedeemAmount:N0}‚ÇΩ ({calculation.MaxRedeemPercent}%)";

                // –ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å –º–µ–Ω—å—à–µ –º–∞–∫—Å–∏–º—É–º–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                if (currentGuest.Balance < calculation.MaxRedeemAmount)
                {
                    MaxRedeemText.Text = $"–¥–æ {currentGuest.Balance:N0}‚ÇΩ (–≤–µ—Å—å –±–∞–ª–∞–Ω—Å)";
                }

                ApplyButton.IsEnabled = true;
            }
            catch (Exception ex)
            {
                log.Error($"LoyaltyWindow: –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: {ex.Message}", ex);
                MaxRedeemText.Text = "–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞";
            }
        }

        /// <summary>
        /// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É–º–º—ã –∫ —Å–ø–∏—Å–∞–Ω–∏—é
        /// </summary>
        private async void RedeemAmountTextBox_TextChanged(object sender, System.Windows.Controls.TextChangedEventArgs e)
        {
            if (currentGuest == null || currentCalculation == null)
                return;

            var text = RedeemAmountTextBox.Text.Trim();

            if (string.IsNullOrEmpty(text))
            {
                CalculationPanel.Visibility = Visibility.Collapsed;
                return;
            }

            if (!int.TryParse(text, out int redeemAmount) || redeemAmount <= 0)
            {
                CalculationPanel.Visibility = Visibility.Collapsed;
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã
            if (redeemAmount > currentGuest.Balance)
            {
                MessageBox.Show(
                    $"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤.\n–ù–∞ –∫–∞—Ä—Ç–µ: {currentGuest.Balance:N0}",
                    "–°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning
                );
                RedeemAmountTextBox.Text = currentGuest.Balance.ToString();
                return;
            }

            if (redeemAmount > currentCalculation.MaxRedeemAmount)
            {
                MessageBox.Show(
                    $"–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Å–ø–∏—Å–∞–Ω–∏—è.\n–ú–∞–∫—Å–∏–º—É–º: {currentCalculation.MaxRedeemAmount:N0}‚ÇΩ",
                    "–°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning
                );
                RedeemAmountTextBox.Text = currentCalculation.MaxRedeemAmount.ToString();
                return;
            }

            // –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞—Å—á–µ—Ç
            await RecalculateAsync(redeemAmount);
        }

        /// <summary>
        /// –ü–µ—Ä–µ—Å—á–µ—Ç —Å —É—á–µ—Ç–æ–º —Å–ø–∏—Å–∞–Ω–∏—è
        /// </summary>
        private async Task RecalculateAsync(int redeemAmount)
        {
            try
            {
                var request = new CalculationRequest
                {
                    GuestCardId = currentGuest.CardId,
                    CheckAmount = orderTotal,
                    RedeemRequest = redeemAmount
                };

                var calculation = await apiClient.CalculateAsync(request);

                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                RedeemValueText.Text = $"-{calculation.AllowedRedeem:N0}‚ÇΩ";
                FinalPriceText.Text = $"{calculation.FinalPrice:N0}‚ÇΩ";
                EarnAmountText.Text = $"+{calculation.EarnAmount:N0} –±.";

                CalculationPanel.Visibility = Visibility.Visible;

                log.Info($"LoyaltyWindow: –ü–µ—Ä–µ—Å—á–µ—Ç - —Å–ø–∏—Å–∞–Ω–∏–µ {calculation.AllowedRedeem}, –∫ –æ–ø–ª–∞—Ç–µ {calculation.FinalPrice}, –Ω–∞—á–∏—Å–ª–∏—Ç—Å—è {calculation.EarnAmount}");
            }
            catch (Exception ex)
            {
                log.Error($"LoyaltyWindow: –û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞: {ex.Message}", ex);
                CalculationPanel.Visibility = Visibility.Collapsed;
            }
        }

        /// <summary>
        /// –ö–Ω–æ–ø–∫–∞ "–ú–∞–∫—Å–∏–º—É–º"
        /// </summary>
        private void MaxRedeemButton_Click(object sender, RoutedEventArgs e)
        {
            if (currentCalculation == null)
                return;

            var maxAmount = Math.Min(currentGuest.Balance, currentCalculation.MaxRedeemAmount);
            RedeemAmountTextBox.Text = maxAmount.ToString();
        }

        /// <summary>
        /// –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ
        /// </summary>
        private async void ApplyButton_Click(object sender, RoutedEventArgs e)
        {
            if (currentGuest == null)
                return;

            try
            {
                var redeemText = RedeemAmountTextBox.Text.Trim();
                int redeemAmount = 0;

                if (!string.IsNullOrEmpty(redeemText))
                {
                    if (!int.TryParse(redeemText, out redeemAmount))
                    {
                        MessageBox.Show(
                            "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è",
                            "–û—à–∏–±–∫–∞",
                            MessageBoxButton.OK,
                            MessageBoxImage.Warning
                        );
                        return;
                    }
                }

                // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                var message = redeemAmount > 0
                    ? $"–°–ø–∏—Å–∞—Ç—å {redeemAmount:N0} –±–∞–ª–ª–æ–≤?\n\n–ö –æ–ø–ª–∞—Ç–µ: {orderTotal - redeemAmount:N0}‚ÇΩ\n–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: {currentCalculation?.EarnAmount ?? 0:N0} –±."
                    : $"–ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã –±–µ–∑ —Å–ø–∏—Å–∞–Ω–∏—è?\n\n–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: ~{(int)(orderTotal * (currentGuest.Level?.EarnPercent ?? 0) / 100):N0} –±.";

                var result = MessageBox.Show(
                    message,
                    "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
                    MessageBoxButton.YesNo,
                    MessageBoxImage.Question
                );

                if (result != MessageBoxResult.Yes)
                    return;

                ShowLoading("–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤...");

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É –≤ iiko (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ)
                if (redeemAmount > 0)
                {
                    log.Info($"LoyaltyWindow: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ {redeemAmount}‚ÇΩ –∫ –∑–∞–∫–∞–∑—É #{order.Number}");

                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫–∏–¥–∫—É —á–µ—Ä–µ–∑ API iiko
                    var discount = operations.CreateDiscount(
                        name: "–ë–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏",
                        sum: redeemAmount,
                        guest: null
                    );

                    operations.AddDiscount(discount, order);

                    log.Info($"LoyaltyWindow: –°–∫–∏–¥–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ –∑–∞–∫–∞–∑—É #{order.Number}");
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è webhook
                // (–ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —á–µ–∫–∞ iiko –æ—Ç–ø—Ä–∞–≤–∏—Ç webhook –Ω–∞ –Ω–∞—à backend)
                cacheService.CachePendingTransaction(order.Number.ToString(), new PendingTransaction
                {
                    OrderNumber = order.Number.ToString(),
                    GuestCardId = currentGuest.CardId,
                    GuestPhone = currentGuest.Phone,
                    CheckAmount = orderTotal,
                    RedeemedPoints = redeemAmount,
                    Timestamp = DateTime.UtcNow
                });

                HideLoading();

                MessageBox.Show(
                    redeemAmount > 0
                        ? $"‚úÖ –°–∫–∏–¥–∫–∞ {redeemAmount:N0}‚ÇΩ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!\n\n–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ {currentCalculation?.EarnAmount ?? 0:N0} –±."
                        : "‚úÖ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã –±–∞–ª–ª—ã!",
                    "–£—Å–ø–µ—Ö",
                    MessageBoxButton.OK,
                    MessageBoxImage.Information
                );

                log.Info($"LoyaltyWindow: –û–ø–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–ª—è –∑–∞–∫–∞–∑–∞ #{order.Number}");

                this.Close();
            }
            catch (Exception ex)
            {
                HideLoading();
                log.Error($"LoyaltyWindow: –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è: {ex.Message}", ex);
                MessageBox.Show(
                    $"–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–ª–æ–≤:\n{ex.Message}",
                    "–û—à–∏–±–∫–∞",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error
                );
            }
        }

        /// <summary>
        /// –û—Ç–º–µ–Ω–∞
        /// </summary>
        private void CancelButton_Click(object sender, RoutedEventArgs e)
        {
            log.Info("LoyaltyWindow: –û–∫–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º");
            this.Close();
        }

        /// <summary>
        /// –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        /// </summary>
        private void ShowLoading(string message)
        {
            LoadingText.Text = message;
            LoadingOverlay.Visibility = Visibility.Visible;
        }

        /// <summary>
        /// –°–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        /// </summary>
        private void HideLoading()
        {
            LoadingOverlay.Visibility = Visibility.Collapsed;
        }
    }
}
```


***

## üîç **7. QR SCANNER SERVICE**

### **Services/QRScannerService.cs**

```csharp
using System;
using System.IO.Ports;
using System.Threading;
using System.Threading.Tasks;
using Resto.Front.Api;

namespace LoyaltyPluginIiko.Services
{
    /// <summary>
    /// –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç—ã —Å QR-—Å–∫–∞–Ω–µ—Ä–æ–º
    /// </summary>
    public class QRScannerService : IDisposable
    {
        private readonly ILog log;
        private SerialPort serialPort;
        private string lastScannedCode;

        public QRScannerService(ILog log)
        {
            this.log = log;
        }

        /// <summary>
        /// –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞
        /// </summary>
        public async Task<string> ScanAsync(int timeoutSeconds = 30)
        {
            try
            {
                log.Info("QRScanner: –û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...");

                // –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤

                // 1. USB HID —Å–∫–∞–Ω–µ—Ä (—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞)
                var code = await ScanViaKeyboardAsync(timeoutSeconds);
                
                if (!string.IsNullOrEmpty(code))
                {
                    log.Info($"QRScanner: –ö–æ–¥ –ø–æ–ª—É—á–µ–Ω - {code}");
                    return code;
                }

                // 2. COM-–ø–æ—Ä—Ç —Å–∫–∞–Ω–µ—Ä
                code = await ScanViaSerialPortAsync(timeoutSeconds);
                
                if (!string.IsNullOrEmpty(code))
                {
                    log.Info($"QRScanner: –ö–æ–¥ –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ COM - {code}");
                    return code;
                }

                return null;
            }
            catch (Exception ex)
            {
                log.Error($"QRScanner: –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: {ex.Message}", ex);
                throw;
            }
        }

        /// <summary>
        /// –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ HID (–∫–∞–∫ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞)
        /// </summary>
        private async Task<string> ScanViaKeyboardAsync(int timeoutSeconds)
        {
            // –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ USB-—Å–∫–∞–Ω–µ—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
            // –û–Ω–∏ –ø—Ä–æ—Å—Ç–æ "–ø–µ—á–∞—Ç–∞—é—Ç" –∫–æ–¥ –∏ –Ω–∞–∂–∏–º–∞—é—Ç Enter
            
            lastScannedCode = null;
            var cts = new CancellationTokenSource(TimeSpan.FromSeconds(timeoutSeconds));

            try
            {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –Ω—É–∂–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π keyboard hook
                // –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∞–π–º–∞—É—Ç
                await Task.Delay(timeoutSeconds * 1000, cts.Token);
            }
            catch (TaskCanceledException)
            {
                // Timeout
            }

            return lastScannedCode;
        }

        /// <summary>
        /// –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ COM-–ø–æ—Ä—Ç
        /// </summary>
        private async Task<string> ScanViaSerialPortAsync(int timeoutSeconds)
        {
            try
            {
                if (serialPort == null || !serialPort.IsOpen)
                {
                    // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø–æ—Ä—Ç
                    var ports = SerialPort.GetPortNames();
                    if (ports.Length == 0)
                    {
                        log.Warn("QRScanner: COM-–ø–æ—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
                        return null;
                    }

                    serialPort = new SerialPort(ports[0], 9600);
                    serialPort.Open();
                }

                var cts = new CancellationTokenSource(TimeSpan.FromSeconds(timeoutSeconds));
                string scannedCode = null;

                serialPort.DataReceived += (sender, e) =>
                {
                    scannedCode = serialPort.ReadExisting().Trim();
                    cts.Cancel();
                };

                try
                {
                    await Task.Delay(timeoutSeconds * 1000, cts.Token);
                }
                catch (TaskCanceledException)
                {
                    // –ü–æ–ª—É—á–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ
                }

                return scannedCode;
            }
            catch (Exception ex)
            {
                log.Error($"QRScanner: –û—à–∏–±–∫–∞ COM-–ø–æ—Ä—Ç–∞: {ex.Message}", ex);
                return null;
            }
        }

        /// <summary>
        /// –†—É—á–Ω–æ–π –≤–≤–æ–¥ –∫–æ–¥–∞ (fallback)
        /// </summary>
        public void SetScannedCode(string code)
        {
            lastScannedCode = code;
        }

        public void Dispose()
        {
            if (serialPort?.IsOpen == true)
            {
                serialPort.Close();
            }
            serialPort?.Dispose();
        }
    }
}
```


***

## üíæ **8. CACHE SERVICE**

### **Services/CacheService.cs**

```csharp
using System;
using System.Collections.Generic;
using LoyaltyPluginIiko.Models;

namespace LoyaltyPluginIiko.Services
{
    /// <summary>
    /// –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    /// </summary>
    public class CacheService
    {
        private readonly Dictionary<string, CachedGuest> guestCache = new Dictionary<string, CachedGuest>();
        private readonly Dictionary<string, PendingTransaction> pendingTransactions = new Dictionary<string, PendingTransaction>();
        private readonly TimeSpan cacheTTL = TimeSpan.FromMinutes(5);

        /// <summary>
        /// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥–æ—Å—Ç—è –≤ –∫–µ—à
        /// </summary>
        public void CacheGuest(string key, GuestInfo guest)
        {
            var cachedGuest = new CachedGuest
            {
                Guest = guest,
                CachedAt = DateTime.UtcNow
            };

            guestCache[key.ToLowerInvariant()] = cachedGuest;
        }

        /// <summary>
        /// –ü–æ–ª—É—á–∏—Ç—å –≥–æ—Å—Ç—è –∏–∑ –∫–µ—à–∞
        /// </summary>
        public GuestInfo GetGuest(string key)
        {
            var normalizedKey = key.ToLowerInvariant();

            if (!guestCache.ContainsKey(normalizedKey))
                return null;

            var cached = guestCache[normalizedKey];

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º TTL
            if (DateTime.UtcNow - cached.CachedAt > cacheTTL)
            {
                guestCache.Remove(normalizedKey);
                return null;
            }

            return cached.Guest;
        }

        /// <summary>
        /// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–∂–∏–¥–∞—é—â—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        /// </summary>
        public void CachePendingTransaction(string orderNumber, PendingTransaction transaction)
        {
            pendingTransactions[orderNumber] = transaction;
        }

        /// <summary>
        /// –ü–æ–ª—É—á–∏—Ç—å –æ–∂–∏–¥–∞—é—â—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        /// </summary>
        public PendingTransaction GetPendingTransaction(string orderNumber)
        {
            return pendingTransactions.ContainsKey(orderNumber) 
                ? pendingTransactions[orderNumber] 
                : null;
        }

        /// <summary>
        /// –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à
        /// </summary>
        public void Clear()
        {
            guestCache.Clear();
            pendingTransactions.Clear();
        }
    }

    public class CachedGuest
    {
        public GuestInfo Guest { get; set; }
        public DateTime CachedAt { get; set; }
    }

    public class PendingTransaction
    {
        public string OrderNumber { get; set; }
        public string GuestCardId { get; set; }
        public string GuestPhone { get; set; }
        public decimal CheckAmount { get; set; }
        public int RedeemedPoints { get; set; }
        public DateTime Timestamp { get; set; }
    }
}
```


***

## üõ†Ô∏è **9. –£–¢–ò–õ–ò–¢–´**

### **Utils/PhoneFormatter.cs**

```csharp
using System.Text.RegularExpressions;

namespace LoyaltyPluginIiko.Utils
{
    /// <summary>
    /// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
    /// </summary>
    public static class PhoneFormatter
    {
        /// <summary>
        /// –û—á–∏—Å—Ç–∫–∞ –Ω–æ–º–µ—Ä–∞ –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
        /// </summary>
        public static string Clean(string phone)
        {
            if (string.IsNullOrWhiteSpace(phone))
                return string.Empty;

            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ +
            var cleaned = Regex.Replace(phone, @"[^\d+]", "");

            // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 8, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ +7
            if (cleaned.StartsWith("8") && cleaned.Length == 11)
            {
                cleaned = "+7" + cleaned.Substring(1);
            }

            // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 7, –¥–æ–±–∞–≤–ª—è–µ–º +
            if (cleaned.StartsWith("7") && cleaned.Length == 11)
            {
                cleaned = "+" + cleaned;
            }

            return cleaned;
        }

        /// <summary>
        /// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        /// </summary>
        public static string Format(string phone)
        {
            var cleaned = Clean(phone);

            if (cleaned.StartsWith("+7") && cleaned.Length == 12)
            {
                // +7 (999) 123-45-67
                return $"+7 ({cleaned.Substring(2, 3)}) {cleaned.Substring(5, 3)}-{cleaned.Substring(8, 2)}-{cleaned.Substring(10, 2)}";
            }

            return phone;
        }
    }
}
```


### **Utils/Logger.cs**

```csharp
using System;
using System.IO;
using Resto.Front.Api;

namespace LoyaltyPluginIiko.Utils
{
    /// <summary>
    /// –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    /// </summary>
    public static class Logger
    {
        private static readonly string LogPath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "LoyaltyPluginIiko",
            "logs"
        );

        static Logger()
        {
            if (!Directory.Exists(LogPath))
            {
                Directory.CreateDirectory(LogPath);
            }
        }

        /// <summary>
        /// –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª
        /// </summary>
        public static void WriteToFile(string message, string level = "INFO")
        {
            try
            {
                var fileName = $"loyalty_{DateTime.Now:yyyy-MM-dd}.log";
                var filePath = Path.Combine(LogPath, fileName);

                var logEntry = $"[{DateTime.Now:yyyy-MM-dd HH:mm:ss}] [{level}] {message}{Environment.NewLine}";

                File.AppendAllText(filePath, logEntry);
            }
            catch
            {
                // Ignore file errors
            }
        }

        /// <summary>
        /// –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è ILog
        /// </summary>
        public static void Info(ILog log, string message)
        {
            log?.Info(message);
            WriteToFile(message, "INFO");
        }

        public static void Error(ILog log, string message, Exception ex = null)
        {
            log?.Error(message, ex);
            WriteToFile($"{message} | {ex?.Message}", "ERROR");
        }

        public static void Warn(ILog log, string message)
        {
            log?.Warn(message);
            WriteToFile(message, "WARN");
        }
    }
}
```


***

## üìÑ **10. –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ú–û–î–ï–õ–¨**

### **Models/RedeemRequest.cs**

```csharp
using Newtonsoft.Json;

namespace LoyaltyPluginIiko.Models
{
    public class RedeemRequest
    {
        [JsonProperty("guest_card_id")]
        public string GuestCardId { get; set; }

        [JsonProperty("order_number")]
        public string OrderNumber { get; set; }

        [JsonProperty("check_amount")]
        public decimal CheckAmount { get; set; }

        [JsonProperty("redeemed_points")]
        public int RedeemedPoints { get; set; }

        [JsonProperty("paid_amount")]
        public decimal PaidAmount { get; set; }

        [JsonProperty("pos_check_id")]
        public string PosCheckId { get; set; }
    }
}
```


***

## üì¶ **11. CSPROJ –§–ê–ô–õ**

### **LoyaltyPluginIiko.csproj**

```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net48</TargetFramework>
    <OutputType>Library</OutputType>
    <AssemblyName>LoyaltyPluginIiko</AssemblyName>
    <RootNamespace>LoyaltyPluginIiko</RootNamespace>
    <LangVersion>latest</LangVersion>
    <PlatformTarget>x86</PlatformTarget>
  </PropertyGroup>

  <ItemGroup>
    <!-- iiko SDK -->
    <Reference Include="IikoNet">
      <HintPath>..\..\libs\IikoNet.dll</HintPath>
      <Private>False</Private>
    </Reference>
    <Reference Include="Resto.Front.Api.V7">
      <HintPath>..\..\libs\Resto.Front.Api.V7.dll</HintPath>
      <Private>False</Private>
    </Reference>
  </ItemGroup>

  <ItemGroup>
    <!-- NuGet –ø–∞–∫–µ—Ç—ã -->
    <PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
    <PackageReference Include="System.Net.Http" Version="4.3.4" />
  </ItemGroup>

  <ItemGroup>
    <Compile Update="UI\LoyaltyWindow.xaml.cs">
      <DependentUpon>LoyaltyWindow.xaml</DependentUpon>
    </Compile>
  </ItemGroup>

  <ItemGroup>
    <Page Include="UI\LoyaltyWindow.xaml">
      <SubType>Designer</SubType>
      <Generator>MSBuild:Compile</Generator>
    </Page>
  </ItemGroup>

  <!-- –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–∞–ø–∫—É –ø–ª–∞–≥–∏–Ω–æ–≤ iiko –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ -->
  <Target Name="CopyToPlugins" AfterTargets="Build">
    <Copy SourceFiles="$(TargetPath)" 
          DestinationFolder="C:\Program Files\iiko\iikoFront\Plugins\" 
          SkipUnchangedFiles="true" />
    <Copy SourceFiles="$(TargetDir)Newtonsoft.Json.dll" 
          DestinationFolder="C:\Program Files\iiko\iikoFront\Plugins\" 
          SkipUnchangedFiles="true" />
  </Target>

</Project>
```


***

## üìò **12. –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –£–°–¢–ê–ù–û–í–ö–ï**

### **INSTALL.md**

```markdown
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ Loyalty –¥–ª—è iiko Front

## –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Windows 7/8/10/11
- iiko RMS 7.7 –∏–ª–∏ –≤—ã—à–µ
- iiko Front 7.7 –∏–ª–∏ –≤—ã—à–µ
- .NET Framework 4.8

## –®–∞–≥ 1: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ

–°–∫–∞—á–∞–π—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é –ø–ª–∞–≥–∏–Ω–∞:
- `LoyaltyPluginIiko.dll`
- `Newtonsoft.Json.dll`
- `config.json` (—à–∞–±–ª–æ–Ω)

## –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1. –ó–∞–∫—Ä–æ–π—Ç–µ iiko Front (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)

2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫—É –ø–ª–∞–≥–∏–Ω–æ–≤:
```

C:\Program Files\iiko\iikoFront\Plugins\

```

3. –û—Ç–∫—Ä–æ–π—Ç–µ `config.json` –≤ –±–ª–æ–∫–Ω–æ—Ç–µ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ:
```json
{
  "ApiBaseUrl": "https://api.yourloyaltyapp.com",
  "ApiKey": "–≤–∞—à-api-–∫–ª—é—á",
  "RestaurantId": "id-—Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞",
  "TenantId": "id-—Ç–µ–Ω–∞–Ω—Ç–∞",
  "TimeoutSeconds": 5,
  "EnableQRScanner": true,
  "ScannerComPort": "COM1"
}
```

4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `config.json` –≤:

```
C:\Users\%USERNAME%\AppData\Roaming\LoyaltyPluginIiko\
```


## –®–∞–≥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–µ–π

1. –í–æ–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Settings ‚Üí Integrations ‚Üí iiko
3. –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é"
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ:
    - API Key
    - Restaurant ID
    - Tenant ID

## –®–∞–≥ 4: –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `C:\Users\%USERNAME%\AppData\Roaming\LoyaltyPluginIiko\logs\`
3. –ï—Å–ª–∏ –ø–ª–∞–≥–∏–Ω –∑–∞–≥—Ä—É–∑–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ, –≤—ã —É–≤–∏–¥–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏" –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã

## –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ QR-—Å–∫–∞–Ω–µ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### USB HID —Å–∫–∞–Ω–µ—Ä (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Å–∫–∞–Ω–µ—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∫ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞.
–ù–∏–∫–∞–∫–æ–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

### COM-–ø–æ—Ä—Ç —Å–∫–∞–Ω–µ—Ä

1. –£–∑–Ω–∞–π—Ç–µ –Ω–æ–º–µ—Ä COM-–ø–æ—Ä—Ç–∞ –≤ –î–∏—Å–ø–µ—Ç—á–µ—Ä–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
2. –£–∫–∞–∂–∏—Ç–µ –µ–≥–æ –≤ `config.json` ‚Üí `ScannerComPort`

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑ –≤ iiko Front
2. –ù–∞–∂–º–∏—Ç–µ "–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏"
3. –í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –≥–æ—Å—Ç—è
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞

## Troubleshooting

### –ü–ª–∞–≥–∏–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é iiko (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 7.7+)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ .NET Framework 4.8
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ `%AppData%\LoyaltyPluginIiko\logs\`


### –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API Key –∏ URL
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall (—Ä–∞–∑—Ä–µ—à–∏—Ç–µ iiko Front –¥–æ—Å—Ç—É–ø –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)


### QR-—Å–∫–∞–Ω–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫–∞–Ω–µ—Ä–∞ (USB/COM)
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `config.json`


## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞

1. –ó–∞–∫—Ä–æ–π—Ç–µ iiko Front
2. –ó–∞–º–µ–Ω–∏—Ç–µ `LoyaltyPluginIiko.dll` –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front

**–í–∞–∂–Ω–æ**: `config.json` —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏.

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

Email: support@yourloyaltyapp.com
Telegram: @loyalty_support
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://docs.yourloyaltyapp.com

```

***

## üöÄ **13. README**

### **README.md**

```markdown
# üîå –ü–ª–∞–≥–∏–Ω —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è iiko Front

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Å –∫–∞—Å—Å–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π iiko.

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üîç **–ü–æ–∏—Å–∫ –≥–æ—Å—Ç–µ–π** –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É, QR-–∫–æ–¥—É –∏–ª–∏ 6-–∑–Ω–∞—á–Ω–æ–º—É –∫–æ–¥—É
- üìä **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞** –∏ —É—Ä–æ–≤–Ω—è –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- üí≥ **–°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤** –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ (—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ä–∞—Å—á–µ—Ç–æ–º –ª–∏–º–∏—Ç–æ–≤)
- üéÅ **–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤** –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —á–µ–∫–∞
- üì± **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ QR-—Å–∫–∞–Ω–µ—Ä–æ–≤** (USB HID –∏ COM-–ø–æ—Ä—Ç)
- ‚ö° **–ë—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞** (–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ç–∞–π–º–∞—É—Ç 200ms)
- üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** (HTTPS, API Key, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ)

## üì¶ –°–æ—Å—Ç–∞–≤

```

LoyaltyPluginIiko/
‚îú‚îÄ‚îÄ LoyaltyPluginIiko.dll       \# –û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–∞–≥–∏–Ω
‚îú‚îÄ‚îÄ Newtonsoft.Json.dll          \# JSON –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
‚îú‚îÄ‚îÄ config.json                  \# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ INSTALL.md                   \# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
‚îî‚îÄ‚îÄ README.md                    \# –≠—Ç–æ—Ç —Ñ–∞–π–ª

```

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```

1. –ö–∞—Å—Å–∏—Ä —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ –≤ iiko Front
2. –ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏"
3. –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR-–∫–æ–¥ –∏–ª–∏ –≤–≤–æ–¥–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω –≥–æ—Å—Ç—è
4. –í–∏–¥–∏—Ç –±–∞–ª–∞–Ω—Å –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±–∞–ª–ª—ã
5. –ì–æ—Å—Ç—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ —Å–ø–∏—Å–∞—Ç—å
6. –ü–ª–∞–≥–∏–Ω –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å–∫–∏–¥–∫—É –∫ –∑–∞–∫–∞–∑—É
7. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã iiko –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ backend
8. Backend –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–ª—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
```

## üì∏ –°–∫—Ä–∏–Ω—à–æ—Ç—ã

### –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ
[–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞]

### –†–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤
[–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç —Ä–∞—Å—á–µ—Ç–∞]

## üîß –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Windows 7 –∏–ª–∏ –≤—ã—à–µ
- iiko Front 7.7+
- .NET Framework 4.8
- –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–ª—è —Å–≤—è–∑–∏ —Å backend

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

- Email: support@yourloyaltyapp.com
- Telegram: @loyalty_support
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://docs.yourloyaltyapp.com

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

¬© 2026 YourLoyaltyApp. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
```


***

## ‚úÖ **–ß–¢–û –ü–û–õ–£–ß–ò–õ–û–°–¨**

### **–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π production-ready –ø–ª–∞–≥–∏–Ω:**

1. ‚úÖ **–ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –ø–ª–∞–≥–∏–Ω–∞** —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
2. ‚úÖ **API Client** –¥–ª—è —Å–≤—è–∑–∏ —Å backend
3. ‚úÖ **UI (WPF)** —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º
4. ‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ QR-—Å–∫–∞–Ω–µ—Ä–æ–≤** (USB + COM)
5. ‚úÖ **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
6. ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
7. ‚úÖ **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** —á–µ—Ä–µ–∑ JSON
8. ‚úÖ **–£—Ç–∏–ª–∏—Ç—ã** (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
9. ‚úÖ **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏** –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

***

## üéØ **–°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò**

1. **–ö–æ–º–ø–∏–ª—è—Ü–∏—è:**

```bash
dotnet build LoyaltyPluginIiko.sln -c Release
```

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
    - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Å—Å—É
    - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
    - –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
3. **–ü–æ–ª—É—á–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–∏ iiko:**
    - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ
    - –ü–æ–ª—É—á–∏—Ç—å Module ID –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞
4. **–î–∏—Å—Ç—Ä–∏–±—É—Ü–∏—è:**
    - –°–æ–∑–¥–∞—Ç—å installer (.msi)
    - –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞

–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å —á–µ–º-—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ? –ò–ª–∏ —Ö–æ—á–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –ø–ª–∞–≥–∏–Ω?

---

# üîì **–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –ü–õ–ê–ì–ò–ù–ê –ë–ï–ó –õ–ò–¶–ï–ù–ó–ò–ò IIKO**

–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä–µ–º **–≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã** –∏ —á—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –ª–µ–≥–∞–ª—å–Ω–æ.

***

## ‚úÖ **–î–ê, –ú–û–ñ–ù–û! (–° –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø–ú–ò)**

### **–í–∞—Ä–∏–∞–Ω—Ç 1: –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

**–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:**

- –í—ã —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ –ø–ª–∞–≥–∏–Ω **–¥–ª—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤**
- –ù–µ –ø—Ä–æ–¥–∞–µ—Ç–µ –∏ –Ω–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç–µ –ø–ª–∞–≥–∏–Ω –¥—Ä—É–≥–∏–º –∫–æ–º–ø–∞–Ω–∏—è–º
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö —Å–≤–æ–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞

**–¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –ª–∏—Ü–µ–Ω–∑–∏—è:**

```
‚ùå –ù–ï–¢ - –ª–∏—Ü–µ–Ω–∑–∏—è iiko –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø!
```

**–ü–æ—á–µ–º—É:**

- iiko **–ù–ï –∑–∞–ø—Ä–µ—â–∞–µ—Ç** —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–ª–∞–≥–∏–Ω—ã –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- iiko SDK **–ø—É–±–ª–∏—á–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω** –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- –í—ã –ø–ª–∞—Ç–∏—Ç–µ –∑–∞ iiko RMS (—ç—Ç–æ –≤–∞—à–∞ –ª–∏—Ü–µ–Ω–∑–∏—è –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)
- –ü–ª–∞–≥–∏–Ω = —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –≤–∞—à–µ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–∞—Å—Å—ã

**–ß—Ç–æ –º–æ–∂–Ω–æ:**

- ‚úÖ –†–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–ª–∞–≥–∏–Ω –¥–ª—è —Å–≤–æ–µ–π —Å–µ—Ç–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
- ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –Ω–∞ –≤—Å–µ —Å–≤–æ–∏ –∫–∞—Å—Å—ã
- ‚úÖ –û–±–Ω–æ–≤–ª—è—Ç—å –∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Å–≤–æ–µ–º—É —É—Å–º–æ—Ç—Ä–µ–Ω–∏—é
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö —Ü–µ–ª—è—Ö (–≤ —Å–≤–æ–∏—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞—Ö)

***

### **–í–∞—Ä–∏–∞–Ω—Ç 2: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ë–ï–ó –ø–ª–∞–≥–∏–Ω–∞**

**–ï—â–µ –ø—Ä–æ—â–µ - –≤–æ–æ–±—â–µ –ù–ï –¥–µ–ª–∞—Ç—å –ø–ª–∞–≥–∏–Ω!**

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ **API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         –í–ê–®–ê –°–ò–°–¢–ï–ú–ê –õ–û–Ø–õ–¨–ù–û–°–¢–ò             ‚îÇ
‚îÇ            (Backend API)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚îÇ Webhooks + REST API
                  ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                    ‚îÇ
        ‚ñº                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  iiko RMS    ‚îÇ    ‚îÇ  iiko Front  ‚îÇ
‚îÇ  (—Å–µ—Ä–≤–µ—Ä)    ‚îÇ    ‚îÇ   (–∫–∞—Å—Å–∞)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ë–ï–ó –ø–ª–∞–≥–∏–Ω–∞:**

#### **–ù–∞ –∫–∞—Å—Å–µ (iiko Front):**

1. **–ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω–µ—à–Ω–∏–π –ø–ª–∞–Ω—à–µ—Ç/—ç–∫—Ä–∞–Ω:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  iiko Front    ‚îÇ        ‚îÇ –ü–ª–∞–Ω—à–µ—Ç (iPad/   ‚îÇ
‚îÇ  (–æ—Å–Ω–æ–≤–Ω–∞—è     ‚îÇ   WiFi ‚îÇ  Android tablet) ‚îÇ
‚îÇ   –∫–∞—Å—Å–∞)       ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ Web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ   ‚îÇ
                          ‚îÇ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º—ã    ‚îÇ
                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

2. **–§–ª–æ—É —Ä–∞–±–æ—Ç—ã:**

```
1. –ö–∞—Å—Å–∏—Ä —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —á–µ–∫ –≤ iiko
2. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–ª–∞–Ω—à–µ—Ç —Å –≤–∞—à–∏–º web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
3. –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR-–∫–æ–¥ –≥–æ—Å—Ç—è –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ
4. –í–∏–¥–∏—Ç –±–∞–ª–∞–Ω—Å –∏ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ø–∏—Å–∞–Ω–∏–µ
5. –ü–ª–∞–Ω—à–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥/–∫—É–ø–æ–Ω
6. –ö–∞—Å—Å–∏—Ä –≤–≤–æ–¥–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –≤ iiko –∫–∞–∫ —Å–∫–∏–¥–∫—É
7. –ó–∞–≤–µ—Ä—à–∞–µ—Ç –æ–ø–ª–∞—Ç—É
8. iiko –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –≤–∞–º
9. –í—ã –Ω–∞—á–∏—Å–ª—è–µ—Ç–µ –±–∞–ª–ª—ã
```


#### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:**

‚úÖ **–ù–ï –Ω—É–∂–µ–Ω –ø–ª–∞–≥–∏–Ω** - –Ω–∏–∫–∞–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º —Å –ª–∏—Ü–µ–Ω–∑–∏—è–º–∏
‚úÖ **–ù–ï –Ω—É–∂–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞** –Ω–∞ –∫–∞—Å—Å—É - –ø—Ä–æ—Å—Ç–æ –±—Ä–∞—É–∑–µ—Ä
‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–π POS** - –Ω–µ —Ç–æ–ª—å–∫–æ iiko
‚úÖ **–ü—Ä–æ—â–µ –æ–±–Ω–æ–≤–ª—è—Ç—å** - –º–µ–Ω—è–µ—Ç–µ web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∞ –Ω–µ –ø–ª–∞–≥–∏–Ω
‚úÖ **–ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ iPad, Android, Windows
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ** - –∫–∞—Å—Å–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç –≤–∞—à–µ–≥–æ –∫–æ–¥–∞

‚ùå **–ú–∏–Ω—É—Å:** —á—É—Ç—å –º–µ–Ω–µ–µ —É–¥–æ–±–Ω–æ (2 —ç–∫—Ä–∞–Ω–∞ –≤–º–µ—Å—Ç–æ 1)

***

### **–í–∞—Ä–∏–∞–Ω—Ç 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ iiko RMS API (–±–µ–∑ –∫–∞—Å—Å)**

**–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç - —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**

```
1. –ì–æ—Å—Ç—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∫–∞—Å—Å–∏—Ä—É
2. –ö–∞—Å—Å–∏—Ä –≤—Ä—É—á–Ω—É—é –≤–≤–æ–¥–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω –≤ iiko Front
3. –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å–∫–∏–¥–∫—É –≤—Ä—É—á–Ω—É—é (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
4. –ó–∞–≤–µ—Ä—à–∞–µ—Ç —á–µ–∫
5. iiko RMS –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –≤–∞–º
6. –í–∞—à backend:
   - –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ–∫–∞
   - –ù–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≥–æ—Å—Ç—é –≤ Telegram
```

**–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è:**

- ‚úÖ –¢–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å **webhooks –≤ iiko RMS**
- ‚úÖ –í–∞—à backend –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ–∫–æ–≤
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–ª—ã

**–ù–∏–∫–∞–∫–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞ –Ω–µ –Ω—É–∂–Ω–æ!**

***

## üìã **–°–†–ê–í–ù–ï–ù–ò–ï –í–ê–†–ò–ê–ù–¢–û–í**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ü–ª–∞–≥–∏–Ω (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π) | –ü–ª–∞–Ω—à–µ—Ç + Web | –¢–æ–ª—å–∫–æ API |
| :-- | :-- | :-- | :-- |
| –õ–∏—Ü–µ–Ω–∑–∏—è iiko | ‚ùå –ù–µ –Ω—É–∂–Ω–∞ | ‚ùå –ù–µ –Ω—É–∂–Ω–∞ | ‚ùå –ù–µ –Ω—É–∂–Ω–∞ |
| –£–¥–æ–±—Å—Ç–≤–æ –∫–∞—Å—Å–∏—Ä–∞ | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê |
| –°–ª–æ–∂–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è | 0‚ÇΩ | ~15,000‚ÇΩ (–ø–ª–∞–Ω—à–µ—Ç) | 0‚ÇΩ |
| –û–±–Ω–æ–≤–ª–µ–Ω–∏—è | –°–ª–æ–∂–Ω–æ | –õ–µ–≥–∫–æ | –õ–µ–≥–∫–æ |
| –†–∞–±–æ—Ç–∞ —Å –¥—Ä—É–≥–∏–º–∏ POS | ‚ùå –¢–æ–ª—å–∫–æ iiko | ‚úÖ –õ—é–±—ã–µ | ‚úÖ –õ—é–±—ã–µ |
| –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ | –ü–æ–ª—É–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ | –í—Ä—É—á–Ω—É—é |
| –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |


***

## üí° **–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø –î–õ–Ø –í–ê–®–ï–ì–û –°–õ–£–ß–ê–Ø**

### **–ï—Å–ª–∏ —É –≤–∞—Å 1-3 —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:**

**–í–∞—Ä–∏–∞–Ω—Ç 2: –ü–ª–∞–Ω—à–µ—Ç + Web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**

```
–ü–æ—á–µ–º—É:
‚úÖ –ü—Ä–æ—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (–ø—Ä–æ—Å—Ç–æ –¥–∞—Ç—å –ø–ª–∞–Ω—à–µ—Ç –∫–∞—Å—Å–∏—Ä–∞–º)
‚úÖ –ù–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –Ω–∞ –∫–∞—Å—Å—ã
‚úÖ –õ–µ–≥–∫–æ –æ–±–Ω–æ–≤–ª—è—Ç—å (–ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ—Ç–µ —Å–∞–π—Ç)
‚úÖ –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å –ª—é–±–æ–π POS –≤ –±—É–¥—É—â–µ–º
‚úÖ –°—Ç–æ–∏–º–æ—Å—Ç—å: ~15,000‚ÇΩ –∑–∞ –ø–ª–∞–Ω—à–µ—Ç (—Ä–∞–∑–æ–≤–∞—è)
```

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏:**

```typescript
// –ü—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–µ—Ç–µ PWA (Progressive Web App)
// –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ
// –ò–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –¥–ª—è QR-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
// –í—Å–µ –ª–æ–≥–∏–∫–∞ –Ω–∞ –≤–∞—à–µ–º backend

https://loyalty.yourapp.com/cashier
```


### **–ï—Å–ª–∏ —É –≤–∞—Å 10+ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤:**

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ü–ª–∞–≥–∏–Ω (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)**

```
–ü–æ—á–µ–º—É:
‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —É–¥–æ–±—Å—Ç–≤–æ –¥–ª—è –∫–∞—Å—Å–∏—Ä–æ–≤
‚úÖ –í—Å–µ –≤ –æ–¥–Ω–æ–º –æ–∫–Ω–µ iiko Front
‚úÖ –†–∞–∑–æ–≤–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
‚úÖ –ù–µ –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞–Ω—à–µ—Ç—ã
‚úÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤–∏–¥
```

**–õ–∏—Ü–µ–Ω–∑–∏—è –ù–ï –Ω—É–∂–Ω–∞**, —Ç–∞–∫ –∫–∞–∫:

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
- –ù–µ –ø—Ä–æ–¥–∞–µ—Ç–µ –¥—Ä—É–≥–∏–º –∫–æ–º–ø–∞–Ω–∏—è–º

***

## üéØ **–ß–¢–û –î–ï–õ–ê–¢–¨ –° –ü–õ–ê–ì–ò–ù–û–ú, –ö–û–¢–û–†–´–ô –ú–´ –°–û–ó–î–ê–õ–ò**

### **–î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

**1. –£–±–µ—Ä–∏—Ç–µ –∏–∑ –∫–æ–¥–∞ `[PluginLicenseModuleId(0x0000000)]`:**

```csharp
// –ë–´–õ–û:
[PluginLicenseModuleId(0x0000000)] // –ü–æ–ª—É—á–∏—Ç—å —É iiko
public sealed class LoyaltyPlugin : IFrontPlugin

// –°–¢–ê–õ–û:
// [PluginLicenseModuleId(0x0000000)] // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ - –Ω–µ –Ω—É–∂–Ω–æ!
public sealed class LoyaltyPlugin : IFrontPlugin
```

**2. –í –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ –ø–ª–∞–≥–∏–Ω–∞ —É–∫–∞–∂–∏—Ç–µ:**

```json
{
  "name": "Internal Loyalty Plugin",
  "version": "1.0.0",
  "description": "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–ª–∞–≥–∏–Ω –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è [–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π —Å–µ—Ç–∏]",
  "for_internal_use_only": true,
  "author": "Internal Dev Team"
}
```

**3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –∫–∞—Å—Å—ã:**

- –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ª–∏—Ü–µ–Ω–∑–∏–∏ ‚úÖ
- –ù–∏–∫–∞–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º —Å iiko ‚úÖ
- –ü–æ–ª–Ω–æ—Å—Ç—å—é –ª–µ–≥–∞–ª—å–Ω–æ ‚úÖ

***

## ‚ö†Ô∏è **–ö–û–ì–î–ê –ù–£–ñ–ù–ê –õ–ò–¶–ï–ù–ó–ò–Ø IIKO**

–õ–∏—Ü–µ–Ω–∑–∏—è **–¢–†–ï–ë–£–ï–¢–°–Ø —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:**

‚ùå –í—ã **–ø—Ä–æ–¥–∞–µ—Ç–µ** –ø–ª–∞–≥–∏–Ω –¥—Ä—É–≥–∏–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º
‚ùå –í—ã **–ø—É–±–ª–∏–∫—É–µ—Ç–µ** –ø–ª–∞–≥–∏–Ω –≤ iiko Store
‚ùå –í—ã –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç–µ —Å–µ–±—è –∫–∞–∫ **–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä iiko**
‚ùå –í—ã —Ö–æ—Ç–∏—Ç–µ **–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—Ç—å** –ø–ª–∞–≥–∏–Ω

**–î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è - –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è!**

***

## üìû **–ù–ê –í–°–Ø–ö–ò–ô –°–õ–£–ß–ê–ô: –ö–ê–ö –ü–û–õ–£–ß–ò–¢–¨ –û–§–ò–¶–ò–ê–õ–¨–ù–û–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï**

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –±—ã—Ç—å –Ω–∞ 100% —É–≤–µ—Ä–µ–Ω—ã:

**1. –ù–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É iiko:**

```
Email: support@iiko.ru
–¢–µ–º–∞: "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"

–¢–µ–∫—Å—Ç:
"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!

–ú—ã —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–ª–∞–≥–∏–Ω –¥–ª—è iiko Front –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è 
–≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π —Å–µ—Ç–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ (–Ω–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏).

–ù—É–∂–Ω–∞ –ª–∏ –Ω–∞–º –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è?

–° —É–≤–∞–∂–µ–Ω–∏–µ–º,
[–í–∞—à–µ –∏–º—è]"
```

**2. –û—Ç–≤–µ—Ç –æ–±—ã—á–Ω–æ:**

```
"–î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª–∏—Ü–µ–Ω–∑–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π SDK.
–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è."
```


***

## üöÄ **–ò–¢–û–ì–û–í–ê–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø**

### **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥:**

**–≠—Ç–∞–ø 1 (MVP, 1-2 –º–µ—Å—è—Ü–∞):**

- ‚úÖ –¢–æ–ª—å–∫–æ API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–í–∞—Ä–∏–∞–Ω—Ç 3)
- ‚úÖ –ö–∞—Å—Å–∏—Ä –≤–≤–æ–¥–∏—Ç —Å–∫–∏–¥–∫—É –≤—Ä—É—á–Ω—É—é
- ‚úÖ –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –±–µ–∑ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

**–≠—Ç–∞–ø 2 (—á–µ—Ä–µ–∑ 2-3 –º–µ—Å—è—Ü–∞):**

- ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç–µ –ø–ª–∞–Ω—à–µ—Ç –Ω–∞ –∫–∞—Å—Å–µ (–í–∞—Ä–∏–∞–Ω—Ç 2)
- ‚úÖ Web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫–∞—Å—Å–∏—Ä–æ–≤
- ‚úÖ –ü—Ä–æ—â–µ –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å

**–≠—Ç–∞–ø 3 (–ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ 10+ —Ç–æ—á–µ–∫):**

- ‚úÖ –†–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ –ø–ª–∞–≥–∏–Ω (–í–∞—Ä–∏–∞–Ω—Ç 1)
- ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç–µ –Ω–∞ –≤—Å–µ –∫–∞—Å—Å—ã
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —É–¥–æ–±—Å—Ç–≤–æ

***

## ‚úÖ **–û–¢–í–ï–¢ –ù–ê –í–ê–® –í–û–ü–†–û–°**

**–î–∞, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–∞–≥–∏–Ω –ë–ï–ó –ª–∏—Ü–µ–Ω–∑–∏–∏ iiko!**

–£—Å–ª–æ–≤–∏–µ: **—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤** (–Ω–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏).

**–ú–æ–π —Å–æ–≤–µ—Ç:**
–ù–∞—á–Ω–∏—Ç–µ —Å **–ø–ª–∞–Ω—à–µ—Ç–∞ + web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** (–í–∞—Ä–∏–∞–Ω—Ç 2) - —ç—Ç–æ –ø—Ä–æ—â–µ, –±—ã—Å—Ç—Ä–µ–µ –∏ –≥–∏–±—á–µ. –ü–ª–∞–≥–∏–Ω –æ—Å—Ç–∞–≤—å—Ç–µ –Ω–∞ –ø–æ—Ç–æ–º, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç 10+ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤.

–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–∞?

---

# üéØ **–í–ê–®–ê –ë–ò–ó–ù–ï–°-–ú–û–î–ï–õ–¨ - –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó**

–û—Ç–ª–∏—á–Ω–∞—è –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å! –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º **–ª–µ–≥–∞–ª—å–Ω–æ—Å—Ç—å, —Ä–∏—Å–∫–∏ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥**.

***

## ‚úÖ **–ö–û–†–û–¢–ö–ò–ô –û–¢–í–ï–¢: –î–ê, –¢–ê–ö –ú–û–ñ–ù–û!**

**–í–∞—à–∞ –º–æ–¥–µ–ª—å:**

```
–í—ã –ø—Ä–æ–¥–∞–µ—Ç–µ: SaaS-–ø–ª–∞—Ç—Ñ–æ—Ä–º—É (–ø–æ–¥–ø–∏—Å–∫–∞)
‚îú‚îÄ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
‚îú‚îÄ –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
‚îú‚îÄ CRM –¥–ª—è –≥–æ—Å—Ç–µ–π
‚îî‚îÄ –ü–ª–∞–≥–∏–Ω (–∫–∞–∫ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–∞)

–ü–ª–∞–≥–∏–Ω = —á–∞—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞, –Ω–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–æ–≤–∞—Ä
```

**–≠—Ç–æ –ª–µ–≥–∞–ª—å–Ω–æ, –µ—Å–ª–∏:**

- ‚úÖ –ü–ª–∞–≥–∏–Ω **–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π** –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (—á–∞—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏)
- ‚úÖ –ù–µ –ø—É–±–ª–∏–∫—É–µ—Ç–µ –≤ **iiko Store**
- ‚úÖ –ù–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç–µ –∫–∞–∫ **–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä iiko**
- ‚úÖ –ü–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ —Å –≤–∞—à–∏–º backend** (–Ω–µ standalone)

***

## üìä **–ê–ù–ê–õ–û–ì–ò–Ø –° –î–†–£–ì–ò–ú–ò –ü–†–û–î–£–ö–¢–ê–ú–ò**

### **–ü–æ—Ö–æ–∂–∏–µ —É—Å–ø–µ—à–Ω—ã–µ –∫–µ–π—Å—ã:**

**1. Stripe (–ø–ª–∞—Ç–µ–∂–∏):**

```
–ü—Ä–æ–¥–∞—é—Ç: API –ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥–∞ –ø–ª–∞—Ç–µ–∂–µ–π
–î–∞—é—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ: SDK/–ø–ª–∞–≥–∏–Ω—ã –¥–ª—è –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç: –ù–∞ –∫–æ–º–∏—Å—Å–∏–∏ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
```

**2. Poster POS (–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç iiko):**

```
–ü—Ä–æ–¥–∞—é—Ç: –û–±–ª–∞—á–Ω–∞—è –∫–∞—Å—Å–∞
–î–∞—é—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ: –ü–ª–∞–≥–∏–Ω—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –¥–æ—Å—Ç–∞–≤–∫–∞–º–∏
–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç: –ù–∞ –ø–æ–¥–ø–∏—Å–∫–µ
```

**3. Jowi (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–º):**

```
–ü—Ä–æ–¥–∞—é—Ç: –ü–ª–∞—Ç—Ñ–æ—Ä–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
–î–∞—é—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏
–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç: –ù–∞ –ø–æ–¥–ø–∏—Å–∫–µ
```

**–í–∞—à–∞ –º–æ–¥–µ–ª—å - —Ç–æ –∂–µ —Å–∞–º–æ–µ!** ‚úÖ

***

## ‚öñÔ∏è **–Æ–†–ò–î–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó**

### **–ß—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ (–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è iiko):**

```
‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ iiko SDK –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
‚úÖ –ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
‚úÖ SaaS-–º–æ–¥–µ–ª—å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º iiko API
```


### **–ß—Ç–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ:**

```
‚ùå –ü—Ä–æ–¥–∞–∂–∞ –ø–ª–∞–≥–∏–Ω–∞ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
‚ùå –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ iiko Store –±–µ–∑ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ "iiko" –±–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
‚ùå –û–±—Ä–∞—Ç–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (reverse engineering)
```


### **–í–∞—à —Å–ª—É—á–∞–π:**

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –í–∞—à–∞ –º–æ–¥–µ–ª—å | –†–∞–∑—Ä–µ—à–µ–Ω–æ? |
| :-- | :-- | :-- |
| –ü—Ä–æ–¥–∞–µ—Ç–µ –ø–ª–∞–≥–∏–Ω –æ—Ç–¥–µ–ª—å–Ω–æ? | ‚ùå –ù–µ—Ç, —á–∞—Å—Ç—å SaaS | ‚úÖ –î–ê |
| –ò—Å–ø–æ–ª—å–∑—É–µ—Ç–µ iiko SDK? | ‚úÖ –î–∞, –ø—É–±–ª–∏—á–Ω—ã–π | ‚úÖ –î–ê |
| –ü—É–±–ª–∏–∫—É–µ—Ç–µ –≤ iiko Store? | ‚ùå –ù–µ—Ç | ‚úÖ –î–ê |
| –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç–µ –∫–∞–∫ –ø–∞—Ä—Ç–Ω–µ—Ä iiko? | ‚ùå –ù–µ—Ç | ‚úÖ –î–ê |
| –ü–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –≤–∞—à–µ–≥–æ backend? | ‚ùå –ù–µ—Ç | ‚úÖ –î–ê |
| –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫–µ? | ‚úÖ –î–∞ | ‚úÖ –î–ê |

**–ò–¢–û–ì–û: –õ–µ–≥–∞–ª—å–Ω–æ** ‚úÖ

***

## üèóÔ∏è **–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê**

### **–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç: –ü–ª–∞–≥–∏–Ω = –ø—Ä–æ—Å—Ç–æ –∫–ª–∏–µ–Ω—Ç –¥–ª—è –≤–∞—à–µ–≥–æ API**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         –í–ê–®–ê –ü–õ–ê–¢–§–û–†–ú–ê (SaaS)               ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ        Backend API (NestJS)          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Loyalty Engine                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - CRM                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Billing                            ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  –ü–æ–¥–ø–∏—Å–∫–∞: 5,000‚ÇΩ/–º–µ—Å ‚Üí –í–ê–® –ó–ê–†–ê–ë–û–¢–û–ö     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚îÇ REST API (HTTPS)
                  ‚îÇ (–ø–ª–∞–≥–∏–Ω –æ–±—Ä–∞—â–∞–µ—Ç—Å—è —Å—é–¥–∞)
                  ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                    ‚îÇ
        ‚ñº                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü–ª–∞–≥–∏–Ω      ‚îÇ    ‚îÇ  Telegram    ‚îÇ
‚îÇ  (iiko)      ‚îÇ    ‚îÇ  Mini App    ‚îÇ
‚îÇ              ‚îÇ    ‚îÇ              ‚îÇ
‚îÇ –ë–ï–°–ü–õ–ê–¢–ù–´–ô   ‚îÇ    ‚îÇ –ë–ï–°–ü–õ–ê–¢–ù–´–ô   ‚îÇ
‚îÇ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç   ‚îÇ    ‚îÇ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ü–ª–∞–≥–∏–Ω:**

- ‚úÖ –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
- ‚úÖ –¢–æ–ª—å–∫–æ UI + API –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ –ë–µ—Å–ø–æ–ª–µ–∑–µ–Ω –±–µ–∑ –≤–∞—à–µ–≥–æ backend
- ‚úÖ –ù–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å standalone

**–ê–Ω–∞–ª–æ–≥–∏—è:** –ü–ª–∞–≥–∏–Ω = –ø—É–ª—å—Ç –æ—Ç —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–∞, –∞ –≤–∞—à backend = —Å–∞–º —Ç–µ–ª–µ–≤–∏–∑–æ—Ä. –ü—É–ª—å—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π, –Ω–æ –±–µ–∑ —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–∞ –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω.

***

## üìù **–ö–ê–ö –ü–†–ê–í–ò–õ–¨–ù–û –û–§–û–†–ú–ò–¢–¨**

### **1. –í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö/–¥–æ–≥–æ–≤–æ—Ä–∞—Ö —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏:**

```markdown
# –õ–ò–¶–ï–ù–ó–ò–û–ù–ù–û–ï –°–û–ì–õ–ê–®–ï–ù–ò–ï

## –ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ:

1. –î–æ—Å—Ç—É–ø –∫ SaaS-–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ [YourBrand]
   - –ü–æ–¥–ø–∏—Å–∫–∞: 5,000‚ÇΩ/–º–µ—Å—è—Ü
   - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞, –ª–æ—è–ª—å–Ω–æ—Å—Ç—å, CRM

2. –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–∞:
   - –ü–ª–∞–≥–∏–Ω –¥–ª—è iiko Front (Windows)
   - Telegram Mini App (iOS/Android)
   - Web-–ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

## –í–ª–∞–¥–µ–Ω–∏–µ –∏ –ø—Ä–∞–≤–∞:

- –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ [YourBrand]: ¬© –û–û–û "–í–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è"
- –ü–ª–∞–≥–∏–Ω –¥–ª—è iiko: ¬© –û–û–û "–í–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è"
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å iiko RMS —á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π SDK

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

- –ü–ª–∞–≥–∏–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–∞–º —Å –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø–ª–∞–≥–∏–Ω —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º
- –ü–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å backend –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã [YourBrand]
```


### **2. –ù–∞ –≤–∞—à–µ–º —Å–∞–π—Ç–µ:**

```markdown
# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å iiko

‚úÖ –ù–∞—à–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å iiko —á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π API
‚úÖ –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç—ã –º—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–≥–∏–Ω
‚úÖ –ü–ª–∞–≥–∏–Ω —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –≤–∞—à–∏ –∫–∞—Å—Å—ã –ø–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

‚ö†Ô∏è –í–∞–∂–Ω–æ: 
- –ú—ã –Ω–µ —è–≤–ª—è–µ–º—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º iiko
- –ü–ª–∞–≥–∏–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø—É–±–ª–∏—á–Ω–æ–≥–æ SDK
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥–æ–π
```


### **3. –í –∫–æ–¥–µ –ø–ª–∞–≥–∏–Ω–∞ (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏):**

```csharp
/*
 * Loyalty Plugin for iiko Front
 * 
 * Copyright ¬© 2026 [Your Company Name]
 * 
 * This plugin is part of [YourBrand] SaaS platform.
 * Provided free of charge to active subscribers.
 * 
 * Developed using iiko SDK (public API)
 * Not affiliated with iiko
 * 
 * For support: support@yourcompany.com
 */
```


***

## üí∞ **–ë–ò–ó–ù–ï–°-–ú–û–î–ï–õ–¨ –í –î–ï–¢–ê–õ–Ø–•**

### **–ß—Ç–æ –ø—Ä–æ–¥–∞–µ—Ç–µ:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ü–û–î–ü–ò–°–ö–ê –ù–ê –ü–õ–ê–¢–§–û–†–ú–£: 5,000‚ÇΩ/–º–µ—Å    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                         ‚îÇ
‚îÇ  ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏                  ‚îÇ
‚îÇ  ‚úÖ CRM –¥–ª—è –≥–æ—Å—Ç–µ–π                      ‚îÇ
‚îÇ  ‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã                  ‚îÇ
‚îÇ  ‚úÖ Telegram Mini App                   ‚îÇ
‚îÇ  ‚úÖ Web-–ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞           ‚îÇ
‚îÇ  ‚úÖ –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7                   ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  üéÅ –ë–û–ù–£–°–û–ú –í –ö–û–ú–ü–õ–ï–ö–¢–ï:                ‚îÇ
‚îÇ  ‚îî‚îÄ –ü–ª–∞–≥–∏–Ω –¥–ª—è iiko Front               ‚îÇ
‚îÇ  ‚îî‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞               ‚îÇ
‚îÇ  ‚îî‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞–≥–∏–Ω–∞                  ‚îÇ
‚îÇ                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **–ö–∞–∫ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å:**

**–ü–†–ê–í–ò–õ–¨–ù–û ‚úÖ:**

```
"–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –≤ iiko"
"SaaS-—Ä–µ—à–µ–Ω–∏–µ —Å –≥–æ—Ç–æ–≤—ã–º –ø–ª–∞–≥–∏–Ω–æ–º –¥–ª—è –≤–∞—à–µ–π –∫–∞—Å—Å—ã"
"–ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ iiko RMS"
```

**–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û ‚ùå:**

```
"–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ø–ª–∞–≥–∏–Ω –¥–ª—è iiko" ‚Üê –Ω–µ–ª—å–∑—è!
"–°–µ—Ä—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä iiko" ‚Üê –Ω–µ–ª—å–∑—è!
"–ö—É–ø–∏—Ç–µ –Ω–∞—à –ø–ª–∞–≥–∏–Ω –¥–ª—è iiko" ‚Üê –Ω–µ–ª—å–∑—è!
```


***

## üîê **–ó–ê–©–ò–¢–ê –í–ê–®–ï–ì–û –ö–û–î–ê**

### **–°–¥–µ–ª–∞–π—Ç–µ —Ç–∞–∫, —á—Ç–æ–±—ã –ø–ª–∞–≥–∏–Ω –±—ã–ª –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω –±–µ–∑ –≤–∞—à–µ–≥–æ backend:**

**1. –ü—Ä–∏–≤—è–∑–∫–∞ –∫ API Key:**

```csharp
// –í –ø–ª–∞–≥–∏–Ω–µ
public class PluginConfig
{
    public string ApiKey { get; set; }  // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ tenant
    public string TenantId { get; set; }
    
    // –ü–ª–∞–≥–∏–Ω –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –≤–∞–ª–∏–¥–Ω–æ–≥–æ API Key
    public bool IsValid()
    {
        return !string.IsNullOrEmpty(ApiKey) && 
               apiClient.ValidateKey(ApiKey); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    }
}
```

**2. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**

```csharp
// API Key –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω AES-256
// –ë–µ–∑ –≤–∞—à–µ–≥–æ backend —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
var encryptedConfig = AES.Encrypt(apiKey, serverSecret);
```

**3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏:**

```csharp
// –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ –ø–ª–∞–≥–∏–Ω–∞
public async Task<bool> CheckSubscriptionAsync()
{
    var response = await apiClient.GetAsync("/api/subscription/status");
    
    if (response.Status != "ACTIVE")
    {
        ShowError("–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.");
        return false;
    }
    
    return true;
}
```

**4. –û–±—Ñ—É—Å–∫–∞—Ü–∏—è –∫–æ–¥–∞:**

```bash
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä –¥–ª—è –∑–∞—â–∏—Ç—ã –∫–æ–¥–∞
dotnet-obfuscator LoyaltyPluginIiko.dll
```


***

## ‚ö†Ô∏è **–í–û–ó–ú–û–ñ–ù–´–ï –†–ò–°–ö–ò –ò –†–ï–®–ï–ù–ò–Ø**

### **–†–∏—Å–∫ 1: iiko –º–æ–∂–µ—Ç –≤–æ–∑—Ä–∞–∑–∏—Ç—å**

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è (~5%)

**–ü–æ—á–µ–º—É –º–æ–∂–µ—Ç –≤–æ–∑—Ä–∞–∑–∏—Ç—å:**

- –°—á–∏—Ç–∞—é—Ç, —á—Ç–æ –≤—ã –∫–æ–Ω–∫—É—Ä–∏—Ä—É–µ—Ç–µ —Å –∏—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏

**–†–µ—à–µ–Ω–∏–µ:**

```
1. –ù–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–π—Ç–µ —Å–µ–±—è –∫–∞–∫ "–ø–∞—Ä—Ç–Ω–µ—Ä iiko"
2. –£–∫–∞–∂–∏—Ç–µ: "–Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è"
3. –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:
   ‚Üí –û–±—ä—è—Å–Ω–∏—Ç–µ –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å (–ø–ª–∞–≥–∏–Ω = —á–∞—Å—Ç—å SaaS)
   ‚Üí –ü–æ–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –Ω–µ –ø—Ä–æ–¥–∞–µ—Ç–µ –ø–ª–∞–≥–∏–Ω
   ‚Üí –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ
```


### **–†–∏—Å–∫ 2: –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –ø–µ—Ä–µ–¥–∞—Ç—å –ø–ª–∞–≥–∏–Ω —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º**

**–†–µ—à–µ–Ω–∏–µ:**

```
‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ –∫ API Key (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ tenant)
‚úÖ –ü–ª–∞–≥–∏–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
‚úÖ –í –¥–æ–≥–æ–≤–æ—Ä–µ: –∑–∞–ø—Ä–µ—Ç –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º
‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
```


### **–†–∏—Å–∫ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏—è iiko –º–æ–≥—É—Ç —Å–ª–æ–º–∞—Ç—å –ø–ª–∞–≥–∏–Ω**

**–†–µ—à–µ–Ω–∏–µ:**

```
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π API (V7+)
‚úÖ –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ pre-release –≤–µ—Ä—Å–∏—è—Ö iiko
‚úÖ –í –¥–æ–≥–æ–≤–æ—Ä–µ: SLA 99.5% —Å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º —Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä–∞
‚úÖ –ë—ã—Å—Ç—Ä—ã–µ hotfix (—Ü–µ–ª—å: < 24 —á–∞—Å–∞)
```


***

## üöÄ **–ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô**

### **–ú–µ—Å—è—Ü 1: MVP**

```
‚úÖ Backend API (–±–∞–∑–æ–≤–∞—è –ª–æ—è–ª—å–Ω–æ—Å—Ç—å)
‚úÖ –ü—Ä–æ—Å—Ç–æ–π –ø–ª–∞–≥–∏–Ω (–ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è, –ø–æ–∫–∞–∑ –±–∞–ª–∞–Ω—Å–∞)
‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ iiko webhooks
‚úÖ –ü–µ—Ä–≤—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
```


### **–ú–µ—Å—è—Ü 2-3: –î–æ—Ä–∞–±–æ—Ç–∫–∞**

```
‚úÖ –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø–ª–∞–≥–∏–Ω (–≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏)
‚úÖ Telegram Mini App
‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã
‚úÖ 5-10 –ø–ª–∞—Ç—è—â–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
```


### **–ú–µ—Å—è—Ü 4-6: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**

```
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–≥–∏–Ω–∞
‚úÖ –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
‚úÖ 50+ –∫–ª–∏–µ–Ω—Ç–æ–≤
‚úÖ –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ —Å iiko
```


***

## üìû **–ù–ê –í–°–Ø–ö–ò–ô –°–õ–£–ß–ê–ô: –û–§–ò–¶–ò–ê–õ–¨–ù–û–ï –ü–ê–†–¢–ù–ï–†–°–¢–í–û**

**–ï—Å–ª–∏ –≤—ã –≤—ã—Ä–∞—Å—Ç–µ—Ç–µ –¥–æ 50+ –∫–ª–∏–µ–Ω—Ç–æ–≤, —Å—Ç–æ–∏—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å:**

### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã iiko:**

- ‚úÖ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
- ‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ iiko Store
- ‚úÖ –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç iiko
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–Ω—ã–π –º–∞—Ä–∫–µ—Ç–∏–Ω–≥
- ‚úÖ –î–æ—Å—Ç—É–ø –∫ –∑–∞–∫—Ä—ã—Ç—ã–º API


### **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞:**

- –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–µ—à–µ–Ω–∏—è
- –í–∑–Ω–æ—Å ~100,000‚ÇΩ (—Ä–∞–∑–æ–≤–æ)
- –û—Ç—á–∏—Å–ª–µ–Ω–∏—è –æ—Ç –ø—Ä–æ–¥–∞–∂ (~10%)
- –°–æ–±–ª—é–¥–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤ –∫–∞—á–µ—Å—Ç–≤–∞

**–ù–æ —ç—Ç–æ –ø–æ—Ç–æ–º!** –°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Ç–∏—Ç–µ –±–µ–∑ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞.

***

## ‚úÖ **–ò–¢–û–ì–û–í–´–ô –û–¢–í–ï–¢**

**–î–ê, –≤–∞—à–∞ –º–æ–¥–µ–ª—å –ª–µ–≥–∞–ª—å–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!**

### **–ö–ª—é—á–µ–≤—ã–µ –ø—É–Ω–∫—Ç—ã:**

1. ‚úÖ –ü—Ä–æ–¥–∞–≤–∞–π—Ç–µ **SaaS-–ø–æ–¥–ø–∏—Å–∫—É**, –∞ –Ω–µ –ø–ª–∞–≥–∏–Ω
2. ‚úÖ –ü–ª–∞–≥–∏–Ω - **–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç** –≤ –∫–æ–º–ø–ª–µ–∫—Ç–µ
3. ‚úÖ –ü–ª–∞–≥–∏–Ω **–±–µ—Å–ø–æ–ª–µ–∑–µ–Ω** –±–µ–∑ –≤–∞—à–µ–≥–æ backend
4. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **–ø—É–±–ª–∏—á–Ω—ã–π iiko SDK**
5. ‚úÖ –ù–ï –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–π—Ç–µ –∫–∞–∫ **–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä**
6. ‚úÖ –ù–ï –ø—É–±–ª–∏–∫—É–π—Ç–µ –≤ **iiko Store** (–ø–æ–∫–∞)
7. ‚úÖ –£–∫–∞–∂–∏—Ç–µ: **"–Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è"**
8. ‚úÖ –í –¥–æ–≥–æ–≤–æ—Ä–∞—Ö: –ø–ª–∞–≥–∏–Ω = **—á–∞—Å—Ç—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã**

### **–ê–Ω–∞–ª–æ–≥–∏:**

- Stripe (–¥–∞—é—Ç SDK –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –ø—Ä–æ–¥–∞—é—Ç –ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥)
- Twilio (–¥–∞—é—Ç SDK –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –ø—Ä–æ–¥–∞—é—Ç SMS/–∑–≤–æ–Ω–∫–∏)
- Amplitude (–¥–∞—é—Ç SDK –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –ø—Ä–æ–¥–∞—é—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É)

**–í—ã –¥–µ–ª–∞–µ—Ç–µ —Ç–æ –∂–µ —Å–∞–º–æ–µ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ SaaS-–∏–Ω–¥—É—Å—Ç—Ä–∏–∏!**

***

**–ù–∞—á–∏–Ω–∞–π—Ç–µ! –£ –≤–∞—Å –æ—Ç–ª–∏—á–Ω–∞—è –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å.** üöÄ

–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å:

- –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏?
- –ó–∞—â–∏—Ç–æ–π –∫–æ–¥–∞ –ø–ª–∞–≥–∏–Ω–∞?
- –°—Ç—Ä–∞—Ç–µ–≥–∏–µ–π –≤—ã—Ö–æ–¥–∞ –Ω–∞ —Ä—ã–Ω–æ–∫?

---

# ü§ñ **–ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø –£–°–¢–ê–ù–û–í–ö–ò –ü–õ–ê–ì–ò–ù–ê**

–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –≠—Ç–æ **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è**. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥–æ–≤.

***

## üéØ **–¶–ï–õ–¨: –£–°–¢–ê–ù–û–í–ö–ê "–í 1 –ö–õ–ò–ö"**

```
–ò–¥–µ–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
1. Admin –∑–∞—Ö–æ–¥–∏—Ç –≤ Dashboard
2. –ù–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–∞—Å—Å—É"
3. –°–ª–µ–¥—É–µ—Ç –ø—Ä–æ—Å—Ç–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
4. –ü–ª–∞–≥–∏–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ

–í—Ä–µ–º—è: 5 –º–∏–Ω—É—Ç
–ë–µ–∑ –≤—ã–µ–∑–¥–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
```


***

## üèÜ **–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô –ü–û–î–•–û–î: SMART INSTALLER**

### **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     Admin Dashboard (Web)                   ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  [–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–∞—Å—Å—É] ‚Üê –∫–ª–∏–∫ Admin'–∞         ‚îÇ
‚îÇ         ‚îÇ                                   ‚îÇ
‚îÇ         ‚ñº                                   ‚îÇ
‚îÇ  –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–æ—á–Ω—É—é —Å—Å—ã–ª–∫—É            ‚îÇ
‚îÇ  https://install.yourapp.com/ABC123        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚îÇ (Admin –∫–æ–ø–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞ –∫–∞—Å—Å–µ)
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ö–∞—Å—Å–æ–≤—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä (Windows)              ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  1. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ            ‚îÇ
‚îÇ  2. –°–∫–∞—á–∏–≤–∞–µ—Ç Smart Installer.exe          ‚îÇ
‚îÇ  3. –ó–∞–ø—É—Å–∫–∞–µ—Ç (—Ç—Ä–µ–±—É–µ—Ç Admin –ø—Ä–∞–≤–∞)         ‚îÇ
‚îÇ  4. Installer:                              ‚îÇ
‚îÇ     - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ iiko Front         ‚îÇ
‚îÇ     - –°–∫–∞—á–∏–≤–∞–µ—Ç –Ω—É–∂–Ω—É—é –≤–µ—Ä—Å–∏—é –ø–ª–∞–≥–∏–Ω–∞      ‚îÇ
‚îÇ     - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤ Plugins –ø–∞–ø–∫—É        ‚îÇ
‚îÇ     - –°–æ–∑–¥–∞–µ—Ç config.json —Å API –∫–ª—é—á–∞–º–∏    ‚îÇ
‚îÇ     - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç iiko Front             ‚îÇ
‚îÇ  5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ backend           ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  ‚úÖ –ì–æ—Ç–æ–≤–æ! –ü–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## üíª **–†–ï–ê–õ–ò–ó–ê–¶–ò–Ø: SMART INSTALLER**

### **1. Backend API (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–æ—á–Ω–æ–π —Å—Å—ã–ª–∫–∏)**

```typescript
// backend/src/modules/deployment/deployment.controller.ts

@Controller('api/deployment')
export class DeploymentController {
  
  @Post('generate-installer-link')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles('RESTAURANT_ADMIN', 'OWNER')
  async generateInstallerLink(
    @CurrentUser() user: User,
    @Body() dto: GenerateInstallerLinkDto
  ) {
    // 1. –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    const installToken = await this.deploymentService.createInstallToken({
      tenantId: user.tenantId,
      restaurantId: dto.restaurantId,
      createdBy: user.id,
      expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24 —á–∞—Å–∞
    });

    // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É
    const installerUrl = `https://install.yourapp.com/${installToken}`;

    // 3. –õ–æ–≥–∏—Ä—É–µ–º
    await this.activityLogService.log({
      action: 'INSTALLER_LINK_GENERATED',
      userId: user.id,
      tenantId: user.tenantId,
      metadata: { restaurantId: dto.restaurantId },
    });

    return {
      installerUrl,
      expiresAt: installToken.expiresAt,
      instructions: [
        '–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Å—Å–æ–≤–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ',
        '–°–∫–∞—á–∞–π—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫',
        '–°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ',
        '–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞—Å—Å–∞ –ø–æ—è–≤–∏—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ'
      ]
    };
  }

  @Get('installer-status/:token')
  async getInstallerStatus(@Param('token') token: string) {
    return this.deploymentService.getInstallationStatus(token);
  }
}
```


### **2. Landing page –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏**

```html
<!-- install.yourapp.com/ABC123 -->
<!DOCTYPE html>
<html>
<head>
  <title>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞</title>
  <style>
    body { 
      font-family: 'Segoe UI', sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }
    .step { 
      background: #f5f5f5;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    .btn-download {
      background: #4CAF50;
      color: white;
      padding: 15px 40px;
      font-size: 18px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: inline-block;
      text-decoration: none;
    }
    .warning {
      background: #FFF3CD;
      padding: 15px;
      border-left: 4px solid #FFC107;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>üîå –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</h1>
  
  <div class="warning">
    ‚ö†Ô∏è <strong>–í–∞–∂–Ω–æ!</strong> –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º iiko Front
  </div>

  <div class="step">
    <h3>–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h3>
    <p id="system-check">–ü—Ä–æ–≤–µ—Ä–∫–∞...</p>
  </div>

  <div class="step" id="download-step" style="display: none;">
    <h3>–®–∞–≥ 2: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞</h3>
    <p>–†–∞–∑–º–µ—Ä: ~2 –ú–ë</p>
    <a href="#" class="btn-download" id="download-btn">
      üì• –°–∫–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫
    </a>
  </div>

  <div class="step" id="install-step" style="display: none;">
    <h3>–®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞</h3>
    <ol>
      <li>–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª <code>LoyaltyInstaller.exe</code></li>
      <li>–†–∞–∑—Ä–µ—à–∏—Ç–µ –∑–∞–ø—É—Å–∫ —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</li>
      <li>–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (1-2 –º–∏–Ω—É—Ç—ã)</li>
      <li>–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front</li>
    </ol>
  </div>

  <div class="step" id="success-step" style="display: none;">
    <h3>‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h3>
    <p>–ü–ª–∞–≥–∏–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.</p>
    <p>–ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–∞–±–æ—Ç–µ.</p>
  </div>

  <script>
    const TOKEN = window.location.pathname.split('/')[1];
    const API_URL = 'https://api.yourapp.com';

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã
    async function checkSystem() {
      const checks = {
        os: navigator.platform.includes('Win'),
        browser: true,
      };

      const checkEl = document.getElementById('system-check');
      
      if (checks.os) {
        checkEl.innerHTML = '‚úÖ Windows –æ–±–Ω–∞—Ä—É–∂–µ–Ω<br>‚úÖ –ë—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
        document.getElementById('download-step').style.display = 'block';
      } else {
        checkEl.innerHTML = '‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è Windows';
      }
    }

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
    document.getElementById('download-btn').onclick = async (e) => {
      e.preventDefault();
      
      // –°–∫–∞—á–∏–≤–∞–µ–º installer
      const response = await fetch(`${API_URL}/api/deployment/installer/${TOKEN}`);
      const blob = await response.blob();
      
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'LoyaltyInstaller.exe';
      a.click();
      
      document.getElementById('install-step').style.display = 'block';
      
      // –ù–∞—á–∏–Ω–∞–µ–º polling —Å—Ç–∞—Ç—É—Å–∞
      pollInstallationStatus();
    };

    // Polling —Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    async function pollInstallationStatus() {
      const interval = setInterval(async () => {
        const response = await fetch(`${API_URL}/api/deployment/installer-status/${TOKEN}`);
        const data = await response.json();
        
        if (data.status === 'INSTALLED') {
          clearInterval(interval);
          document.getElementById('success-step').style.display = 'block';
          
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ dashboard
          if (window.opener) {
            window.opener.postMessage({ type: 'INSTALLATION_COMPLETE' }, '*');
          }
        }
      }, 5000); // –ö–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    checkSystem();
  </script>
</body>
</html>
```


***

## üõ†Ô∏è **SMART INSTALLER (C\# / .NET)**

### **Program.cs**

```csharp
using System;
using System.IO;
using System.Net.Http;
using System.Threading.Tasks;
using System.Windows.Forms;
using Newtonsoft.Json;
using System.Security.Principal;
using Microsoft.Win32;

namespace LoyaltySmartInstaller
{
    class Program
    {
        private const string API_URL = "https://api.yourapp.com";
        private static string installToken;
        private static HttpClient httpClient = new HttpClient();

        [STAThread]
        static async Task Main(string[] args)
        {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            if (!IsAdministrator())
            {
                MessageBox.Show(
                    "–¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏.\n\n–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.",
                    "–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Warning
                );
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º
            if (args.Length > 0)
            {
                installToken = args[0];
            }
            else
            {
                var form = new TokenInputForm();
                if (form.ShowDialog() == DialogResult.OK)
                {
                    installToken = form.Token;
                }
                else
                {
                    return;
                }
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            var progressForm = new ProgressForm();
            progressForm.Show();

            try
            {
                // –®–∞–≥ 1: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
                progressForm.UpdateStatus("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞...");
                var config = await ValidateTokenAsync(installToken);

                // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ iiko Front
                progressForm.UpdateStatus("–ü–æ–∏—Å–∫ iiko Front...");
                var iikoPath = FindIikoFrontPath();
                if (string.IsNullOrEmpty(iikoPath))
                {
                    throw new Exception("iiko Front –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ iiko Front –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.");
                }

                // –®–∞–≥ 3: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞
                progressForm.UpdateStatus("–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞...");
                var pluginBytes = await DownloadPluginAsync(installToken);

                // –®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞
                progressForm.UpdateStatus("–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞...");
                var pluginsPath = Path.Combine(iikoPath, "Plugins");
                if (!Directory.Exists(pluginsPath))
                {
                    Directory.CreateDirectory(pluginsPath);
                }

                var pluginPath = Path.Combine(pluginsPath, "LoyaltyPluginIiko.dll");
                File.WriteAllBytes(pluginPath, pluginBytes);

                // –®–∞–≥ 5: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
                progressForm.UpdateStatus("–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...");
                var depsBytes = await DownloadDependenciesAsync(installToken);
                var depsPath = Path.Combine(pluginsPath, "Newtonsoft.Json.dll");
                File.WriteAllBytes(depsPath, depsBytes);

                // –®–∞–≥ 6: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                progressForm.UpdateStatus("–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...");
                await CreateConfigAsync(config);

                // –®–∞–≥ 7: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Ä–µ–µ—Å—Ç—Ä–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                progressForm.UpdateStatus("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–∞...");
                RegisterPlugin(pluginPath);

                // –®–∞–≥ 8: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ backend
                progressForm.UpdateStatus("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ...");
                await NotifyInstallationCompleteAsync(installToken);

                progressForm.Close();

                MessageBox.Show(
                    "‚úÖ –ü–ª–∞–≥–∏–Ω —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!\n\n" +
                    "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–ª–∞–≥–∏–Ω–∞.",
                    "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Information
                );

                // –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å iiko
                var result = MessageBox.Show(
                    "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å iiko Front —Å–µ–π—á–∞—Å?",
                    "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Question
                );

                if (result == DialogResult.Yes)
                {
                    RestartIikoFront(iikoPath);
                }
            }
            catch (Exception ex)
            {
                progressForm.Close();
                MessageBox.Show(
                    $"–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:\n\n{ex.Message}",
                    "–û—à–∏–±–∫–∞",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Error
                );

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É –Ω–∞ backend
                await NotifyInstallationErrorAsync(installToken, ex.Message);
            }
        }

        private static bool IsAdministrator()
        {
            var identity = WindowsIdentity.GetCurrent();
            var principal = new WindowsPrincipal(identity);
            return principal.IsInRole(WindowsBuiltInRole.Administrator);
        }

        private static async Task<InstallConfig> ValidateTokenAsync(string token)
        {
            var response = await httpClient.GetAsync($"{API_URL}/api/deployment/validate-token/{token}");
            
            if (!response.IsSuccessStatusCode)
            {
                throw new Exception("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–ª–∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏—Å—Ç–µ–∫");
            }

            var json = await response.Content.ReadAsStringAsync();
            return JsonConvert.DeserializeObject<InstallConfig>(json);
        }

        private static string FindIikoFrontPath()
        {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—É—Ç–∏
            var possiblePaths = new[]
            {
                @"C:\Program Files\iiko\iikoFront",
                @"C:\Program Files (x86)\iiko\iikoFront",
                @"D:\iiko\iikoFront"
            };

            foreach (var path in possiblePaths)
            {
                if (Directory.Exists(path))
                {
                    return path;
                }
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–µ—Å—Ç—Ä
            using (var key = Registry.LocalMachine.OpenSubKey(@"SOFTWARE\iiko\iikoFront"))
            {
                if (key != null)
                {
                    var installPath = key.GetValue("InstallPath") as string;
                    if (!string.IsNullOrEmpty(installPath) && Directory.Exists(installPath))
                    {
                        return installPath;
                    }
                }
            }

            return null;
        }

        private static async Task<byte[]> DownloadPluginAsync(string token)
        {
            var response = await httpClient.GetAsync($"{API_URL}/api/deployment/download-plugin/{token}");
            return await response.Content.ReadAsByteArrayAsync();
        }

        private static async Task<byte[]> DownloadDependenciesAsync(string token)
        {
            var response = await httpClient.GetAsync($"{API_URL}/api/deployment/download-deps/{token}");
            return await response.Content.ReadAsByteArrayAsync();
        }

        private static async Task CreateConfigAsync(InstallConfig config)
        {
            var configPath = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                "LoyaltyPluginIiko"
            );

            if (!Directory.Exists(configPath))
            {
                Directory.CreateDirectory(configPath);
            }

            var configFile = Path.Combine(configPath, "config.json");
            
            var pluginConfig = new
            {
                ApiBaseUrl = config.ApiBaseUrl,
                ApiKey = config.ApiKey,
                RestaurantId = config.RestaurantId,
                TenantId = config.TenantId,
                TimeoutSeconds = 5,
                EnableQRScanner = true,
                InstalledAt = DateTime.UtcNow,
                InstalledVersion = config.PluginVersion
            };

            var json = JsonConvert.SerializeObject(pluginConfig, Formatting.Indented);
            File.WriteAllText(configFile, json);
        }

        private static void RegisterPlugin(string pluginPath)
        {
            try
            {
                using (var key = Registry.LocalMachine.CreateSubKey(@"SOFTWARE\LoyaltyPluginIiko"))
                {
                    key.SetValue("InstallPath", pluginPath);
                    key.SetValue("InstalledAt", DateTime.UtcNow.ToString("O"));
                    key.SetValue("Version", "1.0.0");
                }
            }
            catch
            {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Ä–µ–µ—Å—Ç—Ä–∞
            }
        }

        private static async Task NotifyInstallationCompleteAsync(string token)
        {
            var data = new
            {
                status = "INSTALLED",
                installedAt = DateTime.UtcNow,
                computerName = Environment.MachineName,
                userName = Environment.UserName
            };

            var json = JsonConvert.SerializeObject(data);
            var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");
            
            await httpClient.PostAsync($"{API_URL}/api/deployment/installation-complete/{token}", content);
        }

        private static async Task NotifyInstallationErrorAsync(string token, string error)
        {
            try
            {
                var data = new { error };
                var json = JsonConvert.SerializeObject(data);
                var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");
                
                await httpClient.PostAsync($"{API_URL}/api/deployment/installation-error/{token}", content);
            }
            catch
            {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            }
        }

        private static void RestartIikoFront(string iikoPath)
        {
            try
            {
                // –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å iiko Front
                var processes = System.Diagnostics.Process.GetProcessesByName("iikoFront");
                foreach (var process in processes)
                {
                    process.Kill();
                    process.WaitForExit(5000);
                }

                // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–Ω–æ–≤–æ
                System.Threading.Thread.Sleep(2000);
                var exePath = Path.Combine(iikoPath, "iikoFront.exe");
                if (File.Exists(exePath))
                {
                    System.Diagnostics.Process.Start(exePath);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(
                    $"–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å iiko Front:\n{ex.Message}\n\n–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.",
                    "–í–Ω–∏–º–∞–Ω–∏–µ",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Warning
                );
            }
        }
    }

    public class InstallConfig
    {
        public string ApiBaseUrl { get; set; }
        public string ApiKey { get; set; }
        public string RestaurantId { get; set; }
        public string TenantId { get; set; }
        public string PluginVersion { get; set; }
    }
}
```


***

## üé® **UI –î–õ–Ø ADMIN DASHBOARD**

### **React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç**

```tsx
// components/CashRegisterSetup.tsx

import { useState } from 'react';
import { Button, Card, Steps, message, Modal, QRCode } from 'antd';
import { DownloadOutlined, CheckCircleOutlined } from '@ant-design/icons';

export function CashRegisterSetup({ restaurantId }: { restaurantId: string }) {
  const [installerUrl, setInstallerUrl] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  const [installationStatus, setInstallationStatus] = useState<'pending' | 'installing' | 'installed'>('pending');

  const generateInstallerLink = async () => {
    setLoading(true);
    try {
      const response = await fetch('/api/deployment/generate-installer-link', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ restaurantId }),
      });
      
      const data = await response.json();
      setInstallerUrl(data.installerUrl);
      
      // –ù–∞—á–∏–Ω–∞–µ–º polling —Å—Ç–∞—Ç—É—Å–∞
      pollInstallationStatus(data.installerUrl.split('/').pop());
      
      message.success('–°—Å—ã–ª–∫–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–∑–¥–∞–Ω–∞!');
    } catch (error) {
      message.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏');
    } finally {
      setLoading(false);
    }
  };

  const pollInstallationStatus = (token: string) => {
    const interval = setInterval(async () => {
      const response = await fetch(`/api/deployment/installer-status/${token}`);
      const data = await response.json();
      
      if (data.status === 'INSTALLED') {
        clearInterval(interval);
        setInstallationStatus('installed');
        message.success('‚úÖ –ö–∞—Å—Å–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞!');
      } else if (data.status === 'INSTALLING') {
        setInstallationStatus('installing');
      }
    }, 5000);
  };

  const copyToClipboard = () => {
    navigator.clipboard.writeText(installerUrl!);
    message.success('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
  };

  return (
    <Card title="üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞—Å—Å—ã">
      <Steps
        current={installationStatus === 'pending' ? 0 : installationStatus === 'installing' ? 1 : 2}
        items={[
          { title: '–°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏' },
          { title: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞' },
          { title: '–ì–æ—Ç–æ–≤–æ' },
        ]}
      />

      <div style={{ marginTop: 32 }}>
        {!installerUrl ? (
          <Button
            type="primary"
            size="large"
            onClick={generateInstallerLink}
            loading={loading}
            icon={<DownloadOutlined />}
          >
            –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
          </Button>
        ) : installationStatus === 'installed' ? (
          <div style={{ textAlign: 'center' }}>
            <CheckCircleOutlined style={{ fontSize: 64, color: '#52c41a' }} />
            <h2>–ö–∞—Å—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞!</h2>
            <p>–ü–ª–∞–≥–∏–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</p>
          </div>
        ) : (
          <Card>
            <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ:</h3>
            
            <ol>
              <li>
                <strong>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É:</strong>
                <div style={{ display: 'flex', gap: 8, marginTop: 8 }}>
                  <input
                    value={installerUrl}
                    readOnly
                    style={{ flex: 1, padding: 8, border: '1px solid #d9d9d9', borderRadius: 4 }}
                  />
                  <Button onClick={copyToClipboard}>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</Button>
                </div>
              </li>

              <li style={{ marginTop: 16 }}>
                <strong>–ò–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥:</strong>
                <div style={{ marginTop: 8 }}>
                  <QRCode value={installerUrl} size={200} />
                </div>
              </li>

              <li style={{ marginTop: 16 }}>
                <strong>–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Å—Å–æ–≤–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ</strong>
              </li>

              <li style={{ marginTop: 8 }}>
                <strong>–°–∫–∞—á–∞–π—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫</strong>
              </li>

              <li style={{ marginTop: 8 }}>
                <strong>–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏</strong>
              </li>
            </ol>

            {installationStatus === 'installing' && (
              <div style={{ marginTop: 24, padding: 16, background: '#e6f7ff', borderRadius: 8 }}>
                ‚è≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è... –û–∂–∏–¥–∞–π—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
              </div>
            )}
          </Card>
        )}
      </div>
    </Card>
  );
}
```


***

## üöÄ **–ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –ü–û–î–•–û–î: AUTO-UPDATE AGENT**

**–ï—â–µ –ø—Ä–æ—â–µ - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ –ª–µ–≥–∫–∏–π –∞–≥–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–∞–º –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:**

### **–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**

```
1. –ü–µ—Ä–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞: Admin –≤—Ä—É—á–Ω—É—é —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç LoyaltyAgent.exe (1 —Ä–∞–∑)
2. Agent:
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π (500 KB)
   - –†–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ
   - –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–ª–∞–≥–∏–Ω
   - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç iiko Front –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
3. –î–∞–ª—å—à–µ –≤—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
```


### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ –û–¥–∏–Ω —Ä–∞–∑ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ - –∑–∞–±—ã–ª–∏
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Å—Å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –£–¥–∞–ª–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

***

## üìä **–°–†–ê–í–ù–ï–ù–ò–ï –ü–û–î–•–û–î–û–í**

| –ü–æ–¥—Ö–æ–¥ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –£–¥–æ–±—Å—Ç–≤–æ | –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
| :-- | :-- | :-- | :-- | :-- |
| **Smart Installer** | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚úÖ –õ—É—á—à–∏–π –¥–ª—è MVP |
| **Auto-Update Agent** | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚úÖ –î–ª—è –º–∞—Å—à—Ç–∞–±–∞ |
| **Remote Desktop** | ‚≠ê‚≠ê | ‚≠ê‚≠ê | ‚≠ê‚≠ê | ‚ùå –ù–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è |
| **–†—É—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞** | ‚≠ê | ‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚ùå –ù–µ—É–¥–æ–±–Ω–æ |


***

## ‚úÖ **–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô –ü–õ–ê–ù**

### **–≠—Ç–∞–ø 1: MVP (–º–µ—Å—è—Ü 1-2)**

```
‚úÖ Smart Installer (–æ–ø–∏—Å–∞–Ω –≤—ã—à–µ)
‚úÖ Web-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
‚úÖ –†—É—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è –ø–µ—Ä–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (–ø–æ–º–æ—â—å —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏)
```


### **–≠—Ç–∞–ø 2: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è (–º–µ—Å—è—Ü 3-4)**

```
‚úÖ Auto-Update Agent
‚úÖ Dashboard —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –∫–∞—Å—Å
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```


### **–≠—Ç–∞–ø 3: Enterprise (–º–µ—Å—è—Ü 6+)**

```
‚úÖ MSI installer –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ç–µ–π
‚úÖ GPO deployment –¥–ª—è –¥–æ–º–µ–Ω–æ–≤
‚úÖ API –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
```


***

**–ù–∞—á–Ω–∏—Ç–µ —Å Smart Installer - —ç—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å!**

–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π Auto-Update Agent –∏–ª–∏ –¥—Ä—É–≥–∏–º–∏ —á–∞—Å—Ç—è–º–∏?

---

# üéØ **–ü–ï–†–°–û–ù–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ô SMART INSTALLER**

–û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è! –°–¥–µ–ª–∞–µ–º **"–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π" installer**, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –í–°–Å –≤–Ω—É—Ç—Ä–∏.

***

## üí° **–ö–û–ù–¶–ï–ü–¶–ò–Ø: ONE-CLICK INSTALL**

```
–ò–¥–µ–∞–ª—å–Ω—ã–π —Ñ–ª–æ—É:
1. Admin –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–∞—Å—Å—É" –≤ Dashboard
2. Backend –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ô installer.exe
   ‚îî‚îÄ –í–Ω—É—Ç—Ä–∏ —É–∂–µ –≤—à–∏—Ç—ã: API –∫–ª—é—á–∏, tenant ID, restaurant ID
3. Admin —Å–∫–∞—á–∏–≤–∞–µ—Ç installer.exe
4. –ó–∞–ø—É—Å–∫–∞–µ—Ç –Ω–∞ –∫–∞—Å—Å–µ ‚Üí –ì–û–¢–û–í–û! ‚úÖ

–í—Ä–µ–º—è: 1 –º–∏–Ω—É—Ç–∞
–ù–∏–∫–∞–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
```


***

## üèóÔ∏è **–ê–†–•–ò–¢–ï–ö–¢–£–†–ê**

### **–í–∞—Ä–∏–∞–Ω—Ç 1: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è EXE (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     Admin Dashboard (Web)                   ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  [–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–∞—Å—Å—É] ‚Üê –∫–ª–∏–∫                 ‚îÇ
‚îÇ         ‚îÇ                                   ‚îÇ
‚îÇ         ‚ñº                                   ‚îÇ
‚îÇ  POST /api/deployment/generate-installer   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     Backend (NestJS)                        ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  1. –°–æ–∑–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π API Key             ‚îÇ
‚îÇ  2. –ë–µ—Ä–µ—Ç –±–∞–∑–æ–≤—ã–π installer_template.exe   ‚îÇ
‚îÇ  3. –í—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç config.json –≤ —Ä–µ—Å—É—Ä—Å—ã EXE   ‚îÇ
‚îÇ  4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π installer.exe    ‚îÇ
‚îÇ  5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Cloudflare R2/S3           ‚îÇ
‚îÇ  6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Admin —Å–∫–∞—á–∏–≤–∞–µ—Ç: LoyaltyInstaller_ABC.exe ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  –í–Ω—É—Ç—Ä–∏ —É–∂–µ –µ—Å—Ç—å:                          ‚îÇ
‚îÇ  ‚îú‚îÄ LoyaltyPluginIiko.dll                  ‚îÇ
‚îÇ  ‚îú‚îÄ Newtonsoft.Json.dll                    ‚îÇ
‚îÇ  ‚îú‚îÄ config.json (—Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏)    ‚îÇ
‚îÇ  ‚îî‚îÄ Install logic                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## üíª **–†–ï–ê–õ–ò–ó–ê–¶–ò–Ø**

### **1. Backend: –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö installer'–æ–≤**

```typescript
// backend/src/modules/deployment/deployment.service.ts

import { Injectable } from '@nestjs/common';
import { exec } from 'child_process';
import { promises as fs } from 'fs';
import * as path from 'path';
import { v4 as uuidv4 } from 'uuid';
import { S3Service } from '../storage/s3.service';

@Injectable()
export class DeploymentService {
  private readonly TEMPLATE_PATH = path.join(__dirname, '../../../assets/installer_template.exe');
  private readonly PLUGIN_PATH = path.join(__dirname, '../../../assets/LoyaltyPluginIiko.dll');
  private readonly TEMP_DIR = path.join(__dirname, '../../../temp');

  constructor(
    private readonly s3Service: S3Service,
  ) {}

  async generatePersonalizedInstaller(
    tenantId: string,
    restaurantId: string,
    userId: string,
  ) {
    // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π API Key –¥–ª—è —ç—Ç–æ–π –∫–∞—Å—Å—ã
    const apiKey = this.generateApiKey();
    const installerId = uuidv4();

    // 2. –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    const config = {
      ApiBaseUrl: process.env.API_BASE_URL || 'https://api.yourapp.com',
      ApiKey: apiKey,
      RestaurantId: restaurantId,
      TenantId: tenantId,
      TimeoutSeconds: 5,
      EnableQRScanner: true,
      InstallerId: installerId,
      GeneratedAt: new Date().toISOString(),
    };

    // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º API Key –≤ –±–∞–∑—É
    await this.prisma.cashRegisterApiKey.create({
      data: {
        key: apiKey,
        tenantId,
        restaurantId,
        installerId,
        status: 'PENDING',
        createdBy: userId,
      },
    });

    // 4. –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–±–æ—Ä–∫–∏
    const tempDir = path.join(this.TEMP_DIR, installerId);
    await fs.mkdir(tempDir, { recursive: true });

    try {
      // 5. –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ temp
      const configPath = path.join(tempDir, 'config.json');
      const pluginPath = path.join(tempDir, 'LoyaltyPluginIiko.dll');
      const depsPath = path.join(tempDir, 'Newtonsoft.Json.dll');

      await fs.writeFile(configPath, JSON.stringify(config, null, 2));
      await fs.copyFile(this.PLUGIN_PATH, pluginPath);
      await fs.copyFile(
        path.join(__dirname, '../../../assets/Newtonsoft.Json.dll'),
        depsPath,
      );

      // 6. –°–æ–∑–¥–∞–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏
      const manifest = {
        version: '1.0.0',
        files: [
          { name: 'LoyaltyPluginIiko.dll', size: (await fs.stat(pluginPath)).size },
          { name: 'Newtonsoft.Json.dll', size: (await fs.stat(depsPath)).size },
          { name: 'config.json', size: (await fs.stat(configPath)).size },
        ],
        tenant: {
          id: tenantId,
          restaurantId: restaurantId,
        },
      };

      await fs.writeFile(
        path.join(tempDir, 'manifest.json'),
        JSON.stringify(manifest, null, 2),
      );

      // 7. –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –≤ self-extracting EXE (–∏—Å–ø–æ–ª—å–∑—É–µ–º 7-Zip SFX –∏–ª–∏ IExpress)
      const installerPath = await this.buildSelfExtractingExe(tempDir, installerId);

      // 8. –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ S3/R2
      const fileBuffer = await fs.readFile(installerPath);
      const s3Key = `installers/${tenantId}/${installerId}/LoyaltyInstaller.exe`;
      
      const uploadedUrl = await this.s3Service.upload(s3Key, fileBuffer, {
        contentType: 'application/x-msdownload',
        metadata: {
          tenantId,
          restaurantId,
          installerId,
        },
      });

      // 9. –û—á–∏—â–∞–µ–º temp
      await fs.rm(tempDir, { recursive: true, force: true });

      // 10. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± installer
      await this.prisma.installer.create({
        data: {
          id: installerId,
          tenantId,
          restaurantId,
          downloadUrl: uploadedUrl,
          apiKey,
          status: 'GENERATED',
          expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 –¥–Ω–µ–π
          createdBy: userId,
        },
      });

      return {
        installerId,
        downloadUrl: uploadedUrl,
        expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
        size: fileBuffer.length,
      };
    } catch (error) {
      // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      await fs.rm(tempDir, { recursive: true, force: true }).catch(() => {});
      throw error;
    }
  }

  /**
   * –°–æ–∑–¥–∞–Ω–∏–µ self-extracting EXE —Å –ø–æ–º–æ—â—å—é 7-Zip SFX
   */
  private async buildSelfExtractingExe(
    sourceDir: string,
    installerId: string,
  ): Promise<string> {
    const outputPath = path.join(this.TEMP_DIR, `${installerId}.exe`);
    const archivePath = path.join(this.TEMP_DIR, `${installerId}.7z`);

    // 1. –°–æ–∑–¥–∞–µ–º 7z –∞—Ä—Ö–∏–≤
    await this.execCommand(
      `7z a -t7z "${archivePath}" "${sourceDir}/*" -mx=9`,
    );

    // 2. –ë–µ—Ä–µ–º SFX –º–æ–¥—É–ª—å
    const sfxModule = path.join(__dirname, '../../../assets/7zSD.sfx');

    // 3. –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è SFX
    const sfxConfig = `
;!@Install@!UTF-8!
Title="–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏"
BeginPrompt="–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è iiko Front.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?"
RunProgram="install.bat"
;!@InstallEnd@!
    `.trim();

    const configPath = path.join(this.TEMP_DIR, `${installerId}_config.txt`);
    await fs.writeFile(configPath, sfxConfig);

    // 4. –°–æ–∑–¥–∞–µ–º install.bat
    const batchScript = `
@echo off
echo Installing Loyalty Plugin...

REM –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ iiko Front
set "IIKO_PATH=C:\\Program Files\\iiko\\iikoFront"
if not exist "%IIKO_PATH%" set "IIKO_PATH=C:\\Program Files (x86)\\iiko\\iikoFront"

if not exist "%IIKO_PATH%" (
    echo Error: iiko Front not found
    pause
    exit /b 1
)

REM –ö–æ–ø–∏—Ä—É–µ–º –ø–ª–∞–≥–∏–Ω
echo Copying plugin files...
xcopy /Y "LoyaltyPluginIiko.dll" "%IIKO_PATH%\\Plugins\\"
xcopy /Y "Newtonsoft.Json.dll" "%IIKO_PATH%\\Plugins\\"

REM –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
set "CONFIG_PATH=%APPDATA%\\LoyaltyPluginIiko"
if not exist "%CONFIG_PATH%" mkdir "%CONFIG_PATH%"
xcopy /Y "config.json" "%CONFIG_PATH%\\"

REM –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ backend
powershell -Command "Invoke-WebRequest -Uri 'https://api.yourapp.com/api/deployment/installation-complete' -Method POST -Body (Get-Content config.json) -ContentType 'application/json'" >nul 2>&1

echo.
echo Installation completed successfully!
echo Please restart iiko Front.
echo.
pause
    `.trim();

    const batchPath = path.join(sourceDir, 'install.bat');
    await fs.writeFile(batchPath, batchScript);

    // 5. –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π EXE: SFX + config + archive
    await this.execCommand(
      `copy /b "${sfxModule}" + "${configPath}" + "${archivePath}" "${outputPath}"`,
    );

    // 6. –û—á–∏—Å—Ç–∫–∞
    await fs.unlink(archivePath).catch(() => {});
    await fs.unlink(configPath).catch(() => {});

    return outputPath;
  }

  private execCommand(command: string): Promise<string> {
    return new Promise((resolve, reject) => {
      exec(command, (error, stdout, stderr) => {
        if (error) reject(error);
        else resolve(stdout);
      });
    });
  }

  private generateApiKey(): string {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let key = 'lk_'; // loyalty key prefix
    for (let i = 0; i < 32; i++) {
      key += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return key;
  }
}
```


***

### **2. API Endpoint –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ installer**

```typescript
// backend/src/modules/deployment/deployment.controller.ts

@Controller('api/deployment')
export class DeploymentController {
  
  @Post('generate-installer')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles('RESTAURANT_ADMIN', 'OWNER')
  async generateInstaller(
    @CurrentUser() user: User,
    @Body() dto: GenerateInstallerDto,
  ) {
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π installer
    const installer = await this.deploymentService.generatePersonalizedInstaller(
      user.tenantId,
      dto.restaurantId,
      user.id,
    );

    // –õ–æ–≥–∏—Ä—É–µ–º
    await this.activityLogService.log({
      action: 'INSTALLER_GENERATED',
      userId: user.id,
      tenantId: user.tenantId,
      metadata: { 
        installerId: installer.installerId,
        restaurantId: dto.restaurantId 
      },
    });

    return {
      installerId: installer.installerId,
      downloadUrl: installer.downloadUrl,
      expiresAt: installer.expiresAt,
      size: installer.size,
      sizeFormatted: this.formatBytes(installer.size),
      instructions: [
        '1. –°–∫–∞—á–∞–π—Ç–µ installer –Ω–∞ –∫–∞—Å—Å–æ–≤—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä',
        '2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞',
        '3. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏',
        '4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front',
        '5. –ü–ª–∞–≥–∏–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!'
      ]
    };
  }

  @Get('download-installer/:installerId')
  async downloadInstaller(
    @Param('installerId') installerId: string,
    @Res() res: Response,
  ) {
    const installer = await this.prisma.installer.findUnique({
      where: { id: installerId },
    });

    if (!installer) {
      throw new NotFoundException('Installer not found');
    }

    if (new Date() > installer.expiresAt) {
      throw new BadRequestException('Installer expired');
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    await this.prisma.installer.update({
      where: { id: installerId },
      data: { 
        downloadCount: { increment: 1 },
        lastDownloadedAt: new Date(),
      },
    });

    // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ S3 URL –∏–ª–∏ stream —Ñ–∞–π–ª–∞
    res.redirect(installer.downloadUrl);
  }

  @Post('installation-complete')
  async installationComplete(@Body() body: any) {
    const { ApiKey, InstallerId } = body;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    await this.prisma.cashRegisterApiKey.update({
      where: { key: ApiKey },
      data: { 
        status: 'ACTIVE',
        activatedAt: new Date(),
      },
    });

    await this.prisma.installer.update({
      where: { id: InstallerId },
      data: { 
        status: 'INSTALLED',
        installedAt: new Date(),
      },
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ admin'—É
    await this.notificationService.send({
      userId: installer.createdBy,
      type: 'CASH_REGISTER_CONNECTED',
      title: '–ö–∞—Å—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞',
      message: '–ù–æ–≤–∞—è –∫–∞—Å—Å–∞ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∞ –ø–ª–∞–≥–∏–Ω',
    });

    return { success: true };
  }

  private formatBytes(bytes: number): string {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }
}
```


***

### **3. Frontend: UI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏**

```tsx
// components/CashRegisterSetup.tsx

import { useState } from 'react';
import { Button, Card, Steps, message, Progress, Alert } from 'antd';
import { DownloadOutlined, CheckCircleOutlined, LoadingOutlined } from '@ant-design/icons';

export function CashRegisterSetup({ restaurantId }: { restaurantId: string }) {
  const [loading, setLoading] = useState(false);
  const [installer, setInstaller] = useState<any>(null);
  const [currentStep, setCurrentStep] = useState(0);

  const generateInstaller = async () => {
    setLoading(true);
    try {
      const response = await fetch('/api/deployment/generate-installer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ restaurantId }),
      });
      
      const data = await response.json();
      setInstaller(data);
      setCurrentStep(1);
      
      message.success('Installer –≥–æ—Ç–æ–≤ –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é!');
      
      // –ù–∞—á–∏–Ω–∞–µ–º polling —Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
      pollInstallationStatus(data.installerId);
    } catch (error) {
      message.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ installer');
    } finally {
      setLoading(false);
    }
  };

  const downloadInstaller = () => {
    window.location.href = `/api/deployment/download-installer/${installer.installerId}`;
    setCurrentStep(2);
  };

  const pollInstallationStatus = (installerId: string) => {
    const interval = setInterval(async () => {
      const response = await fetch(`/api/deployment/installer-status/${installerId}`);
      const data = await response.json();
      
      if (data.status === 'INSTALLED') {
        clearInterval(interval);
        setCurrentStep(3);
        message.success('‚úÖ –ö–∞—Å—Å–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞!');
      }
    }, 5000);
  };

  return (
    <Card title="üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞—Å—Å—ã">
      <Steps
        current={currentStep}
        items={[
          { title: '–ù–∞—á–∞–ª–æ', icon: currentStep === 0 && loading ? <LoadingOutlined /> : null },
          { title: '–°–∫–∞—á–∏–≤–∞–Ω–∏–µ' },
          { title: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞' },
          { title: '–ì–æ—Ç–æ–≤–æ' },
        ]}
      />

      <div style={{ marginTop: 32 }}>
        {currentStep === 0 && (
          <div style={{ textAlign: 'center' }}>
            <Alert
              message="–ü—Ä–æ—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞"
              description="–ú—ã —Å–æ–∑–¥–∞–¥–∏–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π installer —Å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏. –ü—Ä–æ—Å—Ç–æ —Å–∫–∞—á–∞–π—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞ –∫–∞—Å—Å–æ–≤–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ."
              type="info"
              showIcon
              style={{ marginBottom: 24, textAlign: 'left' }}
            />
            
            <Button
              type="primary"
              size="large"
              onClick={generateInstaller}
              loading={loading}
              style={{ height: 50, fontSize: 16, padding: '0 40px' }}
            >
              {loading ? '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è installer...' : '–°–æ–∑–¥–∞—Ç—å installer –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏'}
            </Button>
          </div>
        )}

        {currentStep === 1 && installer && (
          <Card>
            <div style={{ textAlign: 'center', marginBottom: 24 }}>
              <CheckCircleOutlined style={{ fontSize: 48, color: '#52c41a' }} />
              <h2 style={{ marginTop: 16 }}>Installer –≥–æ—Ç–æ–≤!</h2>
              <p style={{ color: '#666' }}>
                –†–∞–∑–º–µ—Ä: {installer.sizeFormatted} | 
                –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ: {new Date(installer.expiresAt).toLocaleDateString()}
              </p>
            </div>

            <Button
              type="primary"
              size="large"
              icon={<DownloadOutlined />}
              onClick={downloadInstaller}
              block
            >
              –°–∫–∞—á–∞—Ç—å LoyaltyInstaller.exe
            </Button>

            <div style={{ marginTop: 32 }}>
              <h3>–ß—Ç–æ –¥–∞–ª—å—à–µ:</h3>
              <ol style={{ paddingLeft: 20 }}>
                {installer.instructions.map((step: string, idx: number) => (
                  <li key={idx} style={{ marginBottom: 8 }}>{step}</li>
                ))}
              </ol>
            </div>
          </Card>
        )}

        {currentStep === 2 && (
          <Card>
            <div style={{ textAlign: 'center' }}>
              <Progress type="circle" percent={66} status="active" />
              <h2 style={{ marginTop: 24 }}>–û–∂–∏–¥–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏...</h2>
              <p style={{ color: '#666' }}>
                –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–∞ –∫–∞—Å—Å–æ–≤–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.<br/>
                –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
              </p>
            </div>
          </Card>
        )}

        {currentStep === 3 && (
          <Card>
            <div style={{ textAlign: 'center' }}>
              <CheckCircleOutlined style={{ fontSize: 64, color: '#52c41a' }} />
              <h2>üéâ –ö–∞—Å—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞!</h2>
              <p>–ü–ª–∞–≥–∏–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</p>
              
              <Button 
                type="primary" 
                onClick={() => window.location.reload()}
                style={{ marginTop: 16 }}
              >
                –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –∫–∞—Å—Å
              </Button>
            </div>
          </Card>
        )}
      </div>
    </Card>
  );
}
```


***

## üéÅ **BONUS: –ï—â–µ –ø—Ä–æ—â–µ - PowerShell –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π**

### **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: installer —á–µ—Ä–µ–∑ PowerShell –∫–æ–º–∞–Ω–¥—É**

```typescript
// Backend –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ PowerShell

@Post('generate-installer-command')
async generateInstallerCommand(@Body() dto: any) {
  const apiKey = this.generateApiKey();
  const installerId = uuidv4();
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
  await this.saveApiKey(apiKey, dto.tenantId, dto.restaurantId);
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PowerShell –∫–æ–º–∞–Ω–¥—É
  const command = `
iex (New-Object Net.WebClient).DownloadString('https://install.yourapp.com/ps1/${installerId}')
  `.trim();
  
  return {
    command,
    instructions: '–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤ PowerShell –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –Ω–∞ –∫–∞—Å—Å–µ'
  };
}
```


### **UI:**

```tsx
<Card title="–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ PowerShell">
  <Alert
    message="–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±"
    description="–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–¥–Ω—É –∫–æ–º–∞–Ω–¥—É - –≤—Å—ë —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
    type="success"
    showIcon
  />
  
  <div style={{ marginTop: 16 }}>
    <code style={{ 
      display: 'block', 
      padding: 16, 
      background: '#f5f5f5',
      borderRadius: 4,
      fontFamily: 'monospace'
    }}>
      {command}
    </code>
    
    <Button 
      onClick={() => {
        navigator.clipboard.writeText(command);
        message.success('–ö–æ–º–∞–Ω–¥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
      }}
      style={{ marginTop: 8 }}
    >
      –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É
    </Button>
  </div>
</Card>
```


***

## üìä **–°–†–ê–í–ù–ï–ù–ò–ï –ü–û–î–•–û–î–û–í**

| –ü–æ–¥—Ö–æ–¥ | –ü—Ä–æ—Å—Ç–æ—Ç–∞ –¥–ª—è Admin | –ü—Ä–æ—Å—Ç–æ—Ç–∞ –¥–ª—è –∫–∞—Å—Å–∏—Ä–∞ | –†–∞–∑–º–µ—Ä | –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å |
| :-- | :-- | :-- | :-- | :-- |
| **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π EXE** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ~2 MB | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| **PowerShell –∫–æ–º–∞–Ω–¥–∞** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | 0 KB | ‚≠ê‚≠ê‚≠ê‚≠ê |
| **Smart Installer + —Ç–æ–∫–µ–Ω** | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | ~500 KB | ‚≠ê‚≠ê‚≠ê‚≠ê |


***

## ‚úÖ **–ò–¢–û–ì–û–í–ê–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø**

### **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π EXE:**

**–ü–æ—á–µ–º—É:**

- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ –¥–ª—è –∫–∞—Å—Å–∏—Ä–æ–≤ (–¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫)
- ‚úÖ –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∂–µ –≤–Ω—É—Ç—Ä–∏
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ—Ñ–ª–∞–π–Ω (–Ω–µ –Ω—É–∂–µ–Ω –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
- ‚úÖ –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å —Ñ–ª–µ—à–∫–∏
- ‚úÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤–∏–¥

**–§–ª–æ—É:**

```
1. Admin: "–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–∞—Å—Å—É" ‚Üí –°–∫–∞—á–∞—Ç—å (2 —Å–µ–∫—É–Ω–¥—ã)
2. –ö–∞—Å—Å–∏—Ä: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–∞–π–ª ‚Üí –ì–æ—Ç–æ–≤–æ (1 –º–∏–Ω—É—Ç–∞)
```

**–≠—Ç–æ —Å–∞–º–æ–µ –ø—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ –≤–æ–∑–º–æ–∂–Ω—ã—Ö!** üöÄ

–ü–æ–º–æ—á—å —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ EXE –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç–µ–π?

---

# ‚úÖ **–î–ê, –ò–ú–ï–ù–ù–û –¢–ê–ö!**

–ü–ª–∞–≥–∏–Ω —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è **–í–ù–£–¢–†–¨ iiko Front** –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è **–µ–≥–æ —á–∞—Å—Ç—å—é**. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏.

***

## üéØ **–ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢**

### **1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ iiko Front**

```
C:\Program Files\iiko\iikoFront\
‚îú‚îÄ‚îÄ iikoFront.exe                  ‚Üê –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ Resto.Front.Api.dll            ‚Üê API –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤
‚îú‚îÄ‚îÄ Plugins\                       ‚Üê –°–Æ–î–ê —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–ª–∞–≥–∏–Ω—ã
‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyPluginIiko.dll     ‚Üê –í–∞—à –ø–ª–∞–≥–∏–Ω
‚îÇ   ‚îú‚îÄ‚îÄ Newtonsoft.Json.dll       ‚Üê –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îî‚îÄ‚îÄ [–¥—Ä—É–≥–∏–µ –ø–ª–∞–≥–∏–Ω—ã]
‚îî‚îÄ‚îÄ [–¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã iiko]
```


### **2. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ iiko Front:**

```
1. iiko Front –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
2. –°–∫–∞–Ω–∏—Ä—É–µ—Ç –ø–∞–ø–∫—É Plugins\
3. –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ .dll —Ñ–∞–π–ª—ã
4. –ò—â–µ—Ç –∫–ª–∞—Å—Å—ã, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–µ IFrontPlugin
5. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Ö –≤ –ø–∞–º—è—Ç—å
6. –í—ã–∑—ã–≤–∞–µ—Ç InitializePlugin()
7. –ü–ª–∞–≥–∏–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ß–ê–°–¢–¨–Æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚úÖ
```


***

## üñ•Ô∏è **–í–ò–î –° –¢–û–ß–ö–ò –ó–†–ï–ù–ò–Ø –ö–ê–°–°–ò–†–ê**

### **–î–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–≥–∏–Ω–∞:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         iiko Front (–∫–∞—Å—Å–∞)               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                          ‚îÇ
‚îÇ  [–ú–µ–Ω—é] [–°—Ç–æ–ª—ã] [–î–æ—Å—Ç–∞–≤–∫–∞] [–†–µ–∑–µ—Ä–≤—ã]    ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ  –ó–∞–∫–∞–∑ #1234                   ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ                                ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  –ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞    500‚ÇΩ      ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  –ö–æ–ª–∞               150‚ÇΩ      ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  –ò–¢–û–ì–û:            650‚ÇΩ       ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ                                ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  [–û–ø–ª–∞—Ç–∞]                     ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–≥–∏–Ω–∞:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         iiko Front (–∫–∞—Å—Å–∞)               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                          ‚îÇ
‚îÇ  [–ú–µ–Ω—é] [–°—Ç–æ–ª—ã] [–î–æ—Å—Ç–∞–≤–∫–∞] [–†–µ–∑–µ—Ä–≤—ã]    ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ  –ó–∞–∫–∞–∑ #1234                   ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ                                ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  –ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞    500‚ÇΩ      ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  –ö–æ–ª–∞               150‚ÇΩ      ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  –ò–¢–û–ì–û:            650‚ÇΩ       ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ                                ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  [–û–ø–ª–∞—Ç–∞]                     ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  [üí≥ –ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏] ‚Üê –ù–û–í–ê–Ø‚îÇ     ‚îÇ ‚Üê –ü–ª–∞–≥–∏–Ω –¥–æ–±–∞–≤–∏–ª —ç—Ç—É –∫–Ω–æ–ø–∫—É!
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **–ö–æ–≥–¥–∞ –∫–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         iiko Front (–∫–∞—Å—Å–∞)               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  –ó–∞–∫–∞–∑ #1234        ‚îÇ            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –ü–∏—Ü—Ü–∞: 500‚ÇΩ       ‚îÇ            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –ö–æ–ª–∞: 150‚ÇΩ        ‚îÇ            ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ     ‚îÇ üîå –ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏        ‚îÇ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ –û–∫–Ω–æ –ø–ª–∞–≥–∏–Ω–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
‚îÇ     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§     ‚îÇ   –ü–û–í–ï–†–• iiko Front
‚îÇ     ‚îÇ                             ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è:                ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ [+7 999 123 45 67] [–ù–∞–π—Ç–∏] ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ                             ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ ‚îÇ üë§ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤          ‚îÇ ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ ‚îÇ ‚≠ê Gold                 ‚îÇ ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ ‚îÇ üí∞ 2,450 –±–∞–ª–ª–æ–≤        ‚îÇ ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ ‚îÇ                         ‚îÇ ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ ‚îÇ –°–ø–∏—Å–∞—Ç—å: [400] [–ú–∞–∫—Å]  ‚îÇ ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ                             ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ [–ü—Ä–∏–º–µ–Ω–∏—Ç—å] [–û—Ç–º–µ–Ω–∞]       ‚îÇ     ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## üîß **–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò**

### **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å iiko Front API:**

```csharp
// –í–∞—à –ø–ª–∞–≥–∏–Ω –í–ù–£–¢–†–ò iiko Front
public class LoyaltyPlugin : IFrontPlugin
{
    public void InitializePlugin()
    {
        // 1. –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã
        PluginContext.Operations.AddButtonToPaymentScreen(
            "üí≥ –ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏",  ‚Üê –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
            OnLoyaltyButtonClick     ‚Üê –û–±—Ä–∞–±–æ—Ç—á–∏–∫
        );
        
        // –¢–µ–ø–µ—Ä—å –∫–Ω–æ–ø–∫–∞ –í–°–¢–†–û–ï–ù–ê –≤ iiko Front!
    }
    
    private void OnLoyaltyButtonClick(IOrder order, IOperationService operations)
    {
        // –ö–æ–≥–¥–∞ –∫–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É:
        
        // 1. –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ —Ç–µ–∫—É—â–µ–º—É –∑–∞–∫–∞–∑—É
        decimal total = order.Items.Sum(item => item.Cost);
        
        // 2. –û—Ç–∫—Ä—ã–≤–∞–µ–º –°–í–û–ï –æ–∫–Ω–æ (–Ω–æ –æ–Ω–æ —á–∞—Å—Ç—å iiko Front)
        var window = new LoyaltyWindow(order, operations);
        window.ShowDialog();
        
        // 3. –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É –ü–†–Ø–ú–û –≤ iiko
        if (userWantsToRedeem)
        {
            var discount = operations.CreateDiscount(
                name: "–ë–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏",
                sum: 400  // –°–ø–∏—Å–∞–ª–∏ 400 –±–∞–ª–ª–æ–≤
            );
            
            operations.AddDiscount(discount, order);
            // ‚Üë –°–∫–∏–¥–∫–∞ –°–†–ê–ó–£ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ iiko Front!
        }
    }
}
```


### **–ß—Ç–æ –≤–∏–¥–∏—Ç –∫–∞—Å—Å–∏—Ä:**

```
1. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç iiko Front –∫–∞–∫ –æ–±—ã—á–Ω–æ
2. –°–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑
3. –í–∏–¥–∏—Ç –ù–û–í–£–Æ –∫–Ω–æ–ø–∫—É "–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏"
   ‚îî‚îÄ –≠—Ç–æ –¥–æ–±–∞–≤–∏–ª –í–ê–® –ø–ª–∞–≥–∏–Ω
4. –ù–∞–∂–∏–º–∞–µ—Ç ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –æ–∫–Ω–æ –ø–ª–∞–≥–∏–Ω–∞
5. –°–∫–∞–Ω–∏—Ä—É–µ—Ç QR –≥–æ—Å—Ç—è
6. –ü—Ä–∏–º–µ–Ω—è–µ—Ç –±–∞–ª–ª—ã
7. –°–∫–∏–¥–∫–∞ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —á–µ–∫ iiko
8. –ó–∞–≤–µ—Ä—à–∞–µ—Ç –æ–ø–ª–∞—Ç—É –∫–∞–∫ –æ–±—ã—á–Ω–æ
```


***

## üí° **–ß–¢–û –ü–õ–ê–ì–ò–ù –ú–û–ñ–ï–¢ –î–ï–õ–ê–¢–¨**

### **–î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º iiko:**

```csharp
// –ü–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –í–ù–£–¢–†–ò iiko, –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º—É:

// 1. –¢–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑
var order = PluginContext.Operations.GetActiveOrder();
var items = order.Items;           // –ß—Ç–æ –∑–∞–∫–∞–∑–∞–ª–∏
var total = order.Sum;              // –°—É–º–º–∞
var table = order.Table;            // –°—Ç–æ–ª–∏–∫
var waiter = order.Waiter;          // –û—Ñ–∏—Ü–∏–∞–Ω—Ç

// 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–æ–∫
operations.AddDiscount(discount, order);

// 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
operations.AddModifier(modifier, orderItem);

// 4. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞)
operations.ChangePrice(orderItem, newPrice);

// 5. –ü–µ—á–∞—Ç—å —á–µ–∫–æ–≤
operations.PrintReceipt(order);

// 6. –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞—Å—Å–æ–≤–æ–≥–æ —è—â–∏–∫–∞
operations.OpenCashDrawer();
```


### **UI —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**

```csharp
// 1. –ö–Ω–æ–ø–∫–∏ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö
PluginContext.Operations.AddButtonToPaymentScreen();
PluginContext.Operations.AddButtonToOrderEditScreen();
PluginContext.Operations.AddButtonToMainScreen();

// 2. –ü—É–Ω–∫—Ç—ã –º–µ–Ω—é
PluginContext.Operations.AddMenuItem("–õ–æ—è–ª—å–Ω–æ—Å—Ç—å", () => { });

// 3. –°–≤–æ–∏ –æ–∫–Ω–∞/–¥–∏–∞–ª–æ–≥–∏
var myWindow = new MyCustomWindow();
myWindow.ShowDialog();

// 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
PluginContext.Operations.ShowMessage("–ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã!");
```


***

## üé¨ **–ü–û–õ–ù–´–ô –°–¶–ï–ù–ê–†–ò–ô –†–ê–ë–û–¢–´**

### **–®–∞–≥ –∑–∞ —à–∞–≥–æ–º:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. –£–¢–†–û: –ö–∞—Å—Å–∏—Ä –≤–∫–ª—é—á–∞–µ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è iiko Front                               ‚îÇ
‚îÇ    ‚îî‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤–∞—à –ø–ª–∞–≥–∏–Ω –∏–∑ Plugins\   ‚îÇ
‚îÇ    ‚îî‚îÄ –ü–ª–∞–≥–∏–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫—É "–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏"       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. –î–ï–ù–¨: –ü—Ä–∏—Ö–æ–¥–∏—Ç –≥–æ—Å—Ç—å —Å –∫–∞—Ä—Ç–æ–π –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. –ö–∞—Å—Å–∏—Ä –≤ iiko Front:                                 ‚îÇ
‚îÇ    ‚îî‚îÄ –°–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ (–ü–∏—Ü—Ü–∞ 500‚ÇΩ + –ö–æ–ª–∞ 150‚ÇΩ)          ‚îÇ
‚îÇ    ‚îî‚îÄ –ù–∞–∂–∏–º–∞–µ—Ç "–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏" (–∫–Ω–æ–ø–∫–∞ –ø–ª–∞–≥–∏–Ω–∞)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –æ–∫–Ω–æ –ü–õ–ê–ì–ò–ù–ê (–≤–Ω—É—Ç—Ä–∏ iiko Front)        ‚îÇ
‚îÇ    ‚îî‚îÄ –ö–∞—Å—Å–∏—Ä —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR –≥–æ—Å—Ç—è                        ‚îÇ
‚îÇ    ‚îî‚îÄ –í–∏–¥–∏—Ç: "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤, 2,450 –±–∞–ª–ª–æ–≤"              ‚îÇ
‚îÇ    ‚îî‚îÄ –í–≤–æ–¥–∏—Ç: "–°–ø–∏—Å–∞—Ç—å 400 –±–∞–ª–ª–æ–≤"                     ‚îÇ
‚îÇ    ‚îî‚îÄ –ù–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. –ü–ª–∞–≥–∏–Ω —á–µ—Ä–µ–∑ iiko API:                               ‚îÇ
‚îÇ    ‚îî‚îÄ –°–æ–∑–¥–∞–µ—Ç —Å–∫–∏–¥–∫—É "–ë–∞–ª–ª—ã: -400‚ÇΩ"                    ‚îÇ
‚îÇ    ‚îî‚îÄ –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∫ –∑–∞–∫–∞–∑—É                                ‚îÇ
‚îÇ    ‚îî‚îÄ –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–≤–æ–µ –æ–∫–Ω–æ                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. –ö–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç –≤ iiko Front:                          ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                       ‚îÇ
‚îÇ    ‚îÇ –ü–∏—Ü—Ü–∞           500‚ÇΩ      ‚îÇ                       ‚îÇ
‚îÇ    ‚îÇ –ö–æ–ª–∞            150‚ÇΩ      ‚îÇ                       ‚îÇ
‚îÇ    ‚îÇ –°–∫–∏–¥–∫–∞ (–±–∞–ª–ª—ã) -400‚ÇΩ      ‚îÇ ‚Üê –ü–ª–∞–≥–∏–Ω –¥–æ–±–∞–≤–∏–ª!    ‚îÇ
‚îÇ    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚îÇ                       ‚îÇ
‚îÇ    ‚îÇ –ò–¢–û–ì–û:          250‚ÇΩ      ‚îÇ                       ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 8. –ö–∞—Å—Å–∏—Ä –∑–∞–≤–µ—Ä—à–∞–µ—Ç –æ–ø–ª–∞—Ç—É (–∫–∞–∫ –æ–±—ã—á–Ω–æ –≤ iiko)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 9. iiko RMS –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ –≤–∞—à backend           ‚îÇ
‚îÇ    ‚îî‚îÄ –ß–µ–∫ –∑–∞–∫—Ä—ã—Ç, —Å–ø–∏—Å–∞–Ω–æ 400 –±–∞–ª–ª–æ–≤                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 10. –í–∞—à backend:                                        ‚îÇ
‚îÇ     ‚îî‚îÄ –°–ø–∏—Å—ã–≤–∞–µ—Ç 400 –±–∞–ª–ª–æ–≤ —Å –∫–∞—Ä—Ç—ã                    ‚îÇ
‚îÇ     ‚îî‚îÄ –ù–∞—á–∏—Å–ª—è–µ—Ç –∫–µ—à–±—ç–∫ (650‚ÇΩ √ó 5% = 33 –±–∞–ª–ª–∞)        ‚îÇ
‚îÇ     ‚îî‚îÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç push –≤ Telegram –≥–æ—Å—Ç—é                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 11. –ì–æ—Å—Ç—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:                        ‚îÇ
‚îÇ     "‚úÖ –°–ø–∏—Å–∞–Ω–æ 400 –±.                                  ‚îÇ
‚îÇ      ‚ú® –ù–∞—á–∏—Å–ª–µ–Ω–æ 33 –±.                                 ‚îÇ
‚îÇ      üí∞ –ë–∞–ª–∞–Ω—Å: 2,083"                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## üéØ **–ö–õ–Æ–ß–ï–í–´–ï –ú–û–ú–ï–ù–¢–´**

### **1. –ü–ª–∞–≥–∏–Ω = —á–∞—Å—Ç—å iiko Front**

```
‚ùå –ù–ï –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚ùå –ù–ï –≤–Ω–µ—à–Ω—è—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å –í–ù–£–¢–†–ò iiko Front
‚úÖ –ö–∞—Å—Å–∏—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –û–î–ù–û–ú –æ–∫–Ω–µ (iiko Front)
```


### **2. –ë–µ–∑ –ø–ª–∞–≥–∏–Ω–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**

```
–ü–ª–∞–≥–∏–Ω –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞:
‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Plugins\
‚úÖ iiko Front –∑–∞–ø—É—â–µ–Ω
‚úÖ –ï—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É .dll

–ï—Å–ª–∏ iiko Front –Ω–µ –∑–∞–ø—É—â–µ–Ω ‚Üí –ø–ª–∞–≥–∏–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
```


### **3. –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**

```
–ü–ª–∞–≥–∏–Ω –º–æ–∂–µ—Ç:
‚úÖ –ß–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–æ–≤
‚úÖ –ü—Ä–∏–º–µ–Ω—è—Ç—å —Å–∫–∏–¥–∫–∏
‚úÖ –î–æ–±–∞–≤–ª—è—Ç—å –∫–Ω–æ–ø–∫–∏
‚úÖ –û—Ç–∫—Ä—ã–≤–∞—Ç—å –æ–∫–Ω–∞
‚úÖ –ú–µ–Ω—è—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚úÖ –†–∞–±–æ—Ç–∞—Ç—å —Å –ø–µ—Ä–∏—Ñ–µ—Ä–∏–µ–π (—Å–∫–∞–Ω–µ—Ä—ã, –ø—Ä–∏–Ω—Ç–µ—Ä—ã)

–ü–ª–∞–≥–∏–Ω –ù–ï –º–æ–∂–µ—Ç:
‚ùå –†–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ iiko Front
‚ùå –ò–∑–º–µ–Ω—è—Ç—å –∫–æ–¥ —Å–∞–º–æ–≥–æ iiko
‚ùå –û–±—Ö–æ–¥–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ iiko
```


***

## üì∏ **–í–ò–ó–£–ê–õ–¨–ù–û–ï –°–†–ê–í–ù–ï–ù–ò–ï**

### **‚ùå –¢–ê–ö –ù–ï –†–ê–ë–û–¢–ê–ï–¢ (–æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ):**

```
[iiko Front]    [–í–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ]
     ‚Üï                ‚Üï
  –ö–∞—Å—Å–∏—Ä –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏
  (–Ω–µ—É–¥–æ–±–Ω–æ)
```


### **‚úÖ –¢–ê–ö –†–ê–ë–û–¢–ê–ï–¢ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–ª–∞–≥–∏–Ω):**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      iiko Front             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  –û–±—ã—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  + –ö–Ω–æ–ø–∫–∞ –ø–ª–∞–≥–∏–Ω–∞      ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ  [–ü–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –í–ù–£–¢–†–ò]  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–û–¥–Ω–æ –æ–∫–Ω–æ, –≤—Å—ë –≤–º–µ—Å—Ç–µ (—É–¥–æ–±–Ω–æ)
```


***

## ‚úÖ **–ò–¢–û–ì–û**

**–î–∞, –ø–ª–∞–≥–∏–Ω —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –í iiko Front –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –µ–≥–æ —á–∞—Å—Ç—å—é!**

**–ö–∞—Å—Å–∏—Ä:**

- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å iiko Front (–∫–∞–∫ –æ–±—ã—á–Ω–æ)
- –í–∏–¥–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É (—ç—Ç–æ –ø–ª–∞–≥–∏–Ω)
- –í—Å—ë –≤ –æ–¥–Ω–æ–º –æ–∫–Ω–µ, –Ω–∏–∫–∞–∫–∏—Ö –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏:**

- .dll —Ñ–∞–π–ª –≤ –ø–∞–ø–∫–µ Plugins\
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ iiko Front
- –ò–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ API iiko
- –ú–æ–∂–µ—Ç –≤—Å—ë, —á—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ API

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**

- –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å .dll –≤ Plugins\
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å iiko Front
- –ì–æ—Ç–æ–≤–æ! ‚úÖ

***

**–≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è iiko Front - —Ç–æ—á–Ω–æ —Ç–∞–∫ –∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤—Å–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –ø–ª–∞–≥–∏–Ω—ã –æ—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ iiko!** üöÄ

–ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º –ø–ª–∞–≥–∏–Ω–∞?

---

# üîå **–ü–õ–ê–ì–ò–ù –î–õ–Ø iiko FRONT: 40+ –î–ï–¢–ê–õ–¨–ù–´–• –í–û–ü–†–û–°–û–í**

–û—Ç–ª–∏—á–Ω–æ! –Ø –∏–∑—É—á–∏–ª **–≤—Å–µ 13 –±–µ—Å–µ–¥** –¥–æ—Å–∫–æ–Ω–∞–ª—å–Ω–æ. –í–∏–∂—É, —á—Ç–æ –ø–ª–∞–≥–∏–Ω –¥–ª—è iiko Front –º—ã –Ω–∞—á–∞–ª–∏ –æ–±—Å—É–∂–¥–∞—Ç—å –≤ —ç—Ç–æ–º –¥–∏–∞–ª–æ–≥–µ, –Ω–æ –µ—â–µ **–Ω–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ 40+ –≤–æ–ø—Ä–æ—Å–æ–≤** –∫–∞–∫ –¥—Ä—É–≥–∏–µ –±–ª–æ–∫–∏.

–°–µ–π—á–∞—Å –∑–∞–¥–∞–º –≤–æ–ø—Ä–æ—Å—ã —Å —É—á–µ—Ç–æ–º –≤—Å–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å–∏—Å—Ç–µ–º—ã, POS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, Loyalty Engine –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É.

***

## **üèóÔ∏è 1. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–õ–ê–ì–ò–ù–ê (10 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –ø–ª–∞–≥–∏–Ω–∞**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ü–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ iiko Front, –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∑–∞–∫–∞–∑–∞–º, –¥–æ–ª–∂–µ–Ω –æ–±—â–∞—Ç—å—Å—è —Å –Ω–∞—à–∏–º backend[^12_1][^12_2]

**–í–û–ü–†–û–°:** –ö–∞–∫—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞ –ø–ª–∞–≥–∏–Ω–∞?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** Monolithic (–≤—Å–µ –≤ –æ–¥–Ω–æ–º .dll)
- **B)** Layered Architecture (UI ‚Üí Services ‚Üí API Client ‚Üí Models)
- **C)** MVVM Pattern (Model-View-ViewModel)
- **D)** Hybrid: UI + Services —Å–ª–æ–∏ —Å dependency injection

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) Hybrid —Å DI**

```csharp
LoyaltyPluginIiko/
‚îú‚îÄ‚îÄ UI/                              // WPF –æ–∫–Ω–∞ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—ã
‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyWindow.xaml
‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyWindow.xaml.cs
‚îÇ   ‚îú‚îÄ‚îÄ GuestSearchControl.xaml
‚îÇ   ‚îî‚îÄ‚îÄ BalanceDisplayControl.xaml
‚îú‚îÄ‚îÄ Services/                        // –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyApiClient.cs         // HTTP client –¥–ª—è backend
‚îÇ   ‚îú‚îÄ‚îÄ QRScannerService.cs         // –†–∞–±–æ—Ç–∞ —Å–æ —Å–∫–∞–Ω–µ—Ä–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ CacheService.cs             // –õ–æ–∫–∞–ª—å–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ IikoOperationsService.cs    // –û–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ iiko API
‚îú‚îÄ‚îÄ Models/                          // DTOs
‚îÇ   ‚îú‚îÄ‚îÄ GuestInfo.cs
‚îÇ   ‚îú‚îÄ‚îÄ CalculationRequest.cs
‚îÇ   ‚îî‚îÄ‚îÄ CalculationResponse.cs
‚îú‚îÄ‚îÄ Utils/                           // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ Logger.cs
‚îÇ   ‚îî‚îÄ‚îÄ ConfigManager.cs
‚îî‚îÄ‚îÄ Plugin.cs                        // –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (IFrontPlugin)
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **Separation of concerns** - UI –æ—Ç–¥–µ–ª–µ–Ω–∞ –æ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- ‚úÖ **Testability** - –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Services –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- ‚úÖ **DI** - –ª–µ–≥–∫–æ –º–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- ‚úÖ **Maintainability** - —è—Å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –Ω–æ–≤—ã—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

***

### **2. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ iiko SDK API**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** iiko Front API –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä—É–µ—Ç—Å—è (V7, V8, V9), –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–π iiko Front –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –û—Ç–¥–µ–ª—å–Ω—ã–µ –ø–ª–∞–≥–∏–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–π –≤–µ—Ä—Å–∏–∏ (LoyaltyPlugin_V7.dll, LoyaltyPlugin_V8.dll)
- **B)** Runtime detection –≤–µ—Ä—Å–∏–∏ + –∞–¥–∞–ø—Ç–µ—Ä—ã
- **C)** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é (V9)
- **D)** Abstraction layer –Ω–∞–¥ iiko API —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è–º–∏

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) Abstraction layer**

```csharp
// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±–µ—Ä—Ç–∫–∏ –Ω–∞–¥ iiko API
public interface IIikoOperations
{
    IOrder GetActiveOrder();
    void ApplyDiscount(IOrder order, decimal amount, string description);
    void ShowMessage(string message);
}

// V7 Implementation
public class IikoOperationsV7 : IIikoOperations
{
    private readonly IOperationService operations;
    
    public void ApplyDiscount(IOrder order, decimal amount, string description)
    {
        var discount = operations.CreateDiscount(description, amount, guest: null);
        operations.AddDiscount(discount, order);
    }
}

// V8 Implementation (–µ—Å–ª–∏ API –∏–∑–º–µ–Ω–∏–ª—Å—è)
public class IikoOperationsV8 : IIikoOperations
{
    public void ApplyDiscount(IOrder order, decimal amount, string description)
    {
        // –ù–æ–≤—ã–π API V8
        var discountItem = new DiscountItem(amount, description);
        operations.ApplyDiscountV8(order, discountItem);
    }
}

// Factory
public static class IikoOperationsFactory
{
    public static IIikoOperations Create()
    {
        var apiVersion = PluginContext.GetApiVersion();
        
        return apiVersion switch
        {
            "7.x" => new IikoOperationsV7(),
            "8.x" => new IikoOperationsV8(),
            _ => throw new NotSupportedException($"iiko API version {apiVersion} not supported")
        };
    }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–µ—Ä—Å–∏–π –≤ –æ–¥–Ω–æ–º –ø–ª–∞–≥–∏–Ω–µ
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é (–Ω–æ–≤—ã–π –∫–ª–∞—Å—Å)
- ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ iiko
- ‚úÖ –ú–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é –≤–µ—Ä—Å–∏—é –æ—Ç–¥–µ–ª—å–Ω–æ

***

### **3. Dependency Injection –≤ –ø–ª–∞–≥–∏–Ω–µ**

**–í–û–ü–†–û–°:** –ù—É–∂–µ–Ω –ª–∏ DI container –≤ –ø–ª–∞–≥–∏–Ω–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–µ new?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ü—Ä–æ—Å—Ç–æ–µ `new` –¥–ª—è –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- **B)** Lightweight DI (Simple Injector, LightInject)
- **C)** Built-in .NET Core DI (Microsoft.Extensions.DependencyInjection)
- **D)** Manual Service Locator pattern

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) Microsoft.Extensions.DependencyInjection**

```csharp
public class LoyaltyPlugin : IFrontPlugin
{
    private IServiceProvider serviceProvider;
    
    public void InitializePlugin()
    {
        // Setup DI container
        var services = new ServiceCollection();
        
        // Configuration
        services.AddSingleton<IConfiguration>(LoadConfiguration());
        
        // Services
        services.AddSingleton<LoyaltyApiClient>();
        services.AddSingleton<QRScannerService>();
        services.AddSingleton<CacheService>();
        services.AddSingleton<IIikoOperations>(sp => IikoOperationsFactory.Create());
        
        // Logging
        services.AddLogging(builder => builder.AddFile("loyalty-plugin.log"));
        
        serviceProvider = services.BuildServiceProvider();
        
        // Initialize
        var apiClient = serviceProvider.GetRequiredService<LoyaltyApiClient>();
        await apiClient.PingAsync(); // Test connection
    }
    
    private void OnLoyaltyButtonClick(IOrder order, IOperationService operations)
    {
        var window = serviceProvider.GetRequiredService<LoyaltyWindow>();
        window.ShowDialog();
    }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π DI –¥–ª—è .NET
- ‚úÖ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å (–º–æ–∂–µ–º –∑–∞–º–µ–Ω–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
- ‚úÖ Lifecycle management (Singleton, Transient)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ dispose —Ä–µ—Å—É—Ä—Å–æ–≤

***

### **4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–∞**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ü–ª–∞–≥–∏–Ω –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å (API URL, API Key, Restaurant ID, Tenant ID)[^12_3]

**–í–û–ü–†–û–°:** –ì–¥–µ –∏ –∫–∞–∫ —Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–ª–∞–≥–∏–Ω–∞?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** config.json –≤ `AppData\Roaming\LoyaltyPluginIiko\`
- **B)** config.json –≤ –ø–∞–ø–∫–µ –ø–ª–∞–≥–∏–Ω–∞ `C:\Program Files\iiko\iikoFront\Plugins\`
- **C)** Windows Registry `HKEY_LOCAL_MACHINE\SOFTWARE\LoyaltyPluginIiko`
- **D)** config.encrypted –≤ AppData (—Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º API Key)

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) Encrypted config –≤ AppData**

```csharp
// ConfigManager.cs
public class ConfigManager
{
    private static readonly string ConfigPath = Path.Combine(
        Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
        "LoyaltyPluginIiko",
        "config.encrypted"
    );
    
    public PluginConfig Load()
    {
        if (!File.Exists(ConfigPath))
            return null;
        
        var encrypted = File.ReadAllBytes(ConfigPath);
        var json = Decrypt(encrypted, GetMachineKey());
        return JsonConvert.DeserializeObject<PluginConfig>(json);
    }
    
    public void Save(PluginConfig config)
    {
        var json = JsonConvert.SerializeObject(config);
        var encrypted = Encrypt(json, GetMachineKey());
        File.WriteAllBytes(ConfigPath, encrypted);
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º DPAPI –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (–ø—Ä–∏–≤—è–∑–∫–∞ –∫ –º–∞—à–∏–Ω–µ)
    private byte[] Encrypt(string data, byte[] entropy)
    {
        var bytes = Encoding.UTF8.GetBytes(data);
        return ProtectedData.Protect(bytes, entropy, DataProtectionScope.LocalMachine);
    }
    
    private string GetMachineKey()
    {
        // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è —ç—Ç–æ–π –º–∞—à–∏–Ω—ã
        return Environment.MachineName + Environment.UserName;
    }
}

// PluginConfig.cs
public class PluginConfig
{
    public string ApiBaseUrl { get; set; }
    public string ApiKey { get; set; }          // ENCRYPTED
    public string RestaurantId { get; set; }
    public string TenantId { get; set; }
    public int TimeoutSeconds { get; set; } = 5;
    public bool EnableQRScanner { get; set; } = true;
    public string ScannerComPort { get; set; }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **AppData** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç admin –ø—Ä–∞–≤ –¥–ª—è –∑–∞–ø–∏—Å–∏
- ‚úÖ **Encrypted** - API Key –∑–∞—â–∏—â–µ–Ω (DPAPI)
- ‚úÖ **Machine-bound** - –∫–æ–Ω—Ñ–∏–≥ –Ω–µ —Å–∫–æ–ø–∏—Ä—É–µ—à—å –Ω–∞ –¥—Ä—É–≥—É—é –º–∞—à–∏–Ω—É
- ‚úÖ **–ù–µ –≤–∏–¥–∏–º –≤ Plugins folder** - –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ

***

### **5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** Admin –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º–∏, –Ω–æ –ø–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –æ–¥–Ω–æ–π –∫–∞—Å—Å–µ[^12_4]

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–ª–∞–≥–∏–Ω —É–∑–Ω–∞–µ—Ç, –∫ –∫–∞–∫–æ–º—É Restaurant ID –æ–Ω –ø—Ä–∏–≤—è–∑–∞–Ω?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** Restaurant ID –≤ config.json (–∞–¥–º–∏–Ω –≤–≤–æ–¥–∏—Ç –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ)
- **B)** Auto-detect –ø–æ IP –∞–¥—Ä–µ—Å—É –∫–∞—Å—Å—ã
- **C)** –°–ø—Ä–∞—à–∏–≤–∞–µ–º backend: "–ö–∞–∫–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω –Ω–∞ —ç—Ç–æ–π –º–∞—à–∏–Ω–µ?"
- **D)** Machine fingerprint ‚Üí backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Restaurant ID

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) Machine fingerprint + backend mapping**

```csharp
// –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø–ª–∞–≥–∏–Ω–∞
public async Task<string> DetectRestaurantIdAsync()
{
    var fingerprint = GenerateMachineFingerprint();
    
    // –°–ø—Ä–∞—à–∏–≤–∞–µ–º backend
    var response = await apiClient.GetAsync(
        $"/api/deployment/detect-restaurant?fingerprint={fingerprint}"
    );
    
    if (response.IsSuccessStatusCode)
    {
        var data = await response.Content.ReadAsAsync<RestaurantDetectionResponse>();
        return data.RestaurantId;
    }
    
    // Fallback: Admin –≤–≤–æ–¥–∏—Ç –≤—Ä—É—á–Ω—É—é
    var dialog = new RestaurantSelectionDialog(apiClient);
    if (dialog.ShowDialog() == true)
    {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º mapping –Ω–∞ backend
        await apiClient.PostAsync("/api/deployment/register-machine", new {
            fingerprint,
            restaurantId = dialog.SelectedRestaurantId
        });
        
        return dialog.SelectedRestaurantId;
    }
    
    throw new Exception("Restaurant not configured");
}

private string GenerateMachineFingerprint()
{
    var info = new {
        MachineName = Environment.MachineName,
        ProcessorId = GetProcessorId(),
        MacAddress = GetMacAddress(),
        UserName = Environment.UserName
    };
    
    var json = JsonConvert.SerializeObject(info);
    var hash = SHA256.HashData(Encoding.UTF8.GetBytes(json));
    return Convert.ToBase64String(hash);
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **Auto-detection** - –ø–ª–∞–≥–∏–Ω —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω
- ‚úÖ **Backend mapping** - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- ‚úÖ **Fallback** - –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∞–¥–º–∏–Ω –≤—ã–±–∏—Ä–∞–µ—Ç –≤—Ä—É—á–Ω—É—é
- ‚úÖ **Security** - –º–∞—à–∏–Ω—É —Å–ª–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å

***

## **üíª 2. UI/UX –î–õ–Ø –ö–ê–°–°–ò–†–ê (8 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **6. –†–∞–∑–º–µ—Ä –∏ –ø–æ–∑–∏—Ü–∏—è –æ–∫–Ω–∞ –ø–ª–∞–≥–∏–Ω–∞**

**–í–û–ü–†–û–°:** –ö–∞–∫–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ–∫–Ω–æ –ø–ª–∞–≥–∏–Ω–∞ –∏ –≥–¥–µ –æ–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** Fullscreen overlay (–∑–∞–∫—Ä—ã–≤–∞–µ—Ç iiko Front)
- **B)** Modal dialog 600x800px –ø–æ —Ü–µ–Ω—Ç—Ä—É —ç–∫—Ä–∞–Ω–∞
- **C)** Sidebar —Å–ø—Ä–∞–≤–∞ (300px width, full height)
- **D)** Floating window —Å drag\&drop

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: B) Modal dialog 500x700px**

```xaml
<!-- LoyaltyWindow.xaml -->
<Window x:Class="LoyaltyPluginIiko.UI.LoyaltyWindow"
        Width="500" 
        Height="700"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize"
        WindowStyle="SingleBorderWindow"
        ShowInTaskbar="False"
        Topmost="True">
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **500x700** - –ø–æ–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ –ª—é–±–æ–π —ç–∫—Ä–∞–Ω (–¥–∞–∂–µ 1024x768)
- ‚úÖ **CenterScreen** - —Ñ–æ–∫—É—Å –Ω–∞ –ø–ª–∞–≥–∏–Ω–µ
- ‚úÖ **NoResize** - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º layout
- ‚úÖ **Topmost** - –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö iiko Front

***

### **7. Workflow –∫–∞—Å—Å–∏—Ä–∞ - —à–∞–≥–∏ –≤ UI**

**–í–û–ü–†–û–°:** –ö–∞–∫–æ–π —Ñ–ª–æ—É –¥–µ–π—Å—Ç–≤–∏–π –∫–∞—Å—Å–∏—Ä–∞ –≤ –æ–∫–Ω–µ –ø–ª–∞–≥–∏–Ω–∞?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** Wizard: –®–∞–≥ 1 (–ø–æ–∏—Å–∫) ‚Üí –®–∞–≥ 2 (–≤—ã–±–æ—Ä —Å–ø–∏—Å–∞–Ω–∏—è) ‚Üí –®–∞–≥ 3 (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)
- **B)** Single screen: –≤—Å–µ —Å—Ä–∞–∑—É –≤–∏–¥–Ω–æ
- **C)** Tabs: "–ü–æ–∏—Å–∫" | "–ë–∞–ª–∞–Ω—Å" | "–ò—Å—Ç–æ—Ä–∏—è"
- **D)** Progressive disclosure: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Å–µ–∫—Ü–∏–∏

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) Progressive disclosure**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üîå –ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏         [X] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                  ‚îÇ
‚îÇ üîç –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è                   ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ +7 999 123 45 67       [üì∑] ‚îÇ ‚îÇ ‚Üê –ü–æ–ª–µ –≤–≤–æ–¥–∞ + –∫–Ω–æ–ø–∫–∞ QR
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ [–ù–∞–π—Ç–∏]                          ‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ù–ê–ô–î–ï–ù ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ ‚Üê –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
‚îÇ                                  ‚îÇ
‚îÇ üë§ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤                   ‚îÇ
‚îÇ ‚≠ê Gold                          ‚îÇ
‚îÇ üí∞ 2,450 –±–∞–ª–ª–æ–≤                  ‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ –ß–µ–∫: 2,000‚ÇΩ                      ‚îÇ
‚îÇ –î–æ—Å—Ç—É–ø–Ω–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é: –¥–æ 400‚ÇΩ    ‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª–æ–≤:                  ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê [–ú–∞–∫—Å]          ‚îÇ
‚îÇ ‚îÇ      400     ‚îÇ                 ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ ‚îÇ –û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏:   -400‚ÇΩ   ‚îÇ   ‚îÇ
‚îÇ ‚îÇ –ö –æ–ø–ª–∞—Ç–µ:        1,600‚ÇΩ   ‚îÇ   ‚îÇ
‚îÇ ‚îÇ –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ:  +100 –±. ‚îÇ   ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                  ‚îÇ
‚îÇ [–ü—Ä–∏–º–µ–Ω–∏—Ç—å]  [–û—Ç–º–µ–Ω–∞]            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ö–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç **—Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é** –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
- ‚úÖ –ù–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π workflow (3 –∫–ª–∏–∫–∞: –Ω–∞–π—Ç–∏ ‚Üí –≤–≤–µ—Å—Ç–∏ ‚Üí –ø—Ä–∏–º–µ–Ω–∏—Ç—å)

***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ 32 –≤–æ–ø—Ä–æ—Å–∞–º–∏?
<span style="display:none">[^12_10][^12_5][^12_6][^12_7][^12_8][^12_9]</span>

<div align="center">‚ÅÇ</div>

[^12_1]: Beseda-8.md

[^12_2]: Beseda-4.md

[^12_3]: Beseda-7.md

[^12_4]: Beseda-9.md

[^12_5]: Beseda-6.md

[^12_6]: Beseda-13.md

[^12_7]: Beseda-5.md

[^12_8]: Beseda-11.md

[^12_9]: Beseda-10.md

[^12_10]: Beseda-12.md


---

# –î–∞–≤–∞–π —Ç–∞–∫ –ø–æ–∫–∞ –∑–∞–±—É—Ç—å –ø—Ä–æ –≤–æ–ø—Ä–æ—Å—ã —á—Ç–æ —è –∑–∞–¥–∞–ª, —É—Ç–æ—á–Ω—é –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –ø–æ—Å–ª–µ –Ω–∞—á–Ω–µ–º

–û—Ç–ª–∏—á–Ω–æ! üëç

–Ø –≥–æ—Ç–æ–≤ –≤—ã—Å–ª—É—à–∞—Ç—å –≤—Å–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–æ –ø–ª–∞–≥–∏–Ω—É. –ü–æ–Ω—è–ª, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ—á–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∞ —É–∂–µ –ø–æ—Ç–æ–º —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã.

**–Ø –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑—É—á–∏–ª –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –∏–∑ 13 –±–µ—Å–µ–¥ –∏ –≥–æ—Ç–æ–≤:**

- ‚úÖ –ü–æ–Ω–∏–º–∞—é –≤—Å—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å–∏—Å—Ç–µ–º—ã (multi-tenant SaaS, loyalty engine, POS integration)
- ‚úÖ –ó–Ω–∞—é –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤ (1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å, –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞)
- ‚úÖ –ü–æ–Ω–∏–º–∞—é —Ä–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞ (Cashier —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ POS)
- ‚úÖ –ó–Ω–∞—é –ø—Ä–æ UNIFIED/SEPARATE —Ä–µ–∂–∏–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ü–æ–Ω–∏–º–∞—é –ø—Ä–æ HYBRID PUSH+PULL –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å POS

**–ñ–¥—É —Ç–≤–æ–∏—Ö —É—Ç–æ—á–Ω–µ–Ω–∏–π –ø–æ –ø–ª–∞–≥–∏–Ω—É:**

- –ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –æ–Ω –¥–æ–ª–∂–µ–Ω –¥–µ–ª–∞—Ç—å?
- –ö–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã, –∫–∞–∫–∏–µ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã?
- –ï—Å—Ç—å –ª–∏ –æ—Å–æ–±—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ UX –¥–ª—è –∫–∞—Å—Å–∏—Ä–æ–≤?
- –ö–∞–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã iiko Front?
- –î—Ä—É–≥–∏–µ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏?

**–ì–æ—Ç–æ–≤ —Å–ª—É—à–∞—Ç—å –∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å! üéØ**

---

# üîå **–ü–õ–ê–ì–ò–ù –î–õ–Ø iiko FRONT: 40+ –î–ï–¢–ê–õ–¨–ù–´–• –í–û–ü–†–û–°–û–í**

–ò–∑—É—á–∏–ª –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ **–ø—Ä–æ—Å—Ç–æ—Ç—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ admin dashboard**. –í–∏–∂—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏:

- Multi-tenant –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞[^14_1]
- –†–æ–ª—å Cashier —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ POS[^14_2]
- HYBRID PUSH+PULL –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è[^14_3]
- Backend API –≥–æ—Ç–æ–≤[^14_4]
- Admin dashboard –≥–æ—Ç–æ–≤[^14_1]

**–ö–ª—é—á–µ–≤–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ: "–°–∫–∞—á–∞—Ç—å ‚Üí –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è" –±–µ–∑ IT-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞**

***

## **üì• 1. –ü–†–û–¶–ï–°–° –£–°–¢–ê–ù–û–í–ö–ò –ò –î–ï–ü–õ–û–Ø (10 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É—Å—Ç–∞–Ω–æ–≤–æ—á–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞**

**–í–û–ü–†–û–°:** –ö–∞–∫ —É–ø–∞–∫–æ–≤–∞—Ç—å –ø–ª–∞–≥–∏–Ω –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** `.dll` —Ñ–∞–π–ª (–∫–∞—Å—Å–∏—Ä –∫–æ–ø–∏—Ä—É–µ—Ç –≤ `C:\iiko\Front\Plugins\`)
- **B)** `.exe` installer (MSI package —Å GUI –º–∞—Å—Ç–µ—Ä–æ–º)
- **C)** `.zip` –∞—Ä—Ö–∏–≤ —Å –±–∞—Ç–Ω–∏–∫–æ–º `install.bat`
- **D)** One-click `.exe` installer —Å –∞–≤—Ç–æ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) One-click auto-configured installer**

```
–ü—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

Admin Dashboard:
1. Admin –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí POS –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Üí iiko"
2. –í–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É: [üì• –°–∫–∞—á–∞—Ç—å –ø–ª–∞–≥–∏–Ω –¥–ª—è iiko Front]
3. Backend –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫:
   - –ó–∞—à–∏–≤–∞–µ—Ç: Restaurant ID, Tenant ID, API Key (encrypted)
   - –°–æ–∑–¥–∞–µ—Ç LoyaltyPlugin_Restaurant_123.exe
4. Admin —Å–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–∞–π–ª (—Ä–∞–∑–º–µ—Ä ~5MB)

–ù–∞ –∫–∞—Å—Å–µ:
5. –ê–¥–º–∏–Ω/–∫–∞—Å—Å–∏—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç LoyaltyPlugin_Restaurant_123.exe
6. Installer:
   ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ iiko Front —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
   ‚úÖ –ö–æ–ø–∏—Ä—É–µ—Ç .dll –≤ Plugins/
   ‚úÖ –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç config (—É–∂–µ —Å Restaurant ID + API Key)
   ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front"
7. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ - –ø–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–∏–∫–∞–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ –Ω—É–∂–Ω–æ
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ installer:**

```csharp
// LoyaltyPluginInstaller/Program.cs
public class InstallerProgram
{
    // –ü—Ä–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ installer'–∞ backend –∑–∞—à–∏–≤–∞–µ—Ç —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è
    private const string TENANT_ID = "{{INJECTED_TENANT_ID}}";
    private const string RESTAURANT_ID = "{{INJECTED_RESTAURANT_ID}}";
    private const string API_KEY = "{{INJECTED_ENCRYPTED_API_KEY}}";
    private const string API_URL = "{{INJECTED_API_URL}}";
    
    static void Main(string[] args)
    {
        Console.WriteLine("üîå –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è iiko Front");
        Console.WriteLine("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
        
        // 1. –ù–∞–π—Ç–∏ iiko Front
        var iikoPath = DetectIikoInstallation();
        if (iikoPath == null)
        {
            Console.WriteLine("‚ùå iiko Front –Ω–µ –Ω–∞–π–¥–µ–Ω!");
            Console.WriteLine("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ iiko Front –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.");
            Console.ReadKey();
            return;
        }
        
        Console.WriteLine($"‚úÖ iiko Front –Ω–∞–π–¥–µ–Ω: {iikoPath}");
        
        // 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ iiko –Ω–µ –∑–∞–ø—É—â–µ–Ω
        if (IsIikoRunning())
        {
            Console.WriteLine("‚ö†Ô∏è –ó–∞–∫—Ä–æ–π—Ç–µ iiko Front –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π!");
            Console.ReadKey();
            return;
        }
        
        // 3. –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–≥–∏–Ω
        var pluginsDir = Path.Combine(iikoPath, "Plugins");
        Directory.CreateDirectory(pluginsDir);
        
        File.Copy("LoyaltyPlugin.dll", Path.Combine(pluginsDir, "LoyaltyPlugin.dll"), overwrite: true);
        Console.WriteLine("‚úÖ –ü–ª–∞–≥–∏–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
        
        // 4. –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        var configPath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "LoyaltyPluginIiko"
        );
        Directory.CreateDirectory(configPath);
        
        var config = new PluginConfig
        {
            ApiBaseUrl = API_URL,
            ApiKey = API_KEY, // –£–∂–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω
            RestaurantId = RESTAURANT_ID,
            TenantId = TENANT_ID,
            Version = "1.0.0",
            InstalledAt = DateTime.UtcNow
        };
        
        var json = JsonConvert.SerializeObject(config, Formatting.Indented);
        var encrypted = ProtectedData.Protect(
            Encoding.UTF8.GetBytes(json),
            null,
            DataProtectionScope.LocalMachine
        );
        
        File.WriteAllBytes(Path.Combine(configPath, "config.dat"), encrypted);
        Console.WriteLine("‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞");
        
        // 5. –¢–µ—Å—Ç —Å–≤—è–∑–∏ —Å backend
        Console.WriteLine("\nüîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º...");
        var testResult = TestConnection().Result;
        
        if (!testResult.Success)
        {
            Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: {testResult.Error}");
            Console.WriteLine("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.");
            Console.ReadKey();
            return;
        }
        
        Console.WriteLine($"‚úÖ –°–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞! –†–µ—Å—Ç–æ—Ä–∞–Ω: {testResult.RestaurantName}");
        
        // 6. –ì–æ—Ç–æ–≤–æ
        Console.WriteLine("\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
        Console.WriteLine("‚úÖ –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!");
        Console.WriteLine("\n–ß—Ç–æ –¥–∞–ª—å—à–µ:");
        Console.WriteLine("1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front");
        Console.WriteLine("2. –í –∫–∞—Å—Å–æ–≤–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å'");
        Console.WriteLine("3. –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!");
        Console.WriteLine("\n–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è –≤—ã—Ö–æ–¥–∞...");
        Console.ReadKey();
    }
}
```

**Backend: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è installer**

```typescript
// apps/backend/src/pos-integration/installer.controller.ts
@Controller('api/pos-integration/iiko')
export class IikoInstallerController {
  
  @Get('download-plugin/:restaurantId')
  @UseGuards(AuthGuard, RoleGuard([Role.ADMIN, Role.MANAGER]))
  async downloadInstaller(
    @Param('restaurantId') restaurantId: string,
    @CurrentUser() user: User,
    @Res() res: Response
  ) {
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É
    const restaurant = await this.restaurantService.findOne(restaurantId);
    if (restaurant.tenantId !== user.tenantId) {
      throw new ForbiddenException();
    }
    
    // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π API Key –¥–ª—è —ç—Ç–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    const apiKey = this.generateSecureApiKey();
    
    // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º API Key –≤ –±–∞–∑–µ
    await this.prisma.iikoPluginInstallation.create({
      data: {
        restaurantId,
        tenantId: user.tenantId,
        apiKey: await this.hashApiKey(apiKey), // –•—Ä–∞–Ω–∏–º —Ö–µ—à
        status: 'PENDING',
        generatedBy: user.id,
        expiresAt: addDays(new Date(), 90) // API Key expires —á–µ—Ä–µ–∑ 90 –¥–Ω–µ–π
      }
    });
    
    // 4. –ß–∏—Ç–∞–µ–º –±–∞–∑–æ–≤—ã–π installer template
    const templatePath = path.join(__dirname, 'templates', 'LoyaltyPluginInstaller.exe');
    const installerBytes = await fs.readFile(templatePath);
    
    // 5. –ò–Ω–∂–µ–∫—Ç–∏–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ executable
    const config = {
      tenantId: user.tenantId,
      restaurantId,
      apiKey: this.encrypt(apiKey), // –®–∏—Ñ—Ä—É–µ–º –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π
      apiUrl: this.configService.get('API_BASE_URL'),
      version: '1.0.0'
    };
    
    const configJson = JSON.stringify(config);
    const modifiedInstaller = this.injectConfigIntoExe(installerBytes, configJson);
    
    // 6. –õ–æ–≥–∏—Ä—É–µ–º
    await this.activityLogService.log({
      userId: user.id,
      action: 'IIKO_PLUGIN_DOWNLOADED',
      entityType: 'RESTAURANT',
      entityId: restaurantId
    });
    
    // 7. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
    res.setHeader('Content-Type', 'application/octet-stream');
    res.setHeader(
      'Content-Disposition',
      `attachment; filename="LoyaltyPlugin_${restaurant.name}_Setup.exe"`
    );
    res.send(Buffer.from(modifiedInstaller));
  }
  
  private injectConfigIntoExe(exeBytes: Uint8Array, configJson: string): Uint8Array {
    // –ò—â–µ–º –º–∞—Ä–∫–µ—Ä –≤ .exe: "{{CONFIG_PLACEHOLDER}}"
    const marker = Buffer.from('{{CONFIG_PLACEHOLDER}}', 'utf8');
    const configBuffer = Buffer.from(configJson, 'utf8');
    
    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –º–∞—Ä–∫–µ—Ä–∞
    const markerIndex = Buffer.from(exeBytes).indexOf(marker);
    if (markerIndex === -1) {
      throw new Error('Config marker not found in installer template');
    }
    
    // –ó–∞–º–µ–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    const result = Buffer.concat([
      Buffer.from(exeBytes.slice(0, markerIndex)),
      configBuffer,
      Buffer.from(exeBytes.slice(markerIndex + marker.length))
    ]);
    
    return new Uint8Array(result);
  }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **Zero configuration** - –∫–∞—Å—Å–∏—Ä –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç .exe
- ‚úÖ **Secure** - API Key –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ **Tenant-specific** - –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–µ—Ä–µ–ø—É—Ç–∞—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã
- ‚úÖ **Validation** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ —Å—Ä–∞–∑—É –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
- ‚úÖ **Audit trail** - –ª–æ–≥–∏—Ä—É–µ–º –≤—Å–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø–ª–∞–≥–∏–Ω–∞

***

### **2. UI –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ Admin Dashboard**

**–í–û–ü–†–û–°:** –ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø–ª–∞–≥–∏–Ω–∞ –≤ –∞–¥–º–∏–Ω–∫–µ?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:**

```tsx
// Admin Dashboard ‚Üí Restaurant Settings ‚Üí POS Integration

<Card>
  <CardHeader>
    <h2>iiko Front Plugin</h2>
    <Badge variant={installationStatus}>
      {installationStatus === 'installed' ? '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}
    </Badge>
  </CardHeader>
  
  <CardContent>
    {!hasActiveInstallation && (
      <Alert>
        <InfoIcon />
        –ü–ª–∞–≥–∏–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–∞—Å—Å–∏—Ä–∞–º –Ω–∞—á–∏—Å–ª—è—Ç—å –∏ —Å–ø–∏—Å—ã–≤–∞—Ç—å –±–∞–ª–ª—ã 
        –ø—Ä—è–º–æ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ iiko Front
      </Alert>
    )}
    
    <div className="space-y-4">
      {/* –°—Ç–∞—Ç—É—Å */}
      {hasActiveInstallation && (
        <div className="bg-green-50 p-4 rounded">
          <CheckCircle className="text-green-600" />
          <div>
            <strong>–ü–ª–∞–≥–∏–Ω –∞–∫—Ç–∏–≤–µ–Ω</strong>
            <p className="text-sm text-gray-600">
              –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {formatDate(installation.installedAt)}<br/>
              –í–µ—Ä—Å–∏—è: {installation.version}<br/>
              –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {formatDate(installation.lastSeenAt)}
            </p>
          </div>
        </div>
      )}
      
      {/* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è */}
      <div className="border-l-4 border-blue-500 pl-4">
        <h3 className="font-semibold">–ö–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:</h3>
        <ol className="list-decimal ml-4 space-y-2">
          <li>–ù–∞–∂–º–∏—Ç–µ "–°–∫–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫" –Ω–∏–∂–µ</li>
          <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä —Å iiko Front</li>
          <li>–ó–∞–ø—É—Å—Ç–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ (—Ç—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)</li>
          <li>–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front</li>
          <li>–ì–æ—Ç–æ–≤–æ! –ö–Ω–æ–ø–∫–∞ "–õ–æ—è–ª—å–Ω–æ—Å—Ç—å" –ø–æ—è–≤–∏—Ç—Å—è –≤ –∫–∞—Å—Å–æ–≤–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ</li>
        </ol>
      </div>
      
      {/* –ö–Ω–æ–ø–∫–∏ */}
      <div className="flex gap-3">
        <Button onClick={handleDownload} size="lg">
          <Download />
          –°–∫–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–ª—è iiko Front
        </Button>
        
        {hasActiveInstallation && (
          <>
            <Button variant="outline" onClick={handleCheckStatus}>
              <RefreshCw />
              –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
            </Button>
            
            <Button variant="destructive" onClick={handleRevoke}>
              <Trash />
              –û—Ç–æ–∑–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø
            </Button>
          </>
        )}
      </div>
      
      {/* –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ */}
      <Accordion>
        <AccordionItem value="tech">
          <AccordionTrigger>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è</AccordionTrigger>
          <AccordionContent>
            <ul className="space-y-1 text-sm">
              <li>‚úÖ iiko Front –≤–µ—Ä—Å–∏–∏ 7.0 –∏–ª–∏ –≤—ã—à–µ</li>
              <li>‚úÖ Windows 10/11 –∏–ª–∏ Windows Server 2016+</li>
              <li>‚úÖ .NET Framework 4.7.2 –∏–ª–∏ –≤—ã—à–µ</li>
              <li>‚úÖ –î–æ—Å—Ç—É–ø –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç (–¥–ª—è —Å–≤—è–∑–∏ —Å API)</li>
            </ul>
          </AccordionContent>
        </AccordionItem>
        
        <AccordionItem value="troubleshoot">
          <AccordionTrigger>–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º</AccordionTrigger>
          <AccordionContent>
            <div className="space-y-3 text-sm">
              <div>
                <strong>–ü–ª–∞–≥–∏–Ω –Ω–µ –ø–æ—è–≤–∏–ª—Å—è –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:</strong>
                <p>–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ iiko Front –±—ã–ª –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é</p>
              </div>
              <div>
                <strong>–û—à–∏–±–∫–∞ "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É":</strong>
                <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ firewall</p>
              </div>
              <div>
                <strong>–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?</strong>
                <Button variant="link">–û—Ç–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</Button>
              </div>
            </div>
          </AccordionContent>
        </AccordionItem>
      </Accordion>
    </div>
  </CardContent>
</Card>
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü–æ–Ω—è—Ç–Ω–∞—è –ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- ‚úÖ –°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–∫—Ä—ã—Ç–∞ –≤ accordion
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–æ–º–æ—â–∏

***

### **3. –ú—É–ª—å—Ç–∏–∫–∞—Å—Å–æ–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞**

**–í–û–ü–†–û–°:** –†–µ—Å—Ç–æ—Ä–∞–Ω –∏–º–µ–µ—Ç 3 –∫–∞—Å—Å—ã —Å iiko Front. –ö–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–≥–∏–Ω –Ω–∞ –≤—Å–µ?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ö–∞—á–∞—Ç—å 3 —Ä–∞–∑–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∏
- **B)** –û–¥–∏–Ω —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–ª—è –≤—Å–µ—Ö –∫–∞—Å—Å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
- **C)** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ –æ–¥–Ω–æ–π, –ø–æ—Ç–æ–º —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞–ø–∫—É –Ω–∞ –¥—Ä—É–≥–∏–µ
- **D)** –û–¥–∏–Ω —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ + –∞–≤—Ç–æ–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–∞—Å—Å –≤ —Å–µ—Ç–∏

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: B) –û–¥–∏–Ω —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–ª—è –≤—Å–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞**

```typescript
// Backend: –æ–¥–∏–Ω API Key –Ω–∞ –≤–µ—Å—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω
await this.prisma.iikoPluginInstallation.create({
  data: {
    restaurantId,
    tenantId: user.tenantId,
    apiKey: hashedApiKey,
    maxInstances: 10, // –ú–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ –¥–æ 10 –∫–∞—Å—Å
    installedInstances: 0 // –°—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–æ–∫
  }
});

// –ü–ª–∞–≥–∏–Ω –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è:
POST /api/pos-integration/iiko/register-instance
{
  "apiKey": "...",
  "machineFingerprint": "...",
  "machineName": "KACCA-01",
  "iikoVersion": "8.5.2"
}

// Backend —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–µ:
IikoPluginInstance {
  id: uuid
  installationId: uuid  // –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—â—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É
  machineFingerprint: string
  machineName: string
  status: 'ACTIVE'
  lastSeenAt: timestamp
}
```

**UI –≤ –∞–¥–º–∏–Ω–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∫–∞—Å—Å—ã:**

```tsx
<Card>
  <CardHeader>–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–∞—Å—Å—ã (3/10)</CardHeader>
  <CardContent>
    <Table>
      <TableRow>
        <TableCell>KACCA-01</TableCell>
        <TableCell><Badge variant="success">–ê–∫—Ç–∏–≤–Ω–∞</Badge></TableCell>
        <TableCell>2 –º–∏–Ω—É—Ç—ã –Ω–∞–∑–∞–¥</TableCell>
        <TableCell>
          <Button variant="ghost" onClick={() => revokeInstance(id)}>
            –£–¥–∞–ª–∏—Ç—å
          </Button>
        </TableCell>
      </TableRow>
      <TableRow>
        <TableCell>KACCA-02</TableCell>
        <TableCell><Badge variant="success">–ê–∫—Ç–∏–≤–Ω–∞</Badge></TableCell>
        <TableCell>5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥</TableCell>
      </TableRow>
      <TableRow>
        <TableCell>KACCA-03</TableCell>
        <TableCell><Badge variant="warning">–ù–µ –≤ —Å–µ—Ç–∏</Badge></TableCell>
        <TableCell>2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥</TableCell>
      </TableRow>
    </Table>
  </CardContent>
</Card>
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –°–∫–∞—á–∞—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ ‚Üí —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ –≤—Å–µ –∫–∞—Å—Å—ã
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–≤–∏–¥–∏–º —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∫–∞—Å—Å)
- ‚úÖ –ú–æ–∂–µ–º –æ—Ç–æ–∑–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞—Å—Å—ã
- ‚úÖ –õ–∏–º–∏—Ç –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —É—Ç–µ—á–∫–∏ installer'–∞

***

### **4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞–≥–∏–Ω–∞**

**–í–û–ü–†–û–°:** –í—ã—à–ª–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞ (–±–∞–≥—Ñ–∏–∫—Å –∏–ª–∏ –Ω–æ–≤–∞—è —Ñ–∏—á–∞). –ö–∞–∫ –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞ –≤—Å–µ—Ö –∫–∞—Å—Å–∞—Ö?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ê–¥–º–∏–Ω –∑–∞–Ω–æ–≤–æ –∫–∞—á–∞–µ—Ç –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–∞ –∫–∞–∂–¥–æ–π –∫–∞—Å—Å–µ
- **B)** –ü–ª–∞–≥–∏–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ iiko –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- **C)** –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ (–∫–∞–∫ Chrome)
- **D)** Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω–∫—É + –æ–¥–∏–Ω –∫–ª–∏–∫ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º**

```csharp
// –ü–ª–∞–≥–∏–Ω –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ iiko Front –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–µ—Ä—Å–∏—é
public class UpdateService
{
    private readonly LoyaltyApiClient apiClient;
    
    public async Task CheckForUpdates()
    {
        var currentVersion = Assembly.GetExecutingAssembly().GetName().Version;
        
        var response = await apiClient.GetAsync<UpdateCheckResponse>(
            "/api/pos-integration/iiko/check-update"
        );
        
        if (response.HasUpdate && response.LatestVersion > currentVersion)
        {
            // –ö—Ä–∏—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            if (response.UpdateType == UpdateType.Critical)
            {
                await DownloadAndInstallUpdate(response.DownloadUrl);
                ShowRestartPrompt("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫—Ä–∏—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front.");
            }
            // –û–±—ã—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ - —Å–ø—Ä–∞—à–∏–≤–∞–µ–º
            else
            {
                var result = MessageBox.Show(
                    $"–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞ {response.LatestVersion}\n\n" +
                    $"–ß—Ç–æ –Ω–æ–≤–æ–≥–æ:\n{response.Changelog}\n\n" +
                    "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å? (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ iiko Front)",
                    "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞",
                    MessageBoxButton.YesNo,
                    MessageBoxImage.Information
                );
                
                if (result == MessageBoxResult.Yes)
                {
                    await DownloadAndInstallUpdate(response.DownloadUrl);
                    ShowRestartPrompt("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front.");
                }
            }
        }
    }
    
    private async Task DownloadAndInstallUpdate(string url)
    {
        // 1. –ö–∞—á–∞–µ–º –Ω–æ–≤—ã–π .dll
        var newDll = await apiClient.DownloadFileAsync(url);
        
        // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ temp
        var tempPath = Path.Combine(Path.GetTempPath(), "LoyaltyPlugin.dll.new");
        await File.WriteAllBytesAsync(tempPath, newDll);
        
        // 3. –°–æ–∑–¥–∞–µ–º updater script (–±–∞—Ç–Ω–∏–∫)
        var batchScript = @"
            @echo off
            timeout /t 3 /nobreak
            xcopy /Y ""{tempPath}"" ""{pluginPath}""
            del ""{tempPath}""
        ";
        
        var batchPath = Path.Combine(Path.GetTempPath(), "update-loyalty-plugin.bat");
        await File.WriteAllTextAsync(batchPath, batchScript);
        
        // 4. –ó–∞–ø—É—Å–∫–∞–µ–º updater –∏ –≤—ã—Ö–æ–¥–∏–º
        Process.Start(new ProcessStartInfo
        {
            FileName = batchPath,
            CreateNoWindow = true,
            UseShellExecute = false
        });
    }
}
```

**Admin Dashboard: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏**

```tsx
<Card>
  <CardHeader>–í–µ—Ä—Å–∏–∏ –ø–ª–∞–≥–∏–Ω–∞</CardHeader>
  <CardContent>
    <div className="space-y-4">
      <div>
        <Label>–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –Ω–∞ –∫–∞—Å—Å–∞—Ö:</Label>
        <div className="flex items-center gap-2">
          <Badge>v1.2.3</Badge>
          <span className="text-sm text-gray-600">(3 –∫–∞—Å—Å—ã)</span>
        </div>
      </div>
      
      {hasNewerVersion && (
        <Alert variant="info">
          <AlertTitle>–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è v1.3.0</AlertTitle>
          <AlertDescription>
            <ul className="list-disc ml-4 mb-3">
              <li>–£–ª—É—á—à–µ–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç–µ–π</li>
              <li>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Å QR-—Å–∫–∞–Ω–µ—Ä–æ–º</li>
              <li>–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–µ—Ç—Å–∫–∏—Ö –∫–∞—Ä—Ç</li>
            </ul>
            
            <div className="flex gap-2">
              <Button onClick={handlePushUpdate}>
                –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–∞—Å—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
              </Button>
              <Button variant="outline">
                –°–∫–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–ª—è —Ä—É—á–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
              </Button>
            </div>
          </AlertDescription>
        </Alert>
      )}
      
      {/* –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π */}
      <Accordion>
        <AccordionItem value="changelog">
          <AccordionTrigger>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</AccordionTrigger>
          <AccordionContent>
            <div className="space-y-4">
              <div>
                <div className="flex justify-between">
                  <strong>v1.3.0</strong>
                  <span className="text-sm text-gray-500">15 —Ñ–µ–≤ 2026</span>
                </div>
                <ul className="text-sm ml-4 list-disc">
                  <li>–£–ª—É—á—à–µ–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞</li>
                  <li>–§–∏–∫—Å QR-—Å–∫–∞–Ω–µ—Ä–∞</li>
                </ul>
              </div>
              
              <div>
                <div className="flex justify-between">
                  <strong>v1.2.3</strong>
                  <span className="text-sm text-gray-500">1 —Ñ–µ–≤ 2026</span>
                </div>
                <ul className="text-sm ml-4 list-disc">
                  <li>–ü–µ—Ä–≤—ã–π —Ä–µ–ª–∏–∑</li>
                </ul>
              </div>
            </div>
          </AccordionContent>
        </AccordionItem>
      </Accordion>
    </div>
  </CardContent>
</Card>
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - –∞–¥–º–∏–Ω—É –Ω–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ** - updater —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ iiko
- ‚úÖ **–ö–æ–Ω—Ç—Ä–æ–ª—å** - –∞–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤–µ—Ä—Å–∏–∏ –Ω–∞ –≤—Å–µ—Ö –∫–∞—Å—Å–∞—Ö
- ‚úÖ **Changelog** - –ø–æ–Ω—è—Ç–Ω–æ —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

***

### **5. –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏**

**–í–û–ü–†–û–°:** –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞ —Å–ª–æ–º–∞–ª–∞ —á—Ç–æ-—Ç–æ. –ö–∞–∫ –±—ã—Å—Ç—Ä–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π backup + rollback**

```csharp
// –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é
private async Task DownloadAndInstallUpdate(string url)
{
    var pluginPath = GetPluginPath();
    var backupPath = pluginPath + ".backup";
    
    // 1. –ë—ç–∫–∞–ø–∏–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
    if (File.Exists(pluginPath))
    {
        File.Copy(pluginPath, backupPath, overwrite: true);
    }
    
    // 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—É—é
    var newDll = await apiClient.DownloadFileAsync(url);
    await File.WriteAllBytesAsync(pluginPath, newDll);
    
    // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    var updateInfo = new UpdateInfo
    {
        PreviousVersion = currentVersion,
        NewVersion = response.LatestVersion,
        UpdatedAt = DateTime.UtcNow,
        CanRollback = true
    };
    
    await SaveUpdateInfo(updateInfo);
}

// –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞–≥–∏–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
public class HealthCheckService
{
    public async Task PerformStartupHealthCheck()
    {
        try
        {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ backend
            await apiClient.PingAsync();
        }
        catch (Exception ex)
        {
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å - –≤–æ–∑–º–æ–∂–Ω–æ —Å–ª–æ–º–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
            var updateInfo = await LoadUpdateInfo();
            
            if (updateInfo.CanRollback && 
                DateTime.UtcNow - updateInfo.UpdatedAt < TimeSpan.FromDays(7))
            {
                var result = MessageBox.Show(
                    "–ü–ª–∞–≥–∏–Ω –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. " +
                    "–í–æ–∑–º–æ–∂–Ω–æ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–∞.\n\n" +
                    "–û—Ç–∫–∞—Ç–∏—Ç—å –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏?",
                    "–û—à–∏–±–∫–∞ –ø–ª–∞–≥–∏–Ω–∞",
                    MessageBoxButton.YesNo,
                    MessageBoxImage.Warning
                );
                
                if (result == MessageBoxResult.Yes)
                {
                    RollbackToBackup();
                    ShowRestartPrompt("–û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front.");
                }
            }
        }
    }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π backup –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–∞—Ç –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
- ‚úÖ –ó–¥–æ—Ä–æ–≤—å–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

***

## **üîê 2. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ò –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø (8 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **6. –ó–∞—â–∏—Ç–∞ API Key –≤ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–µ**

**–í–û–ü–†–û–°:** API Key –∑–∞—à–∏—Ç –≤ installer.exe. –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å –æ—Ç –¥–µ–∫–æ–º–ø–∏–ª—è—Ü–∏–∏?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –ú–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞**

```csharp
// 1. API Key –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ plaintext
// 2. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ AES-256 —Å machine-bound key
// 3. –û–±—Ñ—É—Å–∫–∞—Ü–∏—è –∫–æ–¥–∞ installer'–∞

public class SecureConfigStorage
{
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—à–∏–Ω—ã
    private static byte[] GetMachineKey()
    {
        var machineInfo = new StringBuilder();
        machineInfo.Append(Environment.MachineName);
        machineInfo.Append(Environment.ProcessorCount);
        machineInfo.Append(Environment.OSVersion.Platform);
        
        // –î–æ–±–∞–≤–ª—è–µ–º MAC address
        var mac = NetworkInterface.GetAllNetworkInterfaces()
            .FirstOrDefault()?
            .GetPhysicalAddress()
            .ToString();
        machineInfo.Append(mac);
        
        // –•–µ—à–∏—Ä—É–µ–º
        using var sha = SHA256.Create();
        return sha.ComputeHash(Encoding.UTF8.GetBytes(machineInfo.ToString()));
    }
    
    // –®–∏—Ñ—Ä—É–µ–º API Key –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
    public static void SaveEncryptedConfig(PluginConfig config)
    {
        var json = JsonConvert.SerializeObject(config);
        var jsonBytes = Encoding.UTF8.GetBytes(json);
        
        // AES-256 —Å machine-bound –∫–ª—é—á–æ–º
        using var aes = Aes.Create();
        aes.Key = GetMachineKey();
        aes.GenerateIV();
        
        using var encryptor = aes.CreateEncryptor();
        var encrypted = encryptor.TransformFinalBlock(jsonBytes, 0, jsonBytes.Length);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º IV + encrypted data
        var result = new byte[aes.IV.Length + encrypted.Length];
        Buffer.BlockCopy(aes.IV, 0, result, 0, aes.IV.Length);
        Buffer.BlockCopy(encrypted, 0, result, aes.IV.Length, encrypted.Length);
        
        File.WriteAllBytes(GetConfigPath(), result);
    }
}

// Backend: API Key –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞
// –û–Ω –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ:
// - –ß–∏—Ç–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ
// - –ò—Å–∫–∞—Ç—å –≥–æ—Å—Ç–µ–π –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É/QR
// - –í—ã–ø–æ–ª–Ω—è—Ç—å calculate –∏ apply –æ–ø–µ—Ä–∞—Ü–∏–∏
// –ù–ï –º–æ–∂–µ—Ç:
// - –°–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ–º–æ
// - –ú–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
// - –í–∏–¥–µ—Ç—å –¥—Ä—É–≥–∏—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ API Key –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω –∏ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –º–∞—à–∏–Ω–µ
- ‚úÖ –î–∞–∂–µ –µ—Å–ª–∏ –∏–∑–≤–ª–µ–∫—É—Ç - –Ω–µ —Å–º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–π –º–∞—à–∏–Ω–µ
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞ API Key –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—é—Ç —Ä–∏—Å–∫

***

### **7. –†–æ—Ç–∞—Ü–∏—è API Key**

**–í–û–ü–†–û–°:** API Key —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω (—É—Ç–µ—á–∫–∞). –ö–∞–∫ –±—ã—Å—Ç—Ä–æ –æ—Ç–æ–∑–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Instant revoke + grace period**

```typescript
// Admin Dashboard
<Button 
  variant="destructive" 
  onClick={handleRevokeApiKey}
>
  ‚ö†Ô∏è –û—Ç–æ–∑–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –ø–ª–∞–≥–∏–Ω–∞
</Button>

// Backend
async revokeApiKey(installationId: string) {
  // 1. –ü–æ–º–µ—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–ª—é—á –∫–∞–∫ revoked
  await this.prisma.iikoPluginInstallation.update({
    where: { id: installationId },
    data: {
      status: 'REVOKED',
      revokedAt: new Date(),
      revokedReason: 'Manual revocation by admin'
    }
  });
  
  // 2. –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Å —ç—Ç–∏–º API Key —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 401
  
  // 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π API Key
  const newApiKey = this.generateSecureApiKey();
  const newInstallation = await this.prisma.iikoPluginInstallation.create({
    data: {
      restaurantId: installation.restaurantId,
      tenantId: installation.tenantId,
      apiKey: await this.hashApiKey(newApiKey),
      status: 'PENDING'
    }
  });
  
  // 4. –ê–¥–º–∏–Ω —Å–∫–∞—á–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π installer —Å –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º
  return newInstallation;
}

// –ü–ª–∞–≥–∏–Ω –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–ª—É—á–∞–µ—Ç 401 ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
"‚ö†Ô∏è –î–æ—Å—Ç—É–ø –æ—Ç–æ–∑–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
–°–∫–∞—á–∞–π—Ç–µ –Ω–æ–≤—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.

[–û—Ç–∫—Ä—ã—Ç—å –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç]  [–ó–∞–∫—Ä—ã—Ç—å –ø–ª–∞–≥–∏–Ω]"
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π revoke (–±–µ–∑ wait)
- ‚úÖ –ü–æ–Ω—è—Ç–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫–∞—Å—Å–∏—Ä—É —á—Ç–æ –¥–µ–ª–∞—Ç—å
- ‚úÖ Audit trail –≤—Å–µ—Ö —Ä–æ—Ç–∞—Ü–∏–π

***

### **8. Rate limiting –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞**

**–í–û–ü–†–û–°:** –ó–∞—â–∏—Ç–∞ –æ—Ç abuse - –µ—Å–ª–∏ –ø–ª–∞–≥–∏–Ω –Ω–∞—á–Ω–µ—Ç —Å–ø–∞–º–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Per-installation rate limits**

```typescript
// Backend: —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π rate limit –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤
@UseGuards(IikoPluginRateLimitGuard)
@Post('calculate')
async calculate(@Body() dto: CalculateRequest) {
  // ...
}

// Rate limit guard
export class IikoPluginRateLimitGuard implements CanActivate {
  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const installation = request.installation; // –ò–∑ auth guard
    
    const key = `ratelimit:iiko:${installation.id}`;
    const limit = 100; // 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –Ω–∞ –æ–¥–Ω—É —É—Å—Ç–∞–Ω–æ–≤–∫—É
    
    const current = await this.redis.incr(key);
    
    if (current === 1) {
      await this.redis.expire(key, 60);
    }
    
    if (current > limit) {
      throw new TooManyRequestsException(
        'Rate limit exceeded. Please slow down.'
      );
    }
    
    return true;
  }
}
```

**–ü–ª–∞–≥–∏–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç rate limit error:**

```csharp
catch (HttpRequestException ex) when (ex.StatusCode == HttpStatusCode.TooManyRequests)
{
    MessageBox.Show(
        "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É.",
        "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤",
        MessageBoxButton.OK,
        MessageBoxImage.Warning
    );
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ó–∞—â–∏—Ç–∞ backend –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
- ‚úÖ Per-installation limits (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –¥—Ä—É–≥–∏—Ö)
- ‚úÖ –ü–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞—Å—Å–∏—Ä—É

***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ 32 –≤–æ–ø—Ä–æ—Å–∞–º–∏? –û–Ω–∏ –±—É–¥—É—Ç –æ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å:

- UI/UX –¥–ª—è –∫–∞—Å—Å–∏—Ä–∞ (8 –≤–æ–ø—Ä–æ—Å–æ–≤)
- –†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º (6 –≤–æ–ø—Ä–æ—Å–æ–≤)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å iiko API (8 –≤–æ–ø—Ä–æ—Å–æ–≤)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ offline —Ä–µ–∂–∏–º (6 –≤–æ–ø—Ä–æ—Å–æ–≤)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (4 –≤–æ–ø—Ä–æ—Å–∞)

<div align="center">‚ÅÇ</div>

[^14_1]: Beseda-9.md

[^14_2]: Beseda-7.md

[^14_3]: Beseda-6.md

[^14_4]: Beseda-8.md


---

## **üíª 3. UI/UX –î–õ–Ø –ö–ê–°–°–ò–†–ê (8 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **9. –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø–ª–∞–≥–∏–Ω –∏–∑ iiko Front**

**–í–û–ü–†–û–°:** –ö–∞–∫ –∫–∞—Å—Å–∏—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ –ø–ª–∞–≥–∏–Ω–∞ –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–∫–∞–∑–æ–º?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ö–Ω–æ–ø–∫–∞ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é iiko Front
- **B)** –ö–Ω–æ–ø–∫–∞ –≤ –ø–∞–Ω–µ–ª–∏ –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞
- **C)** –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞ (Ctrl+L)
- **D)** –ö–æ–º–±–æ: –∫–Ω–æ–ø–∫–∞ –≤ –ø–∞–Ω–µ–ª–∏ –æ–ø–ª–∞—Ç—ã + –≥–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) –ö–Ω–æ–ø–∫–∞ + –≥–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞**

```csharp
// Plugin.cs - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è UI —ç–ª–µ–º–µ–Ω—Ç–æ–≤
public class LoyaltyPlugin : IFrontPlugin
{
    public void InitializePlugin(IPluginContext context)
    {
        // 1. –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ Payment Screen
        context.Operations.RegisterPaymentScreenButton(
            buttonText: "üéÅ –õ–æ—è–ª—å–Ω–æ—Å—Ç—å",
            buttonHandler: OnLoyaltyButtonClick,
            tooltip: "–ù–∞—á–∏—Å–ª–∏—Ç—å/—Å–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (Ctrl+L)"
        );
        
        // 2. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≥–æ—Ä—è—á—É—é –∫–ª–∞–≤–∏—à—É
        context.Operations.RegisterHotKey(
            key: Key.L,
            modifiers: ModifierKeys.Control,
            handler: OnLoyaltyHotKeyPressed,
            description: "–û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏"
        );
    }
    
    private void OnLoyaltyButtonClick(IOrder order, IOperationService operations)
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–∫–∞–∑ –Ω–µ –ø—É—Å—Ç–æ–π
        if (order.Items.Count == 0)
        {
            operations.ShowMessage(
                "–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏",
                "–ü—É—Å—Ç–æ–π –∑–∞–∫–∞–∑"
            );
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–∫–∞–∑ –µ—â–µ –Ω–µ –æ–ø–ª–∞—á–µ–Ω
        if (order.Status == OrderStatus.Closed)
        {
            operations.ShowMessage(
                "–ù–µ–ª—å–∑—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –∫ –∑–∞–∫—Ä—ã—Ç–æ–º—É –∑–∞–∫–∞–∑—É",
                "–ó–∞–∫–∞–∑ –∑–∞–∫—Ä—ã—Ç"
            );
            return;
        }
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–ª–∞–≥–∏–Ω–∞
        var window = serviceProvider.GetRequiredService<LoyaltyWindow>();
        window.CurrentOrder = order;
        window.ShowDialog();
    }
}
```

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ iiko Front:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ iiko Front - –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –ó–∞–∫–∞–∑ #123                                      ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ –ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞    x1        500‚ÇΩ          ‚îÇ ‚îÇ
‚îÇ ‚îÇ Coca-Cola 0.5–ª     x2        200‚ÇΩ          ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ –ò–¢–û–ì–û: 700‚ÇΩ                                     ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
‚îÇ ‚îÇ üí≥ –û–ø–ª–∞—Ç–∏—Ç—å ‚îÇ  ‚îÇ üéÅ –õ–æ—è–ª—å–Ω–æ—Å—Ç—å‚îÇ ‚Üê –ù–ê–®–ê –ö–ù–û–ü–ö–ê‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ [Ctrl+L - –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏]              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ö–Ω–æ–ø–∫–∞ –Ω–∞ –≤–∏–¥—É - –∫–∞—Å—Å–∏—Ä –Ω–µ –∑–∞–±—É–¥–µ—Ç –ø—Ä–æ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞ - –¥–ª—è –æ–ø—ã—Ç–Ω—ã—Ö –∫–∞—Å—Å–∏—Ä–æ–≤ (–±—ã—Å—Ç—Ä–µ–µ)
- ‚úÖ Tooltip –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –≥–æ—Ä—è—á—É—é –∫–ª–∞–≤–∏—à—É
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–∫–∞–∑–∞ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –æ–∫–Ω–∞

***

### **10. Workflow –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è**

**–í–û–ü–†–û–°:** –ö–∞—Å—Å–∏—Ä –æ—Ç–∫—Ä—ã–ª –æ–∫–Ω–æ –ø–ª–∞–≥–∏–Ω–∞. –ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è –¥–æ—Å—Ç—É–ø–Ω—ã?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: 3 —Å–ø–æ—Å–æ–±–∞ –ø–æ–∏—Å–∫–∞**

```xaml
<!-- LoyaltyWindow.xaml -->
<Window Width="520" Height="720">
  <Grid>
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <StackPanel Background="#2563eb" Padding="20">
      <TextBlock Text="üéÅ –ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏" 
                 FontSize="20" 
                 Foreground="White" 
                 FontWeight="Bold"/>
      <TextBlock Text="–ù–∞–π–¥–∏—Ç–µ –≥–æ—Å—Ç—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É, QR-–∫–æ–¥—É –∏–ª–∏ –∫–∞—Ä—Ç–µ" 
                 FontSize="12" 
                 Foreground="White" 
                 Opacity="0.9"/>
    </StackPanel>
    
    <!-- –ü–æ–∏—Å–∫ -->
    <StackPanel Margin="20,100,20,0">
      <!-- –¢–∞–±—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –ø–æ–∏—Å–∫–∞ -->
      <TabControl>
        <!-- –í–∫–ª–∞–¥–∫–∞ 1: –¢–µ–ª–µ—Ñ–æ–Ω -->
        <TabItem Header="üì± –¢–µ–ª–µ—Ñ–æ–Ω">
          <StackPanel Margin="10">
            <TextBlock Text="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≥–æ—Å—Ç—è:" FontWeight="SemiBold"/>
            <TextBox x:Name="PhoneInput"
                     FontSize="18"
                     Height="45"
                     Margin="0,5,0,0"
                     Padding="10"
                     Text="+7 "
                     PreviewTextInput="OnPhoneInputPreview"
                     TextChanged="OnPhoneInputChanged"/>
            
            <TextBlock Text="–í–≤–µ–¥–∏—Ç–µ 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ +7" 
                       FontSize="11" 
                       Foreground="Gray"
                       Margin="0,3,0,0"/>
            
            <Button Content="üîç –ù–∞–π—Ç–∏ –≥–æ—Å—Ç—è"
                    Height="45"
                    Margin="0,15,0,0"
                    FontSize="16"
                    Click="OnSearchByPhone"
                    IsEnabled="{Binding IsPhoneValid}"/>
          </StackPanel>
        </TabItem>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ 2: QR-–∫–æ–¥ -->
        <TabItem Header="üì∑ QR-–∫–æ–¥">
          <StackPanel Margin="10">
            <TextBlock Text="–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Å –∫–∞—Ä—Ç—ã –≥–æ—Å—Ç—è" 
                       FontWeight="SemiBold"
                       TextWrapping="Wrap"/>
            
            <Border BorderBrush="#ddd" 
                    BorderThickness="2" 
                    CornerRadius="8"
                    Margin="0,15,0,0"
                    Padding="30"
                    Background="#f9fafb">
              <StackPanel HorizontalAlignment="Center">
                <Image Source="/Assets/qr-scanner.png" 
                       Width="120" 
                       Height="120"/>
                <TextBlock Text="–ü–æ–¥–Ω–µ—Å–∏—Ç–µ –∫–∞—Ä—Ç—É –∫ —Å–∫–∞–Ω–µ—Ä—É"
                           FontSize="14"
                           HorizontalAlignment="Center"
                           Margin="0,10,0,0"
                           Foreground="Gray"/>
              </StackPanel>
            </Border>
            
            <TextBlock Text="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é:" 
                       FontSize="12"
                       Margin="0,15,0,5"/>
            <TextBox x:Name="QRManualInput"
                     FontSize="16"
                     Height="40"
                     MaxLength="20"
                     TextChanged="OnQRManualInputChanged"/>
          </StackPanel>
        </TabItem>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ 3: 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ -->
        <TabItem Header="üî¢ –ö–æ–¥ –∫–∞—Ä—Ç—ã">
          <StackPanel Margin="10">
            <TextBlock Text="6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ —Å –∫–∞—Ä—Ç—ã –≥–æ—Å—Ç—è:" 
                       FontWeight="SemiBold"/>
            
            <TextBox x:Name="Code6Input"
                     FontSize="28"
                     Height="60"
                     Margin="0,10,0,0"
                     Padding="15"
                     MaxLength="6"
                     TextAlignment="Center"
                     FontFamily="Consolas"
                     PreviewTextInput="OnCode6InputPreview"
                     TextChanged="OnCode6InputChanged"/>
            
            <TextBlock Text="–ì–æ—Å—Ç—å –¥–∏–∫—Ç—É–µ—Ç 6 —Ü–∏—Ñ—Ä —Å –∫–∞—Ä—Ç—ã" 
                       FontSize="11" 
                       Foreground="Gray"
                       Margin="0,5,0,0"
                       TextAlignment="Center"/>
            
            <Button Content="üîç –ù–∞–π—Ç–∏"
                    Height="45"
                    Margin="0,15,0,0"
                    FontSize="16"
                    Click="OnSearchByCode6"
                    IsEnabled="{Binding IsCode6Valid}"/>
          </StackPanel>
        </TabItem>
      </TabControl>
    </StackPanel>
  </Grid>
</Window>
```

**Backend code:**

```csharp
// LoyaltyWindow.xaml.cs
public partial class LoyaltyWindow : Window
{
    private readonly LoyaltyApiClient apiClient;
    private readonly QRScannerService qrScanner;
    
    // –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
    private async void OnSearchByPhone(object sender, RoutedEventArgs e)
    {
        var phone = PhoneInput.Text.Trim();
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!IsValidPhone(phone))
        {
            ShowError("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞");
            return;
        }
        
        await SearchGuest(new SearchRequest { Phone = phone });
    }
    
    // –ü–æ–∏—Å–∫ –ø–æ QR
    protected override void OnActivated(EventArgs e)
    {
        base.OnActivated(e);
        
        // –ù–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å —Å–∫–∞–Ω–µ—Ä QR –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –æ–∫–Ω–∞
        qrScanner.OnScanned += OnQRScanned;
    }
    
    private async void OnQRScanned(string qrData)
    {
        // QR —Å–æ–¥–µ—Ä–∂–∏—Ç: "LOYALTY:CARD:{cardId}"
        if (qrData.StartsWith("LOYALTY:CARD:"))
        {
            var cardId = qrData.Replace("LOYALTY:CARD:", "");
            await SearchGuest(new SearchRequest { QRCode = qrData });
        }
        else
        {
            ShowError("–ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞—Ä—Ç—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏.");
        }
    }
    
    // –ü–æ–∏—Å–∫ –ø–æ 6-–∑–Ω–∞—á–Ω–æ–º—É –∫–æ–¥—É
    private async void OnSearchByCode6(object sender, RoutedEventArgs e)
    {
        var code = Code6Input.Text.Trim();
        
        if (code.Length != 6 || !code.All(char.IsDigit))
        {
            ShowError("–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 6 —Ü–∏—Ñ—Ä");
            return;
        }
        
        await SearchGuest(new SearchRequest { Code6Digit = code });
    }
    
    // –û–±—â–∏–π –º–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞
    private async Task SearchGuest(SearchRequest request)
    {
        try
        {
            LoadingOverlay.Visibility = Visibility.Visible;
            
            var response = await apiClient.SearchGuestAsync(request);
            
            if (response.Found)
            {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω —Å –±–∞–ª–∞–Ω—Å–æ–º
                ShowGuestBalance(response.Guest);
            }
            else
            {
                ShowError("–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –∫–∞—Ä—Ç—É –≤ —Å–∏—Å—Ç–µ–º–µ.");
            }
        }
        catch (HttpRequestException ex)
        {
            ShowError($"–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: {ex.Message}");
        }
        finally
        {
            LoadingOverlay.Visibility = Visibility.Collapsed;
        }
    }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **3 —Å–ø–æ—Å–æ–±–∞ –ø–æ–∏—Å–∫–∞** - —É–¥–æ–±–Ω–æ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π
- ‚úÖ **–¢–µ–ª–µ—Ñ–æ–Ω** - —Å–∞–º—ã–π —á–∞—Å—Ç—ã–π —Å–ª—É—á–∞–π (–≥–æ—Å—Ç—å –¥–∏–∫—Ç—É–µ—Ç)
- ‚úÖ **QR** - —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π (1 —Å–µ–∫—É–Ω–¥–∞)
- ‚úÖ **6-digit** - fallback –µ—Å–ª–∏ QR –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ **Tab UI** - –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

***

### **11. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥–æ—Å—Ç–µ**

**–í–û–ü–†–û–°:** –ì–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω. –ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Å—Å–∏—Ä—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –∫–ª—é—á–µ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π**

```xaml
<!-- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º -->
<Border BorderBrush="#10b981" 
        BorderThickness="2" 
        CornerRadius="12"
        Background="#f0fdf4"
        Padding="20"
        Margin="0,20,0,0">
  
  <StackPanel>
    <!-- –®–∞–ø–∫–∞ —Å –∞–≤–∞—Ç–∞—Ä–æ–º –∏ –∏–º–µ–Ω–µ–º -->
    <Grid>
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="Auto"/>
        <ColumnDefinition Width="*"/>
      </Grid.ColumnDefinitions>
      
      <!-- –ê–≤–∞—Ç–∞—Ä -->
      <Border Width="60" 
              Height="60" 
              CornerRadius="30"
              Background="#e5e7eb"
              VerticalAlignment="Top">
        <TextBlock Text="{Binding GuestInitials}" 
                   FontSize="24"
                   FontWeight="Bold"
                   Foreground="#6b7280"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"/>
      </Border>
      
      <!-- –ò–º—è –∏ —É—Ä–æ–≤–µ–Ω—å -->
      <StackPanel Grid.Column="1" Margin="15,0,0,0">
        <TextBlock Text="{Binding GuestName}" 
                   FontSize="18" 
                   FontWeight="Bold"/>
        
        <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
          <Border Background="#fbbf24" 
                  CornerRadius="4" 
                  Padding="8,3">
            <StackPanel Orientation="Horizontal">
              <TextBlock Text="‚≠ê" FontSize="12"/>
              <TextBlock Text="{Binding LevelName}" 
                         FontSize="12" 
                         FontWeight="SemiBold"
                         Foreground="White"
                         Margin="3,0,0,0"/>
            </StackPanel>
          </Border>
          
          <TextBlock Text="{Binding Phone}" 
                     FontSize="12"
                     Foreground="Gray"
                     Margin="10,0,0,0"
                     VerticalAlignment="Center"/>
        </StackPanel>
      </StackPanel>
    </Grid>
    
    <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
    <Separator Margin="0,15"/>
    
    <!-- –ë–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤ -->
    <Grid>
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*"/>
        <ColumnDefinition Width="*"/>
      </Grid.ColumnDefinitions>
      
      <StackPanel Grid.Column="0">
        <TextBlock Text="–ë–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤:" 
                   FontSize="12" 
                   Foreground="Gray"/>
        <TextBlock FontSize="28" 
                   FontWeight="Bold"
                   Foreground="#10b981">
          <Run Text="{Binding RegularBalance, StringFormat=N0}"/>
          <Run Text="‚ÇΩ" FontSize="20"/>
        </TextBlock>
      </StackPanel>
      
      <StackPanel Grid.Column="1" HorizontalAlignment="Right">
        <TextBlock Text="–ê–∫—Ü–∏–æ–Ω–Ω—ã–µ:" 
                   FontSize="12" 
                   Foreground="Gray"/>
        <TextBlock FontSize="24" 
                   FontWeight="SemiBold"
                   Foreground="#f59e0b">
          <Run Text="{Binding PromoBalance, StringFormat=N0}"/>
          <Run Text="‚ÇΩ" FontSize="16"/>
        </TextBlock>
      </StackPanel>
    </Grid>
    
    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
    <StackPanel Margin="0,15,0,0" 
                Visibility="{Binding HasNextLevel, Converter={StaticResource BoolToVisibility}}">
      <Grid>
        <TextBlock Text="–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è:" 
                   FontSize="11" 
                   Foreground="Gray"/>
        <TextBlock Text="{Binding NextLevelName}" 
                   FontSize="11" 
                   FontWeight="SemiBold"
                   HorizontalAlignment="Right"/>
      </Grid>
      
      <ProgressBar Value="{Binding LevelProgress}" 
                   Maximum="100"
                   Height="6"
                   Margin="0,5,0,0"
                   Foreground="#10b981"
                   Background="#e5e7eb"/>
      
      <TextBlock FontSize="10" 
                 Foreground="Gray"
                 Margin="0,2,0,0">
        <Run Text="–û—Å—Ç–∞–ª–æ—Å—å:"/>
        <Run Text="{Binding RemainingToNextLevel, StringFormat=N0}" FontWeight="SemiBold"/>
        <Run Text="‚ÇΩ"/>
      </TextBlock>
    </StackPanel>
  </StackPanel>
</Border>
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –í—Å—è –∫–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–∞ –æ–¥–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
- ‚úÖ –ö—Ä—É–ø–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ (–≥–ª–∞–≤–Ω–æ–µ –¥–ª—è –∫–∞—Å—Å–∏—Ä–∞)
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ regular/promo –±–∞–ª–ª–æ–≤
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –≥–æ—Å—Ç—è ("–µ—â–µ —á—É—Ç—å-—á—É—Ç—å!")

***

### **12. –†–∞—Å—á–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Å—Å–∏—Ä—É —Å–∫–æ–ª—å–∫–æ –±–∞–ª–ª–æ–≤ –º–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å —Å —Ç–µ–∫—É—â–µ–≥–æ —á–µ–∫–∞?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Pre-calculation –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ + live preview**

```csharp
// –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è –≤—ã–∑—ã–≤–∞–µ–º pre-calculation
private async Task ShowGuestBalance(GuestInfo guest)
{
    // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ—Å—Ç–µ
    GuestInfoPanel.DataContext = guest;
    GuestInfoPanel.Visibility = Visibility.Visible;
    
    // 2. –í—ã–∑—ã–≤–∞–µ–º pre-calculation –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–µ–∫–∞
    var checkAmount = CurrentOrder.GetTotalAmount();
    
    var calcResponse = await apiClient.CalculateAsync(new CalculateRequest
    {
        GuestCardId = guest.CardId,
        CheckAmount = checkAmount,
        CalculateOnly = true // –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ–º, —Ç–æ–ª—å–∫–æ —Å—á–∏—Ç–∞–µ–º
    });
    
    // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    MaxAllowedPoints.Text = $"{calcResponse.MaxAllowedToSpend:N0} ‚ÇΩ";
    MinCheckAmount.Text = $"{calcResponse.MinCheckAmount:N0} ‚ÇΩ";
    WillEarnPoints.Text = $"+{calcResponse.PointsToEarn:N0} –±–∞–ª–ª–æ–≤";
    
    // 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞
    PointsSlider.Maximum = calcResponse.MaxAllowedToSpend;
    PointsSlider.Value = 0; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ–º
}
```

**UI –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—É–º–º—ã —Å–ø–∏—Å–∞–Ω–∏—è:**

```xaml
<!-- –ë–ª–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤ -->
<Border BorderBrush="#ddd" 
        BorderThickness="1" 
        CornerRadius="8"
        Padding="15"
        Margin="0,20,0,0">
  
  <StackPanel>
    <TextBlock Text="–°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª–æ–≤" 
               FontSize="14" 
               FontWeight="SemiBold"/>
    
    <!-- –°—É–º–º–∞ —á–µ–∫–∞ -->
    <Grid Margin="0,10,0,0">
      <TextBlock Text="–°—É–º–º–∞ —á–µ–∫–∞:" Foreground="Gray"/>
      <TextBlock Text="{Binding CheckAmount, StringFormat='{}{0:N0} ‚ÇΩ'}" 
                 FontWeight="SemiBold"
                 HorizontalAlignment="Right"/>
    </Grid>
    
    <!-- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ -->
    <Grid Margin="0,5,0,0">
      <TextBlock Text="–î–æ—Å—Ç—É–ø–Ω–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é:" Foreground="Gray"/>
      <TextBlock Text="{Binding MaxAllowed, StringFormat='{}{0:N0} ‚ÇΩ'}" 
                 FontWeight="SemiBold"
                 Foreground="#10b981"
                 HorizontalAlignment="Right"/>
    </Grid>
    
    <Separator Margin="0,10"/>
    
    <!-- –°–ª–∞–π–¥–µ—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—É–º–º—ã -->
    <Grid>
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*"/>
        <ColumnDefinition Width="Auto"/>
      </Grid.ColumnDefinitions>
      
      <Slider x:Name="PointsSlider"
              Grid.Column="0"
              Minimum="0"
              Maximum="{Binding MaxAllowed}"
              TickFrequency="10"
              IsSnapToTickEnabled="True"
              ValueChanged="OnPointsSliderChanged"
              VerticalAlignment="Center"/>
      
      <Button Grid.Column="1"
              Content="–ú–∞–∫—Å"
              Width="60"
              Height="30"
              Margin="10,0,0,0"
              Click="OnMaxButtonClick"/>
    </Grid>
    
    <!-- –ö—Ä—É–ø–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—É–º–º—ã -->
    <Border Background="#eff6ff" 
            CornerRadius="8" 
            Padding="15"
            Margin="0,15,0,0">
      <StackPanel>
        <TextBlock Text="–ë—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–æ:" 
                   FontSize="12" 
                   Foreground="Gray"
                   HorizontalAlignment="Center"/>
        <TextBlock x:Name="SelectedPointsDisplay"
                   Text="0 ‚ÇΩ"
                   FontSize="36"
                   FontWeight="Bold"
                   Foreground="#2563eb"
                   HorizontalAlignment="Center"/>
      </StackPanel>
    </Border>
    
    <!-- –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç -->
    <Border Background="#f9fafb" 
            CornerRadius="8" 
            Padding="15"
            Margin="0,15,0,0">
      <StackPanel>
        <Grid>
          <TextBlock Text="–û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏:" Foreground="Gray"/>
          <TextBlock Text="{Binding SelectedPoints, StringFormat='-{0:N0} ‚ÇΩ'}" 
                     FontWeight="SemiBold"
                     Foreground="#dc2626"
                     HorizontalAlignment="Right"/>
        </Grid>
        
        <Grid Margin="0,5,0,0">
          <TextBlock Text="–ö –æ–ø–ª–∞—Ç–µ –∫–∞—Ä—Ç–æ–π/–Ω–∞–ª–∏—á–Ω—ã–º–∏:" FontWeight="SemiBold"/>
          <TextBlock Text="{Binding FinalAmount, StringFormat='{}{0:N0} ‚ÇΩ'}" 
                     FontSize="18"
                     FontWeight="Bold"
                     Foreground="#16a34a"
                     HorizontalAlignment="Right"/>
        </Grid>
        
        <Separator Margin="0,10"/>
        
        <Grid>
          <TextBlock Text="–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ:" Foreground="Gray" FontSize="12"/>
          <TextBlock FontSize="12" 
                     Foreground="#10b981"
                     HorizontalAlignment="Right">
            <Run Text="+"/>
            <Run Text="{Binding PointsToEarn, StringFormat=N0}" FontWeight="SemiBold"/>
            <Run Text="–±–∞–ª–ª–æ–≤"/>
          </TextBlock>
        </Grid>
      </StackPanel>
    </Border>
  </StackPanel>
</Border>
```

**Live preview –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ —Å–ª–∞–π–¥–µ—Ä–∞:**

```csharp
private void OnPointsSliderChanged(object sender, RoutedPropertyChangedEventArgs<double> e)
{
    var selectedPoints = (decimal)e.NewValue;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä—É–ø–Ω—ã–π –¥–∏—Å–ø–ª–µ–π
    SelectedPointsDisplay.Text = $"{selectedPoints:N0} ‚ÇΩ";
    
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
    var checkAmount = CurrentOrder.GetTotalAmount();
    var finalAmount = checkAmount - selectedPoints;
    
    FinalAmountDisplay.Text = $"{finalAmount:N0} ‚ÇΩ";
    
    // –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –æ—Ç –ò–°–•–û–î–ù–û–ô —Å—É–º–º—ã (–Ω–µ –æ—Ç finalAmount!)
    var pointsToEarn = (int)(checkAmount * CurrentCalculation.EarnPercentage / 100);
    PointsToEarnDisplay.Text = $"+{pointsToEarn:N0} –±–∞–ª–ª–æ–≤";
}

private void OnMaxButtonClick(object sender, RoutedEventArgs e)
{
    PointsSlider.Value = PointsSlider.Maximum;
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **Pre-calculation** - –∫–∞—Å—Å–∏—Ä —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç –ª–∏–º–∏—Ç—ã
- ‚úÖ **–°–ª–∞–π–¥–µ—Ä** - –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä —Å—É–º–º—ã
- ‚úÖ **Live preview** - –≤–∏–¥–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ **–ö—Ä—É–ø–Ω—ã–µ —Ü–∏—Ñ—Ä—ã** - –≥–ª–∞–≤–Ω–æ–µ –Ω–∞ –≤–∏–¥—É
- ‚úÖ **–ö–Ω–æ–ø–∫–∞ "–ú–∞–∫—Å"** - –±—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –º–∞–∫—Å–∏–º—É–º–∞

***

### **13. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ**

**–í–û–ü–†–û–°:** –ö–∞—Å—Å–∏—Ä –≤—ã–±—Ä–∞–ª —Å—É–º–º—É —Å–ø–∏—Å–∞–Ω–∏—è. –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –∑–∞–∫–∞–∑—É?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è**

```xaml
<!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
<Grid Margin="0,20,0,0">
  <Grid.ColumnDefinitions>
    <ColumnDefinition Width="*"/>
    <ColumnDefinition Width="*"/>
  </Grid.ColumnDefinitions>
  
  <Button Grid.Column="0"
          Content="–û—Ç–º–µ–Ω–∞"
          Height="50"
          Margin="0,0,5,0"
          Click="OnCancelClick"
          Style="{StaticResource OutlineButton}"/>
  
  <Button Grid.Column="1"
          Content="‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å"
          Height="50"
          Margin="5,0,0,0"
          Click="OnApplyClick"
          IsEnabled="{Binding HasSelectedPoints}"
          Style="{StaticResource PrimaryButton}"/>
</Grid>
```

**Backend –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:**

```csharp
private async void OnApplyClick(object sender, RoutedEventArgs e)
{
    var selectedPoints = (decimal)PointsSlider.Value;
    
    if (selectedPoints <= 0)
    {
        ShowError("–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è");
        return;
    }
    
    // –§–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    var confirmation = MessageBox.Show(
        $"–°–ø–∏—Å–∞—Ç—å {selectedPoints:N0} –±–∞–ª–ª–æ–≤ —Å –∫–∞—Ä—Ç—ã –≥–æ—Å—Ç—è?\n\n" +
        $"–ì–æ—Å—Ç—å: {currentGuest.Name}\n" +
        $"–ö –æ–ø–ª–∞—Ç–µ: {(checkAmount - selectedPoints):N0} ‚ÇΩ\n" +
        $"–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +{pointsToEarn} –±–∞–ª–ª–æ–≤",
        "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
        MessageBoxButton.YesNo,
        MessageBoxImage.Question
    );
    
    if (confirmation != MessageBoxResult.Yes)
        return;
    
    try
    {
        LoadingOverlay.Visibility = Visibility.Visible;
        ApplyButton.IsEnabled = false;
        
        // –í—ã–∑—ã–≤–∞–µ–º backend API
        var response = await apiClient.ApplyLoyaltyAsync(new ApplyRequest
        {
            GuestCardId = currentGuest.CardId,
            CheckAmount = checkAmount,
            PointsToSpend = selectedPoints,
            OrderId = CurrentOrder.Id.ToString(),
            CashierName = PluginContext.GetCurrentCashier().Name
        });
        
        if (response.Success)
        {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É –≤ iiko
            var discount = iikoOperations.CreateDiscount(
                description: $"–ë–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ -{selectedPoints:N0}‚ÇΩ",
                amount: selectedPoints,
                guest: null
            );
            
            iikoOperations.AddDiscount(discount, CurrentOrder);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º success
            ShowSuccessMessage(
                $"‚úì –ë–∞–ª–ª—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!\n\n" +
                $"–°–ø–∏—Å–∞–Ω–æ: {selectedPoints:N0} –±–∞–ª–ª–æ–≤\n" +
                $"–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {response.NewBalance:N0} –±–∞–ª–ª–æ–≤\n" +
                $"–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +{response.PointsEarned} –±–∞–ª–ª–æ–≤ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã"
            );
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
            this.DialogResult = true;
            this.Close();
        }
        else
        {
            ShowError($"–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è: {response.Error}");
        }
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Failed to apply loyalty");
        ShowError($"–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: {ex.Message}");
    }
    finally
    {
        LoadingOverlay.Visibility = Visibility.Collapsed;
        ApplyButton.IsEnabled = true;
    }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞)
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
- ‚úÖ Success message —Å –∏—Ç–æ–≥–æ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º
- ‚úÖ –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞

***

### **14. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è (–±–µ–∑ —Å–ø–∏—Å–∞–Ω–∏—è)**

**–í–û–ü–†–û–°:** –ì–æ—Å—Ç—å —Ö–æ—á–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã, –Ω–µ —Å–ø–∏—Å—ã–≤–∞—Ç—å. –ö–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –û–ø—Ü–∏—è "–¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ"**

```xaml
<!-- –î–æ–±–∞–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å -->
<CheckBox x:Name="OnlyEarnCheckbox"
          Content="–¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã (–Ω–µ —Å–ø–∏—Å—ã–≤–∞—Ç—å)"
          Margin="0,15,0,0"
          Checked="OnOnlyEarnChecked"
          Unchecked="OnOnlyEarnUnchecked"/>
```

```csharp
private void OnOnlyEarnChecked(object sender, RoutedEventArgs e)
{
    // –û—Ç–∫–ª—é—á–∞–µ–º —Å–ª–∞–π–¥–µ—Ä —Å–ø–∏—Å–∞–Ω–∏—è
    PointsSlider.IsEnabled = false;
    PointsSlider.Value = 0;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏
    SpendingPanel.Visibility = Visibility.Collapsed;
    EarningPanel.Visibility = Visibility.Visible;
}

private async void OnApplyClick(object sender, RoutedEventArgs e)
{
    if (OnlyEarnCheckbox.IsChecked == true)
    {
        // –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ (–±–µ–∑ —Å–ø–∏—Å–∞–Ω–∏—è)
        var response = await apiClient.ApplyLoyaltyAsync(new ApplyRequest
        {
            GuestCardId = currentGuest.CardId,
            CheckAmount = checkAmount,
            PointsToSpend = 0, // –ù–µ —Å–ø–∏—Å—ã–≤–∞–µ–º
            OrderId = CurrentOrder.Id.ToString()
        });
        
        // –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É –≤ iiko, –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
        ShowSuccessMessage($"‚úì –ö–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –∑–∞–∫–∞–∑—É!\n\n–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +{response.PointsEarned} –±–∞–ª–ª–æ–≤ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã");
        this.Close();
    }
    else
    {
        // –û–±—ã—á–Ω—ã–π —Ñ–ª–æ—É —Å–æ —Å–ø–∏—Å–∞–Ω–∏–µ–º
        // ...
    }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å - –≥–æ—Å—Ç—å –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
- ‚úÖ –ü—Ä–æ—Å—Ç–æ–π UI - –æ–¥–∏–Ω —á–µ–∫–±–æ–∫—Å
- ‚úÖ –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ

***

### **15. –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –≥–æ—Å—Ç—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**

**–í–û–ü–†–û–°:** –ù—É–∂–Ω–∞ –ª–∏ –∫–∞—Å—Å–∏—Ä—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π –≥–æ—Å—Ç—è?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–µ—Ç, –Ω–µ –Ω—É–∂–Ω–∞ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π UI)
- **B)** –î–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –æ–ø–µ—Ä–∞—Ü–∏–π
- **C)** –î–∞, –æ—Ç–¥–µ–ª—å–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ —Å –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π
- **D)** –î–∞, –∫–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é" ‚Üí –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: B) –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –æ–ø–µ—Ä–∞—Ü–∏–π (–∫–æ–º–ø–∞–∫—Ç–Ω–æ)**

```xaml
<!-- –î–æ–±–∞–≤–ª—è–µ–º expander –ø–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≥–æ—Å—Ç–µ -->
<Expander Header="üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏" 
          Margin="0,10,0,0"
          IsExpanded="False">
  <ItemsControl ItemsSource="{Binding RecentTransactions}">
    <ItemsControl.ItemTemplate>
      <DataTemplate>
        <Border BorderBrush="#e5e7eb" 
                BorderThickness="0,0,0,1" 
                Padding="0,8">
          <Grid>
            <StackPanel>
              <TextBlock Text="{Binding Date, StringFormat='dd.MM.yyyy HH:mm'}" 
                         FontSize="11" 
                         Foreground="Gray"/>
              <TextBlock Text="{Binding Description}" 
                         FontSize="13"/>
            </StackPanel>
            
            <TextBlock Text="{Binding AmountFormatted}" 
                       FontSize="14"
                       FontWeight="SemiBold"
                       Foreground="{Binding AmountColor}"
                       HorizontalAlignment="Right"
                       VerticalAlignment="Center"/>
          </Grid>
        </Border>
      </DataTemplate>
    </ItemsControl.ItemTemplate>
  </ItemsControl>
</Expander>
```

```csharp
// –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≥–æ—Å—Ç—è
private async Task ShowGuestBalance(GuestInfo guest)
{
    // ... –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å ...
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –æ–ø–µ—Ä–∞—Ü–∏–π
    var transactions = await apiClient.GetRecentTransactionsAsync(guest.CardId, limit: 5);
    
    RecentTransactionsPanel.ItemsSource = transactions.Select(t => new
    {
        Date = t.CreatedAt,
        Description = FormatTransactionDescription(t),
        AmountFormatted = FormatAmount(t.Amount),
        AmountColor = t.Amount > 0 ? "#10b981" : "#dc2626"
    });
}

private string FormatTransactionDescription(Transaction t)
{
    return t.Type switch
    {
        "EARN" => $"–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞ –ø–æ–∫—É–ø–∫—É {t.CheckAmount:N0}‚ÇΩ",
        "SPEND" => $"–°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤",
        "PROMO" => $"–ê–∫—Ü–∏—è: {t.PromoName}",
        "MANUAL" => $"–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞",
        "BURN" => $"–°–≥–æ—Ä–∞–Ω–∏–µ –∑–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
        _ => t.Type
    };
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ—Ç UI (—Å–≤–µ—Ä–Ω—É—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- ‚úÖ –ü–æ–º–æ–≥–∞–µ—Ç –∫–∞—Å—Å–∏—Ä—É –µ—Å–ª–∏ –≥–æ—Å—Ç—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –±–∞–ª–∞–Ω—Å
- ‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –æ–ø–µ—Ä–∞—Ü–∏–π –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

***

### **16. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è –∏–∑ –ø–ª–∞–≥–∏–Ω–∞**

**–í–û–ü–†–û–°:** –ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ú–æ–∂–Ω–æ –ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –ø—Ä—è–º–æ –≤ –ø–ª–∞–≥–∏–Ω–µ?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–µ—Ç, –∫–∞—Å—Å–∏—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ—Å—Ç—è –Ω–∞ —Å–∞–π—Ç/Telegram
- **B)** –î–∞, –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ (—Ç–µ–ª–µ—Ñ–æ–Ω + –∏–º—è)
- **C)** –î–∞, –ø–æ–ª–Ω–∞—è —Ñ–æ—Ä–º–∞ (—Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º—è, email, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è)
- **D)** –î–∞, –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ + –æ–ø—Ü–∏—è "–∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∑–∂–µ"

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ + promo –ø–æ—Å–ª–µ**

```xaml
<!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –≥–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω -->
<Border BorderBrush="#f59e0b" 
        BorderThickness="2" 
        CornerRadius="8"
        Background="#fffbeb"
        Padding="20"
        Margin="0,20,0,0"
        Visibility="{Binding GuestNotFound, Converter={StaticResource BoolToVisibility}}">
  
  <StackPanel>
    <StackPanel Orientation="Horizontal">
      <TextBlock Text="‚ö†Ô∏è" FontSize="24" Margin="0,0,10,0"/>
      <StackPanel>
        <TextBlock Text="–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω" 
                   FontSize="16" 
                   FontWeight="Bold"/>
        <TextBlock Text="–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏" 
                   FontSize="12" 
                   Foreground="Gray"/>
      </StackPanel>
    </StackPanel>
    
    <Separator Margin="0,15"/>
    
    <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <TextBlock Text="–¢–µ–ª–µ—Ñ–æ–Ω –≥–æ—Å—Ç—è:" FontWeight="SemiBold" Margin="0,10,0,5"/>
    <TextBox x:Name="NewGuestPhone"
             Text="{Binding SearchedPhone, Mode=OneWay}"
             FontSize="16"
             Height="40"
             IsReadOnly="True"
             Background="#f3f4f6"/>
    
    <TextBlock Text="–ò–º—è –≥–æ—Å—Ç—è:" FontWeight="SemiBold" Margin="0,15,0,5"/>
    <TextBox x:Name="NewGuestName"
             FontSize="16"
             Height="40"
             Placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è"/>
    
    <TextBlock Text="Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):" FontWeight="SemiBold" Margin="0,15,0,5"/>
    <TextBox x:Name="NewGuestEmail"
             FontSize="14"
             Height="40"
             Placeholder="guest@example.com"/>
    
    <CheckBox Content="–û—Ç–ø—Ä–∞–≤–∏—Ç—å SMS —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º –∏ —Å—Å—ã–ª–∫–æ–π –Ω–∞ Telegram –±–æ—Ç"
              Margin="0,15,0,0"
              IsChecked="True"/>
    
    <Button Content="‚úì –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
            Height="45"
            Margin="0,20,0,0"
            Click="OnRegisterNewGuest"
            IsEnabled="{Binding IsNewGuestFormValid}"/>
  </StackPanel>
</Border>
```

```csharp
private async void OnRegisterNewGuest(object sender, RoutedEventArgs e)
{
    var phone = NewGuestPhone.Text.Trim();
    var name = NewGuestName.Text.Trim();
    var email = NewGuestEmail.Text.Trim();
    
    if (string.IsNullOrEmpty(name))
    {
        ShowError("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –≥–æ—Å—Ç—è");
        return;
    }
    
    try
    {
        LoadingOverlay.Visibility = Visibility.Visible;
        
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ API
        var response = await apiClient.RegisterGuestAsync(new RegisterGuestRequest
        {
            Phone = phone,
            FirstName = name,
            Email = string.IsNullOrEmpty(email) ? null : email,
            RegistrationSource = "CASHIER",
            RestaurantId = ConfigManager.GetRestaurantId(),
            SendWelcomeSMS = true
        });
        
        if (response.Success)
        {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
            ShowSuccessMessage(
                $"‚úì –ì–æ—Å—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!\n\n" +
                $"–ö–∞—Ä—Ç–∞ #{response.CardNumber}\n" +
                $"–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: {response.InitialBonus} –±–∞–ª–ª–æ–≤"
            );
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
            await ShowGuestBalance(response.Guest);
        }
        else
        {
            ShowError($"–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {response.Error}");
        }
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Failed to register guest");
        ShowError($"–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: {ex.Message}");
    }
    finally
    {
        LoadingOverlay.Visibility = Visibility.Collapsed;
    }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–æ–ª—è (—Ç–µ–ª–µ—Ñ–æ–Ω + –∏–º—è) - –±—ã—Å—Ç—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- ‚úÖ Email –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–≥–æ—Å—Ç—å –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ SMS –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ Telegram –±–æ—Ç
- ‚úÖ –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è–µ–º –ª–æ—è–ª—å–Ω–æ—Å—Ç—å

***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ 24 –≤–æ–ø—Ä–æ—Å–∞–º–∏? –û–Ω–∏ –±—É–¥—É—Ç –æ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å:

- –†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º (6 –≤–æ–ø—Ä–æ—Å–æ–≤)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å iiko API (8 –≤–æ–ø—Ä–æ—Å–æ–≤)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ offline —Ä–µ–∂–∏–º (6 –≤–æ–ø—Ä–æ—Å–æ–≤)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (4 –≤–æ–ø—Ä–æ—Å–∞)

---

## **üíæ 4. –†–ê–ë–û–¢–ê –° –î–ê–ù–ù–´–ú–ò –ò –ö–ï–®–ò–†–û–í–ê–ù–ò–ï–ú (6 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **17. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Å—Ç–µ–π**

**–í–û–ü–†–û–°:** –ö–∞—Å—Å–∏—Ä –∏—â–µ—Ç –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –≥–æ—Å—Ç—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∑–∞ —Å–º–µ–Ω—É. –ù—É–∂–Ω–æ –ª–∏ –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–µ—Ç, –≤—Å–µ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å backend (–≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ)
- **B)** –î–∞, –∫–µ—à–∏—Ä—É–µ–º –Ω–∞ 5 –º–∏–Ω—É—Ç –≤ –ø–∞–º—è—Ç–∏
- **C)** –î–∞, –∫–µ—à–∏—Ä—É–µ–º –Ω–∞ 30 –º–∏–Ω—É—Ç + invalidate –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
- **D)** –î–∞, –∫–µ—à–∏—Ä—É–µ–º –≤–µ—Å—å –¥–µ–Ω—å (–¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã)

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) 30 –º–∏–Ω—É—Ç —Å invalidation**

```csharp
// CacheService.cs
public class CacheService
{
    private readonly MemoryCache cache;
    private readonly TimeSpan defaultExpiration = TimeSpan.FromMinutes(30);
    
    public CacheService()
    {
        cache = new MemoryCache(new MemoryCacheOptions
        {
            SizeLimit = 1000 // –ú–∞–∫—Å–∏–º—É–º 1000 –∑–∞–ø–∏—Å–µ–π
        });
    }
    
    // –ö–µ—à–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ—Å—Ç–µ
    public async Task<GuestInfo> GetOrFetchGuestAsync(
        string key, 
        Func<Task<GuestInfo>> fetchFunc)
    {
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫–µ—à–∞
        if (cache.TryGetValue(key, out GuestInfo cachedGuest))
        {
            logger.LogDebug("Cache hit for guest {Key}", key);
            return cachedGuest;
        }
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –≤ –∫–µ—à–µ - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º
        logger.LogDebug("Cache miss for guest {Key}, fetching from API", key);
        var guest = await fetchFunc();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
        var cacheOptions = new MemoryCacheEntryOptions()
            .SetSize(1)
            .SetSlidingExpiration(defaultExpiration)
            .RegisterPostEvictionCallback((key, value, reason, state) =>
            {
                logger.LogDebug("Guest {Key} evicted from cache. Reason: {Reason}", key, reason);
            });
        
        cache.Set(key, guest, cacheOptions);
        
        return guest;
    }
    
    // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
    public void InvalidateGuest(string guestId)
    {
        var keys = new[]
        {
            $"guest:id:{guestId}",
            $"guest:phone:{GetPhoneFromCache(guestId)}",
            $"guest:qr:{GetQRFromCache(guestId)}",
            $"guest:code6:{GetCode6FromCache(guestId)}"
        };
        
        foreach (var key in keys)
        {
            cache.Remove(key);
        }
        
        logger.LogDebug("Invalidated cache for guest {GuestId}", guestId);
    }
    
    // –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã
    public void ClearAll()
    {
        cache.Clear();
        logger.LogInformation("Cache cleared");
    }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –ø–æ–∏—Å–∫–µ:**

```csharp
// LoyaltyApiClient.cs
public async Task<SearchGuestResponse> SearchGuestAsync(SearchRequest request)
{
    // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª—é—á –∫–µ—à–∞
    var cacheKey = request.Phone != null 
        ? $"guest:phone:{request.Phone}"
        : request.QRCode != null
        ? $"guest:qr:{request.QRCode}"
        : $"guest:code6:{request.Code6Digit}";
    
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫–µ—à–∞
    var guest = await cacheService.GetOrFetchGuestAsync(cacheKey, async () =>
    {
        // –ï—Å–ª–∏ –Ω–µ—Ç –≤ –∫–µ—à–µ - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å backend
        var response = await httpClient.PostAsJsonAsync("/api/loyalty/search-guest", request);
        response.EnsureSuccessStatusCode();
        
        var result = await response.Content.ReadFromJsonAsync<SearchGuestResponse>();
        return result.Guest;
    });
    
    return new SearchGuestResponse
    {
        Found = guest != null,
        Guest = guest
    };
}

// –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º
public async Task<ApplyLoyaltyResponse> ApplyLoyaltyAsync(ApplyRequest request)
{
    var response = await httpClient.PostAsJsonAsync("/api/loyalty/apply", request);
    response.EnsureSuccessStatusCode();
    
    var result = await response.Content.ReadFromJsonAsync<ApplyLoyaltyResponse>();
    
    // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à (–±–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω–∏–ª—Å—è)
    cacheService.InvalidateGuest(request.GuestCardId);
    
    return result;
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **30 –º–∏–Ω—É—Ç** - –±–∞–ª–∞–Ω—Å –≤—Ä—è–¥ –ª–∏ –∏–∑–º–µ–Ω–∏—Ç—Å—è –∑–∞ —ç—Ç–æ –≤—Ä–µ–º—è
- ‚úÖ **Invalidation** - –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–∞–∑—É
- ‚úÖ **Sliding expiration** - –µ—Å–ª–∏ –≥–æ—Å—Ç—è –∏—â—É—Ç —á–∞—Å—Ç–æ, –∫–µ—à –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è
- ‚úÖ **–≠–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞** - –º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ backend

***

### **18. Prefetch –¥–∞–Ω–Ω—ã—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞**

**–í–û–ü–†–û–°:** –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ (–ø—Ä–∞–≤–∏–ª–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏, –ª–∏–º–∏—Ç—ã) –Ω—É–∂–Ω—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏. –ö–∞–∫ –∏—Ö –∑–∞–≥—Ä—É–∂–∞—Ç—å?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ + –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**

```csharp
// Plugin.cs
public class LoyaltyPlugin : IFrontPlugin
{
    private Timer configRefreshTimer;
    private RestaurantConfig restaurantConfig;
    
    public async void InitializePlugin(IPluginContext context)
    {
        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø–ª–∞–≥–∏–Ω–∞
        try
        {
            restaurantConfig = await apiClient.GetRestaurantConfigAsync();
            logger.LogInformation("Restaurant config loaded: {RestaurantName}", restaurantConfig.Name);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to load restaurant config");
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É iiko
            context.Operations.ShowMessage(
                "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞–≥–∏–Ω–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.",
                "–û—à–∏–±–∫–∞ –ø–ª–∞–≥–∏–Ω–∞"
            );
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ backup
            restaurantConfig = LoadBackupConfig();
        }
        
        // 2. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        configRefreshTimer = new Timer(
            callback: async _ => await RefreshConfig(),
            state: null,
            dueTime: TimeSpan.FromMinutes(5),
            period: TimeSpan.FromMinutes(5)
        );
    }
    
    private async Task RefreshConfig()
    {
        try
        {
            var newConfig = await apiClient.GetRestaurantConfigAsync();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            if (!ConfigEquals(restaurantConfig, newConfig))
            {
                logger.LogInformation("Restaurant config updated");
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º backup
                SaveBackupConfig(newConfig);
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                restaurantConfig = newConfig;
                
                // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à (–ø—Ä–∞–≤–∏–ª–∞ –º–æ–≥–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è)
                cacheService.ClearAll();
            }
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to refresh config, using cached version");
        }
    }
    
    private void SaveBackupConfig(RestaurantConfig config)
    {
        var json = JsonConvert.SerializeObject(config);
        var path = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "LoyaltyPluginIiko",
            "config-backup.json"
        );
        File.WriteAllText(path, json);
    }
}

// RestaurantConfig.cs
public class RestaurantConfig
{
    public string RestaurantId { get; set; }
    public string RestaurantName { get; set; }
    public string TenantId { get; set; }
    
    // –ü—Ä–∞–≤–∏–ª–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
    public decimal MinCheckAmount { get; set; } // 50‚ÇΩ
    public decimal MaxSpendPercentage { get; set; } // 20%
    public bool AllowGuestRegistration { get; set; } // true
    
    // –ü—Ä–æ–º–æ (–µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã —Å–µ–π—á–∞—Å)
    public List<ActivePromo> ActivePromos { get; set; }
    
    // Feature flags
    public bool EnableQRScanner { get; set; }
    public bool EnableGuestHistory { get; set; }
    public bool SendWelcomeSMS { get; set; }
    
    public DateTime LoadedAt { get; set; }
}
```

**Backend endpoint:**

```typescript
// apps/backend/src/pos-integration/iiko-plugin.controller.ts
@Get('config')
@UseGuards(IikoPluginAuthGuard)
async getRestaurantConfig(@CurrentInstallation() installation: IikoPluginInstallation) {
  const restaurant = await this.restaurantService.findOne(installation.restaurantId);
  const loyaltySystem = await this.loyaltyService.getActiveSystem(restaurant.tenantId);
  
  return {
    restaurantId: restaurant.id,
    restaurantName: restaurant.name,
    tenantId: restaurant.tenantId,
    minCheckAmount: loyaltySystem.minCheckAmount,
    maxSpendPercentage: loyaltySystem.maxSpendPercentage,
    allowGuestRegistration: restaurant.settings.allowCashierRegistration,
    activePromos: await this.promoService.getActivePromos(restaurant.id),
    enableQRScanner: restaurant.settings.qrScannerEnabled,
    enableGuestHistory: true,
    sendWelcomeSMS: restaurant.settings.sendWelcomeSMS,
    loadedAt: new Date()
  };
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ** - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É
- ‚úÖ **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
- ‚úÖ **Backup** - —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- ‚úÖ **Cache invalidation** - –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª –æ—á–∏—â–∞–µ–º –∫–µ—à

***

### **19. –õ–æ–∫–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è**

**–í–û–ü–†–û–°:** –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ø—Ä–æ–ø–∞–ª –Ω–∞ –∫–∞—Å—Å–µ. –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É –ø–ª–∞–≥–∏–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é
- **B)** –†–∞–±–æ—Ç–∞—Ç—å –≤ read-only —Ä–µ–∂–∏–º–µ (—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä –±–∞–ª–∞–Ω—Å–∞ –∏–∑ –∫–µ—à–∞)
- **C)** –°–æ—Ö—Ä–∞–Ω—è—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
- **D)** –†–∞–∑—Ä–µ—à–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ (–±–µ–∑ —Å–ø–∏—Å–∞–Ω–∏—è)

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –õ–æ–∫–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏**

```csharp
// OfflineQueueService.cs
public class OfflineQueueService
{
    private readonly string queuePath;
    private readonly object lockObj = new object();
    
    public OfflineQueueService()
    {
        queuePath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "LoyaltyPluginIiko",
            "offline-queue.json"
        );
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –≤ –æ—á–µ—Ä–µ–¥—å
    public void EnqueueOperation(OfflineOperation operation)
    {
        lock (lockObj)
        {
            var queue = LoadQueue();
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ (–º–∞–∫—Å–∏–º—É–º 100 –æ–ø–µ—Ä–∞—Ü–∏–π)
            if (queue.Count >= 100)
            {
                throw new InvalidOperationException("Offline queue is full");
            }
            
            operation.QueuedAt = DateTime.UtcNow;
            queue.Add(operation);
            
            SaveQueue(queue);
            logger.LogWarning("Operation queued for offline processing: {OperationType}", operation.Type);
        }
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    public async Task ProcessQueueAsync(LoyaltyApiClient apiClient)
    {
        lock (lockObj)
        {
            var queue = LoadQueue();
            
            if (queue.Count == 0)
                return;
            
            logger.LogInformation("Processing offline queue: {Count} operations", queue.Count);
            
            var processed = new List<OfflineOperation>();
            var failed = new List<OfflineOperation>();
            
            foreach (var operation in queue)
            {
                try
                {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ —É—Å—Ç–∞—Ä–µ–ª–∞ (–º–∞–∫—Å–∏–º—É–º 24 —á–∞—Å–∞)
                    if (DateTime.UtcNow - operation.QueuedAt > TimeSpan.FromHours(24))
                    {
                        logger.LogWarning("Operation expired: {OperationId}", operation.Id);
                        failed.Add(operation);
                        continue;
                    }
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend
                    await apiClient.ApplyLoyaltyAsync(operation.Request);
                    
                    processed.Add(operation);
                    logger.LogInformation("Offline operation processed: {OperationId}", operation.Id);
                }
                catch (Exception ex)
                {
                    logger.LogError(ex, "Failed to process offline operation: {OperationId}", operation.Id);
                    failed.Add(operation);
                }
            }
            
            // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ
            queue.RemoveAll(op => processed.Contains(op));
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ (—á—Ç–æ–±—ã –Ω–µ –∫–æ–ø–∏–ª–∏—Å—å)
            queue.RemoveAll(op => failed.Contains(op));
            
            SaveQueue(queue);
            
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –∫–∞—Å—Å–∏—Ä–∞
            if (processed.Count > 0)
            {
                MessageBox.Show(
                    $"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {processed.Count} –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –æ—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞",
                    "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
                    MessageBoxButton.OK,
                    MessageBoxImage.Information
                );
            }
        }
    }
    
    private List<OfflineOperation> LoadQueue()
    {
        if (!File.Exists(queuePath))
            return new List<OfflineOperation>();
        
        var json = File.ReadAllText(queuePath);
        return JsonConvert.DeserializeObject<List<OfflineOperation>>(json);
    }
    
    private void SaveQueue(List<OfflineOperation> queue)
    {
        var json = JsonConvert.SerializeObject(queue, Formatting.Indented);
        File.WriteAllText(queuePath, json);
    }
}

public class OfflineOperation
{
    public string Id { get; set; } = Guid.NewGuid().ToString();
    public string Type { get; set; } // "APPLY_LOYALTY"
    public ApplyRequest Request { get; set; }
    public DateTime QueuedAt { get; set; }
}
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ UI:**

```csharp
// LoyaltyApiClient.cs
public async Task<ApplyLoyaltyResponse> ApplyLoyaltyAsync(ApplyRequest request)
{
    try
    {
        // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ backend
        var response = await httpClient.PostAsJsonAsync("/api/loyalty/apply", request);
        response.EnsureSuccessStatusCode();
        
        return await response.Content.ReadFromJsonAsync<ApplyLoyaltyResponse>();
    }
    catch (HttpRequestException ex) when (IsNetworkError(ex))
    {
        // –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –¥–æ–±–∞–≤–ª—è–µ–º –≤ offline –æ—á–µ—Ä–µ–¥—å
        logger.LogWarning(ex, "Network error, queueing operation for offline processing");
        
        // –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ (–Ω–µ —Å–ø–∏—Å–∞–Ω–∏–µ)
        if (request.PointsToSpend > 0)
        {
            throw new OfflineException(
                "–í —Ä–µ–∂–∏–º–µ –æ—Ñ—Ñ–ª–∞–π–Ω –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª—è—Ç—å –±–∞–ª–ª—ã. –°–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ."
            );
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
        offlineQueue.EnqueueOperation(new OfflineOperation
        {
            Type = "APPLY_LOYALTY",
            Request = request
        });
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º "—É—Å–ø–µ—Ö" —Å –ø–æ–º–µ—Ç–∫–æ–π –æ–± –æ—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ
        return new ApplyLoyaltyResponse
        {
            Success = true,
            OfflineMode = true,
            Message = "–û–ø–µ—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"
        };
    }
}
```

**UI –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä offline —Ä–µ–∂–∏–º–∞:**

```xaml
<!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–Ω–Ω–µ—Ä –µ—Å–ª–∏ offline -->
<Border Background="#fef3c7" 
        BorderBrush="#f59e0b" 
        BorderThickness="2"
        Padding="10"
        Visibility="{Binding IsOfflineMode, Converter={StaticResource BoolToVisibility}}">
  <StackPanel Orientation="Horizontal">
    <TextBlock Text="‚ö†Ô∏è" FontSize="16" Margin="0,0,10,0"/>
    <TextBlock Text="–†–∞–±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –æ—Ñ—Ñ–ª–∞–π–Ω. –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤." 
               FontSize="12"
               TextWrapping="Wrap"/>
  </StackPanel>
</Border>
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–∞—Å—Å—É** - –º–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–∂–µ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ** - —Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ (–Ω–µ–ª—å–∑—è –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å)
- ‚úÖ **–ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å
- ‚úÖ **–õ–∏–º–∏—Ç –æ—á–µ—Ä–µ–¥–∏** - –Ω–µ –∫–æ–ø—è—Ç—Å—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ

***

### **20. –†–∞–∑–º–µ—Ä –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞**

**–í–û–ü–†–û–°:** –°–∫–æ–ª—å–∫–æ –º–µ—Å—Ç–∞ –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –ø–ª–∞–≥–∏–Ω –Ω–∞ –¥–∏—Å–∫–µ –∫–∞—Å—Å—ã?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –ú–∞–∫—Å–∏–º—É–º 50MB —Å —Ä–æ—Ç–∞—Ü–∏–µ–π**

```csharp
// StorageManager.cs
public class StorageManager
{
    private const long MAX_STORAGE_BYTES = 50 * 1024 * 1024; // 50 MB
    private readonly string storagePath;
    
    public StorageManager()
    {
        storagePath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "LoyaltyPluginIiko"
        );
        
        Directory.CreateDirectory(storagePath);
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    public void CheckStorageLimit()
    {
        var dirInfo = new DirectoryInfo(storagePath);
        var totalSize = dirInfo.GetFiles("*", SearchOption.AllDirectories)
            .Sum(file => file.Length);
        
        logger.LogInformation("Plugin storage size: {Size} MB", totalSize / 1024.0 / 1024.0);
        
        if (totalSize > MAX_STORAGE_BYTES)
        {
            logger.LogWarning("Storage limit exceeded, cleaning up old files");
            CleanupOldFiles();
        }
    }
    
    private void CleanupOldFiles()
    {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)
        var logFiles = Directory.GetFiles(storagePath, "*.log")
            .Select(f => new FileInfo(f))
            .Where(f => DateTime.Now - f.LastWriteTime > TimeSpan.FromDays(7))
            .OrderBy(f => f.LastWriteTime);
        
        foreach (var file in logFiles)
        {
            try
            {
                file.Delete();
                logger.LogInformation("Deleted old log file: {FileName}", file.Name);
            }
            catch (Exception ex)
            {
                logger.LogWarning(ex, "Failed to delete file: {FileName}", file.Name);
            }
        }
        
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–µ—à (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
        var cacheFiles = Directory.GetFiles(storagePath, "*.cache")
            .Select(f => new FileInfo(f))
            .Where(f => DateTime.Now - f.LastWriteTime > TimeSpan.FromDays(30));
        
        foreach (var file in cacheFiles)
        {
            try
            {
                file.Delete();
            }
            catch { }
        }
    }
    
    // –ú–µ—Ç–æ–¥ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    public StorageInfo GetStorageInfo()
    {
        var dirInfo = new DirectoryInfo(storagePath);
        var files = dirInfo.GetFiles("*", SearchOption.AllDirectories);
        
        return new StorageInfo
        {
            TotalSizeMB = files.Sum(f => f.Length) / 1024.0 / 1024.0,
            FileCount = files.Length,
            LogsSizeMB = files.Where(f => f.Extension == ".log").Sum(f => f.Length) / 1024.0 / 1024.0,
            CacheSizeMB = files.Where(f => f.Extension == ".cache").Sum(f => f.Length) / 1024.0 / 1024.0,
            QueueSizeMB = files.Where(f => f.Name.Contains("queue")).Sum(f => f.Length) / 1024.0 / 1024.0
        };
    }
}

public class StorageInfo
{
    public double TotalSizeMB { get; set; }
    public int FileCount { get; set; }
    public double LogsSizeMB { get; set; }
    public double CacheSizeMB { get; set; }
    public double QueueSizeMB { get; set; }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **50 MB –ª–∏–º–∏—Ç** - –Ω–µ –∑–∞–±–∏–≤–∞–µ—Ç –¥–∏—Å–∫ –∫–∞—Å—Å—ã
- ‚úÖ **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞** - —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ –∏ –∫–µ—à
- ‚úÖ **–†–æ—Ç–∞—Ü–∏—è** - —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª—è—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏

***

### **21. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏**

**–í–û–ü–†–û–°:** –í—Ä–µ–º—è –Ω–∞ –∫–∞—Å—Å–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º. –ö–∞–∫ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–ª–∞–≥–∏–Ω?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å backend + –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ**

```csharp
// TimeService.cs
public class TimeService
{
    private TimeSpan? serverTimeOffset;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø–ª–∞–≥–∏–Ω–∞
    public async Task SyncWithServerAsync(LoyaltyApiClient apiClient)
    {
        try
        {
            var localTime = DateTime.UtcNow;
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤—Ä–µ–º—è —Å —Å–µ—Ä–≤–µ—Ä–∞
            var response = await apiClient.GetAsync<ServerTimeResponse>("/api/system/time");
            var serverTime = response.ServerTime;
            
            // –í—ã—á–∏—Å–ª—è–µ–º offset
            serverTimeOffset = serverTime - localTime;
            
            // –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –±–æ–ª—å—à–µ 5 –º–∏–Ω—É—Ç - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
            if (Math.Abs(serverTimeOffset.Value.TotalMinutes) > 5)
            {
                logger.LogWarning(
                    "Clock skew detected: {Offset} minutes. Local: {Local}, Server: {Server}",
                    serverTimeOffset.Value.TotalMinutes,
                    localTime,
                    serverTime
                );
                
                MessageBox.Show(
                    $"–í–Ω–∏–º–∞–Ω–∏–µ! –í—Ä–µ–º—è –Ω–∞ –∫–∞—Å—Å–µ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –Ω–∞ {Math.Abs(serverTimeOffset.Value.TotalMinutes):N0} –º–∏–Ω—É—Ç.\n\n" +
                    "–≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º —Å –∞–∫—Ü–∏—è–º–∏ –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º –±–∞–ª–ª–æ–≤.\n" +
                    "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.",
                    "–†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning
                );
            }
            else
            {
                logger.LogInformation("Time synced with server. Offset: {Offset} seconds", serverTimeOffset.Value.TotalSeconds);
            }
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to sync time with server");
        }
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    public DateTime GetServerTime()
    {
        var localTime = DateTime.UtcNow;
        
        if (serverTimeOffset.HasValue)
        {
            return localTime + serverTimeOffset.Value;
        }
        
        return localTime;
    }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ–º —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
- ‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º –∫–∞—Å—Å–∏—Ä–∞ –µ—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –±–æ–ª—å—à–∞—è
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π

***

### **22. –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –¥–µ–∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏**

**–í–û–ü–†–û–°:** –ü–ª–∞–≥–∏–Ω —É–¥–∞–ª—è–µ—Ç—Å—è. –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ uninstaller**

```csharp
// Uninstaller.exe (–æ—Ç–¥–µ–ª—å–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞)
public class UninstallerProgram
{
    static void Main(string[] args)
    {
        Console.WriteLine("üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏");
        Console.WriteLine("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
        
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ iiko –∑–∞–∫—Ä—ã—Ç
        if (IsIikoRunning())
        {
            Console.WriteLine("‚ö†Ô∏è –ó–∞–∫—Ä–æ–π—Ç–µ iiko Front –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –ø–ª–∞–≥–∏–Ω–∞!");
            Console.ReadKey();
            return;
        }
        
        // 2. –£–¥–∞–ª—è–µ–º .dll
        var iikoPath = DetectIikoInstallation();
        var pluginPath = Path.Combine(iikoPath, "Plugins", "LoyaltyPlugin.dll");
        
        if (File.Exists(pluginPath))
        {
            File.Delete(pluginPath);
            Console.WriteLine("‚úÖ –ü–ª–∞–≥–∏–Ω —É–¥–∞–ª–µ–Ω –∏–∑ iiko Front");
        }
        
        // 3. –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ –¥–∞–Ω–Ω—ã–µ
        Console.WriteLine("\n–£–¥–∞–ª–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–ª–∞–≥–∏–Ω–∞?");
        Console.WriteLine("(–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –ª–æ–≥–∏, –∫–µ—à)");
        Console.Write("–í–≤–µ–¥–∏—Ç–µ Y –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–ª–∏ N –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ");
        
        var response = Console.ReadLine();
        
        if (response?.ToUpper() == "Y")
        {
            var dataPath = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                "LoyaltyPluginIiko"
            );
            
            if (Directory.Exists(dataPath))
            {
                Directory.Delete(dataPath, recursive: true);
                Console.WriteLine("‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã");
            }
        }
        else
        {
            Console.WriteLine("–õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
        }
        
        Console.WriteLine("\n‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!");
        Console.WriteLine("–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è –≤—ã—Ö–æ–¥–∞...");
        Console.ReadKey();
    }
}
```

**–í installer –¥–æ–±–∞–≤–ª—è–µ–º uninstaller:**

```csharp
// –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–ø–∏—Ä—É–µ–º uninstaller
File.Copy("Uninstaller.exe", Path.Combine(pluginsDir, "LoyaltyPluginUninstaller.exe"));
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ß–∏—Å—Ç–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ .dll
- ‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏)
- ‚úÖ Uninstaller –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –ø–∞–ø–∫–∏ –ø–ª–∞–≥–∏–Ω–æ–≤

***

## **üîå 5. –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° iiko API (8 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **23. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ –∫ –∑–∞–∫–∞–∑—É**

**–í–û–ü–†–û–°:** Backend –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤. –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É –≤ iiko?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –ò–º–µ–Ω–æ–≤–∞–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞ —Å –º–µ—Ç–∫–æ–π –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏**

```csharp
// IikoOperationsService.cs
public class IikoOperationsService
{
    private readonly IOperationService operations;
    
    public void ApplyLoyaltyDiscount(IOrder order, decimal amount, string guestName)
    {
        // 1. –°–æ–∑–¥–∞–µ–º —Å–∫–∏–¥–∫—É
        var discount = operations.CreateDiscount(
            name: $"–ë–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ - {guestName}",
            sum: amount,
            guest: null // –ù–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ iiko-–≥–æ—Å—Ç—é (—É –Ω–∞—Å —Å–≤–æ—è —Å–∏—Å—Ç–µ–º–∞)
        );
        
        // 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–∫–∏–¥–∫–∏ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞)
        if (TryGetLoyaltyDiscountType(out var discountType))
        {
            discount.DiscountType = discountType;
        }
        
        // 3. –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–¥–ª—è –æ—Ç—á–µ—Ç–æ–≤)
        discount.Comment = $"Loyalty: Guest={guestName}, Amount={amount:N0}";
        
        // 4. –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ –∑–∞–∫–∞–∑—É
        operations.AddDiscount(discount, order);
        
        logger.LogInformation(
            "Applied loyalty discount: {Amount} to order {OrderId}",
            amount,
            order.Id
        );
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞: —Å–æ–∑–¥–∞—Ç—å —Ç–∏–ø —Å–∫–∏–¥–∫–∏ "–õ–æ—è–ª—å–Ω–æ—Å—Ç—å" –≤ iiko
    private bool TryGetLoyaltyDiscountType(out IDiscountType discountType)
    {
        var allDiscountTypes = operations.GetDiscountTypes();
        
        // –ò—â–µ–º —Ç–∏–ø —Å–∫–∏–¥–∫–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "–õ–æ—è–ª—å–Ω–æ—Å—Ç—å"
        discountType = allDiscountTypes
            .FirstOrDefault(dt => dt.Name.Contains("–õ–æ—è–ª—å–Ω–æ—Å—Ç—å") || dt.Name.Contains("Loyalty"));
        
        if (discountType == null)
        {
            logger.LogWarning("Loyalty discount type not found in iiko. Using default.");
            return false;
        }
        
        return true;
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å)
    public void RemoveLoyaltyDiscount(IOrder order)
    {
        var loyaltyDiscounts = order.Discounts
            .Where(d => d.Comment?.StartsWith("Loyalty:") == true)
            .ToList();
        
        foreach (var discount in loyaltyDiscounts)
        {
            operations.DeleteDiscount(discount, order);
        }
    }
}
```

**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è Admin –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**

```markdown
## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ iiko Front –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞–≥–∏–Ω–æ–º

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–ø–∞ —Å–∫–∏–¥–∫–∏ "–õ–æ—è–ª—å–Ω–æ—Å—Ç—å"

1. –û—Ç–∫—Ä–æ–π—Ç–µ iiko Back Office
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ ‚Üí –°–∫–∏–¥–∫–∏/–Ω–∞–¥–±–∞–≤–∫–∏
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ç–∏–ø —Å–∫–∏–¥–∫–∏:
   - –ù–∞–∑–≤–∞–Ω–∏–µ: "–õ–æ—è–ª—å–Ω–æ—Å—Ç—å"
   - –¢–∏–ø: –°–∫–∏–¥–∫–∞ –≤ —Ä—É–±–ª—è—Ö
   - –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è: –ö –∑–∞–∫–∞–∑—É
   - –ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç—Å—è: –° –¥—Ä—É–≥–∏–º–∏ —Å–∫–∏–¥–∫–∞–º–∏ (–≤–∫–ª—é—á–∏—Ç—å)
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

–¢–µ–ø–µ—Ä—å –ø–ª–∞–≥–∏–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ç–∏–ø –¥–ª—è –≤—Å–µ—Ö —Å–∫–∏–¥–æ–∫ –ø–æ –±–∞–ª–ª–∞–º.
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–∏–¥–∫–∏ (–≤–∏–¥–Ω–æ –≤ —á–µ–∫–µ)
- ‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∞—É–¥–∏—Ç–∞
- ‚úÖ –û—Ç–¥–µ–ª—å–Ω—ã–π —Ç–∏–ø —Å–∫–∏–¥–∫–∏ (—É–¥–æ–±–Ω–æ –≤ –æ—Ç—á–µ—Ç–∞—Ö)

***

### **24. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –∑–∞–∫–∞–∑–µ**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å—É–º–º—É –∑–∞–∫–∞–∑–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –°—É–º–º–∞ –î–û –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫–∏–¥–æ–∫**

```csharp
public decimal GetOrderAmountForLoyalty(IOrder order)
{
    // –í–ê–ñ–ù–û: –±–µ—Ä–µ–º —Å—É–º–º—É –î–û –≤—Å–µ—Ö —Å–∫–∏–¥–æ–∫ (–∫–∞–∫ –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏)
    var amount = order.Items.Sum(item => item.Cost);
    
    // –ù–ï –≤—ã—á–∏—Ç–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∫–∏–¥–∫–∏ (–±–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –æ—Ç –ø–æ–ª–Ω–æ–π —Å—É–º–º—ã)
    // var discounts = order.Discounts.Sum(d => d.Sum); // ‚ùå –ù–ï –¥–µ–ª–∞–µ–º —Ç–∞–∫!
    
    logger.LogDebug(
        "Order amount for loyalty: {Amount} (items: {ItemCount})",
        amount,
        order.Items.Count
    );
    
    return amount;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞
public bool IsOrderEligibleForLoyalty(IOrder order, decimal minCheckAmount)
{
    var amount = GetOrderAmountForLoyalty(order);
    
    if (amount < minCheckAmount)
    {
        logger.LogInformation(
            "Order {OrderId} is below minimum: {Amount} < {MinAmount}",
            order.Id,
            amount,
            minCheckAmount
        );
        return false;
    }
    
    return true;
}
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –æ–∫–Ω–∞:**

```csharp
private void OnLoyaltyButtonClick(IOrder order, IOperationService operations)
{
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–∫–∞–∑ –Ω–µ –ø—É—Å—Ç–æ–π
    if (order.Items.Count == 0)
    {
        operations.ShowMessage("–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑", "–ü—É—Å—Ç–æ–π –∑–∞–∫–∞–∑");
        return;
    }
    
    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É
    var amount = GetOrderAmountForLoyalty(order);
    var minAmount = restaurantConfig.MinCheckAmount;
    
    if (amount < minAmount)
    {
        operations.ShowMessage(
            $"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤: {minAmount:N0}‚ÇΩ\n–¢–µ–∫—É—â–∞—è —Å—É–º–º–∞: {amount:N0}‚ÇΩ",
            "–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞"
        );
        return;
    }
    
    // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–∫–∞–∑ –Ω–µ –∑–∞–∫—Ä—ã—Ç
    if (order.Status == OrderStatus.Closed)
    {
        operations.ShowMessage("–ó–∞–∫–∞–∑ —É–∂–µ –∑–∞–∫—Ä—ã—Ç", "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å");
        return;
    }
    
    // 4. –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–ª–∞–≥–∏–Ω–∞
    var window = serviceProvider.GetRequiredService<LoyaltyWindow>();
    window.CurrentOrder = order;
    window.ShowDialog();
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –°—É–º–º–∞ –î–û —Å–∫–∏–¥–æ–∫ (—Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º —Å–∏—Å—Ç–µ–º—ã)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã
- ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞—Å—Å–∏—Ä—É

***

### **25. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞–∫–∞–∑–∞**

**–í–û–ü–†–û–°:** –ö–∞—Å—Å–∏—Ä –ø—Ä–∏–º–µ–Ω–∏–ª –ª–æ—è–ª—å–Ω–æ—Å—Ç—å, –Ω–æ –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–∏–ª —Ç–æ–≤–∞—Ä –≤ –∑–∞–∫–∞–∑. –ß—Ç–æ –¥–µ–ª–∞—Ç—å?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–∏—á–µ–≥–æ (—Å–∫–∏–¥–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å)
- **B)** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Å–∫–∏–¥–∫—É
- **C)** –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∫–∞—Å—Å–∏—Ä—É
- **D)** –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ + –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Å—á–µ—Ç–∞**

```csharp
// –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
public void InitializePlugin(IPluginContext context)
{
    context.Operations.OrderChanged += OnOrderChanged;
}

private void OnOrderChanged(object sender, OrderChangedEventArgs e)
{
    var order = e.Order;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å–∫–∏–¥–∫–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
    var loyaltyDiscount = order.Discounts
        .FirstOrDefault(d => d.Comment?.StartsWith("Loyalty:") == true);
    
    if (loyaltyDiscount == null)
        return; // –õ–æ—è–ª—å–Ω–æ—Å—Ç—å –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
    
    // –°—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
    var currentAmount = GetOrderAmountForLoyalty(order);
    var discountAmount = loyaltyDiscount.Sum;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∫–∏–¥–∫–∞ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –Ω–æ–≤—É—é —Å—É–º–º—É
    if (discountAmount > currentAmount * 0.5m) // 50% –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    {
        logger.LogWarning(
            "Loyalty discount ({Discount}) is too high for current order amount ({Amount})",
            discountAmount,
            currentAmount
        );
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        var result = operations.ShowMessage(
            $"–í–Ω–∏–º–∞–Ω–∏–µ! –°—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å.\n\n" +
            $"–ë—ã–ª–æ: {e.PreviousAmount:N0}‚ÇΩ\n" +
            $"–°–µ–π—á–∞—Å: {currentAmount:N0}‚ÇΩ\n" +
            $"–°–∫–∏–¥–∫–∞ –±–∞–ª–ª–∞–º–∏: {discountAmount:N0}‚ÇΩ\n\n" +
            $"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å–∫–∏–¥–∫—É?",
            "–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞",
            MessageBoxButton.YesNo
        );
        
        if (result == MessageBoxResult.Yes)
        {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–ª–∞–≥–∏–Ω–∞ –∑–∞–Ω–æ–≤–æ
            OnLoyaltyButtonClick(order, operations);
        }
    }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É –∫–∞—Å—Å–∏—Ä–∞
- ‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º –æ –ø—Ä–æ–±–ª–µ–º–µ
- ‚úÖ –î–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å

***

### **26. –†–∞–±–æ—Ç–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –æ–∫–Ω–∞–º–∏ –∑–∞–∫–∞–∑–æ–≤**

**–í–û–ü–†–û–°:** –í iiko –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–∫–∞–∑–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. –ö–∞–∫ –ø–ª–∞–≥–∏–Ω —ç—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–∫–∞–∑–∞**

```csharp
// Singleton –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
public class OrderContextService
{
    private readonly Dictionary<Guid, LoyaltyContext> orderContexts = new();
    private readonly object lockObj = new object();
    
    public void SetContext(IOrder order, LoyaltyContext context)
    {
        lock (lockObj)
        {
            orderContexts[order.Id] = context;
        }
    }
    
    public LoyaltyContext GetContext(IOrder order)
    {
        lock (lockObj)
        {
            return orderContexts.TryGetValue(order.Id, out var context) 
                ? context 
                : null;
        }
    }
    
    public void ClearContext(IOrder order)
    {
        lock (lockObj)
        {
            orderContexts.Remove(order.Id);
        }
    }
}

public class LoyaltyContext
{
    public string GuestCardId { get; set; }
    public string GuestName { get; set; }
    public decimal AppliedDiscount { get; set; }
    public DateTime AppliedAt { get; set; }
}

// –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –æ–∫–Ω–∞ –ø–ª–∞–≥–∏–Ω–∞
private void OnLoyaltyButtonClick(IOrder order, IOperationService operations)
{
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
    var existingContext = orderContextService.GetContext(order);
    
    if (existingContext != null)
    {
        var result = operations.ShowMessage(
            $"–ö —ç—Ç–æ–º—É –∑–∞–∫–∞–∑—É —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å:\n\n" +
            $"–ì–æ—Å—Ç—å: {existingContext.GuestName}\n" +
            $"–°–∫–∏–¥–∫–∞: {existingContext.AppliedDiscount:N0}‚ÇΩ\n\n" +
            $"–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å?",
            "–õ–æ—è–ª—å–Ω–æ—Å—Ç—å —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞",
            MessageBoxButton.YesNo
        );
        
        if (result != MessageBoxResult.Yes)
            return;
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å–∫–∏–¥–∫—É
        iikoOperations.RemoveLoyaltyDiscount(order);
        orderContextService.ClearContext(order);
    }
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
    var window = serviceProvider.GetRequiredService<LoyaltyWindow>();
    window.CurrentOrder = order;
    
    if (window.ShowDialog() == true)
    {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        orderContextService.SetContext(order, new LoyaltyContext
        {
            GuestCardId = window.AppliedGuestCardId,
            GuestName = window.AppliedGuestName,
            AppliedDiscount = window.AppliedDiscount,
            AppliedAt = DateTime.Now
        });
    }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–∫–∞–∑–æ–≤
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–∏–¥–∫–∏
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –æ—Ç–∫—Ä—ã—Ç–∏—è–º–∏

***

### **27. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≥—Ä—É–ø–ø–∞–º–∏ —Ç–æ–≤–∞—Ä–æ–≤ iiko**

**–í–û–ü–†–û–°:** –í —Å–∏—Å—Ç–µ–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª–∞ "—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–ª–∫–æ–≥–æ–ª—è" –∏–ª–∏ "–∫—Ä–æ–º–µ —Ç–∞–±–∞–∫–∞". –ö–∞–∫ —ç—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –ø–µ—Ä–µ–¥–∞–µ–º –≤ backend**

```csharp
// –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∑–∞–∫–∞–∑–∞
public List<string> GetOrderCategories(IOrder order)
{
    var categories = new HashSet<string>();
    
    foreach (var item in order.Items)
    {
        // iiko —Ö—Ä–∞–Ω–∏—Ç –∏–µ—Ä–∞—Ä—Ö–∏—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        var product = item.Product;
        var category = product.Category;
        
        while (category != null)
        {
            categories.Add(category.Name);
            category = category.Parent;
        }
    }
    
    return categories.ToList();
}

// –ü–µ—Ä–µ–¥–∞–µ–º –≤ backend –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
var calcResponse = await apiClient.CalculateAsync(new CalculateRequest
{
    GuestCardId = guest.CardId,
    CheckAmount = checkAmount,
    OrderCategories = GetOrderCategories(CurrentOrder), // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
    CalculateOnly = true
});

// Backend –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø—Ä–∞–≤–∏–ª–∞ –∏ –≤–µ—Ä–Ω–µ—Ç:
// - –ú–æ–∂–Ω–æ –ª–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å
// - –ö–∞–∫–∏–µ —Ç–æ–≤–∞—Ä—ã —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏
// - –ö–∞–∫–∏–µ —Ç–æ–≤–∞—Ä—ã –∏—Å–∫–ª—é—á–µ–Ω—ã
```

**Backend –≤–∞–ª–∏–¥–∞—Ü–∏—è:**

```typescript
// apps/backend/src/loyalty/calculate.service.ts
async calculate(request: CalculateRequest) {
  const rules = await this.getRules(request.guestCardId);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  for (const rule of rules) {
    if (rule.excludedCategories?.length > 0) {
      const hasExcluded = request.orderCategories.some(cat =>
        rule.excludedCategories.includes(cat)
      );
      
      if (hasExcluded) {
        return {
          canApply: false,
          reason: `–ó–∞–∫–∞–∑ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–≤–∞—Ä—ã –∏–∑ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ${rule.excludedCategories.join(', ')}`
        };
      }
    }
    
    if (rule.allowedCategories?.length > 0) {
      const hasAllowed = request.orderCategories.some(cat =>
        rule.allowedCategories.includes(cat)
      );
      
      if (!hasAllowed) {
        return {
          canApply: false,
          reason: `–ó–∞–∫–∞–∑ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π`
        };
      }
    }
  }
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π —Ä–∞—Å—á–µ—Ç
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ Backend –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ (–Ω–µ –≤ –ø–ª–∞–≥–∏–Ω–µ)
- ‚úÖ –ü–ª–∞–≥–∏–Ω —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö
- ‚úÖ –ì–∏–±–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É

***

### **28. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞—Å—Å–∏—Ä–µ**

**–í–û–ü–†–û–°:** –ù—É–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫—Ç–æ –ø—Ä–∏–º–µ–Ω–∏–ª –ª–æ—è–ª—å–Ω–æ—Å—Ç—å. –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∏–º—è –∫–∞—Å—Å–∏—Ä–∞ –∏–∑ iiko?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: iiko API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**

```csharp
public string GetCurrentCashierName()
{
    var currentUser = PluginContext.Operations.GetCurrentUser();
    
    if (currentUser == null)
    {
        logger.LogWarning("Failed to get current user from iiko");
        return "Unknown";
    }
    
    return currentUser.Name;
}

// –ü–µ—Ä–µ–¥–∞–µ–º –≤ backend
var response = await apiClient.ApplyLoyaltyAsync(new ApplyRequest
{
    GuestCardId = currentGuest.CardId,
    CheckAmount = checkAmount,
    PointsToSpend = selectedPoints,
    OrderId = CurrentOrder.Id.ToString(),
    CashierName = GetCurrentCashierName(),
    CashierId = PluginContext.Operations.GetCurrentUser()?.Id.ToString()
});
```

**Backend –ª–æ–≥–∏—Ä—É–µ—Ç:**

```typescript
await this.activityLogService.log({
  action: 'LOYALTY_APPLIED_FROM_POS',
  entityType: 'BALL_TRANSACTION',
  entityId: transaction.id,
  metadata: {
    cashierName: request.cashierName,
    cashierId: request.cashierId,
    orderId: request.orderId,
    pointsSpent: request.pointsToSpend,
    source: 'IIKO_PLUGIN'
  }
});
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü–æ–ª–Ω—ã–π audit trail
- ‚úÖ –í–∏–¥–Ω–æ –∫—Ç–æ –ø—Ä–∏–º–µ–Ω—è–ª –ª–æ—è–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ iiko

***

### **29. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ vs –∑–∞–ª**

**–í–û–ü–†–û–°:** –ó–∞–∫–∞–∑ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –∑–∞–ª–µ –∏–ª–∏ –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É. –≠—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º —Ç–∏–ø –∑–∞–∫–∞–∑–∞ –≤ backend**

```csharp
public string GetOrderType(IOrder order)
{
    // iiko —Ä–∞–∑–ª–∏—á–∞–µ—Ç —Ç–∏–ø—ã –∑–∞–∫–∞–∑–æ–≤
    if (order.OrderType == OrderType.Delivery)
        return "DELIVERY";
    
    if (order.OrderType == OrderType.TakeAway)
        return "TAKEAWAY";
    
    return "DINE_IN";
}

// –í –∑–∞–ø—Ä–æ—Å–µ
var calcResponse = await apiClient.CalculateAsync(new CalculateRequest
{
    GuestCardId = guest.CardId,
    CheckAmount = checkAmount,
    OrderType = GetOrderType(CurrentOrder),
    CalculateOnly = true
});
```

**Backend –º–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å —Ä–∞–∑–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:**

```typescript
// –ü—Ä–∏–º–µ—Ä: –¥–æ—Å—Ç–∞–≤–∫–∞ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –±–æ–Ω—É—Å–æ–≤
if (request.orderType === 'DELIVERY' && !tenant.settings.allowDeliveryLoyalty) {
  return {
    canApply: false,
    reason: '–î–æ—Å—Ç–∞–≤–∫–∞ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏'
  };
}

// –ò–ª–∏: —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
const earnPercentage = request.orderType === 'DELIVERY' 
  ? loyaltySystem.deliveryEarnPercentage 
  : loyaltySystem.dineInEarnPercentage;
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ì–∏–±–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É
- ‚úÖ –†–∞–∑–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏/–∑–∞–ª–∞
- ‚úÖ Backend –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É

***

### **30. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ API –ø–ª–∞–≥–∏–Ω–∞**

**–í–û–ü–†–û–°:** Backend API –º–µ–Ω—è–µ—Ç—Å—è (–Ω–æ–≤—ã–µ –ø–æ–ª—è, –¥—Ä—É–≥–∞—è –ª–æ–≥–∏–∫–∞). –ö–∞–∫ –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –ø–ª–∞–≥–∏–Ω–∞–º–∏?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: API Versioning + backward compatibility**

```csharp
// –ü–ª–∞–≥–∏–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ—é –≤–µ—Ä—Å–∏—é –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
public class LoyaltyApiClient
{
    private const string PLUGIN_VERSION = "1.2.0";
    
    private async Task<HttpResponseMessage> SendRequestAsync(
        string endpoint, 
        HttpMethod method, 
        object body = null)
    {
        var request = new HttpRequestMessage(method, endpoint);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –ø–ª–∞–≥–∏–Ω–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        request.Headers.Add("X-Plugin-Version", PLUGIN_VERSION);
        request.Headers.Add("X-Plugin-Type", "IIKO");
        
        if (body != null)
        {
            request.Content = JsonContent.Create(body);
        }
        
        return await httpClient.SendAsync(request);
    }
}
```

**Backend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–µ—Ä—Å–∏–∏:**

```typescript
// Middleware –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
export class PluginVersionMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    const pluginVersion = req.headers['x-plugin-version'];
    
    if (!pluginVersion) {
      throw new BadRequestException('Plugin version required');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—É—é –≤–µ—Ä—Å–∏—é
    const minSupportedVersion = '1.0.0';
    if (semver.lt(pluginVersion, minSupportedVersion)) {
      throw new BadRequestException(
        `Plugin version ${pluginVersion} is too old. ` +
        `Minimum supported: ${minSupportedVersion}. ` +
        `Please update the plugin.`
      );
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Ä—Å–∏—é –≤ request –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    req['pluginVersion'] = pluginVersion;
    
    next();
  }
}

// –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ –≤–µ—Ä—Å–∏–∏
@Post('calculate')
async calculate(@Body() dto: CalculateRequest, @Req() req: Request) {
  const pluginVersion = req['pluginVersion'];
  
  // –ù–æ–≤—ã–µ –ø–ª–∞–≥–∏–Ω—ã (>= 1.2.0) –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –¥–µ—Ç—Å–∫–∏–µ –∫–∞—Ä—Ç—ã
  if (semver.gte(pluginVersion, '1.2.0')) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ—Ç—Å–∫–∏–µ –∫–∞—Ä—Ç—ã
    if (guest.isChild && guest.parentCardId) {
      // ...
    }
  }
  
  // –°—Ç–∞—Ä—ã–µ –ø–ª–∞–≥–∏–Ω—ã (< 1.2.0) –Ω–µ –∑–Ω–∞—é—Ç –ø—Ä–æ –Ω–æ–≤—ã–µ –ø–æ–ª—è
  // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–º –Ω–æ–≤—ã–µ –ø–æ–ª—è –≤ –æ—Ç–≤–µ—Ç–µ
  const response = await this.loyaltyService.calculate(dto);
  
  if (semver.lt(pluginVersion, '1.2.0')) {
    delete response.childCardInfo; // –£–¥–∞–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è
  }
  
  return response;
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ Backend –∑–Ω–∞–µ—Ç –≤–µ—Ä—Å–∏—é –ø–ª–∞–≥–∏–Ω–∞
- ‚úÖ –ú–æ–∂–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏
- ‚úÖ Backward compatibility –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
- ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –∫–∞—Å—Å

***

## **‚ùå 6. –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö –ò OFFLINE –†–ï–ñ–ò–ú (6 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **31. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫**

**–í–û–ü–†–û–°:** –ö–∞–∫–∏–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –∏ –∫–∞–∫ –∏—Ö –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞—Å—Å–∏—Ä—É?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: 4 —É—Ä–æ–≤–Ω—è –æ—à–∏–±–æ–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ UI**

```csharp
// ErrorHandler.cs
public enum ErrorSeverity
{
    Info,       // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    Warning,    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å)
    Error,      // –û—à–∏–±–∫–∞ (–Ω–µ–ª—å–∑—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å)
    Critical    // –ö—Ä–∏—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞ (–Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å IT)
}

public class ErrorInfo
{
    public ErrorSeverity Severity { get; set; }
    public string Title { get; set; }
    public string Message { get; set; }
    public string UserAction { get; set; } // –ß—Ç–æ –¥–µ–ª–∞—Ç—å –∫–∞—Å—Å–∏—Ä—É
    public string TechnicalDetails { get; set; } // –î–ª—è –ª–æ–≥–æ–≤
    public Exception Exception { get; set; }
}

public class ErrorHandler
{
    public void HandleError(ErrorInfo error)
    {
        // –õ–æ–≥–∏—Ä—É–µ–º
        LogError(error);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º UI –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç severity
        switch (error.Severity)
        {
            case ErrorSeverity.Info:
                ShowInfoMessage(error);
                break;
            
            case ErrorSeverity.Warning:
                ShowWarningMessage(error);
                break;
            
            case ErrorSeverity.Error:
                ShowErrorMessage(error);
                break;
            
            case ErrorSeverity.Critical:
                ShowCriticalErrorMessage(error);
                break;
        }
    }
    
    private void ShowErrorMessage(ErrorInfo error)
    {
        var dialog = new ErrorDialog
        {
            Title = error.Title,
            Message = error.Message,
            Icon = GetIconForSeverity(error.Severity),
            PrimaryButton = "–ó–∞–∫—Ä—ã—Ç—å",
            ShowTechnicalDetails = error.Severity == ErrorSeverity.Critical
        };
        
        if (dialog.ShowTechnicalDetails)
        {
            dialog.TechnicalDetails = FormatTechnicalDetails(error);
        }
        
        dialog.ShowDialog();
    }
}
```

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```csharp
// 1. INFO: –ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω
HandleError(new ErrorInfo
{
    Severity = ErrorSeverity.Info,
    Title = "–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω",
    Message = "–ö–∞—Ä—Ç–∞ —Å –Ω–æ–º–µ—Ä–æ–º +7 999 123 45 67 –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ.",
    UserAction = "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞."
});

// 2. WARNING: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤
HandleError(new ErrorInfo
{
    Severity = ErrorSeverity.Warning,
    Title = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤",
    Message = "–ù–∞ –∫–∞—Ä—Ç–µ –≥–æ—Å—Ç—è 100‚ÇΩ, –Ω–µ–ª—å–∑—è —Å–ø–∏—Å–∞—Ç—å 500‚ÇΩ.",
    UserAction = "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω—å—à—É—é —Å—É–º–º—É –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ –±–µ–∑ —Å–ø–∏—Å–∞–Ω–∏—è."
});

// 3. ERROR: –û—à–∏–±–∫–∞ —Å–µ—Ç–∏
HandleError(new ErrorInfo
{
    Severity = ErrorSeverity.Error,
    Title = "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º",
    Message = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏.",
    UserAction = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.",
    TechnicalDetails = ex.ToString()
});

// 4. CRITICAL: Backend –≤–µ—Ä–Ω—É–ª 500
HandleError(new ErrorInfo
{
    Severity = ErrorSeverity.Critical,
    Title = "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
    Message = "–°–µ—Ä–≤–µ—Ä –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.",
    UserAction = "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
    TechnicalDetails = $"HTTP 500: {response.Content}",
    Exception = ex
});
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–∞—Å—Å–∏—Ä–∞
- ‚úÖ –¢–µ—Ö–¥–µ—Ç–∞–ª–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ critical
- ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —á—Ç–æ –¥–µ–ª–∞—Ç—å
- ‚úÖ –í—Å–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è

***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ 9 –≤–æ–ø—Ä–æ—Å–∞–º–∏?

- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (5 –≤–æ–ø—Ä–æ—Å–æ–≤)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (4 –≤–æ–ø—Ä–æ—Å–∞)

---

### **32. Retry —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**

**–í–û–ü–†–û–°:** –ó–∞–ø—Ä–æ—Å –∫ backend —É–ø–∞–ª –∏–∑-–∑–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–±–æ—è —Å–µ—Ç–∏. –ü–æ–≤—Ç–æ—Ä—è—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–µ—Ç, —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
- **B)** –î–∞, 3 –ø–æ–ø—ã—Ç–∫–∏ —Å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º (1 —Å–µ–∫—É–Ω–¥–∞)
- **C)** –î–∞, 3 –ø–æ–ø—ã—Ç–∫–∏ —Å exponential backoff (1s, 2s, 4s)
- **D)** –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (read - retry, write - –Ω–µ—Ç)

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) Exponential backoff —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏**

```csharp
// RetryPolicy.cs
public class RetryPolicy
{
    // –î–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —á—Ç–µ–Ω–∏—è (search, calculate) - –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π retry
    public static readonly AsyncRetryPolicy<HttpResponseMessage> ReadOperations = 
        Policy<HttpResponseMessage>
            .Handle<HttpRequestException>()
            .Or<TaskCanceledException>()
            .OrResult(r => IsTransientError(r.StatusCode))
            .WaitAndRetryAsync(
                retryCount: 3,
                sleepDurationProvider: attempt => TimeSpan.FromSeconds(Math.Pow(2, attempt - 1)),
                onRetry: (outcome, timespan, retryCount, context) =>
                {
                    logger.LogWarning(
                        "Retry {RetryCount} for {Operation} after {Delay}ms. Reason: {Reason}",
                        retryCount,
                        context["operation"],
                        timespan.TotalMilliseconds,
                        outcome.Exception?.Message ?? outcome.Result?.StatusCode.ToString()
                    );
                }
            );
    
    // –î–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞–ø–∏—Å–∏ (apply) - –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–π retry (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ)
    public static readonly AsyncRetryPolicy<HttpResponseMessage> WriteOperations = 
        Policy<HttpResponseMessage>
            .Handle<HttpRequestException>()
            .Or<TaskCanceledException>()
            .OrResult(r => r.StatusCode == HttpStatusCode.RequestTimeout || 
                          r.StatusCode == HttpStatusCode.GatewayTimeout)
            .WaitAndRetryAsync(
                retryCount: 2,
                sleepDurationProvider: attempt => TimeSpan.FromSeconds(2 * attempt),
                onRetry: (outcome, timespan, retryCount, context) =>
                {
                    logger.LogWarning(
                        "Retry write operation {RetryCount} after {Delay}ms",
                        retryCount,
                        timespan.TotalMilliseconds
                    );
                }
            );
    
    private static bool IsTransientError(HttpStatusCode statusCode)
    {
        return statusCode switch
        {
            HttpStatusCode.RequestTimeout => true,
            HttpStatusCode.BadGateway => true,
            HttpStatusCode.ServiceUnavailable => true,
            HttpStatusCode.GatewayTimeout => true,
            (HttpStatusCode)429 => true, // Too Many Requests
            _ => false
        };
    }
}

// LoyaltyApiClient.cs
public async Task<SearchGuestResponse> SearchGuestAsync(SearchRequest request)
{
    var context = new Context
    {
        ["operation"] = "SearchGuest"
    };
    
    var response = await RetryPolicy.ReadOperations.ExecuteAsync(async (ctx) =>
    {
        var httpResponse = await httpClient.PostAsJsonAsync("/api/loyalty/search-guest", request);
        return httpResponse;
    }, context);
    
    response.EnsureSuccessStatusCode();
    return await response.Content.ReadFromJsonAsync<SearchGuestResponse>();
}

public async Task<ApplyLoyaltyResponse> ApplyLoyaltyAsync(ApplyRequest request)
{
    // –î–ª—è apply –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ idempotency key
    request.IdempotencyKey = Guid.NewGuid().ToString();
    
    var context = new Context
    {
        ["operation"] = "ApplyLoyalty",
        ["idempotencyKey"] = request.IdempotencyKey
    };
    
    var response = await RetryPolicy.WriteOperations.ExecuteAsync(async (ctx) =>
    {
        var httpResponse = await httpClient.PostAsJsonAsync("/api/loyalty/apply", request);
        return httpResponse;
    }, context);
    
    if (!response.IsSuccessStatusCode)
    {
        // –ü—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–ø–∏—Å–∏ –Ω–µ –¥–µ–ª–∞–µ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫ - –∏–¥–µ–º –≤ offline queue
        throw new LoyaltyApiException($"Failed to apply loyalty: {response.StatusCode}");
    }
    
    return await response.Content.ReadFromJsonAsync<ApplyLoyaltyResponse>();
}
```

**Backend –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏:**

```typescript
// Middleware –¥–ª—è idempotency
@Post('apply')
async applyLoyalty(@Body() dto: ApplyRequest) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –ª–∏ —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å —Ä–∞–Ω–µ–µ
  const existing = await this.redis.get(`idempotency:${dto.idempotencyKey}`);
  
  if (existing) {
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    return JSON.parse(existing);
  }
  
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
  const result = await this.loyaltyService.apply(dto);
  
  // –ö–µ—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ 24 —á–∞—Å–∞
  await this.redis.setex(
    `idempotency:${dto.idempotencyKey}`,
    86400,
    JSON.stringify(result)
  );
  
  return result;
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **Exponential backoff** - –Ω–µ –∑–∞–±–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- ‚úÖ **–†–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏** - read –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–µ–µ, write –æ—Å—Ç–æ—Ä–æ–∂–Ω–µ–µ
- ‚úÖ **Idempotency** - –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤–∏–¥–∏–º –≤—Å–µ retry –≤ –ª–æ–≥–∞—Ö

***

### **33. Timeout –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤**

**–í–û–ü–†–û–°:** –°–∫–æ–ª—å–∫–æ –∂–¥–∞—Ç—å –æ—Ç–≤–µ—Ç–∞ –æ—Ç backend –ø–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π + 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å QR**

```csharp
public class LoyaltyApiClient
{
    private readonly HttpClient httpClient;
    
    public LoyaltyApiClient(IConfiguration config)
    {
        httpClient = new HttpClient
        {
            BaseAddress = new Uri(config.ApiBaseUrl),
            Timeout = TimeSpan.FromSeconds(5) // Default timeout
        };
        
        httpClient.DefaultRequestHeaders.Add("X-API-Key", config.ApiKey);
    }
    
    // –î–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ä–∞–∑–Ω—ã–º–∏ timeout
    private async Task<T> SendWithTimeoutAsync<T>(
        string endpoint, 
        object body, 
        TimeSpan? timeout = null)
    {
        using var cts = new CancellationTokenSource(timeout ?? TimeSpan.FromSeconds(5));
        
        try
        {
            var response = await httpClient.PostAsJsonAsync(endpoint, body, cts.Token);
            response.EnsureSuccessStatusCode();
            return await response.Content.ReadFromJsonAsync<T>(cancellationToken: cts.Token);
        }
        catch (OperationCanceledException)
        {
            logger.LogWarning("Request timeout after {Timeout}ms: {Endpoint}", 
                timeout?.TotalMilliseconds ?? 5000, endpoint);
            
            throw new LoyaltyApiException(
                "–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.",
                innerException: null
            );
        }
    }
    
    // –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π timeout (5 —Å–µ–∫—É–Ω–¥)
    public async Task<SearchGuestResponse> SearchGuestAsync(SearchRequest request)
    {
        return await SendWithTimeoutAsync<SearchGuestResponse>(
            "/api/loyalty/search-guest",
            request,
            timeout: TimeSpan.FromSeconds(5)
        );
    }
    
    // Calculate - –±—ã—Å—Ç—Ä—ã–π timeout (3 —Å–µ–∫—É–Ω–¥—ã, –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
    public async Task<CalculateResponse> CalculateAsync(CalculateRequest request)
    {
        return await SendWithTimeoutAsync<CalculateResponse>(
            "/api/loyalty/calculate",
            request,
            timeout: TimeSpan.FromSeconds(3)
        );
    }
    
    // Apply - —á—É—Ç—å –±–æ–ª—å—à–µ timeout (7 —Å–µ–∫—É–Ω–¥, —Ç.–∫. –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –ë–î)
    public async Task<ApplyLoyaltyResponse> ApplyLoyaltyAsync(ApplyRequest request)
    {
        return await SendWithTimeoutAsync<ApplyLoyaltyResponse>(
            "/api/loyalty/apply",
            request,
            timeout: TimeSpan.FromSeconds(7)
        );
    }
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥–æ—Å—Ç—è - –¥–ª–∏–Ω–Ω—ã–π timeout (10 —Å–µ–∫—É–Ω–¥, –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å SMS)
    public async Task<RegisterGuestResponse> RegisterGuestAsync(RegisterGuestRequest request)
    {
        return await SendWithTimeoutAsync<RegisterGuestResponse>(
            "/api/guests/register",
            request,
            timeout: TimeSpan.FromSeconds(10)
        );
    }
}
```

**UI –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏:**

```xaml
<!-- –û–≤–µ—Ä–ª–µ–π —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º -->
<Grid x:Name="LoadingOverlay" 
      Background="#80000000" 
      Visibility="Collapsed">
  <Border Background="White" 
          CornerRadius="12" 
          Padding="30"
          HorizontalAlignment="Center"
          VerticalAlignment="Center">
    <StackPanel>
      <ProgressBar IsIndeterminate="True" 
                   Width="200"
                   Height="6"/>
      
      <TextBlock x:Name="LoadingText"
                 Text="–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è..."
                 FontSize="14"
                 Margin="0,15,0,0"
                 HorizontalAlignment="Center"/>
      
      <!-- –¢–∞–π–º–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ —É–∂–µ –∂–¥–µ–º -->
      <TextBlock x:Name="LoadingTimer"
                 Text="0 —Å–µ–∫"
                 FontSize="11"
                 Foreground="Gray"
                 Margin="0,5,0,0"
                 HorizontalAlignment="Center"/>
    </StackPanel>
  </Border>
</Grid>
```

```csharp
private async Task SearchGuest(SearchRequest request)
{
    try
    {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º loading
        LoadingOverlay.Visibility = Visibility.Visible;
        LoadingText.Text = "–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è...";
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
        var stopwatch = Stopwatch.StartNew();
        var timer = new DispatcherTimer { Interval = TimeSpan.FromMilliseconds(100) };
        timer.Tick += (s, e) => 
        {
            LoadingTimer.Text = $"{stopwatch.Elapsed.TotalSeconds:F1} —Å–µ–∫";
        };
        timer.Start();
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
        var response = await apiClient.SearchGuestAsync(request);
        
        timer.Stop();
        
        if (response.Found)
        {
            ShowGuestBalance(response.Guest);
        }
        else
        {
            ShowError("–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
        }
    }
    catch (LoyaltyApiException ex) when (ex.Message.Contains("–Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"))
    {
        ShowError(
            "–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ.\n\n" +
            "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n" +
            "‚Ä¢ –ú–µ–¥–ª–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç\n" +
            "‚Ä¢ –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞\n" +
            "‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º\n\n" +
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
        );
    }
    finally
    {
        LoadingOverlay.Visibility = Visibility.Collapsed;
    }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–†–∞–∑–Ω—ã–µ timeout** - –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ **–í–∏–¥–∏–º—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å** - –∫–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç —á—Ç–æ –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
- ‚úÖ **–¢–∞–π–º–µ—Ä** - –ø–æ–Ω—è—Ç–Ω–æ —Å–∫–æ–ª—å–∫–æ —É–∂–µ –∂–¥–µ–º
- ‚úÖ **–ü–æ–Ω—è—Ç–Ω–∞—è –æ—à–∏–±–∫–∞** - —á—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ timeout

***

### **34. –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π**

**–í–û–ü–†–û–°:** –ù—É–∂–Ω–∞ –ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –ø–ª–∞–≥–∏–Ω–µ –∏–ª–∏ –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ backend?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –î–≤–æ–π–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (–∫–ª–∏–µ–Ω—Ç + —Å–µ—Ä–≤–µ—Ä)**

```csharp
// Validators/ApplyLoyaltyValidator.cs
public class ApplyLoyaltyValidator
{
    private readonly RestaurantConfig config;
    
    public ValidationResult Validate(ApplyLoyaltyRequest request, GuestInfo guest)
    {
        var errors = new List<string>();
        
        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞
        if (request.CheckAmount < config.MinCheckAmount)
        {
            errors.Add($"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞: {config.MinCheckAmount:N0}‚ÇΩ");
        }
        
        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–ø–∏—Å—ã–≤–∞–µ–º –Ω–µ –±–æ–ª—å—à–µ —á–µ–º –µ—Å—Ç—å
        if (request.PointsToSpend > guest.RegularBalance + guest.PromoBalance)
        {
            errors.Add($"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤. –ù–∞ –∫–∞—Ä—Ç–µ: {guest.TotalBalance:N0}‚ÇΩ");
        }
        
        // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —Å–ø–∏—Å–∞–Ω–∏—è
        var maxAllowed = request.CheckAmount * config.MaxSpendPercentage / 100;
        if (request.PointsToSpend > maxAllowed)
        {
            errors.Add($"–ú–∞–∫—Å–∏–º—É–º –∫ —Å–ø–∏—Å–∞–Ω–∏—é: {maxAllowed:N0}‚ÇΩ ({config.MaxSpendPercentage}% –æ—Ç —á–µ–∫–∞)");
        }
        
        // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º—É–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è (1 –±–∞–ª–ª)
        if (request.PointsToSpend > 0 && request.PointsToSpend < 1)
        {
            errors.Add("–ú–∏–Ω–∏–º—É–º –∫ —Å–ø–∏—Å–∞–Ω–∏—é: 1 –±–∞–ª–ª");
        }
        
        // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞
        if (guest.CardStatus != "ACTIVE")
        {
            errors.Add($"–ö–∞—Ä—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ ({guest.CardStatus})");
        }
        
        // 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–æ—Å–ª–µ —Å–ø–∏—Å–∞–Ω–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º –∫ –æ–ø–ª–∞—Ç–µ
        var remainingAmount = request.CheckAmount - request.PointsToSpend;
        if (remainingAmount < 1) // –ú–∏–Ω–∏–º—É–º 1‚ÇΩ –∫ –æ–ø–ª–∞—Ç–µ
        {
            errors.Add("–ü–æ—Å–ª–µ —Å–ø–∏—Å–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –æ—Å—Ç–∞—Ç—å—Å—è –º–∏–Ω–∏–º—É–º 1‚ÇΩ –∫ –æ–ø–ª–∞—Ç–µ");
        }
        
        return new ValidationResult
        {
            IsValid = errors.Count == 0,
            Errors = errors
        };
    }
}

public class ValidationResult
{
    public bool IsValid { get; set; }
    public List<string> Errors { get; set; }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
private async void OnApplyClick(object sender, RoutedEventArgs e)
{
    var request = new ApplyLoyaltyRequest
    {
        GuestCardId = currentGuest.CardId,
        CheckAmount = checkAmount,
        PointsToSpend = (decimal)PointsSlider.Value
    };
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
    var validationResult = validator.Validate(request, currentGuest);
    
    if (!validationResult.IsValid)
    {
        ShowValidationErrors(validationResult.Errors);
        return;
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend (—Ç–∞–º —Ç–æ–∂–µ –±—É–¥–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—è)
    try
    {
        var response = await apiClient.ApplyLoyaltyAsync(request);
        
        if (response.Success)
        {
            ApplyDiscountToOrder(response);
        }
        else
        {
            // Backend –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            ShowError($"–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è: {response.Error}");
        }
    }
    catch (Exception ex)
    {
        HandleError(ex);
    }
}

private void ShowValidationErrors(List<string> errors)
{
    var message = "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å:\n\n" + string.Join("\n‚Ä¢ ", errors);
    
    MessageBox.Show(
        message,
        "–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏",
        MessageBoxButton.OK,
        MessageBoxImage.Warning
    );
}
```

**Backend –≤–∞–ª–∏–¥–∞—Ü–∏—è (–¥—É–±–ª–∏—Ä—É–µ—Ç + –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–≤–æ—é):**

```typescript
@Post('apply')
async applyLoyalty(@Body() dto: ApplyRequest) {
  // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç DTO (class-validator)
  // 2. –ë–∏–∑–Ω–µ—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è
  
  const guest = await this.guestService.findOne(dto.guestCardId);
  const loyaltySystem = await this.loyaltyService.getSystem(guest.tenantId);
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∏ (–¥—É–±–ª–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ)
  if (dto.checkAmount < loyaltySystem.minCheckAmount) {
    throw new BadRequestException('Check amount below minimum');
  }
  
  if (dto.pointsToSpend > guest.totalBalance) {
    throw new BadRequestException('Insufficient balance');
  }
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –¥–µ–Ω—å
  const todayOperationsCount = await this.getTodayOperationsCount(guest.id);
  if (todayOperationsCount >= 10) {
    throw new BadRequestException('Daily operations limit exceeded');
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ anti-fraud –ø—Ä–∞–≤–∏–ª
  const isSuspicious = await this.fraudService.check(dto);
  if (isSuspicious) {
    await this.alertService.notifyAdmin('Suspicious loyalty operation', dto);
    throw new ForbiddenException('Operation blocked by fraud detection');
  }
  
  // –í—Å–µ –æ–∫ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
  return this.loyaltyService.apply(dto);
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** - –±—ã—Å—Ç—Ä—ã–π —Ñ–∏–¥–±–µ–∫, –Ω–µ —Ç—Ä–∞—Ç–∏–º –∑–∞–ø—Ä–æ—Å
- ‚úÖ **–°–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** - –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–∫–ª–∏–µ–Ω—Ç—É –Ω–µ–ª—å–∑—è –¥–æ–≤–µ—Ä—è—Ç—å)
- ‚úÖ **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏** - –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –±–æ–ª—å—à–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- ‚úÖ **–ü–æ–Ω—è—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏** - –∫–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç —á—Ç–æ –Ω–µ —Ç–∞–∫

***

### **35. Fallback –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ backend**

**–í–û–ü–†–û–°:** Backend –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (500 –æ—à–∏–±–∫–∞) –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–ª–∞–≥–∏–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é
- **B)** –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∂–∏–º "—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä" (–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- **C)** –î–µ–≥—Ä–∞–¥–∞—Ü–∏—è: —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ (—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ)
- **D)** –ü–æ–ª–Ω—ã–π offline —Ä–µ–∂–∏–º —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –ø–æ–∑–∂–µ

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –î–µ–≥—Ä–∞–¥–∞—Ü–∏—è —Å offline queue**

```csharp
// HealthCheckService.cs
public class HealthCheckService
{
    private bool isBackendHealthy = true;
    private DateTime lastHealthCheck = DateTime.MinValue;
    private readonly TimeSpan healthCheckInterval = TimeSpan.FromMinutes(1);
    
    public async Task<BackendHealthStatus> CheckHealthAsync()
    {
        // –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
        if (DateTime.Now - lastHealthCheck < healthCheckInterval)
        {
            return GetCurrentStatus();
        }
        
        try
        {
            var response = await httpClient.GetAsync("/api/health", 
                new CancellationTokenSource(TimeSpan.FromSeconds(2)).Token);
            
            isBackendHealthy = response.IsSuccessStatusCode;
            lastHealthCheck = DateTime.Now;
            
            if (isBackendHealthy)
            {
                logger.LogInformation("Backend health check: OK");
            }
            else
            {
                logger.LogWarning("Backend health check failed: {StatusCode}", response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            isBackendHealthy = false;
            logger.LogError(ex, "Backend health check error");
        }
        
        return GetCurrentStatus();
    }
    
    private BackendHealthStatus GetCurrentStatus()
    {
        if (isBackendHealthy)
        {
            return new BackendHealthStatus
            {
                Status = HealthStatus.Healthy,
                Message = "–°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω",
                AllowSpend = true,
                AllowEarn = true
            };
        }
        
        // Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        return new BackendHealthStatus
        {
            Status = HealthStatus.Degraded,
            Message = "–°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤.",
            AllowSpend = false,  // –°–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ
            AllowEarn = true     // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ offline queue
        };
    }
}

public class BackendHealthStatus
{
    public HealthStatus Status { get; set; }
    public string Message { get; set; }
    public bool AllowSpend { get; set; }
    public bool AllowEarn { get; set; }
}

public enum HealthStatus
{
    Healthy,
    Degraded,
    Unavailable
}
```

**UI –≤ –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ:**

```csharp
private async void OnLoyaltyButtonClick(IOrder order, IOperationService operations)
{
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ backend
    var health = await healthCheckService.CheckHealthAsync();
    
    if (health.Status == HealthStatus.Degraded)
    {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        var result = MessageBox.Show(
            "‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω\n\n" +
            "–í—ã –º–æ–∂–µ—Ç–µ:\n" +
            "‚Ä¢ –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É –≥–æ—Å—Ç—è –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤\n" +
            "‚Ä¢ –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞\n\n" +
            "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?",
            "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º",
            MessageBoxButton.YesNo,
            MessageBoxImage.Warning
        );
        
        if (result != MessageBoxResult.Yes)
            return;
    }
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
    var window = serviceProvider.GetRequiredService<LoyaltyWindow>();
    window.CurrentOrder = order;
    window.HealthStatus = health; // –ü–µ—Ä–µ–¥–∞–µ–º —Å—Ç–∞—Ç—É—Å
    window.ShowDialog();
}
```

```xaml
<!-- –í LoyaltyWindow –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–Ω–Ω–µ—Ä -->
<Border Background="#fef3c7" 
        BorderBrush="#f59e0b" 
        BorderThickness="2"
        Padding="15"
        Margin="0,0,0,15"
        Visibility="{Binding IsDegradedMode, Converter={StaticResource BoolToVisibility}}">
  <StackPanel>
    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
      <TextBlock Text="‚ö†Ô∏è" FontSize="20" Margin="0,0,10,0"/>
      <TextBlock Text="–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º" 
                 FontSize="16" 
                 FontWeight="Bold"
                 VerticalAlignment="Center"/>
    </StackPanel>
    
    <TextBlock Text="{Binding HealthStatus.Message}" 
               TextWrapping="Wrap"
               FontSize="13"/>
  </StackPanel>
</Border>

<!-- –ë–ª–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω -->
<Border IsEnabled="{Binding HealthStatus.AllowSpend}">
  <StackPanel>
    <TextBlock Text="–°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª–æ–≤"/>
    <Slider x:Name="PointsSlider"/>
    <!-- ... -->
  </StackPanel>
</Border>

<!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è -->
<Button Content="–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è"
        IsEnabled="{Binding HealthStatus.AllowEarn}"
        Click="OnApplyEarnOnly"/>
```

```csharp
private async void OnApplyEarnOnly(object sender, RoutedEventArgs e)
{
    // –í –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
    var request = new ApplyRequest
    {
        GuestCardId = currentGuest.CardId,
        CheckAmount = checkAmount,
        PointsToSpend = 0, // –ù–µ —Å–ø–∏—Å—ã–≤–∞–µ–º
        OrderId = CurrentOrder.Id.ToString()
    };
    
    try
    {
        // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ backend
        var response = await apiClient.ApplyLoyaltyAsync(request);
        
        ShowSuccess($"–ö–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞! –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ +{response.PointsEarned} –±–∞–ª–ª–æ–≤");
        this.Close();
    }
    catch (Exception ex)
    {
        // Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –¥–æ–±–∞–≤–ª—è–µ–º –≤ offline queue
        offlineQueue.EnqueueOperation(new OfflineOperation
        {
            Type = "EARN_ONLY",
            Request = request
        });
        
        ShowSuccess(
            "–ö–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞!\n\n" +
            "–ë–∞–ª–ª—ã –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º."
        );
        
        this.Close();
    }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **Graceful degradation** - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–∞—Å—Å—É –ø–æ–ª–Ω–æ—Å—Ç—å—é
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ** - —Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ (–Ω–µ–ª—å–∑—è –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å)
- ‚úÖ **–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** - —á–µ—Ä–µ–∑ offline queue
- ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ** - –∫–∞—Å—Å–∏—Ä –ø–æ–Ω–∏–º–∞–µ—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

***

### **36. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤–µ—Ä—Å–∏–π –¥–∞–Ω–Ω—ã—Ö**

**–í–û–ü–†–û–°:** –ë–∞–ª–∞–Ω—Å –≥–æ—Å—Ç—è –∏–∑–º–µ–Ω–∏–ª—Å—è –º–µ–∂–¥—É calculate –∏ apply (–≥–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –±–∞–ª–ª—ã –≤ –¥—Ä—É–≥–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ). –ö–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Optimistic locking —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º**

```csharp
// –ü—Ä–∏ calculate –ø–æ–ª—É—á–∞–µ–º –≤–µ—Ä—Å–∏—é –¥–∞–Ω–Ω—ã—Ö
var calcResponse = await apiClient.CalculateAsync(new CalculateRequest
{
    GuestCardId = guest.CardId,
    CheckAmount = checkAmount
});

// Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
public class CalculateResponse
{
    public decimal MaxAllowedToSpend { get; set; }
    public int PointsToEarn { get; set; }
    public long BalanceVersion { get; set; } // –í–µ—Ä—Å–∏—è –±–∞–ª–∞–Ω—Å–∞ –≥–æ—Å—Ç—è
}

// –ü—Ä–∏ apply –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é
var applyRequest = new ApplyRequest
{
    GuestCardId = guest.CardId,
    CheckAmount = checkAmount,
    PointsToSpend = selectedPoints,
    ExpectedBalanceVersion = calcResponse.BalanceVersion // –û–∂–∏–¥–∞–µ–º–∞—è –≤–µ—Ä—Å–∏—è
};

try
{
    var response = await apiClient.ApplyLoyaltyAsync(applyRequest);
}
catch (LoyaltyApiException ex) when (ex.StatusCode == 409) // Conflict
{
    // –í–µ—Ä—Å–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å - –±–∞–ª–∞–Ω—Å –Ω–µ –∞–∫—Ç—É–∞–ª–µ–Ω
    var result = MessageBox.Show(
        "–ë–∞–ª–∞–Ω—Å –≥–æ—Å—Ç—è –∏–∑–º–µ–Ω–∏–ª—Å—è —Å –º–æ–º–µ–Ω—Ç–∞ —Ä–∞—Å—á–µ—Ç–∞.\n\n" +
        "–í–æ–∑–º–æ–∂–Ω–æ –≥–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –±–∞–ª–ª—ã –≤ –¥—Ä—É–≥–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ.\n\n" +
        "–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ?",
        "–ö–æ–Ω—Ñ–ª–∏–∫—Ç –¥–∞–Ω–Ω—ã—Ö",
        MessageBoxButton.YesNo,
        MessageBoxImage.Warning
    );
    
    if (result == MessageBoxResult.Yes)
    {
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Å—Ç—è –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º
        await RefreshGuestAndRecalculate();
    }
}
```

**Backend –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏:**

```typescript
@Post('apply')
async applyLoyalty(@Body() dto: ApplyRequest) {
  const guest = await this.prisma.guestCard.findUnique({
    where: { id: dto.guestCardId }
  });
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é –±–∞–ª–∞–Ω—Å–∞
  if (dto.expectedBalanceVersion && guest.balanceVersion !== dto.expectedBalanceVersion) {
    throw new ConflictException({
      message: 'Balance version mismatch',
      currentBalance: guest.regularBalance + guest.promoBalance,
      currentVersion: guest.balanceVersion
    });
  }
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –≤–µ—Ä—Å–∏–∏
  await this.prisma.$transaction(async (tx) => {
    // –°–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–ª—ã
    await tx.guestCard.update({
      where: { id: dto.guestCardId },
      data: {
        regularBalance: { decrement: dto.pointsToSpend },
        balanceVersion: { increment: 1 } // –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏–º –≤–µ—Ä—Å–∏—é
      }
    });
    
    // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    await tx.loyaltyTransaction.create({
      data: {
        guestCardId: dto.guestCardId,
        type: 'SPEND',
        amount: -dto.pointsToSpend,
        // ...
      }
    });
  });
  
  return { success: true };
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **Optimistic locking** - –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
- ‚úÖ **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** - –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –æ—Ç—Å–ª–µ–¥–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–Ω—è—Ç–Ω–æ** - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ** - –Ω–µ–ª—å–∑—è —Å–ø–∏—Å–∞—Ç—å –±–æ–ª—å—à–µ —á–µ–º –µ—Å—Ç—å

***

## **üìä 7. –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì (4 –≤–æ–ø—Ä–æ—Å–∞)**

### **37. –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**

**–í–û–ü–†–û–°:** –ß—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤ –ø–ª–∞–≥–∏–Ω–µ –∏ —Å –∫–∞–∫–∏–º —É—Ä–æ–≤–Ω–µ–º?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–∞–∑–Ω—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏**

```csharp
// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
public class LoyaltyPlugin : IFrontPlugin
{
    private ILogger logger;
    
    public void InitializePlugin(IPluginContext context)
    {
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Serilog
        Log.Logger = new LoggerConfiguration()
            .MinimumLevel.Information() // –ü—Ä–æ–¥–∞–∫—à–µ–Ω —É—Ä–æ–≤–µ–Ω—å
            .MinimumLevel.Override("Microsoft", LogEventLevel.Warning)
            .Enrich.WithProperty("Plugin", "LoyaltyIiko")
            .Enrich.WithProperty("PluginVersion", GetPluginVersion())
            .Enrich.WithProperty("RestaurantId", GetRestaurantId())
            .Enrich.WithMachineName()
            .WriteTo.File(
                path: GetLogPath(),
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 7, // –•—Ä–∞–Ω–∏–º 7 –¥–Ω–µ–π
                outputTemplate: "[{Timestamp:yyyy-MM-dd HH:mm:ss.fff}] [{Level:u3}] {Message:lj} {Properties:j}{NewLine}{Exception}"
            )
            .WriteTo.Console() // –î–ª—è debug –≤ dev —Å—Ä–µ–¥–µ
            .CreateLogger();
        
        logger = Log.Logger.ForContext<LoyaltyPlugin>();
        logger.Information("Plugin initialized: Version {Version}", GetPluginVersion());
    }
    
    private string GetLogPath()
    {
        var path = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "LoyaltyPluginIiko",
            "logs",
            "plugin-.log" // Serilog –¥–æ–±–∞–≤–∏—Ç –¥–∞—Ç—É
        );
        
        Directory.CreateDirectory(Path.GetDirectoryName(path));
        return path;
    }
}
```

**–ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —É—Ä–æ–≤–Ω—è–º:**

```csharp
// 1. DEBUG - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–æ—Ç–∫–ª—é—á–µ–Ω–æ –≤ prod)
logger.LogDebug(
    "Cache lookup for guest: {Phone}",
    phone
);

// 2. INFORMATION - –æ–±—ã—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
logger.LogInformation(
    "Guest found: {GuestId}, Balance: {Balance}",
    guest.Id,
    guest.TotalBalance
);

logger.LogInformation(
    "Loyalty applied: Guest={GuestId}, Spent={Spent}, Earned={Earned}, Order={OrderId}",
    guestId,
    pointsSpent,
    pointsEarned,
    orderId
);

// 3. WARNING - —á—Ç–æ-—Ç–æ –Ω–µ–æ–±—ã—á–Ω–æ–µ, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ–µ
logger.LogWarning(
    "Backend health check failed: {StatusCode}. Switching to degraded mode.",
    statusCode
);

logger.LogWarning(
    "Retry {Attempt}/3 for operation {Operation}",
    attempt,
    operationName
);

logger.LogWarning(
    "Clock skew detected: {OffsetMinutes} minutes",
    offsetMinutes
);

// 4. ERROR - –æ—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
logger.LogError(ex,
    "Failed to apply loyalty: Guest={GuestId}, Amount={Amount}",
    guestId,
    amount
);

logger.LogError(ex,
    "Network error during search: {Phone}",
    phone
);

// 5. CRITICAL - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ (—Ç—Ä–µ–±—É–µ—Ç –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞)
logger.LogCritical(ex,
    "Plugin initialization failed. Backend unreachable: {Url}",
    apiUrl
);

logger.LogCritical(ex,
    "Offline queue processing failed critically. Data loss risk."
);
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º:**

```csharp
// –ò—Å–ø–æ–ª—å–∑—É–µ–º using –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
public async Task<ApplyLoyaltyResponse> ApplyLoyaltyAsync(ApplyRequest request)
{
    using (logger.BeginScope(new Dictionary<string, object>
    {
        ["GuestCardId"] = request.GuestCardId,
        ["CheckAmount"] = request.CheckAmount,
        ["PointsToSpend"] = request.PointsToSpend,
        ["OrderId"] = request.OrderId,
        ["CashierName"] = request.CashierName
    }))
    {
        logger.LogInformation("Applying loyalty started");
        
        try
        {
            var response = await httpClient.PostAsJsonAsync("/api/loyalty/apply", request);
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ApplyLoyaltyResponse>();
            
            logger.LogInformation(
                "Loyalty applied successfully: NewBalance={NewBalance}, Earned={Earned}",
                result.NewBalance,
                result.PointsEarned
            );
            
            return result;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to apply loyalty");
            throw;
        }
    }
}

// –õ–æ–≥ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:
// [2026-02-17 12:00:15.123] [INF] Applying loyalty started 
//   {"GuestCardId":"abc-123","CheckAmount":1000,"PointsToSpend":200,"OrderId":"order-456","CashierName":"–ò–≤–∞–Ω–æ–≤ –ò."}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏** - –ª–µ–≥–∫–æ –ø–∞—Ä—Å–∏—Ç—å –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ **–ö–æ–Ω—Ç–µ–∫—Å—Ç** - –≤–∏–¥–∏–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ **–†–æ—Ç–∞—Ü–∏—è** - –Ω–µ –∑–∞–±–∏–≤–∞–µ—Ç –¥–∏—Å–∫ (7 –¥–Ω–µ–π)
- ‚úÖ **–†–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏** - –º–æ–∂–µ–º –º–µ–Ω—è—Ç—å verbosity

***

### **38. –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**

**–í–û–ü–†–û–°:** –ö–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–∏—Ä–∞—Ç—å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç—ã –ø–ª–∞–≥–∏–Ω–∞?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Ç—Ä–∏–∫ –Ω–∞ backend –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**

```csharp
// MetricsService.cs
public class MetricsService
{
    private readonly LoyaltyApiClient apiClient;
    private readonly ConcurrentQueue<MetricEvent> metricsQueue = new();
    private readonly Timer flushTimer;
    
    public MetricsService(LoyaltyApiClient apiClient)
    {
        this.apiClient = apiClient;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        flushTimer = new Timer(
            callback: async _ => await FlushMetricsAsync(),
            state: null,
            dueTime: TimeSpan.FromMinutes(5),
            period: TimeSpan.FromMinutes(5)
        );
    }
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫—É
    public void RecordMetric(string name, double value, Dictionary<string, string> tags = null)
    {
        metricsQueue.Enqueue(new MetricEvent
        {
            Name = name,
            Value = value,
            Tags = tags ?? new Dictionary<string, string>(),
            Timestamp = DateTime.UtcNow
        });
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend –±–∞—Ç—á–µ–º
    private async Task FlushMetricsAsync()
    {
        if (metricsQueue.IsEmpty)
            return;
        
        var metrics = new List<MetricEvent>();
        
        while (metricsQueue.TryDequeue(out var metric))
        {
            metrics.Add(metric);
            
            if (metrics.Count >= 100) // –ú–∞–∫—Å 100 –º–µ—Ç—Ä–∏–∫ –∑–∞ —Ä–∞–∑
                break;
        }
        
        if (metrics.Count == 0)
            return;
        
        try
        {
            await apiClient.SendMetricsAsync(metrics);
            logger.LogDebug("Sent {Count} metrics to backend", metrics.Count);
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to send metrics");
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –≤ –æ—á–µ—Ä–µ–¥—å
            foreach (var metric in metrics)
            {
                metricsQueue.Enqueue(metric);
            }
        }
    }
}

public class MetricEvent
{
    public string Name { get; set; }
    public double Value { get; set; }
    public Dictionary<string, string> Tags { get; set; }
    public DateTime Timestamp { get; set; }
}
```

**–ú–µ—Ç—Ä–∏–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–±–∏—Ä–∞–µ–º:**

```csharp
// 1. –û–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
metricsService.RecordMetric("loyalty.apply.success", 1, new()
{
    ["restaurant_id"] = restaurantId,
    ["points_spent"] = pointsSpent.ToString(),
    ["cashier"] = cashierName
});

metricsService.RecordMetric("loyalty.apply.failed", 1, new()
{
    ["restaurant_id"] = restaurantId,
    ["error_type"] = ex.GetType().Name
});

// 2. –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
var stopwatch = Stopwatch.StartNew();
await operation();
stopwatch.Stop();

metricsService.RecordMetric("loyalty.search.duration_ms", stopwatch.ElapsedMilliseconds, new()
{
    ["search_type"] = "phone" // –∏–ª–∏ "qr", "code6"
});

metricsService.RecordMetric("loyalty.apply.duration_ms", stopwatch.ElapsedMilliseconds);

// 3. –†–∞–∑–º–µ—Ä —á–µ–∫–æ–≤
metricsService.RecordMetric("loyalty.check.amount", checkAmount, new()
{
    ["restaurant_id"] = restaurantId
});

// 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ offline queue
metricsService.RecordMetric("loyalty.offline_queue.size", queueSize);
metricsService.RecordMetric("loyalty.offline_queue.processed", processedCount);

// 5. –ó–¥–æ—Ä–æ–≤—å–µ backend
metricsService.RecordMetric("loyalty.backend.health", isHealthy ? 1 : 0);
metricsService.RecordMetric("loyalty.backend.latency_ms", latency);

// 6. –û—à–∏–±–∫–∏
metricsService.RecordMetric("loyalty.error.network", 1);
metricsService.RecordMetric("loyalty.error.timeout", 1);
metricsService.RecordMetric("loyalty.error.validation", 1);

// 7. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–µ—à–∞
metricsService.RecordMetric("loyalty.cache.hit", 1);
metricsService.RecordMetric("loyalty.cache.miss", 1);

// 8. –í–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞ (–¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)
metricsService.RecordMetric("loyalty.plugin.version", 1, new()
{
    ["version"] = pluginVersion,
    ["restaurant_id"] = restaurantId
});
```

**Backend –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–∏–∫–∏:**

```typescript
// apps/backend/src/monitoring/metrics.controller.ts
@Post('metrics')
async receiveMetrics(@Body() metrics: MetricEvent[]) {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ TimeSeries DB (–Ω–∞–ø—Ä–∏–º–µ—Ä InfluxDB –∏–ª–∏ Prometheus)
  for (const metric of metrics) {
    await this.influx.writePoint({
      measurement: metric.name,
      fields: { value: metric.value },
      tags: {
        ...metric.tags,
        source: 'iiko_plugin'
      },
      timestamp: metric.timestamp
    });
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–ª–µ—Ä—Ç—ã
  await this.checkAlerts(metrics);
}

// –ê–ª–µ—Ä—Ç—ã
async checkAlerts(metrics: MetricEvent[]) {
  // –ê–ª–µ—Ä—Ç –µ—Å–ª–∏ –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫
  const errorCount = metrics.filter(m => m.name.includes('.failed')).length;
  if (errorCount > 10) {
    await this.alertService.send({
      severity: 'warning',
      message: `High error rate in iiko plugin: ${errorCount} errors in 5 minutes`
    });
  }
  
  // –ê–ª–µ—Ä—Ç –µ—Å–ª–∏ backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
  const healthMetrics = metrics.filter(m => m.name === 'loyalty.backend.health');
  if (healthMetrics.some(m => m.value === 0)) {
    await this.alertService.send({
      severity: 'critical',
      message: 'iiko plugin reporting backend unavailability'
    });
  }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - Owner –≤–∏–¥–∏—Ç –≤—Å–µ –∫–∞—Å—Å—ã
- ‚úÖ **–ë–∞—Ç—á–∏–Ω–≥** - –Ω–µ –∑–∞–±–∏–≤–∞–µ–º —Å–µ—Ç—å —á–∞—Å—Ç—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
- ‚úÖ **–ê–ª–µ—Ä—Ç—ã** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- ‚úÖ **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** - –≤–∏–¥–∏–º –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–ª–∞–≥–∏–Ω

***

### **39. –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —ç–∫—Ä–∞–Ω –¥–ª—è tech support**

**–í–û–ü–†–û–°:** –ö–∞—Å—Å–∏—Ä –∑–≤–æ–Ω–∏—Ç –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É "–ø–ª–∞–≥–∏–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç". –ö–∞–∫ –±—ã—Å—Ç—Ä–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É?

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —ç–∫—Ä–∞–Ω**

```csharp
// –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—É—é –∫–æ–º–±–∏–Ω–∞—Ü–∏—é –∫–ª–∞–≤–∏—à –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
public void InitializePlugin(IPluginContext context)
{
    // Ctrl+Shift+D = Diagnostics
    context.Operations.RegisterHotKey(
        key: Key.D,
        modifiers: ModifierKeys.Control | ModifierKeys.Shift,
        handler: OpenDiagnostics,
        description: "Open diagnostics"
    );
}

private void OpenDiagnostics()
{
    var diagnosticsWindow = new DiagnosticsWindow(
        apiClient,
        configManager,
        healthCheckService,
        storageManager,
        metricsService
    );
    
    diagnosticsWindow.ShowDialog();
}
```

```xaml
<!-- DiagnosticsWindow.xaml -->
<Window Title="–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏" 
        Width="700" 
        Height="600">
  <TabControl>
    <!-- –í–∫–ª–∞–¥–∫–∞ 1: –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <TabItem Header="–û–±—â–µ–µ">
      <ScrollViewer>
        <StackPanel Margin="20">
          <TextBlock Text="–í–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞:" FontWeight="Bold"/>
          <TextBlock Text="{Binding PluginVersion}" Margin="0,0,0,15"/>
          
          <TextBlock Text="–†–µ—Å—Ç–æ—Ä–∞–Ω:" FontWeight="Bold"/>
          <TextBlock Text="{Binding RestaurantName}" Margin="0,0,0,15"/>
          
          <TextBlock Text="API URL:" FontWeight="Bold"/>
          <TextBlock Text="{Binding ApiUrl}" Margin="0,0,0,15"/>
          
          <TextBlock Text="–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:" FontWeight="Bold"/>
          <StackPanel Orientation="Horizontal">
            <Ellipse Width="12" Height="12" 
                     Fill="{Binding StatusColor}" 
                     Margin="0,0,10,0"/>
            <TextBlock Text="{Binding StatusText}"/>
          </StackPanel>
          
          <Separator Margin="0,20"/>
          
          <TextBlock Text="–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:" FontWeight="Bold"/>
          <TextBlock Text="{Binding StorageInfo}" Margin="0,0,0,15"/>
          
          <TextBlock Text="Offline –æ—á–µ—Ä–µ–¥—å:" FontWeight="Bold"/>
          <TextBlock Text="{Binding OfflineQueueSize}" Margin="0,0,0,15"/>
          
          <TextBlock Text="–†–∞–∑–º–µ—Ä –∫–µ—à–∞:" FontWeight="Bold"/>
          <TextBlock Text="{Binding CacheSize}" Margin="0,0,0,15"/>
        </StackPanel>
      </ScrollViewer>
    </TabItem>
    
    <!-- –í–∫–ª–∞–¥–∫–∞ 2: –¢–µ—Å—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
    <TabItem Header="–¢–µ—Å—Ç—ã">
      <StackPanel Margin="20">
        <TextBlock Text="–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É" 
                   FontSize="16" 
                   FontWeight="Bold"
                   Margin="0,0,0,15"/>
        
        <Button Content="üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"
                Click="OnTestConnection"
                Margin="0,0,0,10"/>
        
        <Border BorderBrush="#e5e7eb" 
                BorderThickness="1" 
                CornerRadius="8"
                Padding="15"
                Margin="0,10,0,0">
          <StackPanel>
            <TextBlock Text="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞:" FontWeight="Bold"/>
            
            <ItemsControl ItemsSource="{Binding TestResults}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                    <TextBlock Text="{Binding Icon}" 
                               FontSize="16" 
                               Margin="0,0,10,0"/>
                    <TextBlock Text="{Binding Name}" 
                               Width="200"/>
                    <TextBlock Text="{Binding Status}" 
                               Foreground="{Binding StatusColor}"/>
                  </StackPanel>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </StackPanel>
        </Border>
        
        <Button Content="üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏"
                Click="OnCopyReport"
                Margin="0,20,0,0"/>
      </StackPanel>
    </TabItem>
    
    <!-- –í–∫–ª–∞–¥–∫–∞ 3: –õ–æ–≥–∏ -->
    <TabItem Header="–õ–æ–≥–∏">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="*"/>
          <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10">
          <Button Content="üîÑ –û–±–Ω–æ–≤–∏—Ç—å" Click="OnRefreshLogs" Margin="0,0,10,0"/>
          <Button Content="üìÅ –û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É —Å –ª–æ–≥–∞–º–∏" Click="OnOpenLogsFolder"/>
        </StackPanel>
        
        <TextBox Grid.Row="1"
                 x:Name="LogsTextBox"
                 IsReadOnly="True"
                 TextWrapping="Wrap"
                 VerticalScrollBarVisibility="Auto"
                 FontFamily="Consolas"
                 FontSize="11"
                 Margin="10,0,10,10"/>
        
        <TextBlock Grid.Row="2" 
                   Text="–ü–æ–∫–∞–∑–∞–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ 200 —Å—Ç—Ä–æ–∫"
                   FontSize="11"
                   Foreground="Gray"
                   Margin="10,0,10,10"/>
      </Grid>
    </TabItem>
    
    <!-- –í–∫–ª–∞–¥–∫–∞ 4: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è -->
    <TabItem Header="–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è">
      <ScrollViewer>
        <StackPanel Margin="20">
          <TextBlock Text="–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:" 
                     FontSize="16" 
                     FontWeight="Bold"
                     Margin="0,0,0,15"/>
          
          <TextBox x:Name="ConfigTextBox"
                   IsReadOnly="True"
                   TextWrapping="Wrap"
                   FontFamily="Consolas"
                   FontSize="11"
                   MinHeight="300"/>
          
          <TextBlock Text="‚ö†Ô∏è –ù–µ –¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –ø—É–±–ª–∏—á–Ω–æ (—Å–æ–¥–µ—Ä–∂–∏—Ç API Key)"
                     Foreground="Orange"
                     FontSize="11"
                     Margin="0,10,0,0"/>
        </StackPanel>
      </ScrollViewer>
    </TabItem>
  </TabControl>
</Window>
```

**Backend –∫–æ–¥ –¥–ª—è —Ç–µ—Å—Ç–æ–≤:**

```csharp
// DiagnosticsWindow.xaml.cs
private async void OnTestConnection(object sender, RoutedEventArgs e)
{
    TestResults.Clear();
    
    // –¢–µ—Å—Ç 1: Ping
    await RunTest("Ping —Å–µ—Ä–≤–µ—Ä–∞", async () =>
    {
        var stopwatch = Stopwatch.StartNew();
        await httpClient.GetAsync("/api/health");
        stopwatch.Stop();
        return $"OK ({stopwatch.ElapsedMilliseconds}ms)";
    });
    
    // –¢–µ—Å—Ç 2: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    await RunTest("–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è", async () =>
    {
        var response = await apiClient.GetAsync("/api/pos-integration/iiko/config");
        return response.IsSuccessStatusCode ? "OK" : $"–û—à–∏–±–∫–∞ {response.StatusCode}";
    });
    
    // –¢–µ—Å—Ç 3: –ü–æ–∏—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è
    await RunTest("–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è (—Ç–µ—Å—Ç)", async () =>
    {
        var response = await apiClient.SearchGuestAsync(new SearchRequest
        {
            Phone = "+79991234567" // –¢–µ—Å—Ç–æ–≤—ã–π –Ω–æ–º–µ—Ä
        });
        return "OK";
    });
    
    // –¢–µ—Å—Ç 4: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
    await RunTest("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏", async () =>
    {
        var serverTime = await apiClient.GetServerTimeAsync();
        var offset = serverTime - DateTime.UtcNow;
        
        if (Math.Abs(offset.TotalMinutes) > 5)
            return $"–†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è {offset.TotalMinutes:N0} –º–∏–Ω";
        
        return $"OK (offset {offset.TotalSeconds:N0}s)";
    });
    
    // –¢–µ—Å—Ç 5: Offline queue
    await RunTest("Offline –æ—á–µ—Ä–µ–¥—å", async () =>
    {
        var queueSize = offlineQueue.GetSize();
        return queueSize == 0 ? "–ü—É—Å—Ç–æ" : $"{queueSize} –æ–ø–µ—Ä–∞—Ü–∏–π";
    });
}

private async Task RunTest(string name, Func<Task<string>> test)
{
    try
    {
        var result = await test();
        
        TestResults.Add(new TestResult
        {
            Icon = "‚úÖ",
            Name = name,
            Status = result,
            StatusColor = Brushes.Green
        });
    }
    catch (Exception ex)
    {
        TestResults.Add(new TestResult
        {
            Icon = "‚ùå",
            Name = name,
            Status = ex.Message,
            StatusColor = Brushes.Red
        });
    }
}

private void OnCopyReport(object sender, RoutedEventArgs e)
{
    var report = new StringBuilder();
    report.AppendLine("=== –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ß–ï–¢ ===");
    report.AppendLine($"–î–∞—Ç–∞: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
    report.AppendLine($"–í–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞: {PluginVersion}");
    report.AppendLine($"–†–µ—Å—Ç–æ—Ä–∞–Ω: {RestaurantName} ({RestaurantId})");
    report.AppendLine($"API URL: {ApiUrl}");
    report.AppendLine();
    
    report.AppendLine("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:");
    foreach (var test in TestResults)
    {
        report.AppendLine($"{test.Icon} {test.Name}: {test.Status}");
    }
    
    report.AppendLine();
    report.AppendLine("–•—Ä–∞–Ω–∏–ª–∏—â–µ:");
    report.AppendLine($"–†–∞–∑–º–µ—Ä: {StorageInfo}");
    report.AppendLine($"Offline –æ—á–µ—Ä–µ–¥—å: {OfflineQueueSize}");
    report.AppendLine($"–ö–µ—à: {CacheSize}");
    
    Clipboard.SetText(report.ToString());
    
    MessageBox.Show(
        "–û—Ç—á–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.",
        "–ì–æ—Ç–æ–≤–æ",
        MessageBoxButton.OK,
        MessageBoxImage.Information
    );
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** - –≤—Å–µ –≤ –æ–¥–Ω–æ–º –æ–∫–Ω–µ
- ‚úÖ **–¢–µ—Å—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** - –≤–∏–¥–∏–º —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ **–õ–æ–≥–∏** - –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä—è–º–æ –≤ –ø–ª–∞–≥–∏–Ω–µ
- ‚úÖ **–û—Ç—á–µ—Ç –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏** - –∫–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –≤–∞–∂–Ω–æ–µ

***

### **40. Telemetry –∏ analytics**

**–í–û–ü–†–û–°:** –ù—É–∂–Ω–æ –ª–∏ —Å–æ–±–∏—Ä–∞—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—É—é —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø–ª–∞–≥–∏–Ω–∞?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–µ—Ç, —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏
- **B)** –î–∞, –±–∞–∑–æ–≤–∞—è (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π, –æ—à–∏–±–æ–∫)
- **C)** –î–∞, –¥–µ—Ç–∞–ª—å–Ω–∞—è (—Å —Å–æ–±—ã—Ç–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- **D)** –î–∞, —Å —Å–æ–≥–ª–∞—Å–∏—è Admin (opt-in)

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) Opt-in —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞**

```csharp
// –ü—Ä–∏ –ø–µ—Ä–≤–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–æ–≥–ª–∞—Å–∏–µ
public async void FirstRun()
{
    var result = MessageBox.Show(
        "–ü–æ–º–æ–≥–∏—Ç–µ –Ω–∞–º —É–ª—É—á—à–∏—Ç—å –ø–ª–∞–≥–∏–Ω!\n\n" +
        "–ú—ã —Ö–æ—Ç–µ–ª–∏ –±—ã —Å–æ–±–∏—Ä–∞—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n" +
        "‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏\n" +
        "‚Ä¢ –¢–∏–ø—ã –æ—à–∏–±–æ–∫\n" +
        "‚Ä¢ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–ª–∞–≥–∏–Ω–∞\n\n" +
        "–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º —É–ª—É—á—à–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω—É–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.\n\n" +
        "–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≥–æ—Å—Ç–µ–π –ù–ï —Å–æ–±–∏—Ä–∞—é—Ç—Å—è.\n\n" +
        "–†–∞–∑—Ä–µ—à–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏?",
        "–£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞",
        MessageBoxButton.YesNo,
        MessageBoxImage.Question
    );
    
    config.TelemetryEnabled = result == MessageBoxResult.Yes;
    configManager.Save(config);
}

// TelemetryService.cs
public class TelemetryService
{
    private readonly bool isEnabled;
    
    public void TrackEvent(string eventName, Dictionary<string, object> properties = null)
    {
        if (!isEnabled)
            return;
        
        // –ê–Ω–æ–Ω–∏–º–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        var anonymizedProperties = AnonymizeProperties(properties);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        anonymizedProperties["plugin_version"] = GetPluginVersion();
        anonymizedProperties["restaurant_id_hash"] = HashRestaurantId(); // –•–µ—à –≤–º–µ—Å—Ç–æ ID
        anonymizedProperties["timestamp"] = DateTime.UtcNow;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º UI)
        Task.Run(async () =>
        {
            try
            {
                await apiClient.SendTelemetryAsync(eventName, anonymizedProperties);
            }
            catch
            {
                // –ú–æ–ª—á–∞ –ø—Ä–æ–≥–ª–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏
            }
        });
    }
    
    private Dictionary<string, object> AnonymizeProperties(Dictionary<string, object> properties)
    {
        if (properties == null)
            return new Dictionary<string, object>();
        
        var anonymized = new Dictionary<string, object>();
        
        foreach (var kvp in properties)
        {
            // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º sensitive –¥–∞–Ω–Ω—ã–µ
            if (IsSensitiveKey(kvp.Key))
                continue;
            
            anonymized[kvp.Key] = kvp.Value;
        }
        
        return anonymized;
    }
    
    private bool IsSensitiveKey(string key)
    {
        var sensitiveKeys = new[] { "phone", "name", "email", "api_key", "guest_id" };
        return sensitiveKeys.Any(sk => key.ToLower().Contains(sk));
    }
    
    private string HashRestaurantId()
    {
        // –û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π —Ö–µ—à (–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ID)
        using var sha = SHA256.Create();
        var hash = sha.ComputeHash(Encoding.UTF8.GetBytes(restaurantId + "salt"));
        return Convert.ToBase64String(hash);
    }
}

// –°–æ–±—ã—Ç–∏—è –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
telemetryService.TrackEvent("loyalty_applied", new()
{
    ["check_amount_range"] = GetAmountRange(checkAmount), // –î–∏–∞–ø–∞–∑–æ–Ω, –Ω–µ —Ç–æ—á–Ω–∞—è —Å—É–º–º–∞
    ["points_spent_range"] = GetAmountRange(pointsSpent),
    ["search_method"] = "phone" // –∏–ª–∏ "qr", "code6"
});

telemetryService.TrackEvent("error_occurred", new()
{
    ["error_type"] = ex.GetType().Name,
    ["error_category"] = "network" // –∏–ª–∏ "validation", "timeout"
});

telemetryService.TrackEvent("offline_mode_activated");

telemetryService.TrackEvent("plugin_updated", new()
{
    ["from_version"] = oldVersion,
    ["to_version"] = newVersion
});

private string GetAmountRange(decimal amount)
{
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç–∏
    if (amount < 500) return "0-500";
    if (amount < 1000) return "500-1000";
    if (amount < 2000) return "1000-2000";
    if (amount < 5000) return "2000-5000";
    return "5000+";
}
```

**Backend –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏:**

```typescript
@Post('telemetry')
async receiveTelemetry(@Body() event: TelemetryEvent) {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é –ë–î
  await this.analytics.track({
    event: event.name,
    properties: event.properties,
    timestamp: event.timestamp
  });
  
  // –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∏–∫–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö (privacy)
  return { received: true };
}

// Owner –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
@Get('analytics/plugin-usage')
async getPluginUsage(@CurrentUser() user: User) {
  if (user.role !== 'OWNER') {
    throw new ForbiddenException();
  }
  
  return {
    totalOperations: await this.analytics.count('loyalty_applied'),
    errorRate: await this.analytics.errorRate(),
    avgCheckAmount: await this.analytics.avg('check_amount_range'),
    mostUsedSearchMethod: await this.analytics.mode('search_method'),
    offlineModeActivations: await this.analytics.count('offline_mode_activated')
  };
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **Opt-in** - Admin —Ä–µ—à–∞–µ—Ç —Å–∞–º
- ‚úÖ **–ê–Ω–æ–Ω–∏–º–Ω–æ** - –Ω–µ—Ç –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **–ü–æ–ª–µ–∑–Ω–æ** - –ø–æ–º–æ–≥–∞–µ—Ç —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç
- ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ** - –æ–±—ä—è—Å–Ω—è–µ–º —á—Ç–æ —Å–æ–±–∏—Ä–∞–µ–º

***

## **üéØ –ò–¢–û–ì–û: 40 –í–û–ü–†–û–°–û–í –° –†–ï–®–ï–ù–ò–Ø–ú–ò**

### **–†–µ–∑—é–º–µ –ø–æ –±–ª–æ–∫–∞–º:**

1. **–ü—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (5 –≤–æ–ø—Ä–æ—Å–æ–≤)** ‚úÖ
    - One-click installer —Å –∞–≤—Ç–æ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
    - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
    - –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å rollback
    - –ú—É–ª—å—Ç–∏–∫–∞—Å—Å–æ–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
    - Uninstaller —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (3 –≤–æ–ø—Ä–æ—Å–∞)** ‚úÖ
    - –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API Key —Å machine-binding
    - Instant revoke –∏ —Ä–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π
    - Rate limiting –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∞–º
3. **UI/UX (8 –≤–æ–ø—Ä–æ—Å–æ–≤)** ‚úÖ
    - –ö–Ω–æ–ø–∫–∞ + –≥–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞ (Ctrl+L)
    - 3 —Å–ø–æ—Å–æ–±–∞ –ø–æ–∏—Å–∫–∞ (—Ç–µ–ª–µ—Ñ–æ–Ω, QR, 6-digit)
    - Progressive disclosure UI
    - Pre-calculation —Å live preview
    - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å —Ñ–∏–Ω–∞–ª—å–Ω—ã–º —ç–∫—Ä–∞–Ω–æ–º
    - –û–ø—Ü–∏—è "—Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ"
    - –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è
4. **–î–∞–Ω–Ω—ã–µ –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (6 –≤–æ–ø—Ä–æ—Å–æ–≤)** ‚úÖ
    - 30 –º–∏–Ω—É—Ç –∫–µ—à —Å invalidation
    - Prefetch –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
    - Offline queue —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
    - –õ–∏–º–∏—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ 50MB
    - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
    - –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –¥–µ–∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏
5. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å iiko (8 –≤–æ–ø—Ä–æ—Å–æ–≤)** ‚úÖ
    - –ò–º–µ–Ω–æ–≤–∞–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
    - –°—É–º–º–∞ –î–û —Å–∫–∏–¥–æ–∫ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
    - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞–∫–∞–∑–∞
    - –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∑–∞–∫–∞–∑–æ–≤
    - –ü–µ—Ä–µ–¥–∞—á–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–æ–≤–∞—Ä–æ–≤
    - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Å—Å–∏—Ä–µ
    - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∏–ø–æ–≤ –∑–∞–∫–∞–∑–æ–≤
    - API –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
6. **–û—à–∏–±–∫–∏ –∏ offline (6 –≤–æ–ø—Ä–æ—Å–æ–≤)** ‚úÖ
    - 4 —É—Ä–æ–≤–Ω—è severity (Info/Warning/Error/Critical)
    - Exponential backoff retry
    - Timeout 3-10 —Å–µ–∫—É–Ω–¥
    - –î–≤–æ–π–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (–∫–ª–∏–µ–Ω—Ç+—Å–µ—Ä–≤–µ—Ä)
    - Graceful degradation –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ backend
    - Optimistic locking –¥–ª—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
7. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (4 –≤–æ–ø—Ä–æ—Å–∞)** ‚úÖ
    - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ Serilog
    - –ú–µ—Ç—Ä–∏–∫–∏ —Å –±–∞—Ç—á–∏–Ω–≥–æ–º –Ω–∞ backend
    - –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —ç–∫—Ä–∞–Ω
    - Opt-in —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è

***

**–•–æ—á–µ—à—å –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É?**

–í–∞—Ä–∏–∞–Ω—Ç—ã:

1. **–§–∏–Ω–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - Database schema, API endpoints, –ø–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è
2. **–î—Ä—É–≥–æ–π –±–ª–æ–∫** - –≤—ã–±–µ—Ä–∏ —á—Ç–æ –µ—â–µ –Ω—É–∂–Ω–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
3. **–ü—Ä–æ—Ç–æ—Ç–∏–ø –∫–æ–¥–∞** - –Ω–∞—á–∞—Ç—å –ø–∏—Å–∞—Ç—å –ø–ª–∞–≥–∏–Ω

–°–∫–∞–∂–∏ —á—Ç–æ –¥–∞–ª—å—à–µ! üöÄ

---

# üéØ **–ü–û–ù–Ø–õ! –≠–¢–û –î–†–£–ì–û–ô –ü–û–î–•–û–î - –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –í UI iiko Front**

–î–∞, –ø–æ–Ω–∏–º–∞—é! –≠—Ç–æ **–∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ –º–µ–Ω—è–µ—Ç –ø–æ–¥—Ö–æ–¥**. –í–º–µ—Å—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω—É–∂–Ω–∞ **–Ω–∞—Ç–∏–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ UI iiko Front**, –∫–∞–∫ —É Premium Bonus.

–î–∞–≤–∞–π —è –ø–µ—Ä–µ—Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É—é —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –∑–∞–¥–∞–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:

***

## **üìã –£–¢–û–ß–ù–ï–ù–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø (–∏–∑ —Ç–≤–æ–µ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è)**

### **1. –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ UI**

‚úÖ **–í–∫–ª–∞–¥–∫–∞ "–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è"** –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ –∑–∞–∫–∞–∑–∞ (–Ω–µ –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞)

- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ Premium Bonus
- –í–∏–¥–Ω–∞ –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç –∑–∞–∫–∞–∑
- –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å


### **2. –î–æ—Å—Ç—É–ø**

‚úÖ **–õ—é–±–æ–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å –ø—Ä–∞–≤–∞–º–∏**: Manager, Cashier, Waiter

- –ù–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–∞—Å—Å–µ, –Ω–æ –∏ –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞—Ö –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–æ–≤
- –ü—Ä–∞–≤–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ iiko Back Office


### **3. Workflow**

```
1. –û—Ç–∫—Ä—ã—Ç –∑–∞–∫–∞–∑
2. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤–æ –≤–∫–ª–∞–¥–∫—É "–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è" ‚Üí "–õ–æ—è–ª—å–Ω–æ—Å—Ç—å"
3. –í–≤–æ–¥–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
4. –ù–∞—Ö–æ–¥–∏–º –≥–æ—Å—Ç—è ‚Üí –°–†–ê–ó–£ –≤–∏–¥–∏–º:
   - –ë–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤ (–∏–ª–∏ —Ä–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏)
   - –î–æ—Å—Ç—É–ø–Ω–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é
5. –í—ã–±–∏—Ä–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ:
   - "–ù–∞–∫–æ–ø–∏—Ç—å" - —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
   - "–°–ø–∏—Å–∞—Ç—å" - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –±–∞–ª–ª—ã/—Å–∫–∏–¥–∫—É
6. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É —Å –∑–∞–∫–∞–∑–æ–º (–¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã)
7. –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ "–û–ø–ª–∞—Ç—É":
   - –°–∫–∏–¥–∫–∞ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç—Å—è
   - –ú–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –∏–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É –ø—Ä—è–º–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã
8. –î–æ –∑–∞–∫—Ä—ã—Ç–∏—è —á–µ–∫–∞ –º–æ–∂–Ω–æ:
   - –û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É
   - –°–º–µ–Ω–∏—Ç—å –∫–∞—Ä—Ç—É
   - –ò–∑–º–µ–Ω–∏—Ç—å "–°–ø–∏—Å–∞—Ç—å"/"–ù–∞–∫–æ–ø–∏—Ç—å"
```


### **4. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–ª–∞—Ç—ã**

‚úÖ –°–∫–∏–¥–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç iiko (–Ω–µ –∫–∞–∫ –≤–Ω–µ—à–Ω—è—è —Å–∫–∏–¥–∫–∞)
‚úÖ –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Å—É–º–º—É —Å–ø–∏—Å–∞–Ω–∏—è –ø—Ä—è–º–æ —Ç–∞–º

***

## **‚ùì –ö–†–ò–¢–ò–ß–ù–´–ï –í–û–ü–†–û–°–´ –î–õ–Ø –¢–ê–ö–û–ô –ò–ù–¢–ï–ì–†–ê–¶–ò–ò**

### **üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ iiko Front Plugin API**

**–í–û–ü–†–û–° 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è custom panel –≤ UI**

–ù–∞—Å–∫–æ–ª—å–∫–æ —è –∑–Ω–∞—é, iiko Front Plugin API –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- ‚úÖ –î–æ–±–∞–≤–ª—è—Ç—å –∫–Ω–æ–ø–∫–∏ –≤ –º–µ–Ω—é
- ‚úÖ –û—Ç–∫—Ä—ã–≤–∞—Ç—å –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (WPF windows)
- ‚úÖ –ú–∞–Ω–∏–ø—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑–æ–º (–¥–æ–±–∞–≤–ª—è—Ç—å —Å–∫–∏–¥–∫–∏, —Ç–æ–≤–∞—Ä—ã)
- ‚ùì **–ù–û –≤–æ–ø—Ä–æ—Å:** –ú–æ–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å **custom panel/tab –≤–æ –≤–∫–ª–∞–¥–∫—É "–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è"**?

**–ú–û–Å –ü–†–ï–î–ü–û–õ–û–ñ–ï–ù–ò–ï:**

```csharp
// –í–æ–∑–º–æ–∂–Ω–æ –ª–∏ —Ç–∞–∫–æ–µ?
public void InitializePlugin(IPluginContext context)
{
    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å –≤ UI
    context.UI.RegisterOrderDetailPanel(
        panelName: "–õ–æ—è–ª—å–Ω–æ—Å—Ç—å",
        panelControl: new LoyaltyPanelControl(),
        location: PanelLocation.BottomTabs // "–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è"
    );
}
```

**–ï—Å–ª–∏ –ù–ï–¢ —Ç–∞–∫–æ–≥–æ API:**

- –ù—É–∂–µ–Ω –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –∫–Ω–æ–ø–∫–∞ + –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–≤–µ—Ä—Ö –∑–∞–∫–∞–∑–∞ (–Ω–µ fullscreen modal)

***

**–í–û–ü–†–û–° 2: –°–∫–∏–¥–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã**

Premium Bonus –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–∫–∏–¥–∫—É —Ç–∞–∫, —á—Ç–æ –æ–Ω–∞ **—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è –ø—Ä—è–º–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã**.

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏?**

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ü–ª–∞–≥–∏–Ω —Å–æ–∑–¥–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–∏–ø —Å–∫–∏–¥–∫–∏ —Å —Ñ–ª–∞–≥–æ–º `IsEditable = true`
- **B)** iiko Front –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞–µ—Ç –≤—Å–µ —Å–∫–∏–¥–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º–∏
- **C)** –≠—Ç–æ custom UI —ç–ª–µ–º–µ–Ω—Ç –æ—Ç Premium Bonus (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API)

**–ú–û–Å –ü–†–ï–î–ü–û–õ–û–ñ–ï–ù–ò–ï:**

```csharp
var discount = operations.CreateDiscount(
    name: "–ë–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏",
    sum: pointsToSpend,
    guest: null
);

// –î–µ–ª–∞–µ–º —Å–∫–∏–¥–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π?
discount.IsManuallyAdjustable = true; // –ï—Å–ª–∏ —Ç–∞–∫–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –µ—Å—Ç—å

operations.AddDiscount(discount, order);
```

**–ù–£–ñ–ù–û –ü–†–û–í–ï–†–ò–¢–¨:** –ï—Å—Ç—å –ª–∏ –≤ iiko API —Å–ø–æ—Å–æ–± —Å–¥–µ–ª–∞—Ç—å —Å–∫–∏–¥–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã?

***

**–í–û–ü–†–û–° 3: –ü—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã –∫ –∑–∞–∫–∞–∑—É –±–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏**

–ö–æ–≥–¥–∞ –Ω–∞–∂–∏–º–∞–µ–º "–ù–∞–∫–æ–ø–∏—Ç—å" (–±–µ–∑ —Å–ø–∏—Å–∞–Ω–∏—è), –Ω—É–∂–Ω–æ:

- –ó–∞–ø–æ–º–Ω–∏—Ç—å —á—Ç–æ –∫ –∑–∞–∫–∞–∑—É –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫–∞—Ä—Ç–∞ –≥–æ—Å—Ç—è
- –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ–∫–∞ ‚Üí –Ω–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã
- –ù–ï –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å–∫–∏–¥–∫—É

**–ö–∞–∫ —Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç—É —Å–≤—è–∑—å?**

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ß–µ—Ä–µ–∑ `order.ExternalData` (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–∫–æ–µ API)
- **B)** –ß–µ—Ä–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É
- **C)** –ß–µ—Ä–µ–∑ –Ω–µ–≤–∏–¥–∏–º—ã–π —Ç–æ–≤–∞—Ä —Å –Ω—É–ª–µ–≤–æ–π —Ü–µ–Ω–æ–π (—Ö–∞–∫)
- **D)** –í –ø–ª–∞–≥–∏–Ω–µ –≤ –ø–∞–º—è—Ç–∏ (OrderContextService)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:**

```csharp
// –î–æ–±–∞–≤–ª—è–µ–º metadata –∫ –∑–∞–∫–∞–∑—É
order.ExternalData["loyalty_card_id"] = guestCardId;
order.ExternalData["loyalty_action"] = "EARN_ONLY"; // –∏–ª–∏ "SPEND"

// –ü—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è —á–µ–∫–∞ —á–∏—Ç–∞–µ–º metadata
context.Operations.OrderClosed += async (sender, args) =>
{
    var cardId = args.Order.ExternalData["loyalty_card_id"];
    if (cardId != null)
    {
        await ProcessLoyaltyOnOrderClose(args.Order, cardId);
    }
};
```

**–ù–£–ñ–ù–û –ü–†–û–í–ï–†–ò–¢–¨:** –ï—Å—Ç—å –ª–∏ `ExternalData` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥ –≤ iiko Order API?

***

**–í–û–ü–†–û–° 4: –û—Ç–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —á–µ–∫–∞**

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç:

1. –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É ‚Üí –Ω–∞–∂–∞—Ç—å "–°–ø–∏—Å–∞—Ç—å" ‚Üí —Å–∫–∏–¥–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞
2. –ü–µ—Ä–µ–¥—É–º–∞—Ç—å ‚Üí –Ω–∞–∂–∞—Ç—å "–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É"
3. –°–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—å—Å—è**

**–ö–∞–∫ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å?**

```csharp
// –ü—Ä–∏ –æ—Ç–≤—è–∑–∫–µ
private void OnUnbindCard()
{
    // 1. –£–¥–∞–ª—è–µ–º —Å–∫–∏–¥–∫—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
    var loyaltyDiscounts = currentOrder.Discounts
        .Where(d => d.Comment?.Contains("Loyalty:") == true);
    
    foreach (var discount in loyaltyDiscounts)
    {
        operations.DeleteDiscount(discount, currentOrder);
    }
    
    // 2. –û—á–∏—â–∞–µ–º metadata
    currentOrder.ExternalData.Remove("loyalty_card_id");
    
    // 3. –£–≤–µ–¥–æ–º–ª—è–µ–º backend –æ–± –æ—Ç–º–µ–Ω–µ
    await apiClient.CancelLoyaltyReservationAsync(orderId);
    
    // 4. –û–±–Ω–æ–≤–ª—è–µ–º UI –ø–∞–Ω–µ–ª–∏
    ClearLoyaltyPanel();
}
```


***

**–í–û–ü–†–û–° 5: –°–º–µ–Ω–∞ –∫–∞—Ä—Ç—ã (–±—ã–ª–∞ –æ–¥–Ω–∞, –ø—Ä–∏–≤—è–∑–∞–ª–∏ –¥—Ä—É–≥—É—é)**

**Workflow:**

1. –ü—Ä–∏–≤—è–∑–∞–Ω–∞ –∫–∞—Ä—Ç–∞ –≥–æ—Å—Ç—è –ê ‚Üí —Å–∫–∏–¥–∫–∞ 200‚ÇΩ
2. –í–≤–µ–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –≥–æ—Å—Ç—è –ë ‚Üí –Ω–∞—à–ª–∏ ‚Üí –Ω–∞–∂–∞–ª–∏ "–°–ø–∏—Å–∞—Ç—å"
3. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –û—à–∏–±–∫–∞: "–°–Ω–∞—á–∞–ª–∞ –æ—Ç–≤—è–∂–∏—Ç–µ —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç—É"
- **B)** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–≤—è–∑—ã–≤–∞–µ–º –ê, –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –ë, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–∏–¥–∫—É
- **C)** –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: "–ó–∞–º–µ–Ω–∏—Ç—å –∫–∞—Ä—Ç—É –ê –Ω–∞ –ë?"

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º**

```csharp
if (currentOrder.HasLoyaltyCard())
{
    var result = MessageBox.Show(
        $"–ö –∑–∞–∫–∞–∑—É —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫–∞—Ä—Ç–∞:\n{currentGuest.Name} ({currentGuest.Phone})\n\n" +
        $"–ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞:\n{newGuest.Name} ({newGuest.Phone})?",
        "–ó–∞–º–µ–Ω–∞ –∫–∞—Ä—Ç—ã",
        MessageBoxButton.YesNo
    );
    
    if (result == MessageBoxResult.Yes)
    {
        await UnbindCurrentCard();
        await BindNewCard(newGuest);
    }
}
```


***

## **üé® –ü–†–ï–î–õ–ê–ì–ê–ï–ú–´–ô UI (—É—á–∏—Ç—ã–≤–∞—è —Ç–≤–æ–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)**

### **–í–∞—Ä–∏–∞–Ω—Ç 1: Custom Panel (–µ—Å–ª–∏ API –ø–æ–∑–≤–æ–ª—è–µ—Ç)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ iiko Front - –ó–∞–∫–∞–∑ #123                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –¢–æ–≤–∞—Ä—ã:                                                  ‚îÇ
‚îÇ ‚Ä¢ –ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞  500‚ÇΩ                                 ‚îÇ
‚îÇ ‚Ä¢ Coca-Cola        100‚ÇΩ                                 ‚îÇ
‚îÇ                                         –ò–¢–û–ì–û: 600‚ÇΩ     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ [–û–±—â–µ–µ] [–ì–æ—Å—Ç–∏] [–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è] ‚Üê –í–ö–õ–ê–î–ö–ò –í–ù–ò–ó–£           ‚îÇ
‚îÇ                  ‚îî‚îÄ‚îÄ –ù–ê–®–ê –í–ö–õ–ê–î–ö–ê                        ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ –î–û–ü–û–õ–ù–ï–ù–ò–Ø: –õ–æ—è–ª—å–Ω–æ—Å—Ç—å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ ‚îÇ                                                  ‚îÇ     ‚îÇ
‚îÇ ‚îÇ –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è:                                     ‚îÇ     ‚îÇ
‚îÇ ‚îÇ [+7 999 123 45 67            ] [–ù–∞–π—Ç–∏]          ‚îÇ     ‚îÇ
‚îÇ ‚îÇ                                                  ‚îÇ     ‚îÇ
‚îÇ ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ           ‚îÇ     ‚îÇ
‚îÇ ‚îÇ                                                  ‚îÇ     ‚îÇ
‚îÇ ‚îÇ üë§ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ ‚Ä¢ +7 999 123 45 67               ‚îÇ     ‚îÇ
‚îÇ ‚îÇ ‚≠ê Gold                                          ‚îÇ     ‚îÇ
‚îÇ ‚îÇ                                                  ‚îÇ     ‚îÇ
‚îÇ ‚îÇ üí∞ –ë–∞–ª–∞–Ω—Å: 2,450‚ÇΩ  |  –î–æ—Å—Ç—É–ø–Ω–æ: –¥–æ 120‚ÇΩ        ‚îÇ     ‚îÇ
‚îÇ ‚îÇ                                                  ‚îÇ     ‚îÇ
‚îÇ ‚îÇ [‚úì –ù–∞–∫–æ–ø–∏—Ç—å] [–°–ø–∏—Å–∞—Ç—å 120‚ÇΩ]  [‚ùå –û—Ç–≤—è–∑–∞—Ç—å]     ‚îÇ     ‚îÇ
‚îÇ ‚îÇ                                                  ‚îÇ     ‚îÇ
‚îÇ ‚îÇ –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +30 –±–∞–ª–ª–æ–≤                      ‚îÇ     ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **–í–∞—Ä–∏–∞–Ω—Ç 2: Compact Side Panel (–µ—Å–ª–∏ custom tabs –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ iiko Front - –ó–∞–∫–∞–∑ #123                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –¢–æ–≤–∞—Ä—ã:                        ‚îÇ üéÅ –õ–û–Ø–õ–¨–ù–û–°–¢–¨         ‚îÇ
‚îÇ ‚Ä¢ –ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞  500‚ÇΩ        ‚îÇ                        ‚îÇ
‚îÇ ‚Ä¢ Coca-Cola        100‚ÇΩ        ‚îÇ üë§ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤        ‚îÇ
‚îÇ                                ‚îÇ üí∞ 2,450‚ÇΩ             ‚îÇ
‚îÇ                                ‚îÇ                        ‚îÇ
‚îÇ                                ‚îÇ –î–æ—Å—Ç—É–ø–Ω–æ: 120‚ÇΩ        ‚îÇ
‚îÇ                                ‚îÇ                        ‚îÇ
‚îÇ                                ‚îÇ [–°–ø–∏—Å–∞—Ç—å 120‚ÇΩ]        ‚îÇ
‚îÇ                                ‚îÇ [–ù–∞–∫–æ–ø–∏—Ç—å]            ‚îÇ
‚îÇ                                ‚îÇ                        ‚îÇ
‚îÇ             –ò–¢–û–ì–û: 600‚ÇΩ        ‚îÇ –ù–∞—á–∏—Å–ª–∏—Ç—Å—è: +30       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ [–û–ø–ª–∞—Ç–∏—Ç—å]  [–ì–æ—Å—Ç–∏]  [–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è]                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## **üöÄ –ß–¢–û –ú–ù–ï –ù–£–ñ–ù–û –û–¢ –¢–ï–ë–Ø**

**1. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å:**

- –ï—Å—Ç—å –ª–∏ –≤ iiko Front Plugin API —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è custom panels/tabs?
- –ú–æ–∂–Ω–æ –ª–∏ —Å–¥–µ–ª–∞—Ç—å —Å–∫–∏–¥–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã?
- –ï—Å—Ç—å –ª–∏ —Å–ø–æ—Å–æ–± —Ö—Ä–∞–Ω–∏—Ç—å metadata –∫ –∑–∞–∫–∞–∑—É?

**2. –£—Ç–æ—á–Ω–∏ –¥–µ—Ç–∞–ª–∏:**

- –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞—Ä—Ç—ã?
- –ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏?
- –ö–∞–∫ –¥–æ–ª–∂–Ω–∞ –≤—ã–≥–ª—è–¥–µ—Ç—å –ø–∞–Ω–µ–ª—å —Ç–æ—á–Ω–æ? (–∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –∏–ª–∏ –ø–æ–ª–Ω–∞—è –≤—ã—Å–æ—Ç–∞)

**3. –ü–æ–∫–∞–∂–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç Premium Bonus:**

- –ï—Å–ª–∏ –º–æ–∂–µ—à—å –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Å–∫—Ä–∏–Ω - –±—É–¥–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–Ω—è—Ç—å –∫–∞–∫ —Ç–æ—á–Ω–æ –¥–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å

***

**–ü–æ—Å–ª–µ —Ç–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ —è –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É—é –≤—Å–µ 40+ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–¥ —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥!**

–ü–æ–Ω—è–ª —Å—É—Ç—å? –ò–ª–∏ –Ω—É–∂–Ω—ã –µ—â–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è? üéØ

---

# üéØ **–û–¢–õ–ò–ß–ù–û! –¢–ï–ü–ï–†–¨ –í–°–Å –ê–ë–°–û–õ–Æ–¢–ù–û –Ø–°–ù–û!**

–°–ø–∞—Å–∏–±–æ –∑–∞ —Ñ–æ—Ç–æ! –¢–µ–ø–µ—Ä—å —è **–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–Ω–∏–º–∞—é** –∫–∞–∫ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å. –î–∞–≤–∞–π –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —á—Ç–æ —è —É–≤–∏–¥–µ–ª:

***

## **üì∏ –ê–ù–ê–õ–ò–ó PREMIUM BONUS –ò–ó –°–ö–†–ò–ù–®–û–¢–û–í**

### **üîç –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–∫—Ä—ã—Ç–∏—è:**

#### **1. –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ UI** ‚úÖ

- **"–î–û–ü–û–õ–ù–ï–ù–ò–Ø"** - —ç—Ç–æ –∫–Ω–æ–ø–∫–∞ –≤ –Ω–∏–∂–Ω–µ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è **–º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏** —Å–æ —Å–ø–∏—Å–∫–æ–º –ø–ª–∞–≥–∏–Ω–æ–≤
- "Premium Bonus" - –æ–¥–∏–Ω –∏–∑ –ø—É–Ω–∫—Ç–æ–≤ —ç—Ç–æ–≥–æ –º–µ–Ω—é


#### **2. Workflow** ‚úÖ

```
–®–∞–≥ 1: –î–û–ü–û–õ–ù–ï–ù–ò–Ø ‚Üí Premium Bonus (–∏–∑ —Å–ø–∏—Å–∫–∞)
–®–∞–≥ 2: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–ü–†–ï–ú–ò–£–ú –ë–û–ù–£–°"
        ‚îú‚îÄ "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ –ø—Ä–æ–≤–µ–¥–∏—Ç–µ –∫–∞—Ä—Ç–æ–π"
        ‚îú‚îÄ "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –∏–ª–∏ –∫–æ–¥"
        ‚îî‚îÄ –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
        
–®–∞–≥ 3: –ü–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞ ‚Üí –æ–∫–Ω–æ "–°–ø–∏—Å–∞–Ω–∏–µ/–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ"
        ‚îú‚îÄ –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏: 890
        ‚îú‚îÄ –ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å: 327
        ‚îú‚îÄ –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è: 178
        ‚îú‚îÄ –û–ø–ª–∞—Ç–∞ —Å –∫–∞—Ä—Ç—ã: 0
        ‚îú‚îÄ –°–∫–∏–¥–∫–∞: 0
        ‚îî‚îÄ –ö–Ω–æ–ø–∫–∏: [–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ—á–µ–∫] [–ù–∞—á–∏—Å–ª–∏—Ç—å] [–°–ø–∏—Å–∞—Ç—å] [–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É] [–û—Ç–º–µ–Ω–∞]

–®–∞–≥ 4: –ù–∞–∂–∏–º–∞–µ–º "–°–ø–∏—Å–∞—Ç—å" ‚Üí –æ–∫–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è

–®–∞–≥ 5: –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ "–û–ø–ª–∞—Ç—É" ‚Üí –≤–∏–¥–∏–º:
        ‚îú‚îÄ PREMIUMBONUS PAYMENT: 178,00 —Ä.
        ‚îî‚îÄ –ù–ê–õ–ò–ß–ù–´–ï: 712,00 —Ä.
```


#### **3. –ö–†–ò–¢–ò–ß–ù–û: –ë–æ–Ω—É—Å—ã = PAYMENT TYPE, –ù–ï DISCOUNT!** üî•

–ù–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã –±–æ–Ω—É—Å—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ **"PREMIUMBONUS PAYMENT"** - —ç—Ç–æ **—Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã**, –∞ –Ω–µ —Å–∫–∏–¥–∫–∞!

**–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:**

```csharp
// ‚ùå –ù–ï –¢–ê–ö (–∫–∞–∫ —è –ø—Ä–µ–¥–ª–∞–≥–∞–ª —Ä–∞–Ω–µ–µ):
var discount = operations.CreateDiscount("–ë–∞–ª–ª—ã", 178);
operations.AddDiscount(discount, order);

// ‚úÖ –¢–ê–ö:
var payment = operations.CreatePayment(
    paymentType: "LOYALTY_POINTS", // –ò–ª–∏ –∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–∏–ø
    sum: 178
);
operations.AddPreliminaryPayment(payment, order);
```


***

## **üÜï –ü–ï–†–ï–û–°–ú–´–°–õ–ï–ù–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–õ–ê–ì–ò–ù–ê**

### **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥:**

```csharp
public class LoyaltyPlugin : IFrontPlugin
{
    public void InitializePlugin(IPluginContext context)
    {
        // 1. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É –≤ –º–µ–Ω—é "–î–û–ü–û–õ–ù–ï–ù–ò–Ø"
        var loyaltyButton = context.Operations.RegisterButton(
            buttonText: "Max Loyalty",
            buttonCategory: ButtonCategory.Additions, // "–î–û–ü–û–õ–ù–ï–ù–ò–Ø"
            handler: OnLoyaltyButtonClick
        );
        
        // 2. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º custom payment type
        var loyaltyPaymentType = context.Operations.RegisterPaymentType(
            name: "MAX_LOYALTY_POINTS",
            displayName: "–ë–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏",
            canBeProcessedExternally: true // –ú—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ backend
        );
        
        // 3. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è
        context.Operations.BeforeOrderClose += OnBeforeOrderClose;
        context.Operations.OrderClosed += OnOrderClosed;
    }
    
    private void OnLoyaltyButtonClick(IOrder order, IOperationService operations)
    {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –∫–∞—Ä—Ç—ã
        var searchWindow = new LoyaltySearchWindow(order, operations);
        
        if (searchWindow.ShowDialog() == true)
        {
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–°–ø–∏—Å–∞—Ç—å"
            if (searchWindow.SelectedAction == LoyaltyAction.Spend)
            {
                // –î–æ–±–∞–≤–ª—è–µ–º preliminary payment
                var payment = operations.CreatePayment(
                    paymentType: loyaltyPaymentType,
                    sum: searchWindow.PointsToSpend
                );
                
                operations.AddPreliminaryPayment(payment, order);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º metadata –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
                SaveOrderLoyaltyContext(order, new LoyaltyContext
                {
                    GuestCardId = searchWindow.GuestCardId,
                    Action = LoyaltyAction.Spend,
                    PointsToSpend = searchWindow.PointsToSpend,
                    OriginalCheckAmount = order.GetTotalAmount()
                });
            }
            else // –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
            {
                SaveOrderLoyaltyContext(order, new LoyaltyContext
                {
                    GuestCardId = searchWindow.GuestCardId,
                    Action = LoyaltyAction.EarnOnly,
                    OriginalCheckAmount = order.GetTotalAmount()
                });
            }
        }
    }
    
    // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ–∫–∞ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
    private async void OnOrderClosed(object sender, OrderClosedEventArgs e)
    {
        var context = GetOrderLoyaltyContext(e.Order);
        
        if (context == null)
            return; // –ù–µ—Ç –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ —ç—Ç–æ–º –∑–∞–∫–∞–∑–µ
        
        try
        {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ backend
            await apiClient.FinalizeOrderAsync(new FinalizeRequest
            {
                GuestCardId = context.GuestCardId,
                OrderId = e.Order.Id.ToString(),
                CheckAmount = context.OriginalCheckAmount,
                PointsSpent = context.PointsToSpend,
                PaymentTypes = e.Order.GetPayments().Select(p => p.Type.Name).ToList()
            });
            
            logger.LogInformation("Loyalty finalized for order {OrderId}", e.Order.Id);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to finalize loyalty");
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ offline queue
            offlineQueue.Enqueue(context);
        }
    }
}
```


***

## **üé® UI –û–ö–ù–ê (–ö–ê–ö –í PREMIUM BONUS)**

### **–û–∫–Ω–æ 1: –ü–æ–∏—Å–∫ –∫–∞—Ä—Ç—ã**

```xaml
<Window Title="Max Loyalty - –ü–æ–∏—Å–∫ –∫–∞—Ä—Ç—ã" 
        Width="600" 
        Height="500"
        WindowStartupLocation="CenterScreen"
        Background="#2a2a2a">
  
  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <Border Grid.Row="0" Background="#1e40af" Padding="20">
      <TextBlock Text="MAX LOYALTY" 
                 FontSize="20" 
                 FontWeight="Bold"
                 Foreground="White"
                 HorizontalAlignment="Center"/>
    </Border>
    
    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <StackPanel Grid.Row="1" Margin="30">
      <TextBlock Text="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥" 
                 FontSize="14"
                 Foreground="White"
                 HorizontalAlignment="Center"
                 Margin="0,20,0,30"/>
      
      <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
      <TextBox x:Name="InputField"
               FontSize="24"
               Height="60"
               TextAlignment="Center"
               Background="#3a3a3a"
               Foreground="White"
               BorderBrush="#4a4a4a"
               BorderThickness="2"
               Padding="10"
               Margin="0,0,0,20"/>
      
      <!-- –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ -->
      <UniformGrid Rows="4" Columns="3" 
                   Width="300" Height="240">
        <Button Content="1" Style="{StaticResource NumpadButton}"/>
        <Button Content="2" Style="{StaticResource NumpadButton}"/>
        <Button Content="3" Style="{StaticResource NumpadButton}"/>
        <Button Content="4" Style="{StaticResource NumpadButton}"/>
        <Button Content="5" Style="{StaticResource NumpadButton}"/>
        <Button Content="6" Style="{StaticResource NumpadButton}"/>
        <Button Content="7" Style="{StaticResource NumpadButton}"/>
        <Button Content="8" Style="{StaticResource NumpadButton}"/>
        <Button Content="9" Style="{StaticResource NumpadButton}"/>
        <Button Content="‚Üê" Style="{StaticResource NumpadButton}"/>
        <Button Content="0" Style="{StaticResource NumpadButton}"/>
        <Button Content="‚úì" Style="{StaticResource NumpadButton}" Foreground="LimeGreen"/>
      </UniformGrid>
    </StackPanel>
    
    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <StackPanel Grid.Row="2" 
                Orientation="Horizontal" 
                HorizontalAlignment="Center"
                Margin="20">
      <Button Content="OK" 
              Width="120" 
              Height="50"
              Margin="10"
              Click="OnOkClick"/>
      <Button Content="–û—Ç–º–µ–Ω–∞" 
              Width="120" 
              Height="50"
              Margin="10"
              Click="OnCancelClick"/>
    </StackPanel>
  </Grid>
</Window>
```


### **–û–∫–Ω–æ 2: –°–ø–∏—Å–∞–Ω–∏–µ/–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ**

```xaml
<Window Title="Max Loyalty - –°–ø–∏—Å–∞–Ω–∏–µ/–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ" 
        Width="800" 
        Height="600"
        Background="#2a2a2a">
  
  <Grid>
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="*"/>
      <ColumnDefinition Width="300"/>
    </Grid.ColumnDefinitions>
    
    <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –û–ø–µ—Ä–∞—Ü–∏—è -->
    <StackPanel Grid.Column="0" Margin="20">
      <TextBlock Text="–°–ø–∏—Å–∞–Ω–∏–µ/–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ" 
                 FontSize="20"
                 FontWeight="Bold"
                 Foreground="#fbbf24"
                 Margin="0,0,0,20"/>
      
      <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="200"/>
          <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
          <RowDefinition Height="50"/>
          <RowDefinition Height="50"/>
          <RowDefinition Height="50"/>
          <RowDefinition Height="50"/>
          <RowDefinition Height="50"/>
        </Grid.RowDefinitions>
        
        <TextBlock Grid.Row="0" Grid.Column="0" 
                   Text="–°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏" 
                   Foreground="White" 
                   VerticalAlignment="Center"/>
        <TextBox Grid.Row="0" Grid.Column="1" 
                 Text="{Binding CheckAmount}" 
                 IsReadOnly="True"
                 Background="#3a3a3a"
                 Foreground="White"/>
        
        <TextBlock Grid.Row="1" Grid.Column="0" 
                   Text="–ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å" 
                   Foreground="White" 
                   VerticalAlignment="Center"/>
        <TextBox Grid.Row="1" Grid.Column="1" 
                 Text="{Binding TotalBalance}" 
                 IsReadOnly="True"
                 Background="#3a3a3a"
                 Foreground="LimeGreen"
                 FontWeight="Bold"/>
        
        <TextBlock Grid.Row="2" Grid.Column="0" 
                   Text="–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è" 
                   Foreground="White" 
                   VerticalAlignment="Center"/>
        <TextBox Grid.Row="2" Grid.Column="1" 
                 Text="{Binding MaxAllowed}" 
                 IsReadOnly="True"
                 Background="#3a3a3a"
                 Foreground="Orange"/>
        
        <TextBlock Grid.Row="3" Grid.Column="0" 
                   Text="–û–ø–ª–∞—Ç–∞ —Å –∫–∞—Ä—Ç—ã" 
                   Foreground="White" 
                   VerticalAlignment="Center"/>
        <TextBox Grid.Row="3" Grid.Column="1" 
                 Text="{Binding PointsToSpend}" 
                 Background="#3a3a3a"
                 Foreground="White"/>
        
        <TextBlock Grid.Row="4" Grid.Column="0" 
                   Text="–°–∫–∏–¥–∫–∞" 
                   Foreground="White" 
                   VerticalAlignment="Center"/>
        <TextBox Grid.Row="4" Grid.Column="1" 
                 Text="0" 
                 IsReadOnly="True"
                 Background="#3a3a3a"
                 Foreground="White"/>
      </Grid>
      
      <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
      <StackPanel Orientation="Horizontal" 
                  HorizontalAlignment="Center"
                  Margin="0,40,0,0">
        <Button Content="–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ—á–µ–∫" 
                Width="150" 
                Height="50"
                Margin="5"/>
        <Button Content="–ù–∞—á–∏—Å–ª–∏—Ç—å" 
                Width="150" 
                Height="50"
                Margin="5"
                Click="OnEarnClick"/>
        <Button Content="–°–ø–∏—Å–∞—Ç—å" 
                Width="150" 
                Height="50"
                Margin="5"
                Background="#10b981"
                Click="OnSpendClick"/>
        <Button Content="–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É" 
                Width="150" 
                Height="50"
                Margin="5"
                Background="#ef4444"
                Click="OnUnbindClick"/>
        <Button Content="–û—Ç–º–µ–Ω–∞" 
                Width="120" 
                Height="50"
                Margin="5"
                Click="OnCancelClick"/>
      </StackPanel>
    </StackPanel>
    
    <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–æ—Å—Ç–µ -->
    <Border Grid.Column="1" 
            Background="#3a3a3a" 
            Padding="15">
      <StackPanel>
        <TextBlock Text="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–æ—Å—Ç–µ" 
                   FontSize="14"
                   FontWeight="Bold"
                   Foreground="White"
                   Margin="0,0,0,15"/>
        
        <TextBlock Text="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" 
                   Foreground="Gray" 
                   FontSize="11"/>
        <TextBox Text="{Binding Phone}" 
                 IsReadOnly="True"
                 Margin="0,5,0,15"/>
        
        <TextBlock Text="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã" 
                   Foreground="Gray" 
                   FontSize="11"/>
        <TextBox Text="{Binding CardNumber}" 
                 IsReadOnly="True"
                 Margin="0,5,0,15"/>
        
        <TextBlock Text="–ò–º—è" 
                   Foreground="Gray" 
                   FontSize="11"/>
        <TextBox Text="{Binding Name}" 
                 IsReadOnly="True"
                 Margin="0,5,0,15"/>
        
        <TextBlock Text="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è" 
                   Foreground="Gray" 
                   FontSize="11"/>
        <TextBox Text="{Binding BirthDate}" 
                 IsReadOnly="True"
                 Margin="0,5,0,15"/>
        
        <TextBlock Text="–£—Ä–æ–≤–µ–Ω—å" 
                   Foreground="Gray" 
                   FontSize="11"/>
        <TextBox Text="{Binding LevelName}" 
                 IsReadOnly="True"
                 Background="#fbbf24"
                 Foreground="Black"
                 FontWeight="Bold"
                 Margin="0,5,0,0"/>
      </StackPanel>
    </Border>
  </Grid>
</Window>
```


***

## **üî• 40+ –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–ù–´–• –í–û–ü–†–û–°–û–í**

–¢–µ–ø–µ—Ä—å —è –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É—é **–í–°–ï 40 –≤–æ–ø—Ä–æ—Å–æ–≤** —Å —É—á–µ—Ç–æ–º —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞. –ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å?

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö:**

1. ‚ùå –£–±–∏—Ä–∞–µ–º "custom panel –≤ UI"
2. ‚úÖ –§–æ–∫—É—Å –Ω–∞ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö (–∫–∞–∫ Premium Bonus)
3. ‚úÖ Payment Type –≤–º–µ—Å—Ç–æ Discount
4. ‚úÖ Preliminary payments
5. ‚úÖ Finalization –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ–∫–∞

**–ù–∞—á–∞—Ç—å –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É –≤—Å–µ—Ö –≤–æ–ø—Ä–æ—Å–æ–≤?** üöÄ
<span style="display:none">[^19_1][^19_2][^19_3][^19_4][^19_5][^19_6]</span>

<div align="center">‚ÅÇ</div>

[^19_1]: IMG_20260217_130830.jpg

[^19_2]: IMG_20260217_125232.jpg

[^19_3]: IMG_20260217_125043.jpg

[^19_4]: IMG_20260217_125033.jpg

[^19_5]: IMG_20260217_125039.jpg

[^19_6]: IMG_20260217_125035.jpg


---

# üéØ **–¢–û–ß–ù–û! –ü–û–î–î–ï–†–ñ–ö–ê –û–ë–û–ò–• –¢–ò–ü–û–í: PAYMENT + DISCOUNT**

–°–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –≤–µ—Ä–Ω–æ! –Ø —É–ø—É—Å—Ç–∏–ª —ç—Ç–æ. –î–∞–≤–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:

***

## **üìä –î–í–ê –¢–ò–ü–ê –õ–û–Ø–õ–¨–ù–û–°–¢–ò –í –°–ò–°–¢–ï–ú–ï**

### **–ò–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –±–µ—Å–µ–¥ (–ë–µ—Å–µ–¥–∞ 5, 6):**

```typescript
// 1. –ù–∞ —É—Ä–æ–≤–Ω–µ —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
enum LoyaltySystemType {
  POINTS      // –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è (–±–∞–ª–ª—ã = —Ä—É–±–ª–∏)
  DISCOUNT    // –°–∫–∏–¥–æ—á–Ω–∞—è (–ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏)
  HYBRID      // –ì–∏–±—Ä–∏–¥–Ω–∞—è (–æ–±–∞ —Ç–∏–ø–∞)
}

// 2. –ù–∞ —É—Ä–æ–≤–Ω–µ –∫–∞—Ä—Ç—ã –≥–æ—Å—Ç—è/—É—Ä–æ–≤–Ω—è
enum LevelType {
  POINTS      // –£ —ç—Ç–æ–≥–æ –≥–æ—Å—Ç—è –±–∞–ª–ª—ã
  DISCOUNT    // –£ —ç—Ç–æ–≥–æ –≥–æ—Å—Ç—è —Å–∫–∏–¥–∫–∞ –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É
}
```


### **Backend Calculate Response:**

```typescript
// Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¢–ò–ü –±–µ–Ω–µ—Ñ–∏—Ç–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥–æ—Å—Ç—è
interface CalculateResponse {
  guestCardId: string;
  benefitType: 'POINTS' | 'DISCOUNT';  // –¢–ò–ü –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Å—Ç—è
  
  // –ï—Å–ª–∏ POINTS:
  regularBalance?: number;
  promoBalance?: number;
  maxAllowedToSpend?: number;
  pointsToEarn?: number;
  
  // –ï—Å–ª–∏ DISCOUNT:
  discountPercentage?: number;  // 10%, 15%, 20% –∏ —Ç.–¥.
  discountAmount?: number;      // –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è —Å—É–º–º–∞ —Å–∫–∏–¥–∫–∏
  canCombineWithOther?: boolean;
  
  checkAmount: number;
  balanceVersion: number;
}
```


***

## **üîß –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–õ–ê–ì–ò–ù–ê**

### **1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–∞ —Å –î–í–£–ú–Ø —Ç–∏–ø–∞–º–∏**

```csharp
public class LoyaltyPlugin : IFrontPlugin
{
    private IPaymentType loyaltyPaymentType;
    private IDiscountType loyaltyDiscountType;
    
    public void InitializePlugin(IPluginContext context)
    {
        // 1. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤ "–î–û–ü–û–õ–ù–ï–ù–ò–Ø"
        context.Operations.RegisterButton(
            buttonText: "Max Loyalty",
            buttonCategory: ButtonCategory.Additions,
            handler: OnLoyaltyButtonClick
        );
        
        // 2. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º PAYMENT TYPE (–¥–ª—è –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–π)
        loyaltyPaymentType = context.Operations.RegisterPaymentType(
            name: "MAX_LOYALTY_POINTS",
            displayName: "–ë–∞–ª–ª—ã Max Loyalty",
            canBeProcessedExternally: true
        );
        
        // 3. –ù–∞—Ö–æ–¥–∏–º DISCOUNT TYPE (–¥–ª—è —Å–∫–∏–¥–æ—á–Ω–æ–π)
        // –ê–¥–º–∏–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å —Ç–∏–ø —Å–∫–∏–¥–∫–∏ "Max Loyalty" –≤ iiko Back Office
        loyaltyDiscountType = context.Operations.GetDiscountTypes()
            .FirstOrDefault(dt => dt.Name.Contains("Max Loyalty"));
        
        if (loyaltyDiscountType == null)
        {
            logger.LogWarning(
                "Discount type 'Max Loyalty' not found. " +
                "Percentage discounts will not work. " +
                "Please create it in iiko Back Office."
            );
        }
        
        // 4. –°–æ–±—ã—Ç–∏—è
        context.Operations.BeforeOrderClose += OnBeforeOrderClose;
        context.Operations.OrderClosed += OnOrderClosed;
    }
}
```


***

## **üí° WORKFLOW –° –£–ß–ï–¢–û–ú –¢–ò–ü–ê**

### **–®–∞–≥ 1: –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è + Calculate**

```csharp
private async void OnOkClick(object sender, RoutedEventArgs e)
{
    var input = InputField.Text.Trim();
    
    try
    {
        // 1. –ò—â–µ–º –≥–æ—Å—Ç—è
        var searchResponse = await apiClient.SearchGuestAsync(new SearchRequest
        {
            Phone = input // –∏–ª–∏ Code6Digit
        });
        
        if (!searchResponse.Found)
        {
            ShowError("–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
            return;
        }
        
        var guest = searchResponse.Guest;
        
        // 2. –í—ã–∑—ã–≤–∞–µ–º Calculate –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–µ–∫–∞
        var checkAmount = currentOrder.GetTotalAmount();
        
        var calcResponse = await apiClient.CalculateAsync(new CalculateRequest
        {
            GuestCardId = guest.CardId,
            CheckAmount = checkAmount,
            CalculateOnly = true
        });
        
        // 3. –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ –í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –¢–ò–ü–ê
        if (calcResponse.BenefitType == "POINTS")
        {
            // –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Üí –æ–∫–Ω–æ —Å–æ —Å–ø–∏—Å–∞–Ω–∏–µ–º –±–∞–ª–ª–æ–≤
            var operationWindow = new LoyaltyOperationWindow(
                guest: guest,
                calculation: calcResponse,
                order: currentOrder,
                mode: LoyaltyMode.Points
            );
            
            if (operationWindow.ShowDialog() == true)
            {
                await ApplyPointsLoyalty(operationWindow);
            }
        }
        else if (calcResponse.BenefitType == "DISCOUNT")
        {
            // –°–∫–∏–¥–æ—á–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Üí –æ–∫–Ω–æ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º —Å–∫–∏–¥–∫–∏
            var operationWindow = new LoyaltyOperationWindow(
                guest: guest,
                calculation: calcResponse,
                order: currentOrder,
                mode: LoyaltyMode.Discount
            );
            
            if (operationWindow.ShowDialog() == true)
            {
                await ApplyDiscountLoyalty(operationWindow);
            }
        }
    }
    catch (Exception ex)
    {
        HandleError(ex);
    }
}
```


***

## **üé® UI –û–ö–ù–ê "–û–ü–ï–†–ê–¶–ò–Ø" - –î–í–ê –í–ê–†–ò–ê–ù–¢–ê**

### **–í–∞—Ä–∏–∞–Ω—Ç A: –ù–ê–ö–û–ü–ò–¢–ï–õ–¨–ù–ê–Ø (POINTS)**

```xaml
<!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å –æ–∫–Ω–∞ –ø—Ä–∏ mode="Points" -->
<StackPanel x:Name="PointsModePanel" 
            Visibility="{Binding IsPointsMode}">
  
  <TextBlock Text="–°–ø–∏—Å–∞–Ω–∏–µ/–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤" 
             FontSize="20"
             FontWeight="Bold"
             Foreground="#fbbf24"/>
  
  <Grid Margin="0,20,0,0">
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="250"/>
      <ColumnDefinition Width="*"/>
    </Grid.ColumnDefinitions>
    <Grid.RowDefinitions>
      <RowDefinition Height="50"/>
      <RowDefinition Height="50"/>
      <RowDefinition Height="50"/>
      <RowDefinition Height="50"/>
      <RowDefinition Height="50"/>
    </Grid.RowDefinitions>
    
    <!-- –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏ -->
    <TextBlock Grid.Row="0" Grid.Column="0" 
               Text="–°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏" 
               Foreground="White"/>
    <TextBox Grid.Row="0" Grid.Column="1" 
             Text="{Binding CheckAmount, StringFormat='{}{0:N0}'}" 
             IsReadOnly="True"/>
    
    <!-- –ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å -->
    <TextBlock Grid.Row="1" Grid.Column="0" 
               Text="–ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å" 
               Foreground="White"/>
    <TextBox Grid.Row="1" Grid.Column="1" 
             Text="{Binding TotalBalance, StringFormat='{}{0:N0}'}" 
             IsReadOnly="True"
             Foreground="LimeGreen"
             FontWeight="Bold"/>
    
    <!-- –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è -->
    <TextBlock Grid.Row="2" Grid.Column="0" 
               Text="–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è" 
               Foreground="White"/>
    <TextBox Grid.Row="2" Grid.Column="1" 
             Text="{Binding MaxAllowed, StringFormat='{}{0:N0}'}" 
             IsReadOnly="True"
             Foreground="Orange"/>
    
    <!-- –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª–æ–≤ (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ) -->
    <TextBlock Grid.Row="3" Grid.Column="0" 
               Text="–°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª–æ–≤" 
               Foreground="White"/>
    <TextBox Grid.Row="3" Grid.Column="1" 
             x:Name="PointsToSpendInput"
             Text="{Binding PointsToSpend}"
             TextChanged="OnPointsToSpendChanged"/>
    
    <!-- –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ -->
    <TextBlock Grid.Row="4" Grid.Column="0" 
               Text="–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ" 
               Foreground="White"/>
    <TextBox Grid.Row="4" Grid.Column="1" 
             Text="{Binding PointsToEarn, StringFormat='+{0:N0}'}" 
             IsReadOnly="True"
             Foreground="LimeGreen"/>
  </Grid>
  
  <!-- –ö–Ω–æ–ø–∫–∏ -->
  <StackPanel Orientation="Horizontal" 
              HorizontalAlignment="Center"
              Margin="0,30,0,0">
    <Button Content="–ù–∞—á–∏—Å–ª–∏—Ç—å" 
            Width="150" 
            Height="50"
            Click="OnEarnClick"/>
    <Button Content="–°–ø–∏—Å–∞—Ç—å" 
            Width="150" 
            Height="50"
            Background="#10b981"
            Click="OnSpendPointsClick"
            IsEnabled="{Binding CanSpend}"/>
    <Button Content="–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É" 
            Width="150" 
            Height="50"
            Background="#ef4444"
            Click="OnUnbindClick"/>
    <Button Content="–û—Ç–º–µ–Ω–∞" 
            Width="120" 
            Height="50"
            Click="OnCancelClick"/>
  </StackPanel>
</StackPanel>
```


### **–í–∞—Ä–∏–∞–Ω—Ç B: –°–ö–ò–î–û–ß–ù–ê–Ø (DISCOUNT)**

```xaml
<!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å –æ–∫–Ω–∞ –ø—Ä–∏ mode="Discount" -->
<StackPanel x:Name="DiscountModePanel" 
            Visibility="{Binding IsDiscountMode}">
  
  <TextBlock Text="–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏" 
             FontSize="20"
             FontWeight="Bold"
             Foreground="#fbbf24"/>
  
  <Grid Margin="0,20,0,0">
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="250"/>
      <ColumnDefinition Width="*"/>
    </Grid.ColumnDefinitions>
    <Grid.RowDefinitions>
      <RowDefinition Height="50"/>
      <RowDefinition Height="50"/>
      <RowDefinition Height="50"/>
      <RowDefinition Height="50"/>
    </Grid.RowDefinitions>
    
    <!-- –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏ -->
    <TextBlock Grid.Row="0" Grid.Column="0" 
               Text="–°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏" 
               Foreground="White"/>
    <TextBox Grid.Row="0" Grid.Column="1" 
             Text="{Binding CheckAmount, StringFormat='{}{0:N0} ‚ÇΩ'}" 
             IsReadOnly="True"/>
    
    <!-- –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ -->
    <TextBlock Grid.Row="1" Grid.Column="0" 
               Text="–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏" 
               Foreground="White"/>
    <TextBox Grid.Row="1" Grid.Column="1" 
             Text="{Binding DiscountPercentage, StringFormat='{}{0}%'}" 
             IsReadOnly="True"
             Foreground="Orange"
             FontSize="18"
             FontWeight="Bold"/>
    
    <!-- –°—É–º–º–∞ —Å–∫–∏–¥–∫–∏ -->
    <TextBlock Grid.Row="2" Grid.Column="0" 
               Text="–°—É–º–º–∞ —Å–∫–∏–¥–∫–∏" 
               Foreground="White"/>
    <TextBox Grid.Row="2" Grid.Column="1" 
             Text="{Binding DiscountAmount, StringFormat='{}{0:N0} ‚ÇΩ'}" 
             IsReadOnly="True"
             Foreground="LimeGreen"
             FontSize="18"
             FontWeight="Bold"/>
    
    <!-- –ö –æ–ø–ª–∞—Ç–µ -->
    <TextBlock Grid.Row="3" Grid.Column="0" 
               Text="–ö –æ–ø–ª–∞—Ç–µ" 
               Foreground="White"/>
    <TextBox Grid.Row="3" Grid.Column="1" 
             Text="{Binding FinalAmount, StringFormat='{}{0:N0} ‚ÇΩ'}" 
             IsReadOnly="True"
             FontSize="18"
             FontWeight="Bold"/>
  </Grid>
  
  <!-- –ö–Ω–æ–ø–∫–∏ -->
  <StackPanel Orientation="Horizontal" 
              HorizontalAlignment="Center"
              Margin="0,30,0,0">
    <Button Content="–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É" 
            Width="180" 
            Height="50"
            Background="#10b981"
            Click="OnApplyDiscountClick"/>
    <Button Content="–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É" 
            Width="150" 
            Height="50"
            Background="#ef4444"
            Click="OnUnbindClick"/>
    <Button Content="–û—Ç–º–µ–Ω–∞" 
            Width="120" 
            Height="50"
            Click="OnCancelClick"/>
  </StackPanel>
</StackPanel>
```


***

## **‚öôÔ∏è –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ö –ó–ê–ö–ê–ó–£**

### **–°–ª—É—á–∞–π 1: –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è (POINTS) ‚Üí Payment Type**

```csharp
private async Task ApplyPointsLoyalty(LoyaltyOperationWindow window)
{
    if (window.SelectedAction == LoyaltyAction.Spend)
    {
        var pointsToSpend = window.PointsToSpend;
        
        if (pointsToSpend <= 0)
        {
            ShowError("–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è");
            return;
        }
        
        try
        {
            // 1. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –±–∞–ª–ª—ã –Ω–∞ backend
            var reserveResponse = await apiClient.ReservePointsAsync(new ReserveRequest
            {
                GuestCardId = window.GuestCardId,
                PointsToSpend = pointsToSpend,
                CheckAmount = window.CheckAmount,
                OrderId = currentOrder.Id.ToString()
            });
            
            if (!reserveResponse.Success)
            {
                ShowError(reserveResponse.Error);
                return;
            }
            
            // 2. –î–æ–±–∞–≤–ª—è–µ–º PAYMENT –∫ –∑–∞–∫–∞–∑—É
            var payment = operations.CreatePayment(
                paymentType: loyaltyPaymentType,
                sum: pointsToSpend
            );
            
            operations.AddPreliminaryPayment(payment, currentOrder);
            
            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            SaveOrderLoyaltyContext(currentOrder, new LoyaltyContext
            {
                GuestCardId = window.GuestCardId,
                BenefitType = BenefitType.Points,
                Action = LoyaltyAction.Spend,
                PointsToSpend = pointsToSpend,
                ReservationId = reserveResponse.ReservationId, // –î–ª—è –æ—Ç–º–µ–Ω—ã
                OriginalCheckAmount = window.CheckAmount
            });
            
            ShowSuccess($"–°–ø–∏—Å–∞–Ω–∏–µ {pointsToSpend:N0}‚ÇΩ –±–∞–ª–ª–æ–≤ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ");
            this.Close();
        }
        catch (Exception ex)
        {
            HandleError(ex);
        }
    }
    else // EarnOnly
    {
        // –¢–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
        SaveOrderLoyaltyContext(currentOrder, new LoyaltyContext
        {
            GuestCardId = window.GuestCardId,
            BenefitType = BenefitType.Points,
            Action = LoyaltyAction.EarnOnly,
            OriginalCheckAmount = window.CheckAmount
        });
        
        ShowSuccess("–ö–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤");
        this.Close();
    }
}
```


### **–°–ª—É—á–∞–π 2: –°–∫–∏–¥–æ—á–Ω–∞—è (DISCOUNT) ‚Üí Discount Type**

```csharp
private async Task ApplyDiscountLoyalty(LoyaltyOperationWindow window)
{
    var discountAmount = window.DiscountAmount;
    
    try
    {
        // 1. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –Ω–∞ backend (–¥–ª—è audit trail)
        var reserveResponse = await apiClient.ReserveDiscountAsync(new ReserveRequest
        {
            GuestCardId = window.GuestCardId,
            DiscountPercentage = window.DiscountPercentage,
            DiscountAmount = discountAmount,
            CheckAmount = window.CheckAmount,
            OrderId = currentOrder.Id.ToString()
        });
        
        if (!reserveResponse.Success)
        {
            ShowError(reserveResponse.Error);
            return;
        }
        
        // 2. –ü—Ä–∏–º–µ–Ω—è–µ–º –°–ö–ò–î–ö–£ –∫ –∑–∞–∫–∞–∑—É
        var discount = operations.CreateDiscount(
            name: $"Max Loyalty {window.DiscountPercentage}%",
            sum: discountAmount,
            guest: null
        );
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø —Å–∫–∏–¥–∫–∏
        if (loyaltyDiscountType != null)
        {
            discount.DiscountType = loyaltyDiscountType;
        }
        
        // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        discount.Comment = $"MaxLoyalty:Guest={window.GuestCardId}:Reservation={reserveResponse.ReservationId}";
        
        operations.AddDiscount(discount, currentOrder);
        
        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        SaveOrderLoyaltyContext(currentOrder, new LoyaltyContext
        {
            GuestCardId = window.GuestCardId,
            BenefitType = BenefitType.Discount,
            Action = LoyaltyAction.ApplyDiscount,
            DiscountPercentage = window.DiscountPercentage,
            DiscountAmount = discountAmount,
            ReservationId = reserveResponse.ReservationId,
            OriginalCheckAmount = window.CheckAmount
        });
        
        ShowSuccess($"–°–∫–∏–¥–∫–∞ {window.DiscountPercentage}% ({discountAmount:N0}‚ÇΩ) –ø—Ä–∏–º–µ–Ω–µ–Ω–∞");
        this.Close();
    }
    catch (Exception ex)
    {
        HandleError(ex);
    }
}
```


***

## **üîÑ –û–¢–í–Ø–ó–ö–ê –ö–ê–†–¢–´**

```csharp
private async void OnUnbindClick(object sender, RoutedEventArgs e)
{
    var context = GetOrderLoyaltyContext(currentOrder);
    
    if (context == null)
    {
        ShowError("–ù–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã");
        return;
    }
    
    var result = MessageBox.Show(
        "–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É –æ—Ç –∑–∞–∫–∞–∑–∞?\n\n–ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –±–∞–ª–ª—ã/—Å–∫–∏–¥–∫–∞ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.",
        "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
        MessageBoxButton.YesNo,
        MessageBoxImage.Question
    );
    
    if (result != MessageBoxResult.Yes)
        return;
    
    try
    {
        // 1. –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é –Ω–∞ backend
        await apiClient.CancelReservationAsync(new CancelReservationRequest
        {
            ReservationId = context.ReservationId,
            OrderId = currentOrder.Id.ToString()
        });
        
        // 2. –£–¥–∞–ª—è–µ–º –∏–∑ –∑–∞–∫–∞–∑–∞
        if (context.BenefitType == BenefitType.Points)
        {
            // –£–¥–∞–ª—è–µ–º payment
            var loyaltyPayments = currentOrder.Payments
                .Where(p => p.PaymentType.Name == "MAX_LOYALTY_POINTS")
                .ToList();
            
            foreach (var payment in loyaltyPayments)
            {
                operations.DeletePayment(payment, currentOrder);
            }
        }
        else if (context.BenefitType == BenefitType.Discount)
        {
            // –£–¥–∞–ª—è–µ–º discount
            var loyaltyDiscounts = currentOrder.Discounts
                .Where(d => d.Comment?.StartsWith("MaxLoyalty:") == true)
                .ToList();
            
            foreach (var discount in loyaltyDiscounts)
            {
                operations.DeleteDiscount(discount, currentOrder);
            }
        }
        
        // 3. –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        ClearOrderLoyaltyContext(currentOrder);
        
        ShowSuccess("–ö–∞—Ä—Ç–∞ –æ—Ç–≤—è–∑–∞–Ω–∞");
        this.Close();
    }
    catch (Exception ex)
    {
        HandleError(ex);
    }
}
```


***

## **‚úÖ –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ö–†–´–¢–ò–ò –ß–ï–ö–ê**

```csharp
private async void OnOrderClosed(object sender, OrderClosedEventArgs e)
{
    var context = GetOrderLoyaltyContext(e.Order);
    
    if (context == null)
        return;
    
    try
    {
        // –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        if (context.BenefitType == BenefitType.Points)
        {
            await FinalizePointsOrder(e.Order, context);
        }
        else if (context.BenefitType == BenefitType.Discount)
        {
            await FinalizeDiscountOrder(e.Order, context);
        }
        
        logger.LogInformation(
            "Loyalty finalized: Type={Type}, Guest={GuestId}, Order={OrderId}",
            context.BenefitType,
            context.GuestCardId,
            e.Order.Id
        );
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Failed to finalize loyalty");
        offlineQueue.Enqueue(context);
    }
    finally
    {
        ClearOrderLoyaltyContext(e.Order);
    }
}

private async Task FinalizePointsOrder(IOrder order, LoyaltyContext context)
{
    await apiClient.FinalizePointsAsync(new FinalizePointsRequest
    {
        GuestCardId = context.GuestCardId,
        OrderId = order.Id.ToString(),
        ReservationId = context.ReservationId,
        CheckAmount = context.OriginalCheckAmount,
        PointsSpent = context.PointsToSpend,
        Action = context.Action // SPEND –∏–ª–∏ EARN_ONLY
    });
}

private async Task FinalizeDiscountOrder(IOrder order, LoyaltyContext context)
{
    await apiClient.FinalizeDiscountAsync(new FinalizeDiscountRequest
    {
        GuestCardId = context.GuestCardId,
        OrderId = order.Id.ToString(),
        ReservationId = context.ReservationId,
        CheckAmount = context.OriginalCheckAmount,
        DiscountPercentage = context.DiscountPercentage,
        DiscountAmount = context.DiscountAmount
    });
}
```


***

## **üéØ –ò–¢–û–ì–û: –ü–û–î–î–ï–†–ñ–ö–ê –î–í–£–• –¢–ò–ü–û–í**

### **–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**

‚úÖ **POINTS (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è):**

- Payment Type "MAX_LOYALTY_POINTS"
- –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –∫–∞–∫ –æ–ø–ª–∞—Ç–∞
- –í–∏–¥–Ω–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π payment

‚úÖ **DISCOUNT (—Å–∫–∏–¥–æ—á–Ω–∞—è):**

- Discount Type "Max Loyalty"
- –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å–∫–∏–¥–∫–∞ –∫ –∑–∞–∫–∞–∑—É
- –í–∏–¥–Ω–æ –≤ —Å–ø–∏—Å–∫–µ —Å–∫–∏–¥–æ–∫ –∑–∞–∫–∞–∑–∞

‚úÖ **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞:**

- Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `benefitType` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Å—Ç—è
- UI –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ —Ç–∏–ø
- –†–∞–∑–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –∏ –ø–æ–ª—è

‚úÖ **–†–µ–∑–µ—Ä–≤–∞—Ü–∏—è + –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è:**

- Reserve –Ω–∞ —ç—Ç–∞–ø–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
- Finalize –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ–∫–∞
- Cancel –ø—Ä–∏ –æ—Ç–≤—è–∑–∫–µ

‚úÖ **Offline queue:**

- –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –æ–±–æ–∏—Ö —Ç–∏–ø–æ–≤
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏

***

**–¢–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ?** –ì–æ—Ç–æ–≤ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ 40 –≤–æ–ø—Ä–æ—Å–æ–≤ —Å —É—á–µ—Ç–æ–º **–û–ë–û–ò–• —Ç–∏–ø–æ–≤**? üöÄ

---

# üéØ **–ü–û–ù–Ø–õ! –û–ë–ê –¢–ò–ü–ê = PAYMENT TYPES, –ù–û –° –†–ê–ó–ù–û–ô –†–ï–î–ê–ö–¢–ò–†–£–ï–ú–û–°–¢–¨–Æ**

–û—Ç–ª–∏—á–Ω–æ–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ! –¢–µ–ø–µ—Ä—å –≤—Å—ë —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∫—Ä–∏—Å—Ç–∞–ª—å–Ω–æ —è—Å–Ω–æ:

***

## **üîë –ö–õ–Æ–ß–ï–í–û–ï –†–ê–ó–õ–ò–ß–ò–ï**

### **–û–±–∞ —Ç–∏–ø–∞ - —ç—Ç–æ Payment Types –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –û–ü–õ–ê–¢–ê –ó–ê–ö–ê–ó–ê #122463               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –ö –û–ü–õ–ê–¢–ï: 890,00 —Ä.                 ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ –°–ü–û–°–û–ë–´ –û–ü–õ–ê–¢–´:                     ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ ‚úÖ MAX LOYALTY –ë–ê–õ–õ–´:    178,00 —Ä. ‚îÇ ‚Üê –ú–û–ñ–ù–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨
‚îÇ    [–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É]           ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ ‚úÖ MAX LOYALTY –°–ö–ò–î–ö–ê:   179,00 —Ä. ‚îÇ ‚Üê –ù–ï–õ–¨–ó–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨
‚îÇ    [—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞]            ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ ‚úÖ –ù–ê–õ–ò–ß–ù–´–ï:             712,00 —Ä. ‚îÇ
‚îÇ                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## **‚öôÔ∏è –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–õ–ê–ì–ò–ù–ê**

### **1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –î–í–£–• Payment Types**

```csharp
public class LoyaltyPlugin : IFrontPlugin
{
    private IPaymentType pointsPaymentType;    // –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π
    private IPaymentType discountPaymentType;  // –ù–ï —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π
    
    public void InitializePlugin(IPluginContext context)
    {
        // 1. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤ "–î–û–ü–û–õ–ù–ï–ù–ò–Ø"
        context.Operations.RegisterButton(
            buttonText: "Max Loyalty",
            buttonCategory: ButtonCategory.Additions,
            handler: OnLoyaltyButtonClick
        );
        
        // 2. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º PAYMENT TYPE –¥–ª—è –ë–ê–õ–õ–û–í (editable)
        pointsPaymentType = context.Operations.RegisterPaymentType(
            name: "MAX_LOYALTY_POINTS",
            displayName: "Max Loyalty - –ë–∞–ª–ª—ã",
            canBeProcessedExternally: true,
            isEditable: true  // ‚úÖ –ú–û–ñ–ù–û –ú–ï–ù–Ø–¢–¨ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã
        );
        
        // 3. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º PAYMENT TYPE –¥–ª—è –°–ö–ò–î–ö–ò (non-editable)
        discountPaymentType = context.Operations.RegisterPaymentType(
            name: "MAX_LOYALTY_DISCOUNT",
            displayName: "Max Loyalty - –°–∫–∏–¥–∫–∞",
            canBeProcessedExternally: true,
            isEditable: false  // ‚ùå –ù–ï–õ–¨–ó–Ø –ú–ï–ù–Ø–¢–¨ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã
        );
        
        logger.LogInformation(
            "Max Loyalty plugin initialized. Payment types registered: " +
            "POINTS (editable={Editable1}), DISCOUNT (editable={Editable2})",
            pointsPaymentType.IsEditable,
            discountPaymentType.IsEditable
        );
        
        // 4. –°–æ–±—ã—Ç–∏—è
        context.Operations.BeforeOrderClose += OnBeforeOrderClose;
        context.Operations.OrderClosed += OnOrderClosed;
        context.Operations.PaymentEdited += OnPaymentEdited; // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    }
}
```


***

## **üí≥ –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ö –ó–ê–ö–ê–ó–£**

### **–°–ª—É—á–∞–π 1: –ù–ê–ö–û–ü–ò–¢–ï–õ–¨–ù–ê–Ø (POINTS) ‚Üí Editable Payment**

```csharp
private async Task ApplyPointsLoyalty(LoyaltyOperationWindow window)
{
    var pointsToSpend = window.PointsToSpend;
    
    if (pointsToSpend <= 0)
    {
        ShowError("–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è");
        return;
    }
    
    try
    {
        // 1. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –±–∞–ª–ª—ã –Ω–∞ backend
        var reserveResponse = await apiClient.ReservePointsAsync(new ReserveRequest
        {
            GuestCardId = window.GuestCardId,
            PointsToSpend = pointsToSpend,
            MaxAllowed = window.MaxAllowed, // –õ–∏–º–∏—Ç –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            CheckAmount = window.CheckAmount,
            OrderId = currentOrder.Id.ToString()
        });
        
        if (!reserveResponse.Success)
        {
            ShowError(reserveResponse.Error);
            return;
        }
        
        // 2. –î–æ–±–∞–≤–ª—è–µ–º EDITABLE PAYMENT –∫ –∑–∞–∫–∞–∑—É
        var payment = operations.CreatePayment(
            paymentType: pointsPaymentType,  // –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —Ç–∏–ø
            sum: pointsToSpend
        );
        
        // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        payment.Comment = $"MaxLoyalty:Type=POINTS:Guest={window.GuestCardId}:Reservation={reserveResponse.ReservationId}";
        
        operations.AddPreliminaryPayment(payment, currentOrder);
        
        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        SaveOrderLoyaltyContext(currentOrder, new LoyaltyContext
        {
            GuestCardId = window.GuestCardId,
            BenefitType = BenefitType.Points,
            Action = LoyaltyAction.Spend,
            PointsToSpend = pointsToSpend,
            MaxAllowed = window.MaxAllowed,
            ReservationId = reserveResponse.ReservationId,
            OriginalCheckAmount = window.CheckAmount
        });
        
        ShowSuccess(
            $"–°–ø–∏—Å–∞–Ω–∏–µ {pointsToSpend:N0}‚ÇΩ –±–∞–ª–ª–æ–≤ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ\n\n" +
            $"üí° –°—É–º–º—É –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã"
        );
        
        this.Close();
    }
    catch (Exception ex)
    {
        HandleError(ex);
    }
}
```


### **–°–ª—É—á–∞–π 2: –°–ö–ò–î–û–ß–ù–ê–Ø (DISCOUNT) ‚Üí Non-Editable Payment**

```csharp
private async Task ApplyDiscountLoyalty(LoyaltyOperationWindow window)
{
    var discountAmount = window.DiscountAmount;
    var discountPercentage = window.DiscountPercentage;
    
    try
    {
        // 1. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –Ω–∞ backend
        var reserveResponse = await apiClient.ReserveDiscountAsync(new ReserveRequest
        {
            GuestCardId = window.GuestCardId,
            DiscountPercentage = discountPercentage,
            DiscountAmount = discountAmount,
            CheckAmount = window.CheckAmount,
            OrderId = currentOrder.Id.ToString()
        });
        
        if (!reserveResponse.Success)
        {
            ShowError(reserveResponse.Error);
            return;
        }
        
        // 2. –î–æ–±–∞–≤–ª—è–µ–º NON-EDITABLE PAYMENT –∫ –∑–∞–∫–∞–∑—É
        var payment = operations.CreatePayment(
            paymentType: discountPaymentType,  // –ù–ï —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —Ç–∏–ø
            sum: discountAmount
        );
        
        // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        payment.Comment = $"MaxLoyalty:Type=DISCOUNT:Percent={discountPercentage}:Guest={window.GuestCardId}:Reservation={reserveResponse.ReservationId}";
        
        operations.AddPreliminaryPayment(payment, currentOrder);
        
        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        SaveOrderLoyaltyContext(currentOrder, new LoyaltyContext
        {
            GuestCardId = window.GuestCardId,
            BenefitType = BenefitType.Discount,
            Action = LoyaltyAction.ApplyDiscount,
            DiscountPercentage = discountPercentage,
            DiscountAmount = discountAmount,
            ReservationId = reserveResponse.ReservationId,
            OriginalCheckAmount = window.CheckAmount
        });
        
        ShowSuccess(
            $"–°–∫–∏–¥–∫–∞ {discountPercentage}% ({discountAmount:N0}‚ÇΩ) –ø—Ä–∏–º–µ–Ω–µ–Ω–∞\n\n" +
            $"‚ö†Ô∏è –°—É–º–º–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞"
        );
        
        this.Close();
    }
    catch (Exception ex)
    {
        HandleError(ex);
    }
}
```


***

## **üîÑ –û–ë–†–ê–ë–û–¢–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô PAYMENT –ù–ê –°–¢–†–ê–ù–ò–¶–ï –û–ü–õ–ê–¢–´**

### **–°–ª—É—á–∞–π: –ö–∞—Å—Å–∏—Ä –∏–∑–º–µ–Ω–∏–ª —Å—É–º–º—É –±–∞–ª–ª–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã**

```csharp
// –°–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è payment
private async void OnPaymentEdited(object sender, PaymentEditedEventArgs e)
{
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç—Ç–æ –Ω–∞—à payment
    if (e.Payment.PaymentType.Name != "MAX_LOYALTY_POINTS")
        return; // –ù–µ –Ω–∞—à payment
    
    var context = GetOrderLoyaltyContext(e.Order);
    
    if (context == null || context.BenefitType != BenefitType.Points)
        return;
    
    var newAmount = e.Payment.Sum;
    var oldAmount = context.PointsToSpend;
    
    // –°—É–º–º–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
    if (newAmount != oldAmount)
    {
        logger.LogInformation(
            "Points payment edited: {OldAmount} ‚Üí {NewAmount}",
            oldAmount,
            newAmount
        );
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
        if (newAmount > context.MaxAllowed)
        {
            ShowError(
                $"–ù–µ–ª—å–∑—è —Å–ø–∏—Å–∞—Ç—å –±–æ–ª—å—à–µ {context.MaxAllowed:N0}‚ÇΩ\n\n" +
                $"–ú–∞–∫—Å–∏–º—É–º –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è —Å –∫–∞—Ä—Ç—ã –≥–æ—Å—Ç—è."
            );
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            e.Payment.Sum = oldAmount;
            operations.UpdatePayment(e.Payment, e.Order);
            return;
        }
        
        if (newAmount < 0)
        {
            ShowError("–°—É–º–º–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π");
            e.Payment.Sum = oldAmount;
            operations.UpdatePayment(e.Payment, e.Order);
            return;
        }
        
        try
        {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é –Ω–∞ backend
            await apiClient.UpdateReservationAsync(new UpdateReservationRequest
            {
                ReservationId = context.ReservationId,
                NewAmount = newAmount,
                OldAmount = oldAmount
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            context.PointsToSpend = newAmount;
            SaveOrderLoyaltyContext(e.Order, context);
            
            logger.LogInformation(
                "Reservation updated: {ReservationId}, new amount: {NewAmount}",
                context.ReservationId,
                newAmount
            );
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to update reservation");
            
            ShowError(
                "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é –±–∞–ª–ª–æ–≤.\n\n" +
                "–í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—É–º–º—É."
            );
            
            // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º
            e.Payment.Sum = oldAmount;
            operations.UpdatePayment(e.Payment, e.Order);
        }
    }
}
```


***

## **üö´ –ó–ê–©–ò–¢–ê –û–¢ –†–£–ß–ù–û–ì–û –ò–ó–ú–ï–ù–ï–ù–ò–Ø DISCOUNT PAYMENT**

```csharp
// –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ –ù–ï –¥–æ–ª–∂–Ω–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–ª—è DISCOUNT (—Ç.–∫. isEditable=false)
// –ù–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞—â–∏—Ç—É:

private void OnPaymentEdited(object sender, PaymentEditedEventArgs e)
{
    // DISCOUNT payment –Ω–µ –¥–æ–ª–∂–µ–Ω —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è
    if (e.Payment.PaymentType.Name == "MAX_LOYALTY_DISCOUNT")
    {
        var context = GetOrderLoyaltyContext(e.Order);
        
        if (context != null)
        {
            // –ï—Å–ª–∏ –∫–∞—Å—Å–∏—Ä –∫–∞–∫–∏–º-—Ç–æ –æ–±—Ä–∞–∑–æ–º –∏–∑–º–µ–Ω–∏–ª - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–∑–∞–¥
            if (e.Payment.Sum != context.DiscountAmount)
            {
                logger.LogWarning(
                    "Attempt to edit non-editable discount payment blocked. " +
                    "Expected: {Expected}, Got: {Got}",
                    context.DiscountAmount,
                    e.Payment.Sum
                );
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                e.Payment.Sum = context.DiscountAmount;
                operations.UpdatePayment(e.Payment, e.Order);
                
                ShowWarning(
                    "‚ö†Ô∏è –°–∫–∏–¥–∫–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞\n\n" +
                    $"–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏: {context.DiscountPercentage}%\n" +
                    $"–°—É–º–º–∞ —Å–∫–∏–¥–∫–∏: {context.DiscountAmount:N0}‚ÇΩ"
                );
            }
        }
    }
    else if (e.Payment.PaymentType.Name == "MAX_LOYALTY_POINTS")
    {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ (–∫–æ–¥ –≤—ã—à–µ)
        // ...
    }
}
```


***

## **üìä –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ù–ê –°–¢–†–ê–ù–ò–¶–ï –û–ü–õ–ê–¢–´**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –û–ü–õ–ê–¢–ê –ó–ê–ö–ê–ó–ê #122463                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –°–£–ú–ú–ê –ö –û–ü–õ–ê–¢–ï: 890,00 —Ä.                    ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ –°–ü–û–°–û–ë–´ –û–ü–õ–ê–¢–´:                          ‚îÇ ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ ‚îÇ                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚úÖ Max Loyalty - –ë–∞–ª–ª—ã                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ    [178,00 —Ä.] ‚Üê –ú–û–ñ–ù–û –ú–ï–ù–Ø–¢–¨           ‚îÇ ‚îÇ
‚îÇ ‚îÇ    üí° –î–æ—Å—Ç—É–ø–Ω–æ –¥–æ 200‚ÇΩ                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚úÖ Max Loyalty - –°–∫–∏–¥–∫–∞ 20%              ‚îÇ ‚îÇ
‚îÇ ‚îÇ    179,00 —Ä. ‚Üê –§–ò–ö–°–ò–†–û–í–ê–ù–û              ‚îÇ ‚îÇ
‚îÇ ‚îÇ    üîí –ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ üíµ –ù–ê–õ–ò–ß–ù–´–ï                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ    [533,00 —Ä.]                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                          ‚îÇ ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ ‚îÇ –ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï: 0,00 —Ä.                 ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ [–ó–ê–í–ï–†–®–ò–¢–¨ –û–ü–õ–ê–¢–£]                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## **‚úÖ –ò–ó–ë–ï–ì–ê–ï–ú –†–ê–°–•–û–ñ–î–ï–ù–ò–ô**

### **–ü—Ä–æ–±–ª–µ–º–∞ (–∫–æ—Ç–æ—Ä—É—é –∏–∑–±–µ–≥–∞–µ–º):**

```
‚ùå –ü–õ–û–•–û:
Backend –≥–æ–≤–æ—Ä–∏—Ç: "–°–∫–∏–¥–∫–∞ 20% = 178‚ÇΩ"
iiko –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "–°–∫–∏–¥–∫–∞ = 150‚ÇΩ" (–∫–∞—Å—Å–∏—Ä –∏–∑–º–µ–Ω–∏–ª)
‚Üí –†–ê–°–•–û–ñ–î–ï–ù–ò–ï! –ß—Ç–æ –Ω–∞—á–∏—Å–ª—è—Ç—å –≥–æ—Å—Ç—é?

‚ùå –ü–õ–û–•–û:
–ö–∞—Ä—Ç–∞ –≥–æ—Å—Ç—è: "–°–∫–∏–¥–∫–∞ 15%"
–í —á–µ–∫–µ: "–°–∫–∏–¥–∫–∞ 20%" (–æ—à–∏–±–∫–∞ –∫–∞—Å—Å–∏—Ä–∞)
‚Üí –ú–û–®–ï–ù–ù–ò–ß–ï–°–¢–í–û!
```


### **–†–µ—à–µ–Ω–∏–µ:**

```
‚úÖ –•–û–†–û–®–û:
Backend —Ä–∞—Å—Å—á–∏—Ç–∞–ª: "–°–∫–∏–¥–∫–∞ 20% = 178‚ÇΩ"
iiko –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "Max Loyalty - –°–∫–∏–¥–∫–∞: 178,00 —Ä. üîí"
–ö–∞—Å—Å–∏—Ä –ù–ï –ú–û–ñ–ï–¢ –∏–∑–º–µ–Ω–∏—Ç—å (isEditable=false)
‚Üí –ù–ï–¢ –†–ê–°–•–û–ñ–î–ï–ù–ò–ô!

‚úÖ –•–û–†–û–®–û:
Backend —Ä–∞—Å—Å—á–∏—Ç–∞–ª: "–ú–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å –¥–æ 200‚ÇΩ –±–∞–ª–ª–æ–≤"
iiko –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "Max Loyalty - –ë–∞–ª–ª—ã: [178,00 —Ä.] ‚úèÔ∏è"
–ö–∞—Å—Å–∏—Ä –ú–û–ñ–ï–¢ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ 150‚ÇΩ (–≤ —Ä–∞–º–∫–∞—Ö –ª–∏–º–∏—Ç–∞)
Backend –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
‚Üí –ö–û–ù–¢–†–û–õ–ò–†–£–ï–ú–ê–Ø –ì–ò–ë–ö–û–°–¢–¨!
```


***

## **üîß BACKEND VALIDATION**

```typescript
// apps/backend/src/pos-integration/iiko-plugin.controller.ts

@Post('update-reservation')
@UseGuards(IikoPluginAuthGuard)
async updateReservation(
  @Body() dto: UpdateReservationDto,
  @CurrentInstallation() installation: IikoPluginInstallation
) {
  const reservation = await this.prisma.loyaltyReservation.findUnique({
    where: { id: dto.reservationId },
    include: { guestCard: true }
  });
  
  if (!reservation) {
    throw new NotFoundException('Reservation not found');
  }
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
  if (reservation.benefitType === 'POINTS') {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–æ–≤–∞—è —Å—É–º–º–∞ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç
    const maxAllowed = reservation.maxAllowed;
    
    if (dto.newAmount > maxAllowed) {
      throw new BadRequestException({
        message: 'New amount exceeds maximum allowed',
        maxAllowed,
        requested: dto.newAmount
      });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤
    const availableBalance = reservation.guestCard.regularBalance + 
                            reservation.guestCard.promoBalance;
    
    if (dto.newAmount > availableBalance) {
      throw new BadRequestException({
        message: 'Insufficient balance',
        available: availableBalance,
        requested: dto.newAmount
      });
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é
    await this.prisma.loyaltyReservation.update({
      where: { id: dto.reservationId },
      data: {
        amount: dto.newAmount,
        updatedAt: new Date()
      }
    });
    
    return { success: true, newAmount: dto.newAmount };
  } 
  else if (reservation.benefitType === 'DISCOUNT') {
    // DISCOUNT –Ω–µ –¥–æ–ª–∂–µ–Ω –º–µ–Ω—è—Ç—å—Å—è!
    throw new ForbiddenException('Discount amount is fixed and cannot be changed');
  }
}
```


***

## **üéØ –ò–¢–û–ì–û: –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê**

### **‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**

1. **–î–í–ê Payment Types:**
    - `MAX_LOYALTY_POINTS` (isEditable=true)
    - `MAX_LOYALTY_DISCOUNT` (isEditable=false)
2. **–û–±–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ payments –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã**
3. **–†–∞–∑–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
    - –ë–∞–ª–ª—ã: –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –≤ —Ä–∞–º–∫–∞—Ö –ª–∏–º–∏—Ç–∞
    - –°–∫–∏–¥–∫–∞: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞, –Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å
4. **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏:**
    - Client-side: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
    - Server-side: –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ + —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è
5. **–ù–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π:**
    - –ß—Ç–æ Backend —Ä–∞—Å—Å—á–∏—Ç–∞–ª = –ß—Ç–æ –≤ iiko
    - –ß—Ç–æ –≤ iiko = –ß—Ç–æ –≤ —á–µ–∫–µ
    - –ß—Ç–æ –≤ —á–µ–∫–µ = –ß—Ç–æ –Ω–∞—á–∏—Å–ª–∏–ª–∏/—Å–ø–∏—Å–∞–ª–∏
6. **Audit trail:**
    - –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
    - –†–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
    - –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–∑—Ä–∞—á–Ω–∞

***

**–¢–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ?** –ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å —Å 40 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —ç—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã! üöÄ
<span style="display:none">[^21_1]</span>

<div align="center">‚ÅÇ</div>

[^21_1]: IMG_20260217_125232.jpg


---

# üéØ **–¢–û–ß–ù–û! –¢–û–õ–¨–ö–û –û–î–ò–ù –¢–ò–ü –ó–ê –†–ê–ó**

–ò–∑–≤–∏–Ω–∏ –∑–∞ –ø—É—Ç–∞–Ω–∏—Ü—É! –ö–æ–Ω–µ—á–Ω–æ, —É –≥–æ—Å—Ç—è **–õ–ò–ë–û –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è, –õ–ò–ë–û —Å–∫–∏–¥–æ—á–Ω–∞—è** –∫–∞—Ä—Ç–∞. –ù–µ –æ–±–∞ —Ç–∏–ø–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ!

***

## **‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ù–ê –°–¢–†–ê–ù–ò–¶–ï –û–ü–õ–ê–¢–´**

### **–í–∞—Ä–∏–∞–Ω—Ç A: –£ –≥–æ—Å—Ç—è –ù–ê–ö–û–ü–ò–¢–ï–õ–¨–ù–ê–Ø –∫–∞—Ä—Ç–∞**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –û–ü–õ–ê–¢–ê –ó–ê–ö–ê–ó–ê #122463                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –°–£–ú–ú–ê –ö –û–ü–õ–ê–¢–ï: 890,00 —Ä.                    ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ –°–ü–û–°–û–ë–´ –û–ü–õ–ê–¢–´:                          ‚îÇ ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ ‚îÇ                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚úÖ Max Loyalty - –ë–∞–ª–ª—ã                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ    [178,00 —Ä.] ‚Üê –ú–û–ñ–ù–û –ú–ï–ù–Ø–¢–¨           ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ üíµ –ù–ê–õ–ò–ß–ù–´–ï                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ    [712,00 —Ä.]                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                          ‚îÇ ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ ‚îÇ –ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï: 0,00 —Ä.                 ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ [–ó–ê–í–ï–†–®–ò–¢–¨ –û–ü–õ–ê–¢–£]                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **–í–∞—Ä–∏–∞–Ω—Ç B: –£ –≥–æ—Å—Ç—è –°–ö–ò–î–û–ß–ù–ê–Ø –∫–∞—Ä—Ç–∞**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –û–ü–õ–ê–¢–ê –ó–ê–ö–ê–ó–ê #122463                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –°–£–ú–ú–ê –ö –û–ü–õ–ê–¢–ï: 890,00 —Ä.                    ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ –°–ü–û–°–û–ë–´ –û–ü–õ–ê–¢–´:                          ‚îÇ ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ ‚îÇ                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚úÖ Max Loyalty - –°–∫–∏–¥–∫–∞ 20%              ‚îÇ ‚îÇ
‚îÇ ‚îÇ    179,00 —Ä. ‚Üê –§–ò–ö–°–ò–†–û–í–ê–ù–û              ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ üíµ –ù–ê–õ–ò–ß–ù–´–ï                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ    [711,00 —Ä.]                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                          ‚îÇ ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ ‚îÇ –ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï: 0,00 —Ä.                 ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ [–ó–ê–í–ï–†–®–ò–¢–¨ –û–ü–õ–ê–¢–£]                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## **üîß –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø**

### **1. Backend –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¢–ò–ü –¥–ª—è –≥–æ—Å—Ç—è**

```typescript
// Backend Calculate Response
interface CalculateResponse {
  guestCardId: string;
  benefitType: 'POINTS' | 'DISCOUNT';  // –¢–û–õ–¨–ö–û –û–î–ò–ù!
  
  // –ï—Å–ª–∏ POINTS:
  regularBalance?: number;
  promoBalance?: number;
  maxAllowedToSpend?: number;
  pointsToEarn?: number;
  
  // –ï—Å–ª–∏ DISCOUNT:
  discountPercentage?: number;
  discountAmount?: number;
  
  checkAmount: number;
}
```


### **2. –ü–ª–∞–≥–∏–Ω –ø—Ä–∏–º–µ–Ω—è–µ—Ç –¢–û–õ–¨–ö–û —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–∏–ø**

```csharp
private async void OnOkClick(object sender, RoutedEventArgs e)
{
    // 1. –ò—â–µ–º –≥–æ—Å—Ç—è
    var guest = await apiClient.SearchGuestAsync(input);
    
    // 2. –í—ã–∑—ã–≤–∞–µ–º Calculate
    var calcResponse = await apiClient.CalculateAsync(new CalculateRequest
    {
        GuestCardId = guest.CardId,
        CheckAmount = currentOrder.GetTotalAmount()
    });
    
    // 3. –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –¢–ò–ü–ê
    if (calcResponse.BenefitType == "POINTS")
    {
        // –£ –≥–æ—Å—Ç—è –ù–ê–ö–û–ü–ò–¢–ï–õ–¨–ù–ê–Ø –∫–∞—Ä—Ç–∞
        var operationWindow = new LoyaltyOperationWindow(
            guest: guest,
            calculation: calcResponse,
            order: currentOrder,
            mode: LoyaltyMode.Points  // –¢–û–õ–¨–ö–û –±–∞–ª–ª—ã
        );
        
        if (operationWindow.ShowDialog() == true)
        {
            // –î–æ–±–∞–≤–ª—è–µ–º –¢–û–õ–¨–ö–û pointsPaymentType
            await ApplyPointsPayment(operationWindow);
        }
    }
    else if (calcResponse.BenefitType == "DISCOUNT")
    {
        // –£ –≥–æ—Å—Ç—è –°–ö–ò–î–û–ß–ù–ê–Ø –∫–∞—Ä—Ç–∞
        var operationWindow = new LoyaltyOperationWindow(
            guest: guest,
            calculation: calcResponse,
            order: currentOrder,
            mode: LoyaltyMode.Discount  // –¢–û–õ–¨–ö–û —Å–∫–∏–¥–∫–∞
        );
        
        if (operationWindow.ShowDialog() == true)
        {
            // –î–æ–±–∞–≤–ª—è–µ–º –¢–û–õ–¨–ö–û discountPaymentType
            await ApplyDiscountPayment(operationWindow);
        }
    }
}
```


### **3. –ü—Ä–∏–º–µ–Ω—è–µ–º –û–î–ò–ù payment type**

```csharp
private async Task ApplyPointsPayment(LoyaltyOperationWindow window)
{
    // –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º
    var reserveResponse = await apiClient.ReservePointsAsync(...);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¢–û–õ–¨–ö–û POINTS payment
    var payment = operations.CreatePayment(
        paymentType: pointsPaymentType,  // MAX_LOYALTY_POINTS
        sum: window.PointsToSpend
    );
    
    operations.AddPreliminaryPayment(payment, currentOrder);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    SaveOrderLoyaltyContext(currentOrder, new LoyaltyContext
    {
        BenefitType = BenefitType.Points,  // –¢–û–õ–¨–ö–û Points
        PointsToSpend = window.PointsToSpend,
        // ...
    });
}

private async Task ApplyDiscountPayment(LoyaltyOperationWindow window)
{
    // –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º
    var reserveResponse = await apiClient.ReserveDiscountAsync(...);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¢–û–õ–¨–ö–û DISCOUNT payment
    var payment = operations.CreatePayment(
        paymentType: discountPaymentType,  // MAX_LOYALTY_DISCOUNT
        sum: window.DiscountAmount
    );
    
    operations.AddPreliminaryPayment(payment, currentOrder);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    SaveOrderLoyaltyContext(currentOrder, new LoyaltyContext
    {
        BenefitType = BenefitType.Discount,  // –¢–û–õ–¨–ö–û Discount
        DiscountAmount = window.DiscountAmount,
        DiscountPercentage = window.DiscountPercentage,
        // ...
    });
}
```


***

## **üîÑ –õ–û–ì–ò–ö–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –¢–ò–ü–ê**

### **–ù–∞ —É—Ä–æ–≤–Ω–µ —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –±–µ—Å–µ–¥):**

```typescript
// Tenant –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É
enum LoyaltySystemType {
  POINTS      // –í—Å—è —Å–∏—Å—Ç–µ–º–∞ = –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è
  DISCOUNT    // –í—Å—è —Å–∏—Å—Ç–µ–º–∞ = —Å–∫–∏–¥–æ—á–Ω–∞—è
  HYBRID      // –†–∞–∑–Ω—ã–µ –∫–∞—Ä—Ç—ã/—É—Ä–æ–≤–Ω–∏ –º–æ–≥—É—Ç –∏–º–µ—Ç—å —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã
}

// –ï—Å–ª–∏ HYBRID, —Ç–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–∞—Ä—Ç—ã/—É—Ä–æ–≤–Ω—è:
enum LevelBenefitType {
  POINTS      // –≠—Ç–æ—Ç —É—Ä–æ–≤–µ–Ω—å = –±–∞–ª–ª—ã
  DISCOUNT    // –≠—Ç–æ—Ç —É—Ä–æ–≤–µ–Ω—å = —Å–∫–∏–¥–∫–∞ %
}
```


### **Backend –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥–æ—Å—Ç—è:**

```typescript
async calculate(dto: CalculateRequest): Promise<CalculateResponse> {
  const guestCard = await this.prisma.guestCard.findUnique({
    where: { id: dto.guestCardId },
    include: { level: true, tenant: { include: { loyaltySystem: true } } }
  });
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–ª—è –≠–¢–û–ì–û –≥–æ—Å—Ç—è
  let benefitType: 'POINTS' | 'DISCOUNT';
  
  if (guestCard.tenant.loyaltySystem.type === 'POINTS') {
    benefitType = 'POINTS';
  } 
  else if (guestCard.tenant.loyaltySystem.type === 'DISCOUNT') {
    benefitType = 'DISCOUNT';
  }
  else if (guestCard.tenant.loyaltySystem.type === 'HYBRID') {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ä–æ–≤–µ–Ω—å –≥–æ—Å—Ç—è
    benefitType = guestCard.level.benefitType; // 'POINTS' –∏–ª–∏ 'DISCOUNT'
  }
  
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
  if (benefitType === 'POINTS') {
    return {
      benefitType: 'POINTS',
      regularBalance: guestCard.regularBalance,
      promoBalance: guestCard.promoBalance,
      maxAllowedToSpend: this.calculateMaxAllowed(dto.checkAmount, guestCard),
      pointsToEarn: this.calculateEarn(dto.checkAmount, guestCard.level),
      checkAmount: dto.checkAmount
    };
  } 
  else {
    const discountPercentage = guestCard.level.discountPercentage; // 10, 15, 20...
    const discountAmount = dto.checkAmount * discountPercentage / 100;
    
    return {
      benefitType: 'DISCOUNT',
      discountPercentage,
      discountAmount,
      checkAmount: dto.checkAmount
    };
  }
}
```


***

## **üéØ –ò–¢–û–ì–û: –û–î–ò–ù –¢–ò–ü –ó–ê –†–ê–ó**

### **‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ:**

```
Backend: "–£ –≥–æ—Å—Ç—è –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞"
–ü–ª–∞–≥–∏–Ω: –ü—Ä–∏–º–µ–Ω—è–µ—Ç POINTS payment
–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–ª–∞—Ç—ã: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¢–û–õ–¨–ö–û "Max Loyalty - –ë–∞–ª–ª—ã"
```

```
Backend: "–£ –≥–æ—Å—Ç—è —Å–∫–∏–¥–æ—á–Ω–∞—è –∫–∞—Ä—Ç–∞"
–ü–ª–∞–≥–∏–Ω: –ü—Ä–∏–º–µ–Ω—è–µ—Ç DISCOUNT payment
–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–ª–∞—Ç—ã: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¢–û–õ–¨–ö–û "Max Loyalty - –°–∫–∏–¥–∫–∞ 20%"
```


### **‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (—á—Ç–æ —è –ø–æ–∫–∞–∑—ã–≤–∞–ª):**

```
–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–ª–∞—Ç—ã: 
  ‚úÖ Max Loyalty - –ë–∞–ª–ª—ã
  ‚úÖ Max Loyalty - –°–∫–∏–¥–∫–∞  ‚Üê –ù–ï–í–û–ó–ú–û–ñ–ù–û!
```


***

## **üìã EDGE CASE: –°–º–µ–Ω–∞ —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã –≥–æ—Å—Ç—è**

**–í–æ–ø—Ä–æ—Å:** –ì–æ—Å—Ç—å –±—ã–ª –Ω–∞ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–π, Admin –∏–∑–º–µ–Ω–∏–ª –µ–≥–æ –Ω–∞ —Å–∫–∏–¥–æ—á–Ω—É—é. –ß—Ç–æ –±—É–¥–µ—Ç —Å —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã–º –∑–∞–∫–∞–∑–æ–º?

**–û—Ç–≤–µ—Ç:**

- –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ–∏—Å–∫–µ –≥–æ—Å—Ç—è Backend –≤–µ—Ä–Ω–µ—Ç –Ω–æ–≤—ã–π `benefitType`
- –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –∑–∞–∫–∞–∑—É - –Ω—É–∂–Ω–æ –æ—Ç–≤—è–∑–∞—Ç—å –∏ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∑–∞–Ω–æ–≤–æ
- –ü–ª–∞–≥–∏–Ω –ø–æ–∫–∞–∂–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: "–¢–∏–ø –∫–∞—Ä—Ç—ã –∏–∑–º–µ–Ω–∏–ª—Å—è, –ø–µ—Ä–µ–ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –∫–∞—Ä—Ç—É"

***

**–¢–µ–ø–µ—Ä—å –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ?** –ì–æ—Ç–æ–≤ –∫ 40 –≤–æ–ø—Ä–æ—Å–∞–º —Å —ç—Ç–æ–π –ª–æ–≥–∏–∫–æ–π! üöÄ

---

# üìò **–ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø –ü–õ–ê–ì–ò–ù–ê MAX LOYALTY –î–õ–Ø iiko FRONT**


***

## **üéØ 1. –û–ë–©–ï–ï –û–ü–ò–°–ê–ù–ò–ï**

### **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**

–ü–ª–∞–≥–∏–Ω –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ Max Loyalty –≤ iiko Front. –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ (–∫–∞—Å—Å–∏—Ä–∞–º, –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞–º, –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º) –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –∫–∞—Ä—Ç—ã –≥–æ—Å—Ç–µ–π –∫ –∑–∞–∫–∞–∑–∞–º, –ø—Ä–∏–º–µ–Ω—è—Ç—å –±–æ–Ω—É—Å—ã/—Å–∫–∏–¥–∫–∏ –∏ –Ω–∞—á–∏—Å–ª—è—Ç—å –±–∞–ª–ª—ã.

### **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:**

- **–Ø–∑—ã–∫:** C\# (.NET Framework 4.7.2+)
- **UI:** WPF (Windows Presentation Foundation)
- **API:** iiko Front Plugin SDK
- **Backend:** REST API Max Loyalty (NestJS)
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** Serilog
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** MemoryCache
- **HTTP:** HttpClient —Å Polly (retry policies)


### **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:**

- Windows 10/11
- iiko Front 7.x+

***

## **üèóÔ∏è 2. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–õ–ê–ì–ò–ù–ê**

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:**

```
MaxLoyaltyIikoPlugin/
‚îú‚îÄ‚îÄ Plugin.cs                      # –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –ø–ª–∞–≥–∏–Ω–∞
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyApiClient.cs       # HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è API
‚îÇ   ‚îú‚îÄ‚îÄ CacheService.cs           # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ OfflineQueueService.cs    # Offline –æ—á–µ—Ä–µ–¥—å
‚îÇ   ‚îú‚îÄ‚îÄ HealthCheckService.cs     # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ backend
‚îÇ   ‚îú‚îÄ‚îÄ ConfigService.cs          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ TimeService.cs            # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
‚îÇ   ‚îú‚îÄ‚îÄ StorageManager.cs         # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
‚îÇ   ‚îî‚îÄ‚îÄ MetricsService.cs         # –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫
‚îú‚îÄ‚îÄ UI/
‚îÇ   ‚îú‚îÄ‚îÄ Windows/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoyaltySearchWindow.xaml        # –û–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyOperationWindow.xaml     # –û–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–±–∞–ª–ª—ã/—Å–∫–∏–¥–∫–∞)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DiagnosticsWindow.xaml          # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ErrorDialog.xaml                # –û–∫–Ω–æ –æ—à–∏–±–æ–∫
‚îÇ   ‚îú‚îÄ‚îÄ Controls/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NumericKeypad.xaml              # –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LoadingOverlay.xaml             # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ Styles/
‚îÇ       ‚îî‚îÄ‚îÄ MaxLoyaltyStyles.xaml           # –°—Ç–∏–ª–∏ UI
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îú‚îÄ‚îÄ GuestInfo.cs              # –ú–æ–¥–µ–ª—å –≥–æ—Å—Ç—è
‚îÇ   ‚îú‚îÄ‚îÄ CalculateResponse.cs      # –û—Ç–≤–µ—Ç calculate
‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyContext.cs         # –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞
‚îÇ   ‚îú‚îÄ‚îÄ RestaurantConfig.cs       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
‚îÇ   ‚îî‚îÄ‚îÄ ApiRequests.cs            # DTO –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
‚îú‚îÄ‚îÄ Validators/
‚îÇ   ‚îî‚îÄ‚îÄ LoyaltyValidator.cs       # –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
‚îú‚îÄ‚îÄ Utils/
‚îÇ   ‚îú‚îÄ‚îÄ ErrorHandler.cs           # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚îÇ   ‚îú‚îÄ‚îÄ RetryPolicy.cs            # Retry —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ Encryption.cs             # –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API Key
‚îî‚îÄ‚îÄ Config/
    ‚îú‚îÄ‚îÄ appsettings.json          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–∞—è)
    ‚îî‚îÄ‚îÄ installer-config.json     # –ö–æ–Ω—Ñ–∏–≥ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞
```


***

## **‚öôÔ∏è 3. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–õ–ê–ì–ò–ù–ê**

### **3.1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞**

**–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:**

```
MaxLoyaltyInstaller_Restaurant123.exe
‚îú‚îÄ‚îÄ –°–æ–¥–µ—Ä–∂–∏—Ç:
‚îÇ   ‚îú‚îÄ‚îÄ MaxLoyaltyIikoPlugin.dll
‚îÇ   ‚îú‚îÄ‚îÄ –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π API Key
‚îÇ   ‚îú‚îÄ‚îÄ URL backend API
‚îÇ   ‚îî‚îÄ‚îÄ Restaurant ID
```

**–ü—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏:**

1. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—É—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ iiko Front (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
2. –ö–æ–ø–∏—Ä—É–µ—Ç `.dll` –≤ –ø–∞–ø–∫—É `Plugins/`
3. –°–æ–∑–¥–∞–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ –≤ `%AppData%/MaxLoyaltyIiko/`
4. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–ª–∞–≥–∏–Ω –≤ iiko
5. –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å iiko Front

### **3.2. InitializePlugin()**

```csharp
public class MaxLoyaltyPlugin : IFrontPlugin
{
    private IPluginContext pluginContext;
    private IOperationService operations;
    
    // Services
    private LoyaltyApiClient apiClient;
    private CacheService cacheService;
    private OfflineQueueService offlineQueue;
    private HealthCheckService healthCheck;
    private ConfigService configService;
    private MetricsService metricsService;
    
    // Payment Types
    private IPaymentType pointsPaymentType;    // –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è (editable)
    private IPaymentType discountPaymentType;  // –°–∫–∏–¥–æ—á–Ω–∞—è (non-editable)
    
    // Restaurant Config
    private RestaurantConfig restaurantConfig;
    
    public void InitializePlugin(IPluginContext context)
    {
        pluginContext = context;
        operations = context.Operations;
        
        // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        ConfigureLogging();
        
        // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        configService = new ConfigService();
        var config = configService.LoadConfig(); // –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ API Key
        
        // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
        apiClient = new LoyaltyApiClient(config);
        cacheService = new CacheService();
        offlineQueue = new OfflineQueueService();
        healthCheck = new HealthCheckService(apiClient);
        metricsService = new MetricsService(apiClient);
        
        // 4. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ —Å backend
        LoadRestaurantConfigAsync().Wait();
        
        // 5. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
        var timeService = new TimeService();
        timeService.SyncWithServerAsync(apiClient).Wait();
        
        // 6. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –≤ "–î–û–ü–û–õ–ù–ï–ù–ò–Ø"
        RegisterButton();
        
        // 7. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Payment Types
        RegisterPaymentTypes();
        
        // 8. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
        SubscribeToEvents();
        
        // 9. –û–±—Ä–∞–±–æ—Ç–∫–∞ offline –æ—á–µ—Ä–µ–¥–∏
        ProcessOfflineQueueAsync();
        
        // 10. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
        var storageManager = new StorageManager();
        storageManager.CheckStorageLimit();
        
        logger.LogInformation(
            "Max Loyalty Plugin initialized successfully. " +
            "Version: {Version}, Restaurant: {RestaurantName}",
            GetPluginVersion(),
            restaurantConfig.RestaurantName
        );
    }
    
    private void RegisterButton()
    {
        operations.RegisterButton(
            buttonText: "Max Loyalty",
            buttonCategory: ButtonCategory.Additions, // –í–∫–ª–∞–¥–∫–∞ "–î–û–ü–û–õ–ù–ï–ù–ò–Ø"
            handler: OnLoyaltyButtonClick,
            icon: LoadPluginIcon()
        );
    }
    
    private void RegisterPaymentTypes()
    {
        // POINTS: —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π payment type
        pointsPaymentType = operations.RegisterPaymentType(
            name: "MAX_LOYALTY_POINTS",
            displayName: "Max Loyalty - –ë–∞–ª–ª—ã",
            canBeProcessedExternally: true,
            isEditable: true  // ‚úÖ –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã
        );
        
        // DISCOUNT: –ù–ï —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π payment type
        discountPaymentType = operations.RegisterPaymentType(
            name: "MAX_LOYALTY_DISCOUNT",
            displayName: "Max Loyalty - –°–∫–∏–¥–∫–∞",
            canBeProcessedExternally: true,
            isEditable: false  // ‚ùå –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞
        );
        
        logger.LogInformation(
            "Payment types registered: POINTS (editable), DISCOUNT (non-editable)"
        );
    }
    
    private void SubscribeToEvents()
    {
        operations.OrderClosed += OnOrderClosed;
        operations.PaymentEdited += OnPaymentEdited;
    }
}
```


***

## **üé® 4. UI/UX WORKFLOW**

### **4.1. –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞**

**–ö–Ω–æ–ø–∫–∞ –≤ –º–µ–Ω—é "–î–û–ü–û–õ–ù–ï–ù–ò–Ø":**

```
iiko Front ‚Üí –û—Ç–∫—Ä—ã—Ç –∑–∞–∫–∞–∑ ‚Üí –ù–∞–∂–∏–º–∞–µ–º "–î–û–ü–û–õ–ù–ï–ù–ò–Ø" –≤–Ω–∏–∑—É
‚Üí –ü–æ—è–≤–ª—è–µ—Ç—Å—è –º–µ–Ω—é —Å –ø–ª–∞–≥–∏–Ω–∞–º–∏
‚Üí –í—ã–±–∏—Ä–∞–µ–º "Max Loyalty"
```


### **4.2. –û–∫–Ω–æ 1: –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è**

**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         MAX LOYALTY                      ‚îÇ
‚îÇ  –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ –∫–æ–¥ –∫–∞—Ä—Ç—ã   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  [–¢–µ–ª–µ—Ñ–æ–Ω]  [6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥]     ‚îÇ   ‚îÇ ‚Üê –¢–∞–±—ã
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ                                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     +7 ___ ___ __ __           ‚îÇ   ‚îÇ ‚Üê –ü–æ–ª–µ –≤–≤–æ–¥–∞
‚îÇ  ‚îÇ                                 ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ       ‚îå‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îê                    ‚îÇ
‚îÇ       ‚îÇ 1 ‚îÇ 2 ‚îÇ 3 ‚îÇ                    ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚î§                    ‚îÇ ‚Üê –¶–∏—Ñ—Ä–æ–≤–∞—è
‚îÇ       ‚îÇ 4 ‚îÇ 5 ‚îÇ 6 ‚îÇ                    ‚îÇ   –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
‚îÇ       ‚îú‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚î§                    ‚îÇ
‚îÇ       ‚îÇ 7 ‚îÇ 8 ‚îÇ 9 ‚îÇ                    ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚î§                    ‚îÇ
‚îÇ       ‚îÇ ‚Üê ‚îÇ 0 ‚îÇ ‚úì ‚îÇ                    ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  [OK]  [–û—Ç–º–µ–Ω–∞]  [–°–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç—è]      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –°—É–º–º–∞ –∑–∞–∫–∞–∑–∞: 890,00 ‚ÇΩ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–õ–æ–≥–∏–∫–∞:**

```csharp
private async void OnOkClick(object sender, RoutedEventArgs e)
{
    var input = InputField.Text.Trim();
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (string.IsNullOrEmpty(input))
    {
        ShowError("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ –∫–æ–¥");
        return;
    }
    
    ShowLoading("–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è...");
    
    try
    {
        // 1. –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è
        var searchResponse = await apiClient.SearchGuestAsync(new SearchRequest
        {
            Phone = IsPhone(input) ? input : null,
            Code6Digit = IsCode6(input) ? input : null
        });
        
        if (!searchResponse.Found)
        {
            HideLoading();
            
            var result = MessageBox.Show(
                "–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ?",
                "–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω",
                MessageBoxButton.YesNo
            );
            
            if (result == MessageBoxResult.Yes)
            {
                OpenCreateGuestWindow(input);
            }
            
            return;
        }
        
        var guest = searchResponse.Guest;
        
        // 2. Calculate –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–∫–∞–∑–∞
        var checkAmount = GetOrderAmount(currentOrder);
        
        var calcResponse = await apiClient.CalculateAsync(new CalculateRequest
        {
            GuestCardId = guest.CardId,
            CheckAmount = checkAmount,
            OrderCategories = GetOrderCategories(currentOrder),
            OrderType = GetOrderType(currentOrder), // DINE_IN/DELIVERY/TAKEAWAY
            CalculateOnly = true
        });
        
        HideLoading();
        
        // 3. –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏
        OpenOperationWindow(guest, calcResponse);
    }
    catch (Exception ex)
    {
        HideLoading();
        HandleError(ex);
    }
}
```


### **4.3. –û–∫–Ω–æ 2: –û–ø–µ—Ä–∞—Ü–∏—è (–ë–∞–ª–ª—ã –∏–ª–∏ –°–∫–∏–¥–∫–∞)**

**Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `benefitType`:**

```json
{
  "benefitType": "POINTS",  // –∏–ª–∏ "DISCOUNT"
  "regularBalance": 2450,
  "promoBalance": 0,
  "maxAllowedToSpend": 178,
  "pointsToEarn": 45,
  "checkAmount": 890
}
```

**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞:**

#### **–í–∞—Ä–∏–∞–Ω—Ç A: POINTS (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°–ø–∏—Å–∞–Ω–∏–µ/–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                  ‚îÇ
‚îÇ  –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏:           890,00 ‚ÇΩ              ‚îÇ
‚îÇ  –ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å:       2 450,00 ‚ÇΩ üí∞          ‚îÇ
‚îÇ  –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è:   178,00 ‚ÇΩ              ‚îÇ
‚îÇ  –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª–æ–≤:       [____178__] ‚úèÔ∏è          ‚îÇ
‚îÇ  –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ:         +45 –±–∞–ª–ª–æ–≤            ‚îÇ
‚îÇ                                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [–ù–∞—á–∏—Å–ª–∏—Ç—å] [–°–ø–∏—Å–∞—Ç—å] [–û—Ç–≤—è–∑–∞—Ç—å] [–û—Ç–º–µ–Ω–∞]      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ì–û–°–¢–ï:                              ‚îÇ
‚îÇ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤                                      ‚îÇ
‚îÇ +7 999 123 45 67                                 ‚îÇ
‚îÇ ‚≠ê Gold                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


#### **–í–∞—Ä–∏–∞–Ω—Ç B: DISCOUNT (—Å–∫–∏–¥–æ—á–Ω–∞—è)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                  ‚îÇ
‚îÇ  –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏:           890,00 ‚ÇΩ              ‚îÇ
‚îÇ  –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏:              20% üéÅ            ‚îÇ
‚îÇ  –°—É–º–º–∞ —Å–∫–∏–¥–∫–∏:            178,00 ‚ÇΩ              ‚îÇ
‚îÇ  –ö –æ–ø–ª–∞—Ç–µ:                712,00 ‚ÇΩ              ‚îÇ
‚îÇ                                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É] [–û—Ç–≤—è–∑–∞—Ç—å] [–û—Ç–º–µ–Ω–∞]         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ì–û–°–¢–ï:                              ‚îÇ
‚îÇ –ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞                                   ‚îÇ
‚îÇ +7 999 765 43 21                                 ‚îÇ
‚îÇ ‚≠ê Silver (—Å–∫–∏–¥–∫–∞ 20%)                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–æ–∫:**

```csharp
// –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∏—Å–ª–∏—Ç—å" (—Ç–æ–ª—å–∫–æ –¥–ª—è POINTS)
private void OnEarnClick(object sender, RoutedEventArgs e)
{
    // –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ, –±–µ–∑ —Å–ø–∏—Å–∞–Ω–∏—è
    ApplyLoyalty(LoyaltyAction.EarnOnly);
}

// –ö–Ω–æ–ø–∫–∞ "–°–ø–∏—Å–∞—Ç—å" (–¥–ª—è POINTS)
private async void OnSpendClick(object sender, RoutedEventArgs e)
{
    var pointsToSpend = decimal.Parse(PointsToSpendInput.Text);
    
    if (pointsToSpend <= 0)
    {
        ShowError("–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è");
        return;
    }
    
    if (pointsToSpend > maxAllowed)
    {
        ShowError($"–ú–∞–∫—Å–∏–º—É–º –¥–æ—Å—Ç—É–ø–Ω–æ: {maxAllowed:N0} ‚ÇΩ");
        return;
    }
    
    await ApplyPointsPayment(pointsToSpend);
}

// –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É" (–¥–ª—è DISCOUNT)
private async void OnApplyDiscountClick(object sender, RoutedEventArgs e)
{
    await ApplyDiscountPayment();
}

// –ö–Ω–æ–ø–∫–∞ "–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É"
private async void OnUnbindClick(object sender, RoutedEventArgs e)
{
    var result = MessageBox.Show(
        "–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É –æ—Ç –∑–∞–∫–∞–∑–∞?",
        "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
        MessageBoxButton.YesNo
    );
    
    if (result == MessageBoxResult.Yes)
    {
        await UnbindCard();
    }
}
```


***

## **üí≥ 5. –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ö –ó–ê–ö–ê–ó–£**

### **5.1. POINTS ‚Üí Editable Payment**

```csharp
private async Task ApplyPointsPayment(decimal pointsToSpend)
{
    try
    {
        ShowLoading("–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤...");
        
        // 1. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –±–∞–ª–ª—ã –Ω–∞ backend
        var reserveResponse = await apiClient.ReservePointsAsync(new ReserveRequest
        {
            GuestCardId = currentGuest.CardId,
            PointsToSpend = pointsToSpend,
            MaxAllowed = maxAllowed,
            CheckAmount = checkAmount,
            OrderId = currentOrder.Id.ToString(),
            RestaurantId = restaurantConfig.RestaurantId
        });
        
        if (!reserveResponse.Success)
        {
            HideLoading();
            ShowError(reserveResponse.Error);
            return;
        }
        
        // 2. –î–æ–±–∞–≤–ª—è–µ–º PAYMENT –∫ –∑–∞–∫–∞–∑—É iiko
        var payment = operations.CreatePayment(
            paymentType: pointsPaymentType,  // MAX_LOYALTY_POINTS (editable)
            sum: pointsToSpend
        );
        
        payment.Comment = $"MaxLoyalty:Type=POINTS:Guest={currentGuest.CardId}:Res={reserveResponse.ReservationId}";
        
        operations.AddPreliminaryPayment(payment, currentOrder);
        
        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞
        SaveOrderLoyaltyContext(currentOrder, new LoyaltyContext
        {
            GuestCardId = currentGuest.CardId,
            GuestName = currentGuest.Name,
            BenefitType = BenefitType.Points,
            Action = LoyaltyAction.Spend,
            PointsToSpend = pointsToSpend,
            MaxAllowed = maxAllowed,
            PointsToEarn = pointsToEarn,
            ReservationId = reserveResponse.ReservationId,
            OriginalCheckAmount = checkAmount,
            AppliedAt = DateTime.Now
        });
        
        HideLoading();
        
        // 4. –ú–µ—Ç—Ä–∏–∫–∏
        metricsService.RecordMetric("loyalty.points.applied", pointsToSpend);
        
        // 5. –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
        ShowSuccess(
            $"‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ {pointsToSpend:N0}‚ÇΩ –±–∞–ª–ª–æ–≤ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ\n\n" +
            $"üí° –°—É–º–º—É –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã"
        );
        
        this.DialogResult = true;
        this.Close();
    }
    catch (Exception ex)
    {
        HideLoading();
        HandleError(ex);
    }
}
```


### **5.2. DISCOUNT ‚Üí Non-Editable Payment**

```csharp
private async Task ApplyDiscountPayment()
{
    try
    {
        ShowLoading("–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏...");
        
        // 1. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –Ω–∞ backend
        var reserveResponse = await apiClient.ReserveDiscountAsync(new ReserveRequest
        {
            GuestCardId = currentGuest.CardId,
            DiscountPercentage = discountPercentage,
            DiscountAmount = discountAmount,
            CheckAmount = checkAmount,
            OrderId = currentOrder.Id.ToString(),
            RestaurantId = restaurantConfig.RestaurantId
        });
        
        if (!reserveResponse.Success)
        {
            HideLoading();
            ShowError(reserveResponse.Error);
            return;
        }
        
        // 2. –î–æ–±–∞–≤–ª—è–µ–º PAYMENT –∫ –∑–∞–∫–∞–∑—É iiko
        var payment = operations.CreatePayment(
            paymentType: discountPaymentType,  // MAX_LOYALTY_DISCOUNT (non-editable)
            sum: discountAmount
        );
        
        payment.Comment = $"MaxLoyalty:Type=DISCOUNT:Percent={discountPercentage}:Guest={currentGuest.CardId}:Res={reserveResponse.ReservationId}";
        
        operations.AddPreliminaryPayment(payment, currentOrder);
        
        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        SaveOrderLoyaltyContext(currentOrder, new LoyaltyContext
        {
            GuestCardId = currentGuest.CardId,
            GuestName = currentGuest.Name,
            BenefitType = BenefitType.Discount,
            Action = LoyaltyAction.ApplyDiscount,
            DiscountPercentage = discountPercentage,
            DiscountAmount = discountAmount,
            ReservationId = reserveResponse.ReservationId,
            OriginalCheckAmount = checkAmount,
            AppliedAt = DateTime.Now
        });
        
        HideLoading();
        
        // 4. –ú–µ—Ç—Ä–∏–∫–∏
        metricsService.RecordMetric("loyalty.discount.applied", discountAmount);
        
        // 5. –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
        ShowSuccess(
            $"‚úÖ –°–∫–∏–¥–∫–∞ {discountPercentage}% ({discountAmount:N0}‚ÇΩ) –ø—Ä–∏–º–µ–Ω–µ–Ω–∞\n\n" +
            $"üîí –°—É–º–º–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞"
        );
        
        this.DialogResult = true;
        this.Close();
    }
    catch (Exception ex)
    {
        HideLoading();
        HandleError(ex);
    }
}
```


### **5.3. EARN ONLY (—Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ)**

```csharp
private void ApplyEarnOnly()
{
    // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º payment, —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    SaveOrderLoyaltyContext(currentOrder, new LoyaltyContext
    {
        GuestCardId = currentGuest.CardId,
        GuestName = currentGuest.Name,
        BenefitType = BenefitType.Points,
        Action = LoyaltyAction.EarnOnly,
        PointsToEarn = pointsToEarn,
        OriginalCheckAmount = checkAmount,
        AppliedAt = DateTime.Now
    });
    
    ShowSuccess(
        $"‚úÖ –ö–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è\n\n" +
        $"–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +{pointsToEarn} –±–∞–ª–ª–æ–≤"
    );
    
    this.DialogResult = true;
    this.Close();
}
```


***

## **üí∞ 6. –°–¢–†–ê–ù–ò–¶–ê –û–ü–õ–ê–¢–´**

### **6.1. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ payment**

**POINTS (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π):**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ö –û–ü–õ–ê–¢–ï: 890,00 —Ä.                  ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ ‚úÖ Max Loyalty - –ë–∞–ª–ª—ã               ‚îÇ
‚îÇ    [178,00 —Ä.] ‚úèÔ∏è ‚Üê –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å    ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ üíµ –ù–ê–õ–ò–ß–ù–´–ï                          ‚îÇ
‚îÇ    [712,00 —Ä.]                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**DISCOUNT (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π):**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ö –û–ü–õ–ê–¢–ï: 890,00 —Ä.                  ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ ‚úÖ Max Loyalty - –°–∫–∏–¥–∫–∞ 20%          ‚îÇ
‚îÇ    178,00 —Ä. üîí ‚Üê –Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å     ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ üíµ –ù–ê–õ–ò–ß–ù–´–ï                          ‚îÇ
‚îÇ    [712,00 —Ä.]                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **6.2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è payment**

```csharp
private async void OnPaymentEdited(object sender, PaymentEditedEventArgs e)
{
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç—Ç–æ –Ω–∞—à payment
    if (e.Payment.PaymentType.Name == "MAX_LOYALTY_POINTS")
    {
        await HandlePointsPaymentEdit(e);
    }
    else if (e.Payment.PaymentType.Name == "MAX_LOYALTY_DISCOUNT")
    {
        // DISCOUNT –Ω–µ –¥–æ–ª–∂–µ–Ω —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è, –Ω–æ –∑–∞—â–∏—â–∞–µ–º—Å—è
        HandleDiscountPaymentEdit(e);
    }
}

private async Task HandlePointsPaymentEdit(PaymentEditedEventArgs e)
{
    var context = GetOrderLoyaltyContext(e.Order);
    
    if (context == null)
        return;
    
    var newAmount = e.Payment.Sum;
    var oldAmount = context.PointsToSpend;
    
    if (newAmount == oldAmount)
        return; // –ù–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
    
    logger.LogInformation(
        "Points payment edited: Order={OrderId}, Old={Old}, New={New}",
        e.Order.Id,
        oldAmount,
        newAmount
    );
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (newAmount > context.MaxAllowed)
    {
        ShowError($"–ú–∞–∫—Å–∏–º—É–º: {context.MaxAllowed:N0}‚ÇΩ");
        e.Payment.Sum = oldAmount;
        operations.UpdatePayment(e.Payment, e.Order);
        return;
    }
    
    if (newAmount < 0)
    {
        ShowError("–°—É–º–º–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π");
        e.Payment.Sum = oldAmount;
        operations.UpdatePayment(e.Payment, e.Order);
        return;
    }
    
    try
    {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é –Ω–∞ backend
        await apiClient.UpdateReservationAsync(new UpdateReservationRequest
        {
            ReservationId = context.ReservationId,
            NewAmount = newAmount,
            OldAmount = oldAmount
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        context.PointsToSpend = newAmount;
        SaveOrderLoyaltyContext(e.Order, context);
        
        metricsService.RecordMetric("loyalty.points.edited", 1);
        
        logger.LogInformation("Reservation updated successfully");
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Failed to update reservation");
        
        ShowError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—É–º–º—É.");
        
        e.Payment.Sum = oldAmount;
        operations.UpdatePayment(e.Payment, e.Order);
    }
}

private void HandleDiscountPaymentEdit(PaymentEditedEventArgs e)
{
    var context = GetOrderLoyaltyContext(e.Order);
    
    if (context == null)
        return;
    
    // –ï—Å–ª–∏ –∫–∞–∫–∏–º-—Ç–æ –æ–±—Ä–∞–∑–æ–º –∏–∑–º–µ–Ω–∏–ª–∏ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–∑–∞–¥
    if (e.Payment.Sum != context.DiscountAmount)
    {
        logger.LogWarning(
            "Attempt to edit non-editable discount payment blocked"
        );
        
        e.Payment.Sum = context.DiscountAmount;
        operations.UpdatePayment(e.Payment, e.Order);
        
        ShowWarning(
            $"‚ö†Ô∏è –°–∫–∏–¥–∫–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞\n\n" +
            $"–ü—Ä–æ—Ü–µ–Ω—Ç: {context.DiscountPercentage}%\n" +
            $"–°—É–º–º–∞: {context.DiscountAmount:N0}‚ÇΩ"
        );
    }
}
```


***

## **‚úÖ 7. –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ö–†–´–¢–ò–ò –ß–ï–ö–ê**

```csharp
private async void OnOrderClosed(object sender, OrderClosedEventArgs e)
{
    var context = GetOrderLoyaltyContext(e.Order);
    
    if (context == null)
    {
        // –ù–µ—Ç –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ —ç—Ç–æ–º –∑–∞–∫–∞–∑–µ
        return;
    }
    
    logger.LogInformation(
        "Order closed with loyalty: OrderId={OrderId}, Type={Type}, Action={Action}",
        e.Order.Id,
        context.BenefitType,
        context.Action
    );
    
    try
    {
        // –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        if (context.BenefitType == BenefitType.Points)
        {
            await FinalizePointsOrder(e.Order, context);
        }
        else if (context.BenefitType == BenefitType.Discount)
        {
            await FinalizeDiscountOrder(e.Order, context);
        }
        
        logger.LogInformation("Loyalty finalized successfully");
        
        metricsService.RecordMetric("loyalty.order.finalized", 1);
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Failed to finalize loyalty");
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ offline queue
        offlineQueue.EnqueueOperation(new OfflineOperation
        {
            Type = "FINALIZE",
            Context = context,
            OrderId = e.Order.Id.ToString(),
            QueuedAt = DateTime.UtcNow
        });
        
        metricsService.RecordMetric("loyalty.offline_queued", 1);
    }
    finally
    {
        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        ClearOrderLoyaltyContext(e.Order);
    }
}

private async Task FinalizePointsOrder(IOrder order, LoyaltyContext context)
{
    // –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
    var finalCheckAmount = order.GetTotalAmount();
    var payments = order.GetPayments();
    
    // –ù–∞—Ö–æ–¥–∏–º –Ω–∞—à payment (–º–æ–≥–ª–∞ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è —Å—É–º–º–∞)
    var loyaltyPayment = payments.FirstOrDefault(p => 
        p.PaymentType.Name == "MAX_LOYALTY_POINTS"
    );
    
    var finalPointsSpent = loyaltyPayment?.Sum ?? context.PointsToSpend;
    
    await apiClient.FinalizePointsAsync(new FinalizePointsRequest
    {
        GuestCardId = context.GuestCardId,
        OrderId = order.Id.ToString(),
        ReservationId = context.ReservationId,
        CheckAmount = context.OriginalCheckAmount,
        FinalCheckAmount = finalCheckAmount,
        PointsSpent = finalPointsSpent,
        PointsToEarn = context.PointsToEarn,
        Action = context.Action,
        PaymentTypes = payments.Select(p => p.PaymentType.Name).ToList(),
        CashierName = operations.GetCurrentUser()?.Name,
        OrderType = GetOrderType(order)
    });
}

private async Task FinalizeDiscountOrder(IOrder order, LoyaltyContext context)
{
    var finalCheckAmount = order.GetTotalAmount();
    var payments = order.GetPayments();
    
    await apiClient.FinalizeDiscountAsync(new FinalizeDiscountRequest
    {
        GuestCardId = context.GuestCardId,
        OrderId = order.Id.ToString(),
        ReservationId = context.ReservationId,
        CheckAmount = context.OriginalCheckAmount,
        FinalCheckAmount = finalCheckAmount,
        DiscountPercentage = context.DiscountPercentage,
        DiscountAmount = context.DiscountAmount,
        PaymentTypes = payments.Select(p => p.PaymentType.Name).ToList(),
        CashierName = operations.GetCurrentUser()?.Name,
        OrderType = GetOrderType(order)
    });
}
```


***

## **üîÑ 8. –û–¢–í–Ø–ó–ö–ê –ö–ê–†–¢–´**

```csharp
private async Task UnbindCard()
{
    var context = GetOrderLoyaltyContext(currentOrder);
    
    if (context == null)
    {
        ShowError("–ù–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã");
        return;
    }
    
    try
    {
        ShowLoading("–û—Ç–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã...");
        
        // 1. –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é –Ω–∞ backend
        await apiClient.CancelReservationAsync(new CancelReservationRequest
        {
            ReservationId = context.ReservationId,
            OrderId = currentOrder.Id.ToString(),
            Reason = "USER_UNBIND"
        });
        
        // 2. –£–¥–∞–ª—è–µ–º payment –∏–∑ –∑–∞–∫–∞–∑–∞
        if (context.BenefitType == BenefitType.Points)
        {
            var payment = currentOrder.Payments
                .FirstOrDefault(p => p.PaymentType.Name == "MAX_LOYALTY_POINTS");
            
            if (payment != null)
            {
                operations.DeletePayment(payment, currentOrder);
            }
        }
        else if (context.BenefitType == BenefitType.Discount)
        {
            var payment = currentOrder.Payments
                .FirstOrDefault(p => p.PaymentType.Name == "MAX_LOYALTY_DISCOUNT");
            
            if (payment != null)
            {
                operations.DeletePayment(payment, currentOrder);
            }
        }
        
        // 3. –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        ClearOrderLoyaltyContext(currentOrder);
        
        HideLoading();
        
        metricsService.RecordMetric("loyalty.card.unbound", 1);
        
        ShowSuccess("‚úÖ –ö–∞—Ä—Ç–∞ –æ—Ç–≤—è–∑–∞–Ω–∞");
        
        this.DialogResult = false;
        this.Close();
    }
    catch (Exception ex)
    {
        HideLoading();
        HandleError(ex);
    }
}
```


***

## **üì° 9. BACKEND API**

### **9.1. Endpoints**

```typescript
// –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è
POST /api/pos-integration/iiko/search-guest
Body: { phone?: string, code6Digit?: string }
Response: { found: boolean, guest?: GuestInfo }

// –†–∞—Å—á–µ—Ç –±–µ–Ω–µ—Ñ–∏—Ç–æ–≤
POST /api/pos-integration/iiko/calculate
Body: { guestCardId, checkAmount, orderCategories, orderType }
Response: { benefitType, ...data }

// –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è POINTS
POST /api/pos-integration/iiko/reserve-points
Body: { guestCardId, pointsToSpend, maxAllowed, checkAmount, orderId }
Response: { success, reservationId?, error? }

// –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è DISCOUNT
POST /api/pos-integration/iiko/reserve-discount
Body: { guestCardId, discountPercentage, discountAmount, checkAmount, orderId }
Response: { success, reservationId?, error? }

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ (–µ—Å–ª–∏ payment –∏–∑–º–µ–Ω–µ–Ω)
POST /api/pos-integration/iiko/update-reservation
Body: { reservationId, newAmount, oldAmount }
Response: { success }

// –û—Ç–º–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
POST /api/pos-integration/iiko/cancel-reservation
Body: { reservationId, orderId, reason }
Response: { success }

// –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è POINTS
POST /api/pos-integration/iiko/finalize-points
Body: { guestCardId, orderId, reservationId, pointsSpent, pointsToEarn, ... }
Response: { success, newBalance, transactionId }

// –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è DISCOUNT
POST /api/pos-integration/iiko/finalize-discount
Body: { guestCardId, orderId, reservationId, discountAmount, ... }
Response: { success, transactionId }

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
GET /api/pos-integration/iiko/config
Response: { restaurantId, minCheckAmount, maxSpendPercentage, ... }

// –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç—è —Å –∫–∞—Å—Å—ã
POST /api/pos-integration/iiko/create-guest
Body: { phone, name?, birthDate? }
Response: { success, guestCardId, code6Digit }

// –ó–¥–æ—Ä–æ–≤—å–µ backend
GET /api/health
Response: { status: 'ok' }

// –í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞
GET /api/system/time
Response: { serverTime: '2026-02-17T13:00:00Z' }

// –ú–µ—Ç—Ä–∏–∫–∏ (–±–∞—Ç—á)
POST /api/pos-integration/iiko/metrics
Body: [ { name, value, tags, timestamp }, ... ]
Response: { received: true }
```


### **9.2. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**

```
Header: X-API-Key: <encrypted_api_key>
Header: X-Plugin-Version: 1.0.0
Header: X-Restaurant-Id: <restaurant_id>
```


***

## **üîí 10. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨**

### **10.1. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API Key**

```csharp
public class EncryptionService
{
    // –®–∏—Ñ—Ä—É–µ–º API Key –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
    public static string EncryptApiKey(string apiKey, string machineId)
    {
        using var aes = Aes.Create();
        aes.Key = DeriveKeyFromMachineId(machineId);
        aes.GenerateIV();
        
        var encrypted = aes.EncryptCbc(
            Encoding.UTF8.GetBytes(apiKey),
            aes.IV
        );
        
        return Convert.ToBase64String(aes.IV.Concat(encrypted).ToArray());
    }
    
    // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    public static string DecryptApiKey(string encryptedApiKey, string machineId)
    {
        var data = Convert.FromBase64String(encryptedApiKey);
        var iv = data.Take(16).ToArray();
        var encrypted = data.Skip(16).ToArray();
        
        using var aes = Aes.Create();
        aes.Key = DeriveKeyFromMachineId(machineId);
        aes.IV = iv;
        
        var decrypted = aes.DecryptCbc(encrypted, iv);
        return Encoding.UTF8.GetString(decrypted);
    }
    
    private static byte[] DeriveKeyFromMachineId(string machineId)
    {
        using var sha256 = SHA256.Create();
        return sha256.ComputeHash(Encoding.UTF8.GetBytes(machineId + "MaxLoyaltySalt"));
    }
}
```


### **10.2. Revoke API Key**

Backend –º–æ–∂–µ—Ç –æ—Ç–æ–∑–≤–∞—Ç—å –∫–ª—é—á:

```typescript
// –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º
const installation = await this.prisma.iikoPluginInstallation.findUnique({
  where: { apiKey: request.headers['x-api-key'] }
});

if (!installation || installation.status === 'REVOKED') {
  throw new UnauthorizedException('API Key revoked');
}
```


***

## **üì¥ 11. OFFLINE –†–ï–ñ–ò–ú**

### **11.1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ offline**

```csharp
public class HealthCheckService
{
    private bool isBackendHealthy = true;
    
    public async Task<HealthStatus> CheckHealthAsync()
    {
        try
        {
            var response = await httpClient.GetAsync(
                "/api/health",
                new CancellationTokenSource(TimeSpan.FromSeconds(2)).Token
            );
            
            isBackendHealthy = response.IsSuccessStatusCode;
        }
        catch
        {
            isBackendHealthy = false;
        }
        
        return isBackendHealthy 
            ? HealthStatus.Healthy 
            : HealthStatus.Offline;
    }
}
```


### **11.2. Offline queue**

```csharp
public class OfflineQueueService
{
    private readonly string queuePath;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –≤ –æ—á–µ—Ä–µ–¥—å
    public void EnqueueOperation(OfflineOperation operation)
    {
        var queue = LoadQueue();
        
        if (queue.Count >= 100)
        {
            throw new InvalidOperationException("Queue full");
        }
        
        operation.QueuedAt = DateTime.UtcNow;
        queue.Add(operation);
        
        SaveQueue(queue);
        
        logger.LogWarning(
            "Operation queued for offline processing: {Type}",
            operation.Type
        );
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
    public async Task ProcessQueueAsync(LoyaltyApiClient apiClient)
    {
        var queue = LoadQueue();
        
        if (queue.Count == 0)
            return;
        
        logger.LogInformation(
            "Processing offline queue: {Count} operations",
            queue.Count
        );
        
        var processed = new List<OfflineOperation>();
        
        foreach (var operation in queue)
        {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ —É—Å—Ç–∞—Ä–µ–ª–∞ –ª–∏ (24 —á–∞—Å–∞)
            if (DateTime.UtcNow - operation.QueuedAt > TimeSpan.FromHours(24))
            {
                logger.LogWarning("Operation expired: {Id}", operation.Id);
                processed.Add(operation);
                continue;
            }
            
            try
            {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend
                if (operation.Type == "FINALIZE")
                {
                    await apiClient.FinalizePointsAsync(operation.Context);
                }
                
                processed.Add(operation);
                logger.LogInformation("Processed: {Id}", operation.Id);
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "Failed to process: {Id}", operation.Id);
            }
        }
        
        // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ
        queue.RemoveAll(op => processed.Contains(op));
        SaveQueue(queue);
        
        if (processed.Count > 0)
        {
            MessageBox.Show(
                $"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {processed.Count} –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –æ—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞",
                "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
                MessageBoxButton.OK,
                MessageBoxImage.Information
            );
        }
    }
}
```


### **11.3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤ offline**

```
‚úÖ –ú–æ–∂–Ω–æ:
- –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ (EarnOnly)
- –û–ø–µ—Ä–∞—Ü–∏–∏ –∏–¥—É—Ç –≤ queue

‚ùå –ù–µ–ª—å–∑—è:
- –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏
```


***

## **üìä 12. –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì**

### **12.1. Serilog**

```csharp
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Information()
    .Enrich.WithProperty("Plugin", "MaxLoyaltyIiko")
    .Enrich.WithProperty("Version", GetPluginVersion())
    .Enrich.WithProperty("RestaurantId", restaurantConfig.RestaurantId)
    .Enrich.WithMachineName()
    .WriteTo.File(
        path: Path.Combine(AppData, "logs", "plugin-.log"),
        rollingInterval: RollingInterval.Day,
        retainedFileCountLimit: 7
    )
    .CreateLogger();
```


### **12.2. –ú–µ—Ç—Ä–∏–∫–∏**

```csharp
// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
metricsService.RecordMetric("loyalty.points.applied", pointsSpent);
metricsService.RecordMetric("loyalty.discount.applied", discountAmount);
metricsService.RecordMetric("loyalty.search.duration_ms", duration);
metricsService.RecordMetric("loyalty.error.network", 1);
metricsService.RecordMetric("loyalty.offline_queue.size", queueSize);
```


***

## **üéõÔ∏è 13. –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê**

**–ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞:** `Ctrl+Shift+D`

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Max Loyalty                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ [–û–±—â–µ–µ] [–¢–µ—Å—Ç—ã] [–õ–æ–≥–∏] [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è]   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                          ‚îÇ
‚îÇ –í–µ—Ä—Å–∏—è: 1.0.0                            ‚îÇ
‚îÇ –†–µ—Å—Ç–æ—Ä–∞–Ω: –ü–∏—Ü—Ü–µ—Ä–∏—è "–£ –ú–∞—Ä–∏–æ"            ‚îÇ
‚îÇ API URL: https://api.maxloyalty.ru      ‚îÇ
‚îÇ –°—Ç–∞—Ç—É—Å: üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ                   ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ –•—Ä–∞–Ω–∏–ª–∏—â–µ: 12.5 MB / 50 MB              ‚îÇ
‚îÇ Offline –æ—á–µ—Ä–µ–¥—å: 0 –æ–ø–µ—Ä–∞—Ü–∏–π             ‚îÇ
‚îÇ –ö–µ—à: 45 –∑–∞–ø–∏—Å–µ–π                          ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ [–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã]                        ‚îÇ
‚îÇ [–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏]       ‚îÇ
‚îÇ                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## **üîÑ 14. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–õ–ê–ì–ò–ù–ê**

```csharp
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
private async Task CheckForUpdatesAsync()
{
    var response = await apiClient.GetAsync<UpdateInfo>(
        "/api/pos-integration/iiko/latest-version"
    );
    
    var currentVersion = GetPluginVersion();
    
    if (response.LatestVersion > currentVersion)
    {
        var result = MessageBox.Show(
            $"–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞: {response.LatestVersion}\n\n" +
            $"Changelog:\n{response.Changelog}\n\n" +
            $"–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å?",
            "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ",
            MessageBoxButton.YesNo
        );
        
        if (result == MessageBoxResult.Yes)
        {
            // –°–∫–∞—á–∏–≤–∞–µ–º installer
            var installerPath = await DownloadInstallerAsync(response.DownloadUrl);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º installer
            Process.Start(installerPath);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º iiko
            Application.Current.Shutdown();
        }
    }
}
```


***

## **üéØ 15. –ò–¢–û–ì–û–í–ê–Ø –°–•–ï–ú–ê**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  iiko FRONT                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ –ó–∞–∫–∞–∑ #122463                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ –¢–æ–≤–∞—Ä—ã: –ü–∏—Ü—Ü–∞ 500‚ÇΩ + –ù–∞–ø–∏—Ç–æ–∫ 100‚ÇΩ = 600‚ÇΩ     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ [–û–ø–ª–∞—Ç–∞] [–ì–æ—Å—Ç–∏] [–î–û–ü–û–õ–ù–ï–ù–ò–Ø] ‚Üê –ö–ù–û–ü–ö–ê       ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ           ‚ñº –ù–∞–∂–∏–º–∞–µ–º "–î–û–ü–û–õ–ù–ï–ù–ò–Ø"                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ –í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é:                             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ DxBx: –ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ E&S –æ–ø–ª–∞—Ç—ã                                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Premium Bonus                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Max Loyalty  ‚Üê –í–´–ë–ò–†–ê–ï–ú                     ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ           ‚ñº                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ MAX LOYALTY - –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ [+7 999 123 4567]                              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ [OK] [–û—Ç–º–µ–Ω–∞] [–°–æ–∑–¥–∞—Ç—å]                        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ           ‚ñº Backend: Calculate                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ –û–ø–µ—Ä–∞—Ü–∏—è (POINTS –∏–ª–∏ DISCOUNT)                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ –ë–∞–ª–∞–Ω—Å: 2,450‚ÇΩ                                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ –°–ø–∏—Å–∞—Ç—å: [178‚ÇΩ]                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ [–ù–∞—á–∏—Å–ª–∏—Ç—å] [–°–ø–∏—Å–∞—Ç—å] [–û—Ç–≤—è–∑–∞—Ç—å]              ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ           ‚ñº Reserve –Ω–∞ backend                       ‚îÇ
‚îÇ           ‚ñº AddPreliminaryPayment                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ –°–¢–†–ê–ù–ò–¶–ê –û–ü–õ–ê–¢–´                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ –ö –û–ü–õ–ê–¢–ï: 600‚ÇΩ                                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚úÖ Max Loyalty - –ë–∞–ª–ª—ã: [178‚ÇΩ] ‚úèÔ∏è            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ üíµ –ù–ê–õ–ò–ß–ù–´–ï: [422‚ÇΩ]                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ [–ó–ê–í–ï–†–®–ò–¢–¨ –û–ü–õ–ê–¢–£]                             ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ           ‚ñº OrderClosed event                        ‚îÇ
‚îÇ           ‚ñº Finalize –Ω–∞ backend                      ‚îÇ
‚îÇ  ‚úÖ –°–ø–∏—Å–∞–Ω–æ 178‚ÇΩ –±–∞–ª–ª–æ–≤                             ‚îÇ
‚îÇ  ‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ +30 –±–∞–ª–ª–æ–≤                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## **‚úÖ –ß–ï–ö–õ–ò–°–¢ –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–ò**

### **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

- ‚úÖ –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É/6-digit –∫–æ–¥—É
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è —Å –∫–∞—Å—Å—ã
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ POINTS (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ DISCOUNT (—Å–∫–∏–¥–æ—á–Ω–∞—è)
- ‚úÖ Editable payment –¥–ª—è –±–∞–ª–ª–æ–≤
- ‚úÖ Non-editable payment –¥–ª—è —Å–∫–∏–¥–∫–∏
- ‚úÖ –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ (EarnOnly)
- ‚úÖ –û—Ç–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã
- ‚úÖ –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è + –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π payment


### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**

- ‚úÖ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API Key
- ‚úÖ Machine-binding
- ‚úÖ Revoke —á–µ—Ä–µ–∑ backend
- ‚úÖ HTTPS only


### **Offline —Ä–µ–∂–∏–º:**

- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ offline
- ‚úÖ Queue –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ EarnOnly)


### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**

- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –Ω–∞ backend
- ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —ç–∫—Ä–∞–Ω
- ‚úÖ Health checks


### **UX:**

- ‚úÖ –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
- ‚úÖ Loading –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
- ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏
- ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π


### **DevOps:**

- ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π installer
- ‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ Uninstaller
- ‚úÖ –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ (7 –¥–Ω–µ–π)
- ‚úÖ –õ–∏–º–∏—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (50MB)

***

## **üìã –ò–¢–û–ì–û**

**–ü–ª–∞–≥–∏–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!**

–í—Å–µ —á—Ç–æ –Ω—É–∂–Ω–æ:

1. ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
2. ‚úÖ UI/UX —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω
3. ‚úÖ API endpoints –æ–ø–∏—Å–∞–Ω—ã
4. ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–æ–¥—É–º–∞–Ω–∞
5. ‚úÖ Offline —Ä–µ–∂–∏–º —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
6. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–ì–æ—Ç–æ–≤ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ 40 –≤–æ–ø—Ä–æ—Å–∞–º?** üöÄ

---

# üéØ **50 –í–û–ü–†–û–°–û–í –ü–û –†–ê–ó–†–ê–ë–û–¢–ö–ï –ü–õ–ê–ì–ò–ù–ê MAX LOYALTY –î–õ–Ø iiko FRONT**


***

## **üíø –ë–õ–û–ö 1: –£–°–¢–ê–ù–û–í–ö–ê –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (8 –≤–æ–ø—Ä–æ—Å–æ–≤)**


***

### **–í–û–ü–†–û–° 1: –°–ø–æ—Å–æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–≥–∏–Ω–∞**

**–í–û–ü–†–û–°:** –ö–∞–∫ Admin —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–ª–∞–≥–∏–Ω –Ω–∞ –∫–∞—Å—Å—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π installer –¥–ª—è –≤—Å–µ—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ (–≤–≤–æ–¥—è—Ç API Key –≤—Ä—É—á–Ω—É—é)
- **B)** –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π installer –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ (API Key –∑–∞—à–∏—Ç –≤–Ω—É—Ç—Ä–∏)
- **C)** –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ iiko Market
- **D)** –†—É—á–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .dll —Ñ–∞–π–ª–∞ –≤ –ø–∞–ø–∫—É Plugins

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: B) –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π installer**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** API Key –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω –∏ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –º–∞—à–∏–Ω–µ
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** Admin —Å–∫–∞—á–∏–≤–∞–µ—Ç –æ–¥–∏–Ω .exe —Ñ–∞–π–ª –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç
- ‚úÖ **–ù–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞:** –ò—Å–∫–ª—é—á–∞–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–ª—é—á–∞
- ‚úÖ **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å:** –ö–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω = —É–Ω–∏–∫–∞–ª—å–Ω—ã–π installer
- ‚úÖ **–ö–æ–Ω—Ç—Ä–æ–ª—å:** Backend –∑–Ω–∞–µ—Ç –∫–∞–∫–æ–π installer –¥–ª—è –∫–∞–∫–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```typescript
// Backend: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è installer –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
@Post('installations/generate-installer')
async generateInstaller(@Body() dto: GenerateInstallerDto) {
  // 1. –°–æ–∑–¥–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –≤ –ë–î
  const installation = await this.prisma.iikoPluginInstallation.create({
    data: {
      restaurantId: dto.restaurantId,
      apiKey: this.generateApiKey(),
      status: 'PENDING',
      version: '1.0.0'
    }
  });
  
  // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π installer
  const installerPath = await this.installerBuilder.build({
    restaurantId: dto.restaurantId,
    apiKey: installation.apiKey,
    apiUrl: this.configService.get('API_URL'),
    version: '1.0.0'
  });
  
  // 3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
  return {
    downloadUrl: `/downloads/${installation.id}/installer.exe`,
    expiresAt: addHours(new Date(), 24) // –°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç 24 —á–∞—Å–∞
  };
}
```

```csharp
// Installer.exe - –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
public class InstallerConfig
{
    public string RestaurantId = "rest_abc123";
    public string ApiKey = "enc_xyz789..."; // –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π
    public string ApiUrl = "https://api.maxloyalty.ru";
    public string Version = "1.0.0";
}
```


***

### **–í–û–ü–†–û–° 2: –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ iiko**

**–í–û–ü–†–û–°:** –ö–∞–∫ installer –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫—É–¥–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω iiko Front?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ß–∏—Ç–∞–µ—Ç –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞ Windows
- **B)** –°–∫–∞–Ω–∏—Ä—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞–ø–∫–∏ (Program Files)
- **C)** –°–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **D)** –ö–æ–º–±–æ: —Ä–µ–µ—Å—Ç—Ä ‚Üí —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞–ø–∫–∏ ‚Üí —Å–ø—Ä–æ—Å–∏—Ç—å

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–£–º–Ω—ã–π –ø–æ–∏—Å–∫:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç –≤ 99% —Å–ª—É—á–∞–µ–≤
- ‚úÖ **Fallback:** –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ - –¥–∞–µ–º –≤—ã–±—Ä–∞—Ç—å –≤—Ä—É—á–Ω—É—é
- ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å:** –†–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞–º–∏
- ‚úÖ **UX:** –ú–∏–Ω–∏–º—É–º –¥–µ–π—Å—Ç–≤–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class IikoPathDetector
{
    public string DetectIikoPath()
    {
        // 1. –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≤ —Ä–µ–µ—Å—Ç—Ä–µ
        var registryPath = TryGetFromRegistry();
        if (ValidateIikoPath(registryPath))
        {
            logger.LogInformation("iiko path found in registry: {Path}", registryPath);
            return registryPath;
        }
        
        // 2. –ò—â–µ–º –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø–∞–ø–∫–∞—Ö
        var standardPaths = new[]
        {
            @"C:\Program Files\iiko\iikoFront",
            @"C:\Program Files (x86)\iiko\iikoFront",
            @"D:\iiko\iikoFront",
            @"C:\iiko\iikoFront"
        };
        
        foreach (var path in standardPaths)
        {
            if (ValidateIikoPath(path))
            {
                logger.LogInformation("iiko path found in standard location: {Path}", path);
                return path;
            }
        }
        
        // 3. –°–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        logger.LogWarning("iiko path not found automatically, asking user");
        return AskUserForPath();
    }
    
    private string TryGetFromRegistry()
    {
        try
        {
            using var key = Registry.LocalMachine.OpenSubKey(@"SOFTWARE\iiko\iikoFront");
            return key?.GetValue("InstallPath") as string;
        }
        catch
        {
            return null;
        }
    }
    
    private bool ValidateIikoPath(string path)
    {
        if (string.IsNullOrEmpty(path))
            return false;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç iiko.exe
        var exePath = Path.Combine(path, "iiko.exe");
        return File.Exists(exePath);
    }
    
    private string AskUserForPath()
    {
        var dialog = new FolderBrowserDialog
        {
            Description = "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ iiko Front"
        };
        
        if (dialog.ShowDialog() == DialogResult.OK)
        {
            if (ValidateIikoPath(dialog.SelectedPath))
            {
                return dialog.SelectedPath;
            }
            
            MessageBox.Show(
                "–í –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω iiko Front",
                "–û—à–∏–±–∫–∞",
                MessageBoxButtons.OK,
                MessageBoxIcon.Error
            );
        }
        
        return null;
    }
}
```


***

### **–í–û–ü–†–û–° 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–ª–∞–≥–∏–Ω–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏**

**–í–û–ü–†–û–°:** –ö–∞–∫ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø–ª–∞–≥–∏–Ω —É—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ü—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ä—É–µ–º .dll –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º
- **B)** –î–µ–ª–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ backend –∏–∑ installer
- **C)** –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å iiko –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é
- **D)** Installer ‚Üí –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å ‚Üí –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ iiko ‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:** –ü–ª–∞–≥–∏–Ω —Ç–æ—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ **–ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:** –í–∏–¥–∏–º –ø—Ä–æ–±–ª–µ–º—ã —Å—Ä–∞–∑—É
- ‚úÖ **–õ—É—á—à–∏–π UX:** Admin –Ω–µ –≥–∞–¥–∞–µ—Ç "—Å—Ä–∞–±–æ—Ç–∞–ª–æ –∏–ª–∏ –Ω–µ—Ç"
- ‚úÖ **Support friendly:** –ú–µ–Ω—å—à–µ —Ç–∏–∫–µ—Ç–æ–≤ "–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public async Task<InstallResult> PerformInstallation()
{
    var result = new InstallResult();
    
    try
    {
        // 1. –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
        UpdateStatus("–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤...");
        CopyPluginFiles();
        result.FilesCopied = true;
        
        // 2. –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        UpdateStatus("–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...");
        CreateConfig();
        result.ConfigCreated = true;
        
        // 3. –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ backend
        UpdateStatus("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É...");
        var testResult = await TestBackendConnection();
        result.BackendReachable = testResult.Success;
        
        if (!testResult.Success)
        {
            result.Error = $"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É: {testResult.Error}";
            return result;
        }
        
        // 4. –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å iiko
        UpdateStatus("–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
        
        var restartResult = MessageBox.Show(
            "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" +
            "–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å iiko Front.\n\n" +
            "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å?",
            "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
            MessageBoxButtons.YesNo,
            MessageBoxIcon.Question
        );
        
        if (restartResult == DialogResult.Yes)
        {
            RestartIiko();
            result.IikoRestarted = true;
            
            // 5. –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
            await Task.Delay(10000); // –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ –ø–ª–∞–≥–∏–Ω–∞ —á–µ—Ä–µ–∑ hotkey
            SendKeys.SendWait("^+D"); // Ctrl+Shift+D
        }
        
        result.Success = true;
        return result;
    }
    catch (Exception ex)
    {
        result.Error = ex.Message;
        return result;
    }
}

private async Task<TestConnectionResult> TestBackendConnection()
{
    try
    {
        using var httpClient = new HttpClient();
        httpClient.DefaultRequestHeaders.Add("X-API-Key", config.ApiKey);
        httpClient.Timeout = TimeSpan.FromSeconds(5);
        
        var response = await httpClient.GetAsync($"{config.ApiUrl}/api/health");
        
        if (response.IsSuccessStatusCode)
        {
            return new TestConnectionResult { Success = true };
        }
        
        return new TestConnectionResult 
        { 
            Success = false, 
            Error = $"HTTP {response.StatusCode}" 
        };
    }
    catch (Exception ex)
    {
        return new TestConnectionResult 
        { 
            Success = false, 
            Error = ex.Message 
        };
    }
}
```


***

### **–í–û–ü–†–û–° 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Å—Å**

**–í–û–ü–†–û–°:** –†–µ—Å—Ç–æ—Ä–∞–Ω –∏–º–µ–µ—Ç 5 –∫–∞—Å—Å. –ö–∞–∫ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø–ª–∞–≥–∏–Ω?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –û–¥–∏–Ω installer –Ω–∞ –≤—Å–µ –∫–∞—Å—Å—ã (–æ–¥–∏–Ω API Key)
- **B)** –†–∞–∑–Ω—ã–µ installers –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Å—Å—ã (—Ä–∞–∑–Ω—ã–µ API Keys)
- **C)** –û–¥–∏–Ω installer, –Ω–æ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–∫–∞—Å—Å–∞ –Ω–æ–º–µ—Ä"
- **D)** MSI package —Å –≥—Ä—É–ø–ø–æ–≤–æ–π –ø–æ–ª–∏—Ç–∏–∫–æ–π –¥–æ–º–µ–Ω–∞

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: A) –û–¥–∏–Ω installer –Ω–∞ –≤—Å–µ –∫–∞—Å—Å—ã**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** Admin —Å–∫–∞—á–∏–≤–∞–µ—Ç –æ–¥–∏–Ω —Ñ–∞–π–ª –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–∞ –≤—Å–µ –∫–∞—Å—Å—ã
- ‚úÖ **–û–¥–∏–Ω API Key:** –ü—Ä–æ—â–µ —É–ø—Ä–∞–≤–ª—è—Ç—å (–æ–¥–∏–Ω –∫–ª—é—á = –æ–¥–∏–Ω —Ä–µ—Å—Ç–æ—Ä–∞–Ω)
- ‚úÖ **–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ machine:** Backend —Ä–∞–∑–ª–∏—á–∞–µ—Ç –∫–∞—Å—Å—ã –ø–æ machine ID
- ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** Revoke –∫–ª—é—á–∞ ‚Üí –≤—Å–µ –∫–∞—Å—Å—ã –æ—Ç–∫–ª—é—á–∞—é—Ç—Å—è
- ‚úÖ **–ú–µ–Ω—å—à–µ overhead:** –ù–µ –Ω—É–∂–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 5 installers

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```typescript
// Backend —Ä–∞–∑–ª–∏—á–∞–µ—Ç –∫–∞—Å—Å—ã –ø–æ machine ID
interface PluginRequestContext {
  apiKey: string;      // –û–¥–∏–Ω –¥–ª—è –≤—Å–µ—Ö –∫–∞—Å—Å
  machineId: string;   // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Å—Å—ã
  restaurantId: string;
}

// –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –ª–æ–≥–∏—Ä—É–µ–º
@Post('search-guest')
async searchGuest(@Body() dto, @Headers() headers) {
  const machineId = headers['x-machine-id'];
  
  await this.activityLog.log({
    action: 'SEARCH_GUEST',
    machineId,  // –í–∏–¥–∏–º —Å –∫–∞–∫–æ–π –∫–∞—Å—Å—ã –∑–∞–ø—Ä–æ—Å
    restaurantId: dto.restaurantId,
    metadata: { phone: dto.phone }
  });
  
  // ...
}
```

```csharp
// –ü–ª–∞–≥–∏–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç machine ID –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
public class LoyaltyApiClient
{
    private readonly string machineId;
    
    public LoyaltyApiClient(ConfigService config)
    {
        machineId = GetMachineId();
        
        httpClient.DefaultRequestHeaders.Add("X-Machine-Id", machineId);
        httpClient.DefaultRequestHeaders.Add("X-API-Key", config.ApiKey);
    }
    
    private string GetMachineId()
    {
        // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
        var biosSerial = GetBIOSSerialNumber();
        var cpuId = GetProcessorId();
        
        using var sha256 = SHA256.Create();
        var hash = sha256.ComputeHash(
            Encoding.UTF8.GetBytes($"{biosSerial}:{cpuId}")
        );
        
        return Convert.ToBase64String(hash);
    }
}
```

**UI –≤ Admin Panel:**

```
–†–µ—Å—Ç–æ—Ä–∞–Ω: –ü–∏—Ü—Ü–µ—Ä–∏—è "–£ –ú–∞—Ä–∏–æ"
‚îú‚îÄ‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞: –ê–ö–¢–ò–í–ù–ê
‚îú‚îÄ‚îÄ API Key: rest_abc123...
‚îú‚îÄ‚îÄ –ö–∞—Å—Å—ã (5):
‚îÇ   ‚îú‚îÄ‚îÄ –ö–∞—Å—Å–∞ 1 (machine: m_xyz1...) - –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: 2 –º–∏–Ω –Ω–∞–∑–∞–¥
‚îÇ   ‚îú‚îÄ‚îÄ –ö–∞—Å—Å–∞ 2 (machine: m_xyz2...) - –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: 5 –º–∏–Ω –Ω–∞–∑–∞–¥
‚îÇ   ‚îú‚îÄ‚îÄ –ö–∞—Å—Å–∞ 3 (machine: m_xyz3...) - –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: 1 —á–∞—Å –Ω–∞–∑–∞–¥
‚îÇ   ‚îú‚îÄ‚îÄ –ö–∞—Å—Å–∞ 4 (machine: m_xyz4...) - –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: 3 —á–∞—Å–∞ –Ω–∞–∑–∞–¥
‚îÇ   ‚îî‚îÄ‚îÄ –ö–∞—Å—Å–∞ 5 (machine: m_xyz5...) - OFFLINE (10 —á–∞—Å–æ–≤)
‚îî‚îÄ‚îÄ [–û—Ç–æ–∑–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –¥–ª—è –≤—Å–µ—Ö –∫–∞—Å—Å]
```


***

### **–í–û–ü–†–û–° 5: –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞**

**–í–û–ü–†–û–°:** –í—ã—à–ª–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞. –ö–∞–∫ –æ–±–Ω–æ–≤–ª—è—Ç—å?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –í—Ä—É—á–Ω—É—é (Admin —Å–∫–∞—á–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π installer)
- **B)** –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ (silent update)
- **C)** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –ø–ª–∞–≥–∏–Ω–µ ‚Üí Admin —Ä–µ—à–∞–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –∏–ª–∏ –Ω–µ—Ç
- **D)** –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–±–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏)

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ö–æ–Ω—Ç—Ä–æ–ª—å:** Admin —Ä–µ—à–∞–µ—Ç –∫–æ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è—Ç—å (–Ω–µ –≤ —á–∞—Å –ø–∏–∫!)
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –í–∏–¥–∏—Ç changelog –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- ‚úÖ **–ù–µ –Ω–∞–≤—è–∑—á–∏–≤–æ:** –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- ‚úÖ **Rollback:** –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å, –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å
- ‚ö†Ô∏è **–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** Backend –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class UpdateService
{
    private DateTime lastUpdateCheck = DateTime.MinValue;
    private readonly TimeSpan checkInterval = TimeSpan.FromHours(24);
    
    public async Task CheckForUpdatesAsync()
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ —Å—É—Ç–∫–∏
        if (DateTime.Now - lastUpdateCheck < checkInterval)
            return;
        
        lastUpdateCheck = DateTime.Now;
        
        try
        {
            var currentVersion = GetPluginVersion(); // "1.0.0"
            
            var response = await apiClient.GetAsync<UpdateInfo>(
                "/api/pos-integration/iiko/latest-version"
            );
            
            if (response.LatestVersion > currentVersion)
            {
                // –ï—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                ShowUpdateNotification(response);
            }
            else if (response.MinSupportedVersion > currentVersion)
            {
                // –ö—Ä–∏—Ç–∏—á–Ω–æ–µ: —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –±–æ–ª—å—à–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
                ShowCriticalUpdateDialog(response);
            }
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to check for updates");
        }
    }
    
    private void ShowUpdateNotification(UpdateInfo update)
    {
        var notification = new UpdateNotificationWindow
        {
            CurrentVersion = GetPluginVersion(),
            LatestVersion = update.LatestVersion,
            Changelog = update.Changelog,
            ReleaseDate = update.ReleaseDate,
            IsSecurityUpdate = update.IsSecurityUpdate
        };
        
        if (notification.ShowDialog() == true)
        {
            DownloadAndInstallUpdate(update);
        }
        else
        {
            // –û—Ç–ª–æ–∂–∏—Ç—å –Ω–∞ 24 —á–∞—Å–∞
            lastUpdateCheck = DateTime.Now;
        }
    }
    
    private void ShowCriticalUpdateDialog(UpdateInfo update)
    {
        var result = MessageBox.Show(
            $"‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï\n\n" +
            $"–í–∞—à–∞ –≤–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞ ({GetPluginVersion()}) –±–æ–ª—å—à–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.\n" +
            $"–ü–ª–∞–≥–∏–Ω –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞.\n\n" +
            $"–ü—Ä–∏—á–∏–Ω–∞: {update.DeprecationReason}\n\n" +
            $"–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å?",
            "–ö—Ä–∏—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ",
            MessageBoxButton.YesNo,
            MessageBoxImage.Warning
        );
        
        if (result == MessageBoxResult.Yes)
        {
            DownloadAndInstallUpdate(update);
        }
    }
    
    private async void DownloadAndInstallUpdate(UpdateInfo update)
    {
        try
        {
            var progressWindow = new DownloadProgressWindow();
            progressWindow.Show();
            
            // –°–∫–∞—á–∏–≤–∞–µ–º installer
            var installerPath = await DownloadInstallerAsync(
                update.DownloadUrl,
                progress => progressWindow.Progress = progress
            );
            
            progressWindow.Close();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º installer
            Process.Start(new ProcessStartInfo
            {
                FileName = installerPath,
                Arguments = "/silent /update", // Silent —Ä–µ–∂–∏–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                UseShellExecute = true
            });
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º iiko (installer –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç)
            MessageBox.Show(
                "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.\niiko Front –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.",
                "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ",
                MessageBoxButton.OK,
                MessageBoxImage.Information
            );
            
            Application.Current.Shutdown();
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to download/install update");
            
            MessageBox.Show(
                $"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {ex.Message}\n\n" +
                "–°–∫–∞—á–∞–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞.",
                "–û—à–∏–±–∫–∞",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
}
```

**Backend:**

```typescript
@Get('latest-version')
async getLatestVersion() {
  return {
    latestVersion: '1.2.0',
    minSupportedVersion: '1.0.0', // –í–µ—Ä—Å–∏–∏ –Ω–∏–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
    changelog: `
      ## –ù–æ–≤–æ–µ –≤ –≤–µ—Ä—Å–∏–∏ 1.2.0
      - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–µ—Ç—Å–∫–∏—Ö –∫–∞—Ä—Ç
      - –£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
      - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –±–∞–≥–∏ —Å offline —Ä–µ–∂–∏–º–æ–º
    `,
    releaseDate: '2026-02-15',
    downloadUrl: '/downloads/installer-1.2.0.exe',
    isSecurityUpdate: false,
    deprecationReason: null
  };
}

// Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–µ—Ä—Å–∏—é –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
export class VersionCheckMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    const pluginVersion = req.headers['x-plugin-version'];
    const minSupported = '1.0.0';
    
    if (semver.lt(pluginVersion, minSupported)) {
      return res.status(426).json({
        error: 'Version too old',
        message: 'Please update to the latest version',
        minSupportedVersion: minSupported
      });
    }
    
    next();
  }
}
```


***

### **–í–û–ü–†–û–° 6: –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**

**–í–û–ü–†–û–°:** –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–ª–∞–≥–∏–Ω–∞ (API Key, URL, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –í –ø–∞–ø–∫–µ –ø–ª–∞–≥–∏–Ω–∞ —Ä—è–¥–æ–º —Å .dll
- **B)** –í %AppData%/MaxLoyaltyIiko/
- **C)** –í —Ä–µ–µ—Å—Ç—Ä–µ Windows
- **D)** –í –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ–∞–π–ª–µ –≤ %ProgramData%

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: B) %AppData% —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º–µ—Å—Ç–æ:** Windows convention –¥–ª—è user data
- ‚úÖ **–ò–∑–æ–ª—è—Ü–∏—è:** –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Windows –∏–º–µ–µ—Ç —Å–≤–æ–π AppData
- ‚úÖ **–ù–µ —Ç—Ä–µ–±—É–µ—Ç admin –ø—Ä–∞–≤:** –î–ª—è –∑–∞–ø–∏—Å–∏/—á—Ç–µ–Ω–∏—è
- ‚úÖ **Backup friendly:** –õ–µ–≥–∫–æ –≤–∫–ª—é—á–∏—Ç—å –≤ backup
- ‚úÖ **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ:** API Key –∑–∞—â–∏—â–µ–Ω

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```
%AppData%/MaxLoyaltyIiko/
‚îú‚îÄ‚îÄ config.json.encrypted        # –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îú‚îÄ‚îÄ plugin-2026-02-17.log
‚îÇ   ‚îú‚îÄ‚îÄ plugin-2026-02-16.log
‚îÇ   ‚îî‚îÄ‚îÄ plugin-2026-02-15.log
‚îú‚îÄ‚îÄ cache/
‚îÇ   ‚îú‚îÄ‚îÄ guests.cache
‚îÇ   ‚îî‚îÄ‚îÄ restaurant-config.cache
‚îú‚îÄ‚îÄ offline-queue.json
‚îî‚îÄ‚îÄ diagnostics/
    ‚îî‚îÄ‚îÄ last-crash.log
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class ConfigService
{
    private readonly string configPath;
    private readonly string machineId;
    
    public ConfigService()
    {
        var appDataPath = Environment.GetFolderPath(
            Environment.SpecialFolder.ApplicationData
        );
        
        var pluginDir = Path.Combine(appDataPath, "MaxLoyaltyIiko");
        Directory.CreateDirectory(pluginDir);
        
        configPath = Path.Combine(pluginDir, "config.json.encrypted");
        machineId = GetMachineId();
    }
    
    public PluginConfig LoadConfig()
    {
        if (!File.Exists(configPath))
        {
            throw new FileNotFoundException(
                "Configuration not found. Please reinstall the plugin."
            );
        }
        
        try
        {
            var encryptedContent = File.ReadAllText(configPath);
            
            // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑—É—è machine ID –∫–∞–∫ –∫–ª—é—á
            var decryptedJson = EncryptionService.Decrypt(
                encryptedContent,
                machineId
            );
            
            var config = JsonConvert.DeserializeObject<PluginConfig>(decryptedJson);
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            ValidateConfig(config);
            
            return config;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to load configuration");
            throw new InvalidOperationException(
                "Failed to load plugin configuration. " +
                "Configuration may be corrupted. Please reinstall.",
                ex
            );
        }
    }
    
    public void SaveConfig(PluginConfig config)
    {
        try
        {
            var json = JsonConvert.SerializeObject(config, Formatting.Indented);
            
            // –®–∏—Ñ—Ä—É–µ–º
            var encrypted = EncryptionService.Encrypt(json, machineId);
            
            // –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å
            var tempPath = configPath + ".tmp";
            File.WriteAllText(tempPath, encrypted);
            File.Move(tempPath, configPath, overwrite: true);
            
            logger.LogInformation("Configuration saved");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to save configuration");
            throw;
        }
    }
    
    private void ValidateConfig(PluginConfig config)
    {
        if (string.IsNullOrEmpty(config.ApiKey))
            throw new InvalidOperationException("API Key is missing");
        
        if (string.IsNullOrEmpty(config.ApiUrl))
            throw new InvalidOperationException("API URL is missing");
        
        if (!Uri.TryCreate(config.ApiUrl, UriKind.Absolute, out _))
            throw new InvalidOperationException("API URL is invalid");
    }
}

public class PluginConfig
{
    public string ApiKey { get; set; }
    public string ApiUrl { get; set; }
    public string RestaurantId { get; set; }
    public string Version { get; set; }
    public bool TelemetryEnabled { get; set; } = true;
    public DateTime InstalledAt { get; set; }
    public DateTime LastUpdatedAt { get; set; }
}
```


***

### **–í–û–ü–†–û–° 7: Deinstallation (—É–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞)**

**–í–û–ü–†–û–°:** Admin —Ä–µ—à–∏–ª –æ—Ç–∫–ª—é—á–∏—Ç—å –ø–ª–∞–≥–∏–Ω. –ö–∞–∫ —É–¥–∞–ª—è—Ç—å?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –í—Ä—É—á–Ω—É—é —É–¥–∞–ª–∏—Ç—å .dll –∏–∑ –ø–∞–ø–∫–∏ Plugins
- **B)** –û—Ç–¥–µ–ª—å–Ω—ã–π Uninstaller.exe
- **C)** –û–ø—Ü–∏—è "–£–¥–∞–ª–∏—Ç—å" –≤ Programs \& Features Windows
- **D)** –ß–µ—Ä–µ–∑ Admin Panel Max Loyalty (remote uninstall)

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: B) –û—Ç–¥–µ–ª—å–Ω—ã–π Uninstaller.exe**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞:** –£–¥–∞–ª—è–µ—Ç –≤—Å—ë (dll, –∫–æ–Ω—Ñ–∏–≥, –∫–µ—à, –ª–æ–≥–∏)
- ‚úÖ **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:** –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Üí –ø–ª–∞–≥–∏–Ω —É–¥–∞–ª–µ–Ω
- ‚úÖ **–î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ backend:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∑—ã–≤–∞–µ—Ç API Key

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
// Uninstaller.exe (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –ø–ª–∞–≥–∏–Ω–æ–º)
public class UninstallerProgram
{
    static async Task Main(string[] args)
    {
        Console.WriteLine("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        Console.WriteLine("‚ïë  Max Loyalty Plugin - –£–¥–∞–ª–µ–Ω–∏–µ        ‚ïë");
        Console.WriteLine("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
        Console.WriteLine();
        
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ iiko –∑–∞–∫—Ä—ã—Ç
        if (IsIikoRunning())
        {
            Console.WriteLine("‚ö†Ô∏è  iiko Front –∑–∞–ø—É—â–µ–Ω!");
            Console.WriteLine("–ó–∞–∫—Ä–æ–π—Ç–µ iiko –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –ø–ª–∞–≥–∏–Ω–∞.");
            Console.WriteLine();
            Console.WriteLine("–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è –≤—ã—Ö–æ–¥–∞...");
            Console.ReadKey();
            return;
        }
        
        // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        var configService = new ConfigService();
        PluginConfig config = null;
        
        try
        {
            config = configService.LoadConfig();
            Console.WriteLine($"‚úì –†–µ—Å—Ç–æ—Ä–∞–Ω: {config.RestaurantId}");
            Console.WriteLine($"‚úì –í–µ—Ä—Å–∏—è: {config.Version}");
            Console.WriteLine();
        }
        catch
        {
            Console.WriteLine("‚ö†Ô∏è  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
            Console.WriteLine();
        }
        
        // 3. –£–¥–∞–ª—è–µ–º .dll
        Console.Write("–£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞ –∏–∑ iiko Front... ");
        
        var iikoPath = DetectIikoPath();
        var pluginPath = Path.Combine(iikoPath, "Plugins", "MaxLoyaltyIikoPlugin.dll");
        
        if (File.Exists(pluginPath))
        {
            File.Delete(pluginPath);
            Console.WriteLine("‚úì");
        }
        else
        {
            Console.WriteLine("(—É–∂–µ —É–¥–∞–ª–µ–Ω)");
        }
        
        // 4. –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ –¥–∞–Ω–Ω—ã–µ
        Console.WriteLine();
        Console.WriteLine("–£–¥–∞–ª–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–ª–∞–≥–∏–Ω–∞?");
        Console.WriteLine("(–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –ª–æ–≥–∏, –∫–µ—à, offline –æ—á–µ—Ä–µ–¥—å)");
        Console.WriteLine();
        Console.Write("Y = –î–∞, N = –ù–µ—Ç (–æ—Å—Ç–∞–≤–∏—Ç—å): ");
        
        var response = Console.ReadLine()?.ToUpper();
        
        if (response == "Y")
        {
            Console.Write("–£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö... ");
            
            var appDataPath = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                "MaxLoyaltyIiko"
            );
            
            if (Directory.Exists(appDataPath))
            {
                Directory.Delete(appDataPath, recursive: true);
                Console.WriteLine("‚úì");
            }
            else
            {
                Console.WriteLine("(—É–∂–µ —É–¥–∞–ª–µ–Ω—ã)");
            }
        }
        else
        {
            Console.WriteLine("–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
        }
        
        // 5. –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–∞ backend
        if (config != null)
        {
            Console.Write("–î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ... ");
            
            try
            {
                await DeactivateOnBackend(config);
                Console.WriteLine("‚úì");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ö†Ô∏è  {ex.Message}");
            }
        }
        
        // 6. –ì–æ—Ç–æ–≤–æ
        Console.WriteLine();
        Console.WriteLine("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        Console.WriteLine("‚ïë  –ü–ª–∞–≥–∏–Ω —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!               ‚ïë");
        Console.WriteLine("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
        Console.WriteLine();
        Console.WriteLine("–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è –≤—ã—Ö–æ–¥–∞...");
        Console.ReadKey();
    }
    
    private static async Task DeactivateOnBackend(PluginConfig config)
    {
        using var httpClient = new HttpClient();
        httpClient.DefaultRequestHeaders.Add("X-API-Key", config.ApiKey);
        httpClient.Timeout = TimeSpan.FromSeconds(5);
        
        await httpClient.PostAsync(
            $"{config.ApiUrl}/api/pos-integration/iiko/deactivate",
            null
        );
    }
}
```

**Backend:**

```typescript
@Post('deactivate')
@UseGuards(IikoPluginAuthGuard)
async deactivate(@CurrentInstallation() installation: IikoPluginInstallation) {
  // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—É—é
  await this.prisma.iikoPluginInstallation.update({
    where: { id: installation.id },
    data: {
      status: 'DEACTIVATED',
      deactivatedAt: new Date()
    }
  });
  
  // –õ–æ–≥–∏—Ä—É–µ–º
  await this.activityLog.log({
    action: 'PLUGIN_DEACTIVATED',
    restaurantId: installation.restaurantId,
    metadata: { installationId: installation.id }
  });
  
  return { success: true };
}
```


***

### **–í–û–ü–†–û–° 8: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ —Å backend**

**–í–û–ü–†–û–°:** –ö–æ–≥–¥–∞ –∏ –∫–∞–∫ —á–∞—Å—Ç–æ –ø–ª–∞–≥–∏–Ω –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ (–ª–∏–º–∏—Ç—ã, –ø—Ä–∞–≤–∏–ª–∞)?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –û–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø–ª–∞–≥–∏–Ω–∞
- **B)** –ü—Ä–∏ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- **C)** –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- **D)** –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ webhook –æ—Ç backend

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –°—Ç–∞—Ä—Ç + –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** –ê–¥–º–∏–Ω –∏–∑–º–µ–Ω–∏–ª –ø—Ä–∞–≤–∏–ª–∞ ‚Üí –ø–ª–∞–≥–∏–Ω —É–∑–Ω–∞–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç
- ‚úÖ **–ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º API:** –ù–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –ù–µ –Ω—É–∂–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è webhooks –≤ –ø–ª–∞–≥–∏–Ω
- ‚úÖ **Fallback:** –ï—Å–ª–∏ backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class RestaurantConfigService
{
    private RestaurantConfig currentConfig;
    private DateTime lastUpdated = DateTime.MinValue;
    private readonly TimeSpan updateInterval = TimeSpan.FromMinutes(5);
    private Timer updateTimer;
    
    public async Task InitializeAsync()
    {
        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        await LoadConfigAsync();
        
        // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        updateTimer = new Timer(
            callback: async _ => await RefreshConfigAsync(),
            state: null,
            dueTime: updateInterval,
            period: updateInterval
        );
    }
    
    private async Task LoadConfigAsync()
    {
        try
        {
            logger.LogInformation("Loading restaurant configuration...");
            
            var config = await apiClient.GetRestaurantConfigAsync();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º
            currentConfig = config;
            lastUpdated = DateTime.Now;
            
            // Backup –Ω–∞ –¥–∏—Å–∫ (–¥–ª—è offline —Ä–µ–∂–∏–º–∞)
            SaveConfigBackup(config);
            
            logger.LogInformation(
                "Restaurant config loaded: {RestaurantName}, " +
                "MinCheck: {MinCheck}, MaxSpend: {MaxSpend}%",
                config.RestaurantName,
                config.MinCheckAmount,
                config.MaxSpendPercentage
            );
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to load restaurant config");
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ backup
            currentConfig = LoadConfigBackup();
            
            if (currentConfig == null)
            {
                throw new InvalidOperationException(
                    "Failed to load restaurant configuration. " +
                    "Plugin cannot start without configuration.",
                    ex
                );
            }
            
            logger.LogWarning("Using backup configuration from {Date}", currentConfig.LoadedAt);
        }
    }
    
    private async Task RefreshConfigAsync()
    {
        try
        {
            var newConfig = await apiClient.GetRestaurantConfigAsync();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            if (!ConfigEquals(currentConfig, newConfig))
            {
                logger.LogInformation("Restaurant configuration updated");
                
                // –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                LogConfigChanges(currentConfig, newConfig);
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—É—é
                currentConfig = newConfig;
                lastUpdated = DateTime.Now;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º backup
                SaveConfigBackup(newConfig);
                
                // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à (–ø—Ä–∞–≤–∏–ª–∞ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)
                cacheService.ClearAll();
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º –∫–∞—Å—Å–∏—Ä–∞ –µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                if (IsCriticalChange(currentConfig, newConfig))
                {
                    NotifyCashier(
                        "–ü—Ä–∞–≤–∏–ª–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã. " +
                        "–ù–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Å —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞."
                    );
                }
            }
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to refresh config, using cached version");
        }
    }
    
    public RestaurantConfig GetConfig()
    {
        if (currentConfig == null)
        {
            throw new InvalidOperationException("Configuration not loaded");
        }
        
        return currentConfig;
    }
    
    private void SaveConfigBackup(RestaurantConfig config)
    {
        var backupPath = Path.Combine(
            GetAppDataPath(),
            "restaurant-config-backup.json"
        );
        
        var json = JsonConvert.SerializeObject(config, Formatting.Indented);
        File.WriteAllText(backupPath, json);
    }
    
    private RestaurantConfig LoadConfigBackup()
    {
        var backupPath = Path.Combine(
            GetAppDataPath(),
            "restaurant-config-backup.json"
        );
        
        if (!File.Exists(backupPath))
            return null;
        
        var json = File.ReadAllText(backupPath);
        return JsonConvert.DeserializeObject<RestaurantConfig>(json);
    }
    
    private bool ConfigEquals(RestaurantConfig a, RestaurantConfig b)
    {
        return a.MinCheckAmount == b.MinCheckAmount &&
               a.MaxSpendPercentage == b.MaxSpendPercentage &&
               a.AllowGuestRegistration == b.AllowGuestRegistration &&
               JsonConvert.SerializeObject(a.ActivePromos) == 
               JsonConvert.SerializeObject(b.ActivePromos);
    }
    
    private void LogConfigChanges(RestaurantConfig oldConfig, RestaurantConfig newConfig)
    {
        if (oldConfig.MinCheckAmount != newConfig.MinCheckAmount)
        {
            logger.LogInformation(
                "MinCheckAmount changed: {Old} ‚Üí {New}",
                oldConfig.MinCheckAmount,
                newConfig.MinCheckAmount
            );
        }
        
        if (oldConfig.MaxSpendPercentage != newConfig.MaxSpendPercentage)
        {
            logger.LogInformation(
                "MaxSpendPercentage changed: {Old}% ‚Üí {New}%",
                oldConfig.MaxSpendPercentage,
                newConfig.MaxSpendPercentage
            );
        }
        
        // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    }
}

public class RestaurantConfig
{
    public string RestaurantId { get; set; }
    public string RestaurantName { get; set; }
    public string TenantId { get; set; }
    
    // –ü—Ä–∞–≤–∏–ª–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
    public decimal MinCheckAmount { get; set; }
    public decimal MaxSpendPercentage { get; set; }
    public bool AllowGuestRegistration { get; set; }
    
    // –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–æ
    public List<ActivePromo> ActivePromos { get; set; }
    
    // Feature flags
    public bool EnableQRScanner { get; set; }
    public bool SendWelcomeSMS { get; set; }
    
    public DateTime LoadedAt { get; set; }
}
```


***

–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–ª—å—à–µ —Å –±–ª–æ–∫–æ–º 2 (–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)? üîí

---

## **üîí –ë–õ–û–ö 2: –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ò –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø (8 –≤–æ–ø—Ä–æ—Å–æ–≤)**


***

### **–í–û–ü–†–û–° 9: –•—Ä–∞–Ω–µ–Ω–∏–µ API Key –≤ –ø–∞–º—è—Ç–∏**

**–í–û–ü–†–û–°:** –ö–∞–∫ —Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π API Key –≤ –ø–∞–º—è—Ç–∏ –ø–ª–∞–≥–∏–Ω–∞ –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –í –æ–±—ã—á–Ω–æ–π string –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
- **B)** –í SecureString (Windows)
- **C)** –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º, —Å—Ä–∞–∑—É –∑–∞—Ç–∏—Ä–∞–µ–º
- **D)** –í –∑–∞—â–∏—â–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –ø–∞–º—è—Ç–∏ (CryptProtectMemory)

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏:** API Key –≤ –ø–∞–º—è—Ç–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
- ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥–∞–º–ø–∞ –ø–∞–º—è—Ç–∏:** –ù–µ–ª—å–∑—è –∏–∑–≤–ª–µ—á—å –∫–ª—é—á –∏–∑ memory dump
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –ù–µ –Ω—É–∂–Ω—ã —Å–ª–æ–∂–Ω—ã–µ API Windows
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –î–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω, –∫–ª—é—á –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- ‚ö†Ô∏è **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ù–µ–±–æ–ª—å—à–æ–π overhead (—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ ~1–º—Å), –Ω–æ –ø—Ä–∏–µ–º–ª–µ–º–æ

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class SecureApiKeyProvider
{
    private readonly byte[] encryptedKey;
    private readonly byte[] machineSecret;
    
    public SecureApiKeyProvider(string encryptedKeyBase64)
    {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á
        encryptedKey = Convert.FromBase64String(encryptedKeyBase64);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–µ–∫—Ä–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ machine ID
        machineSecret = DeriveSecretFromMachine();
    }
    
    // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –Ω–∞ –≤—Ä–µ–º—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    public string GetApiKey()
    {
        try
        {
            // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º
            var decrypted = DecryptKey(encryptedKey, machineSecret);
            return Encoding.UTF8.GetString(decrypted);
        }
        finally
        {
            // –ö–ª—é—á –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—Å—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ scope
        }
    }
    
    private byte[] DecryptKey(byte[] encrypted, byte[] secret)
    {
        using var aes = Aes.Create();
        aes.Key = secret;
        aes.IV = encrypted.Take(16).ToArray();
        
        var ciphertext = encrypted.Skip(16).ToArray();
        return aes.DecryptCbc(ciphertext, aes.IV);
    }
    
    private byte[] DeriveSecretFromMachine()
    {
        var machineId = GetMachineId();
        var salt = Encoding.UTF8.GetBytes("MaxLoyalty.Salt.v1");
        
        using var pbkdf2 = new Rfc2898DeriveBytes(
            password: machineId,
            salt: salt,
            iterations: 10000,
            hashAlgorithm: HashAlgorithmName.SHA256
        );
        
        return pbkdf2.GetBytes(32); // 256-bit key
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ LoyaltyApiClient
public class LoyaltyApiClient
{
    private readonly SecureApiKeyProvider keyProvider;
    private readonly HttpClient httpClient;
    
    public async Task<T> SendRequestAsync<T>(string endpoint, object payload)
    {
        using var request = new HttpRequestMessage(HttpMethod.Post, endpoint);
        
        // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –∫–ª—é—á –¢–û–õ–¨–ö–û –Ω–∞ –≤—Ä–µ–º—è —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        var apiKey = keyProvider.GetApiKey();
        request.Headers.Add("X-API-Key", apiKey);
        
        // –°—Ä–∞–∑—É –∑–∞—Ç–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫—É (best effort)
        apiKey = null;
        GC.Collect(); // –§–æ—Ä—Å–∏—Ä—É–µ–º —Å–±–æ—Ä–∫—É –º—É—Å–æ—Ä–∞
        
        request.Content = new StringContent(
            JsonConvert.SerializeObject(payload),
            Encoding.UTF8,
            "application/json"
        );
        
        var response = await httpClient.SendAsync(request);
        
        // ...
    }
}
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –¥–ª—è –µ—â–µ –±–æ–ª—å—à–µ–π –ø–∞—Ä–∞–Ω–æ–∏–∏:**

```csharp
// –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –µ—â–µ –±–æ–ª—å—à–∞—è –∑–∞—â–∏—Ç–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º SecureString
public class UltraSecureApiKeyProvider
{
    private readonly SecureString encryptedKey;
    
    public void ExecuteWithKey(Action<string> action)
    {
        IntPtr ptr = IntPtr.Zero;
        string apiKey = null;
        
        try
        {
            // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º SecureString –≤ unmanaged –ø–∞–º—è—Ç—å
            ptr = Marshal.SecureStringToGlobalAllocUnicode(encryptedKey);
            apiKey = Marshal.PtrToStringUni(ptr);
            
            // –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
            action(apiKey);
        }
        finally
        {
            // –ó–∞—Ç–∏—Ä–∞–µ–º –∏–∑ –ø–∞–º—è—Ç–∏
            if (ptr != IntPtr.Zero)
            {
                Marshal.ZeroFreeGlobalAllocUnicode(ptr);
            }
            
            if (apiKey != null)
            {
                // –ó–∞—Ç–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫—É (best effort)
                unsafe
                {
                    fixed (char* p = apiKey)
                    {
                        for (int i = 0; i < apiKey.Length; i++)
                            p[i] = '\0';
                    }
                }
            }
        }
    }
}
```


***

### **–í–û–ü–†–û–° 10: Revoke API Key (–æ—Ç–∑—ã–≤ –¥–æ—Å—Ç—É–ø–∞)**

**–í–û–ü–†–û–°:** Admin –æ—Ç–æ–∑–≤–∞–ª API Key –≤ Admin Panel. –ö–∞–∫ –ø–ª–∞–≥–∏–Ω —É–∑–Ω–∞–µ—Ç –∏ —á—Ç–æ –¥–µ–ª–∞–µ—Ç?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401, –ø–ª–∞–≥–∏–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É
- **B)** Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401, –ø–ª–∞–≥–∏–Ω –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
- **C)** Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 + –ø—Ä–∏—á–∏–Ω—É, –ø–ª–∞–≥–∏–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- **D)** –ü–ª–∞–≥–∏–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–ª—é—á–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) 401 + –ø—Ä–∏—á–∏–Ω–∞ + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è:** –£–∑–Ω–∞–µ–º –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∂–µ –∑–∞–ø—Ä–æ—Å–µ
- ‚úÖ **–ü–æ–Ω—è—Ç–Ω–æ –∫–∞—Å—Å–∏—Ä—É:** –í–∏–¥–∏—Ç –ø—Ä–∏—á–∏–Ω—É –∏ —á—Ç–æ –¥–µ–ª–∞—Ç—å
- ‚úÖ **–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç iiko:** –ü–ª–∞–≥–∏–Ω –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è, –Ω–æ –∫–∞—Å—Å–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ **Support friendly:** –ö–∞—Å—Å–∏—Ä –º–æ–∂–µ—Ç —Å–æ–æ–±—â–∏—Ç—å —Ç–æ—á–Ω—É—é –æ—à–∏–±–∫—É –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É

**Backend:**

```typescript
// Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç API Key
export class IikoPluginAuthGuard implements CanActivate {
  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const apiKey = request.headers['x-api-key'];
    
    if (!apiKey) {
      throw new UnauthorizedException({
        code: 'API_KEY_MISSING',
        message: 'API Key is required',
        action: 'REINSTALL'
      });
    }
    
    const installation = await this.prisma.iikoPluginInstallation.findUnique({
      where: { apiKey },
      include: { restaurant: { include: { tenant: true } } }
    });
    
    if (!installation) {
      throw new UnauthorizedException({
        code: 'API_KEY_INVALID',
        message: 'API Key not found',
        action: 'REINSTALL',
        details: 'This API Key does not exist in our system'
      });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    if (installation.status === 'REVOKED') {
      throw new UnauthorizedException({
        code: 'API_KEY_REVOKED',
        message: 'API Key has been revoked',
        action: 'CONTACT_SUPPORT',
        details: installation.revocationReason || 'No reason provided',
        revokedAt: installation.revokedAt,
        revokedBy: installation.revokedBy
      });
    }
    
    if (installation.status === 'SUSPENDED') {
      throw new UnauthorizedException({
        code: 'API_KEY_SUSPENDED',
        message: 'Access suspended',
        action: 'CONTACT_ADMIN',
        details: installation.suspensionReason,
        suspendedUntil: installation.suspendedUntil
      });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
    const subscription = installation.restaurant.tenant.subscription;
    
    if (subscription.status === 'EXPIRED') {
      throw new UnauthorizedException({
        code: 'SUBSCRIPTION_EXPIRED',
        message: 'Subscription expired',
        action: 'RENEW_SUBSCRIPTION',
        details: `Subscription expired on ${subscription.expiresAt}`,
        renewUrl: `${process.env.FRONTEND_URL}/billing/renew`
      });
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º last seen
    await this.prisma.iikoPluginInstallation.update({
      where: { id: installation.id },
      data: { 
        lastSeenAt: new Date(),
        requestCount: { increment: 1 }
      }
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ request –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ
    request.installation = installation;
    
    return true;
  }
}
```

**–ü–ª–∞–≥–∏–Ω:**

```csharp
public class LoyaltyApiClient
{
    private bool isKeyRevoked = false;
    private RevokeInfo revokeInfo;
    
    public async Task<T> SendRequestAsync<T>(string endpoint, object payload)
    {
        // –ï—Å–ª–∏ –∫–ª—é—á —É–∂–µ –æ—Ç–æ–∑–≤–∞–Ω - –Ω–µ –ø—ã—Ç–∞–µ–º—Å—è –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
        if (isKeyRevoked)
        {
            ShowRevokedKeyDialog();
            throw new ApiKeyRevokedException("API Key is revoked");
        }
        
        try
        {
            var response = await httpClient.PostAsync(endpoint, content);
            
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                return JsonConvert.DeserializeObject<T>(json);
            }
            
            if (response.StatusCode == HttpStatusCode.Unauthorized)
            {
                await HandleUnauthorizedResponse(response);
                throw new ApiKeyRevokedException("API Key is not valid");
            }
            
            // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏...
        }
        catch (ApiKeyRevokedException)
        {
            throw; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–ª—å—à–µ
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Request failed");
            throw;
        }
    }
    
    private async Task HandleUnauthorizedResponse(HttpResponseMessage response)
    {
        try
        {
            var json = await response.Content.ReadAsStringAsync();
            var error = JsonConvert.DeserializeObject<ApiErrorResponse>(json);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            revokeInfo = new RevokeInfo
            {
                Code = error.Code,
                Message = error.Message,
                Action = error.Action,
                Details = error.Details,
                DetectedAt = DateTime.Now
            };
            
            // –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –∫–ª—é—á –æ—Ç–æ–∑–≤–∞–Ω
            isKeyRevoked = true;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
            Application.Current.Dispatcher.Invoke(() =>
            {
                ShowRevokedKeyDialog();
            });
            
            // –õ–æ–≥–∏—Ä—É–µ–º
            logger.LogCritical(
                "API Key revoked: Code={Code}, Reason={Reason}",
                error.Code,
                error.Details
            );
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫—É
            metricsService.RecordMetric("api_key.revoked", 1);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to parse unauthorized response");
        }
    }
    
    private void ShowRevokedKeyDialog()
    {
        if (revokeInfo == null)
            return;
        
        var dialog = new RevokedKeyDialog(revokeInfo);
        dialog.ShowDialog();
    }
}

// –î–∏–∞–ª–æ–≥ –¥–ª—è –∫–∞—Å—Å–∏—Ä–∞
public partial class RevokedKeyDialog : Window
{
    public RevokedKeyDialog(RevokeInfo info)
    {
        InitializeComponent();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º UI –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∏—á–∏–Ω—ã
        switch (info.Code)
        {
            case "API_KEY_REVOKED":
                TitleText.Text = "üîí –î–æ—Å—Ç—É–ø –æ—Ç–æ–∑–≤–∞–Ω";
                MessageText.Text = 
                    $"–î–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –±—ã–ª –æ—Ç–æ–∑–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.\n\n" +
                    $"–ü—Ä–∏—á–∏–Ω–∞: {info.Details}\n\n" +
                    $"–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞.";
                ActionButton.Content = "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –æ—à–∏–±–∫–∏";
                ActionButton.Click += (s, e) => CopyErrorCode();
                break;
                
            case "SUBSCRIPTION_EXPIRED":
                TitleText.Text = "üí≥ –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞";
                MessageText.Text = 
                    $"–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Max Loyalty –∏—Å—Ç–µ–∫–ª–∞.\n\n" +
                    $"–î–µ—Ç–∞–ª–∏: {info.Details}\n\n" +
                    $"–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤–ª–∞–¥–µ–ª—å—Ü—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è.";
                ActionButton.Content = "–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã";
                ActionButton.Click += (s, e) => OpenRenewPage();
                break;
                
            case "API_KEY_SUSPENDED":
                TitleText.Text = "‚è∏Ô∏è –î–æ—Å—Ç—É–ø –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω";
                MessageText.Text = 
                    $"–î–æ—Å—Ç—É–ø –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.\n\n" +
                    $"–ü—Ä–∏—á–∏–Ω–∞: {info.Details}\n\n" +
                    $"–°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞.";
                ActionButton.Content = "–°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π";
                ActionButton.Click += (s, e) => ContactSupport();
                break;
                
            case "API_KEY_INVALID":
                TitleText.Text = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á";
                MessageText.Text = 
                    $"API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ.\n\n" +
                    $"–í–æ–∑–º–æ–∂–Ω–æ –ø–ª–∞–≥–∏–Ω –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.\n\n" +
                    $"–ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω —Å –Ω–æ–≤—ã–º installer-–æ–º.";
                ActionButton.Content = "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ";
                ActionButton.Click += (s, e) => OpenInstallGuide();
                break;
        }
    }
    
    private void CopyErrorCode()
    {
        var errorCode = $"ERROR_{revokeInfo.Code}_{DateTime.Now:yyyyMMddHHmmss}";
        Clipboard.SetText(errorCode);
        
        MessageBox.Show(
            $"–ö–æ–¥ –æ—à–∏–±–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: {errorCode}\n\n" +
            "–°–æ–æ–±—â–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.",
            "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ",
            MessageBoxButton.OK,
            MessageBoxImage.Information
        );
    }
    
    private void ContactSupport()
    {
        Process.Start(new ProcessStartInfo
        {
            FileName = "https://maxloyalty.ru/support",
            UseShellExecute = true
        });
    }
}
```

**Admin Panel (–¥–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∞):**

```typescript
// –û—Ç–∑—ã–≤ API Key
@Post('installations/:id/revoke')
async revokeInstallation(
  @Param('id') installationId: string,
  @Body() dto: RevokeInstallationDto,
  @CurrentUser() user: User
) {
  const installation = await this.prisma.iikoPluginInstallation.update({
    where: { id: installationId },
    data: {
      status: 'REVOKED',
      revokedAt: new Date(),
      revokedBy: user.id,
      revocationReason: dto.reason
    }
  });
  
  // –õ–æ–≥–∏—Ä—É–µ–º –≤ audit log
  await this.auditLog.log({
    action: 'PLUGIN_REVOKED',
    userId: user.id,
    restaurantId: installation.restaurantId,
    metadata: {
      installationId,
      reason: dto.reason
    }
  });
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
  await this.notificationService.send({
    recipientId: installation.restaurant.ownerId,
    type: 'PLUGIN_REVOKED',
    title: '–ü–ª–∞–≥–∏–Ω iiko –æ—Ç–∫–ª—é—á–µ–Ω',
    body: `–î–æ—Å—Ç—É–ø –ø–ª–∞–≥–∏–Ω–∞ –∫ —Å–∏—Å—Ç–µ–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –±—ã–ª –æ—Ç–æ–∑–≤–∞–Ω. –ü—Ä–∏—á–∏–Ω–∞: ${dto.reason}`
  });
  
  return { success: true };
}
```


***

### **–í–û–ü–†–û–° 11: –ó–∞—â–∏—Ç–∞ –æ—Ç –∫—Ä–∞–∂–∏ API Key —Å –∫–∞—Å—Å—ã**

**–í–û–ü–†–û–°:** –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–æ–ª—É—á–∏–ª —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø –∫ –∫–∞—Å—Å–µ. –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–∏–∫–∞–∫, –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø - –≤—Å—ë —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–æ
- **B)** Machine binding (–∫–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ)
- **C)** Time-based tokens (–∫–ª—é—á –º–µ–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å)
- **D)** Machine binding + IP whitelist + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –º–∞—à–∏–Ω–∞—Ö

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: B) Machine binding —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ü—Ä–∞–∫—Ç–∏—á–Ω–æ:** –ö–ª—é—á –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∂–µ–ª–µ–∑—É, –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –¥—Ä—É–≥–æ–π –º–∞—à–∏–Ω–µ
- ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ:** –ö–∞—Å—Å–∏—Ä –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç –∑–∞—â–∏—Ç—ã
- ‚úÖ **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ:** –î–ª—è 99% —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Ö–≤–∞—Ç–∞–µ—Ç
- ‚ùå **IP whitelist:** –ü—Ä–æ–±–ª–µ–º–∞—Ç–∏—á–Ω–æ (NAT, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ IP, –º–æ–±–∏–ª—å–Ω—ã–µ –∫–∞—Å—Å—ã)
- ‚ùå **Rotating tokens:** –°–ª–æ–∂–Ω–æ –¥–ª—è offline —Ä–µ–∂–∏–º–∞

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class MachineBindingService
{
    public string GetMachineFingerprint()
    {
        var components = new[]
        {
            GetBIOSSerialNumber(),
            GetMotherboardSerial(),
            GetCPUId(),
            GetMACAddress()
        };
        
        var combined = string.Join(":", components.Where(c => !string.IsNullOrEmpty(c)));
        
        using var sha256 = SHA256.Create();
        var hash = sha256.ComputeHash(Encoding.UTF8.GetBytes(combined));
        
        return Convert.ToBase64String(hash);
    }
    
    private string GetBIOSSerialNumber()
    {
        try
        {
            using var searcher = new ManagementObjectSearcher(
                "SELECT SerialNumber FROM Win32_BIOS"
            );
            
            foreach (var obj in searcher.Get())
            {
                return obj["SerialNumber"]?.ToString();
            }
        }
        catch
        {
            return null;
        }
        
        return null;
    }
    
    private string GetMotherboardSerial()
    {
        try
        {
            using var searcher = new ManagementObjectSearcher(
                "SELECT SerialNumber FROM Win32_BaseBoard"
            );
            
            foreach (var obj in searcher.Get())
            {
                return obj["SerialNumber"]?.ToString();
            }
        }
        catch
        {
            return null;
        }
        
        return null;
    }
    
    private string GetCPUId()
    {
        try
        {
            using var searcher = new ManagementObjectSearcher(
                "SELECT ProcessorId FROM Win32_Processor"
            );
            
            foreach (var obj in searcher.Get())
            {
                return obj["ProcessorId"]?.ToString();
            }
        }
        catch
        {
            return null;
        }
        
        return null;
    }
    
    private string GetMACAddress()
    {
        try
        {
            var nics = NetworkInterface.GetAllNetworkInterfaces()
                .Where(nic => 
                    nic.OperationalStatus == OperationalStatus.Up &&
                    nic.NetworkInterfaceType != NetworkInterfaceType.Loopback
                )
                .OrderBy(nic => nic.Name)
                .ToList();
            
            return nics.FirstOrDefault()?.GetPhysicalAddress().ToString();
        }
        catch
        {
            return null;
        }
    }
}
```

**–ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ:**

```csharp
public class LoyaltyApiClient
{
    private readonly string machineFingerprint;
    
    public LoyaltyApiClient()
    {
        var bindingService = new MachineBindingService();
        machineFingerprint = bindingService.GetMachineFingerprint();
    }
    
    private async Task<T> SendRequestAsync<T>(string endpoint, object payload)
    {
        using var request = new HttpRequestMessage(HttpMethod.Post, endpoint);
        
        request.Headers.Add("X-API-Key", apiKey);
        request.Headers.Add("X-Machine-Fingerprint", machineFingerprint);
        request.Headers.Add("X-Plugin-Version", pluginVersion);
        
        // ...
    }
}
```

**Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**

```typescript
export class IikoPluginAuthGuard implements CanActivate {
  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const apiKey = request.headers['x-api-key'];
    const fingerprint = request.headers['x-machine-fingerprint'];
    
    const installation = await this.prisma.iikoPluginInstallation.findUnique({
      where: { apiKey }
    });
    
    // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å - —Å–æ—Ö—Ä–∞–Ω—è–µ–º fingerprint
    if (!installation.machineFingerprint) {
      await this.prisma.iikoPluginInstallation.update({
        where: { id: installation.id },
        data: { 
          machineFingerprint: fingerprint,
          firstSeenAt: new Date()
        }
      });
      
      logger.log(`Machine fingerprint registered: ${fingerprint.substring(0, 8)}...`);
      
      return true;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    if (installation.machineFingerprint !== fingerprint) {
      // ‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å –¥—Ä—É–≥–æ–π –º–∞—à–∏–Ω—ã!
      
      await this.securityLog.log({
        level: 'CRITICAL',
        event: 'MACHINE_MISMATCH',
        installationId: installation.id,
        restaurantId: installation.restaurantId,
        expected: installation.machineFingerprint,
        actual: fingerprint,
        ip: request.ip
      });
      
      // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
      await this.notificationService.send({
        recipientId: installation.restaurant.adminId,
        type: 'SECURITY_ALERT',
        priority: 'HIGH',
        title: 'üîí –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
        body: 
          `–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API –∫–ª—é—á–∞ —Å –¥—Ä—É–≥–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞.\n\n` +
          `–†–µ—Å—Ç–æ—Ä–∞–Ω: ${installation.restaurant.name}\n` +
          `IP: ${request.ip}\n` +
          `–í—Ä–µ–º—è: ${new Date().toISOString()}\n\n` +
          `–ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤—ã, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–∑–æ–≤–∏—Ç–µ API –∫–ª—é—á.`
      });
      
      throw new ForbiddenException({
        code: 'MACHINE_MISMATCH',
        message: 'This API Key is bound to a different machine',
        action: 'CONTACT_ADMIN',
        details: 'API Key can only be used on the original installation machine'
      });
    }
    
    return true;
  }
}
```


***

### **–í–û–ü–†–û–° 12: Rate limiting –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞**

**–í–û–ü–†–û–°:** –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è API (—Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–ª–∏ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ–≥–æ)?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–µ—Ç rate limiting (–¥–æ–≤–µ—Ä—è–µ–º –ø–ª–∞–≥–∏–Ω—É)
- **B)** –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –Ω–∞ tenant (–Ω–∞–ø—Ä–∏–º–µ—Ä 1000 req/—á–∞—Å)
- **C)** –õ–∏–º–∏—Ç –Ω–∞ –∫–∞–∂–¥—É—é –∫–∞—Å—Å—É (–Ω–∞–ø—Ä–∏–º–µ—Ä 100 req/–º–∏–Ω)
- **D)** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ª–∏–º–∏—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∞—Ä–∏—Ñ–∞

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –õ–∏–º–∏—Ç –Ω–∞ –∫–∞—Å—Å—É + burst allowance**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç –±–∞–≥–æ–≤:** –ï—Å–ª–∏ –ø–ª–∞–≥–∏–Ω –∑–∞—Ü–∏–∫–ª–∏–ª—Å—è, –Ω–µ —É—Ä–æ–Ω–∏–º backend
- ‚úÖ **–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å:** –û–¥–Ω–∞ –∫–∞—Å—Å–∞ –Ω–µ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å API –¥–ª—è –¥—Ä—É–≥–∏—Ö
- ‚úÖ **Burst allowance:** –†–∞–∑—Ä–µ—à–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏–µ –≤—Å–ø–ª–µ—Å–∫–∏ (—á–∞—Å –ø–∏–∫)
- ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –í–∏–¥–∏–º –∞–Ω–æ–º–∞–ª–∏–∏ –≤ –ª–æ–≥–∞—Ö

**Backend:**

```typescript
// Rate limiting middleware
@Injectable()
export class PluginRateLimitGuard implements CanActivate {
  constructor(
    private redis: RedisService,
    private logger: Logger
  ) {}
  
  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const installation = request.installation; // –ò–∑ auth guard
    const fingerprint = request.headers['x-machine-fingerprint'];
    
    // –ö–ª—é—á –¥–ª—è rate limiting: installation + machine
    const key = `ratelimit:plugin:${installation.id}:${fingerprint}`;
    
    // –õ–∏–º–∏—Ç—ã
    const limits = {
      perMinute: 100,   // 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
      perHour: 3000,    // 3000 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —á–∞—Å
      burst: 20         // –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å burst 20 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 10 —Å–µ–∫
    };
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω—É—Ç–Ω—ã–π –ª–∏–º–∏—Ç
    const minuteCount = await this.redis.incr(`${key}:minute`);
    
    if (minuteCount === 1) {
      await this.redis.expire(`${key}:minute`, 60);
    }
    
    if (minuteCount > limits.perMinute) {
      this.logger.warn(
        `Rate limit exceeded (minute): ${installation.id}, count=${minuteCount}`
      );
      
      throw new TooManyRequestsException({
        code: 'RATE_LIMIT_MINUTE',
        message: 'Too many requests per minute',
        limit: limits.perMinute,
        current: minuteCount,
        retryAfter: await this.redis.ttl(`${key}:minute`)
      });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Å–æ–≤–æ–π –ª–∏–º–∏—Ç
    const hourCount = await this.redis.incr(`${key}:hour`);
    
    if (hourCount === 1) {
      await this.redis.expire(`${key}:hour`, 3600);
    }
    
    if (hourCount > limits.perHour) {
      this.logger.error(
        `Rate limit exceeded (hour): ${installation.id}, count=${hourCount}`
      );
      
      // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
      await this.notificationService.send({
        recipientId: installation.restaurant.adminId,
        type: 'RATE_LIMIT_ALERT',
        title: '‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤',
        body: 
          `–ö–∞—Å—Å–∞ –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API.\n\n` +
          `–õ–∏–º–∏—Ç: ${limits.perHour} –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å\n` +
          `–§–∞–∫—Ç–∏—á–µ—Å–∫–∏: ${hourCount} –∑–∞–ø—Ä–æ—Å–æ–≤\n\n` +
          `–í–æ–∑–º–æ–∂–Ω–æ –ø–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.`
      });
      
      throw new TooManyRequestsException({
        code: 'RATE_LIMIT_HOUR',
        message: 'Too many requests per hour',
        limit: limits.perHour,
        current: hourCount,
        retryAfter: await this.redis.ttl(`${key}:hour`)
      });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º burst (20 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 10 —Å–µ–∫—É–Ω–¥)
    const burstKey = `${key}:burst`;
    const burstCount = await this.redis.incr(burstKey);
    
    if (burstCount === 1) {
      await this.redis.expire(burstKey, 10);
    }
    
    if (burstCount > limits.burst) {
      this.logger.warn(
        `Burst limit exceeded: ${installation.id}, count=${burstCount}`
      );
      
      throw new TooManyRequestsException({
        code: 'RATE_LIMIT_BURST',
        message: 'Too many requests in short time',
        limit: limits.burst,
        window: '10 seconds',
        retryAfter: await this.redis.ttl(burstKey)
      });
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
    request.rateLimit = {
      minuteCount,
      hourCount,
      burstCount
    };
    
    return true;
  }
}
```

**–ü–ª–∞–≥–∏–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 429:**

```csharp
public class LoyaltyApiClient
{
    private async Task<T> SendRequestAsync<T>(string endpoint, object payload)
    {
        try
        {
            var response = await httpClient.PostAsync(endpoint, content);
            
            if (response.StatusCode == (HttpStatusCode)429) // Too Many Requests
            {
                await HandleRateLimitResponse(response);
                
                // Retry —Å exponential backoff
                await Task.Delay(GetRetryDelay());
                return await SendRequestAsync<T>(endpoint, payload);
            }
            
            // ...
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Request failed");
            throw;
        }
    }
    
    private async Task HandleRateLimitResponse(HttpResponseMessage response)
    {
        var json = await response.Content.ReadAsStringAsync();
        var error = JsonConvert.DeserializeObject<RateLimitError>(json);
        
        logger.LogWarning(
            "Rate limit exceeded: {Code}, Limit={Limit}, Current={Current}, RetryAfter={RetryAfter}",
            error.Code,
            error.Limit,
            error.Current,
            error.RetryAfter
        );
        
        // –ï—Å–ª–∏ —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
        if (IsSystematicRateLimitIssue())
        {
            Application.Current.Dispatcher.Invoke(() =>
            {
                MessageBox.Show(
                    $"‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–µ—Ä—É\n\n" +
                    $"–õ–∏–º–∏—Ç: {error.Limit}\n" +
                    $"–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —á–µ—Ä–µ–∑ {error.RetryAfter} —Å–µ–∫—É–Ω–¥.\n\n" +
                    $"–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.",
                    "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning
                );
            });
        }
        
        metricsService.RecordMetric("api.rate_limited", 1);
    }
    
    private int GetRetryDelay()
    {
        // Exponential backoff: 1s, 2s, 4s, 8s, ...
        var attempt = retryAttempts++;
        return (int)Math.Pow(2, Math.Min(attempt, 5)) * 1000;
    }
}
```


***

### **–í–û–ü–†–û–° 13: HTTPS –∏ Certificate Pinning**

**–í–û–ü–†–û–°:** –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –æ—Ç Man-in-the-Middle –∞—Ç–∞–∫?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –¢–æ–ª—å–∫–æ HTTPS (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞)
- **B)** HTTPS + Certificate Pinning (–∂–µ—Å—Ç–∫–æ –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç backend)
- **C)** HTTPS + Public Key Pinning
- **D)** Mutual TLS (–∫–ª–∏–µ–Ω—Ç —Ç–æ–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç)

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: A) HTTPS —Å —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ:** –î–ª—è 99.9% —Å–ª—É—á–∞–µ–≤ —Ö–≤–∞—Ç–∞–µ—Ç –æ–±—ã—á–Ω–æ–≥–æ HTTPS
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ:** –ù–µ –Ω—É–∂–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è pinning
- ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å:** –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞–≥–∏–Ω–∞
- ‚ùå **Certificate Pinning:** –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (–Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –ø–ª–∞–≥–∏–Ω)
- ‚ùå **Mutual TLS:** –û–≤–µ—Ä–∫–∏–ª–ª –¥–ª—è –Ω–∞—à–µ–≥–æ use case

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class LoyaltyApiClient
{
    private readonly HttpClient httpClient;
    
    public LoyaltyApiClient(ConfigService config)
    {
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º HttpClient —Å —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π SSL
        var handler = new HttpClientHandler
        {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
            ServerCertificateCustomValidationCallback = ValidateServerCertificate
        };
        
        httpClient = new HttpClient(handler)
        {
            BaseAddress = new Uri(config.ApiUrl),
            Timeout = TimeSpan.FromSeconds(30)
        };
        
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏
        httpClient.DefaultRequestHeaders.Add("X-Plugin-Version", GetPluginVersion());
        httpClient.DefaultRequestHeaders.Add("User-Agent", "MaxLoyaltyIikoPlugin/1.0");
    }
    
    private bool ValidateServerCertificate(
        HttpRequestMessage request,
        X509Certificate2 certificate,
        X509Chain chain,
        SslPolicyErrors sslPolicyErrors)
    {
        // –ï—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–æ–∫ - –≤—Å—ë –æ–∫
        if (sslPolicyErrors == SslPolicyErrors.None)
        {
            return true;
        }
        
        // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
        logger.LogError(
            "SSL Certificate validation failed: {Errors}, Cert={Subject}",
            sslPolicyErrors,
            certificate.Subject
        );
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
        
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –Ω–∞—à –¥–æ–º–µ–Ω
        if (!certificate.Subject.Contains("maxloyalty.ru"))
        {
            logger.LogCritical("Certificate is not for maxloyalty.ru domain");
            return false;
        }
        
        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ –∏—Å—Ç–µ–∫
        if (certificate.NotAfter < DateTime.Now)
        {
            logger.LogCritical("Certificate has expired");
            return false;
        }
        
        // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º chain
        if ((sslPolicyErrors & SslPolicyErrors.RemoteCertificateChainErrors) != 0)
        {
            foreach (var status in chain.ChainStatus)
            {
                logger.LogError("Chain error: {Status}", status.StatusInformation);
            }
            
            return false;
        }
        
        // –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ - –æ—Ç–∫–ª–æ–Ω—è–µ–º
        return false;
    }
}
```

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ (Certificate Fingerprint):**

–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–≤—ã—à–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å fingerprint:

```csharp
public class LoyaltyApiClient
{
    // SHA256 fingerprint –Ω–∞—à–µ–≥–æ production —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
    private const string EXPECTED_CERT_FINGERPRINT = 
        "AA:BB:CC:DD:EE:FF:00:11:22:33:44:55:66:77:88:99:AA:BB:CC:DD:EE:FF:00:11:22:33:44:55:66:77:88:99";
    
    private bool ValidateServerCertificate(
        HttpRequestMessage request,
        X509Certificate2 certificate,
        X509Chain chain,
        SslPolicyErrors sslPolicyErrors)
    {
        // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
        if (sslPolicyErrors != SslPolicyErrors.None)
        {
            logger.LogError("SSL errors: {Errors}", sslPolicyErrors);
            return false;
        }
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø—Ä–æ–≤–µ—Ä—è–µ–º fingerprint (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        var actualFingerprint = certificate.GetCertHashString(HashAlgorithmName.SHA256);
        var expectedFingerprint = EXPECTED_CERT_FINGERPRINT.Replace(":", "");
        
        if (!actualFingerprint.Equals(expectedFingerprint, StringComparison.OrdinalIgnoreCase))
        {
            logger.LogWarning(
                "Certificate fingerprint mismatch. Expected={Expected}, Actual={Actual}",
                EXPECTED_CERT_FINGERPRINT,
                actualFingerprint
            );
            
            // –í production - –æ—Ç–∫–ª–æ–Ω—è–µ–º
            // –í dev - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º –Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            #if !DEBUG
            return false;
            #endif
        }
        
        return true;
    }
}
```

**Backend (Let's Encrypt + Cloudflare):**

```yaml
# nginx config
server {
    listen 443 ssl http2;
    server_name api.maxloyalty.ru;
    
    # SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
    ssl_certificate /etc/letsencrypt/live/api.maxloyalty.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.maxloyalty.ru/privkey.pem;
    
    # –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:...';
    
    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    
    location / {
        proxy_pass http://backend:3000;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```


***

### **–í–û–ü–†–û–° 14: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ sensitive –¥–∞–Ω–Ω—ã—Ö**

**–í–û–ü–†–û–°:** –ß—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å, –∞ —á—Ç–æ –ù–ï–¢ –≤ –ª–æ–≥–∞—Ö –ø–ª–∞–≥–∏–Ω–∞?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –õ–æ–≥–∏—Ä—É–µ–º –≤—Å—ë (–≤–∫–ª—é—á–∞—è API Key, —Ç–µ–ª–µ—Ñ–æ–Ω—ã –≥–æ—Å—Ç–µ–π)
- **B)** –õ–æ–≥–∏—Ä—É–µ–º –±–µ–∑ sensitive –¥–∞–Ω–Ω—ã—Ö
- **C)** –õ–æ–≥–∏—Ä—É–µ–º —Å –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º (phone: +7999***45-67)
- **D)** –†–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏: Debug=–≤—Å—ë, Production=–º–∏–Ω–∏–º—É–º

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ sensitive –¥–∞–Ω–Ω—ã—Ö**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **GDPR compliance:** –ù–µ —Ö—Ä–∞–Ω–∏–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ
- ‚úÖ **–ü–æ–ª–µ–∑–Ω–æ—Å—Ç—å:** –í–∏–¥–∏–º —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –Ω–æ –±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –õ–æ–≥–∏ –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ support
- ‚úÖ **–ë–∞–ª–∞–Ω—Å:** –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è debugging

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public static class LoggingExtensions
{
    public static string MaskPhone(this string phone)
    {
        if (string.IsNullOrEmpty(phone) || phone.Length < 10)
            return "***";
        
        // +7 999 123-45-67 ‚Üí +7 999 ***-**-67
        return phone.Substring(0, 7) + "***-**" + phone.Substring(phone.Length - 2);
    }
    
    public static string MaskEmail(this string email)
    {
        if (string.IsNullOrEmpty(email) || !email.Contains("@"))
            return "***@***.***";
        
        var parts = email.Split('@');
        var localPart = parts[0];
        var domain = parts[1];
        
        // user@example.com ‚Üí u***r@e*****e.com
        var maskedLocal = localPart.Length > 2 
            ? localPart[0] + "***" + localPart[localPart.Length - 1]
            : "***";
        
        var maskedDomain = domain.Length > 4
            ? domain[0] + "*****" + domain.Substring(domain.Length - 5)
            : "***";
        
        return $"{maskedLocal}@{maskedDomain}";
    }
    
    public static string MaskApiKey(this string apiKey)
    {
        if (string.IsNullOrEmpty(apiKey) || apiKey.Length < 16)
            return "***";
        
        // rest_abc123xyz789... ‚Üí rest_abc...789
        return apiKey.Substring(0, 8) + "..." + apiKey.Substring(apiKey.Length - 3);
    }
    
    public static string MaskCardNumber(this string cardNumber)
    {
        if (string.IsNullOrEmpty(cardNumber) || cardNumber.Length < 6)
            return "***";
        
        // 123456 ‚Üí 12****
        return cardNumber.Substring(0, 2) + "****";
    }
}

// Logger wrapper
public class SensitiveDataLogger
{
    private readonly ILogger logger;
    
    public void LogGuestSearch(string input, bool found, string guestId = null)
    {
        logger.LogInformation(
            "Guest search: Input={MaskedInput}, Found={Found}, GuestId={GuestId}",
            MaskSearchInput(input),
            found,
            guestId
        );
    }
    
    public void LogLoyaltyOperation(
        string guestId, 
        string operation, 
        decimal amount)
    {
        logger.LogInformation(
            "Loyalty operation: Guest={GuestId}, Operation={Operation}, Amount={Amount}",
            guestId, // ID –Ω–µ sensitive
            operation,
            amount
        );
    }
    
    public void LogApiRequest(string endpoint, string guestCardId)
    {
        logger.LogDebug(
            "API Request: Endpoint={Endpoint}, GuestCard={GuestCardId}",
            endpoint,
            guestCardId
        );
        
        // –ù–ï –ª–æ–≥–∏—Ä—É–µ–º:
        // - API Key (—É–∂–µ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö)
        // - Phone/Email
        // - Payment details
    }
    
    public void LogError(Exception ex, string context, Dictionary<string, object> data = null)
    {
        // –ú–∞—Å–∫–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ exception
        var maskedData = data?.ToDictionary(
            kvp => kvp.Key,
            kvp => MaskValue(kvp.Key, kvp.Value)
        );
        
        logger.LogError(
            ex,
            "Error in {Context}: {Data}",
            context,
            JsonConvert.SerializeObject(maskedData)
        );
    }
    
    private object MaskValue(string key, object value)
    {
        var keyLower = key.ToLower();
        var valueStr = value?.ToString();
        
        if (valueStr == null)
            return null;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á—Ç–æ –Ω—É–∂–Ω–æ –º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∏–º–µ–Ω–∏ –∫–ª—é—á–∞
        if (keyLower.Contains("phone"))
            return valueStr.MaskPhone();
        
        if (keyLower.Contains("email"))
            return valueStr.MaskEmail();
        
        if (keyLower.Contains("apikey") || keyLower.Contains("api_key"))
            return valueStr.MaskApiKey();
        
        if (keyLower.Contains("card") && keyLower.Contains("number"))
            return valueStr.MaskCardNumber();
        
        // –û—Å—Ç–∞–ª—å–Ω–æ–µ –Ω–µ –º–∞—Å–∫–∏—Ä—É–µ–º
        return value;
    }
    
    private string MaskSearchInput(string input)
    {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á—Ç–æ —ç—Ç–æ (—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –∫–æ–¥)
        if (input.StartsWith("+") || input.StartsWith("7") || input.StartsWith("8"))
        {
            return input.MaskPhone();
        }
        
        // –ï—Å–ª–∏ 6 —Ü–∏—Ñ—Ä - —ç—Ç–æ –∫–æ–¥ –∫–∞—Ä—Ç—ã
        if (input.Length == 6 && input.All(char.IsDigit))
        {
            return input.MaskCardNumber();
        }
        
        return "***";
    }
}
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Serilog:**

```csharp
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Information()
    .MinimumLevel.Override("Microsoft", LogEventLevel.Warning)
    .Enrich.WithProperty("Plugin", "MaxLoyaltyIiko")
    .Enrich.WithProperty("Version", pluginVersion)
    .Enrich.WithProperty("RestaurantId", restaurantId)
    .Enrich.WithMachineName()
    .Enrich.WithEnvironmentUserName() // –ù–ï sensitive –¥–ª—è –∫–∞—Å—Å—ã
    .Destructure.ByTransforming<GuestInfo>(guest => new
    {
        CardId = guest.CardId,
        Phone = guest.Phone.MaskPhone(), // –ú–∞—Å–∫–∏—Ä—É–µ–º
        Email = guest.Email?.MaskEmail(),
        Name = guest.Name // –ò–º—è –º–æ–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å
    })
    .WriteTo.File(
        path: Path.Combine(GetAppDataPath(), "logs", "plugin-.log"),
        rollingInterval: RollingInterval.Day,
        retainedFileCountLimit: 7,
        outputTemplate: 
            "{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz} " +
            "[{Level:u3}] " +
            "{Message:lj} " +
            "{Properties:j}{NewLine}{Exception}"
    )
    .CreateLogger();
```

**–ß—Ç–æ –ú–û–ñ–ù–û –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å:**

- ‚úÖ Timestamp
- ‚úÖ –£—Ä–æ–≤–µ–Ω—å (Info/Warning/Error)
- ‚úÖ –î–µ–π—Å—Ç–≤–∏–µ (SearchGuest, ApplyLoyalty, etc)
- ‚úÖ GuestCardId (UUID)
- ‚úÖ OrderId
- ‚úÖ ReservationId
- ‚úÖ –°—É–º–º—ã (check amount, points)
- ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç (success/failure)
- ‚úÖ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
- ‚úÖ HTTP status codes
- ‚úÖ Machine fingerprint (hash)

**–ß—Ç–æ –ù–ï–õ–¨–ó–Ø –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å:**

- ‚ùå API Key (–≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ)
- ‚ùå Phone (–≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ)
- ‚ùå Email (–≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ)
- ‚ùå –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
- ‚ùå –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (–≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ)
- ‚ùå –ê–¥—Ä–µ—Å
- ‚ùå –ü–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

***

–ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ 15-16 (–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–ª–æ–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏) –∏ –∑–∞—Ç–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ –ë–ª–æ–∫—É 3 (UI/UX)?

---

### **–í–û–ü–†–û–° 15: –ó–∞—â–∏—Ç–∞ –æ—Ç SQL Injection –∏ XSS –≤ –ø–ª–∞–≥–∏–Ω–µ**

**–í–û–ü–†–û–°:** –ü–ª–∞–≥–∏–Ω –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–≤–æ–¥ –æ—Ç –∫–∞—Å—Å–∏—Ä–∞ (—Ç–µ–ª–µ—Ñ–æ–Ω, –∫–æ–¥). –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –æ—Ç –∏–Ω—ä–µ–∫—Ü–∏–π?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –î–æ–≤–µ—Ä—è–µ–º –∫–∞—Å—Å–∏—Ä—É, –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º
- **B)** –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
- **C)** –°—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è + —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –Ω–∞ client-side
- **D)** –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ client + –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –Ω–∞ server (defense in depth)

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) –î–≤–æ–π–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **Defense in depth:** –ó–∞—â–∏—Ç–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ
- ‚úÖ **–õ—É—á—à–∏–π UX:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** Backend –Ω–µ –¥–æ–≤–µ—Ä—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
- ‚úÖ **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ—à–∏–±–æ–∫:** –ö–∞—Å—Å–∏—Ä —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–≤–æ–¥

**–ü–ª–∞–≥–∏–Ω (Client-side):**

```csharp
public class InputValidator
{
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    public static ValidationResult ValidatePhone(string phone)
    {
        if (string.IsNullOrWhiteSpace(phone))
        {
            return ValidationResult.Error("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞");
        }
        
        // –£–¥–∞–ª—è–µ–º –≤—Å—ë –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
        var digitsOnly = new string(phone.Where(char.IsDigit).ToArray());
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç
        if (digitsOnly.Length < 10 || digitsOnly.Length > 11)
        {
            return ValidationResult.Error(
                "–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 10-11 —Ü–∏—Ñ—Ä"
            );
        }
        
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º (—É–±–∏—Ä–∞–µ–º 8 –≤ –Ω–∞—á–∞–ª–µ, –¥–æ–±–∞–≤–ª—è–µ–º +7)
        if (digitsOnly.StartsWith("8") && digitsOnly.Length == 11)
        {
            digitsOnly = "7" + digitsOnly.Substring(1);
        }
        
        if (digitsOnly.StartsWith("7") && digitsOnly.Length == 11)
        {
            return ValidationResult.Success("+" + digitsOnly);
        }
        
        if (digitsOnly.Length == 10)
        {
            return ValidationResult.Success("+7" + digitsOnly);
        }
        
        return ValidationResult.Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞");
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è 6-–∑–Ω–∞—á–Ω–æ–≥–æ –∫–æ–¥–∞
    public static ValidationResult ValidateCode6Digit(string code)
    {
        if (string.IsNullOrWhiteSpace(code))
        {
            return ValidationResult.Error("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–∞—Ä—Ç—ã");
        }
        
        // –£–¥–∞–ª—è–µ–º –≤—Å—ë –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
        var digitsOnly = new string(code.Where(char.IsDigit).ToArray());
        
        if (digitsOnly.Length != 6)
        {
            return ValidationResult.Error("–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 6 —Ü–∏—Ñ—Ä");
        }
        
        return ValidationResult.Success(digitsOnly);
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏ (–¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–æ—Å—Ç—è)
    public static ValidationResult ValidateName(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            return ValidationResult.Error("–í–≤–µ–¥–∏—Ç–µ –∏–º—è");
        }
        
        // –£–¥–∞–ª—è–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        var sanitized = SanitizeName(name);
        
        if (sanitized.Length < 2)
        {
            return ValidationResult.Error("–ò–º—è —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ");
        }
        
        if (sanitized.Length > 50)
        {
            return ValidationResult.Error("–ò–º—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å 50 —Å–∏–º–≤–æ–ª–æ–≤)");
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã
        if (!Regex.IsMatch(sanitized, @"^[–∞-—è—ë–ê-–Ø–Åa-zA-Z\s\-]+$"))
        {
            return ValidationResult.Error("–ò–º—è —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã");
        }
        
        return ValidationResult.Success(sanitized);
    }
    
    private static string SanitizeName(string input)
    {
        if (input == null)
            return string.Empty;
        
        // –£–¥–∞–ª—è–µ–º HTML —Ç—ç–≥–∏ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        input = Regex.Replace(input, @"<[^>]*>", string.Empty);
        
        // –£–¥–∞–ª—è–µ–º SQL –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        var sqlKeywords = new[] 
        { 
            "SELECT", "INSERT", "UPDATE", "DELETE", "DROP", 
            "CREATE", "ALTER", "EXEC", "EXECUTE", "--", "/*", "*/"
        };
        
        foreach (var keyword in sqlKeywords)
        {
            input = Regex.Replace(
                input, 
                keyword, 
                string.Empty, 
                RegexOptions.IgnoreCase
            );
        }
        
        // –£–¥–∞–ª—è–µ–º –æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        input = Regex.Replace(input, @"[<>""'`;\\]", string.Empty);
        
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–æ–±–µ–ª—ã
        input = Regex.Replace(input, @"\s+", " ");
        
        return input.Trim();
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã –±–∞–ª–ª–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è
    public static ValidationResult ValidatePointsAmount(
        string input, 
        decimal maxAllowed)
    {
        if (string.IsNullOrWhiteSpace(input))
        {
            return ValidationResult.Error("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
        }
        
        // –ü–∞—Ä—Å–∏–º —á–∏—Å–ª–æ
        if (!decimal.TryParse(input, out decimal amount))
        {
            return ValidationResult.Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞");
        }
        
        if (amount <= 0)
        {
            return ValidationResult.Error("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0");
        }
        
        if (amount > maxAllowed)
        {
            return ValidationResult.Error(
                $"–ú–∞–∫—Å–∏–º—É–º –¥–æ—Å—Ç—É–ø–Ω–æ: {maxAllowed:N0} ‚ÇΩ"
            );
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ –¥—Ä–æ–±–Ω–æ–µ (–±–∞–ª–ª—ã = —Ä—É–±–ª–∏ = —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)
        if (amount % 1 != 0)
        {
            return ValidationResult.Error("–ë–∞–ª–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º");
        }
        
        return ValidationResult.Success(amount);
    }
}

public class ValidationResult
{
    public bool IsValid { get; set; }
    public string ErrorMessage { get; set; }
    public object Value { get; set; }
    
    public static ValidationResult Success(object value)
    {
        return new ValidationResult 
        { 
            IsValid = true, 
            Value = value 
        };
    }
    
    public static ValidationResult Error(string message)
    {
        return new ValidationResult 
        { 
            IsValid = false, 
            ErrorMessage = message 
        };
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ UI
private async void OnSearchClick(object sender, RoutedEventArgs e)
{
    var input = InputField.Text;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤–≤–æ–¥–∞
    ValidationResult validation;
    
    if (IsPhoneTab)
    {
        validation = InputValidator.ValidatePhone(input);
    }
    else
    {
        validation = InputValidator.ValidateCode6Digit(input);
    }
    
    if (!validation.IsValid)
    {
        ShowError(validation.ErrorMessage);
        return;
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    var normalizedInput = validation.Value.ToString();
    
    await SearchGuestAsync(normalizedInput);
}
```

**Backend (Server-side):**

```typescript
// DTO —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π (class-validator)
export class SearchGuestDto {
  @IsOptional()
  @IsString()
  @Matches(/^\+7\d{10}$/, {
    message: 'Phone must be in format +7XXXXXXXXXX'
  })
  phone?: string;

  @IsOptional()
  @IsString()
  @Length(6, 6)
  @Matches(/^\d{6}$/, {
    message: 'Code must be exactly 6 digits'
  })
  code6Digit?: string;

  @ValidateIf(o => !o.phone && !o.code6Digit)
  @IsNotEmpty({ message: 'Either phone or code6Digit is required' })
  _oneOfRequired?: any;
}

export class CreateGuestDto {
  @IsString()
  @Matches(/^\+7\d{10}$/)
  phone: string;

  @IsString()
  @MinLength(2)
  @MaxLength(50)
  @Matches(/^[–∞-—è—ë–ê-–Ø–Åa-zA-Z\s\-]+$/, {
    message: 'Name can only contain letters, spaces and hyphens'
  })
  name: string;

  @IsOptional()
  @IsDateString()
  birthDate?: string;
}

export class ReservePointsDto {
  @IsUUID()
  guestCardId: string;

  @IsNumber()
  @Min(1)
  @Max(1000000)
  @IsInt({ message: 'Points must be integer' })
  pointsToSpend: number;

  @IsNumber()
  @Min(0)
  maxAllowed: number;

  @IsNumber()
  @Min(0)
  checkAmount: number;

  @IsString()
  orderId: string;
}

// Controller —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
@Post('search-guest')
@UseGuards(IikoPluginAuthGuard)
async searchGuest(@Body() dto: SearchGuestDto) {
  // class-validator —É–∂–µ –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–ª DTO
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è
  if (dto.phone) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ –≤ blacklist
    const isBlacklisted = await this.blacklistService.isPhoneBlacklisted(
      dto.phone
    );
    
    if (isBlacklisted) {
      throw new BadRequestException('This phone number is blocked');
    }
  }
  
  if (dto.code6Digit) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º rate limiting –¥–ª—è –∫–æ–¥–∞
    const attempts = await this.redis.incr(
      `code_attempts:${dto.code6Digit}`
    );
    
    if (attempts === 1) {
      await this.redis.expire(`code_attempts:${dto.code6Digit}`, 60);
    }
    
    if (attempts > 10) {
      throw new TooManyRequestsException(
        'Too many attempts for this code'
      );
    }
  }
  
  // –ò—â–µ–º –≥–æ—Å—Ç—è
  const guest = await this.loyaltyService.searchGuest(dto);
  
  return guest;
}

// Prisma –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç SQL injection –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
async searchGuest(dto: SearchGuestDto) {
  // –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã - –±–µ–∑–æ–ø–∞—Å–Ω—ã
  const guest = await this.prisma.guestCard.findFirst({
    where: {
      OR: [
        { phone: dto.phone },
        { code6Digit: dto.code6Digit }
      ],
      deletedAt: null
    },
    include: {
      level: true,
      tenant: true
    }
  });
  
  return guest;
}
```

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ (Input Sanitization Library):**

```csharp
// NuGet: HtmlSanitizer
public class SecureInputHandler
{
    private static readonly HtmlSanitizer sanitizer = new HtmlSanitizer();
    
    public static string SanitizeUserInput(string input)
    {
        if (string.IsNullOrEmpty(input))
            return string.Empty;
        
        // 1. HTML —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è
        var sanitized = sanitizer.Sanitize(input);
        
        // 2. –£–¥–∞–ª—è–µ–º null bytes
        sanitized = sanitized.Replace("\0", string.Empty);
        
        // 3. –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º Unicode (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º homograph –∞—Ç–∞–∫–∏)
        sanitized = sanitized.Normalize(NormalizationForm.FormC);
        
        // 4. –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
        if (sanitized.Length > 1000)
        {
            sanitized = sanitized.Substring(0, 1000);
        }
        
        return sanitized;
    }
}
```


***

### **–í–û–ü–†–û–° 16: –ê—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π –∫–∞—Å—Å–∏—Ä–∞**

**–í–û–ü–†–û–°:** –ù—É–∂–Ω–æ –ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –í–°–ï –¥–µ–π—Å—Ç–≤–∏—è –∫–∞—Å—Å–∏—Ä–∞ –¥–ª—è audit trail?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –î–∞, –ª–æ–≥–∏—Ä—É–µ–º –≤—Å—ë (–∫–∞–∂–¥—ã–π –∫–ª–∏–∫)
- **B)** –¢–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤/—Å–∫–∏–¥–∫–∏)
- **C)** –ö—Ä–∏—Ç–∏—á–Ω—ã–µ + –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ (–ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è, –ø—Ä–æ—Å–º–æ—Ç—Ä)
- **D)** –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥

**üéØ –ú–û–â –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –ö—Ä–∏—Ç–∏—á–Ω—ã–µ + –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ü–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞:** –ú–æ–∂–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—é —Å–µ—Å—Å–∏—é
- ‚úÖ **–†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ:** –ü—Ä–∏ —Å–ø–æ—Ä–µ –≤–∏–¥–∏–º —á—Ç–æ –∫–∞—Å—Å–∏—Ä –¥–µ–ª–∞–ª
- ‚úÖ **Compliance:** GDPR —Ç—Ä–µ–±—É–µ—Ç audit trail –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **–ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º:** –ù–µ –ª–æ–≥–∏—Ä—É–µ–º UI –∫–ª–∏–∫–∏, —Ç–æ–ª—å–∫–æ –±–∏–∑–Ω–µ—Å-–¥–µ–π—Å—Ç–≤–∏—è

**–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º:**

```csharp
public enum AuditAction
{
    // –ü–æ–∏—Å–∫
    GUEST_SEARCH_STARTED,
    GUEST_SEARCH_SUCCESS,
    GUEST_SEARCH_NOT_FOUND,
    GUEST_SEARCH_ERROR,
    
    // –û–ø–µ—Ä–∞—Ü–∏–∏
    LOYALTY_WINDOW_OPENED,
    POINTS_SPEND_INITIATED,
    POINTS_SPEND_APPLIED,
    POINTS_EARN_ONLY_APPLIED,
    DISCOUNT_APPLIED,
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏—è
    POINTS_AMOUNT_CHANGED,
    CARD_UNBOUND,
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç—è
    GUEST_CREATION_STARTED,
    GUEST_CREATED,
    
    // –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
    ORDER_FINALIZED,
    
    // –û—à–∏–±–∫–∏
    OPERATION_FAILED,
    API_ERROR,
    VALIDATION_ERROR
}

public class AuditLogger
{
    private readonly ILogger logger;
    private readonly MetricsService metricsService;
    
    public async Task LogActionAsync(AuditAction action, AuditContext context)
    {
        var entry = new AuditEntry
        {
            Id = Guid.NewGuid(),
            Timestamp = DateTime.UtcNow,
            Action = action,
            
            // –ö–∞—Å—Å–∏—Ä
            CashierName = GetCurrentCashierName(),
            MachineName = Environment.MachineName,
            MachineFingerprint = GetMachineFingerprint(),
            
            // –ö–æ–Ω—Ç–µ–∫—Å—Ç
            OrderId = context.OrderId,
            GuestCardId = context.GuestCardId,
            RestaurantId = context.RestaurantId,
            
            // –î–µ—Ç–∞–ª–∏ (masked)
            Details = context.Details,
            
            // –†–µ–∑—É–ª—å—Ç–∞—Ç
            Success = context.Success,
            ErrorCode = context.ErrorCode,
            ErrorMessage = context.ErrorMessage
        };
        
        // –õ–æ–∫–∞–ª—å–Ω—ã–π –ª–æ–≥
        logger.LogInformation(
            "Audit: {Action} by {Cashier} | Order={OrderId}, Guest={GuestId}, Success={Success}",
            action,
            entry.CashierName.MaskEmail(),
            entry.OrderId,
            entry.GuestCardId,
            entry.Success
        );
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
        try
        {
            await SendAuditToBackendAsync(entry);
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to send audit to backend");
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–∑–∂–µ
            SaveAuditLocally(entry);
        }
        
        // –ú–µ—Ç—Ä–∏–∫–∞
        metricsService.RecordMetric($"audit.{action.ToString().ToLower()}", 1);
    }
    
    private async Task SendAuditToBackendAsync(AuditEntry entry)
    {
        await apiClient.PostAsync("/api/audit/plugin-action", entry);
    }
    
    private void SaveAuditLocally(AuditEntry entry)
    {
        var auditDir = Path.Combine(GetAppDataPath(), "audit");
        Directory.CreateDirectory(auditDir);
        
        var fileName = $"audit-{DateTime.Now:yyyy-MM-dd}.jsonl";
        var filePath = Path.Combine(auditDir, fileName);
        
        // Append to JSONL file
        var json = JsonConvert.SerializeObject(entry);
        File.AppendAllText(filePath, json + Environment.NewLine);
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
public class LoyaltyOperationWindow
{
    private readonly AuditLogger auditLogger;
    
    private async void OnSpendClick(object sender, RoutedEventArgs e)
    {
        // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –æ–ø–µ—Ä–∞—Ü–∏–∏
        await auditLogger.LogActionAsync(
            AuditAction.POINTS_SPEND_INITIATED,
            new AuditContext
            {
                OrderId = currentOrder.Id.ToString(),
                GuestCardId = currentGuest.CardId,
                Details = new
                {
                    PointsToSpend = pointsToSpend,
                    MaxAllowed = maxAllowed,
                    CheckAmount = checkAmount
                }
            }
        );
        
        try
        {
            await ApplyPointsPayment(pointsToSpend);
            
            // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—Ö
            await auditLogger.LogActionAsync(
                AuditAction.POINTS_SPEND_APPLIED,
                new AuditContext
                {
                    OrderId = currentOrder.Id.ToString(),
                    GuestCardId = currentGuest.CardId,
                    Success = true,
                    Details = new
                    {
                        PointsSpent = pointsToSpend,
                        ReservationId = reservationId
                    }
                }
            );
        }
        catch (Exception ex)
        {
            // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
            await auditLogger.LogActionAsync(
                AuditAction.OPERATION_FAILED,
                new AuditContext
                {
                    OrderId = currentOrder.Id.ToString(),
                    GuestCardId = currentGuest.CardId,
                    Success = false,
                    ErrorCode = ex.GetType().Name,
                    ErrorMessage = ex.Message
                }
            );
            
            throw;
        }
    }
}
```

**Backend (Audit Log):**

```typescript
// –ú–æ–¥–µ–ª—å audit log
model PluginAuditLog {
  id                String    @id @default(uuid())
  timestamp         DateTime  @default(now())
  
  // –î–µ–π—Å—Ç–≤–∏–µ
  action            String    // POINTS_SPEND_APPLIED, etc.
  
  // –ö—Ç–æ
  restaurantId      String
  machineFingerprint String
  cashierName       String?
  
  // –ß—Ç–æ
  orderId           String?
  guestCardId       String?
  
  // –î–µ—Ç–∞–ª–∏
  details           Json?
  
  // –†–µ–∑—É–ª—å—Ç–∞—Ç
  success           Boolean
  errorCode         String?
  errorMessage      String?
  
  // –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
  @@index([restaurantId, timestamp])
  @@index([guestCardId, timestamp])
  @@index([action, timestamp])
}

// Endpoint –¥–ª—è –ø—Ä–∏–µ–º–∞ audit
@Post('audit/plugin-action')
@UseGuards(IikoPluginAuthGuard)
async logPluginAction(
  @Body() dto: PluginAuditLogDto,
  @CurrentInstallation() installation: IikoPluginInstallation
) {
  await this.prisma.pluginAuditLog.create({
    data: {
      action: dto.action,
      restaurantId: installation.restaurantId,
      machineFingerprint: dto.machineFingerprint,
      cashierName: dto.cashierName,
      orderId: dto.orderId,
      guestCardId: dto.guestCardId,
      details: dto.details,
      success: dto.success,
      errorCode: dto.errorCode,
      errorMessage: dto.errorMessage,
      timestamp: new Date(dto.timestamp)
    }
  });
  
  return { received: true };
}

// UI –≤ Admin Panel: Audit Trail
@Get('restaurants/:id/audit-trail')
async getAuditTrail(
  @Param('id') restaurantId: string,
  @Query() query: AuditTrailQuery
) {
  const logs = await this.prisma.pluginAuditLog.findMany({
    where: {
      restaurantId,
      timestamp: {
        gte: query.startDate,
        lte: query.endDate
      },
      action: query.action ? { in: query.actions } : undefined,
      guestCardId: query.guestCardId
    },
    orderBy: { timestamp: 'desc' },
    take: query.limit || 100
  });
  
  return logs;
}
```

**Admin Panel UI:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Audit Trail - –ü–ª–∞–≥–∏–Ω iiko                              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –§–∏–ª—å—Ç—Ä—ã:                                               ‚îÇ
‚îÇ –ü–µ—Ä–∏–æ–¥: [17.02.2026] - [17.02.2026]                  ‚îÇ
‚îÇ –î–µ–π—Å—Ç–≤–∏–µ: [–í—Å–µ] ‚ñº                                     ‚îÇ
‚îÇ –ö–∞—Å—Å–∞: [–í—Å–µ] ‚ñº                                        ‚îÇ
‚îÇ –ì–æ—Å—Ç—å: [___________] üîç                               ‚îÇ
‚îÇ                                                        ‚îÇ
‚îÇ [–ü—Ä–∏–º–µ–Ω–∏—Ç—å]  [–°–±—Ä–æ—Å–∏—Ç—å]  [–≠–∫—Å–ø–æ—Ä—Ç CSV]               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                        ‚îÇ
‚îÇ 17.02.2026 14:30:15 | –ö–∞—Å—Å–∞ #1 | –ò–≤–∞–Ω –ü.             ‚îÇ
‚îÇ ‚Üí POINTS_SPEND_APPLIED ‚úÖ                             ‚îÇ
‚îÇ   –ì–æ—Å—Ç—å: –ü–µ—Ç—Ä–æ–≤ –°–µ—Ä–≥–µ–π (+7999***45-67)               ‚îÇ
‚îÇ   –°–ø–∏—Å–∞–Ω–æ: 178 –±–∞–ª–ª–æ–≤                                 ‚îÇ
‚îÇ   –ó–∞–∫–∞–∑: #122463                                       ‚îÇ
‚îÇ                                                        ‚îÇ
‚îÇ 17.02.2026 14:28:03 | –ö–∞—Å—Å–∞ #1 | –ò–≤–∞–Ω –ü.             ‚îÇ
‚îÇ ‚Üí GUEST_SEARCH_SUCCESS ‚úÖ                             ‚îÇ
‚îÇ   –¢–µ–ª–µ—Ñ–æ–Ω: +7999***45-67                              ‚îÇ
‚îÇ   –ù–∞–π–¥–µ–Ω –∑–∞: 234ms                                    ‚îÇ
‚îÇ                                                        ‚îÇ
‚îÇ 17.02.2026 14:15:42 | –ö–∞—Å—Å–∞ #2 | –ú–∞—Ä–∏—è –°.            ‚îÇ
‚îÇ ‚Üí DISCOUNT_APPLIED ‚úÖ                                 ‚îÇ
‚îÇ   –ì–æ—Å—Ç—å: –°–∏–¥–æ—Ä–æ–≤–∞ –ê–Ω–Ω–∞ (+7916***78-90)               ‚îÇ
‚îÇ   –°–∫–∏–¥–∫–∞: 20% (179‚ÇΩ)                                  ‚îÇ
‚îÇ   –ó–∞–∫–∞–∑: #122450                                       ‚îÇ
‚îÇ                                                        ‚îÇ
‚îÇ 17.02.2026 13:55:18 | –ö–∞—Å—Å–∞ #1 | –ò–≤–∞–Ω –ü.             ‚îÇ
‚îÇ ‚Üí OPERATION_FAILED ‚ùå                                 ‚îÇ
‚îÇ   –û—à–∏–±–∫–∞: INSUFFICIENT_BALANCE                        ‚îÇ
‚îÇ   –î–µ—Ç–∞–ª–∏: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ               ‚îÇ
‚îÇ                                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## **üé® –ë–õ–û–ö 3: UI/UX –ò –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï –° –ö–ê–°–°–ò–†–û–ú (7 –≤–æ–ø—Ä–æ—Å–æ–≤)**


***

### **–í–û–ü–†–û–° 17: –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–ª–∞–≥–∏–Ω–∞**

**–í–û–ü–†–û–°:** –ù–∞ –∫–∞–∫–æ–º —è–∑—ã–∫–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å UI –ø–ª–∞–≥–∏–Ω–∞?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π (hardcoded)
- **B)** –ê–Ω–≥–ª–∏–π—Å–∫–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é + —Ä—É—Å—Å–∫–∏–π
- **C)** –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º Windows
- **D)** –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å —Å –≤—ã–±–æ—Ä–æ–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: A) –¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π (hardcoded)**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **Target market:** –ù–∞—à–∞ —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è - –†–æ—Å—Å–∏—è –∏ –°–ù–ì
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –ù–µ –Ω—É–∂–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ i18n
- ‚úÖ **–ú–µ–Ω—å—à–µ –±–∞–≥–æ–≤:** –û–¥–∏–Ω —è–∑—ã–∫ = –º–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫ –ø–µ—Ä–µ–≤–æ–¥–∞
- ‚úÖ **–ë—ã—Å—Ç—Ä–µ–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞:** –ù–µ —Ç—Ä–∞—Ç–∏–º –≤—Ä–µ–º—è –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥—ã
- üìà **–ë—É–¥—É—â–µ–µ:** –ï—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è - –¥–æ–±–∞–≤–∏–º –ø–æ–∑–∂–µ

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
// –í—Å–µ —Å—Ç—Ä–æ–∫–∏ hardcoded –Ω–∞ —Ä—É—Å—Å–∫–æ–º
public static class UiStrings
{
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    public const string WindowTitle = "Max Loyalty";
    public const string SearchTitle = "–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è";
    public const string OperationTitle = "–°–ø–∏—Å–∞–Ω–∏–µ/–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ";
    
    // –ö–Ω–æ–ø–∫–∏
    public const string ButtonOk = "OK";
    public const string ButtonCancel = "–û—Ç–º–µ–Ω–∞";
    public const string ButtonSearch = "–ù–∞–π—Ç–∏";
    public const string ButtonApply = "–ü—Ä–∏–º–µ–Ω–∏—Ç—å";
    public const string ButtonSpend = "–°–ø–∏—Å–∞—Ç—å";
    public const string ButtonEarn = "–ù–∞—á–∏—Å–ª–∏—Ç—å";
    public const string ButtonUnbind = "–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É";
    public const string ButtonCreateGuest = "–°–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç—è";
    
    // –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
    public const string PlaceholderPhone = "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞";
    public const string PlaceholderCode = "–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥";
    public const string PlaceholderName = "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –≥–æ—Å—Ç—è";
    
    // –°–æ–æ–±—â–µ–Ω–∏—è
    public const string MessageGuestNotFound = "–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω";
    public const string MessageSuccess = "–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ";
    public const string MessageError = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞";
    public const string MessageLoading = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    
    // –û—à–∏–±–∫–∏
    public const string ErrorInvalidPhone = "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞";
    public const string ErrorInvalidCode = "–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 6 —Ü–∏—Ñ—Ä";
    public const string ErrorNetworkUnavailable = "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É";
    public const string ErrorInsufficientBalance = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤";
    
    // –ü–æ–¥—Å–∫–∞–∑–∫–∏
    public const string HintEditablePoints = "üí° –°—É–º–º—É –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã";
    public const string HintFixedDiscount = "üîí –°—É–º–º–∞ —Å–∫–∏–¥–∫–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞";
    public const string HintOfflineMode = "‚ö†Ô∏è Offline —Ä–µ–∂–∏–º: —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ";
}
```

**–ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è i18n:**

```csharp
// –ú–æ–∂–Ω–æ –±—É–¥–µ—Ç –ª–µ–≥–∫–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ Resource files (.resx)
public static class UiStrings
{
    private static ResourceManager rm = new ResourceManager(
        "MaxLoyaltyIiko.Resources.Strings",
        Assembly.GetExecutingAssembly()
    );
    
    public static string GetString(string key)
    {
        var culture = CultureInfo.CurrentUICulture;
        return rm.GetString(key, culture) ?? key;
    }
}

// Resources/Strings.ru-RU.resx
ButtonOk = "OK"
ButtonCancel = "–û—Ç–º–µ–Ω–∞"

// Resources/Strings.en-US.resx
ButtonOk = "OK"
ButtonCancel = "Cancel"
```


***

### **–í–û–ü–†–û–° 18: –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ –∏ –±—Ä–µ–Ω–¥–∏–Ω–≥**

**–í–û–ü–†–û–°:** –ö–∞–∫—É—é —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è Windows (—Å–µ—Ä–∞—è)
- **B)** –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç iiko Front (—Å–≤–µ—Ç–ª–∞—è)
- **C)** –ë—Ä–µ–Ω–¥–∏–Ω–≥ Max Loyalty (—Å–≤–æ–∏ —Ü–≤–µ—Ç–∞)
- **D)** –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ (–∫–∞–∫ –≤ Admin Panel)

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –ë—Ä–µ–Ω–¥–∏–Ω–≥ Max Loyalty**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–£–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å:** –ö–∞—Å—Å–∏—Ä —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç —á—Ç–æ —ç—Ç–æ Max Loyalty
- ‚úÖ **–ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å:** –°–æ–≤–ø–∞–¥–∞–µ—Ç —Å Admin Panel –∏ Telegram Bot
- ‚úÖ **–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º:** –í—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç
- ‚úÖ **–û—Ç–ª–∏—á–∏–µ –æ—Ç iiko:** –ù–µ –ø—É—Ç–∞–µ—Ç—Å—è —Å –Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏ iiko

**–¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ (–∏–∑ –ë–µ—Å–µ–¥—ã 12):**

```csharp
public static class BrandColors
{
    // Primary
    public static readonly Color Primary = Color.FromRgb(30, 64, 175);      // #1e40af (Blue)
    public static readonly Color PrimaryHover = Color.FromRgb(29, 78, 216); // #1d4ed8
    public static readonly Color PrimaryLight = Color.FromRgb(219, 234, 254); // #dbeafe
    
    // Success
    public static readonly Color Success = Color.FromRgb(16, 185, 129);     // #10b981 (Green)
    public static readonly Color SuccessHover = Color.FromRgb(5, 150, 105); // #059669
    
    // Warning
    public static readonly Color Warning = Color.FromRgb(251, 191, 36);     // #fbbf24 (Yellow)
    public static readonly Color WarningHover = Color.FromRgb(245, 158, 11); // #f59e0b
    
    // Danger
    public static readonly Color Danger = Color.FromRgb(239, 68, 68);       // #ef4444 (Red)
    public static readonly Color DangerHover = Color.FromRgb(220, 38, 38);  // #dc2626
    
    // Neutral (Dark theme)
    public static readonly Color Background = Color.FromRgb(42, 42, 42);    // #2a2a2a
    public static readonly Color Surface = Color.FromRgb(58, 58, 58);       // #3a3a3a
    public static readonly Color Border = Color.FromRgb(74, 74, 74);        // #4a4a4a
    
    // Text
    public static readonly Color TextPrimary = Color.FromRgb(255, 255, 255); // White
    public static readonly Color TextSecondary = Color.FromRgb(156, 163, 175); // Gray
    public static readonly Color TextDisabled = Color.FromRgb(107, 114, 128); // Darker gray
}

public static class BrandFonts
{
    public static readonly FontFamily Primary = new FontFamily("Segoe UI");
    public static readonly FontFamily Mono = new FontFamily("Consolas");
    
    public static readonly double SizeSmall = 11;
    public static readonly double SizeNormal = 13;
    public static readonly double SizeMedium = 15;
    public static readonly double SizeLarge = 18;
    public static readonly double SizeXLarge = 24;
}
```

**–°—Ç–∏–ª–∏ XAML:**

```xaml
<!-- MaxLoyaltyStyles.xaml -->
<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    
    <!-- –¶–≤–µ—Ç–∞ -->
    <SolidColorBrush x:Key="PrimaryBrush" Color="#1e40af"/>
    <SolidColorBrush x:Key="SuccessBrush" Color="#10b981"/>
    <SolidColorBrush x:Key="WarningBrush" Color="#fbbf24"/>
    <SolidColorBrush x:Key="DangerBrush" Color="#ef4444"/>
    <SolidColorBrush x:Key="BackgroundBrush" Color="#2a2a2a"/>
    <SolidColorBrush x:Key="SurfaceBrush" Color="#3a3a3a"/>
    <SolidColorBrush x:Key="BorderBrush" Color="#4a4a4a"/>
    <SolidColorBrush x:Key="TextPrimaryBrush" Color="#ffffff"/>
    <SolidColorBrush x:Key="TextSecondaryBrush" Color="#9ca3af"/>
    
    <!-- –ö–Ω–æ–ø–∫–∞ Primary -->
    <Style x:Key="PrimaryButton" TargetType="Button">
        <Setter Property="Background" Value="{StaticResource PrimaryBrush}"/>
        <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
        <Setter Property="BorderThickness" Value="0"/>
        <Setter Property="Padding" Value="20,10"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="FontWeight" Value="SemiBold"/>
        <Setter Property="Cursor" Value="Hand"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="Button">
                    <Border Background="{TemplateBinding Background}"
                            CornerRadius="6"
                            Padding="{TemplateBinding Padding}">
                        <ContentPresenter HorizontalAlignment="Center"
                                        VerticalAlignment="Center"/>
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Background" Value="#1d4ed8"/>
                        </Trigger>
                        <Trigger Property="IsPressed" Value="True">
                            <Setter Property="Background" Value="#1e3a8a"/>
                        </Trigger>
                        <Trigger Property="IsEnabled" Value="False">
                            <Setter Property="Background" Value="#6b7280"/>
                            <Setter Property="Cursor" Value="Arrow"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>
    
    <!-- –ö–Ω–æ–ø–∫–∞ Success -->
    <Style x:Key="SuccessButton" TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
        <Setter Property="Background" Value="{StaticResource SuccessBrush}"/>
        <Style.Triggers>
            <Trigger Property="IsMouseOver" Value="True">
                <Setter Property="Background" Value="#059669"/>
            </Trigger>
        </Style.Triggers>
    </Style>
    
    <!-- –ö–Ω–æ–ø–∫–∞ Danger -->
    <Style x:Key="DangerButton" TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
        <Setter Property="Background" Value="{StaticResource DangerBrush}"/>
        <Style.Triggers>
            <Trigger Property="IsMouseOver" Value="True">
                <Setter Property="Background" Value="#dc2626"/>
            </Trigger>
        </Style.Triggers>
    </Style>
    
    <!-- TextBox -->
    <Style x:Key="ModernTextBox" TargetType="TextBox">
        <Setter Property="Background" Value="{StaticResource SurfaceBrush}"/>
        <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
        <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
        <Setter Property="BorderThickness" Value="2"/>
        <Setter Property="Padding" Value="12"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="TextBox">
                    <Border Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}"
                            CornerRadius="6">
                        <ScrollViewer x:Name="PART_ContentHost"
                                    Margin="{TemplateBinding Padding}"/>
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsFocused" Value="True">
                            <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrush}"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>
    
    <!-- Label -->
    <Style x:Key="ModernLabel" TargetType="TextBlock">
        <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
        <Setter Property="FontSize" Value="12"/>
        <Setter Property="Margin" Value="0,0,0,5"/>
    </Style>
    
</ResourceDictionary>
```


***

### **–í–û–ü–†–û–° 19: –†–∞–∑–º–µ—Ä –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–∫–æ–Ω**

**–í–û–ü–†–û–°:** –ö–∞–∫–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–∫–Ω–∞ –ø–ª–∞–≥–∏–Ω–∞ –∏ –≥–¥–µ –æ–Ω–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ú–∞–ª–µ–Ω—å–∫–∏–µ –æ–∫–Ω–∞ (400x300) –≤ —Ü–µ–Ω—Ç—Ä–µ —ç–∫—Ä–∞–Ω–∞
- **B)** –°—Ä–µ–¥–Ω–∏–µ –æ–∫–Ω–∞ (600x500) –≤ —Ü–µ–Ω—Ç—Ä–µ
- **C)** –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
- **D)** –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–æ–¥ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: B) –°—Ä–µ–¥–Ω–∏–µ –æ–∫–Ω–∞ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å:** –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- ‚úÖ **–ù–µ –∑–∞–≥–æ—Ä–∞–∂–∏–≤–∞–µ—Ç:** –ù–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω iiko
- ‚úÖ **–°—Ç–∞–Ω–¥–∞—Ä—Ç:** –ü—Ä–∏–≤—ã—á–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤
- ‚úÖ **Touch-friendly:** –ö–Ω–æ–ø–∫–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–∏–µ –¥–ª—è —Ç–∞—á—Å–∫—Ä–∏–Ω–æ–≤

**–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–∫–æ–Ω:**

```csharp
public static class WindowSizes
{
    // –û–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è
    public static readonly Size SearchWindow = new Size(600, 550);
    
    // –û–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–±–∞–ª–ª—ã/—Å–∫–∏–¥–∫–∞)
    public static readonly Size OperationWindow = new Size(900, 600);
    
    // –û–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥–æ—Å—Ç—è
    public static readonly Size CreateGuestWindow = new Size(500, 450);
    
    // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    public static readonly Size DiagnosticsWindow = new Size(800, 600);
    
    // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã (–µ—Å–ª–∏ resizable)
    public static readonly Size MinSize = new Size(400, 300);
}

public class LoyaltyWindowBase : Window
{
    protected LoyaltyWindowBase()
    {
        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        WindowStartupLocation = WindowStartupLocation.CenterScreen;
        
        // –°—Ç–∏–ª—å
        Background = new SolidColorBrush(BrandColors.Background);
        ResizeMode = ResizeMode.NoResize; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä
        ShowInTaskbar = false; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ taskbar
        Topmost = true; // –ü–æ–≤–µ—Ä—Ö –¥—Ä—É–≥–∏—Ö –æ–∫–æ–Ω
        
        // –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ä–∞–º–∫–∞
        BorderThickness = new Thickness(1);
        BorderBrush = new SolidColorBrush(BrandColors.Border);
        
        // –ó–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã (—á–µ—Ä–µ–∑ AllowsTransparency)
        AllowsTransparency = true;
        WindowStyle = WindowStyle.None;
        
        // –¢–µ–Ω—å
        Effect = new DropShadowEffect
        {
            Color = Colors.Black,
            Direction = 270,
            ShadowDepth = 5,
            Opacity = 0.5,
            BlurRadius = 15
        };
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ Escape
        KeyDown += (s, e) =>
        {
            if (e.Key == Key.Escape)
            {
                DialogResult = false;
                Close();
            }
        };
        
        // Drag-and-drop –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –æ–∫–Ω–∞
        MouseLeftButtonDown += (s, e) =>
        {
            if (e.GetPosition(this).Y < 50) // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –≤ —à–∞–ø–∫–µ
            {
                DragMove();
            }
        };
    }
}

// –û–∫–Ω–æ –ø–æ–∏—Å–∫–∞
public partial class LoyaltySearchWindow : LoyaltyWindowBase
{
    public LoyaltySearchWindow()
    {
        InitializeComponent();
        
        Width = WindowSizes.SearchWindow.Width;
        Height = WindowSizes.SearchWindow.Height;
        Title = "Max Loyalty - –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è";
    }
}

// –û–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏
public partial class LoyaltyOperationWindow : LoyaltyWindowBase
{
    public LoyaltyOperationWindow()
    {
        InitializeComponent();
        
        Width = WindowSizes.OperationWindow.Width;
        Height = WindowSizes.OperationWindow.Height;
        Title = "Max Loyalty - –û–ø–µ—Ä–∞—Ü–∏—è";
    }
}
```

**–ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:**

```csharp
public class ScreenHelper
{
    public static Size GetAdaptiveSize(Size defaultSize)
    {
        var screen = Screen.FromPoint(System.Windows.Forms.Cursor.Position);
        var workingArea = screen.WorkingArea;
        
        // –ï—Å–ª–∏ —ç–∫—Ä–∞–Ω –º–∞–ª–µ–Ω—å–∫–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä 1024x768)
        if (workingArea.Width < 1280 || workingArea.Height < 720)
        {
            // –£–º–µ–Ω—å—à–∞–µ–º –Ω–∞ 20%
            return new Size(
                defaultSize.Width * 0.8,
                defaultSize.Height * 0.8
            );
        }
        
        // –ï—Å–ª–∏ —ç–∫—Ä–∞–Ω –±–æ–ª—å—à–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä 1920x1080+)
        if (workingArea.Width >= 1920 && workingArea.Height >= 1080)
        {
            // –ú–æ–∂–µ–º –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å –∏–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å
            return defaultSize;
        }
        
        return defaultSize;
    }
}
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ 20-23 (–æ—Å—Ç–∞–ª—å–Ω—ã–µ UI/UX) –∏ –∑–∞—Ç–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ –±–ª–æ–∫—É 4 (Offline —Ä–µ–∂–∏–º)?

---

### **–í–û–ü–†–û–° 20: –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞**

**–í–û–ü–†–û–°:** –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ü–∏—Ñ—Ä–æ–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞/–∫–æ–¥–∞?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–µ—Ç —ç–∫—Ä–∞–Ω–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, —Ç–æ–ª—å–∫–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è
- **B)** –ü—Ä–æ—Å—Ç–∞—è NumPad (–∫–∞–∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä)
- **C)** NumPad + –∫–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –≤–≤–æ–¥–∞ (+1, +10, +100)
- **D)** NumPad —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º –∏ –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) NumPad —Å –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **Touch-friendly:** –ë–æ–ª—å—à–∏–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–∞—á—Å–∫—Ä–∏–Ω–æ–≤
- ‚úÖ **–£–¥–æ–±—Å—Ç–≤–æ:** –ö–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç –∫–∞–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–æ–º–µ—Ä
- ‚úÖ **–ú–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫:** –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç —É–≤–∏–¥–µ—Ç—å –æ–ø–µ—á–∞—Ç–∫–∏
- ‚úÖ **–ë—ã—Å—Ç—Ä–æ—Ç–∞:** –ö–ª–∏–∫ –±—ã—Å—Ç—Ä–µ–µ —á–µ–º –ø–æ–∏—Å–∫ —Ü–∏—Ñ—Ä—ã –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```xaml
<!-- NumericKeypad.xaml -->
<UserControl x:Class="MaxLoyaltyIiko.Controls.NumericKeypad"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- –î–∏—Å–ø–ª–µ–π -->
            <RowDefinition Height="*"/>    <!-- –ö–Ω–æ–ø–∫–∏ -->
        </Grid.RowDefinitions>
        
        <!-- –î–∏—Å–ø–ª–µ–π —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º -->
        <Border Grid.Row="0" 
                Background="#3a3a3a"
                BorderBrush="#4a4a4a"
                BorderThickness="2"
                CornerRadius="8"
                Padding="15"
                Margin="0,0,0,15">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- –û—Å–Ω–æ–≤–Ω–æ–π –¥–∏—Å–ø–ª–µ–π -->
                <TextBlock Grid.Row="0"
                           x:Name="DisplayText"
                           Text="+7 ___ ___ __ __"
                           FontSize="24"
                           FontFamily="Consolas"
                           Foreground="White"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,5"/>
                
                <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
                <TextBlock Grid.Row="1"
                           x:Name="HintText"
                           Text="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
                           FontSize="11"
                           Foreground="#9ca3af"
                           HorizontalAlignment="Center"/>
            </Grid>
        </Border>
        
        <!-- –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ -->
        <UniformGrid Grid.Row="1" 
                     Rows="4" 
                     Columns="3"
                     HorizontalAlignment="Center"
                     Width="300"
                     Height="280">
            
            <!-- –†—è–¥ 1 -->
            <Button Content="1" Style="{StaticResource NumpadButton}" Click="OnDigitClick"/>
            <Button Content="2" Style="{StaticResource NumpadButton}" Click="OnDigitClick"/>
            <Button Content="3" Style="{StaticResource NumpadButton}" Click="OnDigitClick"/>
            
            <!-- –†—è–¥ 2 -->
            <Button Content="4" Style="{StaticResource NumpadButton}" Click="OnDigitClick"/>
            <Button Content="5" Style="{StaticResource NumpadButton}" Click="OnDigitClick"/>
            <Button Content="6" Style="{StaticResource NumpadButton}" Click="OnDigitClick"/>
            
            <!-- –†—è–¥ 3 -->
            <Button Content="7" Style="{StaticResource NumpadButton}" Click="OnDigitClick"/>
            <Button Content="8" Style="{StaticResource NumpadButton}" Click="OnDigitClick"/>
            <Button Content="9" Style="{StaticResource NumpadButton}" Click="OnDigitClick"/>
            
            <!-- –†—è–¥ 4 -->
            <Button Content="‚å´" 
                    Style="{StaticResource NumpadButtonSecondary}" 
                    Click="OnBackspaceClick"
                    ToolTip="–£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ü–∏—Ñ—Ä—É"/>
            <Button Content="0" Style="{StaticResource NumpadButton}" Click="OnDigitClick"/>
            <Button Content="‚úì" 
                    Style="{StaticResource NumpadButtonSuccess}" 
                    Click="OnConfirmClick"
                    ToolTip="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"/>
        </UniformGrid>
    </Grid>
</UserControl>
```

```xaml
<!-- –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ -->
<Style x:Key="NumpadButton" TargetType="Button">
    <Setter Property="Background" Value="#3a3a3a"/>
    <Setter Property="Foreground" Value="White"/>
    <Setter Property="FontSize" Value="24"/>
    <Setter Property="FontWeight" Value="SemiBold"/>
    <Setter Property="BorderThickness" Value="0"/>
    <Setter Property="Margin" Value="5"/>
    <Setter Property="Cursor" Value="Hand"/>
    <Setter Property="Template">
        <Setter.Value>
            <ControlTemplate TargetType="Button">
                <Border Background="{TemplateBinding Background}"
                        CornerRadius="8">
                    <ContentPresenter HorizontalAlignment="Center"
                                    VerticalAlignment="Center"/>
                </Border>
                <ControlTemplate.Triggers>
                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter Property="Background" Value="#4a4a4a"/>
                    </Trigger>
                    <Trigger Property="IsPressed" Value="True">
                        <Setter Property="Background" Value="#1e40af"/>
                    </Trigger>
                </ControlTemplate.Triggers>
            </ControlTemplate>
        </Setter.Value>
    </Setter>
</Style>

<Style x:Key="NumpadButtonSecondary" TargetType="Button" BasedOn="{StaticResource NumpadButton}">
    <Setter Property="Background" Value="#6b7280"/>
    <Style.Triggers>
        <Trigger Property="IsMouseOver" Value="True">
            <Setter Property="Background" Value="#9ca3af"/>
        </Trigger>
    </Style.Triggers>
</Style>

<Style x:Key="NumpadButtonSuccess" TargetType="Button" BasedOn="{StaticResource NumpadButton}">
    <Setter Property="Background" Value="#10b981"/>
    <Setter Property="FontSize" Value="28"/>
    <Style.Triggers>
        <Trigger Property="IsMouseOver" Value="True">
            <Setter Property="Background" Value="#059669"/>
        </Trigger>
    </Style.Triggers>
</Style>
```

**Code-behind:**

```csharp
public partial class NumericKeypad : UserControl
{
    private StringBuilder currentInput = new StringBuilder();
    private InputMode mode = InputMode.Phone;
    
    public event EventHandler<string> InputCompleted;
    public event EventHandler<string> InputChanged;
    
    public enum InputMode
    {
        Phone,      // +7 999 123 45 67
        Code6Digit  // 123456
    }
    
    public NumericKeypad()
    {
        InitializeComponent();
        UpdateDisplay();
    }
    
    public void SetMode(InputMode newMode)
    {
        mode = newMode;
        currentInput.Clear();
        UpdateDisplay();
        
        HintText.Text = mode == InputMode.Phone 
            ? "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" 
            : "–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥";
    }
    
    private void OnDigitClick(object sender, RoutedEventArgs e)
    {
        var button = sender as Button;
        var digit = button.Content.ToString();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
        if (mode == InputMode.Phone && currentInput.Length >= 10)
        {
            SystemSounds.Beep.Play();
            return;
        }
        
        if (mode == InputMode.Code6Digit && currentInput.Length >= 6)
        {
            SystemSounds.Beep.Play();
            return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—É
        currentInput.Append(digit);
        
        // –ó–≤—É–∫ –∫–ª–∏–∫–∞
        PlayClickSound();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏—Å–ø–ª–µ–π
        UpdateDisplay();
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        InputChanged?.Invoke(this, GetFormattedValue());
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –≤–≤–µ–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é
        if ((mode == InputMode.Phone && currentInput.Length == 10) ||
            (mode == InputMode.Code6Digit && currentInput.Length == 6))
        {
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ feedback
            Task.Delay(300).ContinueWith(_ =>
            {
                Dispatcher.Invoke(() => OnConfirmClick(null, null));
            });
        }
    }
    
    private void OnBackspaceClick(object sender, RoutedEventArgs e)
    {
        if (currentInput.Length > 0)
        {
            currentInput.Remove(currentInput.Length - 1, 1);
            PlayClickSound();
            UpdateDisplay();
            InputChanged?.Invoke(this, GetFormattedValue());
        }
        else
        {
            SystemSounds.Beep.Play();
        }
    }
    
    private void OnConfirmClick(object sender, RoutedEventArgs e)
    {
        if (IsInputValid())
        {
            PlaySuccessSound();
            InputCompleted?.Invoke(this, GetFormattedValue());
        }
        else
        {
            SystemSounds.Exclamation.Play();
            
            var required = mode == InputMode.Phone ? 10 : 6;
            HintText.Text = $"–í–≤–µ–¥–∏—Ç–µ –≤—Å–µ {required} —Ü–∏—Ñ—Ä";
            HintText.Foreground = new SolidColorBrush(BrandColors.Danger);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —Ç—Ä—è—Å–∫–∏
            ShakeAnimation();
        }
    }
    
    private void UpdateDisplay()
    {
        var formatted = FormatInput(currentInput.ToString());
        DisplayText.Text = formatted;
        
        // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
        if (IsInputValid())
        {
            DisplayText.Foreground = new SolidColorBrush(BrandColors.Success);
        }
        else if (currentInput.Length > 0)
        {
            DisplayText.Foreground = new SolidColorBrush(BrandColors.Warning);
        }
        else
        {
            DisplayText.Foreground = Brushes.White;
        }
    }
    
    private string FormatInput(string input)
    {
        if (mode == InputMode.Phone)
        {
            // +7 999 123 45 67
            var template = "+7 ___ ___ __ __";
            var chars = input.ToCharArray();
            var result = template.ToCharArray();
            var inputIndex = 0;
            
            for (int i = 0; i < result.Length && inputIndex < chars.Length; i++)
            {
                if (result[i] == '_')
                {
                    result[i] = chars[inputIndex++];
                }
            }
            
            return new string(result);
        }
        else // Code6Digit
        {
            // 123456
            var template = "______";
            var chars = input.ToCharArray();
            var result = template.ToCharArray();
            
            for (int i = 0; i < chars.Length; i++)
            {
                result[i] = chars[i];
            }
            
            return new string(result);
        }
    }
    
    private bool IsInputValid()
    {
        if (mode == InputMode.Phone)
            return currentInput.Length == 10;
        else
            return currentInput.Length == 6;
    }
    
    private string GetFormattedValue()
    {
        if (mode == InputMode.Phone)
            return "+7" + currentInput.ToString();
        else
            return currentInput.ToString();
    }
    
    private void PlayClickSound()
    {
        // –ö–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–∏—è—Ç–Ω—ã–π –∑–≤—É–∫ –∫–ª–∏–∫–∞
        SystemSounds.Asterisk.Play();
    }
    
    private void PlaySuccessSound()
    {
        // –ó–≤—É–∫ —É—Å–ø–µ—Ö–∞
        SystemSounds.Exclamation.Play();
    }
    
    private void ShakeAnimation()
    {
        // –ê–Ω–∏–º–∞—Ü–∏—è —Ç—Ä—è—Å–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        var animation = new DoubleAnimation
        {
            From = 0,
            To = 10,
            Duration = TimeSpan.FromMilliseconds(50),
            AutoReverse = true,
            RepeatBehavior = new RepeatBehavior(3)
        };
        
        var transform = new TranslateTransform();
        DisplayText.RenderTransform = transform;
        
        transform.BeginAnimation(TranslateTransform.XProperty, animation);
    }
    
    // –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    public void Clear()
    {
        currentInput.Clear();
        UpdateDisplay();
        HintText.Foreground = new SolidColorBrush(BrandColors.TextSecondary);
        HintText.Text = mode == InputMode.Phone 
            ? "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" 
            : "–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥";
    }
    
    public string GetValue()
    {
        return GetFormattedValue();
    }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```csharp
public partial class LoyaltySearchWindow : LoyaltyWindowBase
{
    private void InitializeComponent()
    {
        // ...
        
        // –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        var keypad = new NumericKeypad();
        keypad.SetMode(NumericKeypad.InputMode.Phone);
        
        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è
        keypad.InputChanged += (s, value) =>
        {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            PhoneInputField.Text = value;
        };
        
        keypad.InputCompleted += async (s, value) =>
        {
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫
            await SearchGuestAsync(value);
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Ñ–æ—Ä–º—É
        KeypadContainer.Children.Add(keypad);
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤ (–¢–µ–ª–µ—Ñ–æ–Ω / –ö–æ–¥)
        PhoneTab.Selected += (s, e) =>
        {
            keypad.SetMode(NumericKeypad.InputMode.Phone);
            keypad.Clear();
        };
        
        CodeTab.Selected += (s, e) =>
        {
            keypad.SetMode(NumericKeypad.InputMode.Code6Digit);
            keypad.Clear();
        };
    }
}
```


***

### **–í–û–ü–†–û–° 21: Loading –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∏ feedback**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞—Å—Å–∏—Ä—É —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∑–∞–≥—Ä—É–∑–∫–∞?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ö—É—Ä—Å–æ—Ä –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –ø–µ—Å–æ—á–Ω—ã–µ —á–∞—Å—ã
- **B)** –°–ø–∏–Ω–Ω–µ—Ä –≤ —Ü–µ–Ω—Ç—Ä–µ –æ–∫–Ω–∞
- **C)** –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏
- **D)** Overlay —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π + —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) Overlay —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π + —Å—Ç–∞—Ç—É—Å**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ë–ª–æ–∫–∏—Ä—É–µ—Ç UI:** –ö–∞—Å—Å–∏—Ä –Ω–µ –º–æ–∂–µ—Ç –∫–ª–∏–∫–∞—Ç—å –ø–æ–∫–∞ –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞
- ‚úÖ **–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ:** –í–∏–¥–Ω–æ —á—Ç–æ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
- ‚úÖ **–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ:** –í—ã–≥–ª—è–¥–∏—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚úÖ **–ú–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å:** –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É Cancel

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```xaml
<!-- LoadingOverlay.xaml -->
<UserControl x:Class="MaxLoyaltyIiko.Controls.LoadingOverlay"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    
    <!-- –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω -->
    <Grid Background="#CC000000" Visibility="{Binding IsLoading}">
        <Border Background="#2a2a2a"
                BorderBrush="#1e40af"
                BorderThickness="2"
                CornerRadius="12"
                Padding="40"
                Width="300"
                Height="200"
                HorizontalAlignment="Center"
                VerticalAlignment="Center">
            
            <StackPanel>
                <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏–Ω–Ω–µ—Ä -->
                <Viewbox Width="60" Height="60" Margin="0,0,0,20">
                    <Canvas Width="24" Height="24">
                        <Path x:Name="SpinnerPath"
                              Data="M12,4 A8,8 0 0,1 20,12"
                              Stroke="#1e40af"
                              StrokeThickness="2"
                              StrokeLineCap="Round">
                            <Path.RenderTransform>
                                <RotateTransform x:Name="SpinnerRotation" 
                                               CenterX="12" 
                                               CenterY="12"/>
                            </Path.RenderTransform>
                        </Path>
                    </Canvas>
                </Viewbox>
                
                <!-- –¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ -->
                <TextBlock x:Name="StatusText"
                           Text="–ó–∞–≥—Ä—É–∑–∫–∞..."
                           FontSize="16"
                           FontWeight="Medium"
                           Foreground="White"
                           TextAlignment="Center"
                           Margin="0,0,0,10"/>
                
                <!-- –î–µ—Ç–∞–ª–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
                <TextBlock x:Name="DetailsText"
                           Text=""
                           FontSize="12"
                           Foreground="#9ca3af"
                           TextAlignment="Center"
                           TextWrapping="Wrap"/>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
                <Button x:Name="CancelButton"
                        Content="–û—Ç–º–µ–Ω–∏—Ç—å"
                        Style="{StaticResource DangerButton}"
                        Width="120"
                        Margin="0,20,0,0"
                        Visibility="Collapsed"
                        Click="OnCancelClick"/>
            </StackPanel>
        </Border>
    </Grid>
    
</UserControl>
```

**Code-behind:**

```csharp
public partial class LoadingOverlay : UserControl
{
    private Storyboard spinnerAnimation;
    private CancellationTokenSource cancellationTokenSource;
    
    public event EventHandler CancelRequested;
    
    public LoadingOverlay()
    {
        InitializeComponent();
        
        // –°–æ–∑–¥–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤—Ä–∞—â–µ–Ω–∏—è
        spinnerAnimation = new Storyboard();
        var rotation = new DoubleAnimation
        {
            From = 0,
            To = 360,
            Duration = TimeSpan.FromSeconds(1),
            RepeatBehavior = RepeatBehavior.Forever
        };
        
        Storyboard.SetTarget(rotation, SpinnerRotation);
        Storyboard.SetTargetProperty(rotation, new PropertyPath(RotateTransform.AngleProperty));
        
        spinnerAnimation.Children.Add(rotation);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        Visibility = Visibility.Collapsed;
    }
    
    public void Show(string message, string details = null, bool showCancelButton = false)
    {
        StatusText.Text = message;
        DetailsText.Text = details ?? string.Empty;
        DetailsText.Visibility = string.IsNullOrEmpty(details) 
            ? Visibility.Collapsed 
            : Visibility.Visible;
        
        CancelButton.Visibility = showCancelButton 
            ? Visibility.Visible 
            : Visibility.Collapsed;
        
        if (showCancelButton)
        {
            cancellationTokenSource = new CancellationTokenSource();
        }
        
        Visibility = Visibility.Visible;
        spinnerAnimation.Begin();
    }
    
    public void UpdateStatus(string message, string details = null)
    {
        StatusText.Text = message;
        
        if (details != null)
        {
            DetailsText.Text = details;
            DetailsText.Visibility = Visibility.Visible;
        }
    }
    
    public void Hide()
    {
        spinnerAnimation.Stop();
        Visibility = Visibility.Collapsed;
        cancellationTokenSource?.Dispose();
        cancellationTokenSource = null;
    }
    
    private void OnCancelClick(object sender, RoutedEventArgs e)
    {
        cancellationTokenSource?.Cancel();
        CancelRequested?.Invoke(this, EventArgs.Empty);
        Hide();
    }
    
    public CancellationToken GetCancellationToken()
    {
        return cancellationTokenSource?.Token ?? CancellationToken.None;
    }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –æ–∫–Ω–µ:**

```xaml
<Grid>
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <StackPanel>
        <!-- ... -->
    </StackPanel>
    
    <!-- Loading overlay –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ -->
    <local:LoadingOverlay x:Name="LoadingOverlay" 
                          Grid.RowSpan="999"
                          Panel.ZIndex="999"/>
</Grid>
```

```csharp
private async Task SearchGuestAsync(string input)
{
    try
    {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º loading
        LoadingOverlay.Show(
            message: "–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è...",
            details: $"–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É: {input.MaskPhone()}",
            showCancelButton: true
        );
        
        var cancellationToken = LoadingOverlay.GetCancellationToken();
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
        var result = await apiClient.SearchGuestAsync(
            input, 
            cancellationToken
        );
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        LoadingOverlay.UpdateStatus(
            message: "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...",
            details: "–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞—Ä—Ç–µ"
        );
        
        await Task.Delay(300); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è UX
        
        // –°–∫—Ä—ã–≤–∞–µ–º loading
        LoadingOverlay.Hide();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if (result.Found)
        {
            OpenOperationWindow(result.Guest);
        }
        else
        {
            ShowGuestNotFoundDialog();
        }
    }
    catch (OperationCanceledException)
    {
        LoadingOverlay.Hide();
        logger.LogInformation("Guest search cancelled by user");
    }
    catch (Exception ex)
    {
        LoadingOverlay.Hide();
        HandleError(ex);
    }
}
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - inline loader:**

–î–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (< 1 —Å–µ–∫—É–Ω–¥—ã) –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å inline loader:

```xaml
<!-- Inline loader –≤ –∫–Ω–æ–ø–∫–µ -->
<Button x:Name="SearchButton" Click="OnSearchClick">
    <StackPanel Orientation="Horizontal">
        <!-- –°–ø–∏–Ω–Ω–µ—Ä (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <Border x:Name="ButtonSpinner"
                Width="16"
                Height="16"
                Margin="0,0,8,0"
                Visibility="Collapsed">
            <!-- –ú–∏–Ω–∏–∞—Ç—é—Ä–Ω—ã–π —Å–ø–∏–Ω–Ω–µ—Ä -->
        </Border>
        
        <!-- –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ -->
        <TextBlock x:Name="ButtonText" Text="–ù–∞–π—Ç–∏"/>
    </StackPanel>
</Button>
```

```csharp
private async void OnSearchClick(object sender, RoutedEventArgs e)
{
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º inline loader
    ButtonText.Text = "–ü–æ–∏—Å–∫...";
    ButtonSpinner.Visibility = Visibility.Visible;
    SearchButton.IsEnabled = false;
    
    try
    {
        await SearchGuestAsync(input);
    }
    finally
    {
        // –°–∫—Ä—ã–≤–∞–µ–º
        ButtonText.Text = "–ù–∞–π—Ç–∏";
        ButtonSpinner.Visibility = Visibility.Collapsed;
        SearchButton.IsEnabled = true;
    }
}
```


***

### **–í–û–ü–†–û–° 22: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ - UI**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –∫–∞—Å—Å–∏—Ä—É?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π MessageBox.Show()
- **B)** Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–≤—Å–ø–ª—ã–≤–∞—é—Ç –∏ –∏—Å—á–µ–∑–∞—é—Ç)
- **C)** –ú–æ–¥–∞–ª—å–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ—à–∏–±–∫–∏
- **D)** Inline –æ—à–∏–±–∫–∏ + –º–æ–¥–∞–ª—å–Ω—ã–µ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **UX:** Inline –æ—à–∏–±–∫–∏ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç workflow
- ‚úÖ **–ö—Ä–∏—Ç–∏—á–Ω—ã–µ:** –ú–æ–¥–∞–ª—å–Ω—ã–µ –¥–ª—è –≤–∞–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫
- ‚úÖ **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä—è–¥–æ–º —Å –ø–æ–ª–µ–º
- ‚úÖ **–î–µ—Ç–∞–ª–∏:** –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

**–¢–∏–ø—ã –æ—à–∏–±–æ–∫:**

```csharp
public enum ErrorSeverity
{
    Info,       // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Å–∏–Ω–∏–π)
    Warning,    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–∂–µ–ª—Ç—ã–π)
    Error,      // –û—à–∏–±–∫–∞ (–∫—Ä–∞—Å–Ω—ã–π)
    Critical    // –ö—Ä–∏—Ç–∏—á–Ω–∞—è (–∫—Ä–∞—Å–Ω—ã–π + –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ)
}

public class UserError
{
    public ErrorSeverity Severity { get; set; }
    public string Message { get; set; }
    public string Details { get; set; }
    public string ActionText { get; set; }
    public Action ActionCallback { get; set; }
}
```

**Inline –æ—à–∏–±–∫–∏:**

```xaml
<!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è inline –æ—à–∏–±–æ–∫ -->
<UserControl x:Class="MaxLoyaltyIiko.Controls.InlineError">
    <Border x:Name="ErrorBorder"
            Background="#fef2f2"
            BorderBrush="#ef4444"
            BorderThickness="1"
            CornerRadius="6"
            Padding="12"
            Margin="0,5,0,5"
            Visibility="Collapsed">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <!-- –ò–∫–æ–Ω–∫–∞ -->
            <TextBlock Grid.Column="0"
                       x:Name="IconText"
                       Text="‚ö†Ô∏è"
                       FontSize="16"
                       VerticalAlignment="Center"
                       Margin="0,0,10,0"/>
            
            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ -->
            <TextBlock Grid.Column="1"
                       x:Name="MessageText"
                       TextWrapping="Wrap"
                       Foreground="#991b1b"
                       VerticalAlignment="Center"/>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
            <Button Grid.Column="2"
                    Content="‚úï"
                    Width="20"
                    Height="20"
                    Background="Transparent"
                    BorderThickness="0"
                    Foreground="#991b1b"
                    FontSize="14"
                    Click="OnCloseClick"
                    Cursor="Hand"/>
        </Grid>
    </Border>
</UserControl>
```

```csharp
public partial class InlineError : UserControl
{
    public void Show(string message, ErrorSeverity severity = ErrorSeverity.Error)
    {
        MessageText.Text = message;
        
        // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç severity
        switch (severity)
        {
            case ErrorSeverity.Info:
                ErrorBorder.Background = new SolidColorBrush(Color.FromRgb(239, 246, 255)); // blue-50
                ErrorBorder.BorderBrush = new SolidColorBrush(Color.FromRgb(59, 130, 246)); // blue-500
                MessageText.Foreground = new SolidColorBrush(Color.FromRgb(30, 58, 138)); // blue-900
                IconText.Text = "‚ÑπÔ∏è";
                break;
                
            case ErrorSeverity.Warning:
                ErrorBorder.Background = new SolidColorBrush(Color.FromRgb(254, 252, 232)); // yellow-50
                ErrorBorder.BorderBrush = new SolidColorBrush(Color.FromRgb(251, 191, 36)); // yellow-400
                MessageText.Foreground = new SolidColorBrush(Color.FromRgb(120, 53, 15)); // yellow-900
                IconText.Text = "‚ö†Ô∏è";
                break;
                
            case ErrorSeverity.Error:
            case ErrorSeverity.Critical:
                ErrorBorder.Background = new SolidColorBrush(Color.FromRgb(254, 242, 242)); // red-50
                ErrorBorder.BorderBrush = new SolidColorBrush(Color.FromRgb(239, 68, 68)); // red-500
                MessageText.Foreground = new SolidColorBrush(Color.FromRgb(153, 27, 27)); // red-900
                IconText.Text = "‚ùå";
                break;
        }
        
        ErrorBorder.Visibility = Visibility.Visible;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
        var animation = new DoubleAnimation
        {
            From = 0,
            To = 1,
            Duration = TimeSpan.FromMilliseconds(200)
        };
        ErrorBorder.BeginAnimation(OpacityProperty, animation);
    }
    
    public void Hide()
    {
        ErrorBorder.Visibility = Visibility.Collapsed;
    }
    
    private void OnCloseClick(object sender, RoutedEventArgs e)
    {
        Hide();
    }
}
```

**–ú–æ–¥–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥ –æ—à–∏–±–∫–∏:**

```csharp
public class ErrorDialog : Window
{
    public static void Show(UserError error)
    {
        var dialog = new ErrorDialog(error);
        dialog.ShowDialog();
    }
    
    private ErrorDialog(UserError error)
    {
        Width = 450;
        Height = 300;
        WindowStartupLocation = WindowStartupLocation.CenterScreen;
        ResizeMode = ResizeMode.NoResize;
        WindowStyle = WindowStyle.None;
        AllowsTransparency = true;
        Background = new SolidColorBrush(BrandColors.Background);
        
        var content = new Grid();
        
        // –®–∞–ø–∫–∞ —Å –∏–∫–æ–Ω–∫–æ–π –∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
        var header = new Border
        {
            Background = GetSeverityBrush(error.Severity),
            Padding = new Thickness(20),
            Child = new StackPanel
            {
                Orientation = Orientation.Horizontal,
                Children =
                {
                    new TextBlock
                    {
                        Text = GetSeverityIcon(error.Severity),
                        FontSize = 32,
                        Margin = new Thickness(0, 0, 15, 0)
                    },
                    new TextBlock
                    {
                        Text = GetSeverityTitle(error.Severity),
                        FontSize = 20,
                        FontWeight = FontWeights.Bold,
                        Foreground = Brushes.White,
                        VerticalAlignment = VerticalAlignment.Center
                    }
                }
            }
        };
        
        // –°–æ–æ–±—â–µ–Ω–∏–µ
        var message = new TextBlock
        {
            Text = error.Message,
            FontSize = 14,
            TextWrapping = TextWrapping.Wrap,
            Foreground = Brushes.White,
            Margin = new Thickness(20)
        };
        
        // –î–µ—Ç–∞–ª–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        var details = new Expander
        {
            Header = "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏",
            Content = new TextBox
            {
                Text = error.Details,
                IsReadOnly = true,
                TextWrapping = TextWrapping.Wrap,
                Background = new SolidColorBrush(BrandColors.Surface),
                Foreground = new SolidColorBrush(BrandColors.TextSecondary),
                BorderThickness = new Thickness(0),
                FontFamily = new FontFamily("Consolas"),
                FontSize = 11
            },
            Margin = new Thickness(20, 0, 20, 20),
            Visibility = string.IsNullOrEmpty(error.Details) 
                ? Visibility.Collapsed 
                : Visibility.Visible
        };
        
        // –ö–Ω–æ–ø–∫–∏
        var buttonsPanel = new StackPanel
        {
            Orientation = Orientation.Horizontal,
            HorizontalAlignment = HorizontalAlignment.Right,
            Margin = new Thickness(20)
        };
        
        if (error.ActionCallback != null)
        {
            var actionButton = new Button
            {
                Content = error.ActionText ?? "–î–µ–π—Å—Ç–≤–∏–µ",
                Style = (Style)FindResource("PrimaryButton"),
                Margin = new Thickness(0, 0, 10, 0)
            };
            actionButton.Click += (s, e) =>
            {
                error.ActionCallback?.Invoke();
                Close();
            };
            buttonsPanel.Children.Add(actionButton);
        }
        
        var closeButton = new Button
        {
            Content = "–ó–∞–∫—Ä—ã—Ç—å",
            Style = (Style)FindResource("PrimaryButton")
        };
        closeButton.Click += (s, e) => Close();
        buttonsPanel.Children.Add(closeButton);
        
        // –ö–æ–º–ø–æ–Ω–æ–≤–∫–∞
        var stack = new StackPanel();
        stack.Children.Add(header);
        stack.Children.Add(message);
        stack.Children.Add(details);
        stack.Children.Add(buttonsPanel);
        
        content.Children.Add(stack);
        Content = content;
    }
    
    private Brush GetSeverityBrush(ErrorSeverity severity)
    {
        return severity switch
        {
            ErrorSeverity.Info => new SolidColorBrush(BrandColors.Primary),
            ErrorSeverity.Warning => new SolidColorBrush(BrandColors.Warning),
            _ => new SolidColorBrush(BrandColors.Danger)
        };
    }
    
    private string GetSeverityIcon(ErrorSeverity severity)
    {
        return severity switch
        {
            ErrorSeverity.Info => "‚ÑπÔ∏è",
            ErrorSeverity.Warning => "‚ö†Ô∏è",
            _ => "‚ùå"
        };
    }
    
    private string GetSeverityTitle(ErrorSeverity severity)
    {
        return severity switch
        {
            ErrorSeverity.Info => "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è",
            ErrorSeverity.Warning => "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ",
            ErrorSeverity.Error => "–û—à–∏–±–∫–∞",
            ErrorSeverity.Critical => "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞",
            _ => "–û—à–∏–±–∫–∞"
        };
    }
}
```

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**

```csharp
public class ErrorHandler
{
    public static void Handle(Exception ex, string context = null)
    {
        logger.LogError(ex, "Error in {Context}", context);
        
        var error = MapExceptionToUserError(ex, context);
        
        // Inline –∏–ª–∏ –º–æ–¥–∞–ª—å–Ω—ã–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç severity
        if (error.Severity == ErrorSeverity.Critical)
        {
            ErrorDialog.Show(error);
        }
        else
        {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º inline –µ—Å–ª–∏ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
            var currentWindow = Application.Current.Windows
                .OfType<LoyaltyWindowBase>()
                .FirstOrDefault(w => w.IsActive);
            
            currentWindow?.ShowInlineError(error);
        }
        
        // –ú–µ—Ç—Ä–∏–∫–∞
        metricsService.RecordMetric("error.shown", 1, new Dictionary<string, string>
        {
            ["type"] = ex.GetType().Name,
            ["severity"] = error.Severity.ToString()
        });
    }
    
    private static UserError MapExceptionToUserError(Exception ex, string context)
    {
        return ex switch
        {
            ApiKeyRevokedException => new UserError
            {
                Severity = ErrorSeverity.Critical,
                Message = "–î–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–æ–∑–≤–∞–Ω",
                Details = ex.Message,
                ActionText = "–°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π",
                ActionCallback = () => Process.Start("https://maxloyalty.ru/support")
            },
            
            HttpRequestException => new UserError
            {
                Severity = ErrorSeverity.Error,
                Message = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É",
                Details = $"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.\n\n–î–µ—Ç–∞–ª–∏: {ex.Message}",
                ActionText = "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å",
                ActionCallback = () => { /* retry logic */ }
            },
            
            InsufficientBalanceException insufficientEx => new UserError
            {
                Severity = ErrorSeverity.Warning,
                Message = $"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ",
                Details = $"–î–æ—Å—Ç—É–ø–Ω–æ: {insufficientEx.Available:N0}‚ÇΩ\n–ó–∞–ø—Ä–æ—à–µ–Ω–æ: {insufficientEx.Requested:N0}‚ÇΩ"
            },
            
            ValidationException validationEx => new UserError
            {
                Severity = ErrorSeverity.Info,
                Message = validationEx.Message,
                Details = validationEx.ValidationErrors != null 
                    ? string.Join("\n", validationEx.ValidationErrors)
                    : null
            },
            
            _ => new UserError
            {
                Severity = ErrorSeverity.Error,
                Message = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞",
                Details = $"–ö–æ–Ω—Ç–µ–∫—Å—Ç: {context}\n\n{ex.GetType().Name}: {ex.Message}\n\n{ex.StackTrace}",
                ActionText = "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏",
                ActionCallback = () => Clipboard.SetText(ex.ToString())
            }
        };
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
try
{
    await ApplyPointsPayment(pointsToSpend);
}
catch (Exception ex)
{
    ErrorHandler.Handle(ex, "ApplyPointsPayment");
}
```


***

### **–í–û–ü–†–û–° 23: –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏**

**–í–û–ü–†–û–°:** –ö–∞–∫–∏–µ –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –ø–ª–∞–≥–∏–Ω–µ?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–µ—Ç –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à (—Ç–æ–ª—å–∫–æ –º—ã—à—å)
- **B)** –¢–æ–ª—å–∫–æ Escape –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
- **C)** Escape + Enter –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- **D)** –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –∫–ª–∞–≤–∏—à –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–∞–±–æ—Ç—ã

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–°–∫–æ—Ä–æ—Å—Ç—å:** –ö–∞—Å—Å–∏—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
- ‚úÖ **–≠—Ä–≥–æ–Ω–æ–º–∏–∫–∞:** –ú–µ–Ω—å—à–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –º—ã—à—å-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
- ‚úÖ **–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º:** –û–ø—ã—Ç–Ω—ã–µ –∫–∞—Å—Å–∏—Ä—ã –ª—é–±—è—Ç hotkeys
- ‚úÖ **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:** –ü–æ–º–æ–≥–∞–µ—Ç –ª—é–¥—è–º —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏

**–°–ø–∏—Å–æ–∫ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à:**

```csharp
public static class Hotkeys
{
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ
    public const Key OpenPlugin = Key.F9;           // –û—Ç–∫—Ä—ã—Ç—å –ø–ª–∞–≥–∏–Ω
    public const Key OpenDiagnostics = Key.D;       // Ctrl+Shift+D - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    
    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
    public const Key Close = Key.Escape;            // –ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ
    public const Key Confirm = Key.Enter;           // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å/OK
    public const Key Cancel = Key.Escape;           // –û—Ç–º–µ–Ω–∞
    
    // –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è
    public const Key SwitchToPhone = Key.F1;        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω
    public const Key SwitchToCode = Key.F2;         // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –∫–æ–¥
    public const Key Search = Key.F3;               // –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫
    public const Key CreateGuest = Key.F4;          // –°–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç—è
    
    // –û–ø–µ—Ä–∞—Ü–∏–∏
    public const Key ApplyPoints = Key.F5;          // –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã
    public const Key EarnOnly = Key.F6;             // –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å
    public const Key ApplyDiscount = Key.F5;        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É
    public const Key UnbindCard = Key.Delete;       // –û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    public const Key ClearInput = Key.Back;         // –û—á–∏—Å—Ç–∏—Ç—å (Ctrl+Backspace)
    public const Key SelectAll = Key.A;             // –í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë (Ctrl+A)
    
    // –ü–æ–º–æ—â—å
    public const Key ShowHelp = Key.F1;             // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–º–æ—â—å (–µ—Å–ª–∏ Ctrl –Ω–∞–∂–∞—Ç)
}
```

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à:**

```csharp
public partial class LoyaltySearchWindow : LoyaltyWindowBase
{
    protected override void OnKeyDown(KeyEventArgs e)
    {
        base.OnKeyDown(e);
        
        // –° –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏
        if (Keyboard.Modifiers == ModifierKeys.Control)
        {
            switch (e.Key)
            {
                case Key.A: // Ctrl+A - –≤—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë
                    InputField.SelectAll();
                    e.Handled = true;
                    break;
                    
                case Key.Back: // Ctrl+Backspace - –æ—á–∏—Å—Ç–∏—Ç—å
                    InputField.Clear();
                    e.Handled = true;
                    break;
                    
                case Key.F1: // Ctrl+F1 - –ø–æ–º–æ—â—å
                    ShowHelpDialog();
                    e.Handled = true;
                    break;
            }
        }
        else if (Keyboard.Modifiers == (ModifierKeys.Control | ModifierKeys.Shift))
        {
            if (e.Key == Key.D) // Ctrl+Shift+D - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
            {
                OpenDiagnostics();
                e.Handled = true;
            }
        }
        else // –ë–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
        {
            switch (e.Key)
            {
                case Key.F1: // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω
                    PhoneTab.IsSelected = true;
                    e.Handled = true;
                    break;
                    
                case Key.F2: // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –∫–æ–¥
                    CodeTab.IsSelected = true;
                    e.Handled = true;
                    break;
                    
                case Key.F3: // –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫
                    OnSearchClick(null, null);
                    e.Handled = true;
                    break;
                    
                case Key.F4: // –°–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç—è
                    OnCreateGuestClick(null, null);
                    e.Handled = true;
                    break;
                    
                case Key.Enter: // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                    OnOkClick(null, null);
                    e.Handled = true;
                    break;
                    
                case Key.Escape: // –ó–∞–∫—Ä—ã—Ç—å
                    DialogResult = false;
                    Close();
                    e.Handled = true;
                    break;
            }
        }
    }
}

public partial class LoyaltyOperationWindow : LoyaltyWindowBase
{
    protected override void OnKeyDown(KeyEventArgs e)
    {
        base.OnKeyDown(e);
        
        if (Keyboard.Modifiers == ModifierKeys.None)
        {
            switch (e.Key)
            {
                case Key.F5: // –°–ø–∏—Å–∞—Ç—å / –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É
                    if (mode == LoyaltyMode.Points)
                        OnSpendClick(null, null);
                    else
                        OnApplyDiscountClick(null, null);
                    e.Handled = true;
                    break;
                    
                case Key.F6: // –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å
                    if (mode == LoyaltyMode.Points)
                        OnEarnClick(null, null);
                    e.Handled = true;
                    break;
                    
                case Key.Delete: // –û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É
                    OnUnbindClick(null, null);
                    e.Handled = true;
                    break;
                    
                case Key.Escape: // –ó–∞–∫—Ä—ã—Ç—å
                    DialogResult = false;
                    Close();
                    e.Handled = true;
                    break;
            }
        }
    }
}
```

**–ü–æ–¥—Å–∫–∞–∑–∫–∏ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à –≤ UI:**

```xaml
<!-- –ö–Ω–æ–ø–∫–∏ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ -->
<Button Content="_–ù–∞–π—Ç–∏ (F3)"
        Click="OnSearchClick"
        ToolTip="–ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞: F3"/>

<Button Content="_–°–ø–∏—Å–∞—Ç—å (F5)"
        Click="OnSpendClick"
        ToolTip="–ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞: F5"/>

<Button Content="_–û—Ç–º–µ–Ω–∏—Ç—å (Esc)"
        Click="OnCancelClick"
        ToolTip="–ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞: Escape"/>

<!-- –î–∏–∞–ª–æ–≥ –ø–æ–º–æ—â–∏ -->
<Window x:Class="HelpDialog">
    <ScrollViewer>
        <StackPanel Margin="20">
            <TextBlock Text="–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ Max Loyalty" 
                       FontSize="18" 
                       FontWeight="Bold" 
                       Margin="0,0,0,20"/>
            
            <TextBlock Text="–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è" 
                       FontWeight="Bold" 
                       Margin="0,10,0,5"/>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="120"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <TextBlock Grid.Column="0" Text="F1" FontFamily="Consolas"/>
                <TextBlock Grid.Column="1" Text="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É"/>
                
                <!-- ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏ -->
            </Grid>
        </StackPanel>
    </ScrollViewer>
</Window>
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –ë–ª–æ–∫–æ–º 4 (Offline —Ä–µ–∂–∏–º –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è - 6 –≤–æ–ø—Ä–æ—Å–æ–≤)?

---

## **üì¥ –ë–õ–û–ö 4: OFFLINE –†–ï–ñ–ò–ú –ò –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø (6 –≤–æ–ø—Ä–æ—Å–æ–≤)**


***

### **–í–û–ü–†–û–° 24: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ offline —Å–æ—Å—Ç–æ—è–Ω–∏—è**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–ª–∞–≥–∏–Ω –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —á—Ç–æ backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –¢–æ–ª—å–∫–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–ø—Ä–æ—Å–∞ (reactive)
- **B)** Health check –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (proactive)
- **C)** Health check + –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
- **D)** Exponential backoff health checks —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) Exponential backoff + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ë—ã—Å—Ç—Ä–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** –£–∑–Ω–∞–µ–º –æ –ø—Ä–æ–±–ª–µ–º–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 5-10 —Å–µ–∫
- ‚úÖ **–ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º:** –ï—Å–ª–∏ offline, –Ω–µ —Å–ø–∞–º–∏–º –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
- ‚úÖ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:** –ö–∞—Å—Å–∏—Ä –∑–Ω–∞–µ—Ç –æ –ø—Ä–æ–±–ª–µ–º–µ
- ‚úÖ **–ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ online –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class HealthCheckService
{
    private readonly LoyaltyApiClient apiClient;
    private readonly ILogger logger;
    
    private HealthStatus currentStatus = HealthStatus.Unknown;
    private DateTime lastCheckTime = DateTime.MinValue;
    private Timer healthCheckTimer;
    
    // Exponential backoff –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    private int consecutiveFailures = 0;
    private readonly int[] checkIntervals = { 5, 10, 30, 60, 120 }; // —Å–µ–∫—É–Ω–¥—ã
    
    public event EventHandler<HealthStatus> StatusChanged;
    
    public enum HealthStatus
    {
        Unknown,
        Online,
        Offline,
        Degraded
    }
    
    public HealthCheckService(LoyaltyApiClient apiClient, ILogger logger)
    {
        this.apiClient = apiClient;
        this.logger = logger;
    }
    
    public void Start()
    {
        // –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–∑—É
        _ = CheckHealthAsync();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
        healthCheckTimer = new Timer(
            callback: async _ => await CheckHealthAsync(),
            state: null,
            dueTime: TimeSpan.FromSeconds(5),
            period: TimeSpan.FromSeconds(5)
        );
        
        logger.LogInformation("Health check service started");
    }
    
    public void Stop()
    {
        healthCheckTimer?.Dispose();
        logger.LogInformation("Health check service stopped");
    }
    
    public async Task<HealthStatus> CheckHealthAsync()
    {
        try
        {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º /health endpoint —Å —Ç–∞–π–º–∞—É—Ç–æ–º 3 —Å–µ–∫—É–Ω–¥—ã
            var stopwatch = Stopwatch.StartNew();
            
            var response = await apiClient.GetAsync<HealthResponse>(
                "/api/health",
                timeout: TimeSpan.FromSeconds(3)
            );
            
            stopwatch.Stop();
            
            if (response != null && response.Status == "ok")
            {
                var previousStatus = currentStatus;
                currentStatus = HealthStatus.Online;
                consecutiveFailures = 0;
                
                // –ï—Å–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å –∏–∑ offline
                if (previousStatus == HealthStatus.Offline)
                {
                    logger.LogInformation(
                        "Backend is back online. Response time: {ResponseTime}ms",
                        stopwatch.ElapsedMilliseconds
                    );
                    
                    OnStatusChanged(HealthStatus.Online);
                    
                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –∫–∞—Å—Å–∏—Ä–∞
                    NotifyCashier(
                        "‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ",
                        "–°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Å–Ω–æ–≤–∞ –¥–æ—Å—Ç—É–ø–Ω–∞",
                        NotificationType.Success
                    );
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º offline queue
                    await ProcessOfflineQueueAsync();
                }
                
                // –ï—Å–ª–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (> 2 —Å–µ–∫—É–Ω–¥) - degraded
                if (stopwatch.ElapsedMilliseconds > 2000)
                {
                    currentStatus = HealthStatus.Degraded;
                    logger.LogWarning(
                        "Backend is slow: {ResponseTime}ms",
                        stopwatch.ElapsedMilliseconds
                    );
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–æ–∫ –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π
                UpdateCheckInterval(checkIntervals[0]);
            }
            else
            {
                HandleUnhealthy("Invalid health response");
            }
        }
        catch (TaskCanceledException)
        {
            HandleUnhealthy("Health check timeout");
        }
        catch (HttpRequestException ex)
        {
            HandleUnhealthy($"Network error: {ex.Message}");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Unexpected error during health check");
            HandleUnhealthy($"Unexpected error: {ex.Message}");
        }
        
        lastCheckTime = DateTime.Now;
        return currentStatus;
    }
    
    private void HandleUnhealthy(string reason)
    {
        consecutiveFailures++;
        
        var previousStatus = currentStatus;
        currentStatus = HealthStatus.Offline;
        
        logger.LogWarning(
            "Backend is offline: {Reason}. Consecutive failures: {Count}",
            reason,
            consecutiveFailures
        );
        
        // –ü–µ—Ä–≤—ã–π —Ä–∞–∑ offline - —É–≤–µ–¥–æ–º–ª—è–µ–º –∫–∞—Å—Å–∏—Ä–∞
        if (previousStatus != HealthStatus.Offline)
        {
            OnStatusChanged(HealthStatus.Offline);
            
            NotifyCashier(
                "‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É",
                "–°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.\n" +
                "–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤.",
                NotificationType.Warning
            );
        }
        
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–æ–∫ (exponential backoff)
        var intervalIndex = Math.Min(consecutiveFailures - 1, checkIntervals.Length - 1);
        var interval = checkIntervals[intervalIndex];
        
        UpdateCheckInterval(interval);
        
        logger.LogInformation(
            "Next health check in {Interval} seconds",
            interval
        );
    }
    
    private void UpdateCheckInterval(int seconds)
    {
        healthCheckTimer?.Change(
            dueTime: TimeSpan.FromSeconds(seconds),
            period: TimeSpan.FromSeconds(seconds)
        );
    }
    
    private void OnStatusChanged(HealthStatus newStatus)
    {
        StatusChanged?.Invoke(this, newStatus);
        
        // –ú–µ—Ç—Ä–∏–∫–∞
        metricsService.RecordMetric(
            "backend.status",
            1,
            tags: new Dictionary<string, string>
            {
                ["status"] = newStatus.ToString().ToLower()
            }
        );
    }
    
    private void NotifyCashier(string title, string message, NotificationType type)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            // Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            ToastNotification.Show(title, message, type);
            
            // –¢–∞–∫–∂–µ –ª–æ–≥–∏—Ä—É–µ–º –≤ status bar –µ—Å–ª–∏ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
            var activeWindow = Application.Current.Windows
                .OfType<LoyaltyWindowBase>()
                .FirstOrDefault(w => w.IsActive);
            
            activeWindow?.UpdateStatusBar(title, type);
        });
    }
    
    private async Task ProcessOfflineQueueAsync()
    {
        try
        {
            var offlineQueue = new OfflineQueueService();
            await offlineQueue.ProcessQueueAsync(apiClient);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to process offline queue");
        }
    }
    
    public HealthStatus GetCurrentStatus()
    {
        return currentStatus;
    }
    
    public bool IsOnline()
    {
        return currentStatus == HealthStatus.Online || 
               currentStatus == HealthStatus.Degraded;
    }
    
    public TimeSpan TimeSinceLastCheck()
    {
        return DateTime.Now - lastCheckTime;
    }
}

// DTO
public class HealthResponse
{
    public string Status { get; set; } // "ok" –∏–ª–∏ "error"
    public DateTime ServerTime { get; set; }
    public string Version { get; set; }
}
```

**–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ UI:**

```xaml
<!-- Status bar –≤–Ω–∏–∑—É –æ–∫–Ω–∞ -->
<Border Grid.Row="999" 
        Background="#1e293b"
        BorderBrush="#334155"
        BorderThickness="0,1,0,0"
        Height="30">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <StackPanel Grid.Column="0" 
                    Orientation="Horizontal" 
                    Margin="10,0">
            <Ellipse x:Name="StatusIndicator"
                     Width="8"
                     Height="8"
                     Fill="#10b981"
                     Margin="0,0,8,0"/>
            <TextBlock x:Name="StatusText"
                       Text="–ü–æ–¥–∫–ª—é—á–µ–Ω–æ"
                       FontSize="11"
                       Foreground="#94a3b8"/>
        </StackPanel>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <TextBlock Grid.Column="1"
                   x:Name="StatusMessage"
                   FontSize="11"
                   Foreground="#64748b"
                   VerticalAlignment="Center"/>
        
        <!-- –í–µ—Ä—Å–∏—è -->
        <TextBlock Grid.Column="2"
                   Text="v1.0.0"
                   FontSize="10"
                   Foreground="#475569"
                   Margin="0,0,10,0"
                   VerticalAlignment="Center"/>
    </Grid>
</Border>
```

```csharp
public partial class LoyaltyWindowBase : Window
{
    protected void UpdateStatusBar(HealthStatus status)
    {
        switch (status)
        {
            case HealthStatus.Online:
                StatusIndicator.Fill = new SolidColorBrush(BrandColors.Success);
                StatusText.Text = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ";
                StatusText.Foreground = new SolidColorBrush(BrandColors.Success);
                break;
                
            case HealthStatus.Degraded:
                StatusIndicator.Fill = new SolidColorBrush(BrandColors.Warning);
                StatusText.Text = "–ú–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ";
                StatusText.Foreground = new SolidColorBrush(BrandColors.Warning);
                break;
                
            case HealthStatus.Offline:
                StatusIndicator.Fill = new SolidColorBrush(BrandColors.Danger);
                StatusText.Text = "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
                StatusText.Foreground = new SolidColorBrush(BrandColors.Danger);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º warning banner
                ShowOfflineBanner();
                break;
        }
    }
    
    private void ShowOfflineBanner()
    {
        var banner = new Border
        {
            Background = new SolidColorBrush(Color.FromRgb(254, 243, 199)), // yellow-100
            BorderBrush = new SolidColorBrush(BrandColors.Warning),
            BorderThickness = new Thickness(0, 0, 0, 2),
            Padding = new Thickness(15, 10),
            Child = new StackPanel
            {
                Orientation = Orientation.Horizontal,
                Children =
                {
                    new TextBlock
                    {
                        Text = "‚ö†Ô∏è",
                        FontSize = 16,
                        Margin = new Thickness(0, 0, 10, 0)
                    },
                    new TextBlock
                    {
                        Text = "Offline —Ä–µ–∂–∏–º: –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤",
                        Foreground = new SolidColorBrush(Color.FromRgb(120, 53, 15)), // yellow-900
                        FontWeight = FontWeights.Medium
                    }
                }
            }
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º banner –≤ –≤–µ—Ä—Ö –æ–∫–Ω–∞
        // ...
    }
}
```


***

### **–í–û–ü–†–û–° 25: Offline queue - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è**

**–í–û–ü–†–û–°:** –ö–∞–∫ —Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ offline –æ—á–µ—Ä–µ–¥–∏?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –í –ø–∞–º—è—Ç–∏ (List<T>) - —Ç–µ—Ä—è–µ–º –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
- **B)** JSON —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ
- **C)** SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **D)** JSON —Ñ–∞–π–ª + backup + —Ä–æ—Ç–∞—Ü–∏—è

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) JSON —Ñ–∞–π–ª —Å backup**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** JSON –ª–µ–≥–∫–æ —á–∏—Ç–∞—Ç—å –∏ debug–∏—Ç—å
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** Backup –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –∫–æ—Ä—Ä—É–ø—Ü–∏–∏
- ‚úÖ **–õ–µ–≥–∫–æ–≤–µ—Å–Ω–æ—Å—Ç—å:** –ù–µ –Ω—É–∂–Ω–∞ SQLite –¥–ª—è –Ω–µ–±–æ–ª—å—à–æ–≥–æ –æ–±—ä–µ–º–∞
- ‚úÖ **–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç—å:** –õ–µ–≥–∫–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è support

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```csharp
public class OfflineOperation
{
    public string Id { get; set; } = Guid.NewGuid().ToString();
    public DateTime QueuedAt { get; set; } = DateTime.UtcNow;
    public DateTime? ProcessedAt { get; set; }
    public int RetryCount { get; set; } = 0;
    public OperationType Type { get; set; }
    public OperationStatus Status { get; set; } = OperationStatus.Pending;
    
    // –î–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    public string GuestCardId { get; set; }
    public string OrderId { get; set; }
    public decimal CheckAmount { get; set; }
    public decimal? PointsToEarn { get; set; }
    
    // –ö–æ–Ω—Ç–µ–∫—Å—Ç
    public string CashierName { get; set; }
    public string RestaurantId { get; set; }
    
    // –†–µ–∑—É–ª—å—Ç–∞—Ç
    public string ErrorMessage { get; set; }
    public DateTime? ExpiresAt { get; set; } // –û–ø–µ—Ä–∞—Ü–∏—è –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
}

public enum OperationType
{
    FINALIZE_EARN_ONLY,   // –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç offline)
    FINALIZE_SPEND,       // –°–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è offline, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ queue –µ—Å–ª–∏ –±—ã–ª online)
    CANCEL_RESERVATION    // –û—Ç–º–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
}

public enum OperationStatus
{
    Pending,      // –û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
    Processing,   // –°–µ–π—á–∞—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
    Completed,    // –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
    Failed,       // –û—à–∏–±–∫–∞ (–ø–æ—Å–ª–µ –≤—Å–µ—Ö retry)
    Expired       // –ò—Å—Ç–µ–∫–ª–∞ (> 24 —á–∞—Å–æ–≤)
}

public class OfflineQueueService
{
    private readonly string queueFilePath;
    private readonly string backupFilePath;
    private readonly ILogger logger;
    private readonly object lockObject = new object();
    
    private const int MAX_QUEUE_SIZE = 100;
    private const int MAX_RETRY_COUNT = 5;
    private static readonly TimeSpan OPERATION_TTL = TimeSpan.FromHours(24);
    
    public OfflineQueueService()
    {
        var appDataPath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "MaxLoyaltyIiko"
        );
        
        Directory.CreateDirectory(appDataPath);
        
        queueFilePath = Path.Combine(appDataPath, "offline-queue.json");
        backupFilePath = Path.Combine(appDataPath, "offline-queue.backup.json");
        
        logger = Log.ForContext<OfflineQueueService>();
    }
    
    public void EnqueueOperation(OfflineOperation operation)
    {
        lock (lockObject)
        {
            try
            {
                var queue = LoadQueue();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞
                if (queue.Count >= MAX_QUEUE_SIZE)
                {
                    logger.LogError(
                        "Offline queue is full ({Size}/{Max}). Cannot enqueue operation.",
                        queue.Count,
                        MAX_QUEUE_SIZE
                    );
                    
                    throw new InvalidOperationException(
                        $"Offline queue is full. Maximum {MAX_QUEUE_SIZE} operations allowed."
                    );
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º expiration
                operation.ExpiresAt = DateTime.UtcNow.Add(OPERATION_TTL);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
                queue.Add(operation);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º
                SaveQueue(queue);
                
                logger.LogInformation(
                    "Operation queued for offline processing: {Type}, Order={OrderId}, Guest={GuestId}",
                    operation.Type,
                    operation.OrderId,
                    operation.GuestCardId
                );
                
                metricsService.RecordMetric("offline_queue.enqueued", 1);
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "Failed to enqueue offline operation");
                throw;
            }
        }
    }
    
    public async Task ProcessQueueAsync(LoyaltyApiClient apiClient)
    {
        lock (lockObject)
        {
            var queue = LoadQueue();
            
            if (queue.Count == 0)
            {
                logger.LogInformation("Offline queue is empty, nothing to process");
                return;
            }
            
            logger.LogInformation(
                "Processing offline queue: {Count} operations pending",
                queue.Count(op => op.Status == OperationStatus.Pending)
            );
        }
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –æ–¥–Ω–æ–π
        var operations = GetPendingOperations();
        var processedCount = 0;
        var failedCount = 0;
        
        foreach (var operation in operations)
        {
            try
            {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ –∏—Å—Ç–µ–∫–ª–∞
                if (operation.ExpiresAt < DateTime.UtcNow)
                {
                    MarkAsExpired(operation);
                    logger.LogWarning(
                        "Operation expired: {Id}, queued at {QueuedAt}",
                        operation.Id,
                        operation.QueuedAt
                    );
                    continue;
                }
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
                await ProcessOperationAsync(operation, apiClient);
                
                MarkAsCompleted(operation);
                processedCount++;
                
                logger.LogInformation(
                    "Operation processed successfully: {Id}, Type={Type}",
                    operation.Id,
                    operation.Type
                );
            }
            catch (Exception ex)
            {
                operation.RetryCount++;
                
                if (operation.RetryCount >= MAX_RETRY_COUNT)
                {
                    MarkAsFailed(operation, ex.Message);
                    failedCount++;
                    
                    logger.LogError(
                        ex,
                        "Operation failed permanently after {RetryCount} retries: {Id}",
                        operation.RetryCount,
                        operation.Id
                    );
                }
                else
                {
                    operation.ErrorMessage = ex.Message;
                    UpdateOperation(operation);
                    
                    logger.LogWarning(
                        ex,
                        "Operation failed, will retry: {Id}, Retry {Current}/{Max}",
                        operation.Id,
                        operation.RetryCount,
                        MAX_RETRY_COUNT
                    );
                }
            }
        }
        
        // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        CleanupQueue();
        
        logger.LogInformation(
            "Offline queue processing completed: {Processed} processed, {Failed} failed",
            processedCount,
            failedCount
        );
        
        metricsService.RecordMetric("offline_queue.processed", processedCount);
        metricsService.RecordMetric("offline_queue.failed", failedCount);
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –∫–∞—Å—Å–∏—Ä–∞
        if (processedCount > 0)
        {
            Application.Current.Dispatcher.Invoke(() =>
            {
                ToastNotification.Show(
                    "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
                    $"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {processedCount} –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ offline –æ—á–µ—Ä–µ–¥–∏",
                    NotificationType.Success
                );
            });
        }
    }
    
    private async Task ProcessOperationAsync(
        OfflineOperation operation, 
        LoyaltyApiClient apiClient)
    {
        operation.Status = OperationStatus.Processing;
        UpdateOperation(operation);
        
        switch (operation.Type)
        {
            case OperationType.FINALIZE_EARN_ONLY:
                await apiClient.FinalizePointsAsync(new FinalizePointsRequest
                {
                    GuestCardId = operation.GuestCardId,
                    OrderId = operation.OrderId,
                    CheckAmount = operation.CheckAmount,
                    PointsToEarn = operation.PointsToEarn.Value,
                    Action = LoyaltyAction.EarnOnly,
                    IsOfflineSync = true // –§–ª–∞–≥ —á—Ç–æ —ç—Ç–æ –∏–∑ offline queue
                });
                break;
                
            case OperationType.FINALIZE_SPEND:
                // –°–ø–∏—Å–∞–Ω–∏–µ –≤ offline queue - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
                await apiClient.FinalizePointsAsync(new FinalizePointsRequest
                {
                    GuestCardId = operation.GuestCardId,
                    OrderId = operation.OrderId,
                    CheckAmount = operation.CheckAmount,
                    // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è –∏–∑ operation
                    IsOfflineSync = true
                });
                break;
                
            case OperationType.CANCEL_RESERVATION:
                // –û—Ç–º–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –æ—á–µ—Ä–µ–¥–∏ –µ—Å–ª–∏ –ø–æ—Ç–µ—Ä—è–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                // –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —á–µ–∫–∞
                await apiClient.CancelReservationAsync(new CancelReservationRequest
                {
                    OrderId = operation.OrderId,
                    Reason = "OFFLINE_CANCEL",
                    IsOfflineSync = true
                });
                break;
        }
    }
    
    private List<OfflineOperation> LoadQueue()
    {
        try
        {
            if (!File.Exists(queueFilePath))
            {
                return new List<OfflineOperation>();
            }
            
            var json = File.ReadAllText(queueFilePath);
            
            if (string.IsNullOrWhiteSpace(json))
            {
                return new List<OfflineOperation>();
            }
            
            var queue = JsonConvert.DeserializeObject<List<OfflineOperation>>(json);
            return queue ?? new List<OfflineOperation>();
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to load offline queue, trying backup");
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ backup
            try
            {
                if (File.Exists(backupFilePath))
                {
                    var json = File.ReadAllText(backupFilePath);
                    var queue = JsonConvert.DeserializeObject<List<OfflineOperation>>(json);
                    
                    logger.LogWarning("Loaded queue from backup");
                    return queue ?? new List<OfflineOperation>();
                }
            }
            catch (Exception backupEx)
            {
                logger.LogError(backupEx, "Failed to load backup, returning empty queue");
            }
            
            return new List<OfflineOperation>();
        }
    }
    
    private void SaveQueue(List<OfflineOperation> queue)
    {
        try
        {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª –∫–∞–∫ backup
            if (File.Exists(queueFilePath))
            {
                File.Copy(queueFilePath, backupFilePath, overwrite: true);
            }
            
            // –°–µ—Ä–∏–∞–ª–∏–∑—É–µ–º —Å –∫—Ä–∞—Å–∏–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            var json = JsonConvert.SerializeObject(queue, Formatting.Indented);
            
            // –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å
            var tempPath = queueFilePath + ".tmp";
            File.WriteAllText(tempPath, json);
            File.Move(tempPath, queueFilePath, overwrite: true);
            
            logger.LogDebug("Offline queue saved: {Count} operations", queue.Count);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to save offline queue");
            throw;
        }
    }
    
    private List<OfflineOperation> GetPendingOperations()
    {
        lock (lockObject)
        {
            var queue = LoadQueue();
            return queue
                .Where(op => op.Status == OperationStatus.Pending)
                .OrderBy(op => op.QueuedAt)
                .ToList();
        }
    }
    
    private void UpdateOperation(OfflineOperation operation)
    {
        lock (lockObject)
        {
            var queue = LoadQueue();
            var index = queue.FindIndex(op => op.Id == operation.Id);
            
            if (index >= 0)
            {
                queue[index] = operation;
                SaveQueue(queue);
            }
        }
    }
    
    private void MarkAsCompleted(OfflineOperation operation)
    {
        operation.Status = OperationStatus.Completed;
        operation.ProcessedAt = DateTime.UtcNow;
        UpdateOperation(operation);
    }
    
    private void MarkAsFailed(OfflineOperation operation, string error)
    {
        operation.Status = OperationStatus.Failed;
        operation.ErrorMessage = error;
        UpdateOperation(operation);
    }
    
    private void MarkAsExpired(OfflineOperation operation)
    {
        operation.Status = OperationStatus.Expired;
        UpdateOperation(operation);
    }
    
    private void CleanupQueue()
    {
        lock (lockObject)
        {
            var queue = LoadQueue();
            
            // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∏ –∏—Å—Ç–µ–∫—à–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
            var cutoffDate = DateTime.UtcNow.AddDays(-7);
            
            var cleaned = queue.Where(op =>
                op.Status == OperationStatus.Pending ||
                (op.ProcessedAt.HasValue && op.ProcessedAt.Value > cutoffDate)
            ).ToList();
            
            if (cleaned.Count < queue.Count)
            {
                logger.LogInformation(
                    "Cleaned up {Count} old operations from queue",
                    queue.Count - cleaned.Count
                );
                
                SaveQueue(cleaned);
            }
        }
    }
    
    public int GetQueueSize()
    {
        lock (lockObject)
        {
            var queue = LoadQueue();
            return queue.Count(op => op.Status == OperationStatus.Pending);
        }
    }
    
    public List<OfflineOperation> GetAllOperations()
    {
        lock (lockObject)
        {
            return LoadQueue();
        }
    }
}
```


***

### **–í–û–ü–†–û–° 26: –ß—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤ offline —Ä–µ–∂–∏–º–µ?**

**–í–û–ü–†–û–°:** –ö–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –∫–æ–≥–¥–∞ backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–∏—á–µ–≥–æ (–ø–ª–∞–≥–∏–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
- **B)** –¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (readonly)
- **C)** –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ (EarnOnly)
- **D)** –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ + —Å–ø–∏—Å–∞–Ω–∏–µ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ (EarnOnly)**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ù–µ–ª—å–∑—è —Å–ø–∏—Å–∞—Ç—å –±–æ–ª—å—à–µ —á–µ–º –µ—Å—Ç—å (–Ω–µ –∑–Ω–∞–µ–º –±–∞–ª–∞–Ω—Å)
- ‚úÖ **–ü–æ–ª—å–∑–∞:** –ì–æ—Å—Ç—å —Ö–æ—Ç—è –±—ã –ø–æ–ª—É—á–∏—Ç –±–∞–ª–ª—ã –∑–∞ –ø–æ–∫—É–ø–∫—É
- ‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–µ (–º–æ–∂–Ω–æ retry)
- ‚ùå **–°–ø–∏—Å–∞–Ω–∏–µ:** –†–∏—Å–∫ —Å–ø–∏—Å–∞—Ç—å –±–æ–ª—å—à–µ —á–µ–º –µ—Å—Ç—å –∏–ª–∏ –∑–∞–¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**

```csharp
public class LoyaltyOperationService
{
    private readonly HealthCheckService healthCheck;
    private readonly OfflineQueueService offlineQueue;
    
    public async Task<OperationResult> SearchGuestAsync(string input)
    {
        // –ü–æ–∏—Å–∫ –≤—Å–µ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç backend
        if (!healthCheck.IsOnline())
        {
            return OperationResult.Error(
                "–ü–æ–∏—Å–∫ –≥–æ—Å—Ç–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ offline —Ä–µ–∂–∏–º–µ",
                ErrorSeverity.Warning
            );
        }
        
        return await apiClient.SearchGuestAsync(input);
    }
    
    public async Task<OperationResult> CalculateAsync(string guestCardId, decimal checkAmount)
    {
        // Calculate –≤—Å–µ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç backend
        if (!healthCheck.IsOnline())
        {
            return OperationResult.Error(
                "–†–∞—Å—á–µ—Ç –±–æ–Ω—É—Å–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ offline —Ä–µ–∂–∏–º–µ",
                ErrorSeverity.Warning
            );
        }
        
        return await apiClient.CalculateAsync(new CalculateRequest
        {
            GuestCardId = guestCardId,
            CheckAmount = checkAmount
        });
    }
    
    public async Task<OperationResult> ApplyPointsSpendAsync(
        string guestCardId,
        decimal pointsToSpend,
        decimal checkAmount,
        string orderId)
    {
        // –°–ø–∏—Å–∞–Ω–∏–µ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ offline
        if (!healthCheck.IsOnline())
        {
            return OperationResult.Error(
                "‚ö†Ô∏è –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ offline —Ä–µ–∂–∏–º–µ\n\n" +
                "–í—ã –º–æ–∂–µ—Ç–µ:\n" +
                "‚Ä¢ –î–æ–∂–¥–∞—Ç—å—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è\n" +
                "‚Ä¢ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤",
                ErrorSeverity.Warning
            );
        }
        
        // Online - —Ä–∞–±–æ—Ç–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
        var reserveResult = await apiClient.ReservePointsAsync(new ReserveRequest
        {
            GuestCardId = guestCardId,
            PointsToSpend = pointsToSpend,
            CheckAmount = checkAmount,
            OrderId = orderId
        });
        
        if (!reserveResult.Success)
        {
            return OperationResult.Error(reserveResult.Error);
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
        // ...
        
        return OperationResult.Success();
    }
    
    public async Task<OperationResult> ApplyEarnOnlyAsync(
        string guestCardId,
        string guestName,
        decimal checkAmount,
        decimal pointsToEarn,
        string orderId)
    {
        if (healthCheck.IsOnline())
        {
            // Online - –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            // –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ–∫–∞
            SaveOrderContext(new LoyaltyContext
            {
                GuestCardId = guestCardId,
                GuestName = guestName,
                BenefitType = BenefitType.Points,
                Action = LoyaltyAction.EarnOnly,
                PointsToEarn = pointsToEarn,
                OriginalCheckAmount = checkAmount,
                OrderId = orderId
            });
            
            return OperationResult.Success(
                $"‚úÖ –ö–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞\n\n–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +{pointsToEarn:N0} –±–∞–ª–ª–æ–≤"
            );
        }
        else
        {
            // Offline - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ offline queue
            offlineQueue.EnqueueOperation(new OfflineOperation
            {
                Type = OperationType.FINALIZE_EARN_ONLY,
                GuestCardId = guestCardId,
                OrderId = orderId,
                CheckAmount = checkAmount,
                PointsToEarn = pointsToEarn,
                CashierName = GetCurrentCashierName(),
                RestaurantId = configService.GetRestaurantId()
            });
            
            // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è
            SaveOrderContext(new LoyaltyContext
            {
                GuestCardId = guestCardId,
                GuestName = guestName,
                BenefitType = BenefitType.Points,
                Action = LoyaltyAction.EarnOnly,
                PointsToEarn = pointsToEarn,
                OriginalCheckAmount = checkAmount,
                OrderId = orderId,
                IsOffline = true
            });
            
            return OperationResult.Success(
                $"‚úÖ –ö–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ (offline —Ä–µ–∂–∏–º)\n\n" +
                $"–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +{pointsToEarn:N0} –±–∞–ª–ª–æ–≤\n" +
                $"–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è."
            );
        }
    }
    
    public async Task<OperationResult> ApplyDiscountAsync(
        string guestCardId,
        decimal discountPercentage,
        decimal discountAmount,
        decimal checkAmount,
        string orderId)
    {
        // –°–∫–∏–¥–∫–∞ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ offline (–Ω—É–∂–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è)
        if (!healthCheck.IsOnline())
        {
            return OperationResult.Error(
                "‚ö†Ô∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ offline —Ä–µ–∂–∏–º–µ\n\n" +
                "–î–æ–∂–¥–∏—Ç–µ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è",
                ErrorSeverity.Warning
            );
        }
        
        // Online - —Ä–∞–±–æ—Ç–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
        // ...
    }
}
```

**UI –≤ offline —Ä–µ–∂–∏–º–µ:**

```csharp
public partial class LoyaltySearchWindow : LoyaltyWindowBase
{
    protected override void OnLoaded(RoutedEventArgs e)
    {
        base.OnLoaded(e);
        
        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        healthCheck.StatusChanged += OnHealthStatusChanged;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
        UpdateUIForHealthStatus(healthCheck.GetCurrentStatus());
    }
    
    private void OnHealthStatusChanged(object sender, HealthStatus status)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            UpdateUIForHealthStatus(status);
        });
    }
    
    private void UpdateUIForHealthStatus(HealthStatus status)
    {
        if (status == HealthStatus.Offline)
        {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–Ω–Ω–µ—Ä
            OfflineBanner.Visibility = Visibility.Visible;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏
            HintText.Text = "‚ö†Ô∏è Offline —Ä–µ–∂–∏–º: –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤";
            HintText.Foreground = new SolidColorBrush(BrandColors.Warning);
        }
        else
        {
            OfflineBanner.Visibility = Visibility.Collapsed;
            HintText.Text = "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥";
            HintText.Foreground = new SolidColorBrush(BrandColors.TextSecondary);
        }
        
        UpdateStatusBar(status);
    }
}

public partial class LoyaltyOperationWindow : LoyaltyWindowBase
{
    private void UpdateUIForOffline(bool isOffline)
    {
        if (isOffline)
        {
            if (mode == LoyaltyMode.Points)
            {
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°–ø–∏—Å–∞—Ç—å"
                SpendButton.Visibility = Visibility.Collapsed;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                OfflineWarning.Visibility = Visibility.Visible;
                OfflineWarning.Text = 
                    "‚ö†Ô∏è Offline —Ä–µ–∂–∏–º\n\n" +
                    "–°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.\n" +
                    "–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ.";
                
                // –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∏—Å–ª–∏—Ç—å" –∞–∫—Ç–∏–≤–Ω–∞
                EarnButton.IsEnabled = true;
            }
            else // Discount
            {
                // –í—Å—è —Ñ–æ—Ä–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —Å–∫–∏–¥–∫–∏
                ApplyDiscountButton.IsEnabled = false;
                
                OfflineWarning.Visibility = Visibility.Visible;
                OfflineWarning.Text = 
                    "‚ö†Ô∏è Offline —Ä–µ–∂–∏–º\n\n" +
                    "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.\n" +
                    "–î–æ–∂–¥–∏—Ç–µ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.";
            }
        }
        else
        {
            // Online - –≤—Å—ë –¥–æ—Å—Ç—É–ø–Ω–æ
            SpendButton.Visibility = Visibility.Visible;
            ApplyDiscountButton.IsEnabled = true;
            OfflineWarning.Visibility = Visibility.Collapsed;
        }
    }
}
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ 27-29 (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ offline/sync) –∏ –∑–∞—Ç–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ –±–ª–æ–∫—É 5 (–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å iiko)?

---

### **–í–û–ü–†–û–° 27: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è**

**–í–û–ü–†–û–°:** –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–æ—Å—å. –ö–∞–∫ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ offline queue?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- **B)** –í—Ä—É—á–Ω—É—é –∫–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å"
- **C)** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞—Å—Å–∏—Ä—É
- **D)** –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —Ñ–æ–Ω–µ –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:** –ö–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:** –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π –æ—Ç –∫–∞—Å—Å–∏—Ä–∞
- ‚úÖ **–ö–æ–Ω—Ç—Ä–æ–ª—å:** –ú–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫
- ‚úÖ **–ê—É–¥–∏—Ç:** –í–∏–¥–Ω–æ –∫–æ–≥–¥–∞ –∏ —á—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–æ—Å—å

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class LoyaltyPlugin : IFrontPlugin
{
    private HealthCheckService healthCheck;
    private OfflineQueueService offlineQueue;
    
    public void Dispose()
    {
        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        healthCheck.StatusChanged += OnHealthStatusChanged;
    }
    
    private async void OnHealthStatusChanged(object sender, HealthStatus newStatus)
    {
        if (newStatus == HealthStatus.Online)
        {
            // –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–æ—Å—å
            logger.LogInformation("Connection restored, checking offline queue");
            
            var queueSize = offlineQueue.GetQueueSize();
            
            if (queueSize > 0)
            {
                logger.LogInformation(
                    "Found {Count} pending operations in offline queue",
                    queueSize
                );
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞—Å—Å–∏—Ä—É
                var shouldSync = await ShowSyncConfirmationAsync(queueSize);
                
                if (shouldSync)
                {
                    await SyncOfflineOperationsAsync();
                }
                else
                {
                    logger.LogInformation("User declined offline sync");
                }
            }
            else
            {
                logger.LogInformation("Offline queue is empty, no sync needed");
            }
        }
    }
    
    private async Task<bool> ShowSyncConfirmationAsync(int queueSize)
    {
        var result = await Application.Current.Dispatcher.InvokeAsync(() =>
        {
            var dialog = new SyncConfirmationDialog(queueSize);
            return dialog.ShowDialog() == true;
        });
        
        return result;
    }
    
    private async Task SyncOfflineOperationsAsync()
    {
        try
        {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º progress dialog
            var progressDialog = await Application.Current.Dispatcher.InvokeAsync(() =>
            {
                var dialog = new SyncProgressDialog();
                dialog.Show();
                return dialog;
            });
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å
            await offlineQueue.ProcessQueueAsync(apiClient);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º progress dialog
            Application.Current.Dispatcher.Invoke(() =>
            {
                progressDialog.Close();
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            ShowSyncResultNotification();
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to sync offline operations");
            
            Application.Current.Dispatcher.Invoke(() =>
            {
                ErrorDialog.Show(new UserError
                {
                    Severity = ErrorSeverity.Error,
                    Message = "–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏",
                    Details = ex.Message
                });
            });
        }
    }
    
    private void ShowSyncResultNotification()
    {
        var operations = offlineQueue.GetAllOperations();
        
        var completed = operations.Count(op => op.Status == OperationStatus.Completed);
        var failed = operations.Count(op => op.Status == OperationStatus.Failed);
        
        Application.Current.Dispatcher.Invoke(() =>
        {
            if (failed > 0)
            {
                ToastNotification.Show(
                    "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –æ—à–∏–±–∫–∞–º–∏",
                    $"‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {completed}\n‚ùå –û—à–∏–±–æ–∫: {failed}",
                    NotificationType.Warning,
                    duration: TimeSpan.FromSeconds(10)
                );
            }
            else
            {
                ToastNotification.Show(
                    "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
                    $"–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π: {completed}",
                    NotificationType.Success,
                    duration: TimeSpan.FromSeconds(5)
                );
            }
        });
    }
}
```

**–î–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**

```csharp
public class SyncConfirmationDialog : Window
{
    public SyncConfirmationDialog(int operationCount)
    {
        Width = 450;
        Height = 250;
        Title = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è";
        WindowStartupLocation = WindowStartupLocation.CenterScreen;
        ResizeMode = ResizeMode.NoResize;
        Background = new SolidColorBrush(BrandColors.Background);
        
        var content = new StackPanel { Margin = new Thickness(30) };
        
        // –ò–∫–æ–Ω–∫–∞
        var icon = new TextBlock
        {
            Text = "üîÑ",
            FontSize = 48,
            HorizontalAlignment = HorizontalAlignment.Center,
            Margin = new Thickness(0, 0, 0, 20)
        };
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        var title = new TextBlock
        {
            Text = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ",
            FontSize = 18,
            FontWeight = FontWeights.Bold,
            Foreground = Brushes.White,
            HorizontalAlignment = HorizontalAlignment.Center,
            Margin = new Thickness(0, 0, 0, 15)
        };
        
        // –°–æ–æ–±—â–µ–Ω–∏–µ
        var message = new TextBlock
        {
            Text = $"–í offline –æ—á–µ—Ä–µ–¥–∏ {operationCount} –æ–ø–µ—Ä–∞—Ü–∏–π.\n\n" +
                   "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å?",
            FontSize = 14,
            Foreground = new SolidColorBrush(BrandColors.TextSecondary),
            TextAlignment = TextAlignment.Center,
            TextWrapping = TextWrapping.Wrap,
            Margin = new Thickness(0, 0, 0, 25)
        };
        
        // –ö–Ω–æ–ø–∫–∏
        var buttonsPanel = new StackPanel
        {
            Orientation = Orientation.Horizontal,
            HorizontalAlignment = HorizontalAlignment.Center
        };
        
        var syncButton = new Button
        {
            Content = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å",
            Style = (Style)FindResource("SuccessButton"),
            Width = 180,
            Margin = new Thickness(0, 0, 10, 0)
        };
        syncButton.Click += (s, e) =>
        {
            DialogResult = true;
            Close();
        };
        
        var laterButton = new Button
        {
            Content = "–ü–æ–∑–∂–µ",
            Style = (Style)FindResource("PrimaryButton"),
            Width = 100
        };
        laterButton.Click += (s, e) =>
        {
            DialogResult = false;
            Close();
        };
        
        buttonsPanel.Children.Add(syncButton);
        buttonsPanel.Children.Add(laterButton);
        
        // –ö–æ–º–ø–æ–Ω–æ–≤–∫–∞
        content.Children.Add(icon);
        content.Children.Add(title);
        content.Children.Add(message);
        content.Children.Add(buttonsPanel);
        
        Content = content;
    }
}
```

**Progress dialog —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**

```csharp
public class SyncProgressDialog : Window
{
    private TextBlock progressText;
    private TextBlock statusText;
    private ProgressBar progressBar;
    
    public SyncProgressDialog()
    {
        Width = 400;
        Height = 200;
        Title = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...";
        WindowStartupLocation = WindowStartupLocation.CenterScreen;
        ResizeMode = ResizeMode.NoResize;
        WindowStyle = WindowStyle.None;
        AllowsTransparency = true;
        Background = new SolidColorBrush(BrandColors.Background);
        
        var content = new StackPanel { Margin = new Thickness(30) };
        
        // –°–ø–∏–Ω–Ω–µ—Ä
        var spinner = new LoadingSpinner
        {
            Width = 40,
            Height = 40,
            Margin = new Thickness(0, 0, 0, 20)
        };
        
        // –ü—Ä–æ–≥—Ä–µ—Å—Å
        progressText = new TextBlock
        {
            Text = "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: 0 / 0",
            FontSize = 16,
            FontWeight = FontWeights.SemiBold,
            Foreground = Brushes.White,
            HorizontalAlignment = HorizontalAlignment.Center,
            Margin = new Thickness(0, 0, 0, 10)
        };
        
        // –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
        progressBar = new ProgressBar
        {
            Height = 8,
            Minimum = 0,
            Maximum = 100,
            Value = 0,
            Margin = new Thickness(0, 0, 0, 15)
        };
        
        // –°—Ç–∞—Ç—É—Å
        statusText = new TextBlock
        {
            Text = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π...",
            FontSize = 12,
            Foreground = new SolidColorBrush(BrandColors.TextSecondary),
            HorizontalAlignment = HorizontalAlignment.Center,
            TextWrapping = TextWrapping.Wrap
        };
        
        content.Children.Add(spinner);
        content.Children.Add(progressText);
        content.Children.Add(progressBar);
        content.Children.Add(statusText);
        
        Content = content;
    }
    
    public void UpdateProgress(int current, int total)
    {
        Dispatcher.Invoke(() =>
        {
            progressText.Text = $"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {current} / {total}";
            progressBar.Value = total > 0 ? (current * 100.0 / total) : 0;
        });
    }
    
    public void UpdateStatus(string status)
    {
        Dispatcher.Invoke(() =>
        {
            statusText.Text = status;
        });
    }
}
```

**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è OfflineQueueService –¥–ª—è progress:**

```csharp
public class OfflineQueueService
{
    public event EventHandler<SyncProgressEventArgs> ProgressChanged;
    
    public async Task ProcessQueueAsync(LoyaltyApiClient apiClient)
    {
        var operations = GetPendingOperations();
        var total = operations.Count;
        var current = 0;
        
        OnProgressChanged(new SyncProgressEventArgs
        {
            Current = 0,
            Total = total,
            Status = "–ù–∞—á–∞–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏..."
        });
        
        foreach (var operation in operations)
        {
            try
            {
                OnProgressChanged(new SyncProgressEventArgs
                {
                    Current = current,
                    Total = total,
                    Status = $"–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ {operation.Type}..."
                });
                
                await ProcessOperationAsync(operation, apiClient);
                
                MarkAsCompleted(operation);
                current++;
                
                OnProgressChanged(new SyncProgressEventArgs
                {
                    Current = current,
                    Total = total,
                    Status = $"–û–ø–µ—Ä–∞—Ü–∏—è {current}/{total} –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞"
                });
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è UX
                await Task.Delay(300);
            }
            catch (Exception ex)
            {
                // Handle error...
            }
        }
        
        CleanupQueue();
        
        OnProgressChanged(new SyncProgressEventArgs
        {
            Current = total,
            Total = total,
            Status = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        });
    }
    
    private void OnProgressChanged(SyncProgressEventArgs e)
    {
        ProgressChanged?.Invoke(this, e);
    }
}

public class SyncProgressEventArgs : EventArgs
{
    public int Current { get; set; }
    public int Total { get; set; }
    public string Status { get; set; }
}
```


***

### **–í–û–ü–†–û–° 28: –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**

**–í–û–ü–†–û–°:** –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –∏–∑ offline queue –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å —Ç–µ–∫—É—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –û—Ç–∫–ª–æ–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é, –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
- **B)** –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞–∑—Ä–µ—à–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- **C)** –°–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞—Å—Å–∏—Ä–∞ —á—Ç–æ –¥–µ–ª–∞—Ç—å
- **D)** –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, backend —Ä–µ—à–∞–µ—Ç

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) Backend —Ä–µ—à–∞–µ—Ç + fallback**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞:** Backend –∑–Ω–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- ‚úÖ **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** Backend –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥—É–±–ª–∏
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –ü–ª–∞–≥–∏–Ω –Ω–µ —Ä–µ—à–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
- ‚úÖ **–ê—É–¥–∏—Ç:** –í—Å–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –Ω–∞ backend

**Backend –æ–±—Ä–∞–±–æ—Ç–∫–∞:**

```typescript
// Endpoint —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ —Å —Ñ–ª–∞–≥–æ–º offline sync
@Post('finalize-points')
async finalizePoints(@Body() dto: FinalizePointsDto) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ offline sync
  if (dto.isOfflineSync) {
    logger.log(`Processing offline sync operation: Order ${dto.orderId}`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è —É–∂–µ –Ω–µ –±—ã–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
    const existing = await this.prisma.loyaltyTransaction.findFirst({
      where: {
        orderId: dto.orderId,
        guestCardId: dto.guestCardId,
        type: dto.action === 'EARN_ONLY' ? 'EARN' : 'SPEND'
      }
    });
    
    if (existing) {
      // –û–ø–µ—Ä–∞—Ü–∏—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ (–¥—É–±–ª–∏–∫–∞—Ç)
      logger.warn(
        `Duplicate offline operation detected: Order ${dto.orderId}, ` +
        `existing transaction: ${existing.id}`
      );
      
      // –õ–æ–≥–∏—Ä—É–µ–º –≤ audit
      await this.auditLog.log({
        action: 'OFFLINE_SYNC_DUPLICATE',
        orderId: dto.orderId,
        existingTransactionId: existing.id,
        metadata: { dto }
      });
      
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
      return {
        success: true,
        duplicate: true,
        existingTransactionId: existing.id,
        message: 'Operation already processed'
      };
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–∫–∞–∑ –µ—â–µ –∞–∫—Ç—É–∞–ª–µ–Ω
    const orderAge = Date.now() - new Date(dto.timestamp).getTime();
    const MAX_ORDER_AGE = 7 * 24 * 60 * 60 * 1000; // 7 –¥–Ω–µ–π
    
    if (orderAge > MAX_ORDER_AGE) {
      logger.error(
        `Offline operation too old: Order ${dto.orderId}, ` +
        `age: ${Math.round(orderAge / (24 * 60 * 60 * 1000))} days`
      );
      
      throw new BadRequestException({
        code: 'OPERATION_TOO_OLD',
        message: 'Operation is too old to process',
        orderId: dto.orderId,
        ageInDays: Math.round(orderAge / (24 * 60 * 60 * 1000))
      });
    }
    
    // –î–ª—è EARN_ONLY –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—É–º–º–∞ —á–µ–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
    if (dto.action === 'EARN_ONLY') {
      // –ú–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å—É–º–º—É —á–µ–∫–∞ –∏–∑ iiko API –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      // –ù–æ –æ–±—ã—á–Ω–æ –ø—Ä–æ—Å—Ç–æ –¥–æ–≤–µ—Ä—è–µ–º offline –¥–∞–Ω–Ω—ã–º –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
    }
    
    // –î–ª—è SPEND –ø—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
    if (dto.action === 'SPEND') {
      const guestCard = await this.prisma.guestCard.findUnique({
        where: { id: dto.guestCardId },
        include: { transactions: true }
      });
      
      const currentBalance = this.calculateBalance(guestCard);
      
      if (currentBalance < dto.pointsToSpend) {
        logger.error(
          `Insufficient balance for offline spend: ` +
          `Guest ${dto.guestCardId}, ` +
          `requested: ${dto.pointsToSpend}, ` +
          `available: ${currentBalance}`
        );
        
        // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ - —Å–ø–∏—Å–∞—Ç—å –Ω–µ –º–æ–∂–µ–º
        throw new BadRequestException({
          code: 'INSUFFICIENT_BALANCE_OFFLINE',
          message: 'Insufficient balance for offline operation',
          requested: dto.pointsToSpend,
          available: currentBalance,
          orderId: dto.orderId
        });
      }
    }
  }
  
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –∫–∞–∫ –æ–±—ã—á–Ω–æ
  const transaction = await this.createTransaction(dto);
  
  // –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ —ç—Ç–æ –±—ã–ª–∞ offline –æ–ø–µ—Ä–∞—Ü–∏—è
  if (dto.isOfflineSync) {
    await this.prisma.loyaltyTransaction.update({
      where: { id: transaction.id },
      data: {
        metadata: {
          ...transaction.metadata,
          offlineSync: true,
          syncedAt: new Date()
        }
      }
    });
  }
  
  return {
    success: true,
    transactionId: transaction.id,
    newBalance: await this.getGuestBalance(dto.guestCardId)
  };
}
```

**–ü–ª–∞–≥–∏–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ sync:**

```csharp
private async Task ProcessOperationAsync(
    OfflineOperation operation, 
    LoyaltyApiClient apiClient)
{
    try
    {
        operation.Status = OperationStatus.Processing;
        UpdateOperation(operation);
        
        var response = await apiClient.FinalizePointsAsync(new FinalizePointsRequest
        {
            GuestCardId = operation.GuestCardId,
            OrderId = operation.OrderId,
            CheckAmount = operation.CheckAmount,
            PointsToEarn = operation.PointsToEarn,
            Action = LoyaltyAction.EarnOnly,
            IsOfflineSync = true,
            Timestamp = operation.QueuedAt // –í–∞–∂–Ω–æ: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
        });
        
        if (response.Duplicate)
        {
            // –û–ø–µ—Ä–∞—Ü–∏—è —É–∂–µ –±—ã–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ - —ç—Ç–æ OK
            logger.LogInformation(
                "Offline operation was already processed: {OrderId}, " +
                "existing transaction: {TransactionId}",
                operation.OrderId,
                response.ExistingTransactionId
            );
            
            // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ completed
            MarkAsCompleted(operation);
        }
        else
        {
            // –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
            logger.LogInformation(
                "Offline operation processed successfully: {OrderId}, " +
                "transaction: {TransactionId}",
                operation.OrderId,
                response.TransactionId
            );
            
            MarkAsCompleted(operation);
        }
    }
    catch (ApiException ex) when (ex.Code == "OPERATION_TOO_OLD")
    {
        // –û–ø–µ—Ä–∞—Ü–∏—è —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä–∞—è - –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ expired
        logger.LogWarning(
            "Offline operation expired: {OrderId}, age: {Age} days",
            operation.OrderId,
            ex.Data["ageInDays"]
        );
        
        MarkAsExpired(operation);
    }
    catch (ApiException ex) when (ex.Code == "INSUFFICIENT_BALANCE_OFFLINE")
    {
        // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞ - –Ω–µ –º–æ–∂–µ–º –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
        logger.LogError(
            "Cannot process offline spend - insufficient balance: {OrderId}, " +
            "requested: {Requested}, available: {Available}",
            operation.OrderId,
            ex.Data["requested"],
            ex.Data["available"]
        );
        
        // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ failed
        MarkAsFailed(
            operation, 
            $"Insufficient balance: {ex.Data["available"]} < {ex.Data["requested"]}"
        );
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        NotifyManager(
            "–û—à–∏–±–∫–∞ offline –æ–ø–µ—Ä–∞—Ü–∏–∏",
            $"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã –¥–ª—è –∑–∞–∫–∞–∑–∞ {operation.OrderId}. " +
            $"–ù–∞ –∫–∞—Ä—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤."
        );
    }
    catch (Exception ex)
    {
        // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ - –±—É–¥–µ–º retry
        logger.LogError(ex, "Failed to process offline operation: {OrderId}", operation.OrderId);
        throw;
    }
}
```


***

### **–í–û–ü–†–û–° 29: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ offline queue**

**–í–û–ü–†–û–°:** –ö–∞–∫ –¥–æ–ª–≥–æ –¥–µ—Ä–∂–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –≤ offline queue?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ (–ø–æ–∫–∞ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è)
- **B)** 24 —á–∞—Å–∞
- **C)** 7 –¥–Ω–µ–π
- **D)** –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: B) 24 —á–∞—Å–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å:** –û–ø–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ —Å—É—Ç–æ–∫ —É–∂–µ –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã
- ‚úÖ **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:** –ë–∞–ª–ª—ã –¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏—Å–ª—è—Ç—å—Å—è –≤ —Ä–∞–∑—É–º–Ω—ã–π —Å—Ä–æ–∫
- ‚úÖ **Disk space:** –ù–µ —Ä–∞—Å—Ç–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
- ‚úÖ **–ö–æ–º–ø—Ä–æ–º–∏—Å—Å:** –î–∞–∂–µ –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º offline —É—Å–ø–µ—é—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class OfflineQueueService
{
    private static readonly TimeSpan OPERATION_TTL = TimeSpan.FromHours(24);
    private static readonly TimeSpan WARNING_THRESHOLD = TimeSpan.FromHours(20);
    
    private Timer expirationCheckTimer;
    
    public void Start()
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–µ–∫—à–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∫–∞–∂–¥—ã–π —á–∞—Å
        expirationCheckTimer = new Timer(
            callback: _ => CheckExpiredOperations(),
            state: null,
            dueTime: TimeSpan.FromMinutes(5),
            period: TimeSpan.FromHours(1)
        );
    }
    
    public void Stop()
    {
        expirationCheckTimer?.Dispose();
    }
    
    private void CheckExpiredOperations()
    {
        lock (lockObject)
        {
            var queue = LoadQueue();
            var now = DateTime.UtcNow;
            
            var expiredOps = queue
                .Where(op => 
                    op.Status == OperationStatus.Pending &&
                    op.ExpiresAt.HasValue &&
                    op.ExpiresAt.Value < now
                )
                .ToList();
            
            if (expiredOps.Any())
            {
                logger.LogWarning(
                    "Found {Count} expired operations in queue",
                    expiredOps.Count
                );
                
                foreach (var op in expiredOps)
                {
                    MarkAsExpired(op);
                    
                    logger.LogWarning(
                        "Operation expired: {Id}, Type={Type}, Order={OrderId}, " +
                        "Queued={QueuedAt}, Age={Age}",
                        op.Id,
                        op.Type,
                        op.OrderId,
                        op.QueuedAt,
                        now - op.QueuedAt
                    );
                }
                
                SaveQueue(queue);
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                NotifyManagerAboutExpiredOperations(expiredOps);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–ª–∏–∑–∫–∏–µ –∫ –∏—Å—Ç–µ—á–µ–Ω–∏—é
            var warningOps = queue
                .Where(op => 
                    op.Status == OperationStatus.Pending &&
                    op.ExpiresAt.HasValue &&
                    op.ExpiresAt.Value < now.Add(WARNING_THRESHOLD) &&
                    op.ExpiresAt.Value > now
                )
                .ToList();
            
            if (warningOps.Any())
            {
                logger.LogWarning(
                    "Found {Count} operations close to expiration",
                    warningOps.Count
                );
                
                NotifyManagerAboutExpiringOperations(warningOps);
            }
        }
    }
    
    private void NotifyManagerAboutExpiredOperations(List<OfflineOperation> operations)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            var message = 
                $"‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!\n\n" +
                $"{operations.Count} –æ–ø–µ—Ä–∞—Ü–∏–π –≤ offline –æ—á–µ—Ä–µ–¥–∏ –∏—Å—Ç–µ–∫–ª–∏.\n\n" +
                $"–ë–∞–ª–ª—ã –Ω–µ –±—ã–ª–∏ –Ω–∞—á–∏—Å–ª–µ–Ω—ã –¥–ª—è —ç—Ç–∏—Ö –∑–∞–∫–∞–∑–æ–≤:\n";
            
            foreach (var op in operations.Take(5))
            {
                message += $"‚Ä¢ –ó–∞–∫–∞–∑ {op.OrderId} (–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ {op.PointsToEarn:N0} –±–∞–ª–ª–æ–≤)\n";
            }
            
            if (operations.Count > 5)
            {
                message += $"... –∏ –µ—â–µ {operations.Count - 5}\n";
            }
            
            message += "\n–°–≤—è–∂–∏—Ç–µ—Å—å —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.";
            
            ToastNotification.Show(
                "–û–ø–µ—Ä–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫–ª–∏",
                message,
                NotificationType.Error,
                duration: TimeSpan.FromMinutes(5) // –î–æ–ª–≥–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            );
        });
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        try
        {
            apiClient.ReportExpiredOperationsAsync(new ReportExpiredOperationsRequest
            {
                OperationIds = operations.Select(o => o.Id).ToList(),
                RestaurantId = configService.GetRestaurantId()
            });
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to report expired operations to backend");
        }
    }
    
    private void NotifyManagerAboutExpiringOperations(List<OfflineOperation> operations)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            var oldestOp = operations.OrderBy(o => o.ExpiresAt).First();
            var timeLeft = oldestOp.ExpiresAt.Value - DateTime.UtcNow;
            
            ToastNotification.Show(
                "–û–ø–µ—Ä–∞—Ü–∏–∏ —Å–∫–æ—Ä–æ –∏—Å—Ç–µ–∫—É—Ç",
                $"–í offline –æ—á–µ—Ä–µ–¥–∏ {operations.Count} –æ–ø–µ—Ä–∞—Ü–∏–π.\n" +
                $"–°—Ç–∞—Ä–µ–π—à–∞—è –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ {timeLeft.Hours}—á {timeLeft.Minutes}–º.\n\n" +
                $"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.",
                NotificationType.Warning,
                duration: TimeSpan.FromSeconds(30)
            );
        });
    }
    
    public void EnqueueOperation(OfflineOperation operation)
    {
        lock (lockObject)
        {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º TTL
            operation.ExpiresAt = DateTime.UtcNow.Add(OPERATION_TTL);
            
            // ...–æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
            
            logger.LogInformation(
                "Operation queued, will expire at {ExpiresAt} (in {Hours}h)",
                operation.ExpiresAt,
                OPERATION_TTL.TotalHours
            );
        }
    }
    
    // –†—É—á–Ω–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Å—Ä–æ–∫–∞ (–¥–ª—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤)
    public void ExtendOperationTTL(string operationId, TimeSpan extension)
    {
        lock (lockObject)
        {
            var queue = LoadQueue();
            var operation = queue.FirstOrDefault(op => op.Id == operationId);
            
            if (operation == null)
            {
                throw new InvalidOperationException($"Operation {operationId} not found");
            }
            
            if (operation.Status != OperationStatus.Pending)
            {
                throw new InvalidOperationException(
                    $"Cannot extend TTL for operation in status {operation.Status}"
                );
            }
            
            operation.ExpiresAt = operation.ExpiresAt.Value.Add(extension);
            
            SaveQueue(queue);
            
            logger.LogInformation(
                "Extended TTL for operation {Id}, new expiration: {ExpiresAt}",
                operationId,
                operation.ExpiresAt
            );
        }
    }
}
```

**UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è offline queue (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞):**

```csharp
public class OfflineQueueViewer : Window
{
    private DataGrid operationsGrid;
    private OfflineQueueService queueService;
    
    public OfflineQueueViewer(OfflineQueueService queueService)
    {
        this.queueService = queueService;
        
        Title = "Offline –æ—á–µ—Ä–µ–¥—å";
        Width = 900;
        Height = 600;
        
        InitializeUI();
        LoadOperations();
    }
    
    private void InitializeUI()
    {
        var mainPanel = new DockPanel();
        
        // Toolbar
        var toolbar = new ToolBar();
        
        var refreshBtn = new Button { Content = "–û–±–Ω–æ–≤–∏—Ç—å" };
        refreshBtn.Click += (s, e) => LoadOperations();
        
        var syncBtn = new Button { Content = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å" };
        syncBtn.Click += async (s, e) => await SyncNow();
        
        var clearBtn = new Button { Content = "–û—á–∏—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ" };
        clearBtn.Click += (s, e) => CleanupQueue();
        
        toolbar.Items.Add(refreshBtn);
        toolbar.Items.Add(syncBtn);
        toolbar.Items.Add(clearBtn);
        
        DockPanel.SetDock(toolbar, Dock.Top);
        mainPanel.Children.Add(toolbar);
        
        // Grid —Å –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
        operationsGrid = new DataGrid
        {
            AutoGenerateColumns = false,
            IsReadOnly = true,
            GridLinesVisibility = DataGridGridLinesVisibility.All
        };
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–ó–∞–∫–∞–∑",
            Binding = new Binding("OrderId"),
            Width = 100
        });
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–¢–∏–ø",
            Binding = new Binding("Type"),
            Width = 150
        });
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–ë–∞–ª–ª—ã",
            Binding = new Binding("PointsToEarn") { StringFormat = "{0:N0}" },
            Width = 80
        });
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–°—Ç–∞—Ç—É—Å",
            Binding = new Binding("Status"),
            Width = 100
        });
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–î–æ–±–∞–≤–ª–µ–Ω–æ",
            Binding = new Binding("QueuedAt") { StringFormat = "{0:dd.MM.yyyy HH:mm}" },
            Width = 130
        });
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–ò—Å—Ç–µ–∫–∞–µ—Ç",
            Binding = new Binding("ExpiresAt") { StringFormat = "{0:dd.MM.yyyy HH:mm}" },
            Width = 130
        });
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–ü–æ–ø—ã—Ç–æ–∫",
            Binding = new Binding("RetryCount"),
            Width = 70
        });
        
        mainPanel.Children.Add(operationsGrid);
        
        Content = mainPanel;
    }
    
    private void LoadOperations()
    {
        var operations = queueService.GetAllOperations();
        operationsGrid.ItemsSource = operations.OrderByDescending(o => o.QueuedAt);
    }
    
    private async Task SyncNow()
    {
        // ...
    }
    
    private void CleanupQueue()
    {
        // ...
    }
}
```


***

## **üîå –ë–õ–û–ö 5: –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° iiko FRONT (8 –≤–æ–ø—Ä–æ—Å–æ–≤)**


***

### **–í–û–ü–†–û–° 30: –¢–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å iiko**

**–í–û–ü–†–û–°:** –í –∫–∞–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã –ø–ª–∞–≥–∏–Ω –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å iiko Front?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –¢–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∫–∞—Å—Å–∏—Ä –≤—Ä—É—á–Ω—É—é –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–ª–∞–≥–∏–Ω
- **B)** –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–ª–∞–≥–∏–Ω–∞ + —Å–æ–±—ã—Ç–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è —á–µ–∫–∞
- **C)** –û—Ç–∫—Ä—ã—Ç–∏–µ + –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ–∫–∞ + –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É–º–º—ã
- **D)** –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ –≤—Å–µ–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏ –∑–∞–∫–∞–∑–∞

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: B) –û—Ç–∫—Ä—ã—Ç–∏–µ + –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ–∫–∞**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ú–∏–Ω–∏–º—É–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ:** –î–≤–∞ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–∞ - –ø—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ **–ù–µ –º–µ—à–∞–µ—Ç —Ä–∞–±–æ—Ç–µ:** –ù–µ —Ä–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ú–µ–Ω—å—à–µ —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ = –º–µ–Ω—å—à–µ –±–∞–≥–æ–≤
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ù–µ –Ω–∞–≥—Ä—É–∂–∞–µ–º —Å–∏—Å—Ç–µ–º—É –ª–∏—à–Ω–∏–º–∏ event handlers

**–°–æ–±—ã—Ç–∏—è iiko SDK:**

```csharp
public class LoyaltyPlugin : IFrontPlugin
{
    private IOperationService operationService;
    private IViewManager viewManager;
    
    public void Dispose(IPluginResources resources)
    {
        operationService = resources.GetOperationService();
        viewManager = resources.GetViewManager();
        
        // 1. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤ UI iiko
        RegisterButton();
        
        // 2. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è
        SubscribeToEvents();
        
        logger.LogInformation("Max Loyalty plugin initialized");
    }
    
    private void RegisterButton()
    {
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–õ–æ—è–ª—å–Ω–æ—Å—Ç—å" –≤ UI –∫–∞—Å—Å—ã
        var button = viewManager.CreateButton(
            caption: "Max Loyalty",
            hotkey: Key.F9,
            callback: OnLoyaltyButtonClick
        );
        
        // –†–∞–∑–º–µ—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ toolbar
        viewManager.AddButtonToPaymentScreen(button);
        
        logger.LogInformation("Loyalty button registered in iiko UI");
    }
    
    private void SubscribeToEvents()
    {
        // –°–æ–±—ã—Ç–∏–µ: —á–µ–∫ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è (–ø–µ—Ä–µ–¥ –ø–µ—á–∞—Ç—å—é)
        operationService.BeforeOrderClose += OnBeforeOrderClose;
        
        // –°–æ–±—ã—Ç–∏–µ: —á–µ–∫ –∑–∞–∫—Ä—ã—Ç (–ø–æ—Å–ª–µ –ø–µ—á–∞—Ç–∏)
        operationService.AfterOrderClose += OnAfterOrderClose;
        
        // –°–æ–±—ã—Ç–∏–µ: —á–µ–∫ –æ—Ç–º–µ–Ω–µ–Ω
        operationService.OrderCancelled += OnOrderCancelled;
        
        logger.LogInformation("Subscribed to iiko events");
    }
    
    // ===== –°–û–ë–´–¢–ò–ï 1: –ö–∞—Å—Å–∏—Ä –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "Max Loyalty" =====
    private void OnLoyaltyButtonClick(IOrder order)
    {
        try
        {
            logger.LogInformation(
                "Loyalty button clicked: Order {OrderId}, Amount {Amount}",
                order.Id,
                order.GetSum()
            );
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–∫–∞–∑ –ø–æ–¥—Ö–æ–¥–∏—Ç
            if (!ValidateOrder(order))
            {
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–∞—Ä—Ç–∞ –µ—â–µ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞
            var existingContext = contextStorage.GetContext(order.Id.ToString());
            
            if (existingContext != null)
            {
                // –ö–∞—Ä—Ç–∞ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏
                OpenOperationWindow(order, existingContext);
            }
            else
            {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è
                OpenSearchWindow(order);
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error in loyalty button click handler");
            ErrorHandler.Handle(ex, "OnLoyaltyButtonClick");
        }
    }
    
    private bool ValidateOrder(IOrder order)
    {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ó–∞–∫–∞–∑ –Ω–µ –ø—É—Å—Ç–æ–π
        if (order.GetItems().Count == 0)
        {
            ShowError("–ó–∞–∫–∞–∑ –ø—É—Å—Ç–æ–π", "–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑");
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞
        var config = configService.GetRestaurantConfig();
        var orderSum = order.GetSum();
        
        if (orderSum < config.MinCheckAmount)
        {
            ShowError(
                "–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞ —Å–ª–∏—à–∫–æ–º –º–∞–ª–∞",
                $"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏: {config.MinCheckAmount:N0}‚ÇΩ\n" +
                $"–¢–µ–∫—É—â–∞—è —Å—É–º–º–∞: {orderSum:N0}‚ÇΩ"
            );
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ó–∞–∫–∞–∑ –µ—â–µ –Ω–µ –∑–∞–∫—Ä—ã—Ç
        if (order.Status == OrderStatus.Closed)
        {
            ShowError("–ó–∞–∫–∞–∑ —É–∂–µ –∑–∞–∫—Ä—ã—Ç", "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –∫ –∑–∞–∫—Ä—ã—Ç–æ–º—É –∑–∞–∫–∞–∑—É");
            return false;
        }
        
        return true;
    }
    
    private void OpenSearchWindow(IOrder order)
    {
        var window = new LoyaltySearchWindow(order);
        
        var result = window.ShowDialog();
        
        if (result == true && window.SelectedGuest != null)
        {
            // –ì–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏
            OpenOperationWindow(order, window.SelectedGuest);
        }
    }
    
    private void OpenOperationWindow(IOrder order, GuestInfo guest)
    {
        var window = new LoyaltyOperationWindow(order, guest);
        window.ShowDialog();
    }
    
    // ===== –°–û–ë–´–¢–ò–ï 2: –ß–µ–∫ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è (BeforeOrderClose) =====
    private void OnBeforeOrderClose(IOrder order, IPaymentTransaction payment)
    {
        try
        {
            logger.LogInformation(
                "Before order close: Order {OrderId}, Payment {PaymentType}",
                order.Id,
                payment.PaymentType
            );
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞
            var context = contextStorage.GetContext(order.Id.ToString());
            
            if (context == null)
            {
                // –ù–µ—Ç –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
                return;
            }
            
            logger.LogInformation(
                "Loyalty context found for order: Action={Action}, Guest={GuestId}",
                context.Action,
                context.GuestCardId
            );
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å—É–º–º—ã
            var finalSum = order.GetSum();
            
            if (context.Action == LoyaltyAction.Spend || context.Action == LoyaltyAction.SpendAndEarn)
            {
                // –ï—Å–ª–∏ —Å–ø–∏—Å—ã–≤–∞–ª–∏ –±–∞–ª–ª—ã - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–∏–º–µ–Ω–∏–ª–∏ —Å–∫–∏–¥–∫—É
                var expectedSum = context.OriginalCheckAmount - context.PointsSpent.Value;
                var tolerance = 1m; // 1 —Ä—É–±–ª—å —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å
                
                if (Math.Abs(finalSum - expectedSum) > tolerance)
                {
                    logger.LogWarning(
                        "Order sum mismatch: Expected {Expected}, Actual {Actual}",
                        expectedSum,
                        finalSum
                    );
                    
                    // –°–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞—Å—Å–∏—Ä–∞
                    var proceed = MessageBox.Show(
                        $"–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–ª–æ–≤.\n\n" +
                        $"–û–∂–∏–¥–∞–ª–∞—Å—å: {expectedSum:N2}‚ÇΩ\n" +
                        $"–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è: {finalSum:N2}‚ÇΩ\n\n" +
                        $"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ–∫–∞?",
                        "–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É–º–º—ã",
                        MessageBoxButton.YesNo,
                        MessageBoxImage.Question
                    );
                    
                    if (proceed != MessageBoxResult.Yes)
                    {
                        // –û—Ç–º–µ–Ω—è–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ–∫–∞
                        throw new PluginException("Order close cancelled by cashier");
                    }
                }
            }
            
            // –í—Å—ë –æ–∫, –¥–∞–µ–º –∑–∞–∫—Ä—ã—Ç—å —á–µ–∫
            // –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –≤ AfterOrderClose
        }
        catch (PluginException)
        {
            throw; // –ü—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º –¥–∞–ª—å—à–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã –∑–∞–∫—Ä—ã—Ç–∏—è
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error in BeforeOrderClose handler");
            // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ–∫–∞ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –≤ –ø–ª–∞–≥–∏–Ω–µ
        }
    }
    
    // ===== –°–û–ë–´–¢–ò–ï 3: –ß–µ–∫ –∑–∞–∫—Ä—ã—Ç (AfterOrderClose) =====
    private async void OnAfterOrderClose(IOrder order, IPaymentTransaction payment)
    {
        try
        {
            logger.LogInformation(
                "After order close: Order {OrderId}",
                order.Id
            );
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
            var context = contextStorage.GetContext(order.Id.ToString());
            
            if (context == null)
            {
                return;
            }
            
            // –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –Ω–∞ backend
            await FinalizeOrderAsync(context, order);
            
            // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            contextStorage.RemoveContext(order.Id.ToString());
            
            logger.LogInformation(
                "Order finalized successfully: Order {OrderId}, Guest {GuestId}",
                order.Id,
                context.GuestCardId
            );
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error in AfterOrderClose handler");
            
            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ offline queue
            TryEnqueueOffline(context, order);
        }
    }
    
    private async Task FinalizeOrderAsync(LoyaltyContext context, IOrder order)
    {
        var request = new FinalizePointsRequest
        {
            GuestCardId = context.GuestCardId,
            OrderId = context.OrderId,
            CheckAmount = order.GetSum(),
            Action = context.Action,
            PointsToEarn = context.PointsToEarn,
            PointsToSpend = context.PointsSpent,
            ReservationId = context.ReservationId,
            DiscountAmount = context.DiscountAmount
        };
        
        if (healthCheck.IsOnline())
        {
            // Online - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø—Ä—è–º—É—é
            await apiClient.FinalizePointsAsync(request);
        }
        else
        {
            // Offline - –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
            offlineQueue.EnqueueOperation(new OfflineOperation
            {
                Type = OperationType.FINALIZE_EARN_ONLY, // –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç offline
                GuestCardId = context.GuestCardId,
                OrderId = context.OrderId,
                CheckAmount = order.GetSum(),
                PointsToEarn = context.PointsToEarn,
                CashierName = GetCurrentCashierName(),
                RestaurantId = configService.GetRestaurantId()
            });
            
            logger.LogInformation(
                "Order finalization queued for offline processing: {OrderId}",
                order.Id
            );
        }
    }
    
    // ===== –°–û–ë–´–¢–ò–ï 4: –ß–µ–∫ –æ—Ç–º–µ–Ω–µ–Ω (OrderCancelled) =====
    private async void OnOrderCancelled(IOrder order, string reason)
    {
        try
        {
            logger.LogInformation(
                "Order cancelled: Order {OrderId}, Reason {Reason}",
                order.Id,
                reason
            );
            
            var context = contextStorage.GetContext(order.Id.ToString());
            
            if (context == null)
            {
                return;
            }
            
            // –ï—Å–ª–∏ –±—ã–ª–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è - –æ—Ç–º–µ–Ω—è–µ–º
            if (context.ReservationId != null)
            {
                await CancelReservationAsync(context);
            }
            
            // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            contextStorage.RemoveContext(order.Id.ToString());
            
            logger.LogInformation(
                "Loyalty context cleared for cancelled order: {OrderId}",
                order.Id
            );
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error in OrderCancelled handler");
        }
    }
    
    private async Task CancelReservationAsync(LoyaltyContext context)
    {
        try
        {
            await apiClient.CancelReservationAsync(new CancelReservationRequest
            {
                ReservationId = context.ReservationId,
                OrderId = context.OrderId,
                Reason = "ORDER_CANCELLED"
            });
            
            logger.LogInformation(
                "Reservation cancelled: {ReservationId}",
                context.ReservationId
            );
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to cancel reservation: {ReservationId}", context.ReservationId);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ offline queue
            offlineQueue.EnqueueOperation(new OfflineOperation
            {
                Type = OperationType.CANCEL_RESERVATION,
                OrderId = context.OrderId,
                // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
            });
        }
    }
}
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ 31-37 (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å iiko)?

---

### **–í–û–ü–†–û–° 31: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ –≤ iiko**

**–í–û–ü–†–û–°:** –ö–∞–∫ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É –æ—Ç –±–∞–ª–ª–æ–≤/—É—Ä–æ–≤–Ω—è –∫ —á–µ–∫—É –≤ iiko?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ API (AddDiscount)
- **B)** –í—Ä—É—á–Ω—É—é –∫–∞—Å—Å–∏—Ä –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å–∫–∏–¥–∫—É –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–ª–∞–≥–∏–Ω–∞
- **C)** –°–æ–∑–¥–∞–µ–º —Å–ø–µ—Ü—Ç–æ–≤–∞—Ä "–û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏" —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π —Ü–µ–Ω–æ–π
- **D)** –ò—Å–ø–æ–ª—å–∑—É–µ–º payment type "–ë–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏"

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –°–ø–µ—Ü—Ç–æ–≤–∞—Ä —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π —Ü–µ–Ω–æ–π**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å:** –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–π –≤–µ—Ä—Å–∏–∏ iiko
- ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:** –í–∏–¥–Ω–æ –≤ —á–µ–∫–µ —á—Ç–æ —Å–ø–∏—Å–∞–Ω—ã –±–∞–ª–ª—ã
- ‚úÖ **–£—á–µ—Ç:** –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å (—Å–∫–∏–¥–∫–∞ = —Ç–æ–≤–∞—Ä)
- ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å:** –ú–æ–∂–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–æ–∫

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ iiko:**

–ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–µ—Ç —Å–ø–µ—Ü—Ç–æ–≤–∞—Ä—ã –≤ iiko:

```
–¢–æ–≤–∞—Ä—ã –¥–ª—è –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏:
‚îú‚îÄ‚îÄ "–û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ Max Loyalty" (—Ü–µ–Ω–∞: 0, –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ü–µ–Ω—ã —Ä–∞–∑—Ä–µ—à–µ–Ω)
‚îÇ   ‚îî‚îÄ‚îÄ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –°–ª—É–∂–µ–±–Ω—ã–µ
‚îÇ   ‚îî‚îÄ‚îÄ –ê—Ä—Ç–∏–∫—É–ª: MAX_LOYALTY_POINTS
‚îÇ   ‚îî‚îÄ‚îÄ –ù–î–°: –ë–µ–∑ –ù–î–°
‚îÇ
‚îî‚îÄ‚îÄ "–°–∫–∏–¥–∫–∞ —É—Ä–æ–≤–Ω—è Max Loyalty" (—Ü–µ–Ω–∞: 0, –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ü–µ–Ω—ã —Ä–∞–∑—Ä–µ—à–µ–Ω)
    ‚îî‚îÄ‚îÄ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –°–ª—É–∂–µ–±–Ω—ã–µ
    ‚îî‚îÄ‚îÄ –ê—Ä—Ç–∏–∫—É–ª: MAX_LOYALTY_DISCOUNT
    ‚îî‚îÄ‚îÄ –ù–î–°: –ë–µ–∑ –ù–î–°
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ –ø–ª–∞–≥–∏–Ω–µ:**

```csharp
public class IikoIntegrationService
{
    private readonly IOperationService operationService;
    private readonly ILogger logger;
    
    // ID —Ç–æ–≤–∞—Ä–æ–≤ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ)
    private Guid pointsPaymentProductId;
    private Guid discountProductId;
    
    public IikoIntegrationService(IOperationService operationService)
    {
        this.operationService = operationService;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º ID –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        LoadProductIds();
    }
    
    private void LoadProductIds()
    {
        var config = configService.GetConfig();
        
        pointsPaymentProductId = Guid.Parse(config.IikoPointsProductId);
        discountProductId = Guid.Parse(config.IikoDiscountProductId);
        
        logger.LogInformation(
            "Loaded iiko product IDs: Points={PointsId}, Discount={DiscountId}",
            pointsPaymentProductId,
            discountProductId
        );
    }
    
    // ===== –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –°–ü–ò–°–ê–ù–ò–Ø –ë–ê–õ–õ–û–í =====
    public void ApplyPointsPayment(IOrder order, decimal pointsAmount)
    {
        try
        {
            logger.LogInformation(
                "Applying points payment: Order {OrderId}, Amount {Amount}",
                order.Id,
                pointsAmount
            );
            
            // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç –∏–∑ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã iiko
            var product = operationService.GetProductById(pointsPaymentProductId);
            
            if (product == null)
            {
                throw new InvalidOperationException(
                    $"Product not found in iiko: {pointsPaymentProductId}. " +
                    "Please configure loyalty products in iiko."
                );
            }
            
            // –°–æ–∑–¥–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –∑–∞–∫–∞–∑–µ —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π —Ü–µ–Ω–æ–π
            var orderItem = operationService.CreateOrderItem(
                product: product,
                quantity: 1,
                price: -pointsAmount, // –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–∞ = —Å–∫–∏–¥–∫–∞
                comment: $"–°–ø–∏—Å–∞–Ω–æ –±–∞–ª–ª–æ–≤: {pointsAmount:N0}"
            );
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∑–∞–∫–∞–∑
            order.AddItem(orderItem);
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º—É –∑–∞–∫–∞–∑–∞
            operationService.RecalculateOrder(order);
            
            logger.LogInformation(
                "Points payment applied: Order {OrderId}, New total: {Total}",
                order.Id,
                order.GetSum()
            );
            
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –∫–∞—Å—Å–∏—Ä–∞
            ShowNotification(
                "–ë–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã",
                $"–°–ø–∏—Å–∞–Ω–æ: {pointsAmount:N0} ‚ÇΩ\n" +
                $"–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: {order.GetSum():N2} ‚ÇΩ",
                NotificationType.Success
            );
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to apply points payment");
            throw new PluginException("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –∫ –∑–∞–∫–∞–∑—É", ex);
        }
    }
    
    // ===== –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –°–ö–ò–î–ö–ò –£–†–û–í–ù–Ø =====
    public void ApplyLevelDiscount(IOrder order, decimal discountAmount, int levelNumber)
    {
        try
        {
            logger.LogInformation(
                "Applying level discount: Order {OrderId}, Amount {Amount}, Level {Level}",
                order.Id,
                discountAmount,
                levelNumber
            );
            
            var product = operationService.GetProductById(discountProductId);
            
            if (product == null)
            {
                throw new InvalidOperationException(
                    $"Discount product not found in iiko: {discountProductId}"
                );
            }
            
            var orderItem = operationService.CreateOrderItem(
                product: product,
                quantity: 1,
                price: -discountAmount,
                comment: $"–°–∫–∏–¥–∫–∞ —É—Ä–æ–≤–Ω—è {levelNumber}"
            );
            
            order.AddItem(orderItem);
            operationService.RecalculateOrder(order);
            
            logger.LogInformation(
                "Level discount applied: Order {OrderId}, New total: {Total}",
                order.Id,
                order.GetSum()
            );
            
            ShowNotification(
                "–°–∫–∏–¥–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞",
                $"–°–∫–∏–¥–∫–∞ —É—Ä–æ–≤–Ω—è {levelNumber}: -{discountAmount:N2} ‚ÇΩ\n" +
                $"–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: {order.GetSum():N2} ‚ÇΩ",
                NotificationType.Success
            );
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to apply level discount");
            throw new PluginException("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É –∫ –∑–∞–∫–∞–∑—É", ex);
        }
    }
    
    // ===== –û–¢–ú–ï–ù–ê –°–ö–ò–î–ö–ò (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) =====
    public void RemoveLoyaltyDiscount(IOrder order)
    {
        try
        {
            logger.LogInformation("Removing loyalty discount from order {OrderId}", order.Id);
            
            // –ù–∞—Ö–æ–¥–∏–º –Ω–∞—à–∏ —Ç–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ
            var loyaltyItems = order.GetItems()
                .Where(item => 
                    item.Product.Id == pointsPaymentProductId ||
                    item.Product.Id == discountProductId
                )
                .ToList();
            
            if (!loyaltyItems.Any())
            {
                logger.LogWarning("No loyalty items found in order {OrderId}", order.Id);
                return;
            }
            
            // –£–¥–∞–ª—è–µ–º
            foreach (var item in loyaltyItems)
            {
                order.RemoveItem(item);
                logger.LogDebug("Removed loyalty item: {ProductName}", item.Product.Name);
            }
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º
            operationService.RecalculateOrder(order);
            
            logger.LogInformation(
                "Loyalty discount removed: Order {OrderId}, New total: {Total}",
                order.Id,
                order.GetSum()
            );
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to remove loyalty discount");
            throw;
        }
    }
    
    // ===== –ü–†–û–í–ï–†–ö–ê –ß–¢–û –°–ö–ò–î–ö–ê –£–ñ–ï –ü–†–ò–ú–ï–ù–ï–ù–ê =====
    public bool HasLoyaltyDiscount(IOrder order)
    {
        return order.GetItems().Any(item =>
            item.Product.Id == pointsPaymentProductId ||
            item.Product.Id == discountProductId
        );
    }
    
    // ===== –ü–û–õ–£–ß–ï–ù–ò–ï –°–£–ú–ú–´ –°–ö–ò–î–ö–ò =====
    public decimal GetAppliedDiscountAmount(IOrder order)
    {
        var loyaltyItems = order.GetItems()
            .Where(item => 
                item.Product.Id == pointsPaymentProductId ||
                item.Product.Id == discountProductId
            );
        
        // –°—É–º–º–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–Ω = —Ä–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏
        return Math.Abs(loyaltyItems.Sum(item => item.GetSum()));
    }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ LoyaltyOperationWindow:**

```csharp
public partial class LoyaltyOperationWindow : LoyaltyWindowBase
{
    private IikoIntegrationService iikoService;
    
    private async void OnSpendClick(object sender, RoutedEventArgs e)
    {
        try
        {
            var pointsToSpend = decimal.Parse(PointsInput.Text);
            
            // 1. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –Ω–∞ backend
            LoadingOverlay.Show("–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤...");
            
            var reservation = await apiClient.ReservePointsAsync(new ReserveRequest
            {
                GuestCardId = currentGuest.CardId,
                PointsToSpend = pointsToSpend,
                CheckAmount = currentOrder.GetSum(),
                OrderId = currentOrder.Id.ToString()
            });
            
            if (!reservation.Success)
            {
                LoadingOverlay.Hide();
                ShowError(reservation.Error);
                return;
            }
            
            // 2. –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É –≤ iiko
            LoadingOverlay.UpdateStatus("–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ –∫ –∑–∞–∫–∞–∑—É...");
            
            iikoService.ApplyPointsPayment(currentOrder, pointsToSpend);
            
            LoadingOverlay.Hide();
            
            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            SaveOrderContext(new LoyaltyContext
            {
                GuestCardId = currentGuest.CardId,
                GuestName = currentGuest.Name,
                OrderId = currentOrder.Id.ToString(),
                BenefitType = BenefitType.Points,
                Action = LoyaltyAction.Spend,
                PointsSpent = pointsToSpend,
                ReservationId = reservation.ReservationId,
                OriginalCheckAmount = currentOrder.GetSum() + pointsToSpend, // –°—É–º–º–∞ –¥–æ —Å–∫–∏–¥–∫–∏
                PointsToEarn = reservation.PointsToEarn
            });
            
            // 4. –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
            DialogResult = true;
            Close();
            
            logger.LogInformation(
                "Points payment applied successfully: Order {OrderId}, Points {Points}",
                currentOrder.Id,
                pointsToSpend
            );
        }
        catch (Exception ex)
        {
            LoadingOverlay.Hide();
            ErrorHandler.Handle(ex, "ApplyPointsPayment");
        }
    }
    
    private async void OnApplyDiscountClick(object sender, RoutedEventArgs e)
    {
        try
        {
            var discountAmount = currentCalculation.DiscountAmount;
            
            // 1. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º —Å–∫–∏–¥–∫—É –Ω–∞ backend
            LoadingOverlay.Show("–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–∏–¥–∫–∏...");
            
            var reservation = await apiClient.ReserveDiscountAsync(new ReserveDiscountRequest
            {
                GuestCardId = currentGuest.CardId,
                DiscountAmount = discountAmount,
                CheckAmount = currentOrder.GetSum(),
                OrderId = currentOrder.Id.ToString()
            });
            
            if (!reservation.Success)
            {
                LoadingOverlay.Hide();
                ShowError(reservation.Error);
                return;
            }
            
            // 2. –ü—Ä–∏–º–µ–Ω—è–µ–º –≤ iiko
            LoadingOverlay.UpdateStatus("–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ –∫ –∑–∞–∫–∞–∑—É...");
            
            iikoService.ApplyLevelDiscount(
                currentOrder, 
                discountAmount,
                currentGuest.Level.Number
            );
            
            LoadingOverlay.Hide();
            
            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            SaveOrderContext(new LoyaltyContext
            {
                GuestCardId = currentGuest.CardId,
                GuestName = currentGuest.Name,
                OrderId = currentOrder.Id.ToString(),
                BenefitType = BenefitType.Discount,
                Action = LoyaltyAction.ApplyDiscount,
                DiscountAmount = discountAmount,
                DiscountPercentage = currentGuest.Level.DiscountPercentage,
                ReservationId = reservation.ReservationId,
                OriginalCheckAmount = currentOrder.GetSum() + discountAmount,
                PointsToEarn = reservation.PointsToEarn
            });
            
            DialogResult = true;
            Close();
        }
        catch (Exception ex)
        {
            LoadingOverlay.Hide();
            ErrorHandler.Handle(ex, "ApplyDiscount");
        }
    }
}
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ (–µ—Å–ª–∏ iiko –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç):**

–ï—Å–ª–∏ –≤ –≤–µ—Ä—Å–∏–∏ iiko –¥–æ—Å—Ç—É–ø–µ–Ω API —Å–∫–∏–¥–æ–∫:

```csharp
// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ native —Å–∫–∏–¥–æ–∫ iiko
public void ApplyPointsPaymentAsDiscount(IOrder order, decimal pointsAmount)
{
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—É—é –∏–ª–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–∫–∏–¥–∫—É
    var discount = operationService.CreateDiscount(
        name: "–û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ Max Loyalty",
        type: DiscountType.FixedSum,
        value: pointsAmount,
        comment: $"–°–ø–∏—Å–∞–Ω–æ –±–∞–ª–ª–æ–≤: {pointsAmount:N0}"
    );
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ –∑–∞–∫–∞–∑—É
    order.ApplyDiscount(discount);
    
    operationService.RecalculateOrder(order);
}
```


***

### **–í–û–ü–†–û–° 32: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ**

**–í–û–ü–†–û–°:** –ö–∞–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –∏–∑ iiko?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –¢–æ–ª—å–∫–æ —Å—É–º–º—É –∑–∞–∫–∞–∑–∞
- **B)** –°—É–º–º–∞ + —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
- **C)** –°—É–º–º–∞ + —Ç–æ–≤–∞—Ä—ã + —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã
- **D)** –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ç–æ–≤–∞—Ä—ã, –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã, —Å–∫–∏–¥–∫–∏, –≥–æ—Å—Ç—å)

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: B) –°—É–º–º–∞ + —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ:** –î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤ –Ω—É–∂–Ω–∞ —Å—É–º–º–∞ –∏ —Å–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º API
- ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å:** –ú–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- ‚ùå **–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:** –£–∑–Ω–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —á–µ–∫–∞ (—Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class OrderInfoProvider
{
    private readonly IOperationService operationService;
    
    public OrderInfo GetOrderInfo(IOrder order)
    {
        try
        {
            var info = new OrderInfo
            {
                Id = order.Id.ToString(),
                Number = order.Number,
                TotalAmount = order.GetSum(),
                OriginalAmount = GetOriginalAmount(order),
                ItemsCount = order.GetItems().Count,
                Items = GetOrderItems(order),
                Guest = GetOrderGuest(order),
                OpenedAt = order.OpenTime,
                Waiter = GetWaiterName(order),
                Table = GetTableName(order)
            };
            
            return info;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to get order info");
            throw;
        }
    }
    
    private decimal GetOriginalAmount(IOrder order)
    {
        // –°—É–º–º–∞ –±–µ–∑ —É—á–µ—Ç–∞ –Ω–∞—à–∏—Ö —Å–∫–∏–¥–æ–∫
        var totalSum = order.GetSum();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞—à–∏ —Å–∫–∏–¥–∫–∏ –µ—Å–ª–∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
        var loyaltyDiscount = order.GetItems()
            .Where(item => 
                item.Product.Id == pointsPaymentProductId ||
                item.Product.Id == discountProductId
            )
            .Sum(item => Math.Abs(item.GetSum()));
        
        return totalSum + loyaltyDiscount;
    }
    
    private List<OrderItemInfo> GetOrderItems(IOrder order)
    {
        var items = new List<OrderItemInfo>();
        
        foreach (var item in order.GetItems())
        {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–∞—à–∏ —Å–ª—É–∂–µ–±–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
            if (item.Product.Id == pointsPaymentProductId || 
                item.Product.Id == discountProductId)
            {
                continue;
            }
            
            var itemInfo = new OrderItemInfo
            {
                Id = item.Id.ToString(),
                Name = item.Product.Name,
                Category = item.Product.Category?.Name,
                Quantity = item.Quantity,
                Price = item.Price,
                Sum = item.GetSum(),
                Modifiers = GetModifiers(item)
            };
            
            items.Add(itemInfo);
        }
        
        return items;
    }
    
    private List<ModifierInfo> GetModifiers(IOrderItem item)
    {
        var modifiers = new List<ModifierInfo>();
        
        foreach (var modifier in item.GetModifiers())
        {
            modifiers.Add(new ModifierInfo
            {
                Name = modifier.Product.Name,
                Quantity = modifier.Quantity,
                Price = modifier.Price
            });
        }
        
        return modifiers;
    }
    
    private GuestInfo GetOrderGuest(IOrder order)
    {
        // –í iiko –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–≤—è–∑–∞–Ω –≥–æ—Å—Ç—å
        var iikoGuest = order.GetGuest();
        
        if (iikoGuest == null)
            return null;
        
        return new GuestInfo
        {
            Name = iikoGuest.Name,
            Phone = iikoGuest.Phone,
            // –≠—Ç–æ –≥–æ—Å—Ç—å –∏–∑ iiko, –Ω–µ –∏–∑ –Ω–∞—à–µ–π —Å–∏—Å—Ç–µ–º—ã
            IsIikoGuest = true
        };
    }
    
    private string GetWaiterName(IOrder order)
    {
        try
        {
            var waiter = order.GetWaiter();
            return waiter?.Name ?? "–ù–µ —É–∫–∞–∑–∞–Ω";
        }
        catch
        {
            return "–ù–µ —É–∫–∞–∑–∞–Ω";
        }
    }
    
    private string GetTableName(IOrder order)
    {
        try
        {
            var table = order.GetTable();
            return table?.Name ?? order.GetSection()?.Name ?? "–ù–µ —É–∫–∞–∑–∞–Ω";
        }
        catch
        {
            return "–ù–µ —É–∫–∞–∑–∞–Ω";
        }
    }
}

public class OrderInfo
{
    public string Id { get; set; }
    public int Number { get; set; }
    public decimal TotalAmount { get; set; }
    public decimal OriginalAmount { get; set; }
    public int ItemsCount { get; set; }
    public List<OrderItemInfo> Items { get; set; }
    public GuestInfo Guest { get; set; }
    public DateTime OpenedAt { get; set; }
    public string Waiter { get; set; }
    public string Table { get; set; }
}

public class OrderItemInfo
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string Category { get; set; }
    public decimal Quantity { get; set; }
    public decimal Price { get; set; }
    public decimal Sum { get; set; }
    public List<ModifierInfo> Modifiers { get; set; }
}

public class ModifierInfo
{
    public string Name { get; set; }
    public decimal Quantity { get; set; }
    public decimal Price { get; set; }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```csharp
private async void OnLoyaltyButtonClick(IOrder order)
{
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ
    var orderInfo = orderInfoProvider.GetOrderInfo(order);
    
    logger.LogInformation(
        "Order info: Number={Number}, Total={Total}, Items={ItemsCount}",
        orderInfo.Number,
        orderInfo.TotalAmount,
        orderInfo.ItemsCount
    );
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É
    var config = configService.GetRestaurantConfig();
    
    if (orderInfo.OriginalAmount < config.MinCheckAmount)
    {
        ShowError(
            "–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞ —Å–ª–∏—à–∫–æ–º –º–∞–ª–∞",
            $"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: {config.MinCheckAmount:N0}‚ÇΩ\n" +
            $"–¢–µ–∫—É—â–∞—è —Å—É–º–º–∞: {orderInfo.OriginalAmount:N0}‚ÇΩ"
        );
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)
    if (HasExcludedCategories(orderInfo))
    {
        var proceed = MessageBox.Show(
            "–í –∑–∞–∫–∞–∑–µ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã –∏–∑ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.\n" +
            "–ë–∞–ª–ª—ã –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã.\n\n" +
            "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?",
            "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ",
            MessageBoxButton.YesNo,
            MessageBoxImage.Question
        );
        
        if (proceed != MessageBoxResult.Yes)
            return;
    }
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞
    OpenSearchWindow(order, orderInfo);
}

private bool HasExcludedCategories(OrderInfo orderInfo)
{
    var config = configService.GetRestaurantConfig();
    
    if (config.ExcludedCategories == null || !config.ExcludedCategories.Any())
        return false;
    
    return orderInfo.Items.Any(item =>
        config.ExcludedCategories.Contains(item.Category, StringComparer.OrdinalIgnoreCase)
    );
}
```


***

### **–í–û–ü–†–û–° 33: –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–∞–∫–∞–∑–∞**

**–í–û–ü–†–û–°:** –ö–∞–∫ —Ö—Ä–∞–Ω–∏—Ç—å —Å–≤—è–∑—å –º–µ–∂–¥—É –∑–∞–∫–∞–∑–æ–º iiko –∏ –æ–ø–µ—Ä–∞—Ü–∏–µ–π –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –í –ø–∞–º—è—Ç–∏ –ø–ª–∞–≥–∏–Ω–∞ (Dictionary<OrderId, Context>)
- **B)** –í –ø–∞–º—è—Ç–∏ + backup –Ω–∞ –¥–∏—Å–∫
- **C)** –í properties –∑–∞–∫–∞–∑–∞ iiko (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
- **D)** –í –æ—Ç–¥–µ–ª—å–Ω–æ–º SQLite

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: B) –í –ø–∞–º—è—Ç–∏ + backup –Ω–∞ –¥–∏—Å–∫**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ë—ã—Å—Ç—Ä–æ:** –î–æ—Å—Ç—É–ø –∏–∑ –ø–∞–º—è—Ç–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ:** Backup –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –∫—Ä–∞—à–∞ –ø–ª–∞–≥–∏–Ω–∞
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ:** –ù–µ –Ω—É–∂–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **–ò–∑–æ–ª—è—Ü–∏—è:** –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç iiko

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class LoyaltyContextStorage
{
    private readonly ConcurrentDictionary<string, LoyaltyContext> contexts;
    private readonly string backupFilePath;
    private readonly ILogger logger;
    private readonly object lockObject = new object();
    
    public LoyaltyContextStorage()
    {
        contexts = new ConcurrentDictionary<string, LoyaltyContext>();
        
        var appDataPath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "MaxLoyaltyIiko"
        );
        
        Directory.CreateDirectory(appDataPath);
        backupFilePath = Path.Combine(appDataPath, "order-contexts.json");
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ backup –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        LoadFromBackup();
        
        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        StartAutoSave();
    }
    
    public void SaveContext(LoyaltyContext context)
    {
        contexts.AddOrUpdate(
            context.OrderId,
            context,
            (key, oldValue) => context
        );
        
        logger.LogInformation(
            "Context saved: Order {OrderId}, Guest {GuestId}, Action {Action}",
            context.OrderId,
            context.GuestCardId,
            context.Action
        );
        
        // –°—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ –¥–∏—Å–∫
        SaveToBackup();
    }
    
    public LoyaltyContext GetContext(string orderId)
    {
        contexts.TryGetValue(orderId, out var context);
        return context;
    }
    
    public void RemoveContext(string orderId)
    {
        if (contexts.TryRemove(orderId, out var removed))
        {
            logger.LogInformation(
                "Context removed: Order {OrderId}",
                orderId
            );
            
            SaveToBackup();
        }
    }
    
    public List<LoyaltyContext> GetAllContexts()
    {
        return contexts.Values.ToList();
    }
    
    public int GetCount()
    {
        return contexts.Count;
    }
    
    private void LoadFromBackup()
    {
        try
        {
            if (!File.Exists(backupFilePath))
            {
                logger.LogInformation("No context backup found");
                return;
            }
            
            var json = File.ReadAllText(backupFilePath);
            var loadedContexts = JsonConvert.DeserializeObject<List<LoyaltyContext>>(json);
            
            if (loadedContexts == null || !loadedContexts.Any())
            {
                logger.LogInformation("Context backup is empty");
                return;
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã (> 24 —á–∞—Å–æ–≤)
            var cutoff = DateTime.UtcNow.AddHours(-24);
            var validContexts = loadedContexts
                .Where(ctx => ctx.CreatedAt > cutoff)
                .ToList();
            
            foreach (var ctx in validContexts)
            {
                contexts.TryAdd(ctx.OrderId, ctx);
            }
            
            logger.LogInformation(
                "Loaded {Count} contexts from backup ({Total} total, {Expired} expired)",
                validContexts.Count,
                loadedContexts.Count,
                loadedContexts.Count - validContexts.Count
            );
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to load context backup");
        }
    }
    
    private void SaveToBackup()
    {
        lock (lockObject)
        {
            try
            {
                var contextList = contexts.Values.ToList();
                var json = JsonConvert.SerializeObject(contextList, Formatting.Indented);
                
                // –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å
                var tempPath = backupFilePath + ".tmp";
                File.WriteAllText(tempPath, json);
                File.Move(tempPath, backupFilePath, overwrite: true);
                
                logger.LogDebug("Context backup saved: {Count} contexts", contextList.Count);
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "Failed to save context backup");
            }
        }
    }
    
    private void StartAutoSave()
    {
        var timer = new Timer(
            callback: _ => SaveToBackup(),
            state: null,
            dueTime: TimeSpan.FromSeconds(30),
            period: TimeSpan.FromSeconds(30)
        );
    }
    
    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
    public void CleanupOldContexts()
    {
        var cutoff = DateTime.UtcNow.AddHours(-24);
        
        var oldContexts = contexts
            .Where(kvp => kvp.Value.CreatedAt < cutoff)
            .Select(kvp => kvp.Key)
            .ToList();
        
        foreach (var orderId in oldContexts)
        {
            contexts.TryRemove(orderId, out _);
            
            logger.LogWarning(
                "Removed old context: Order {OrderId}",
                orderId
            );
        }
        
        if (oldContexts.Any())
        {
            SaveToBackup();
            
            logger.LogInformation(
                "Cleaned up {Count} old contexts",
                oldContexts.Count
            );
        }
    }
}

public class LoyaltyContext
{
    public string OrderId { get; set; }
    public string GuestCardId { get; set; }
    public string GuestName { get; set; }
    public BenefitType BenefitType { get; set; }
    public LoyaltyAction Action { get; set; }
    
    // –î–ª—è –±–∞–ª–ª–æ–≤
    public decimal? PointsSpent { get; set; }
    public decimal? PointsToEarn { get; set; }
    
    // –î–ª—è —Å–∫–∏–¥–∫–∏
    public decimal? DiscountAmount { get; set; }
    public decimal? DiscountPercentage { get; set; }
    
    // –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è
    public string ReservationId { get; set; }
    
    // –°—É–º–º—ã
    public decimal OriginalCheckAmount { get; set; }
    
    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public bool IsOffline { get; set; }
}

public enum LoyaltyAction
{
    EarnOnly,        // –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
    Spend,           // –¢–æ–ª—å–∫–æ —Å–ø–∏—Å–∞–Ω–∏–µ
    SpendAndEarn,    // –°–ø–∏—Å–∞–Ω–∏–µ + –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
    ApplyDiscount    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ —É—Ä–æ–≤–Ω—è
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```csharp
// –ü—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
private void SaveOrderContext(LoyaltyContext context)
{
    contextStorage.SaveContext(context);
    
    logger.LogInformation(
        "Order context saved: {OrderId} -> {GuestId}",
        context.OrderId,
        context.GuestCardId
    );
}

// –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ–∫–∞
private async void OnAfterOrderClose(IOrder order, IPaymentTransaction payment)
{
    var context = contextStorage.GetContext(order.Id.ToString());
    
    if (context != null)
    {
        await FinalizeOrderAsync(context, order);
        contextStorage.RemoveContext(order.Id.ToString());
    }
}

// –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞
private async void OnOrderCancelled(IOrder order, string reason)
{
    var context = contextStorage.GetContext(order.Id.ToString());
    
    if (context != null)
    {
        if (context.ReservationId != null)
        {
            await CancelReservationAsync(context);
        }
        
        contextStorage.RemoveContext(order.Id.ToString());
    }
}
```


***

### **–í–û–ü–†–û–° 34: –ö–Ω–æ–ø–∫–∞ –≤ UI iiko**

**–í–û–ü–†–û–°:** –ì–¥–µ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –∫–Ω–æ–ø–∫—É –ø–ª–∞–≥–∏–Ω–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ iiko?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –í –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
- **B)** –ù–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã
- **C)** –ù–∞ —ç–∫—Ä–∞–Ω–µ –∑–∞–∫–∞–∑–∞ + —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã
- **D)** –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –≠–∫—Ä–∞–Ω –∑–∞–∫–∞–∑–∞ + —ç–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–£–¥–æ–±—Å—Ç–≤–æ:** –î–æ—Å—Ç—É–ø–Ω–∞ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç —Ä–∞–±–æ—Ç—ã —Å –∑–∞–∫–∞–∑–æ–º
- ‚úÖ **–ó–∞–º–µ—Ç–Ω–æ—Å—Ç—å:** –ö–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–∞
- ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å:** –ú–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –¥–æ –∏–ª–∏ –≤–æ –≤—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã
- ‚úÖ **–°—Ç–∞–Ω–¥–∞—Ä—Ç:** –¢–∞–∫ —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è –¥—Ä—É–≥–∏–µ –ø–ª–∞–≥–∏–Ω—ã iiko

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class LoyaltyPlugin : IFrontPlugin
{
    private IViewManager viewManager;
    private IButton orderScreenButton;
    private IButton paymentScreenButton;
    
    public void Dispose(IPluginResources resources)
    {
        viewManager = resources.GetViewManager();
        
        RegisterButtons();
    }
    
    private void RegisterButtons()
    {
        try
        {
            // –ö–Ω–æ–ø–∫–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∑–∞–∫–∞–∑–∞
            orderScreenButton = viewManager.CreateButton(
                caption: "Max Loyalty",
                hotkey: Key.F9,
                callback: OnLoyaltyButtonClick,
                icon: LoadPluginIcon()
            );
            
            // –†–∞–∑–º–µ—â–∞–µ–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∑–∞–∫–∞–∑–∞
            viewManager.AddButtonToOrderScreen(
                button: orderScreenButton,
                position: ButtonPosition.Right // –°–ø—Ä–∞–≤–∞ –≤ toolbar
            );
            
            logger.LogInformation("Button added to order screen");
            
            // –ö–Ω–æ–ø–∫–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã
            paymentScreenButton = viewManager.CreateButton(
                caption: "Max Loyalty",
                hotkey: Key.F9,
                callback: OnLoyaltyButtonClick,
                icon: LoadPluginIcon()
            );
            
            // –†–∞–∑–º–µ—â–∞–µ–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã
            viewManager.AddButtonToPaymentScreen(
                button: paymentScreenButton,
                position: ButtonPosition.Top // –°–≤–µ—Ä—Ö—É
            );
            
            logger.LogInformation("Button added to payment screen");
            
            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            // –ë—É–¥–µ–º –º–µ–Ω—è—Ç—å —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –∫–∞—Ä—Ç–∞ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞
            operationService.OrderChanged += UpdateButtonState;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to register plugin buttons");
            throw;
        }
    }
    
    private Image LoadPluginIcon()
    {
        try
        {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∫–æ–Ω–∫—É –∏–∑ —Ä–µ—Å—É—Ä—Å–æ–≤
            var iconStream = Assembly.GetExecutingAssembly()
                .GetManifestResourceStream("MaxLoyaltyIiko.Resources.logo.png");
            
            if (iconStream == null)
            {
                logger.LogWarning("Plugin icon not found, using default");
                return null;
            }
            
            var bitmap = new BitmapImage();
            bitmap.BeginInit();
            bitmap.StreamSource = iconStream;
            bitmap.CacheOption = BitmapCacheOption.OnLoad;
            bitmap.EndInit();
            
            return new Image
            {
                Source = bitmap,
                Width = 24,
                Height = 24
            };
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to load plugin icon");
            return null;
        }
    }
    
    private void UpdateButtonState(IOrder order)
    {
        try
        {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
            var context = contextStorage.GetContext(order.Id.ToString());
            
            if (context != null)
            {
                // –ö–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ - –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                var guestName = context.GuestName;
                var shortName = guestName.Length > 15 
                    ? guestName.Substring(0, 12) + "..." 
                    : guestName;
                
                orderScreenButton.SetCaption($"üí≥ {shortName}");
                paymentScreenButton.SetCaption($"üí≥ {shortName}");
                
                // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –Ω–∞ –∑–µ–ª–µ–Ω—ã–π (–µ—Å–ª–∏ API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
                orderScreenButton.SetColor(Colors.LightGreen);
                paymentScreenButton.SetColor(Colors.LightGreen);
            }
            else
            {
                // –ù–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏ - –æ–±—ã—á–Ω—ã–π –≤–∏–¥
                orderScreenButton.SetCaption("Max Loyalty");
                paymentScreenButton.SetCaption("Max Loyalty");
                
                orderScreenButton.SetColor(Colors.Transparent);
                paymentScreenButton.SetColor(Colors.Transparent);
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to update button state");
        }
    }
    
    private void OnLoyaltyButtonClick(IOrder order)
    {
        try
        {
            logger.LogInformation(
                "Loyalty button clicked: Order {OrderId}",
                order.Id
            );
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            var context = contextStorage.GetContext(order.Id.ToString());
            
            if (context != null)
            {
                // –ö–∞—Ä—Ç–∞ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π
                ShowContextMenu(order, context);
            }
            else
            {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è
                OpenSearchWindow(order);
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error in button click handler");
            ErrorHandler.Handle(ex, "OnLoyaltyButtonClick");
        }
    }
    
    private void ShowContextMenu(IOrder order, LoyaltyContext context)
    {
        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Å –æ–ø—Ü–∏—è–º–∏
        var menu = new ContextMenu();
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–µ
        var infoItem = new MenuItem
        {
            Header = $"–ü—Ä–∏–≤—è–∑–∞–Ω–∞ –∫–∞—Ä—Ç–∞: {context.GuestName}",
            IsEnabled = false,
            FontWeight = FontWeights.Bold
        };
        menu.Items.Add(infoItem);
        
        menu.Items.Add(new Separator());
        
        // –ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
        var changeItem = new MenuItem
        {
            Header = "–ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é"
        };
        changeItem.Click += (s, e) => OpenOperationWindow(order, context);
        menu.Items.Add(changeItem);
        
        // –û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É
        var unbindItem = new MenuItem
        {
            Header = "–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É",
            Foreground = Brushes.Red
        };
        unbindItem.Click += (s, e) => UnbindCard(order, context);
        menu.Items.Add(unbindItem);
        
        menu.IsOpen = true;
    }
    
    private async void UnbindCard(IOrder order, LoyaltyContext context)
    {
        var result = MessageBox.Show(
            $"–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É –≥–æ—Å—Ç—è {context.GuestName}?\n\n" +
            "–ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ —Å–∫–∏–¥–∫–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.",
            "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
            MessageBoxButton.YesNo,
            MessageBoxImage.Question
        );
        
        if (result != MessageBoxResult.Yes)
            return;
        
        try
        {
            // –£–¥–∞–ª—è–µ–º —Å–∫–∏–¥–∫—É –∏–∑ –∑–∞–∫–∞–∑–∞
            iikoService.RemoveLoyaltyDiscount(order);
            
            // –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é
            if (context.ReservationId != null)
            {
                await apiClient.CancelReservationAsync(new CancelReservationRequest
                {
                    ReservationId = context.ReservationId,
                    OrderId = context.OrderId,
                    Reason = "UNBOUND_BY_CASHIER"
                });
            }
            
            // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            contextStorage.RemoveContext(context.OrderId);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
            UpdateButtonState(order);
            
            ShowNotification(
                "–ö–∞—Ä—Ç–∞ –æ—Ç–≤—è–∑–∞–Ω–∞",
                $"–ö–∞—Ä—Ç–∞ –≥–æ—Å—Ç—è {context.GuestName} –æ—Ç–≤—è–∑–∞–Ω–∞ –æ—Ç –∑–∞–∫–∞–∑–∞",
                NotificationType.Success
            );
            
            logger.LogInformation(
                "Card unbound: Order {OrderId}, Guest {GuestId}",
                context.OrderId,
                context.GuestCardId
            );
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to unbind card");
            ErrorHandler.Handle(ex, "UnbindCard");
        }
    }
}
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ 35-37 (–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–ª–æ–∫–∞ iiko) –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ –±–ª–æ–∫—É 6 (–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)?

---

### **–í–û–ü–†–û–° 35: –í–µ—Ä—Å–∏–∏ –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å iiko**

**–í–û–ü–†–û–°:** –ö–∞–∫ –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–ª–∞–≥–∏–Ω–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ iiko Front?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é iiko
- **B)** –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ, –±–ª–æ–∫–∏—Ä—É–µ–º –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ
- **C)** –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Ä—Å–∏–∏
- **D)** –û—Ç–¥–µ–ª—å–Ω—ã–µ –±–∏–ª–¥—ã –ø–ª–∞–≥–∏–Ω–∞ –ø–æ–¥ –∫–∞–∂–¥—É—é –≤–µ—Ä—Å–∏—é iiko

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ + –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å:** –û–¥–∏–Ω –ø–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏—è—Ö
- ‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞:** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏
- ‚úÖ **–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ:** –ù–µ –Ω—É–∂–Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –±–∏–ª–¥–æ–≤

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class IikoVersionManager
{
    private readonly IPluginResources resources;
    private readonly ILogger logger;
    
    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –≤–µ—Ä—Å–∏—è iiko Front
    private static readonly Version MIN_SUPPORTED_VERSION = new Version(7, 5, 0);
    
    // –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è iiko
    private Version currentVersion;
    
    // –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
    private IikoCapabilities capabilities;
    
    public IikoVersionManager(IPluginResources resources)
    {
        this.resources = resources;
        
        // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Ä—Å–∏—é iiko
        DetectVersion();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
        CheckCompatibility();
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
        DetectCapabilities();
    }
    
    private void DetectVersion()
    {
        try
        {
            var versionString = resources.GetApiVersion();
            currentVersion = Version.Parse(versionString);
            
            logger.LogInformation(
                "Detected iiko Front version: {Version}",
                currentVersion
            );
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to detect iiko version");
            
            // –°—á–∏—Ç–∞–µ–º —á—Ç–æ —ç—Ç–æ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è
            currentVersion = new Version(7, 0, 0);
        }
    }
    
    private void CheckCompatibility()
    {
        if (currentVersion < MIN_SUPPORTED_VERSION)
        {
            var message = 
                $"‚ö†Ô∏è –ù–ï–°–û–í–ú–ï–°–¢–ò–ú–ê–Ø –í–ï–†–°–ò–Ø iiko Front\n\n" +
                $"–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: {currentVersion}\n" +
                $"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è: {MIN_SUPPORTED_VERSION}\n\n" +
                $"–ü–ª–∞–≥–∏–Ω Max Loyalty –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏.\n" +
                $"–û–±–Ω–æ–≤–∏—Ç–µ iiko Front –¥–æ –≤–µ—Ä—Å–∏–∏ {MIN_SUPPORTED_VERSION} –∏–ª–∏ –Ω–æ–≤–µ–µ.";
            
            logger.LogCritical(
                "Incompatible iiko version: {Current} < {Required}",
                currentVersion,
                MIN_SUPPORTED_VERSION
            );
            
            MessageBox.Show(
                message,
                "Max Loyalty - –û—à–∏–±–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
            
            throw new InvalidOperationException(
                $"iiko Front version {currentVersion} is not supported. " +
                $"Minimum required: {MIN_SUPPORTED_VERSION}"
            );
        }
        
        logger.LogInformation("iiko version compatibility check passed");
    }
    
    private void DetectCapabilities()
    {
        capabilities = new IikoCapabilities();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã—Ö API
        
        // 1. Native —Å–∫–∏–¥–∫–∏ (–¥–æ—Å—Ç—É–ø–Ω—ã —Å –≤–µ—Ä—Å–∏–∏ 7.6+)
        capabilities.SupportsNativeDiscounts = currentVersion >= new Version(7, 6, 0);
        
        // 2. Custom properties –∑–∞–∫–∞–∑–∞ (–¥–æ—Å—Ç—É–ø–Ω—ã —Å –≤–µ—Ä—Å–∏–∏ 7.7+)
        capabilities.SupportsOrderProperties = currentVersion >= new Version(7, 7, 0);
        
        // 3. Webhooks (–¥–æ—Å—Ç—É–ø–Ω—ã —Å –≤–µ—Ä—Å–∏–∏ 7.8+)
        capabilities.SupportsWebhooks = currentVersion >= new Version(7, 8, 0);
        
        // 4. Advanced payment types (–¥–æ—Å—Ç—É–ø–Ω—ã —Å –≤–µ—Ä—Å–∏–∏ 7.9+)
        capabilities.SupportsAdvancedPayments = currentVersion >= new Version(7, 9, 0);
        
        // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
        capabilities.SupportsOrderModification = CheckMethodExists("IOrder.ModifyItem");
        capabilities.SupportsGuestBinding = CheckMethodExists("IOrder.SetGuest");
        
        logger.LogInformation(
            "iiko capabilities detected: " +
            "NativeDiscounts={NativeDiscounts}, " +
            "OrderProperties={OrderProperties}, " +
            "Webhooks={Webhooks}",
            capabilities.SupportsNativeDiscounts,
            capabilities.SupportsOrderProperties,
            capabilities.SupportsWebhooks
        );
    }
    
    private bool CheckMethodExists(string methodSignature)
    {
        try
        {
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ —Ä–µ—Ñ–ª–µ–∫—Å–∏—é
            var parts = methodSignature.Split('.');
            var typeName = parts[0];
            var methodName = parts[1];
            
            var type = Type.GetType($"Resto.Front.Api.Data.Orders.{typeName}");
            if (type == null)
                return false;
            
            var method = type.GetMethod(methodName);
            return method != null;
        }
        catch
        {
            return false;
        }
    }
    
    public Version GetVersion()
    {
        return currentVersion;
    }
    
    public IikoCapabilities GetCapabilities()
    {
        return capabilities;
    }
    
    public bool IsFeatureSupported(string featureName)
    {
        return featureName switch
        {
            "NativeDiscounts" => capabilities.SupportsNativeDiscounts,
            "OrderProperties" => capabilities.SupportsOrderProperties,
            "Webhooks" => capabilities.SupportsWebhooks,
            "AdvancedPayments" => capabilities.SupportsAdvancedPayments,
            _ => false
        };
    }
}

public class IikoCapabilities
{
    public bool SupportsNativeDiscounts { get; set; }
    public bool SupportsOrderProperties { get; set; }
    public bool SupportsWebhooks { get; set; }
    public bool SupportsAdvancedPayments { get; set; }
    public bool SupportsOrderModification { get; set; }
    public bool SupportsGuestBinding { get; set; }
}
```

**–ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```csharp
public class IikoIntegrationService
{
    private readonly IikoVersionManager versionManager;
    private readonly IikoCapabilities capabilities;
    
    public IikoIntegrationService(IikoVersionManager versionManager)
    {
        this.versionManager = versionManager;
        this.capabilities = versionManager.GetCapabilities();
    }
    
    public void ApplyPointsPayment(IOrder order, decimal pointsAmount)
    {
        if (capabilities.SupportsNativeDiscounts)
        {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–∫–∏–¥–∫–∏ (–Ω–æ–≤—ã–π —Å–ø–æ—Å–æ–±)
            ApplyPointsPaymentAsNativeDiscount(order, pointsAmount);
            
            logger.LogDebug("Applied points payment using native discounts");
        }
        else
        {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü—Ç–æ–≤–∞—Ä—ã (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±)
            ApplyPointsPaymentAsProduct(order, pointsAmount);
            
            logger.LogDebug("Applied points payment using special product");
        }
    }
    
    private void ApplyPointsPaymentAsNativeDiscount(IOrder order, decimal pointsAmount)
    {
        // –ù–æ–≤—ã–π API (iiko 7.6+)
        var discount = operationService.CreateDiscount(
            name: "–û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ Max Loyalty",
            type: DiscountType.FixedSum,
            value: pointsAmount
        );
        
        order.ApplyDiscount(discount);
        operationService.RecalculateOrder(order);
    }
    
    private void ApplyPointsPaymentAsProduct(IOrder order, decimal pointsAmount)
    {
        // –°—Ç–∞—Ä—ã–π API (iiko 7.5+)
        var product = operationService.GetProductById(pointsPaymentProductId);
        
        var orderItem = operationService.CreateOrderItem(
            product: product,
            quantity: 1,
            price: -pointsAmount
        );
        
        order.AddItem(orderItem);
        operationService.RecalculateOrder(order);
    }
    
    public void SaveOrderMetadata(IOrder order, LoyaltyContext context)
    {
        if (capabilities.SupportsOrderProperties)
        {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ properties –∑–∞–∫–∞–∑–∞ (–Ω–æ–≤—ã–π —Å–ø–æ—Å–æ–±)
            order.SetProperty("MaxLoyalty.GuestCardId", context.GuestCardId);
            order.SetProperty("MaxLoyalty.ReservationId", context.ReservationId);
            
            logger.LogDebug("Saved loyalty metadata to order properties");
        }
        else
        {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –Ω–∞—à–µ–º storage (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±)
            contextStorage.SaveContext(context);
            
            logger.LogDebug("Saved loyalty metadata to plugin storage");
        }
    }
}
```

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤–µ—Ä—Å–∏–∏:**

```csharp
public class DiagnosticsWindow : Window
{
    private void ShowVersionInfo()
    {
        var versionManager = serviceProvider.GetService<IikoVersionManager>();
        var version = versionManager.GetVersion();
        var capabilities = versionManager.GetCapabilities();
        
        var info = new StringBuilder();
        info.AppendLine($"iiko Front –≤–µ—Ä—Å–∏—è: {version}");
        info.AppendLine();
        info.AppendLine("–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:");
        info.AppendLine($"  ‚úì Native —Å–∫–∏–¥–∫–∏: {(capabilities.SupportsNativeDiscounts ? "–î–∞" : "–ù–µ—Ç")}");
        info.AppendLine($"  ‚úì Custom properties: {(capabilities.SupportsOrderProperties ? "–î–∞" : "–ù–µ—Ç")}");
        info.AppendLine($"  ‚úì Webhooks: {(capabilities.SupportsWebhooks ? "–î–∞" : "–ù–µ—Ç")}");
        info.AppendLine($"  ‚úì Advanced payments: {(capabilities.SupportsAdvancedPayments ? "–î–∞" : "–ù–µ—Ç")}");
        
        VersionInfoText.Text = info.ToString();
    }
}
```


***

### **–í–û–ü–†–û–° 36: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫—Ä–∞—à–∞ iiko**

**–í–û–ü–†–û–°:** –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ iiko –∫—Ä–∞—à–Ω—É–ª—Å—è –≤–æ –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–∏—á–µ–≥–æ, –¥–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è–Ω—ã
- **B)** –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ backup –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ
- **C)** Backup + –∞–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π
- **D)** Backup + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ backend –æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) Backup + –∞–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ù–µ —Ç–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ
- ‚úÖ **–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤:** –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –µ—Å–ª–∏ —á–µ–∫ –Ω–µ –∑–∞–∫—Ä—ã—Ç
- ‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** Backend –∑–Ω–∞–µ—Ç –æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
- ‚úÖ **–ê—É–¥–∏—Ç:** –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class CrashRecoveryService
{
    private readonly LoyaltyContextStorage contextStorage;
    private readonly LoyaltyApiClient apiClient;
    private readonly ILogger logger;
    
    public async Task PerformRecoveryAsync()
    {
        try
        {
            logger.LogInformation("Starting crash recovery check...");
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –∏–∑ backup
            var contexts = contextStorage.GetAllContexts();
            
            if (!contexts.Any())
            {
                logger.LogInformation("No pending contexts found, recovery not needed");
                return;
            }
            
            logger.LogWarning(
                "Found {Count} pending contexts from previous session",
                contexts.Count
            );
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
            ShowRecoveryNotification(contexts.Count);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
            var recovered = 0;
            var cancelled = 0;
            var failed = 0;
            
            foreach (var context in contexts)
            {
                try
                {
                    var result = await RecoverContextAsync(context);
                    
                    switch (result)
                    {
                        case RecoveryResult.Recovered:
                            recovered++;
                            break;
                        case RecoveryResult.Cancelled:
                            cancelled++;
                            break;
                        case RecoveryResult.Failed:
                            failed++;
                            break;
                    }
                }
                catch (Exception ex)
                {
                    logger.LogError(ex, "Failed to recover context: {OrderId}", context.OrderId);
                    failed++;
                }
            }
            
            logger.LogInformation(
                "Crash recovery completed: Recovered={Recovered}, Cancelled={Cancelled}, Failed={Failed}",
                recovered,
                cancelled,
                failed
            );
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            ShowRecoveryResultNotification(recovered, cancelled, failed);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –Ω–∞ backend
            await ReportCrashRecoveryAsync(contexts, recovered, cancelled, failed);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Crash recovery failed");
        }
    }
    
    private async Task<RecoveryResult> RecoverContextAsync(LoyaltyContext context)
    {
        logger.LogInformation(
            "Recovering context: Order {OrderId}, Guest {GuestId}, Age {Age}",
            context.OrderId,
            context.GuestCardId,
            DateTime.UtcNow - context.CreatedAt
        );
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        var age = DateTime.UtcNow - context.CreatedAt;
        
        if (age > TimeSpan.FromHours(24))
        {
            // –°–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä—ã–π - –æ—Ç–º–µ–Ω—è–µ–º
            logger.LogWarning(
                "Context too old ({Age}h), cancelling: {OrderId}",
                age.TotalHours,
                context.OrderId
            );
            
            await CancelStaleReservationAsync(context);
            contextStorage.RemoveContext(context.OrderId);
            
            return RecoveryResult.Cancelled;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è
        if (context.ReservationId != null)
        {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –Ω–∞ backend
            var status = await CheckReservationStatusAsync(context.ReservationId);
            
            if (status == ReservationStatus.Active)
            {
                // –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞ - –∑–Ω–∞—á–∏—Ç —á–µ–∫ –Ω–µ –±—ã–ª –∑–∞–∫—Ä—ã—Ç
                logger.LogWarning(
                    "Active reservation found, cancelling: {ReservationId}",
                    context.ReservationId
                );
                
                await CancelReservationAsync(context, "CRASH_RECOVERY");
                contextStorage.RemoveContext(context.OrderId);
                
                return RecoveryResult.Cancelled;
            }
            else if (status == ReservationStatus.Finalized)
            {
                // –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ - –≤—Å—ë –æ–∫, –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
                logger.LogInformation(
                    "Reservation already finalized: {ReservationId}",
                    context.ReservationId
                );
                
                contextStorage.RemoveContext(context.OrderId);
                return RecoveryResult.Recovered;
            }
            else
            {
                // –û—Ç–º–µ–Ω–µ–Ω–∞ –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ - —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
                logger.LogInformation(
                    "Reservation not active: {ReservationId}, status: {Status}",
                    context.ReservationId,
                    status
                );
                
                contextStorage.RemoveContext(context.OrderId);
                return RecoveryResult.Recovered;
            }
        }
        else if (context.Action == LoyaltyAction.EarnOnly)
        {
            // –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ, –±–µ–∑ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—ã–ª –ª–∏ –∑–∞–∫–∞–∑ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
            var isFinalized = await CheckOrderFinalizedAsync(context.OrderId);
            
            if (isFinalized)
            {
                // –ó–∞–∫–∞–∑ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω - —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
                logger.LogInformation(
                    "Order already finalized: {OrderId}",
                    context.OrderId
                );
                
                contextStorage.RemoveContext(context.OrderId);
                return RecoveryResult.Recovered;
            }
            else
            {
                // –ó–∞–∫–∞–∑ –Ω–µ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
                // –ï—Å–ª–∏ offline - –º–æ–≥ –ø–æ–ø–∞—Å—Ç—å –≤ offline queue
                if (context.IsOffline)
                {
                    logger.LogInformation(
                        "Offline earn-only context, checking offline queue: {OrderId}",
                        context.OrderId
                    );
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≤ offline queue
                    var inQueue = offlineQueue.HasOperation(context.OrderId);
                    
                    if (inQueue)
                    {
                        // –ï—Å—Ç—å –≤ –æ—á–µ—Ä–µ–¥–∏ - –≤—Å—ë –æ–∫
                        contextStorage.RemoveContext(context.OrderId);
                        return RecoveryResult.Recovered;
                    }
                    else
                    {
                        // –ù–µ—Ç –≤ –æ—á–µ—Ä–µ–¥–∏ - –¥–æ–±–∞–≤–ª—è–µ–º
                        logger.LogWarning(
                            "Offline operation not in queue, re-adding: {OrderId}",
                            context.OrderId
                        );
                        
                        offlineQueue.EnqueueOperation(new OfflineOperation
                        {
                            Type = OperationType.FINALIZE_EARN_ONLY,
                            GuestCardId = context.GuestCardId,
                            OrderId = context.OrderId,
                            CheckAmount = context.OriginalCheckAmount,
                            PointsToEarn = context.PointsToEarn,
                            RestaurantId = configService.GetRestaurantId()
                        });
                        
                        contextStorage.RemoveContext(context.OrderId);
                        return RecoveryResult.Recovered;
                    }
                }
                else
                {
                    // Online, –Ω–æ –Ω–µ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω - —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –∑–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω
                    logger.LogWarning(
                        "Order not finalized and not offline: {OrderId}",
                        context.OrderId
                    );
                    
                    contextStorage.RemoveContext(context.OrderId);
                    return RecoveryResult.Cancelled;
                }
            }
        }
        
        return RecoveryResult.Failed;
    }
    
    private async Task<ReservationStatus> CheckReservationStatusAsync(string reservationId)
    {
        try
        {
            var response = await apiClient.GetAsync<ReservationStatusResponse>(
                $"/api/reservations/{reservationId}/status"
            );
            
            return response.Status;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to check reservation status: {ReservationId}", reservationId);
            return ReservationStatus.Unknown;
        }
    }
    
    private async Task<bool> CheckOrderFinalizedAsync(string orderId)
    {
        try
        {
            var response = await apiClient.GetAsync<OrderStatusResponse>(
                $"/api/orders/{orderId}/status"
            );
            
            return response.IsFinalized;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to check order status: {OrderId}", orderId);
            return false;
        }
    }
    
    private async Task CancelReservationAsync(LoyaltyContext context, string reason)
    {
        try
        {
            await apiClient.CancelReservationAsync(new CancelReservationRequest
            {
                ReservationId = context.ReservationId,
                OrderId = context.OrderId,
                Reason = reason
            });
            
            logger.LogInformation(
                "Reservation cancelled: {ReservationId}, Reason: {Reason}",
                context.ReservationId,
                reason
            );
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to cancel reservation: {ReservationId}", context.ReservationId);
            throw;
        }
    }
    
    private async Task CancelStaleReservationAsync(LoyaltyContext context)
    {
        await CancelReservationAsync(context, "STALE_CONTEXT");
    }
    
    private void ShowRecoveryNotification(int contextCount)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            ToastNotification.Show(
                "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ—è",
                $"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {contextCount} –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.\n" +
                "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...",
                NotificationType.Warning,
                duration: TimeSpan.FromSeconds(5)
            );
        });
    }
    
    private void ShowRecoveryResultNotification(int recovered, int cancelled, int failed)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            var message = $"–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: {recovered}\n" +
                         $"–û—Ç–º–µ–Ω–µ–Ω–æ: {cancelled}";
            
            if (failed > 0)
            {
                message += $"\n–û—à–∏–±–æ–∫: {failed}";
            }
            
            ToastNotification.Show(
                "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ",
                message,
                failed > 0 ? NotificationType.Warning : NotificationType.Success,
                duration: TimeSpan.FromSeconds(10)
            );
        });
    }
    
    private async Task ReportCrashRecoveryAsync(
        List<LoyaltyContext> contexts, 
        int recovered, 
        int cancelled, 
        int failed)
    {
        try
        {
            await apiClient.PostAsync("/api/diagnostics/crash-recovery", new
            {
                restaurantId = configService.GetRestaurantId(),
                timestamp = DateTime.UtcNow,
                contextsCount = contexts.Count,
                recovered,
                cancelled,
                failed,
                contexts = contexts.Select(c => new
                {
                    c.OrderId,
                    c.GuestCardId,
                    c.Action,
                    c.ReservationId,
                    age = (DateTime.UtcNow - c.CreatedAt).TotalMinutes
                })
            });
            
            logger.LogInformation("Crash recovery report sent to backend");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to report crash recovery");
        }
    }
}

public enum RecoveryResult
{
    Recovered,  // –£—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
    Cancelled,  // –û—Ç–º–µ–Ω–µ–Ω–æ
    Failed      // –û—à–∏–±–∫–∞
}

public enum ReservationStatus
{
    Unknown,
    Active,
    Finalized,
    Cancelled,
    Expired
}
```

**–ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø–ª–∞–≥–∏–Ω–∞:**

```csharp
public class LoyaltyPlugin : IFrontPlugin
{
    public async void Dispose(IPluginResources resources)
    {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º crash recovery
        var recoveryService = new CrashRecoveryService(
            contextStorage,
            apiClient,
            offlineQueue,
            configService
        );
        
        await recoveryService.PerformRecoveryAsync();
        
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—ã—á–Ω—É—é —Ä–∞–±–æ—Ç—É...
    }
}
```


***

### **–í–û–ü–†–û–° 37: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –≤ iiko**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è debugging?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –¢–æ–ª—å–∫–æ –≤ —Ñ–∞–π–ª –ø–ª–∞–≥–∏–Ω–∞
- **B)** –í —Ñ–∞–π–ª –ø–ª–∞–≥–∏–Ω–∞ + –≤ –ª–æ–≥ iiko
- **C)** –í —Ñ–∞–π–ª + –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ backend
- **D)** –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Å–µ –∫–∞–Ω–∞–ª—ã

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ü–æ–ª–Ω–æ—Ç–∞:** –õ–æ–≥–∏ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ü–µ–ª–µ–π
- ‚úÖ **Debugging:** –õ–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É
- ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** Backend –≤–∏–¥–∏—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
- ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** JSON –ª–æ–≥–∏ –ª–µ–≥–∫–æ –ø–∞—Ä—Å–∏—Ç—å

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class LoggingConfiguration
{
    public static void ConfigureLogging(string restaurantId, string pluginVersion)
    {
        var appDataPath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "MaxLoyaltyIiko"
        );
        
        var logsPath = Path.Combine(appDataPath, "logs");
        Directory.CreateDirectory(logsPath);
        
        Log.Logger = new LoggerConfiguration()
            // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
            .MinimumLevel.Debug()
            .MinimumLevel.Override("Microsoft", LogEventLevel.Warning)
            .MinimumLevel.Override("System", LogEventLevel.Warning)
            
            // –û–±–æ–≥–∞—â–µ–Ω–∏–µ
            .Enrich.FromLogContext()
            .Enrich.WithThreadId()
            .Enrich.WithMachineName()
            .Enrich.WithProperty("Plugin", "MaxLoyaltyIiko")
            .Enrich.WithProperty("Version", pluginVersion)
            .Enrich.WithProperty("RestaurantId", restaurantId)
            
            // 1. –õ–æ–≥ –≤ —Ñ–∞–π–ª (structured JSON)
            .WriteTo.File(
                new JsonFormatter(),
                path: Path.Combine(logsPath, "plugin-.json"),
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 30,
                buffered: true,
                flushToDiskInterval: TimeSpan.FromSeconds(5)
            )
            
            // 2. –õ–æ–≥ –≤ —Ñ–∞–π–ª (human readable)
            .WriteTo.File(
                path: Path.Combine(logsPath, "plugin-.log"),
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 7,
                outputTemplate: 
                    "{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz} " +
                    "[{Level:u3}] " +
                    "[{ThreadId}] " +
                    "{Message:lj} " +
                    "{Properties:j}{NewLine}{Exception}"
            )
            
            // 3. Errors –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª
            .WriteTo.Logger(lc => lc
                .Filter.ByIncludingOnly(e => e.Level >= LogEventLevel.Error)
                .WriteTo.File(
                    path: Path.Combine(logsPath, "errors-.log"),
                    rollingInterval: RollingInterval.Day,
                    retainedFileCountLimit: 30
                )
            )
            
            // 4. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ backend (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
            .WriteTo.Async(a => a.Http(
                requestUri: $"{ConfigService.ApiUrl}/api/logs/plugin",
                queueLimit: 1000,
                textFormatter: new JsonFormatter(),
                httpClient: CreateHttpClient()
            ))
            
            // 5. Debug output (—Ç–æ–ª—å–∫–æ –≤ Debug —Ä–µ–∂–∏–º–µ)
            #if DEBUG
            .WriteTo.Debug()
            #endif
            
            .CreateLogger();
        
        Log.Information("Logging configured for restaurant {RestaurantId}", restaurantId);
    }
    
    private static HttpClient CreateHttpClient()
    {
        var client = new HttpClient();
        client.DefaultRequestHeaders.Add("X-API-Key", ConfigService.GetApiKey());
        client.Timeout = TimeSpan.FromSeconds(5);
        return client;
    }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ structured logging:**

```csharp
public class LoyaltyOperationService
{
    private readonly ILogger logger = Log.ForContext<LoyaltyOperationService>();
    
    public async Task<OperationResult> ApplyPointsPaymentAsync(
        string guestCardId,
        decimal pointsToSpend,
        decimal checkAmount,
        string orderId)
    {
        // –°–æ–∑–¥–∞–µ–º correlation ID –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Å–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
        var correlationId = Guid.NewGuid().ToString();
        
        using (LogContext.PushProperty("CorrelationId", correlationId))
        using (LogContext.PushProperty("Operation", "ApplyPointsPayment"))
        {
            logger.Information(
                "Starting points payment operation: " +
                "GuestCard={GuestCardId}, " +
                "Points={Points}, " +
                "CheckAmount={CheckAmount}, " +
                "Order={OrderId}",
                guestCardId,
                pointsToSpend,
                checkAmount,
                orderId
            );
            
            var stopwatch = Stopwatch.StartNew();
            
            try
            {
                // 1. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –Ω–∞ backend
                logger.Debug("Reserving points on backend");
                
                var reservation = await apiClient.ReservePointsAsync(new ReserveRequest
                {
                    GuestCardId = guestCardId,
                    PointsToSpend = pointsToSpend,
                    CheckAmount = checkAmount,
                    OrderId = orderId
                });
                
                if (!reservation.Success)
                {
                    logger.Warning(
                        "Points reservation failed: {Error}",
                        reservation.Error
                    );
                    
                    return OperationResult.Error(reservation.Error);
                }
                
                logger.Information(
                    "Points reserved: ReservationId={ReservationId}, Duration={Duration}ms",
                    reservation.ReservationId,
                    stopwatch.ElapsedMilliseconds
                );
                
                // 2. –ü—Ä–∏–º–µ–Ω—è–µ–º –≤ iiko
                logger.Debug("Applying payment to iiko order");
                
                iikoService.ApplyPointsPayment(order, pointsToSpend);
                
                logger.Information(
                    "Points payment applied successfully: " +
                    "Duration={Duration}ms, " +
                    "NewOrderTotal={NewTotal}",
                    stopwatch.ElapsedMilliseconds,
                    order.GetSum()
                );
                
                // –ú–µ—Ç—Ä–∏–∫–∏
                metricsService.RecordMetric(
                    "loyalty.operation.duration",
                    stopwatch.ElapsedMilliseconds,
                    tags: new Dictionary<string, string>
                    {
                        ["operation"] = "apply_points_payment",
                        ["success"] = "true"
                    }
                );
                
                return OperationResult.Success();
            }
            catch (Exception ex)
            {
                stopwatch.Stop();
                
                logger.Error(
                    ex,
                    "Points payment operation failed: " +
                    "Duration={Duration}ms, " +
                    "Error={ErrorType}",
                    stopwatch.ElapsedMilliseconds,
                    ex.GetType().Name
                );
                
                // –ú–µ—Ç—Ä–∏–∫–∏
                metricsService.RecordMetric(
                    "loyalty.operation.duration",
                    stopwatch.ElapsedMilliseconds,
                    tags: new Dictionary<string, string>
                    {
                        ["operation"] = "apply_points_payment",
                        ["success"] = "false",
                        ["error_type"] = ex.GetType().Name
                    }
                );
                
                throw;
            }
        }
    }
}
```

**Backend endpoint –¥–ª—è –ø—Ä–∏–µ–º–∞ –ª–æ–≥–æ–≤:**

```typescript
@Post('logs/plugin')
@UseGuards(IikoPluginAuthGuard)
async receivePluginLogs(
  @Body() logs: PluginLogEntry[],
  @CurrentInstallation() installation: IikoPluginInstallation
) {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏ –≤ –±–∞–∑—É –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  await this.prisma.pluginLog.createMany({
    data: logs.map(log => ({
      restaurantId: installation.restaurantId,
      level: log.level,
      message: log.message,
      timestamp: new Date(log.timestamp),
      properties: log.properties,
      exception: log.exception
    }))
  });
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
  const criticalErrors = logs.filter(log => log.level === 'Fatal' || log.level === 'Error');
  
  if (criticalErrors.length > 0) {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –∞–¥–º–∏–Ω—É
    await this.notificationService.sendToAdmin({
      type: 'PLUGIN_ERROR',
      restaurantId: installation.restaurantId,
      message: `‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –ø–ª–∞–≥–∏–Ω–µ iiko\n\n${criticalErrors[0].message}`
    });
  }
  
  return { received: logs.length };
}
```


***

## **‚ö° –ë–õ–û–ö 6: –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨ –ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø (5 –≤–æ–ø—Ä–æ—Å–æ–≤)**


***

### **–í–û–ü–†–û–° 38: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**

**–í–û–ü–†–û–°:** –ß—Ç–æ –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å –≤ –ø–ª–∞–≥–∏–Ω–µ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–∏—á–µ–≥–æ –Ω–µ –∫–µ—à–∏—Ä—É–µ–º (–≤—Å–µ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º backend)
- **B)** –¢–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
- **C)** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è + –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–æ—Å—Ç—è—Ö
- **D)** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è + –≥–æ—Å—Ç–∏ + —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã calculate

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è + –≥–æ—Å—Ç–∏**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–°–∫–æ—Ä–æ—Å—Ç—å:** –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π
- ‚úÖ **UX:** –ù–µ –∂–¥–µ–º backend –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∫–ª–∏–∫–µ
- ‚úÖ **Offline:** –ö–µ—à —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- ‚ùå **Calculate:** –ù–µ–ª—å–∑—è –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—É–º–º—ã —á–µ–∫–∞)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class CacheService
{
    private readonly MemoryCache cache;
    private readonly ILogger logger;
    
    // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–µ—à–∞
    private static readonly TimeSpan RestaurantConfigTTL = TimeSpan.FromMinutes(5);
    private static readonly TimeSpan GuestInfoTTL = TimeSpan.FromMinutes(10);
    private static readonly TimeSpan SearchResultTTL = TimeSpan.FromMinutes(2);
    
    public CacheService()
    {
        cache = new MemoryCache(new MemoryCacheOptions
        {
            SizeLimit = 1000, // –ú–∞–∫—Å 1000 –∑–∞–ø–∏—Å–µ–π
            ExpirationScanFrequency = TimeSpan.FromMinutes(1)
        });
    }
    
    // ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –†–ï–°–¢–û–†–ê–ù–ê =====
    
    public async Task<RestaurantConfig> GetRestaurantConfigAsync(
        Func<Task<RestaurantConfig>> fetchFunc)
    {
        var key = "restaurant_config";
        
        if (cache.TryGetValue(key, out RestaurantConfig cached))
        {
            logger.LogDebug("Restaurant config loaded from cache");
            return cached;
        }
        
        logger.LogDebug("Restaurant config cache miss, fetching from backend");
        
        var config = await fetchFunc();
        
        cache.Set(key, config, new MemoryCacheEntryOptions
        {
            AbsoluteExpirationRelativeToNow = RestaurantConfigTTL,
            Size = 1
        });
        
        return config;
    }
    
    public void InvalidateRestaurantConfig()
    {
        cache.Remove("restaurant_config");
        logger.LogDebug("Restaurant config cache invalidated");
    }
    
    // ===== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ì–û–°–¢–ï =====
    
    public async Task<GuestInfo> GetGuestInfoAsync(
        string guestCardId,
        Func<Task<GuestInfo>> fetchFunc)
    {
        var key = $"guest_{guestCardId}";
        
        if (cache.TryGetValue(key, out GuestInfo cached))
        {
            logger.LogDebug("Guest info loaded from cache: {GuestCardId}", guestCardId);
            return cached;
        }
        
        logger.LogDebug("Guest info cache miss: {GuestCardId}", guestCardId);
        
        var guest = await fetchFunc();
        
        if (guest != null)
        {
            cache.Set(key, guest, new MemoryCacheEntryOptions
            {
                AbsoluteExpirationRelativeToNow = GuestInfoTTL,
                Size = 10 // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–æ—Å—Ç–µ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞
            });
        }
        
        return guest;
    }
    
    public void InvalidateGuest(string guestCardId)
    {
        cache.Remove($"guest_{guestCardId}");
        logger.LogDebug("Guest cache invalidated: {GuestCardId}", guestCardId);
    }
    
    // ===== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê =====
    
    public async Task<SearchResult> GetSearchResultAsync(
        string searchInput,
        Func<Task<SearchResult>> fetchFunc)
    {
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–µ—à–∞
        var normalizedInput = NormalizeSearchInput(searchInput);
        var key = $"search_{normalizedInput}";
        
        if (cache.TryGetValue(key, out SearchResult cached))
        {
            logger.LogDebug("Search result loaded from cache: {Input}", searchInput);
            return cached;
        }
        
        logger.LogDebug("Search cache miss: {Input}", searchInput);
        
        var result = await fetchFunc();
        
        // –ö–µ—à–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        if (result.Found)
        {
            cache.Set(key, result, new MemoryCacheEntryOptions
            {
                AbsoluteExpirationRelativeToNow = SearchResultTTL,
                Size = 10
            });
        }
        
        return result;
    }
    
    private string NormalizeSearchInput(string input)
    {
        // –î–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞: —É–±–∏—Ä–∞–µ–º –≤—Å–µ –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
        if (input.StartsWith("+") || input.StartsWith("7") || input.StartsWith("8"))
        {
            var digitsOnly = new string(input.Where(char.IsDigit).ToArray());
            
            if (digitsOnly.StartsWith("8") && digitsOnly.Length == 11)
            {
                return "+7" + digitsOnly.Substring(1);
            }
            
            if (digitsOnly.StartsWith("7") && digitsOnly.Length == 11)
            {
                return "+" + digitsOnly;
            }
            
            if (digitsOnly.Length == 10)
            {
                return "+7" + digitsOnly;
            }
        }
        
        // –î–ª—è –∫–æ–¥–∞: –ø—Ä–æ—Å—Ç–æ —Ü–∏—Ñ—Ä—ã
        return new string(input.Where(char.IsDigit).ToArray());
    }
    
    // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ï–®–ï–ú =====
    
    public void ClearAll()
    {
        cache.Compact(1.0); // –£–¥–∞–ª—è–µ–º –≤—Å—ë
        logger.LogInformation("Cache cleared");
    }
    
    public CacheStatistics GetStatistics()
    {
        return new CacheStatistics
        {
            // MemoryCache –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            // –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–≤–æ–π –ø–æ–¥—Å—á–µ—Ç
        };
    }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```csharp
public class LoyaltyApiClient
{
    private readonly CacheService cache;
    
    public async Task<GuestInfo> GetGuestInfoAsync(string guestCardId)
    {
        return await cache.GetGuestInfoAsync(
            guestCardId,
            fetchFunc: async () =>
            {
                // –ó–∞–ø—Ä–æ—Å –∫ backend –µ—Å–ª–∏ –Ω–µ—Ç –≤ –∫–µ—à–µ
                var response = await httpClient.GetAsync<GuestInfoResponse>(
                    $"/api/guests/{guestCardId}"
                );
                
                return response.Guest;
            }
        );
    }
    
    public async Task<SearchResult> SearchGuestAsync(string input)
    {
        return await cache.GetSearchResultAsync(
            input,
            fetchFunc: async () =>
            {
                // –ó–∞–ø—Ä–æ—Å –∫ backend
                var response = await httpClient.PostAsync<SearchResponse>(
                    "/api/search-guest",
                    new { phone = input }
                );
                
                return new SearchResult
                {
                    Found = response.Found,
                    Guest = response.Guest
                };
            }
        );
    }
    
    public async Task<RestaurantConfig> GetRestaurantConfigAsync()
    {
        return await cache.GetRestaurantConfigAsync(
            fetchFunc: async () =>
            {
                // –ó–∞–ø—Ä–æ—Å –∫ backend
                var response = await httpClient.GetAsync<RestaurantConfigResponse>(
                    "/api/restaurant/config"
                );
                
                return response.Config;
            }
        );
    }
}
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ 39-42 (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å) –∏ –∑–∞—Ç–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –±–ª–æ–∫ 7 (–î–µ–ø–ª–æ–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞)?

---

### **–í–û–ü–†–û–° 39: –¢–∞–π–º–∞—É—Ç—ã –∏ retry —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏**

**–í–û–ü–†–û–°:** –ö–∞–∫–∏–µ —Ç–∞–π–º–∞—É—Ç—ã –∏ retry –ø–æ–ª–∏—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ë–µ–∑ —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ retry (–∑–∞–ø—Ä–æ—Å –ª–∏–±–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ª–∏–±–æ –Ω–µ—Ç)
- **B)** –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç 5 —Å–µ–∫, –±–µ–∑ retry
- **C)** –¢–∞–π–º–∞—É—Ç 10 —Å–µ–∫ + 3 retry —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- **D)** –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã + exponential backoff retry

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã + exponential backoff**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –°–ø—Ä–∞–≤–ª—è–µ–º—Å—è —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Å–±–æ—è–º–∏
- ‚úÖ **–ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º:** Exponential backoff –Ω–µ —Å–ø–∞–º–∏—Ç —Å–µ—Ä–≤–µ—Ä
- ‚úÖ **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å:** –†–∞–∑–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ **UX:** –ö–∞—Å—Å–∏—Ä –Ω–µ –∂–¥–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class ApiClientConfiguration
{
    // –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π
    public static readonly Dictionary<OperationType, TimeSpan> Timeouts = new()
    {
        [OperationType.HealthCheck] = TimeSpan.FromSeconds(3),
        [OperationType.SearchGuest] = TimeSpan.FromSeconds(5),
        [OperationType.Calculate] = TimeSpan.FromSeconds(5),
        [OperationType.ReservePoints] = TimeSpan.FromSeconds(8),
        [OperationType.FinalizePoints] = TimeSpan.FromSeconds(10),
        [OperationType.GetConfig] = TimeSpan.FromSeconds(5)
    };
    
    // Retry –ø–æ–ª–∏—Ç–∏–∫–∏
    public static readonly Dictionary<OperationType, RetryPolicy> RetryPolicies = new()
    {
        // Health check - –Ω–µ retry (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±—ã—Å—Ç—Ä—ã–º)
        [OperationType.HealthCheck] = new RetryPolicy
        {
            MaxAttempts = 1,
            Strategy = RetryStrategy.None
        },
        
        // –ü–æ–∏—Å–∫ - 2 retry —Å –∫–æ—Ä–æ—Ç–∫–∏–º backoff
        [OperationType.SearchGuest] = new RetryPolicy
        {
            MaxAttempts = 3,
            Strategy = RetryStrategy.ExponentialBackoff,
            InitialDelay = TimeSpan.FromMilliseconds(200),
            MaxDelay = TimeSpan.FromSeconds(2)
        },
        
        // Calculate - 2 retry
        [OperationType.Calculate] = new RetryPolicy
        {
            MaxAttempts = 3,
            Strategy = RetryStrategy.ExponentialBackoff,
            InitialDelay = TimeSpan.FromMilliseconds(300),
            MaxDelay = TimeSpan.FromSeconds(3)
        },
        
        // –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è - 3 retry (–≤–∞–∂–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)
        [OperationType.ReservePoints] = new RetryPolicy
        {
            MaxAttempts = 4,
            Strategy = RetryStrategy.ExponentialBackoff,
            InitialDelay = TimeSpan.FromMilliseconds(500),
            MaxDelay = TimeSpan.FromSeconds(5)
        },
        
        // –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è - 5 retry (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)
        [OperationType.FinalizePoints] = new RetryPolicy
        {
            MaxAttempts = 6,
            Strategy = RetryStrategy.ExponentialBackoff,
            InitialDelay = TimeSpan.FromSeconds(1),
            MaxDelay = TimeSpan.FromSeconds(10)
        },
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - 2 retry
        [OperationType.GetConfig] = new RetryPolicy
        {
            MaxAttempts = 3,
            Strategy = RetryStrategy.ExponentialBackoff,
            InitialDelay = TimeSpan.FromMilliseconds(500),
            MaxDelay = TimeSpan.FromSeconds(3)
        }
    };
}

public enum OperationType
{
    HealthCheck,
    SearchGuest,
    Calculate,
    ReservePoints,
    FinalizePoints,
    GetConfig
}

public enum RetryStrategy
{
    None,
    FixedDelay,
    ExponentialBackoff,
    Jittered
}

public class RetryPolicy
{
    public int MaxAttempts { get; set; }
    public RetryStrategy Strategy { get; set; }
    public TimeSpan InitialDelay { get; set; }
    public TimeSpan MaxDelay { get; set; }
}

public class LoyaltyApiClient
{
    private readonly HttpClient httpClient;
    private readonly ILogger logger;
    
    public async Task<TResponse> ExecuteWithRetryAsync<TResponse>(
        OperationType operationType,
        Func<CancellationToken, Task<TResponse>> operation,
        CancellationToken cancellationToken = default)
    {
        var timeout = ApiClientConfiguration.Timeouts[operationType];
        var retryPolicy = ApiClientConfiguration.RetryPolicies[operationType];
        
        var attempt = 0;
        Exception lastException = null;
        
        using var timeoutCts = new CancellationTokenSource(timeout);
        using var linkedCts = CancellationTokenSource.CreateLinkedTokenSource(
            cancellationToken, 
            timeoutCts.Token
        );
        
        while (attempt < retryPolicy.MaxAttempts)
        {
            attempt++;
            
            try
            {
                logger.LogDebug(
                    "Executing {Operation}, attempt {Attempt}/{Max}",
                    operationType,
                    attempt,
                    retryPolicy.MaxAttempts
                );
                
                var stopwatch = Stopwatch.StartNew();
                
                var result = await operation(linkedCts.Token);
                
                stopwatch.Stop();
                
                logger.LogDebug(
                    "{Operation} succeeded on attempt {Attempt}, duration: {Duration}ms",
                    operationType,
                    attempt,
                    stopwatch.ElapsedMilliseconds
                );
                
                // –ú–µ—Ç—Ä–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                metricsService.RecordMetric(
                    "api.request.duration",
                    stopwatch.ElapsedMilliseconds,
                    tags: new Dictionary<string, string>
                    {
                        ["operation"] = operationType.ToString(),
                        ["attempt"] = attempt.ToString(),
                        ["success"] = "true"
                    }
                );
                
                return result;
            }
            catch (OperationCanceledException) when (timeoutCts.IsCancellationRequested)
            {
                // Timeout
                lastException = new TimeoutException(
                    $"Operation {operationType} timed out after {timeout.TotalSeconds}s"
                );
                
                logger.LogWarning(
                    "Operation {Operation} timed out on attempt {Attempt}",
                    operationType,
                    attempt
                );
            }
            catch (HttpRequestException ex)
            {
                // Network error
                lastException = ex;
                
                logger.LogWarning(
                    ex,
                    "Operation {Operation} failed on attempt {Attempt}: {Error}",
                    operationType,
                    attempt,
                    ex.Message
                );
            }
            catch (ApiException ex) when (IsRetryableError(ex))
            {
                // Retryable API error (5xx)
                lastException = ex;
                
                logger.LogWarning(
                    ex,
                    "Operation {Operation} failed with retryable error on attempt {Attempt}: {StatusCode}",
                    operationType,
                    attempt,
                    ex.StatusCode
                );
            }
            catch (Exception ex)
            {
                // Non-retryable error - –Ω–µ –¥–µ–ª–∞–µ–º retry
                logger.LogError(
                    ex,
                    "Operation {Operation} failed with non-retryable error: {ErrorType}",
                    operationType,
                    ex.GetType().Name
                );
                
                throw;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–µ–Ω –ª–∏ retry
            if (attempt >= retryPolicy.MaxAttempts)
            {
                logger.LogError(
                    "Operation {Operation} failed after {Attempts} attempts",
                    operationType,
                    attempt
                );
                
                break;
            }
            
            // –í—ã—á–∏—Å–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ retry
            var delay = CalculateRetryDelay(retryPolicy, attempt);
            
            logger.LogDebug(
                "Retrying {Operation} in {Delay}ms",
                operationType,
                delay.TotalMilliseconds
            );
            
            // –ñ–¥–µ–º –ø–µ—Ä–µ–¥ retry
            try
            {
                await Task.Delay(delay, linkedCts.Token);
            }
            catch (OperationCanceledException)
            {
                // –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
                throw;
            }
        }
        
        // –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
        metricsService.RecordMetric(
            "api.request.failed",
            1,
            tags: new Dictionary<string, string>
            {
                ["operation"] = operationType.ToString(),
                ["attempts"] = attempt.ToString()
            }
        );
        
        throw new ApiException(
            $"Operation {operationType} failed after {attempt} attempts",
            lastException
        );
    }
    
    private TimeSpan CalculateRetryDelay(RetryPolicy policy, int attempt)
    {
        TimeSpan delay;
        
        switch (policy.Strategy)
        {
            case RetryStrategy.None:
                return TimeSpan.Zero;
            
            case RetryStrategy.FixedDelay:
                delay = policy.InitialDelay;
                break;
            
            case RetryStrategy.ExponentialBackoff:
                // 2^attempt * InitialDelay
                var exponential = Math.Pow(2, attempt - 1);
                delay = TimeSpan.FromMilliseconds(
                    policy.InitialDelay.TotalMilliseconds * exponential
                );
                break;
            
            case RetryStrategy.Jittered:
                // Exponential backoff + random jitter
                var expJitter = Math.Pow(2, attempt - 1);
                var baseDelay = policy.InitialDelay.TotalMilliseconds * expJitter;
                var jitter = Random.Shared.NextDouble() * baseDelay * 0.3; // ¬±30% jitter
                delay = TimeSpan.FromMilliseconds(baseDelay + jitter);
                break;
            
            default:
                delay = policy.InitialDelay;
                break;
        }
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
        if (delay > policy.MaxDelay)
        {
            delay = policy.MaxDelay;
        }
        
        return delay;
    }
    
    private bool IsRetryableError(ApiException ex)
    {
        // Retry —Ç–æ–ª—å–∫–æ –¥–ª—è server errors (5xx)
        return ex.StatusCode >= 500 && ex.StatusCode < 600;
    }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```csharp
public async Task<SearchResult> SearchGuestAsync(string input)
{
    return await ExecuteWithRetryAsync(
        OperationType.SearchGuest,
        async (ct) =>
        {
            var response = await httpClient.PostAsync(
                "/api/search-guest",
                new StringContent(JsonConvert.SerializeObject(new { phone = input })),
                ct
            );
            
            response.EnsureSuccessStatusCode();
            
            var json = await response.Content.ReadAsStringAsync();
            return JsonConvert.DeserializeObject<SearchResult>(json);
        }
    );
}

public async Task<ReserveResponse> ReservePointsAsync(ReserveRequest request)
{
    return await ExecuteWithRetryAsync(
        OperationType.ReservePoints,
        async (ct) =>
        {
            var response = await httpClient.PostAsync(
                "/api/reserve-points",
                new StringContent(JsonConvert.SerializeObject(request)),
                ct
            );
            
            if (!response.IsSuccessStatusCode)
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                throw new ApiException(
                    $"Reserve failed: {response.StatusCode}",
                    (int)response.StatusCode,
                    errorContent
                );
            }
            
            var json = await response.Content.ReadAsStringAsync();
            return JsonConvert.DeserializeObject<ReserveResponse>(json);
        }
    );
}
```

**Circuit Breaker –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏:**

```csharp
public class CircuitBreakerService
{
    private CircuitBreakerState state = CircuitBreakerState.Closed;
    private int consecutiveFailures = 0;
    private DateTime lastFailureTime = DateTime.MinValue;
    
    private const int FAILURE_THRESHOLD = 5;
    private static readonly TimeSpan OPEN_DURATION = TimeSpan.FromSeconds(30);
    
    public async Task<T> ExecuteAsync<T>(Func<Task<T>> operation)
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ circuit breaker
        if (state == CircuitBreakerState.Open)
        {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –≤ half-open
            if (DateTime.Now - lastFailureTime > OPEN_DURATION)
            {
                logger.LogInformation("Circuit breaker transitioning to half-open");
                state = CircuitBreakerState.HalfOpen;
            }
            else
            {
                logger.LogWarning("Circuit breaker is open, rejecting request");
                throw new CircuitBreakerOpenException(
                    "Circuit breaker is open due to repeated failures"
                );
            }
        }
        
        try
        {
            var result = await operation();
            
            // –£—Å–ø–µ—Ö - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
            if (state == CircuitBreakerState.HalfOpen)
            {
                logger.LogInformation("Circuit breaker transitioning to closed (half-open ‚Üí closed)");
                state = CircuitBreakerState.Closed;
            }
            
            consecutiveFailures = 0;
            
            return result;
        }
        catch (Exception ex)
        {
            consecutiveFailures++;
            lastFailureTime = DateTime.Now;
            
            logger.LogWarning(
                "Circuit breaker recorded failure: {Count}/{Threshold}",
                consecutiveFailures,
                FAILURE_THRESHOLD
            );
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä–æ–≥
            if (consecutiveFailures >= FAILURE_THRESHOLD)
            {
                logger.LogError("Circuit breaker opened due to {Count} consecutive failures", consecutiveFailures);
                state = CircuitBreakerState.Open;
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º backend –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö
                _ = ReportCircuitBreakerOpenAsync();
            }
            
            throw;
        }
    }
}

public enum CircuitBreakerState
{
    Closed,   // –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
    Open,     // –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫, –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã
    HalfOpen  // –ü—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
}
```


***

### **–í–û–ü–†–û–° 40: –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏**

**–í–û–ü–†–û–°:** –ö–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø–ª–∞–≥–∏–Ω–∞?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–µ –∑–∞–º–æ—Ä–∞—á–∏–≤–∞–µ–º—Å—è (–∫–æ–º–ø—å—é—Ç–µ—Ä—ã –º–æ—â–Ω—ã–µ)
- **B)** –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–µ—à–∞
- **C)** –ö–µ—à + –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **D)** –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏ + –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –ö–µ—à + –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ë–∞–ª–∞–Ω—Å:** –ö–µ—à —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ —Ä–∞—Å—Ç–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –ù–µ –Ω—É–∂–µ–Ω —Å–ª–æ–∂–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É iiko

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class MemoryManager
{
    private readonly ILogger logger;
    private Timer cleanupTimer;
    
    // –õ–∏–º–∏—Ç—ã
    private const int MAX_CACHE_SIZE = 1000; // –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø–∏—Å–µ–π –≤ –∫–µ—à–µ
    private const long MAX_LOG_FILE_SIZE = 100 * 1024 * 1024; // 100 MB
    private const int MAX_OFFLINE_QUEUE_SIZE = 100;
    
    public void Start()
    {
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç
        cleanupTimer = new Timer(
            callback: _ => PerformCleanup(),
            state: null,
            dueTime: TimeSpan.FromMinutes(15),
            period: TimeSpan.FromMinutes(15)
        );
        
        logger.LogInformation("Memory manager started");
    }
    
    public void Stop()
    {
        cleanupTimer?.Dispose();
    }
    
    private void PerformCleanup()
    {
        try
        {
            logger.LogDebug("Starting memory cleanup");
            
            var stopwatch = Stopwatch.StartNew();
            
            // 1. –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –∫–µ—à–∞
            CleanupCache();
            
            // 2. –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –∑–∞–∫–∞–∑–æ–≤
            CleanupOrderContexts();
            
            // 3. –û—á–∏—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ offline queue
            CleanupOfflineQueue();
            
            // 4. –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤
            CleanupLogs();
            
            // 5. –§–æ—Ä—Å–∏—Ä—É–µ–º —Å–±–æ—Ä–∫—É –º—É—Å–æ—Ä–∞ (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
            if (ShouldForceGC())
            {
                ForceGarbageCollection();
            }
            
            stopwatch.Stop();
            
            logger.LogInformation(
                "Memory cleanup completed in {Duration}ms",
                stopwatch.ElapsedMilliseconds
            );
            
            // –õ–æ–≥–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
            LogMemoryUsage();
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Memory cleanup failed");
        }
    }
    
    private void CleanupCache()
    {
        var cacheStats = cacheService.GetStatistics();
        
        if (cacheStats.EntryCount > MAX_CACHE_SIZE * 0.8) // 80% –æ—Ç –ª–∏–º–∏—Ç–∞
        {
            logger.LogWarning(
                "Cache size approaching limit: {Current}/{Max}, compacting",
                cacheStats.EntryCount,
                MAX_CACHE_SIZE
            );
            
            // –£–¥–∞–ª—è–µ–º 30% —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
            cacheService.Compact(0.3);
        }
    }
    
    private void CleanupOrderContexts()
    {
        // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
        contextStorage.CleanupOldContexts();
    }
    
    private void CleanupOfflineQueue()
    {
        // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
        offlineQueue.CleanupQueue();
        
        var queueSize = offlineQueue.GetQueueSize();
        
        if (queueSize > MAX_OFFLINE_QUEUE_SIZE)
        {
            logger.LogWarning(
                "Offline queue size exceeds limit: {Size}/{Max}",
                queueSize,
                MAX_OFFLINE_QUEUE_SIZE
            );
            
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
            NotifyAdminAboutLargeQueue(queueSize);
        }
    }
    
    private void CleanupLogs()
    {
        try
        {
            var logsPath = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                "MaxLoyaltyIiko",
                "logs"
            );
            
            if (!Directory.Exists(logsPath))
                return;
            
            var logFiles = Directory.GetFiles(logsPath, "*.log")
                .OrderByDescending(f => File.GetCreationTime(f))
                .ToList();
            
            // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
            var cutoffDate = DateTime.Now.AddDays(-30);
            var filesToDelete = logFiles
                .Where(f => File.GetCreationTime(f) < cutoffDate)
                .ToList();
            
            foreach (var file in filesToDelete)
            {
                try
                {
                    File.Delete(file);
                    logger.LogDebug("Deleted old log file: {File}", Path.GetFileName(file));
                }
                catch (Exception ex)
                {
                    logger.LogWarning(ex, "Failed to delete log file: {File}", file);
                }
            }
            
            if (filesToDelete.Any())
            {
                logger.LogInformation("Deleted {Count} old log files", filesToDelete.Count);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—É—â–∏—Ö –ª–æ–≥–æ–≤
            var totalSize = logFiles
                .Where(File.Exists)
                .Sum(f => new FileInfo(f).Length);
            
            if (totalSize > MAX_LOG_FILE_SIZE * 2) // 200 MB
            {
                logger.LogWarning(
                    "Log files size exceeds limit: {Size} MB",
                    totalSize / (1024 * 1024)
                );
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω–µ–º –ª–∏–º–∏—Ç–∞
                var currentSize = totalSize;
                foreach (var file in logFiles.Skip(7)) // –û—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 —Ñ–∞–π–ª–æ–≤
                {
                    if (currentSize <= MAX_LOG_FILE_SIZE)
                        break;
                    
                    try
                    {
                        var fileSize = new FileInfo(file).Length;
                        File.Delete(file);
                        currentSize -= fileSize;
                        
                        logger.LogDebug("Deleted log file to free space: {File}", Path.GetFileName(file));
                    }
                    catch { }
                }
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Log cleanup failed");
        }
    }
    
    private bool ShouldForceGC()
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
        var currentMemory = GC.GetTotalMemory(forceFullCollection: false);
        var memoryMB = currentMemory / (1024 * 1024);
        
        // –ï—Å–ª–∏ –ø–ª–∞–≥–∏–Ω –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ 100 MB - –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å GC
        return memoryMB > 100;
    }
    
    private void ForceGarbageCollection()
    {
        logger.LogDebug("Forcing garbage collection");
        
        var memoryBefore = GC.GetTotalMemory(forceFullCollection: false);
        
        GC.Collect(GC.MaxGeneration, GCCollectionMode.Forced, blocking: true, compacting: true);
        GC.WaitForPendingFinalizers();
        GC.Collect();
        
        var memoryAfter = GC.GetTotalMemory(forceFullCollection: false);
        var freedMB = (memoryBefore - memoryAfter) / (1024 * 1024);
        
        logger.LogInformation(
            "Garbage collection completed: Freed {Freed} MB (Before: {Before} MB, After: {After} MB)",
            freedMB,
            memoryBefore / (1024 * 1024),
            memoryAfter / (1024 * 1024)
        );
    }
    
    private void LogMemoryUsage()
    {
        var process = Process.GetCurrentProcess();
        
        var workingSet = process.WorkingSet64 / (1024 * 1024); // MB
        var privateMemory = process.PrivateMemorySize64 / (1024 * 1024); // MB
        var gcMemory = GC.GetTotalMemory(forceFullCollection: false) / (1024 * 1024); // MB
        
        logger.LogInformation(
            "Memory usage: WorkingSet={WorkingSet} MB, Private={Private} MB, GC={GC} MB",
            workingSet,
            privateMemory,
            gcMemory
        );
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫—É
        metricsService.RecordMetric("plugin.memory.working_set", workingSet);
        metricsService.RecordMetric("plugin.memory.private", privateMemory);
        metricsService.RecordMetric("plugin.memory.gc", gcMemory);
    }
    
    private void NotifyAdminAboutLargeQueue(int size)
    {
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Ä–∞–∑ –≤ —á–∞—Å
        var lastNotification = cache.Get<DateTime>("last_queue_notification");
        
        if (DateTime.Now - lastNotification < TimeSpan.FromHours(1))
            return;
        
        cache.Set("last_queue_notification", DateTime.Now);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend
        _ = apiClient.PostAsync("/api/diagnostics/large-offline-queue", new
        {
            restaurantId = configService.GetRestaurantId(),
            queueSize = size,
            maxSize = MAX_OFFLINE_QUEUE_SIZE
        });
    }
}
```

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–∞–º—è—Ç–∏:**

```csharp
public class DiagnosticsWindow : Window
{
    private void ShowMemoryInfo()
    {
        var process = Process.GetCurrentProcess();
        
        var info = new StringBuilder();
        info.AppendLine("üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:");
        info.AppendLine();
        info.AppendLine($"Working Set: {process.WorkingSet64 / (1024 * 1024)} MB");
        info.AppendLine($"Private Memory: {process.PrivateMemorySize64 / (1024 * 1024)} MB");
        info.AppendLine($"GC Memory: {GC.GetTotalMemory(false) / (1024 * 1024)} MB");
        info.AppendLine();
        info.AppendLine($"GC Collections:");
        info.AppendLine($"  Gen 0: {GC.CollectionCount(0)}");
        info.AppendLine($"  Gen 1: {GC.CollectionCount(1)}");
        info.AppendLine($"  Gen 2: {GC.CollectionCount(2)}");
        info.AppendLine();
        
        var cacheStats = cacheService.GetStatistics();
        info.AppendLine($"–ö–µ—à: {cacheStats.EntryCount} –∑–∞–ø–∏—Å–µ–π");
        
        var contextCount = contextStorage.GetCount();
        info.AppendLine($"–ö–æ–Ω—Ç–µ–∫—Å—Ç—ã –∑–∞–∫–∞–∑–æ–≤: {contextCount}");
        
        var queueSize = offlineQueue.GetQueueSize();
        info.AppendLine($"Offline –æ—á–µ—Ä–µ–¥—å: {queueSize}");
        
        MemoryInfoText.Text = info.ToString();
    }
}
```


***

### **–í–û–ü–†–û–° 41: –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**

**–í–û–ü–†–û–°:** –ö–∞–∫ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤ –ø–ª–∞–≥–∏–Ω–µ?

**–í–ê–†–ò–ê–ù–¢–´:**

- **A)** –í—Å—ë –≤ main thread (–±–µ–∑ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏)
- **B)** Async/await –¥–ª—è I/O, –Ω–æ –±–µ–∑ —è–≤–Ω—ã—Ö lock-–æ–≤
- **C)** Async/await + lock –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ–∫—Ü–∏–π
- **D)** Async/await + concurrent –∫–æ–ª–ª–µ–∫—Ü–∏–∏ + SemaphoreSlim

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) Async/await + concurrent –∫–æ–ª–ª–µ–∫—Ü–∏–∏ + SemaphoreSlim**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** Concurrent –∫–æ–ª–ª–µ–∫—Ü–∏–∏ thread-safe
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º UI thread
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å:** SemaphoreSlim –¥–ª—è async –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –ú–æ–∂–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class LoyaltyContextStorage
{
    // Concurrent –∫–æ–ª–ª–µ–∫—Ü–∏—è –¥–ª—è thread-safe –¥–æ—Å—Ç—É–ø–∞
    private readonly ConcurrentDictionary<string, LoyaltyContext> contexts;
    
    // SemaphoreSlim –¥–ª—è async —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    private readonly SemaphoreSlim fileLock = new SemaphoreSlim(1, 1);
    
    private readonly string backupFilePath;
    private readonly ILogger logger;
    
    public LoyaltyContextStorage()
    {
        contexts = new ConcurrentDictionary<string, LoyaltyContext>();
        
        // ...
    }
    
    // Thread-safe –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    public void SaveContext(LoyaltyContext context)
    {
        contexts.AddOrUpdate(
            context.OrderId,
            context,
            (key, oldValue) => context
        );
        
        // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –¥–∏—Å–∫ (fire and forget)
        _ = SaveToBackupAsync();
    }
    
    // Thread-safe —á—Ç–µ–Ω–∏–µ
    public LoyaltyContext GetContext(string orderId)
    {
        contexts.TryGetValue(orderId, out var context);
        return context;
    }
    
    // Thread-safe —É–¥–∞–ª–µ–Ω–∏–µ
    public void RemoveContext(string orderId)
    {
        if (contexts.TryRemove(orderId, out _))
        {
            _ = SaveToBackupAsync();
        }
    }
    
    // Async —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
    private async Task SaveToBackupAsync()
    {
        // –ñ–¥–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Å–µ–º–∞—Ñ–æ—Ä–∞
        await fileLock.WaitAsync();
        
        try
        {
            var contextList = contexts.Values.ToList();
            var json = JsonConvert.SerializeObject(contextList, Formatting.Indented);
            
            // –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å
            var tempPath = backupFilePath + ".tmp";
            await File.WriteAllTextAsync(tempPath, json);
            File.Move(tempPath, backupFilePath, overwrite: true);
            
            logger.LogDebug("Context backup saved: {Count} contexts", contextList.Count);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to save context backup");
        }
        finally
        {
            // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Å–µ–º–∞—Ñ–æ—Ä
            fileLock.Release();
        }
    }
    
    private async Task LoadFromBackupAsync()
    {
        await fileLock.WaitAsync();
        
        try
        {
            if (!File.Exists(backupFilePath))
                return;
            
            var json = await File.ReadAllTextAsync(backupFilePath);
            var loadedContexts = JsonConvert.DeserializeObject<List<LoyaltyContext>>(json);
            
            if (loadedContexts == null)
                return;
            
            foreach (var ctx in loadedContexts)
            {
                contexts.TryAdd(ctx.OrderId, ctx);
            }
            
            logger.LogInformation("Loaded {Count} contexts from backup", loadedContexts.Count);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to load context backup");
        }
        finally
        {
            fileLock.Release();
        }
    }
}
```

**Offline Queue —Å thread-safe –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏:**

```csharp
public class OfflineQueueService
{
    private readonly ConcurrentQueue<OfflineOperation> pendingOperations;
    private readonly SemaphoreSlim processingSemaphore = new SemaphoreSlim(1, 1);
    private readonly SemaphoreSlim fileLock = new SemaphoreSlim(1, 1);
    
    public void EnqueueOperation(OfflineOperation operation)
    {
        pendingOperations.Enqueue(operation);
        
        // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        _ = SaveQueueAsync();
    }
    
    public async Task ProcessQueueAsync(LoyaltyApiClient apiClient)
    {
        // –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
        if (!await processingSemaphore.WaitAsync(0))
        {
            logger.LogWarning("Queue processing already in progress, skipping");
            return;
        }
        
        try
        {
            while (pendingOperations.TryDequeue(out var operation))
            {
                await ProcessOperationAsync(operation, apiClient);
            }
        }
        finally
        {
            processingSemaphore.Release();
        }
    }
}
```

**UI –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ:**

```csharp
public class LoyaltyOperationWindow : LoyaltyWindowBase
{
    private async void OnSpendClick(object sender, RoutedEventArgs e)
    {
        try
        {
            // UI –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ UI thread
            LoadingOverlay.Show("–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤...");
            SpendButton.IsEnabled = false;
            
            // I/O –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ background thread
            var reservation = await Task.Run(async () =>
            {
                return await apiClient.ReservePointsAsync(new ReserveRequest
                {
                    // ...
                });
            });
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ UI thread –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
            await Dispatcher.InvokeAsync(() =>
            {
                LoadingOverlay.Hide();
                
                if (reservation.Success)
                {
                    DialogResult = true;
                    Close();
                }
                else
                {
                    ShowError(reservation.Error);
                    SpendButton.IsEnabled = true;
                }
            });
        }
        catch (Exception ex)
        {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ç–æ–∂–µ –≤ UI thread
            await Dispatcher.InvokeAsync(() =>
            {
                LoadingOverlay.Hide();
                ErrorHandler.Handle(ex, "ApplyPointsPayment");
                SpendButton.IsEnabled = true;
            });
        }
    }
}
```


***

### **–í–û–ü–†–û–° 42: –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**

**–í–û–ü–†–û–°:** –ö–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–∏—Ä–∞—Ç—å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–∏–∫–∞–∫–∏–µ (–ª–æ–≥–æ–≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
- **B)** –¢–æ–ª—å–∫–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
- **C)** –í—Ä–µ–º—è + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ + –æ—à–∏–±–∫–∏
- **D)** –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –º–µ—Ç—Ä–∏–∫ + –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ backend

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –º–µ—Ç—Ä–∏–∫**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:** –í–∏–¥–∏–º —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –∫–∞—Å—Å–∞—Ö
- ‚úÖ **–ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:** –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ–±–ª–µ–º—ã –¥–æ –∂–∞–ª–æ–± –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –î–∞–Ω–Ω—ã–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ **SLA:** –ú–æ–∂–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å quality of service

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class MetricsService
{
    private readonly LoyaltyApiClient apiClient;
    private readonly ILogger logger;
    
    // –õ–æ–∫–∞–ª—å–Ω—ã–π –±—É—Ñ–µ—Ä –º–µ—Ç—Ä–∏–∫ (–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞–∫–µ—Ç–∞–º–∏)
    private readonly ConcurrentQueue<Metric> metricsBuffer;
    private readonly Timer flushTimer;
    
    private const int BUFFER_SIZE = 100;
    private static readonly TimeSpan FLUSH_INTERVAL = TimeSpan.FromSeconds(30);
    
    public MetricsService(LoyaltyApiClient apiClient)
    {
        this.apiClient = apiClient;
        metricsBuffer = new ConcurrentQueue<Metric>();
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Ç—Ä–∏–∫ –Ω–∞ backend
        flushTimer = new Timer(
            callback: async _ => await FlushMetricsAsync(),
            state: null,
            dueTime: FLUSH_INTERVAL,
            period: FLUSH_INTERVAL
        );
    }
    
    // –ó–∞–ø–∏—Å–∞—Ç—å –º–µ—Ç—Ä–∏–∫—É
    public void RecordMetric(
        string name, 
        double value, 
        Dictionary<string, string> tags = null)
    {
        var metric = new Metric
        {
            Name = name,
            Value = value,
            Tags = tags ?? new Dictionary<string, string>(),
            Timestamp = DateTime.UtcNow
        };
        
        metricsBuffer.Enqueue(metric);
        
        // –ï—Å–ª–∏ –±—É—Ñ–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É
        if (metricsBuffer.Count >= BUFFER_SIZE)
        {
            _ = FlushMetricsAsync();
        }
    }
    
    // –ó–∞–ø–∏—Å–∞—Ç—å duration –º–µ—Ç—Ä–∏–∫—É
    public IDisposable MeasureDuration(string operationName, Dictionary<string, string> tags = null)
    {
        return new DurationMeasurement(this, operationName, tags);
    }
    
    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞ backend
    private async Task FlushMetricsAsync()
    {
        if (metricsBuffer.IsEmpty)
            return;
        
        try
        {
            var metrics = new List<Metric>();
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ –±—É—Ñ–µ—Ä–∞
            while (metricsBuffer.TryDequeue(out var metric) && metrics.Count < BUFFER_SIZE)
            {
                metrics.Add(metric);
            }
            
            if (!metrics.Any())
                return;
            
            logger.LogDebug("Flushing {Count} metrics to backend", metrics.Count);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend
            await apiClient.PostAsync("/api/metrics/plugin", new
            {
                restaurantId = configService.GetRestaurantId(),
                metrics = metrics
            });
            
            logger.LogDebug("Metrics flushed successfully");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to flush metrics");
            
            // –ú–µ—Ç—Ä–∏–∫–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã, –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Ä–∞–±–æ—Ç—É
        }
    }
    
    private class DurationMeasurement : IDisposable
    {
        private readonly MetricsService metricsService;
        private readonly string operationName;
        private readonly Dictionary<string, string> tags;
        private readonly Stopwatch stopwatch;
        
        public DurationMeasurement(
            MetricsService metricsService, 
            string operationName,
            Dictionary<string, string> tags)
        {
            this.metricsService = metricsService;
            this.operationName = operationName;
            this.tags = tags ?? new Dictionary<string, string>();
            
            stopwatch = Stopwatch.StartNew();
        }
        
        public void Dispose()
        {
            stopwatch.Stop();
            
            metricsService.RecordMetric(
                $"{operationName}.duration",
                stopwatch.ElapsedMilliseconds,
                tags
            );
        }
    }
}

public class Metric
{
    public string Name { get; set; }
    public double Value { get; set; }
    public Dictionary<string, string> Tags { get; set; }
    public DateTime Timestamp { get; set; }
}
```

**–°–ø–∏—Å–æ–∫ –º–µ—Ç—Ä–∏–∫ –¥–ª—è —Å–±–æ—Ä–∞:**

```csharp
public static class MetricNames
{
    // API –∑–∞–ø—Ä–æ—Å—ã
    public const string ApiRequestDuration = "api.request.duration";
    public const string ApiRequestFailed = "api.request.failed";
    public const string ApiRequestRetry = "api.request.retry";
    
    // –û–ø–µ—Ä–∞—Ü–∏–∏
    public const string OperationDuration = "loyalty.operation.duration";
    public const string OperationSuccess = "loyalty.operation.success";
    public const string OperationFailed = "loyalty.operation.failed";
    
    // Backend —Å—Ç–∞—Ç—É—Å
    public const string BackendStatus = "backend.status"; // 1=online, 0=offline
    public const string BackendResponseTime = "backend.response_time";
    
    // –ö–µ—à
    public const string CacheHit = "cache.hit";
    public const string CacheMiss = "cache.miss";
    public const string CacheSize = "cache.size";
    
    // Offline queue
    public const string OfflineQueueSize = "offline_queue.size";
    public const string OfflineQueueEnqueued = "offline_queue.enqueued";
    public const string OfflineQueueProcessed = "offline_queue.processed";
    public const string OfflineQueueFailed = "offline_queue.failed";
    
    // –ü–∞–º—è—Ç—å
    public const string MemoryWorkingSet = "plugin.memory.working_set";
    public const string MemoryPrivate = "plugin.memory.private";
    public const string MemoryGC = "plugin.memory.gc";
    
    // UI
    public const string WindowOpened = "ui.window.opened";
    public const string WindowClosed = "ui.window.closed";
    public const string ButtonClicked = "ui.button.clicked";
    
    // –û—à–∏–±–∫–∏
    public const string ErrorShown = "error.shown";
    public const string CrashDetected = "crash.detected";
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```csharp
public class LoyaltyOperationService
{
    public async Task<OperationResult> ApplyPointsPaymentAsync(...)
    {
        using (metricsService.MeasureDuration("apply_points_payment", new Dictionary<string, string>
        {
            ["restaurant_id"] = restaurantId
        }))
        {
            try
            {
                // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
                var result = await DoApplyPointsPaymentAsync(...);
                
                // –ú–µ—Ç—Ä–∏–∫–∞ —É—Å–ø–µ—Ö–∞
                metricsService.RecordMetric(
                    MetricNames.OperationSuccess,
                    1,
                    tags: new Dictionary<string, string>
                    {
                        ["operation"] = "apply_points_payment"
                    }
                );
                
                return result;
            }
            catch (Exception ex)
            {
                // –ú–µ—Ç—Ä–∏–∫–∞ –æ—à–∏–±–∫–∏
                metricsService.RecordMetric(
                    MetricNames.OperationFailed,
                    1,
                    tags: new Dictionary<string, string>
                    {
                        ["operation"] = "apply_points_payment",
                        ["error_type"] = ex.GetType().Name
                    }
                );
                
                throw;
            }
        }
    }
}
```

**Backend dashboard (Grafana):**

```typescript
// Backend endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫
@Get('metrics/restaurants/:id')
async getRestaurantMetrics(
  @Param('id') restaurantId: string,
  @Query() query: MetricsQuery
) {
  const metrics = await this.prisma.pluginMetric.groupBy({
    by: ['name', 'tags'],
    where: {
      restaurantId,
      timestamp: {
        gte: query.startDate,
        lte: query.endDate
      }
    },
    _avg: { value: true },
    _max: { value: true },
    _min: { value: true },
    _count: { value: true }
  });
  
  return metrics;
}
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –±–ª–æ–∫–æ–º 7 (–î–µ–ø–ª–æ–π, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ - 8 –≤–æ–ø—Ä–æ—Å–æ–≤)?

---

## **üöÄ –ë–õ–û–ö 7: –î–ï–ü–õ–û–ô, –£–°–¢–ê–ù–û–í–ö–ê –ò –ü–û–î–î–ï–†–ñ–ö–ê (8 –≤–æ–ø—Ä–æ—Å–æ–≤)**


***

### **–í–û–ü–†–û–° 43: –ü—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–≥–∏–Ω–∞**

**–í–û–ü–†–û–°:** –ö–∞–∫ Admin —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–ª–∞–≥–∏–Ω –Ω–∞ –∫–∞—Å—Å—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –°–∫–∞—á–∏–≤–∞–µ—Ç DLL, –∫–æ–ø–∏—Ä—É–µ—Ç –≤ –ø–∞–ø–∫—É iiko, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç
- **B)** –ó–∞–ø—É—Å–∫–∞–µ—Ç installer.exe —Å GUI wizard
- **C)** Installer.exe —Å –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º + silent —Ä–µ–∂–∏–º
- **D)** Remote —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∑ Admin Panel Max Loyalty

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) Smart installer —Å GUI + silent —Ä–µ–∂–∏–º**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** GUI wizard –ø–æ–Ω—è—Ç–µ–Ω –ª—é–±–æ–º—É –∞–¥–º–∏–Ω—É
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:** Silent —Ä–µ–∂–∏–º –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
- ‚úÖ **–û—Ç–∫–∞—Ç:** –ú–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
// MaxLoyaltyInstaller.exe
public class InstallerProgram
{
    [STAThread]
    static async Task Main(string[] args)
    {
        // –ü–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
        var config = ParseArguments(args);
        
        if (config.SilentMode)
        {
            // Silent —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (–¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –¥–µ–ø–ª–æ—è)
            await PerformSilentInstallAsync(config);
        }
        else
        {
            // GUI wizard
            var app = new Application();
            var wizard = new InstallationWizard(config);
            app.Run(wizard);
        }
    }
    
    private static InstallerConfig ParseArguments(string[] args)
    {
        var config = new InstallerConfig();
        
        for (int i = 0; i < args.Length; i++)
        {
            switch (args[i].ToLower())
            {
                case "/silent":
                case "-s":
                    config.SilentMode = true;
                    break;
                    
                case "/apikey":
                case "-k":
                    config.ApiKey = args[++i];
                    break;
                    
                case "/iikopath":
                case "-p":
                    config.IikoPath = args[++i];
                    break;
                    
                case "/update":
                case "-u":
                    config.UpdateMode = true;
                    break;
                    
                case "/uninstall":
                    config.UninstallMode = true;
                    break;
            }
        }
        
        return config;
    }
}

public class InstallationWizard : Window
{
    private readonly InstallerConfig config;
    private int currentStep = 0;
    
    // –®–∞–≥–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    private readonly List<IInstallationStep> steps;
    
    public InstallationWizard(InstallerConfig config)
    {
        this.config = config;
        
        Title = "Max Loyalty - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è iiko";
        Width = 700;
        Height = 500;
        WindowStartupLocation = WindowStartupLocation.CenterScreen;
        ResizeMode = ResizeMode.NoResize;
        
        // –°–æ–∑–¥–∞–µ–º —à–∞–≥–∏
        steps = new List<IInstallationStep>
        {
            new WelcomeStep(),
            new DetectIikoStep(),
            new ConfigureProductsStep(),
            new InstallFilesStep(),
            new TestConnectionStep(),
            new CompletionStep()
        };
        
        InitializeUI();
        ShowStep(0);
    }
    
    private void InitializeUI()
    {
        var mainGrid = new Grid();
        
        mainGrid.RowDefinitions.Add(new RowDefinition { Height = new GridLength(80) }); // Header
        mainGrid.RowDefinitions.Add(new RowDefinition { Height = new GridLength(1, GridUnitType.Star) }); // Content
        mainGrid.RowDefinitions.Add(new RowDefinition { Height = new GridLength(60) }); // Footer
        
        // Header
        var header = new Border
        {
            Background = new SolidColorBrush(Color.FromRgb(30, 64, 175)),
            Child = new StackPanel
            {
                Margin = new Thickness(30, 15, 30, 15),
                Children =
                {
                    new TextBlock
                    {
                        Text = "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Max Loyalty –¥–ª—è iiko",
                        FontSize = 20,
                        FontWeight = FontWeights.Bold,
                        Foreground = Brushes.White
                    },
                    new TextBlock
                    {
                        Text = "–°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–≥–∏–Ω–∞",
                        FontSize = 12,
                        Foreground = new SolidColorBrush(Color.FromRgb(219, 234, 254)),
                        Margin = new Thickness(0, 5, 0, 0)
                    }
                }
            }
        };
        Grid.SetRow(header, 0);
        mainGrid.Children.Add(header);
        
        // Content area
        contentArea = new ContentControl
        {
            Margin = new Thickness(30)
        };
        Grid.SetRow(contentArea, 1);
        mainGrid.Children.Add(contentArea);
        
        // Footer (–∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
        var footer = new Border
        {
            BorderThickness = new Thickness(0, 1, 0, 0),
            BorderBrush = new SolidColorBrush(Color.FromRgb(229, 231, 235)),
            Child = new StackPanel
            {
                Orientation = Orientation.Horizontal,
                HorizontalAlignment = HorizontalAlignment.Right,
                Margin = new Thickness(30, 15, 30, 15),
                Children =
                {
                    (backButton = new Button
                    {
                        Content = "< –ù–∞–∑–∞–¥",
                        Width = 100,
                        Margin = new Thickness(0, 0, 10, 0),
                        IsEnabled = false
                    }),
                    (nextButton = new Button
                    {
                        Content = "–î–∞–ª–µ–µ >",
                        Width = 100,
                        Margin = new Thickness(0, 0, 10, 0)
                    }),
                    (cancelButton = new Button
                    {
                        Content = "–û—Ç–º–µ–Ω–∞",
                        Width = 100
                    })
                }
            }
        };
        Grid.SetRow(footer, 2);
        mainGrid.Children.Add(footer);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        backButton.Click += (s, e) => ShowStep(currentStep - 1);
        nextButton.Click += async (s, e) => await OnNextClickAsync();
        cancelButton.Click += (s, e) => OnCancelClick();
        
        Content = mainGrid;
    }
    
    private void ShowStep(int stepIndex)
    {
        if (stepIndex < 0 || stepIndex >= steps.Count)
            return;
        
        currentStep = stepIndex;
        var step = steps[currentStep];
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º UI —à–∞–≥–∞
        contentArea.Content = step.GetContent(config);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        backButton.IsEnabled = currentStep > 0;
        nextButton.Content = currentStep == steps.Count - 1 ? "–ó–∞–≤–µ—Ä—à–∏—Ç—å" : "–î–∞–ª–µ–µ >";
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —à–∞–≥–∞
        headerTitle.Text = step.Title;
        headerSubtitle.Text = step.Subtitle;
    }
    
    private async Task OnNextClickAsync()
    {
        var step = steps[currentStep];
        
        try
        {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —à–∞–≥–∞
            var validationResult = await step.ValidateAsync(config);
            
            if (!validationResult.IsValid)
            {
                MessageBox.Show(
                    validationResult.ErrorMessage,
                    "–û—à–∏–±–∫–∞",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning
                );
                return;
            }
            
            // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —à–∞–≥–∞
            var executeResult = await step.ExecuteAsync(config);
            
            if (!executeResult.Success)
            {
                MessageBox.Show(
                    executeResult.ErrorMessage,
                    "–û—à–∏–±–∫–∞",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error
                );
                return;
            }
            
            // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
            if (currentStep < steps.Count - 1)
            {
                ShowStep(currentStep + 1);
            }
            else
            {
                // –ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥ - –∑–∞–∫—Ä—ã–≤–∞–µ–º
                DialogResult = true;
                Close();
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show(
                $"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:\n\n{ex.Message}",
                "–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
}

// –®–∞–≥ 1: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
public class WelcomeStep : IInstallationStep
{
    public string Title => "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å";
    public string Subtitle => "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ Max Loyalty –¥–ª—è iiko Front";
    
    public UIElement GetContent(InstallerConfig config)
    {
        return new StackPanel
        {
            Children =
            {
                new TextBlock
                {
                    Text = "–≠—Ç–æ—Ç –º–∞—Å—Ç–µ—Ä –ø–æ–º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–≥–∏–Ω Max Loyalty –Ω–∞ –≤–∞—à—É –∫–∞—Å—Å—É.",
                    TextWrapping = TextWrapping.Wrap,
                    FontSize = 14,
                    Margin = new Thickness(0, 0, 0, 20)
                },
                new TextBlock
                {
                    Text = "–ß—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ:",
                    FontWeight = FontWeights.Bold,
                    Margin = new Thickness(0, 0, 0, 10)
                },
                new StackPanel
                {
                    Margin = new Thickness(20, 0, 0, 0),
                    Children =
                    {
                        new TextBlock { Text = "‚úì –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ iiko Front" },
                        new TextBlock { Text = "‚úì –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–ª–∞–≥–∏–Ω–∞" },
                        new TextBlock { Text = "‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤ iiko" },
                        new TextBlock { Text = "‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É Max Loyalty" },
                        new TextBlock { Text = "‚úì –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –ø–ª–∞–≥–∏–Ω–∞" }
                    }
                },
                new Border
                {
                    Background = new SolidColorBrush(Color.FromRgb(254, 243, 199)),
                    BorderBrush = new SolidColorBrush(Color.FromRgb(251, 191, 36)),
                    BorderThickness = new Thickness(1),
                    CornerRadius = new CornerRadius(6),
                    Padding = new Thickness(15),
                    Margin = new Thickness(0, 20, 0, 0),
                    Child = new StackPanel
                    {
                        Children =
                        {
                            new TextBlock
                            {
                                Text = "‚ö†Ô∏è –í–∞–∂–Ω–æ:",
                                FontWeight = FontWeights.Bold,
                                Foreground = new SolidColorBrush(Color.FromRgb(120, 53, 15))
                            },
                            new TextBlock
                            {
                                Text = "–ü–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∑–∞–∫—Ä–æ–π—Ç–µ iiko Front –Ω–∞ —ç—Ç–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.",
                                TextWrapping = TextWrapping.Wrap,
                                Foreground = new SolidColorBrush(Color.FromRgb(120, 53, 15)),
                                Margin = new Thickness(0, 5, 0, 0)
                            }
                        }
                    }
                }
            }
        };
    }
    
    public Task<ValidationResult> ValidateAsync(InstallerConfig config)
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ iiko –Ω–µ –∑–∞–ø—É—â–µ–Ω
        var iikoProcesses = Process.GetProcessesByName("iiko");
        
        if (iikoProcesses.Any())
        {
            return Task.FromResult(ValidationResult.Error(
                "iiko Front –∑–∞–ø—É—â–µ–Ω.\n\n" +
                "–ó–∞–∫—Ä–æ–π—Ç–µ iiko –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏."
            ));
        }
        
        return Task.FromResult(ValidationResult.Success());
    }
    
    public Task<ExecutionResult> ExecuteAsync(InstallerConfig config)
    {
        // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º –Ω–∞ —ç—Ç–æ–º —à–∞–≥–µ
        return Task.FromResult(ExecutionResult.Success());
    }
}

// –®–∞–≥ 2: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ iiko
public class DetectIikoStep : IInstallationStep
{
    public string Title => "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ iiko Front";
    public string Subtitle => "–ü–æ–∏—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ iiko Front";
    
    private TextBox pathTextBox;
    
    public UIElement GetContent(InstallerConfig config)
    {
        var panel = new StackPanel();
        
        panel.Children.Add(new TextBlock
        {
            Text = "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ iiko Front...",
            Margin = new Thickness(0, 0, 0, 20)
        });
        
        // –ü–æ–ª–µ —Å –ø—É—Ç–µ–º
        panel.Children.Add(new TextBlock
        {
            Text = "–ü—É—Ç—å –∫ iiko Front:",
            FontWeight = FontWeights.Bold,
            Margin = new Thickness(0, 0, 0, 5)
        });
        
        var pathGrid = new Grid();
        pathGrid.ColumnDefinitions.Add(new ColumnDefinition { Width = new GridLength(1, GridUnitType.Star) });
        pathGrid.ColumnDefinitions.Add(new ColumnDefinition { Width = new GridLength(100) });
        
        pathTextBox = new TextBox
        {
            Text = config.IikoPath ?? DetectIikoPath(),
            Margin = new Thickness(0, 0, 10, 0),
            VerticalContentAlignment = VerticalAlignment.Center,
            Height = 35
        };
        Grid.SetColumn(pathTextBox, 0);
        pathGrid.Children.Add(pathTextBox);
        
        var browseButton = new Button
        {
            Content = "–û–±–∑–æ—Ä...",
            Height = 35
        };
        browseButton.Click += OnBrowseClick;
        Grid.SetColumn(browseButton, 1);
        pathGrid.Children.Add(browseButton);
        
        panel.Children.Add(pathGrid);
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏
        if (!string.IsNullOrEmpty(pathTextBox.Text))
        {
            var version = GetIikoVersion(pathTextBox.Text);
            
            if (version != null)
            {
                panel.Children.Add(new Border
                {
                    Background = new SolidColorBrush(Color.FromRgb(240, 253, 244)),
                    BorderBrush = new SolidColorBrush(Color.FromRgb(16, 185, 129)),
                    BorderThickness = new Thickness(1),
                    CornerRadius = new CornerRadius(6),
                    Padding = new Thickness(15),
                    Margin = new Thickness(0, 15, 0, 0),
                    Child = new TextBlock
                    {
                        Text = $"‚úì –ù–∞–π–¥–µ–Ω–∞ –≤–µ—Ä—Å–∏—è iiko Front: {version}",
                        Foreground = new SolidColorBrush(Color.FromRgb(6, 78, 59))
                    }
                });
            }
        }
        
        return panel;
    }
    
    private string DetectIikoPath()
    {
        // –õ–æ–≥–∏–∫–∞ –∏–∑ –≤–æ–ø—Ä–æ—Å–∞ 2
        var detector = new IikoPathDetector();
        return detector.DetectIikoPath();
    }
    
    private void OnBrowseClick(object sender, RoutedEventArgs e)
    {
        var dialog = new FolderBrowserDialog
        {
            Description = "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ iiko Front"
        };
        
        if (dialog.ShowDialog() == DialogResult.OK)
        {
            pathTextBox.Text = dialog.SelectedPath;
        }
    }
    
    public Task<ValidationResult> ValidateAsync(InstallerConfig config)
    {
        config.IikoPath = pathTextBox.Text;
        
        if (string.IsNullOrEmpty(config.IikoPath))
        {
            return Task.FromResult(ValidationResult.Error("–£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ iiko Front"));
        }
        
        if (!Directory.Exists(config.IikoPath))
        {
            return Task.FromResult(ValidationResult.Error("–£–∫–∞–∑–∞–Ω–Ω–∞—è –ø–∞–ø–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"));
        }
        
        var exePath = Path.Combine(config.IikoPath, "iiko.exe");
        if (!File.Exists(exePath))
        {
            return Task.FromResult(ValidationResult.Error(
                "–í —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª iiko.exe"
            ));
        }
        
        return Task.FromResult(ValidationResult.Success());
    }
    
    public Task<ExecutionResult> ExecuteAsync(InstallerConfig config)
    {
        return Task.FromResult(ExecutionResult.Success());
    }
}

// –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
public class ConfigureProductsStep : IInstallationStep
{
    public string Title => "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ iiko";
    public string Subtitle => "–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø–ª–∞–≥–∏–Ω–∞";
    
    public UIElement GetContent(InstallerConfig config)
    {
        return new StackPanel
        {
            Children =
            {
                new TextBlock
                {
                    Text = "–î–ª—è —Ä–∞–±–æ—Ç—ã –ø–ª–∞–≥–∏–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å –¥–≤–∞ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞ –≤ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–µ iiko:",
                    TextWrapping = TextWrapping.Wrap,
                    Margin = new Thickness(0, 0, 0, 20)
                },
                
                new Border
                {
                    BorderBrush = Brushes.LightGray,
                    BorderThickness = new Thickness(1),
                    CornerRadius = new CornerRadius(6),
                    Padding = new Thickness(15),
                    Margin = new Thickness(0, 0, 0, 15),
                    Child = new StackPanel
                    {
                        Children =
                        {
                            new TextBlock
                            {
                                Text = "1. –û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ Max Loyalty",
                                FontWeight = FontWeights.Bold,
                                Margin = new Thickness(0, 0, 0, 5)
                            },
                            new TextBlock { Text = "‚Ä¢ –¶–µ–Ω–∞: 0 ‚ÇΩ" },
                            new TextBlock { Text = "‚Ä¢ –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ü–µ–Ω—ã: —Ä–∞–∑—Ä–µ—à–µ–Ω" },
                            new TextBlock { Text = "‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –°–ª—É–∂–µ–±–Ω—ã–µ" },
                            new TextBlock { Text = "‚Ä¢ –ù–î–°: –ë–µ–∑ –ù–î–°" }
                        }
                    }
                },
                
                new Border
                {
                    BorderBrush = Brushes.LightGray,
                    BorderThickness = new Thickness(1),
                    CornerRadius = new CornerRadius(6),
                    Padding = new Thickness(15),
                    Margin = new Thickness(0, 0, 0, 20),
                    Child = new StackPanel
                    {
                        Children =
                        {
                            new TextBlock
                            {
                                Text = "2. –°–∫–∏–¥–∫–∞ —É—Ä–æ–≤–Ω—è Max Loyalty",
                                FontWeight = FontWeights.Bold,
                                Margin = new Thickness(0, 0, 0, 5)
                            },
                            new TextBlock { Text = "‚Ä¢ –¶–µ–Ω–∞: 0 ‚ÇΩ" },
                            new TextBlock { Text = "‚Ä¢ –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ü–µ–Ω—ã: —Ä–∞–∑—Ä–µ—à–µ–Ω" },
                            new TextBlock { Text = "‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –°–ª—É–∂–µ–±–Ω—ã–µ" },
                            new TextBlock { Text = "‚Ä¢ –ù–î–°: –ë–µ–∑ –ù–î–°" }
                        }
                    }
                },
                
                new CheckBox
                {
                    Content = "–¢–æ–≤–∞—Ä—ã —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã –≤ iiko",
                    IsChecked = false,
                    Margin = new Thickness(0, 0, 0, 15)
                },
                
                new Border
                {
                    Background = new SolidColorBrush(Color.FromRgb(239, 246, 255)),
                    BorderBrush = new SolidColorBrush(Color.FromRgb(59, 130, 246)),
                    BorderThickness = new Thickness(1),
                    CornerRadius = new CornerRadius(6),
                    Padding = new Thickness(15),
                    Child = new StackPanel
                    {
                        Children =
                        {
                            new TextBlock
                            {
                                Text = "üí° –°–æ–≤–µ—Ç:",
                                FontWeight = FontWeights.Bold,
                                Foreground = new SolidColorBrush(Color.FromRgb(30, 58, 138))
                            },
                            new TextBlock
                            {
                                Text = "–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–≥–∏–Ω–∞, —É–∫–∞–∂–∏—Ç–µ ID —ç—Ç–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–ª–∞–≥–∏–Ω–∞ —á–µ—Ä–µ–∑ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ (Ctrl+Shift+D).",
                                TextWrapping = TextWrapping.Wrap,
                                Foreground = new SolidColorBrush(Color.FromRgb(30, 58, 138)),
                                Margin = new Thickness(0, 5, 0, 0)
                            }
                        }
                    }
                }
            }
        };
    }
    
    public Task<ValidationResult> ValidateAsync(InstallerConfig config)
    {
        return Task.FromResult(ValidationResult.Success());
    }
    
    public Task<ExecutionResult> ExecuteAsync(InstallerConfig config)
    {
        return Task.FromResult(ExecutionResult.Success());
    }
}

// –®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤
public class InstallFilesStep : IInstallationStep
{
    public string Title => "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤";
    public string Subtitle => "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–ª–∞–≥–∏–Ω–∞";
    
    private ProgressBar progressBar;
    private TextBlock statusText;
    
    public UIElement GetContent(InstallerConfig config)
    {
        var panel = new StackPanel();
        
        statusText = new TextBlock
        {
            Text = "–ì–æ—Ç–æ–≤ –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ",
            Margin = new Thickness(0, 0, 0, 20)
        };
        panel.Children.Add(statusText);
        
        progressBar = new ProgressBar
        {
            Height = 25,
            Minimum = 0,
            Maximum = 100,
            Value = 0
        };
        panel.Children.Add(progressBar);
        
        return panel;
    }
    
    public Task<ValidationResult> ValidateAsync(InstallerConfig config)
    {
        return Task.FromResult(ValidationResult.Success());
    }
    
    public async Task<ExecutionResult> ExecuteAsync(InstallerConfig config)
    {
        try
        {
            // 1. –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É Plugins –µ—Å–ª–∏ –Ω–µ—Ç
            UpdateStatus("–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –ø–ª–∞–≥–∏–Ω–æ–≤...", 10);
            
            var pluginsPath = Path.Combine(config.IikoPath, "Plugins");
            Directory.CreateDirectory(pluginsPath);
            
            await Task.Delay(500); // –î–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ feedback
            
            // 2. –ö–æ–ø–∏—Ä—É–µ–º DLL –ø–ª–∞–≥–∏–Ω–∞
            UpdateStatus("–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ MaxLoyaltyIikoPlugin.dll...", 30);
            
            var sourceDll = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "MaxLoyaltyIikoPlugin.dll");
            var targetDll = Path.Combine(pluginsPath, "MaxLoyaltyIikoPlugin.dll");
            
            File.Copy(sourceDll, targetDll, overwrite: true);
            
            await Task.Delay(500);
            
            // 3. –ö–æ–ø–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            UpdateStatus("–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...", 50);
            
            var dependencies = new[] { "Newtonsoft.Json.dll", "Serilog.dll", "Serilog.Sinks.File.dll" };
            
            foreach (var dep in dependencies)
            {
                var sourcePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, dep);
                var targetPath = Path.Combine(pluginsPath, dep);
                
                if (File.Exists(sourcePath))
                {
                    File.Copy(sourcePath, targetPath, overwrite: true);
                }
            }
            
            await Task.Delay(500);
            
            // 4. –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            UpdateStatus("–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...", 70);
            
            var appDataPath = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                "MaxLoyaltyIiko"
            );
            
            Directory.CreateDirectory(appDataPath);
            
            var configPath = Path.Combine(appDataPath, "config.json.encrypted");
            
            var pluginConfig = new PluginConfig
            {
                ApiKey = config.ApiKey,
                ApiUrl = "https://api.maxloyalty.ru",
                RestaurantId = config.RestaurantId,
                Version = "1.0.0",
                InstalledAt = DateTime.UtcNow
            };
            
            var json = JsonConvert.SerializeObject(pluginConfig);
            var encrypted = EncryptionService.Encrypt(json, GetMachineId());
            
            File.WriteAllText(configPath, encrypted);
            
            await Task.Delay(500);
            
            // 5. –ó–∞–≤–µ—Ä—à–µ–Ω–æ
            UpdateStatus("–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!", 100);
            
            return ExecutionResult.Success();
        }
        catch (Exception ex)
        {
            return ExecutionResult.Error($"–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏: {ex.Message}");
        }
    }
    
    private void UpdateStatus(string text, int progress)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            statusText.Text = text;
            progressBar.Value = progress;
        });
    }
}

// –®–∞–≥ 5: –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
public class TestConnectionStep : IInstallationStep
{
    public string Title => "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
    public string Subtitle => "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º Max Loyalty";
    
    private TextBlock resultText;
    
    public UIElement GetContent(InstallerConfig config)
    {
        var panel = new StackPanel();
        
        panel.Children.Add(new TextBlock
        {
            Text = "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É...",
            Margin = new Thickness(0, 0, 0, 20)
        });
        
        var spinner = new LoadingSpinner
        {
            Width = 40,
            Height = 40,
            HorizontalAlignment = HorizontalAlignment.Center,
            Margin = new Thickness(0, 20, 0, 20)
        };
        panel.Children.Add(spinner);
        
        resultText = new TextBlock
        {
            TextWrapping = TextWrapping.Wrap,
            HorizontalAlignment = HorizontalAlignment.Center
        };
        panel.Children.Add(resultText);
        
        return panel;
    }
    
    public Task<ValidationResult> ValidateAsync(InstallerConfig config)
    {
        return Task.FromResult(ValidationResult.Success());
    }
    
    public async Task<ExecutionResult> ExecuteAsync(InstallerConfig config)
    {
        try
        {
            using var httpClient = new HttpClient();
            httpClient.DefaultRequestHeaders.Add("X-API-Key", config.ApiKey);
            httpClient.Timeout = TimeSpan.FromSeconds(10);
            
            var response = await httpClient.GetAsync($"{config.ApiUrl}/api/health");
            
            if (response.IsSuccessStatusCode)
            {
                Application.Current.Dispatcher.Invoke(() =>
                {
                    resultText.Text = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!\n\n–°–µ—Ä–≤–µ—Ä Max Loyalty –¥–æ—Å—Ç—É–ø–µ–Ω.";
                    resultText.Foreground = Brushes.Green;
                });
                
                return ExecutionResult.Success();
            }
            else
            {
                Application.Current.Dispatcher.Invoke(() =>
                {
                    resultText.Text = $"‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: {response.StatusCode}\n\n" +
                                     "–ü–ª–∞–≥–∏–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.";
                    resultText.Foreground = Brushes.Orange;
                });
                
                return ExecutionResult.Success(); // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
            }
        }
        catch (Exception ex)
        {
            Application.Current.Dispatcher.Invoke(() =>
            {
                resultText.Text = $"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:\n\n{ex.Message}\n\n" +
                                 "–ü–ª–∞–≥–∏–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.";
                resultText.Foreground = Brushes.Red;
            });
            
            return ExecutionResult.Success(); // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
        }
    }
}

// –®–∞–≥ 6: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
public class CompletionStep : IInstallationStep
{
    public string Title => "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞";
    public string Subtitle => "–ü–ª–∞–≥–∏–Ω Max Loyalty —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω";
    
    public UIElement GetContent(InstallerConfig config)
    {
        return new StackPanel
        {
            Children =
            {
                new TextBlock
                {
                    Text = "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!",
                    FontSize = 18,
                    FontWeight = FontWeights.Bold,
                    Foreground = Brushes.Green,
                    HorizontalAlignment = HorizontalAlignment.Center,
                    Margin = new Thickness(0, 20, 0, 30)
                },
                
                new TextBlock
                {
                    Text = "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:",
                    FontWeight = FontWeights.Bold,
                    Margin = new Thickness(0, 0, 0, 10)
                },
                
                new StackPanel
                {
                    Margin = new Thickness(20, 0, 0, 20),
                    Children =
                    {
                        new TextBlock { Text = "1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front" },
                        new TextBlock { Text = "2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –Ω–∞ –∫–∞—Å—Å–µ –ø–æ—è–≤–∏–ª–∞—Å—å –∫–Ω–æ–ø–∫–∞ \"Max Loyalty\"" },
                        new TextBlock { Text = "3. –°–æ–∑–¥–∞–π—Ç–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–µ iiko" },
                        new TextBlock { Text = "4. –ù–∞–∂–º–∏—Ç–µ Ctrl+Shift+D –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏" },
                        new TextBlock { Text = "5. –£–∫–∞–∂–∏—Ç–µ ID —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö" }
                    }
                },
                
                new Border
                {
                    Background = new SolidColorBrush(Color.FromRgb(239, 246, 255)),
                    BorderBrush = new SolidColorBrush(Color.FromRgb(59, 130, 246)),
                    BorderThickness = new Thickness(1),
                    CornerRadius = new CornerRadius(6),
                    Padding = new Thickness(15),
                    Child = new StackPanel
                    {
                        Children =
                        {
                            new TextBlock
                            {
                                Text = "üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:",
                                FontWeight = FontWeights.Bold,
                                Foreground = new SolidColorBrush(Color.FromRgb(30, 58, 138)),
                                Margin = new Thickness(0, 0, 0, 5)
                            },
                            new TextBlock
                            {
                                Text = "–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É:\nhttps://docs.maxloyalty.ru/iiko-plugin",
                                TextWrapping = TextWrapping.Wrap,
                                Foreground = new SolidColorBrush(Color.FromRgb(30, 58, 138))
                            }
                        }
                    }
                }
            }
        };
    }
    
    public Task<ValidationResult> ValidateAsync(InstallerConfig config)
    {
        return Task.FromResult(ValidationResult.Success());
    }
    
    public Task<ExecutionResult> ExecuteAsync(InstallerConfig config)
    {
        return Task.FromResult(ExecutionResult.Success());
    }
}
```


***

### **–í–û–ü–†–û–° 44: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤**

**–í–û–ü–†–û–°:** –ö–∞–∫—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –¢–æ–ª—å–∫–æ README.txt —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
- **B)** PDF —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –Ω–∞ 20+ —Å—Ç—Ä–∞–Ω–∏—Ü
- **C)** –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –æ–Ω–ª–∞–π–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è + –≤–∏–¥–µ–æ–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- **D)** –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ –≤ –ø–ª–∞–≥–∏–Ω–µ + –æ–Ω–ª–∞–π–Ω –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) –û–Ω–ª–∞–π–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è + –≤–∏–¥–µ–æ**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å:** –ú–æ–∂–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å –±–µ–∑ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–≥–∏–Ω–∞
- ‚úÖ **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:** –î–æ—Å—Ç—É–ø–Ω–∞ —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- ‚úÖ **–ü–æ–∏—Å–∫:** –õ–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- ‚úÖ **–í–∏–∑—É–∞–ª—å–Ω–æ—Å—Ç—å:** –í–∏–¥–µ–æ –ø–æ–Ω—è—Ç–Ω–µ–µ —Ç–µ–∫—Å—Ç–∞
- ‚úÖ **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:** FAQ, –ø–æ–∏—Å–∫, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**

```
https://docs.maxloyalty.ru/iiko-plugin/

‚îú‚îÄ‚îÄ –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞
‚îÇ   ‚îú‚îÄ‚îÄ –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ –í–∏–¥–µ–æ: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞ 5 –º–∏–Ω—É—Ç
‚îÇ
‚îú‚îÄ‚îÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ iiko
‚îÇ   ‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
‚îÇ   ‚îú‚îÄ‚îÄ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–µ–Ω—é
‚îÇ   ‚îî‚îÄ‚îÄ –í–∏–¥–µ–æ: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ –†–∞–±–æ—Ç–∞ —Å –ø–ª–∞–≥–∏–Ω–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è
‚îÇ   ‚îú‚îÄ‚îÄ –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ –û—Ç–º–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ –í–∏–¥–µ–æ: –¢–∏–ø–∏—á–Ω—ã–π workflow
‚îÇ
‚îú‚îÄ‚îÄ Offline —Ä–µ–∂–∏–º
‚îÇ   ‚îú‚îÄ‚îÄ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç offline
‚îÇ   ‚îú‚îÄ‚îÄ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ FAQ
‚îÇ
‚îú‚îÄ‚îÄ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
‚îÇ   ‚îú‚îÄ‚îÄ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ
‚îÇ   ‚îú‚îÄ‚îÄ –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ –õ–æ–≥–∏ –ø–ª–∞–≥–∏–Ω–∞
‚îÇ   ‚îú‚îÄ‚îÄ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏...
‚îÇ   ‚îî‚îÄ‚îÄ –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
‚îÇ
‚îú‚îÄ‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞
‚îÇ   ‚îú‚îÄ‚îÄ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ –£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞
‚îÇ   ‚îî‚îÄ‚îÄ –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π
‚îÇ
‚îî‚îÄ‚îÄ API Reference (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
    ‚îú‚îÄ‚îÄ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
    ‚îú‚îÄ‚îÄ –°–æ–±—ã—Ç–∏—è
    ‚îú‚îÄ‚îÄ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    ‚îî‚îÄ‚îÄ Troubleshooting
```

**–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**

```markdown
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ Max Loyalty –¥–ª—è iiko

–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 17.02.2026

## –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:** Windows 10/11 (64-bit)
- **iiko Front:** –í–µ—Ä—Å–∏—è 7.5 –∏–ª–∏ –≤—ã—à–µ
- **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É:** –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ (–¥–ª—è online —Ä–µ–∂–∏–º–∞)
- **–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:** –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä Windows

## –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–æ—á–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

1. –í–æ–π–¥–∏—Ç–µ –≤ [Admin Panel Max Loyalty](https://admin.maxloyalty.ru)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** ‚Üí **iiko Front**
3. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **–°–∫–∞—á–∞—Ç—å installer**
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª `MaxLoyaltyInstaller_–†–µ—Å—Ç–•–•–•.exe`

> **üí° –í–∞–∂–Ω–æ:** –ö–∞–∂–¥—ã–π installer —É–Ω–∏–∫–∞–ª–µ–Ω –¥–ª—è –≤–∞—à–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç API –∫–ª—é—á.

## –®–∞–≥ 2: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

–ü–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π:

1. ‚úÖ –ó–∞–∫—Ä–æ–π—Ç–µ iiko Front –Ω–∞ –≤—Å–µ—Ö –∫–∞—Å—Å–∞—Ö
2. ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
3. ‚úÖ –ò–º–µ–µ—Ç–µ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ Windows

## –®–∞–≥ 3: –ó–∞–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `MaxLoyaltyInstaller_–†–µ—Å—Ç–•–•–•.exe`
2. –ï—Å–ª–∏ Windows –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–∑–¥–∞—Ç–µ–ª—å":
   - –ù–∞–∂–º–∏—Ç–µ **–ü–æ–¥—Ä–æ–±–Ω–µ–µ**
   - –ù–∞–∂–º–∏—Ç–µ **–í—ã–ø–æ–ª–Ω–∏—Ç—å –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ**

![](screenshots/windows-warning.png)

## –®–∞–≥ 4: –ú–∞—Å—Ç–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∫–∏

–°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –º–∞—Å—Ç–µ—Ä–∞:

### 4.1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ

- –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –ù–∞–∂–º–∏—Ç–µ **–î–∞–ª–µ–µ**

![](screenshots/step-1-welcome.png)

### 4.2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ iiko

- Installer –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç iiko Front
- –ï—Å–ª–∏ –ø—É—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–π, –Ω–∞–∂–º–∏—Ç–µ **–û–±–∑–æ—Ä** –∏ —É–∫–∞–∂–∏—Ç–µ –≤—Ä—É—á–Ω—É—é
- –ù–∞–∂–º–∏—Ç–µ **–î–∞–ª–µ–µ**

![](screenshots/step-2-detect.png)

### 4.3. –°–ª—É–∂–µ–±–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã

- –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç–æ–≤–∞—Ä–∞–º
- –ù–∞–∂–º–∏—Ç–µ **–î–∞–ª–µ–µ** (—Ç–æ–≤–∞—Ä—ã —Å–æ–∑–¥–∞–¥–∏–º –ø–æ–∑–∂–µ)

![](screenshots/step-3-products.png)

### 4.4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤

- –î–æ–∂–¥–∏—Ç–µ—Å—å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
- –≠—Ç–æ –∑–∞–π–º–µ—Ç ~30 —Å–µ–∫—É–Ω–¥

![](screenshots/step-4-install.png)

### 4.5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

- Installer –ø—Ä–æ–≤–µ—Ä–∏—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
- –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç

![](screenshots/step-5-test.png)

### 4.6. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ

- –ù–∞–∂–º–∏—Ç–µ **–ó–∞–≤–µ—Ä—à–∏—Ç—å**
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!

![](screenshots/step-6-complete.png)

## –®–∞–≥ 5: –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤

–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–∑–¥–∞–π—Ç–µ –≤ iiko –¥–≤–∞ —Ç–æ–≤–∞—Ä–∞:

### –¢–æ–≤–∞—Ä 1: "–û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ Max Loyalty"

1. –û—Ç–∫—Ä–æ–π—Ç–µ **iiko Office** ‚Üí **–ú–µ–Ω—é –∏ —Å–∫–ª–∞–¥** ‚Üí **–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞**
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä:
   - **–ù–∞–∑–≤–∞–Ω–∏–µ:** –û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ Max Loyalty
   - **–ê—Ä—Ç–∏–∫—É–ª:** MAX_LOYALTY_POINTS
   - **–¶–µ–Ω–∞:** 0 ‚ÇΩ
   - **–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ü–µ–Ω—ã:** ‚úÖ –†–∞–∑—Ä–µ—à–∏—Ç—å
   - **–ö–∞—Ç–µ–≥–æ—Ä–∏—è:** –°–ª—É–∂–µ–±–Ω—ã–µ
   - **–ù–î–°:** –ë–µ–∑ –ù–î–°
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏ –∑–∞–ø–æ–º–Ω–∏—Ç–µ **ID —Ç–æ–≤–∞—Ä–∞**

![](screenshots/product-points.png)

### –¢–æ–≤–∞—Ä 2: "–°–∫–∏–¥–∫–∞ —É—Ä–æ–≤–Ω—è Max Loyalty"

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å–æ–∑–¥–∞–π—Ç–µ:
- **–ù–∞–∑–≤–∞–Ω–∏–µ:** –°–∫–∏–¥–∫–∞ —É—Ä–æ–≤–Ω—è Max Loyalty
- **–ê—Ä—Ç–∏–∫—É–ª:** MAX_LOYALTY_DISCOUNT
- (–æ—Å—Ç–∞–ª—å–Ω–æ–µ —Ç–∞–∫ –∂–µ)

## –®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞–≥–∏–Ω–∞

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ **iiko Front**
2. –û—Ç–∫—Ä–æ–π—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É: –Ω–∞–∂–º–∏—Ç–µ **Ctrl + Shift + D**
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **–ù–∞—Å—Ç—Ä–æ–π–∫–∏**
4. –£–∫–∞–∂–∏—Ç–µ **ID —Ç–æ–≤–∞—Ä–æ–≤** –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞
5. –ù–∞–∂–º–∏—Ç–µ **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å**

![](screenshots/config-products.png)

## –®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑
2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **Max Loyalty** (F9)
3. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è
4. –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞! ‚úÖ

## –í–∏–¥–µ–æ–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

<iframe width="560" height="315" 
  src="https://www.youtube.com/embed/XXXXX" 
  frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" 
  allowfullscreen>
</iframe>

## –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏...

### ‚ùå Installer –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç iiko

**–ü—Ä–∏—á–∏–Ω–∞:** iiko —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø–∞–ø–∫—É

**–†–µ—à–µ–Ω–∏–µ:**
1. –ù–∞–∂–º–∏—Ç–µ **–û–±–∑–æ—Ä**
2. –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å `iiko.exe`

### ‚ùå –û—à–∏–±–∫–∞ "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∏–ª–∏ API Key –Ω–µ–≤–µ—Ä–Ω—ã–π

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–∞—á–∞—Ç—å –Ω–æ–≤—ã–π installer –∏–∑ Admin Panel

### ‚ùå –ö–Ω–æ–ø–∫–∞ Max Loyalty –Ω–µ –ø–æ—è–≤–∏–ª–∞—Å—å –≤ iiko

**–ü—Ä–∏—á–∏–Ω–∞:** iiko –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª –ø–ª–∞–≥–∏–Ω

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ `iiko\Plugins\`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ iiko

## –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?

- üìß Email: support@maxloyalty.ru
- üí¨ Telegram: @maxloyalty_support
- üìû –¢–µ–ª–µ—Ñ–æ–Ω: +7 (495) 123-45-67

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** [–†–∞–±–æ—Ç–∞ —Å –ø–ª–∞–≥–∏–Ω–æ–º ‚Üí](work-with-plugin.md)
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ 45-50 (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ –ø–æ–¥–¥–µ—Ä–∂–∫—É, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É, rollback)?

---

### **–í–û–ü–†–û–° 45: –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ**

**–í–û–ü–†–û–°:** –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–º –æ–∫–Ω–µ –¥–ª—è troubleshooting?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –¢–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞ –∏ —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- **B)** –í–µ—Ä—Å–∏—è + –ª–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **C)** –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: —Å—Ç–∞—Ç—É—Å, –ª–æ–≥–∏, –º–µ—Ç—Ä–∏–∫–∏, —Ç–µ—Å—Ç—ã
- **D)** –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ + —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ + —ç–∫—Å–ø–æ—Ä—Ç**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–°–∞–º–æ–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:** –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç —Å–∞–º –Ω–∞–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É
- ‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞:** –≠–∫—Å–ø–æ—Ä—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—ë –¥–ª—è debugging
- ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:** –í–∏–¥–Ω–æ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏
- ‚úÖ **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:** –ú–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —á–∏–Ω–∏—Ç—å –Ω–∞ –º–µ—Å—Ç–µ

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class DiagnosticsWindow : Window
{
    private readonly LoyaltyPlugin plugin;
    private TabControl tabControl;
    
    public DiagnosticsWindow(LoyaltyPlugin plugin)
    {
        this.plugin = plugin;
        
        Title = "Max Loyalty - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞";
        Width = 900;
        Height = 700;
        WindowStartupLocation = WindowStartupLocation.CenterScreen;
        
        InitializeUI();
    }
    
    private void InitializeUI()
    {
        var mainGrid = new Grid();
        
        // Header
        var header = CreateHeader();
        mainGrid.Children.Add(header);
        
        // Tab control
        tabControl = new TabControl { Margin = new Thickness(0, 80, 0, 0) };
        
        tabControl.Items.Add(CreateTab("–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", CreateOverviewTab()));
        tabControl.Items.Add(CreateTab("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ", CreateConnectionTab()));
        tabControl.Items.Add(CreateTab("Offline –æ—á–µ—Ä–µ–¥—å", CreateOfflineQueueTab()));
        tabControl.Items.Add(CreateTab("–õ–æ–≥–∏", CreateLogsTab()));
        tabControl.Items.Add(CreateTab("–ú–µ—Ç—Ä–∏–∫–∏", CreateMetricsTab()));
        tabControl.Items.Add(CreateTab("–ù–∞—Å—Ç—Ä–æ–π–∫–∏", CreateSettingsTab()));
        tabControl.Items.Add(CreateTab("–¢–µ—Å—Ç—ã", CreateTestsTab()));
        
        mainGrid.Children.Add(tabControl);
        
        // Footer buttons
        var footer = CreateFooter();
        mainGrid.Children.Add(footer);
        
        Content = mainGrid;
    }
    
    // ===== TAB 1: –û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø =====
    private UIElement CreateOverviewTab()
    {
        var panel = new StackPanel { Margin = new Thickness(20) };
        
        // –í–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞
        panel.Children.Add(CreateInfoSection("–ü–ª–∞–≥–∏–Ω", new Dictionary<string, string>
        {
            ["–í–µ—Ä—Å–∏—è"] = plugin.GetVersion(),
            ["–°–±–æ—Ä–∫–∞"] = plugin.GetBuildDate().ToString("dd.MM.yyyy HH:mm"),
            ["–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"] = plugin.GetInstallDate().ToString("dd.MM.yyyy HH:mm"),
            ["–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã"] = plugin.GetUptime().ToString(@"hh\:mm\:ss")
        }));
        
        // iiko
        panel.Children.Add(CreateInfoSection("iiko Front", new Dictionary<string, string>
        {
            ["–í–µ—Ä—Å–∏—è"] = versionManager.GetVersion().ToString(),
            ["–ü—É—Ç—å"] = configService.GetIikoPath(),
            ["–†–µ–∂–∏–º"] = debugMode ? "Debug" : "Release"
        }));
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        panel.Children.Add(CreateInfoSection("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è", new Dictionary<string, string>
        {
            ["Restaurant ID"] = configService.GetRestaurantId(),
            ["API URL"] = configService.GetApiUrl(),
            ["–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞"] = $"{configService.GetMinCheckAmount():N0} ‚ÇΩ",
            ["Offline —Ä–µ–∂–∏–º"] = healthCheck.IsOnline() ? "‚ùå –ù–µ—Ç (Online)" : "‚úÖ –î–∞"
        }));
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        var stats = metricsService.GetSessionStatistics();
        
        panel.Children.Add(CreateInfoSection("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏", new Dictionary<string, string>
        {
            ["–û–ø–µ—Ä–∞—Ü–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ"] = stats.OperationsCount.ToString(),
            ["–£—Å–ø–µ—à–Ω—ã—Ö"] = stats.SuccessfulOperations.ToString(),
            ["–û—à–∏–±–æ–∫"] = stats.FailedOperations.ToString(),
            ["Offline –æ–ø–µ—Ä–∞—Ü–∏–π"] = stats.OfflineOperations.ToString(),
            ["API –∑–∞–ø—Ä–æ—Å–æ–≤"] = stats.ApiRequests.ToString(),
            ["–°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ API"] = $"{stats.AverageApiLatency:N0} –º—Å"
        }));
        
        // –ü–∞–º—è—Ç—å
        var process = Process.GetCurrentProcess();
        
        panel.Children.Add(CreateInfoSection("–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", new Dictionary<string, string>
        {
            ["–ü–∞–º—è—Ç—å (Working Set)"] = $"{process.WorkingSet64 / (1024 * 1024)} MB",
            ["–ü–∞–º—è—Ç—å (Private)"] = $"{process.PrivateMemorySize64 / (1024 * 1024)} MB",
            ["–ü–∞–º—è—Ç—å (GC)"] = $"{GC.GetTotalMemory(false) / (1024 * 1024)} MB",
            ["Threads"] = process.Threads.Count.ToString(),
            ["GC Gen 0"] = GC.CollectionCount(0).ToString(),
            ["GC Gen 1"] = GC.CollectionCount(1).ToString(),
            ["GC Gen 2"] = GC.CollectionCount(2).ToString()
        }));
        
        return panel;
    }
    
    // ===== TAB 2: –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï =====
    private UIElement CreateConnectionTab()
    {
        var panel = new StackPanel { Margin = new Thickness(20) };
        
        // –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        var statusPanel = new StackPanel
        {
            Orientation = Orientation.Horizontal,
            Margin = new Thickness(0, 0, 0, 20)
        };
        
        var statusIndicator = new Ellipse
        {
            Width = 16,
            Height = 16,
            Fill = healthCheck.IsOnline() 
                ? Brushes.Green 
                : Brushes.Red,
            Margin = new Thickness(0, 0, 10, 0)
        };
        
        var statusText = new TextBlock
        {
            Text = healthCheck.IsOnline() ? "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ" : "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è",
            FontSize = 18,
            FontWeight = FontWeights.Bold
        };
        
        statusPanel.Children.Add(statusIndicator);
        statusPanel.Children.Add(statusText);
        panel.Children.Add(statusPanel);
        
        // –î–µ—Ç–∞–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        panel.Children.Add(CreateInfoSection("–°–µ—Ä–≤–µ—Ä", new Dictionary<string, string>
        {
            ["URL"] = configService.GetApiUrl(),
            ["–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞"] = healthCheck.GetLastCheckTime().ToString("HH:mm:ss"),
            ["–°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞"] = "—á–µ—Ä–µ–∑ " + healthCheck.GetTimeUntilNextCheck().TotalSeconds + " —Å–µ–∫",
            ["–ù–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫"] = healthCheck.GetConsecutiveFailures().ToString(),
            ["–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞"] = healthCheck.GetLastError() ?? "–ù–µ—Ç"
        }));
        
        // Health check –∏—Å—Ç–æ—Ä–∏—è
        var historyGrid = new DataGrid
        {
            AutoGenerateColumns = false,
            IsReadOnly = true,
            Height = 200,
            Margin = new Thickness(0, 20, 0, 0)
        };
        
        historyGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–í—Ä–µ–º—è",
            Binding = new Binding("Timestamp") { StringFormat = "HH:mm:ss" },
            Width = 100
        });
        
        historyGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–°—Ç–∞—Ç—É—Å",
            Binding = new Binding("Status"),
            Width = 100
        });
        
        historyGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–ó–∞–¥–µ—Ä–∂–∫–∞",
            Binding = new Binding("Latency") { StringFormat = "{0:N0} –º—Å" },
            Width = 100
        });
        
        historyGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–û—à–∏–±–∫–∞",
            Binding = new Binding("Error"),
            Width = new DataGridLength(1, DataGridLengthUnitType.Star)
        });
        
        historyGrid.ItemsSource = healthCheck.GetHistory();
        
        panel.Children.Add(new TextBlock
        {
            Text = "–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫:",
            FontWeight = FontWeights.Bold,
            Margin = new Thickness(0, 20, 0, 10)
        });
        panel.Children.Add(historyGrid);
        
        // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        var buttonsPanel = new StackPanel
        {
            Orientation = Orientation.Horizontal,
            Margin = new Thickness(0, 20, 0, 0)
        };
        
        var testButton = new Button
        {
            Content = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–π—á–∞—Å",
            Width = 150,
            Height = 35,
            Margin = new Thickness(0, 0, 10, 0)
        };
        testButton.Click += async (s, e) => await TestConnectionAsync();
        
        var syncButton = new Button
        {
            Content = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å offline –æ—á–µ—Ä–µ–¥—å",
            Width = 250,
            Height = 35,
            IsEnabled = !healthCheck.IsOnline()
        };
        syncButton.Click += async (s, e) => await SyncOfflineQueueAsync();
        
        buttonsPanel.Children.Add(testButton);
        buttonsPanel.Children.Add(syncButton);
        panel.Children.Add(buttonsPanel);
        
        return panel;
    }
    
    // ===== TAB 3: OFFLINE –û–ß–ï–†–ï–î–¨ =====
    private UIElement CreateOfflineQueueTab()
    {
        var panel = new StackPanel { Margin = new Thickness(20) };
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏
        var queueSize = offlineQueue.GetQueueSize();
        var pendingCount = offlineQueue.GetPendingCount();
        var completedCount = offlineQueue.GetCompletedCount();
        var failedCount = offlineQueue.GetFailedCount();
        
        panel.Children.Add(CreateInfoSection("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", new Dictionary<string, string>
        {
            ["–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π"] = queueSize.ToString(),
            ["–û–∂–∏–¥–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏"] = pendingCount.ToString(),
            ["–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ"] = completedCount.ToString(),
            ["–û—à–∏–±–æ–∫"] = failedCount.ToString(),
            ["–†–∞–∑–º–µ—Ä –Ω–∞ –¥–∏—Å–∫–µ"] = offlineQueue.GetQueueFileSize() + " KB"
        }));
        
        // –¢–∞–±–ª–∏—Ü–∞ –æ–ø–µ—Ä–∞—Ü–∏–π
        var operationsGrid = new DataGrid
        {
            AutoGenerateColumns = false,
            IsReadOnly = true,
            Height = 400,
            Margin = new Thickness(0, 20, 0, 0)
        };
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "ID –∑–∞–∫–∞–∑–∞",
            Binding = new Binding("OrderId"),
            Width = 120
        });
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–¢–∏–ø",
            Binding = new Binding("Type"),
            Width = 150
        });
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–°—É–º–º–∞",
            Binding = new Binding("CheckAmount") { StringFormat = "{0:N2} ‚ÇΩ" },
            Width = 100
        });
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–ë–∞–ª–ª—ã",
            Binding = new Binding("PointsToEarn") { StringFormat = "{0:N0}" },
            Width = 80
        });
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–°—Ç–∞—Ç—É—Å",
            Binding = new Binding("Status"),
            Width = 100
        });
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–î–æ–±–∞–≤–ª–µ–Ω–æ",
            Binding = new Binding("QueuedAt") { StringFormat = "dd.MM HH:mm" },
            Width = 120
        });
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–ò—Å—Ç–µ–∫–∞–µ—Ç",
            Binding = new Binding("ExpiresAt") { StringFormat = "dd.MM HH:mm" },
            Width = 120
        });
        
        operationsGrid.Columns.Add(new DataGridTextColumn
        {
            Header = "–ü–æ–ø—ã—Ç–æ–∫",
            Binding = new Binding("RetryCount"),
            Width = 70
        });
        
        operationsGrid.ItemsSource = offlineQueue.GetAllOperations();
        
        panel.Children.Add(operationsGrid);
        
        // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        var buttonsPanel = new StackPanel
        {
            Orientation = Orientation.Horizontal,
            Margin = new Thickness(0, 20, 0, 0)
        };
        
        var refreshButton = new Button
        {
            Content = "–û–±–Ω–æ–≤–∏—Ç—å",
            Width = 120,
            Height = 35,
            Margin = new Thickness(0, 0, 10, 0)
        };
        refreshButton.Click += (s, e) => RefreshOfflineQueue();
        
        var processButton = new Button
        {
            Content = "–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—á–µ—Ä–µ–¥—å",
            Width = 180,
            Height = 35,
            Margin = new Thickness(0, 0, 10, 0),
            IsEnabled = healthCheck.IsOnline() && pendingCount > 0
        };
        processButton.Click += async (s, e) => await ProcessQueueAsync();
        
        var clearButton = new Button
        {
            Content = "–û—á–∏—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ",
            Width = 180,
            Height = 35,
            IsEnabled = completedCount > 0
        };
        clearButton.Click += (s, e) => ClearCompletedOperations();
        
        buttonsPanel.Children.Add(refreshButton);
        buttonsPanel.Children.Add(processButton);
        buttonsPanel.Children.Add(clearButton);
        panel.Children.Add(buttonsPanel);
        
        return panel;
    }
    
    // ===== TAB 4: –õ–û–ì–ò =====
    private UIElement CreateLogsTab()
    {
        var panel = new DockPanel { Margin = new Thickness(20) };
        
        // Toolbar
        var toolbar = new StackPanel
        {
            Orientation = Orientation.Horizontal,
            Margin = new Thickness(0, 0, 0, 10)
        };
        
        var levelFilter = new ComboBox
        {
            Width = 120,
            Margin = new Thickness(0, 0, 10, 0)
        };
        levelFilter.Items.Add("–í—Å–µ —É—Ä–æ–≤–Ω–∏");
        levelFilter.Items.Add("Debug");
        levelFilter.Items.Add("Info");
        levelFilter.Items.Add("Warning");
        levelFilter.Items.Add("Error");
        levelFilter.SelectedIndex = 0;
        
        var searchBox = new TextBox
        {
            Width = 200,
            Height = 30,
            Margin = new Thickness(0, 0, 10, 0),
            VerticalContentAlignment = VerticalAlignment.Center
        };
        searchBox.SetValue(TextBox.PlaceholderTextProperty, "–ü–æ–∏—Å–∫...");
        
        var refreshButton = new Button
        {
            Content = "–û–±–Ω–æ–≤–∏—Ç—å",
            Width = 100,
            Height = 30,
            Margin = new Thickness(0, 0, 10, 0)
        };
        
        var openFolderButton = new Button
        {
            Content = "–û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É –ª–æ–≥–æ–≤",
            Width = 150,
            Height = 30,
            Margin = new Thickness(0, 0, 10, 0)
        };
        openFolderButton.Click += (s, e) => OpenLogsFolder();
        
        var clearButton = new Button
        {
            Content = "–û—á–∏—Å—Ç–∏—Ç—å",
            Width = 100,
            Height = 30
        };
        clearButton.Click += (s, e) => ClearLogs();
        
        toolbar.Children.Add(levelFilter);
        toolbar.Children.Add(searchBox);
        toolbar.Children.Add(refreshButton);
        toolbar.Children.Add(openFolderButton);
        toolbar.Children.Add(clearButton);
        
        DockPanel.SetDock(toolbar, Dock.Top);
        panel.Children.Add(toolbar);
        
        // –õ–æ–≥–∏
        var logsTextBox = new TextBox
        {
            IsReadOnly = true,
            VerticalScrollBarVisibility = ScrollBarVisibility.Auto,
            FontFamily = new FontFamily("Consolas"),
            FontSize = 11,
            Background = new SolidColorBrush(Color.FromRgb(30, 30, 30)),
            Foreground = Brushes.LightGray,
            Padding = new Thickness(10)
        };
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤
        logsTextBox.Text = LoadRecentLogs(1000);
        
        panel.Children.Add(logsTextBox);
        
        return panel;
    }
    
    // ===== TAB 5: –ú–ï–¢–†–ò–ö–ò =====
    private UIElement CreateMetricsTab()
    {
        var panel = new StackPanel { Margin = new Thickness(20) };
        
        var metrics = metricsService.GetAggregatedMetrics();
        
        // API –º–µ—Ç—Ä–∏–∫–∏
        panel.Children.Add(CreateInfoSection("API –∑–∞–ø—Ä–æ—Å—ã", new Dictionary<string, string>
        {
            ["–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤"] = metrics.TotalApiRequests.ToString(),
            ["–£—Å–ø–µ—à–Ω—ã—Ö"] = metrics.SuccessfulApiRequests.ToString(),
            ["–û—à–∏–±–æ–∫"] = metrics.FailedApiRequests.ToString(),
            ["Success rate"] = $"{metrics.ApiSuccessRate:P1}",
            ["–°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞"] = $"{metrics.AverageApiLatency:N0} –º—Å",
            ["P95 –∑–∞–¥–µ—Ä–∂–∫–∞"] = $"{metrics.P95ApiLatency:N0} –º—Å",
            ["P99 –∑–∞–¥–µ—Ä–∂–∫–∞"] = $"{metrics.P99ApiLatency:N0} –º—Å"
        }));
        
        // –û–ø–µ—Ä–∞—Ü–∏–∏
        panel.Children.Add(CreateInfoSection("–û–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏", new Dictionary<string, string>
        {
            ["–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π"] = metrics.TotalOperations.ToString(),
            ["–°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤"] = metrics.SpendOperations.ToString(),
            ["–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤"] = metrics.EarnOperations.ToString(),
            ["–°–∫–∏–¥–∫–∏"] = metrics.DiscountOperations.ToString(),
            ["–û—Ç–º–µ–Ω—ã"] = metrics.CancelledOperations.ToString(),
            ["Success rate"] = $"{metrics.OperationSuccessRate:P1}"
        }));
        
        // –ö–µ—à
        panel.Children.Add(CreateInfoSection("–ö–µ—à", new Dictionary<string, string>
        {
            ["–†–∞–∑–º–µ—Ä –∫–µ—à–∞"] = $"{metrics.CacheSize} –∑–∞–ø–∏—Å–µ–π",
            ["Cache hits"] = metrics.CacheHits.ToString(),
            ["Cache misses"] = metrics.CacheMisses.ToString(),
            ["Hit rate"] = $"{metrics.CacheHitRate:P1}"
        }));
        
        // –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
        var exportButton = new Button
        {
            Content = "–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏",
            Width = 200,
            Height = 35,
            Margin = new Thickness(0, 20, 0, 0)
        };
        exportButton.Click += (s, e) => ExportMetrics();
        
        panel.Children.Add(exportButton);
        
        return panel;
    }
    
    // ===== TAB 6: –ù–ê–°–¢–†–û–ô–ö–ò =====
    private UIElement CreateSettingsTab()
    {
        var panel = new StackPanel { Margin = new Thickness(20) };
        
        // iiko —Ç–æ–≤–∞—Ä—ã
        panel.Children.Add(new TextBlock
        {
            Text = "–°–ª—É–∂–µ–±–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã iiko",
            FontSize = 16,
            FontWeight = FontWeights.Bold,
            Margin = new Thickness(0, 0, 0, 15)
        });
        
        var productsGrid = new Grid();
        productsGrid.ColumnDefinitions.Add(new ColumnDefinition { Width = new GridLength(200) });
        productsGrid.ColumnDefinitions.Add(new ColumnDefinition { Width = new GridLength(1, GridUnitType.Star) });
        productsGrid.RowDefinitions.Add(new RowDefinition());
        productsGrid.RowDefinitions.Add(new RowDefinition());
        
        // –¢–æ–≤–∞—Ä –¥–ª—è –±–∞–ª–ª–æ–≤
        productsGrid.Children.Add(new TextBlock
        {
            Text = "–¢–æ–≤–∞—Ä –¥–ª—è –±–∞–ª–ª–æ–≤:",
            VerticalAlignment = VerticalAlignment.Center
        });
        Grid.SetRow(productsGrid.Children[^1], 0);
        Grid.SetColumn(productsGrid.Children[^1], 0);
        
        var pointsProductInput = new TextBox
        {
            Text = configService.GetPointsProductId(),
            Height = 30,
            VerticalContentAlignment = VerticalAlignment.Center,
            Margin = new Thickness(10, 5, 0, 5)
        };
        Grid.SetRow(pointsProductInput, 0);
        Grid.SetColumn(pointsProductInput, 1);
        productsGrid.Children.Add(pointsProductInput);
        
        // –¢–æ–≤–∞—Ä –¥–ª—è —Å–∫–∏–¥–∫–∏
        productsGrid.Children.Add(new TextBlock
        {
            Text = "–¢–æ–≤–∞—Ä –¥–ª—è —Å–∫–∏–¥–∫–∏:",
            VerticalAlignment = VerticalAlignment.Center
        });
        Grid.SetRow(productsGrid.Children[^1], 1);
        Grid.SetColumn(productsGrid.Children[^1], 0);
        
        var discountProductInput = new TextBox
        {
            Text = configService.GetDiscountProductId(),
            Height = 30,
            VerticalContentAlignment = VerticalAlignment.Center,
            Margin = new Thickness(10, 5, 0, 5)
        };
        Grid.SetRow(discountProductInput, 1);
        Grid.SetColumn(discountProductInput, 1);
        productsGrid.Children.Add(discountProductInput);
        
        panel.Children.Add(productsGrid);
        
        // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        var saveButton = new Button
        {
            Content = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏",
            Width = 180,
            Height = 35,
            Margin = new Thickness(0, 20, 0, 0)
        };
        saveButton.Click += (s, e) => SaveSettings(pointsProductInput.Text, discountProductInput.Text);
        
        panel.Children.Add(saveButton);
        
        // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        panel.Children.Add(new Separator { Margin = new Thickness(0, 30, 0, 30) });
        
        panel.Children.Add(new TextBlock
        {
            Text = "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏",
            FontSize = 16,
            FontWeight = FontWeights.Bold,
            Margin = new Thickness(0, 0, 0, 15)
        });
        
        var advancedPanel = new StackPanel();
        
        var debugModeCheckbox = new CheckBox
        {
            Content = "–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ (–ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏)",
            IsChecked = configService.IsDebugMode(),
            Margin = new Thickness(0, 0, 0, 10)
        };
        advancedPanel.Children.Add(debugModeCheckbox);
        
        var autoSyncCheckbox = new CheckBox
        {
            Content = "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è offline –æ—á–µ—Ä–µ–¥–∏",
            IsChecked = configService.IsAutoSyncEnabled(),
            Margin = new Thickness(0, 0, 0, 10)
        };
        advancedPanel.Children.Add(autoSyncCheckbox);
        
        var metricsCheckbox = new CheckBox
        {
            Content = "–û—Ç–ø—Ä–∞–≤–∫–∞ –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ (–ø–æ–º–æ–≥–∞–µ—Ç —É–ª—É—á—à–∏—Ç—å –ø–ª–∞–≥–∏–Ω)",
            IsChecked = configService.IsMetricsEnabled(),
            Margin = new Thickness(0, 0, 0, 10)
        };
        advancedPanel.Children.Add(metricsCheckbox);
        
        panel.Children.Add(advancedPanel);
        
        return panel;
    }
    
    // ===== TAB 7: –¢–ï–°–¢–´ =====
    private UIElement CreateTestsTab()
    {
        var panel = new StackPanel { Margin = new Thickness(20) };
        
        panel.Children.Add(new TextBlock
        {
            Text = "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞",
            FontSize = 16,
            FontWeight = FontWeights.Bold,
            Margin = new Thickness(0, 0, 0, 15)
        });
        
        panel.Children.Add(new TextBlock
        {
            Text = "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø–ª–∞–≥–∏–Ω–∞:",
            TextWrapping = TextWrapping.Wrap,
            Margin = new Thickness(0, 0, 0, 20)
        });
        
        // –°–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤
        var testsPanel = new StackPanel();
        
        var tests = new[]
        {
            new { Name = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É", Action = (Func<Task<TestResult>>)TestServerConnection },
            new { Name = "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞", Action = (Func<Task<TestResult>>)TestRestaurantConfig },
            new { Name = "–°–ª—É–∂–µ–±–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã", Action = (Func<Task<TestResult>>)TestServiceProducts },
            new { Name = "–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è (—Ç–µ—Å—Ç)", Action = (Func<Task<TestResult>>)TestGuestSearch },
            new { Name = "–†–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤ (—Ç–µ—Å—Ç)", Action = (Func<Task<TestResult>>)TestCalculation },
            new { Name = "Offline queue", Action = (Func<Task<TestResult>>)TestOfflineQueue },
            new { Name = "–ö–µ—à", Action = (Func<Task<TestResult>>)TestCache },
            new { Name = "–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ", Action = (Func<Task<TestResult>>)TestLogging }
        };
        
        foreach (var test in tests)
        {
            var testPanel = new DockPanel { Margin = new Thickness(0, 0, 0, 10) };
            
            var runButton = new Button
            {
                Content = "‚ñ∂",
                Width = 40,
                Height = 30
            };
            DockPanel.SetDock(runButton, Dock.Left);
            
            var resultIcon = new TextBlock
            {
                Text = "‚è∫",
                FontSize = 20,
                Width = 30,
                VerticalAlignment = VerticalAlignment.Center
            };
            DockPanel.SetDock(resultIcon, Dock.Right);
            
            var testName = new TextBlock
            {
                Text = test.Name,
                VerticalAlignment = VerticalAlignment.Center,
                Margin = new Thickness(10, 0, 10, 0)
            };
            
            runButton.Click += async (s, e) =>
            {
                runButton.IsEnabled = false;
                resultIcon.Text = "‚è≥";
                
                try
                {
                    var result = await test.Action();
                    
                    resultIcon.Text = result.Success ? "‚úÖ" : "‚ùå";
                    resultIcon.Foreground = result.Success ? Brushes.Green : Brushes.Red;
                    
                    if (!result.Success)
                    {
                        MessageBox.Show(
                            $"–¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω:\n\n{result.ErrorMessage}",
                            test.Name,
                            MessageBoxButton.OK,
                            MessageBoxImage.Warning
                        );
                    }
                }
                catch (Exception ex)
                {
                    resultIcon.Text = "‚ùå";
                    resultIcon.Foreground = Brushes.Red;
                    
                    MessageBox.Show(
                        $"–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞:\n\n{ex.Message}",
                        test.Name,
                        MessageBoxButton.OK,
                        MessageBoxImage.Error
                    );
                }
                finally
                {
                    runButton.IsEnabled = true;
                }
            };
            
            testPanel.Children.Add(runButton);
            testPanel.Children.Add(resultIcon);
            testPanel.Children.Add(testName);
            
            testsPanel.Children.Add(testPanel);
        }
        
        panel.Children.Add(testsPanel);
        
        // –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
        var runAllButton = new Button
        {
            Content = "–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã",
            Width = 180,
            Height = 40,
            Margin = new Thickness(0, 30, 0, 0)
        };
        runAllButton.Click += async (s, e) => await RunAllTestsAsync();
        
        panel.Children.Add(runAllButton);
        
        return panel;
    }
    
    // ===== FOOTER =====
    private UIElement CreateFooter()
    {
        var footer = new Border
        {
            BorderThickness = new Thickness(0, 1, 0, 0),
            BorderBrush = Brushes.LightGray,
            VerticalAlignment = VerticalAlignment.Bottom,
            Height = 60,
            Child = new StackPanel
            {
                Orientation = Orientation.Horizontal,
                HorizontalAlignment = HorizontalAlignment.Right,
                VerticalAlignment = VerticalAlignment.Center,
                Margin = new Thickness(20, 0, 20, 0),
                Children =
                {
                    new Button
                    {
                        Content = "–≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
                        Width = 180,
                        Height = 35,
                        Margin = new Thickness(0, 0, 10, 0)
                    },
                    new Button
                    {
                        Content = "–ó–∞–∫—Ä—ã—Ç—å",
                        Width = 100,
                        Height = 35
                    }
                }
            }
        };
        
        ((Button)((StackPanel)footer.Child).Children[0]).Click += (s, e) => ExportSupportBundle();
        ((Button)((StackPanel)footer.Child).Children[1]).Click += (s, e) => Close();
        
        return footer;
    }
    
    // ===== HELPERS =====
    
    private UIElement CreateInfoSection(string title, Dictionary<string, string> items)
    {
        var panel = new StackPanel { Margin = new Thickness(0, 0, 0, 20) };
        
        panel.Children.Add(new TextBlock
        {
            Text = title,
            FontWeight = FontWeights.Bold,
            FontSize = 14,
            Margin = new Thickness(0, 0, 0, 10)
        });
        
        var grid = new Grid { Margin = new Thickness(10, 0, 0, 0) };
        grid.ColumnDefinitions.Add(new ColumnDefinition { Width = new GridLength(250) });
        grid.ColumnDefinitions.Add(new ColumnDefinition { Width = new GridLength(1, GridUnitType.Star) });
        
        int row = 0;
        foreach (var item in items)
        {
            grid.RowDefinitions.Add(new RowDefinition());
            
            var keyText = new TextBlock
            {
                Text = item.Key + ":",
                Foreground = Brushes.Gray,
                Margin = new Thickness(0, 2, 0, 2)
            };
            Grid.SetRow(keyText, row);
            Grid.SetColumn(keyText, 0);
            grid.Children.Add(keyText);
            
            var valueText = new TextBlock
            {
                Text = item.Value,
                FontWeight = FontWeights.SemiBold,
                Margin = new Thickness(10, 2, 0, 2)
            };
            Grid.SetRow(valueText, row);
            Grid.SetColumn(valueText, 1);
            grid.Children.Add(valueText);
            
            row++;
        }
        
        panel.Children.Add(grid);
        
        return panel;
    }
    
    private void ExportSupportBundle()
    {
        try
        {
            var saveDialog = new SaveFileDialog
            {
                FileName = $"MaxLoyalty_Diagnostics_{DateTime.Now:yyyyMMdd_HHmmss}.zip",
                Filter = "ZIP –∞—Ä—Ö–∏–≤|*.zip"
            };
            
            if (saveDialog.ShowDialog() != true)
                return;
            
            // –°–æ–∑–¥–∞–µ–º ZIP —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
            using (var zip = ZipFile.Open(saveDialog.FileName, ZipArchiveMode.Create))
            {
                // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–±–µ–∑ API key!)
                var configJson = JsonConvert.SerializeObject(new
                {
                    Version = plugin.GetVersion(),
                    IikoVersion = versionManager.GetVersion().ToString(),
                    RestaurantId = configService.GetRestaurantId(),
                    InstalledAt = plugin.GetInstallDate(),
                    CurrentTime = DateTime.Now
                }, Formatting.Indented);
                
                var configEntry = zip.CreateEntry("config.json");
                using (var writer = new StreamWriter(configEntry.Open()))
                {
                    writer.Write(configJson);
                }
                
                // –õ–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10000 —Å—Ç—Ä–æ–∫)
                var logsEntry = zip.CreateEntry("logs.txt");
                using (var writer = new StreamWriter(logsEntry.Open()))
                {
                    writer.Write(LoadRecentLogs(10000));
                }
                
                // –ú–µ—Ç—Ä–∏–∫–∏
                var metricsJson = JsonConvert.SerializeObject(
                    metricsService.GetAggregatedMetrics(),
                    Formatting.Indented
                );
                var metricsEntry = zip.CreateEntry("metrics.json");
                using (var writer = new StreamWriter(metricsEntry.Open()))
                {
                    writer.Write(metricsJson);
                }
                
                // Offline queue
                var queueJson = JsonConvert.SerializeObject(
                    offlineQueue.GetAllOperations(),
                    Formatting.Indented
                );
                var queueEntry = zip.CreateEntry("offline_queue.json");
                using (var writer = new StreamWriter(queueEntry.Open()))
                {
                    writer.Write(queueJson);
                }
                
                // System info
                var systemInfo = new
                {
                    OS = Environment.OSVersion.ToString(),
                    MachineName = Environment.MachineName,
                    ProcessorCount = Environment.ProcessorCount,
                    Memory = GC.GetGCMemoryInfo().TotalAvailableMemoryBytes / (1024 * 1024) + " MB"
                };
                
                var systemInfoJson = JsonConvert.SerializeObject(systemInfo, Formatting.Indented);
                var systemInfoEntry = zip.CreateEntry("system_info.json");
                using (var writer = new StreamWriter(systemInfoEntry.Open()))
                {
                    writer.Write(systemInfoJson);
                }
            }
            
            MessageBox.Show(
                $"–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:\n\n{saveDialog.FileName}\n\n" +
                "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏.",
                "–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω",
                MessageBoxButton.OK,
                MessageBoxImage.Information
            );
        }
        catch (Exception ex)
        {
            MessageBox.Show(
                $"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:\n\n{ex.Message}",
                "–û—à–∏–±–∫–∞",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
}
```


***

### **–í–û–ü–†–û–° 46: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞**

**–í–û–ü–†–û–°:** –ö–∞–∫ –æ–±–Ω–æ–≤–ª—è—Ç—å –ø–ª–∞–≥–∏–Ω –Ω–∞ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –†—É—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ + —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ
- **B)** Installer —Å —Ä–µ–∂–∏–º–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (overwrite —Ñ–∞–π–ª–æ–≤)
- **C)** –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ iiko
- **D)** Remote update –∏–∑ Admin Panel

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: B) Installer —Å —Ä–µ–∂–∏–º–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ö–æ–Ω—Ç—Ä–æ–ª—å:** –ê–¥–º–∏–Ω —Ä–µ—à–∞–µ—Ç –∫–æ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è—Ç—å
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –±–µ–∑ –≤–µ–¥–æ–º–∞
- ‚úÖ **–û—Ç–∫–∞—Ç:** –ú–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –¢–æ—Ç –∂–µ installer —á—Ç–æ –∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class UpdateChecker
{
    private readonly LoyaltyApiClient apiClient;
    private readonly ILogger logger;
    
    public async Task<UpdateInfo> CheckForUpdatesAsync()
    {
        try
        {
            var currentVersion = GetCurrentVersion();
            
            var response = await apiClient.GetAsync<CheckUpdateResponse>(
                $"/api/plugin/check-update?currentVersion={currentVersion}&restaurantId={restaurantId}"
            );
            
            if (response.UpdateAvailable)
            {
                logger.LogInformation(
                    "Update available: {CurrentVersion} -> {NewVersion}",
                    currentVersion,
                    response.LatestVersion
                );
                
                return new UpdateInfo
                {
                    UpdateAvailable = true,
                    CurrentVersion = currentVersion,
                    LatestVersion = response.LatestVersion,
                    ReleaseDate = response.ReleaseDate,
                    ReleaseNotes = response.ReleaseNotes,
                    DownloadUrl = response.DownloadUrl,
                    IsCritical = response.IsCritical,
                    MinimumVersion = response.MinimumVersion
                };
            }
            
            return new UpdateInfo { UpdateAvailable = false };
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to check for updates");
            return new UpdateInfo { UpdateAvailable = false };
        }
    }
    
    public async Task<bool> DownloadUpdateAsync(UpdateInfo updateInfo, IProgress<int> progress)
    {
        try
        {
            var tempPath = Path.Combine(Path.GetTempPath(), "MaxLoyaltyUpdate.exe");
            
            using var httpClient = new HttpClient();
            httpClient.Timeout = TimeSpan.FromMinutes(5);
            
            var response = await httpClient.GetAsync(updateInfo.DownloadUrl, HttpCompletionOption.ResponseHeadersRead);
            response.EnsureSuccessStatusCode();
            
            var totalBytes = response.Content.Headers.ContentLength ?? 0;
            var downloadedBytes = 0L;
            
            using (var fileStream = new FileStream(tempPath, FileMode.Create, FileAccess.Write, FileShare.None))
            using (var contentStream = await response.Content.ReadAsStreamAsync())
            {
                var buffer = new byte[8192];
                int bytesRead;
                
                while ((bytesRead = await contentStream.ReadAsync(buffer, 0, buffer.Length)) > 0)
                {
                    await fileStream.WriteAsync(buffer, 0, bytesRead);
                    downloadedBytes += bytesRead;
                    
                    if (totalBytes > 0)
                    {
                        var progressPercentage = (int)((downloadedBytes * 100) / totalBytes);
                        progress?.Report(progressPercentage);
                    }
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å —Ñ–∞–π–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            if (!VerifyFileSignature(tempPath))
            {
                File.Delete(tempPath);
                throw new SecurityException("Downloaded file signature is invalid");
            }
            
            logger.LogInformation("Update downloaded successfully: {Path}", tempPath);
            
            return true;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to download update");
            return false;
        }
    }
    
    public void InstallUpdate(string installerPath)
    {
        try
        {
            // –ó–∞–ø—É—Å–∫–∞–µ–º installer –≤ —Ä–µ–∂–∏–º–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            var startInfo = new ProcessStartInfo
            {
                FileName = installerPath,
                Arguments = "/update /silent",
                UseShellExecute = true,
                Verb = "runas" // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º admin –ø—Ä–∞–≤–∞
            };
            
            Process.Start(startInfo);
            
            logger.LogInformation("Update installer started");
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º iiko –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            Application.Current.Shutdown();
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to install update");
            throw;
        }
    }
}
```

**Update notification –≤ UI:**

```csharp
public class UpdateNotificationWindow : Window
{
    private readonly UpdateInfo updateInfo;
    
    public UpdateNotificationWindow(UpdateInfo updateInfo)
    {
        this.updateInfo = updateInfo;
        
        Title = "–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Max Loyalty";
        Width = 500;
        Height = 400;
        WindowStartupLocation = WindowStartupLocation.CenterScreen;
        
        InitializeUI();
    }
    
    private void InitializeUI()
    {
        var panel = new StackPanel { Margin = new Thickness(30) };
        
        // –ò–∫–æ–Ω–∫–∞
        panel.Children.Add(new TextBlock
        {
            Text = updateInfo.IsCritical ? "‚ö†Ô∏è" : "üîÑ",
            FontSize = 48,
            HorizontalAlignment = HorizontalAlignment.Center,
            Margin = new Thickness(0, 0, 0, 20)
        });
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        panel.Children.Add(new TextBlock
        {
            Text = updateInfo.IsCritical 
                ? "–î–æ—Å—Ç—É–ø–Ω–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ!" 
                : "–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è",
            FontSize = 18,
            FontWeight = FontWeights.Bold,
            HorizontalAlignment = HorizontalAlignment.Center,
            Margin = new Thickness(0, 0, 0, 10)
        });
        
        // –í–µ—Ä—Å–∏–∏
        panel.Children.Add(new TextBlock
        {
            Text = $"–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: {updateInfo.CurrentVersion}\n" +
                   $"–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: {updateInfo.LatestVersion}",
            HorizontalAlignment = HorizontalAlignment.Center,
            Foreground = Brushes.Gray,
            Margin = new Thickness(0, 0, 0, 20)
        });
        
        // Release notes
        panel.Children.Add(new TextBlock
        {
            Text = "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ:",
            FontWeight = FontWeights.Bold,
            Margin = new Thickness(0, 0, 0, 10)
        });
        
        var notesBox = new TextBox
        {
            Text = updateInfo.ReleaseNotes,
            IsReadOnly = true,
            TextWrapping = TextWrapping.Wrap,
            Height = 120,
            VerticalScrollBarVisibility = ScrollBarVisibility.Auto,
            Margin = new Thickness(0, 0, 0, 20)
        };
        panel.Children.Add(notesBox);
        
        // –ö–Ω–æ–ø–∫–∏
        var buttonsPanel = new StackPanel
        {
            Orientation = Orientation.Horizontal,
            HorizontalAlignment = HorizontalAlignment.Center
        };
        
        var updateButton = new Button
        {
            Content = "–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å",
            Width = 150,
            Height = 35,
            Margin = new Thickness(0, 0, 10, 0)
        };
        updateButton.Click += OnUpdateClick;
        
        var laterButton = new Button
        {
            Content = updateInfo.IsCritical ? "–û—Ç–ª–æ–∂–∏—Ç—å" : "–ü–æ–∑–∂–µ",
            Width = 100,
            Height = 35
        };
        laterButton.Click += (s, e) =>
        {
            DialogResult = false;
            Close();
        };
        
        buttonsPanel.Children.Add(updateButton);
        buttonsPanel.Children.Add(laterButton);
        panel.Children.Add(buttonsPanel);
        
        Content = panel;
    }
    
    private async void OnUpdateClick(object sender, RoutedEventArgs e)
    {
        var progressWindow = new UpdateProgressWindow();
        progressWindow.Show();
        
        var updateChecker = new UpdateChecker(apiClient);
        
        var progress = new Progress<int>(percentage =>
        {
            progressWindow.UpdateProgress(percentage);
        });
        
        var success = await updateChecker.DownloadUpdateAsync(updateInfo, progress);
        
        if (success)
        {
            progressWindow.Close();
            
            var result = MessageBox.Show(
                "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ.\n\n" +
                "–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–∫—Ä—ã—Ç—å iiko.\n" +
                "–ó–∞–∫—Ä—ã—Ç—å iiko –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–π—á–∞—Å?",
                "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question
            );
            
            if (result == MessageBoxResult.Yes)
            {
                updateChecker.InstallUpdate(Path.Combine(Path.GetTempPath(), "MaxLoyaltyUpdate.exe"));
            }
        }
        else
        {
            progressWindow.Close();
            
            MessageBox.Show(
                "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.\n\n" +
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.",
                "–û—à–∏–±–∫–∞",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
}
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ 47-50 (rollback, –ø–æ–¥–¥–µ—Ä–∂–∫–∞, —É–¥–∞–ª–µ–Ω–∏–µ)?

---

### **–í–û–ü–†–û–° 47: –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ (rollback)**

**–í–û–ü–†–û–°:** –ö–∞–∫ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–æ–º–∞–ª–æ –ø–ª–∞–≥–∏–Ω?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ù–µ–ª—å–∑—è, —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
- **B)** Backup —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ + —Å–∫—Ä–∏–ø—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- **C)** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–ø—É—Å–∫–∞
- **D)** –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ + –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –≤–µ—Ä—Å–∏–∏ –≤ installer

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: B) Backup + manual rollback**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** Backup —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ **–ö–æ–Ω—Ç—Ä–æ–ª—å:** –ê–¥–º–∏–Ω —Ä–µ—à–∞–µ—Ç –∫–æ–≥–¥–∞ –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –ù–µ –Ω—É–∂–Ω–∞ —Å–ª–æ–∂–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ **–ò—Å—Ç–æ—Ä–∏—è:** –•—Ä–∞–Ω–∏–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–π

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class VersionManager
{
    private readonly string pluginPath;
    private readonly string backupBasePath;
    private readonly ILogger logger;
    
    private const int MAX_BACKUPS = 3; // –•—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –≤–µ—Ä—Å–∏–∏
    
    public VersionManager()
    {
        pluginPath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ProgramFiles),
            "iiko",
            "Plugins"
        );
        
        backupBasePath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "MaxLoyaltyIiko",
            "backups"
        );
        
        Directory.CreateDirectory(backupBasePath);
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ backup –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
    public string CreateBackup(string currentVersion)
    {
        try
        {
            var timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
            var backupPath = Path.Combine(backupBasePath, $"v{currentVersion}_{timestamp}");
            
            Directory.CreateDirectory(backupPath);
            
            logger.LogInformation("Creating backup: {BackupPath}", backupPath);
            
            // –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –ø–ª–∞–≥–∏–Ω–∞
            var filesToBackup = new[]
            {
                "MaxLoyaltyIikoPlugin.dll",
                "Newtonsoft.Json.dll",
                "Serilog.dll",
                "Serilog.Sinks.File.dll"
            };
            
            foreach (var file in filesToBackup)
            {
                var sourcePath = Path.Combine(pluginPath, file);
                var targetPath = Path.Combine(backupPath, file);
                
                if (File.Exists(sourcePath))
                {
                    File.Copy(sourcePath, targetPath, overwrite: false);
                    logger.LogDebug("Backed up: {File}", file);
                }
            }
            
            // –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            var configPath = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                "MaxLoyaltyIiko",
                "config.json.encrypted"
            );
            
            if (File.Exists(configPath))
            {
                File.Copy(
                    configPath,
                    Path.Combine(backupPath, "config.json.encrypted"),
                    overwrite: false
                );
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ backup
            var metadata = new BackupMetadata
            {
                Version = currentVersion,
                CreatedAt = DateTime.Now,
                IikoVersion = versionManager.GetVersion().ToString(),
                Files = filesToBackup.ToList()
            };
            
            var metadataJson = JsonConvert.SerializeObject(metadata, Formatting.Indented);
            File.WriteAllText(Path.Combine(backupPath, "metadata.json"), metadataJson);
            
            logger.LogInformation("Backup created successfully: {BackupPath}", backupPath);
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ backup'—ã
            CleanupOldBackups();
            
            return backupPath;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to create backup");
            throw;
        }
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö backup'–æ–≤
    public List<BackupInfo> GetAvailableBackups()
    {
        try
        {
            var backups = new List<BackupInfo>();
            
            if (!Directory.Exists(backupBasePath))
                return backups;
            
            var backupDirs = Directory.GetDirectories(backupBasePath)
                .OrderByDescending(d => Directory.GetCreationTime(d))
                .ToList();
            
            foreach (var dir in backupDirs)
            {
                var metadataPath = Path.Combine(dir, "metadata.json");
                
                if (!File.Exists(metadataPath))
                    continue;
                
                try
                {
                    var json = File.ReadAllText(metadataPath);
                    var metadata = JsonConvert.DeserializeObject<BackupMetadata>(json);
                    
                    backups.Add(new BackupInfo
                    {
                        Path = dir,
                        Version = metadata.Version,
                        CreatedAt = metadata.CreatedAt,
                        IikoVersion = metadata.IikoVersion,
                        Size = GetDirectorySize(dir)
                    });
                }
                catch (Exception ex)
                {
                    logger.LogWarning(ex, "Failed to load backup metadata: {Path}", dir);
                }
            }
            
            return backups;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to get available backups");
            return new List<BackupInfo>();
        }
    }
    
    // –û—Ç–∫–∞—Ç –∫ backup
    public bool RestoreBackup(string backupPath)
    {
        try
        {
            logger.LogInformation("Restoring backup: {BackupPath}", backupPath);
            
            if (!Directory.Exists(backupPath))
            {
                logger.LogError("Backup path does not exist: {Path}", backupPath);
                return false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ iiko –Ω–µ –∑–∞–ø—É—â–µ–Ω
            var iikoProcesses = Process.GetProcessesByName("iiko");
            if (iikoProcesses.Any())
            {
                logger.LogError("Cannot restore backup: iiko is running");
                throw new InvalidOperationException("–ó–∞–∫—Ä–æ–π—Ç–µ iiko –ø–µ—Ä–µ–¥ –æ—Ç–∫–∞—Ç–æ–º");
            }
            
            // –°–æ–∑–¥–∞–µ–º backup —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            var currentVersion = GetCurrentVersion();
            CreateBackup(currentVersion);
            
            // –ß–∏—Ç–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ backup
            var metadataPath = Path.Combine(backupPath, "metadata.json");
            var metadata = JsonConvert.DeserializeObject<BackupMetadata>(
                File.ReadAllText(metadataPath)
            );
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã
            foreach (var file in metadata.Files)
            {
                var sourcePath = Path.Combine(backupPath, file);
                var targetPath = Path.Combine(pluginPath, file);
                
                if (!File.Exists(sourcePath))
                {
                    logger.LogWarning("Backup file not found: {File}", file);
                    continue;
                }
                
                // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª
                if (File.Exists(targetPath))
                {
                    File.Delete(targetPath);
                }
                
                // –ö–æ–ø–∏—Ä—É–µ–º –∏–∑ backup
                File.Copy(sourcePath, targetPath, overwrite: true);
                
                logger.LogDebug("Restored: {File}", file);
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            var backupConfigPath = Path.Combine(backupPath, "config.json.encrypted");
            if (File.Exists(backupConfigPath))
            {
                var targetConfigPath = Path.Combine(
                    Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                    "MaxLoyaltyIiko",
                    "config.json.encrypted"
                );
                
                File.Copy(backupConfigPath, targetConfigPath, overwrite: true);
            }
            
            logger.LogInformation(
                "Backup restored successfully: Version {Version}",
                metadata.Version
            );
            
            return true;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to restore backup");
            return false;
        }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö backup'–æ–≤
    private void CleanupOldBackups()
    {
        try
        {
            var backupDirs = Directory.GetDirectories(backupBasePath)
                .OrderByDescending(d => Directory.GetCreationTime(d))
                .ToList();
            
            if (backupDirs.Count <= MAX_BACKUPS)
                return;
            
            var backupsToDelete = backupDirs.Skip(MAX_BACKUPS);
            
            foreach (var dir in backupsToDelete)
            {
                Directory.Delete(dir, recursive: true);
                logger.LogInformation("Deleted old backup: {Path}", dir);
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to cleanup old backups");
        }
    }
    
    private long GetDirectorySize(string path)
    {
        var dirInfo = new DirectoryInfo(path);
        return dirInfo.EnumerateFiles("*", SearchOption.AllDirectories)
            .Sum(file => file.Length);
    }
}

public class BackupMetadata
{
    public string Version { get; set; }
    public DateTime CreatedAt { get; set; }
    public string IikoVersion { get; set; }
    public List<string> Files { get; set; }
}

public class BackupInfo
{
    public string Path { get; set; }
    public string Version { get; set; }
    public DateTime CreatedAt { get; set; }
    public string IikoVersion { get; set; }
    public long Size { get; set; }
}
```

**UI –¥–ª—è rollback:**

```csharp
public class RollbackWindow : Window
{
    private readonly VersionManager versionManager;
    private ListBox backupsListBox;
    
    public RollbackWindow(VersionManager versionManager)
    {
        this.versionManager = versionManager;
        
        Title = "–û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏";
        Width = 600;
        Height = 450;
        WindowStartupLocation = WindowStartupLocation.CenterScreen;
        
        InitializeUI();
        LoadBackups();
    }
    
    private void InitializeUI()
    {
        var panel = new DockPanel { Margin = new Thickness(20) };
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        var header = new TextBlock
        {
            Text = "–î–æ—Å—Ç—É–ø–Ω—ã–µ backup'—ã",
            FontSize = 16,
            FontWeight = FontWeights.Bold,
            Margin = new Thickness(0, 0, 0, 15)
        };
        DockPanel.SetDock(header, Dock.Top);
        panel.Children.Add(header);
        
        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        var warning = new Border
        {
            Background = new SolidColorBrush(Color.FromRgb(254, 243, 199)),
            BorderBrush = new SolidColorBrush(Color.FromRgb(251, 191, 36)),
            BorderThickness = new Thickness(1),
            CornerRadius = new CornerRadius(6),
            Padding = new Thickness(15),
            Margin = new Thickness(0, 0, 0, 15),
            Child = new StackPanel
            {
                Children =
                {
                    new TextBlock
                    {
                        Text = "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!",
                        FontWeight = FontWeights.Bold,
                        Foreground = new SolidColorBrush(Color.FromRgb(120, 53, 15))
                    },
                    new TextBlock
                    {
                        Text = "–û—Ç–∫–∞—Ç –∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –ø–ª–∞–≥–∏–Ω–∞ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é. " +
                               "–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ iiko –∑–∞–∫—Ä—ã—Ç –ø–µ—Ä–µ–¥ –æ—Ç–∫–∞—Ç–æ–º.",
                        TextWrapping = TextWrapping.Wrap,
                        Foreground = new SolidColorBrush(Color.FromRgb(120, 53, 15)),
                        Margin = new Thickness(0, 5, 0, 0)
                    }
                }
            }
        };
        DockPanel.SetDock(warning, Dock.Top);
        panel.Children.Add(warning);
        
        // –°–ø–∏—Å–æ–∫ backup'–æ–≤
        backupsListBox = new ListBox
        {
            DisplayMemberPath = "DisplayName"
        };
        panel.Children.Add(backupsListBox);
        
        // –ö–Ω–æ–ø–∫–∏
        var buttonsPanel = new StackPanel
        {
            Orientation = Orientation.Horizontal,
            HorizontalAlignment = HorizontalAlignment.Right,
            Margin = new Thickness(0, 15, 0, 0)
        };
        DockPanel.SetDock(buttonsPanel, Dock.Bottom);
        
        var restoreButton = new Button
        {
            Content = "–û—Ç–∫–∞—Ç–∏—Ç—å",
            Width = 120,
            Height = 35,
            Margin = new Thickness(0, 0, 10, 0)
        };
        restoreButton.Click += OnRestoreClick;
        
        var deleteButton = new Button
        {
            Content = "–£–¥–∞–ª–∏—Ç—å backup",
            Width = 130,
            Height = 35,
            Margin = new Thickness(0, 0, 10, 0)
        };
        deleteButton.Click += OnDeleteClick;
        
        var closeButton = new Button
        {
            Content = "–ó–∞–∫—Ä—ã—Ç—å",
            Width = 100,
            Height = 35
        };
        closeButton.Click += (s, e) => Close();
        
        buttonsPanel.Children.Add(restoreButton);
        buttonsPanel.Children.Add(deleteButton);
        buttonsPanel.Children.Add(closeButton);
        panel.Children.Add(buttonsPanel);
        
        Content = panel;
    }
    
    private void LoadBackups()
    {
        var backups = versionManager.GetAvailableBackups();
        
        backupsListBox.Items.Clear();
        
        if (!backups.Any())
        {
            backupsListBox.Items.Add(new
            {
                DisplayName = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö backup'–æ–≤"
            });
            return;
        }
        
        foreach (var backup in backups)
        {
            var sizeMB = backup.Size / (1024.0 * 1024.0);
            
            backupsListBox.Items.Add(new
            {
                Backup = backup,
                DisplayName = $"–í–µ—Ä—Å–∏—è {backup.Version} - {backup.CreatedAt:dd.MM.yyyy HH:mm} " +
                             $"(iiko {backup.IikoVersion}, {sizeMB:N1} MB)"
            });
        }
    }
    
    private void OnRestoreClick(object sender, RoutedEventArgs e)
    {
        var selected = backupsListBox.SelectedItem as dynamic;
        if (selected?.Backup == null)
        {
            MessageBox.Show(
                "–í—ã–±–µ—Ä–∏—Ç–µ backup –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è",
                "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ",
                MessageBoxButton.OK,
                MessageBoxImage.Warning
            );
            return;
        }
        
        BackupInfo backup = selected.Backup;
        
        var result = MessageBox.Show(
            $"–û—Ç–∫–∞—Ç–∏—Ç—å –ø–ª–∞–≥–∏–Ω –∫ –≤–µ—Ä—Å–∏–∏ {backup.Version}?\n\n" +
            $"–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–∞.\n" +
            $"iiko –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Å–ª–µ –æ—Ç–∫–∞—Ç–∞.",
            "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–∫–∞—Ç–∞",
            MessageBoxButton.YesNo,
            MessageBoxImage.Question
        );
        
        if (result != MessageBoxResult.Yes)
            return;
        
        try
        {
            var success = versionManager.RestoreBackup(backup.Path);
            
            if (success)
            {
                MessageBox.Show(
                    $"–û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!\n\n" +
                    $"–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è: {backup.Version}\n" +
                    $"–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ iiko –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.",
                    "–û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω",
                    MessageBoxButton.OK,
                    MessageBoxImage.Information
                );
                
                DialogResult = true;
                Close();
            }
            else
            {
                MessageBox.Show(
                    "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ—Ç–∫–∞—Ç.\n\n" +
                    "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.",
                    "–û—à–∏–±–∫–∞",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error
                );
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show(
                $"–û—à–∏–±–∫–∞ –æ—Ç–∫–∞—Ç–∞:\n\n{ex.Message}",
                "–û—à–∏–±–∫–∞",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
    
    private void OnDeleteClick(object sender, RoutedEventArgs e)
    {
        var selected = backupsListBox.SelectedItem as dynamic;
        if (selected?.Backup == null)
        {
            MessageBox.Show(
                "–í—ã–±–µ—Ä–∏—Ç–µ backup –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è",
                "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ",
                MessageBoxButton.OK,
                MessageBoxImage.Warning
            );
            return;
        }
        
        BackupInfo backup = selected.Backup;
        
        var result = MessageBox.Show(
            $"–£–¥–∞–ª–∏—Ç—å backup –≤–µ—Ä—Å–∏–∏ {backup.Version}?",
            "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è",
            MessageBoxButton.YesNo,
            MessageBoxImage.Question
        );
        
        if (result != MessageBoxResult.Yes)
            return;
        
        try
        {
            Directory.Delete(backup.Path, recursive: true);
            
            MessageBox.Show(
                "Backup —É–¥–∞–ª–µ–Ω",
                "–£—Å–ø–µ—à–Ω–æ",
                MessageBoxButton.OK,
                MessageBoxImage.Information
            );
            
            LoadBackups();
        }
        catch (Exception ex)
        {
            MessageBox.Show(
                $"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:\n\n{ex.Message}",
                "–û—à–∏–±–∫–∞",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
}
```


***

### **–í–û–ü–†–û–° 48: –£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–ª–∞–≥–∏–Ω –∏–∑ —Å–∏—Å—Ç–µ–º—ã?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –ü—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç—å DLL —Ñ–∞–π–ª—ã
- **B)** Uninstaller.exe —Å GUI
- **C)** Windows "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º"
- **D)** Uninstaller + cleanup –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) Uninstaller —Å –ø–æ–ª–Ω—ã–º cleanup**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–ß–∏—Å—Ç–æ—Ç–∞:** –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–ª–µ–¥—ã –ø–ª–∞–≥–∏–Ω–∞
- ‚úÖ **–í—ã–±–æ—Ä:** –ê–¥–º–∏–Ω —Ä–µ—à–∞–µ—Ç —á—Ç–æ —É–¥–∞–ª—è—Ç—å (–ª–æ–≥–∏, –∫–æ–Ω—Ñ–∏–≥)
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –û—Ç–º–µ–Ω—è–µ–º –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ **Feedback:** –ú–æ–∂–µ–º —Å–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É —É–¥–∞–ª–µ–Ω–∏—è

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class UninstallerProgram
{
    [STAThread]
    static async Task Main(string[] args)
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—â–µ–Ω –ª–∏ silent mode
        var silentMode = args.Contains("/silent") || args.Contains("-s");
        
        if (silentMode)
        {
            await PerformSilentUninstallAsync();
        }
        else
        {
            var app = new Application();
            var wizard = new UninstallWizard();
            app.Run(wizard);
        }
    }
}

public class UninstallWizard : Window
{
    private int currentStep = 0;
    private UninstallOptions options;
    
    public UninstallWizard()
    {
        Title = "–£–¥–∞–ª–µ–Ω–∏–µ Max Loyalty –¥–ª—è iiko";
        Width = 600;
        Height = 450;
        WindowStartupLocation = WindowStartupLocation.CenterScreen;
        
        options = new UninstallOptions();
        
        InitializeUI();
    }
    
    // –®–∞–≥ 1: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    private UIElement CreateConfirmationStep()
    {
        var panel = new StackPanel { Margin = new Thickness(30) };
        
        panel.Children.Add(new TextBlock
        {
            Text = "‚ùì",
            FontSize = 64,
            HorizontalAlignment = HorizontalAlignment.Center,
            Margin = new Thickness(0, 20, 0, 30)
        });
        
        panel.Children.Add(new TextBlock
        {
            Text = "–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å Max Loyalty?",
            FontSize = 16,
            FontWeight = FontWeights.Bold,
            HorizontalAlignment = HorizontalAlignment.Center,
            TextWrapping = TextWrapping.Wrap,
            Margin = new Thickness(0, 0, 0, 20)
        });
        
        panel.Children.Add(new TextBlock
        {
            Text = "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –ø–ª–∞–≥–∏–Ω –∏–∑ iiko Front.\n" +
                   "–í—ã —Å–º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ–≥–æ –ø–æ–∑–∂–µ.",
            TextAlignment = TextAlignment.Center,
            TextWrapping = TextWrapping.Wrap,
            Foreground = Brushes.Gray,
            Margin = new Thickness(0, 0, 0, 30)
        });
        
        // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π feedback
        panel.Children.Add(new TextBlock
        {
            Text = "–ü–æ—á–µ–º—É –≤—ã —É–¥–∞–ª—è–µ—Ç–µ –ø–ª–∞–≥–∏–Ω? (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)",
            FontWeight = FontWeights.Bold,
            Margin = new Thickness(0, 0, 0, 10)
        });
        
        var reasonComboBox = new ComboBox
        {
            Margin = new Thickness(0, 0, 0, 10)
        };
        reasonComboBox.Items.Add("–ù–µ –Ω—É–∂–µ–Ω");
        reasonComboBox.Items.Add("–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ");
        reasonComboBox.Items.Add("–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –¥—Ä—É–≥—É—é —Å–∏—Å—Ç–µ–º—É");
        reasonComboBox.Items.Add("–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ");
        reasonComboBox.Items.Add("–î—Ä—É–≥–æ–µ");
        reasonComboBox.SelectedIndex = 0;
        
        panel.Children.Add(reasonComboBox);
        
        var feedbackTextBox = new TextBox
        {
            Height = 80,
            TextWrapping = TextWrapping.Wrap,
            AcceptsReturn = true,
            VerticalScrollBarVisibility = ScrollBarVisibility.Auto
        };
        feedbackTextBox.SetValue(TextBox.PlaceholderTextProperty, "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏...");
        panel.Children.Add(feedbackTextBox);
        
        return panel;
    }
    
    // –®–∞–≥ 2: –û–ø—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è
    private UIElement CreateOptionsStep()
    {
        var panel = new StackPanel { Margin = new Thickness(30) };
        
        panel.Children.Add(new TextBlock
        {
            Text = "–ß—Ç–æ —É–¥–∞–ª–∏—Ç—å?",
            FontSize = 16,
            FontWeight = FontWeights.Bold,
            Margin = new Thickness(0, 0, 0, 20)
        });
        
        var deletePluginCheckbox = new CheckBox
        {
            Content = "–§–∞–π–ª—ã –ø–ª–∞–≥–∏–Ω–∞",
            IsChecked = true,
            IsEnabled = false, // –í—Å–µ–≥–¥–∞ —É–¥–∞–ª—è–µ–º
            Margin = new Thickness(0, 0, 0, 15)
        };
        panel.Children.Add(deletePluginCheckbox);
        
        var deleteConfigCheckbox = new CheckBox
        {
            Content = "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (API –∫–ª—é—á, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)",
            IsChecked = true,
            Margin = new Thickness(0, 0, 0, 15)
        };
        deleteConfigCheckbox.Checked += (s, e) => options.DeleteConfig = true;
        deleteConfigCheckbox.Unchecked += (s, e) => options.DeleteConfig = false;
        panel.Children.Add(deleteConfigCheckbox);
        
        var deleteLogsCheckbox = new CheckBox
        {
            Content = "–õ–æ–≥–∏ –ø–ª–∞–≥–∏–Ω–∞",
            IsChecked = false,
            Margin = new Thickness(0, 0, 0, 15)
        };
        deleteLogsCheckbox.Checked += (s, e) => options.DeleteLogs = true;
        deleteLogsCheckbox.Unchecked += (s, e) => options.DeleteLogs = false;
        panel.Children.Add(deleteLogsCheckbox);
        
        var deleteOfflineQueueCheckbox = new CheckBox
        {
            Content = "Offline –æ—á–µ—Ä–µ–¥—å",
            IsChecked = false,
            Margin = new Thickness(0, 0, 0, 15)
        };
        deleteOfflineQueueCheckbox.Checked += (s, e) => options.DeleteOfflineQueue = true;
        deleteOfflineQueueCheckbox.Unchecked += (s, e) => options.DeleteOfflineQueue = false;
        panel.Children.Add(deleteOfflineQueueCheckbox);
        
        var deleteBackupsCheckbox = new CheckBox
        {
            Content = "Backup'—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π",
            IsChecked = false,
            Margin = new Thickness(0, 0, 0, 15)
        };
        deleteBackupsCheckbox.Checked += (s, e) => options.DeleteBackups = true;
        deleteBackupsCheckbox.Unchecked += (s, e) => options.DeleteBackups = false;
        panel.Children.Add(deleteBackupsCheckbox);
        
        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        panel.Children.Add(new Border
        {
            Background = new SolidColorBrush(Color.FromRgb(254, 243, 199)),
            BorderBrush = new SolidColorBrush(Color.FromRgb(251, 191, 36)),
            BorderThickness = new Thickness(1),
            CornerRadius = new CornerRadius(6),
            Padding = new Thickness(15),
            Margin = new Thickness(0, 20, 0, 0),
            Child = new TextBlock
            {
                Text = "‚ö†Ô∏è –ï—Å–ª–∏ –≤ offline –æ—á–µ—Ä–µ–¥–∏ –µ—Å—Ç—å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, " +
                       "–∏—Ö —É–¥–∞–ª–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è—Ö –±–∞–ª–ª–æ–≤.",
                TextWrapping = TextWrapping.Wrap,
                Foreground = new SolidColorBrush(Color.FromRgb(120, 53, 15))
            }
        });
        
        return panel;
    }
    
    // –®–∞–≥ 3: –£–¥–∞–ª–µ–Ω–∏–µ
    private UIElement CreateUninstallStep()
    {
        var panel = new StackPanel { Margin = new Thickness(30) };
        
        var statusText = new TextBlock
        {
            Text = "–£–¥–∞–ª–µ–Ω–∏–µ...",
            FontSize = 14,
            Margin = new Thickness(0, 20, 0, 15)
        };
        panel.Children.Add(statusText);
        
        var progressBar = new ProgressBar
        {
            Height = 25,
            Minimum = 0,
            Maximum = 100,
            Value = 0
        };
        panel.Children.Add(progressBar);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
        Task.Run(async () =>
        {
            await PerformUninstallAsync(options, 
                status => Application.Current.Dispatcher.Invoke(() => statusText.Text = status),
                progress => Application.Current.Dispatcher.Invoke(() => progressBar.Value = progress)
            );
            
            Application.Current.Dispatcher.Invoke(() =>
            {
                ShowStep(3); // –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
            });
        });
        
        return panel;
    }
    
    // –ü—Ä–æ—Ü–µ—Å—Å —É–¥–∞–ª–µ–Ω–∏—è
    private async Task PerformUninstallAsync(
        UninstallOptions options,
        Action<string> updateStatus,
        Action<int> updateProgress)
    {
        try
        {
            updateStatus("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...");
            updateProgress(10);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ iiko –Ω–µ –∑–∞–ø—É—â–µ–Ω
            var iikoProcesses = Process.GetProcessesByName("iiko");
            if (iikoProcesses.Any())
            {
                throw new InvalidOperationException("–ó–∞–∫—Ä–æ–π—Ç–µ iiko –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –ø–ª–∞–≥–∏–Ω–∞");
            }
            
            await Task.Delay(500);
            
            // –û—Ç–º–µ–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
            updateStatus("–û—Ç–º–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π...");
            updateProgress(20);
            
            await CancelActiveReservationsAsync();
            
            await Task.Delay(500);
            
            // –£–≤–µ–¥–æ–º–ª—è–µ–º backend –æ–± —É–¥–∞–ª–µ–Ω–∏–∏
            updateStatus("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞...");
            updateProgress(30);
            
            await NotifyBackendUninstallAsync();
            
            await Task.Delay(500);
            
            // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã –ø–ª–∞–≥–∏–Ω–∞
            updateStatus("–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–ª–∞–≥–∏–Ω–∞...");
            updateProgress(40);
            
            var pluginPath = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.ProgramFiles),
                "iiko",
                "Plugins"
            );
            
            var filesToDelete = new[]
            {
                "MaxLoyaltyIikoPlugin.dll",
                "Newtonsoft.Json.dll",
                "Serilog.dll",
                "Serilog.Sinks.File.dll"
            };
            
            foreach (var file in filesToDelete)
            {
                var filePath = Path.Combine(pluginPath, file);
                if (File.Exists(filePath))
                {
                    File.Delete(filePath);
                }
            }
            
            await Task.Delay(500);
            
            // –£–¥–∞–ª—è–µ–º AppData
            var appDataPath = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                "MaxLoyaltyIiko"
            );
            
            if (options.DeleteConfig)
            {
                updateStatus("–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...");
                updateProgress(50);
                
                var configPath = Path.Combine(appDataPath, "config.json.encrypted");
                if (File.Exists(configPath))
                {
                    File.Delete(configPath);
                }
            }
            
            if (options.DeleteLogs)
            {
                updateStatus("–£–¥–∞–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤...");
                updateProgress(60);
                
                var logsPath = Path.Combine(appDataPath, "logs");
                if (Directory.Exists(logsPath))
                {
                    Directory.Delete(logsPath, recursive: true);
                }
            }
            
            if (options.DeleteOfflineQueue)
            {
                updateStatus("–£–¥–∞–ª–µ–Ω–∏–µ offline –æ—á–µ—Ä–µ–¥–∏...");
                updateProgress(70);
                
                var queuePath = Path.Combine(appDataPath, "offline-queue.json");
                if (File.Exists(queuePath))
                {
                    File.Delete(queuePath);
                }
            }
            
            if (options.DeleteBackups)
            {
                updateStatus("–£–¥–∞–ª–µ–Ω–∏–µ backup'–æ–≤...");
                updateProgress(80);
                
                var backupsPath = Path.Combine(appDataPath, "backups");
                if (Directory.Exists(backupsPath))
                {
                    Directory.Delete(backupsPath, recursive: true);
                }
            }
            
            // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—É—é –ø–∞–ø–∫—É AppData –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å
            if (Directory.Exists(appDataPath) && !Directory.EnumerateFileSystemEntries(appDataPath).Any())
            {
                Directory.Delete(appDataPath);
            }
            
            updateStatus("–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!");
            updateProgress(100);
            
            await Task.Delay(1000);
        }
        catch (Exception ex)
        {
            updateStatus($"–û—à–∏–±–∫–∞: {ex.Message}");
            throw;
        }
    }
    
    private async Task CancelActiveReservationsAsync()
    {
        try
        {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –∑–∞–∫–∞–∑–æ–≤
            var contextStorage = new LoyaltyContextStorage();
            var contexts = contextStorage.GetAllContexts();
            
            // –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
            var apiClient = new LoyaltyApiClient();
            
            foreach (var context in contexts.Where(c => c.ReservationId != null))
            {
                try
                {
                    await apiClient.CancelReservationAsync(new CancelReservationRequest
                    {
                        ReservationId = context.ReservationId,
                        OrderId = context.OrderId,
                        Reason = "PLUGIN_UNINSTALL"
                    });
                }
                catch
                {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ - –ø–ª–∞–≥–∏–Ω —É–¥–∞–ª—è–µ—Ç—Å—è
                }
            }
        }
        catch
        {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
        }
    }
    
    private async Task NotifyBackendUninstallAsync()
    {
        try
        {
            var apiClient = new LoyaltyApiClient();
            
            await apiClient.PostAsync("/api/plugin/uninstall", new
            {
                restaurantId = configService.GetRestaurantId(),
                version = GetCurrentVersion(),
                timestamp = DateTime.UtcNow
            });
        }
        catch
        {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
        }
    }
}

public class UninstallOptions
{
    public bool DeleteConfig { get; set; } = true;
    public bool DeleteLogs { get; set; } = false;
    public bool DeleteOfflineQueue { get; set; } = false;
    public bool DeleteBackups { get; set; } = false;
}
```


***

### **–í–û–ü–†–û–° 49: –ü—Ä–æ—Ü–µ—Å—Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏**

**–í–û–ü–†–û–°:** –ö–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –¢–æ–ª—å–∫–æ email support
- **B)** Email + –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π
- **C)** Email + –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π + —á–∞—Ç
- **D)** –ú–Ω–æ–≥–æ–∫–∞–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ + –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: D) –ú–Ω–æ–≥–æ–∫–∞–Ω–∞–ª—å–Ω–∞—è + –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:** –†–∞–∑–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π
- ‚úÖ **–°–∫–æ—Ä–æ—Å—Ç—å:** –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ –Ω–∞—Ö–æ–¥–∏–º –ø—Ä–æ–±–ª–µ–º—ã
- ‚úÖ **–°–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ:** –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É
- ‚úÖ **–≠—Å–∫–∞–ª–∞—Ü–∏—è:** –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏:**

```typescript
// Backend - —Å–∏—Å—Ç–µ–º–∞ —Ç–∏–∫–µ—Ç–æ–≤
@Injectable()
export class SupportService {
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ
  async createTicketFromError(error: PluginError): Promise<Ticket> {
    const ticket = await this.prisma.ticket.create({
      data: {
        restaurantId: error.restaurantId,
        type: 'AUTO_CREATED',
        priority: this.calculatePriority(error),
        subject: `Plugin Error: ${error.errorType}`,
        description: this.formatErrorForTicket(error),
        source: 'AUTO',
        status: 'OPEN',
        metadata: {
          errorId: error.id,
          pluginVersion: error.pluginVersion,
          stackTrace: error.stackTrace
        }
      }
    });
    
    // –ï—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ - —Å—Ä–∞–∑—É —É–≤–µ–¥–æ–º–ª—è–µ–º support
    if (ticket.priority === 'CRITICAL') {
      await this.notifySupport(ticket);
    }
    
    return ticket;
  }
  
  private calculatePriority(error: PluginError): TicketPriority {
    // –ö—Ä–∏—Ç–∏—á–Ω–æ: –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–æ–æ–±—â–µ
    if (error.errorType === 'INITIALIZATION_FAILED' ||
        error.errorType === 'BACKEND_UNREACHABLE' ||
        error.consecutiveFailures > 10) {
      return 'CRITICAL';
    }
    
    // –í—ã—Å–æ–∫–æ: —á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏
    if (error.consecutiveFailures > 5) {
      return 'HIGH';
    }
    
    // –°—Ä–µ–¥–Ω–µ: —Ä–∞–∑–æ–≤—ã–µ –æ—à–∏–±–∫–∏
    if (error.errorType.includes('TIMEOUT') ||
        error.errorType.includes('NETWORK')) {
      return 'MEDIUM';
    }
    
    return 'LOW';
  }
  
  // –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
  @Cron('*/5 * * * *') // –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
  async checkPluginHealth() {
    // –ù–∞—Ö–æ–¥–∏–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏
    const problematicRestaurants = await this.prisma.pluginMetric.groupBy({
      by: ['restaurantId'],
      where: {
        name: 'api.request.failed',
        timestamp: {
          gte: new Date(Date.now() - 30 * 60 * 1000) // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –º–∏–Ω—É—Ç
        }
      },
      _count: {
        value: true
      },
      having: {
        value: {
          _count: {
            gt: 10 // –ë–æ–ª—å—à–µ 10 –æ—à–∏–±–æ–∫ –∑–∞ 30 –º–∏–Ω—É—Ç
          }
        }
      }
    });
    
    for (const restaurant of problematicRestaurants) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã–π —Ç–∏–∫–µ—Ç
      const existingTicket = await this.prisma.ticket.findFirst({
        where: {
          restaurantId: restaurant.restaurantId,
          status: { in: ['OPEN', 'IN_PROGRESS'] },
          type: 'HEALTH_CHECK'
        }
      });
      
      if (!existingTicket) {
        // –°–æ–∑–¥–∞–µ–º —Ç–∏–∫–µ—Ç
        await this.createTicket({
          restaurantId: restaurant.restaurantId,
          type: 'HEALTH_CHECK',
          priority: 'MEDIUM',
          subject: 'High error rate detected',
          description: `Plugin experiencing high error rate: ${restaurant._count.value} errors in last 30 minutes`,
          source: 'MONITORING'
        });
      }
    }
  }
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ support —á–∞—Ç
  private async notifySupport(ticket: Ticket) {
    const restaurant = await this.prisma.restaurant.findUnique({
      where: { id: ticket.restaurantId }
    });
    
    // Telegram notification
    await this.telegram.sendMessage({
      chatId: process.env.SUPPORT_CHAT_ID,
      text: `üö® –ö—Ä–∏—Ç–∏—á–Ω—ã–π —Ç–∏–∫–µ—Ç #${ticket.id}\n\n` +
            `–†–µ—Å—Ç–æ—Ä–∞–Ω: ${restaurant.name}\n` +
            `–ü—Ä–æ–±–ª–µ–º–∞: ${ticket.subject}\n\n` +
            `[–û—Ç–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç](${process.env.ADMIN_URL}/tickets/${ticket.id})`
    });
    
    // Email notification
    await this.email.send({
      to: 'support@maxloyalty.ru',
      subject: `[CRITICAL] Ticket #${ticket.id}: ${ticket.subject}`,
      template: 'support-alert',
      context: { ticket, restaurant }
    });
  }
}
```

**–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (Knowledge Base):**

```typescript
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
interface KnowledgeBaseArticle {
  id: string;
  title: string;
  category: 'installation' | 'troubleshooting' | 'howto' | 'faq';
  tags: string[];
  content: string;
  searchKeywords: string[];
  relatedArticles: string[];
  views: number;
  helpful: number;
  notHelpful: number;
}

// –ü—Ä–∏–º–µ—Ä—ã —Å—Ç–∞—Ç–µ–π
const articles: KnowledgeBaseArticle[] = [
  {
    id: 'kb-001',
    title: '–ü–ª–∞–≥–∏–Ω –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ iiko –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏',
    category: 'troubleshooting',
    tags: ['—É—Å—Ç–∞–Ω–æ–≤–∫–∞', '–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', '–∫–Ω–æ–ø–∫–∞'],
    searchKeywords: ['–Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è', '–Ω–µ –≤–∏–¥–Ω–æ', '–∫–Ω–æ–ø–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', '–ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏'],
    content: `
## –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–≥–∏–Ω–∞ –∫–Ω–æ–ø–∫–∞ Max Loyalty –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ iiko Front.

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

### 1. iiko –Ω–µ –±—ã–ª –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä–æ–π—Ç–µ iiko Front –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.

### 2. –§–∞–π–ª—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–∞–ø–∫—É
**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É \`C:\\Program Files\\iiko\\Plugins\`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç–∞–º –µ—Å—Ç—å —Ñ–∞–π–ª \`MaxLoyaltyIikoPlugin.dll\`

**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω.

### 3. –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ó–∞–ø—É—Å—Ç–∏—Ç–µ iiko –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

### 4. –ü—Ä–æ–±–ª–µ–º—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤–µ—Ä—Å–∏–∏ iiko
**–ü—Ä–æ–≤–µ—Ä–∫–∞:** 
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è iiko: 7.5
- –û—Ç–∫—Ä–æ–π—Ç–µ iiko ‚Üí –°–ø—Ä–∞–≤–∫–∞ ‚Üí –û –ø—Ä–æ–≥—Ä–∞–º–º–µ

**–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç–µ iiko –¥–æ –≤–µ—Ä—Å–∏–∏ 7.5 –∏–ª–∏ –≤—ã—à–µ.

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª \`C:\\Program Files\\iiko\\Logs\\iiko.log\`
2. –ù–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º "MaxLoyalty"
3. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ª–æ–≥ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É

## –í—Å—ë –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?
[–°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É ‚Üí](https://admin.maxloyalty.ru/support)
    `,
    relatedArticles: ['kb-002', 'kb-010'],
    views: 1250,
    helpful: 98,
    notHelpful: 12
  },
  
  {
    id: 'kb-002',
    title: '–û—à–∏–±–∫–∞ "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É"',
    category: 'troubleshooting',
    tags: ['–æ—à–∏–±–∫–∞', '–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ', 'offline'],
    searchKeywords: ['–Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', '–Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è', '—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'offline'],
    content: `
## –ü—Ä–æ–±–ª–µ–º–∞
–ü–ª–∞–≥–∏–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É"

## –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
- –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä
- –ó–∞–π–¥–∏—Ç–µ –Ω–∞ https://maxloyalty.ru
- –ï—Å–ª–∏ —Å–∞–π—Ç –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è - –ø—Ä–æ–±–ª–µ–º–∞ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞
- –û—Ç–∫—Ä–æ–π—Ç–µ https://status.maxloyalty.ru
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç (–∑–µ–ª–µ–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã)

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall
–î–æ–±–∞–≤—å—Ç–µ –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è:
- \`MaxLoyaltyIikoPlugin.dll\`
- –î–æ–º–µ–Ω: \`*.maxloyalty.ru\`

## –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø–ª–∞–≥–∏–Ω–∞ (Ctrl+Shift+D)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"
3. –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–π—á–∞—Å"
4. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏

## Offline —Ä–µ–∂–∏–º
–ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ:
- ‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å)
- ‚ùå –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)
- ‚ùå –°–∫–∏–¥–∫–∞ —É—Ä–æ–≤–Ω—è (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)

–û–ø–µ—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞—é—Ç—Å—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- Email: support@maxloyalty.ru
- Telegram: @maxloyalty_support
- –¢–µ–ª–µ—Ñ–æ–Ω: +7 (495) 123-45-67
    `,
    relatedArticles: ['kb-006', 'kb-015'],
    views: 856,
    helpful: 76,
    notHelpful: 8
  }
];
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑ –ø–ª–∞–≥–∏–Ω–∞:**

```csharp
public class SupportHelper
{
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
    public static void OpenKnowledgeBase(string articleId = null)
    {
        var url = articleId != null
            ? $"https://docs.maxloyalty.ru/iiko-plugin/kb/{articleId}"
            : "https://docs.maxloyalty.ru/iiko-plugin";
        
        Process.Start(new ProcessStartInfo
        {
            FileName = url,
            UseShellExecute = true
        });
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ –∏–∑ –ø–ª–∞–≥–∏–Ω–∞
    public static async Task<string> CreateSupportTicketAsync(
        string subject,
        string description,
        SupportTicketPriority priority = SupportTicketPriority.Medium)
    {
        try
        {
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            var diagnostics = CollectDiagnostics();
            
            var request = new CreateTicketRequest
            {
                RestaurantId = configService.GetRestaurantId(),
                Subject = subject,
                Description = description,
                Priority = priority,
                Source = "PLUGIN",
                Diagnostics = diagnostics
            };
            
            var response = await apiClient.PostAsync<CreateTicketResponse>(
                "/api/support/tickets",
                request
            );
            
            return response.TicketId;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to create support ticket");
            throw;
        }
    }
    
    private static DiagnosticsData CollectDiagnostics()
    {
        return new DiagnosticsData
        {
            PluginVersion = GetCurrentVersion(),
            IikoVersion = versionManager.GetVersion().ToString(),
            OS = Environment.OSVersion.ToString(),
            LastErrors = GetRecentErrors(20),
            Metrics = metricsService.GetAggregatedMetrics(),
            OfflineQueueSize = offlineQueue.GetQueueSize(),
            ConfigSummary = GetConfigSummary()
        };
    }
}
```


***

### **–í–û–ü–†–û–° 50: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã**

**–í–û–ü–†–û–°:** –ö–∞–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–æ–≤ –Ω–∞ –≤—Å–µ—Ö –∫–∞—Å—Å–∞—Ö?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- **A)** –õ–æ–≥–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è, –∞–¥–º–∏–Ω —Å–º–æ—Ç—Ä–∏—Ç –≤—Ä—É—á–Ω—É—é
- **B)** Dashboard —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
- **C)** Dashboard + –∞–≤—Ç–æ–∞–ª–µ—Ä—Ç—ã –≤ Telegram
- **D)** –ü–æ–ª–Ω–∞—è observability –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ (metrics + logs + traces + alerts)

**üéØ –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: C) Dashboard + Telegram –∞–ª–µ—Ä—Ç—ã**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:** Dashboard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É
- ‚úÖ **–†–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:** –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- ‚úÖ **–ë–∞–ª–∞–Ω—Å:** –ù–µ overcomplicated, –Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
- ‚úÖ **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:** Telegram –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–≥–¥–∞

**Backend monitoring:**

```typescript
@Injectable()
export class MonitoringService {
  
  @Cron('*/1 * * * *') // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
  async checkPluginHealth() {
    const restaurants = await this.prisma.restaurant.findMany({
      where: { pluginInstalled: true },
      include: { pluginInstallation: true }
    });
    
    for (const restaurant of restaurants) {
      await this.checkRestaurantHealth(restaurant);
    }
  }
  
  private async checkRestaurantHealth(restaurant: Restaurant) {
    const metrics = await this.getRecentMetrics(restaurant.id);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    if (metrics.lastActivity < new Date(Date.now() - 60 * 60 * 1000)) {
      // –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ > 1 —á–∞—Å–∞
      await this.sendAlert({
        type: 'NO_ACTIVITY',
        severity: 'WARNING',
        restaurantId: restaurant.id,
        message: `No plugin activity for ${Math.round((Date.now() - metrics.lastActivity.getTime()) / (60 * 60 * 1000))} hours`
      });
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: Error rate
    const errorRate = metrics.failedRequests / metrics.totalRequests;
    if (errorRate > 0.1) { // > 10% –æ—à–∏–±–æ–∫
      await this.sendAlert({
        type: 'HIGH_ERROR_RATE',
        severity: 'CRITICAL',
        restaurantId: restaurant.id,
        message: `High error rate: ${(errorRate * 100).toFixed(1)}%`
      });
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: Offline queue —Ä–∞—Å—Ç–µ—Ç
    if (metrics.offlineQueueSize > 50) {
      await this.sendAlert({
        type: 'LARGE_OFFLINE_QUEUE',
        severity: 'WARNING',
        restaurantId: restaurant.id,
        message: `Offline queue size: ${metrics.offlineQueueSize}`
      });
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è
    const latestVersion = await this.getLatestPluginVersion();
    if (semver.lt(restaurant.pluginInstallation.version, latestVersion)) {
      await this.sendAlert({
        type: 'OUTDATED_VERSION',
        severity: 'INFO',
        restaurantId: restaurant.id,
        message: `Plugin version ${restaurant.pluginInstallation.version} is outdated (latest: ${latestVersion})`
      });
    }
  }
  
  private async sendAlert(alert: Alert) {
    // Telegram
    await this.telegram.sendMessage({
      chatId: process.env.MONITORING_CHAT_ID,
      text: this.formatAlertMessage(alert),
      parseMode: 'Markdown'
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
    await this.prisma.alert.create({
      data: alert
    });
  }
  
  private formatAlertMessage(alert: Alert): string {
    const emoji = {
      'CRITICAL': 'üö®',
      'WARNING': '‚ö†Ô∏è',
      'INFO': '‚ÑπÔ∏è'
    }[alert.severity];
    
    const restaurant = await this.prisma.restaurant.findUnique({
      where: { id: alert.restaurantId }
    });
    
    return `${emoji} *${alert.type}*\n\n` +
           `–†–µ—Å—Ç–æ—Ä–∞–Ω: ${restaurant.name}\n` +
           `–°–æ–æ–±—â–µ–Ω–∏–µ: ${alert.message}\n\n` +
           `[–û—Ç–∫—Ä—ã—Ç—å dashboard](${process.env.ADMIN_URL}/restaurants/${alert.restaurantId}/monitoring)`;
  }
}
```

**Admin Panel - Monitoring Dashboard:**

```tsx
export function MonitoringDashboard() {
  const { data: restaurants } = useQuery('restaurants-health', fetchRestaurantsHealth);
  
  return (
    <div>
      <h1>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–ª–∞–≥–∏–Ω–æ–≤</h1>
      
      {/* –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
      <div className="grid grid-cols-4 gap-4">
        <StatCard
          title="–í—Å–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤"
          value={restaurants?.total || 0}
          icon="üè™"
        />
        <StatCard
          title="Online"
          value={restaurants?.online || 0}
          color="green"
          icon="‚úÖ"
        />
        <StatCard
          title="–° –ø—Ä–æ–±–ª–µ–º–∞–º–∏"
          value={restaurants?.withIssues || 0}
          color="orange"
          icon="‚ö†Ô∏è"
        />
        <StatCard
          title="Offline"
          value={restaurants?.offline || 0}
          color="red"
          icon="‚ùå"
        />
      </div>
      
      {/* –¢–∞–±–ª–∏—Ü–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ */}
      <RestaurantsTable
        restaurants={restaurants?.list || []}
        columns={[
          { key: 'name', label: '–†–µ—Å—Ç–æ—Ä–∞–Ω' },
          { key: 'status', label: '–°—Ç–∞—Ç—É—Å', render: StatusBadge },
          { key: 'version', label: '–í–µ—Ä—Å–∏—è' },
          { key: 'lastActivity', label: '–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', render: RelativeTime },
          { key: 'errorRate', label: 'Error Rate', render: PercentageBar },
          { key: 'offlineQueueSize', label: 'Offline Queue' },
          { key: 'actions', label: '–î–µ–π—Å—Ç–≤–∏—è', render: ActionsMenu }
        ]}
      />
    </div>
  );
}
```


***

## **üìã –§–ò–ù–ê–õ–¨–ù–´–ô SUMMARY**

–û—Ç–ª–∏—á–Ω–æ! –ú—ã –ø—Ä–æ—à–ª–∏ **50 –∫–ª—é—á–µ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤** –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞–≥–∏–Ω–∞ Max Loyalty –¥–ª—è iiko Front.

### **–ò—Ç–æ–≥–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    iiko Front (Windows)                      ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ           Max Loyalty Plugin (C# WPF)                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Search Window (–ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è)                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Operation Window (—Å–ø–∏—Å–∞–Ω–∏–µ/–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ)             ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Diagnostics Window (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Error Handler (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Offline Queue (–æ—á–µ—Ä–µ–¥—å –æ–ø–µ—Ä–∞—Ü–∏–π)                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Context Storage (—Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤)                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Health Check (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)              ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Metrics Service (—Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫)                      ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                         ‚Üï iiko SDK API                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ              iiko Front Core                           ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üï HTTPS
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Max Loyalty Backend (NestJS)                ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ‚Ä¢ Guest API (–ø–æ–∏—Å–∫, –±–∞–ª–∞–Ω—Å, –∏—Å—Ç–æ—Ä–∏—è)                       ‚îÇ
‚îÇ  ‚Ä¢ Calculate API (—Ä–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤/—Å–∫–∏–¥–æ–∫)                     ‚îÇ
‚îÇ  ‚Ä¢ Reserve API (—Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –±–∞–ª–ª–æ–≤)                          ‚îÇ
‚îÇ  ‚Ä¢ Finalize API (–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π)                       ‚îÇ
‚îÇ  ‚Ä¢ Health Check API                                          ‚îÇ
‚îÇ  ‚Ä¢ Monitoring & Alerts                                       ‚îÇ
‚îÇ  ‚Ä¢ Support System (—Ç–∏–∫–µ—Ç—ã, KB)                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

‚úÖ **Offline-first** - —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - retry, exponential backoff, circuit breaker
‚úÖ **UX** - –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫, –ø–æ–Ω—è—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏, keyboard shortcuts
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –º–µ—Ç—Ä–∏–∫–∏, –ª–æ–≥–∏, –∞–ª–µ—Ä—Ç—ã, –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞** - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, rollback, –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π

**–ì–æ—Ç–æ–≤–æ –∫ production!** üöÄ

---

# üìä –§–ò–ù–ê–õ–¨–ù–´–ô –°–ü–ò–°–û–ö –†–ï–®–ï–ù–ò–ô –ü–û –í–°–ï–ú 50 –í–û–ü–†–û–°–ê–ú

## **–ë–õ–û–ö 1: –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ò –ë–ê–ó–û–í–ê–Ø –°–¢–†–£–ö–¢–£–†–ê (7 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **–í–û–ü–†–û–° 1: –Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) C\# + WPF –¥–ª—è UI
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ù–∞—Ç–∏–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å iiko SDK (.NET Framework)
- ‚úÖ WPF –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π UI —Å —Ç–µ–º–Ω–æ–π —Ç–µ–º–æ–π
- ‚úÖ –ë–æ–≥–∞—Ç–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫ (.NET)
- ‚úÖ –ó–Ω–∞–∫–æ–º –±–æ–ª—å—à–∏–Ω—Å—Ç–≤—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ C\#

***

### **–í–û–ü–†–û–° 2: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ iiko**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) –ê–≤—Ç–æ–ø–æ–∏—Å–∫ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø—É—Ç—è—Ö + —Ä—É—á–Ω–æ–π –≤–≤–æ–¥
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü–æ–∫—Ä—ã–≤–∞–µ—Ç 95% —Å–ª—É—á–∞–µ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å –¥–ª—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–æ–∫
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤

***

### **–í–û–ü–†–û–° 3: –•—Ä–∞–Ω–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) Encrypted config –≤ AppData + Windows DPAPI
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ API Key –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∞—à–∏–Ω–µ
- ‚úÖ DPAPI –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –º–∞—à–∏–Ω–µ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚úÖ –ù–µ—Ç hardcoded –∫–ª—é—á–µ–π —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç best practices –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

***

### **–í–û–ü–†–û–° 4: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) –ú–Ω–æ–≥–æ–ø—Ä–æ–µ–∫—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –ª–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ UI –æ—Ç–¥–µ–ª–µ–Ω –æ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –¥–ª—è –±—É–¥—É—â–∏—Ö —Ñ–∏—á

***

### **–í–û–ü–†–û–° 5: –ü–æ–¥—Ö–æ–¥ –∫ UI**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) WPF + MVVM + custom controls
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ MVVM - —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è WPF –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- ‚úÖ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å ViewModel
- ‚úÖ Custom controls = –µ–¥–∏–Ω—ã–π –¥–∏–∑–∞–π–Ω
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã Max Loyalty

***

### **–í–û–ü–†–û–° 6: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) Serilog —Å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ Structured logging - –ª–µ–≥–∫–æ –ø–∞—Ä—Å–∏—Ç—å –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–æ sinks (—Ñ–∞–π–ª, HTTP, console)
- ‚úÖ –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è + —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
- ‚úÖ Production-ready —Ä–µ—à–µ–Ω–∏–µ

***

### **–í–û–ü–†–û–° 7: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π error handler + user-friendly —Å–æ–æ–±—â–µ–Ω–∏—è
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
- ‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ severity
- ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–∞—Å—Å–∏—Ä–æ–≤
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è debugging
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ support

***

## **–ë–õ–û–ö 2: UI/UX –ò –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï –° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ú (9 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **–í–û–ü–†–û–° 8: Workflow –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ (—Ç–µ–ª–µ—Ñ–æ–Ω/–∫–æ–¥/email –≤ –æ–¥–Ω–æ–º –ø–æ–ª–µ)
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ú–∏–Ω–∏–º—É–º –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –∫–∞—Å—Å–∏—Ä–∞
- ‚úÖ –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –≤–≤–æ–¥–∞
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞ (–æ–¥–Ω–æ –ø–æ–ª–µ)
- ‚úÖ –ú–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫ –≤–≤–æ–¥–∞

***

### **–í–û–ü–†–û–° 9: –§–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) –°–≤–æ–±–æ–¥–Ω—ã–π –≤–≤–æ–¥ + –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏ backend
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ù–µ —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–∞—Å–∫–æ–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª—é–±—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
- ‚úÖ –î–≤–æ–π–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è = –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ —Å copy-paste

***

### **–í–û–ü–†–û–° 10: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥–æ—Å—Ç–µ**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ +ExpandedView –ø—Ä–∏ –∫–ª–∏–∫–µ
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º —ç–∫—Ä–∞–Ω –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ —Å—Ä–∞–∑—É (–∏–º—è, –±–∞–ª–∞–Ω—Å, —É—Ä–æ–≤–µ–Ω—å)
- ‚úÖ –î–µ—Ç–∞–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –∫–ª–∏–∫—É
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è —Å–ø–æ—Ä–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π

***

### **–í–û–ü–†–û–° 11: –í—ã–±–æ—Ä —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –æ–±–æ–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ + –≤—ã–±–æ—Ä
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ö–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å—Ä–∞–∑—É
- ‚úÖ –ú–æ–∂–µ—Ç —Å—Ä–∞–≤–Ω–∏—Ç—å –∏ –≤—ã–±—Ä–∞—Ç—å –ª—É—á—à–µ–µ
- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è –≥–æ—Å—Ç—è
- ‚úÖ –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ API (—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)

***

### **–í–û–ü–†–û–° 12: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) Smart input —Å –ø—Ä–µ—Å–µ—Ç–∞–º–∏ + –≤–∞–ª–∏–¥–∞—Ü–∏—è
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ë—ã—Å—Ç—Ä–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å—É–º–º
- ‚úÖ –°–≤–æ–±–æ–¥–Ω—ã–π –≤–≤–æ–¥ –¥–ª—è —Ç–æ—á–Ω–æ–π —Å—É–º–º—ã
- ‚úÖ Instant –≤–∞–ª–∏–¥–∞—Ü–∏—è = –º–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è –≤ –∏—Ç–æ–≥–µ

***

### **–í–û–ü–†–û–° 13: Keyboard shortcuts**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) –ë–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä —à–æ—Ä—Ç–∫–∞—Ç–æ–≤ –¥–ª—è —á–∞—Å—Ç—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –£—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É –æ–ø—ã—Ç–Ω—ã—Ö –∫–∞—Å—Å–∏—Ä–æ–≤
- ‚úÖ –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö
- ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ (Enter, Esc)
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ –ø–æ–¥—Å–∫–∞–∑–∫–∞—Ö

***

### **–í–û–ü–†–û–° 14: Loading —Å–æ—Å—Ç–æ—è–Ω–∏—è**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) Skeleton screens + –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ Skeleton = –æ—â—É—â–µ–Ω–∏–µ –±—ã—Å—Ç—Ä–æ—Ç—ã
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π > 2 —Å–µ–∫—É–Ω–¥
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π UX –ø–æ–¥—Ö–æ–¥

***

### **–í–û–ü–†–û–° 15: –ü–æ–∫–∞–∑ –æ—à–∏–±–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) Inline –æ—à–∏–±–∫–∏ + modal –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ Inline –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É
- ‚úÖ Modal –ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –≤–∞–∂–Ω–æ–º—É
- ‚úÖ –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç = –ø—Ä–æ–±–ª–µ–º–∞
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π

***

### **–í–û–ü–†–û–° 16: –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ UI**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** B) –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –≤ —Å—Ç–∏–ª–µ Max Loyalty
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å —Å –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π
- ‚úÖ –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –≥–ª–∞–∑–∞ –∫–∞—Å—Å–∏—Ä–∞
- ‚úÖ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π look \& feel
- ‚úÖ –õ—É—á—à–µ –≤–∏–¥–Ω–æ –≤ —Ä–∞–∑–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö –æ—Å–≤–µ—â–µ–Ω–∏—è

***

## **–ë–õ–û–ö 3: API –ò BACKEND –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø (8 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **–í–û–ü–†–û–° 17: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ API endpoints**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) REST API —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ endpoint'–∞–º–∏
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –ø–æ–Ω—è—Ç–Ω–æ—Å—Ç—å
- ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç –∏–Ω–¥—É—Å—Ç—Ä–∏–∏
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HTTP –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

***

### **–í–û–ü–†–û–° 18: –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö API**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** B) JSON —Å —á–µ—Ç–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- ‚úÖ –õ–µ–≥–∫–æ –ø–∞—Ä—Å–∏—Ç—Å—è –≤ C\#
- ‚úÖ Human-readable –¥–ª—è debugging
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö

***

### **–í–û–ü–†–û–° 19: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è API**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) API Key –≤ header + per-restaurant –∫–ª—é—á–∏
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ HTTPS
- ‚úÖ –õ–µ–≥–∫–æ —Ä–æ—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏
- ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞

***

### **–í–û–ü–†–û–° 20: Endpoint –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) POST /api/search-guest —Å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º –ø–æ–∏—Å–∫–æ–º
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ POST = –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –±–æ–ª—å—à–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚úÖ –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ URL
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–∏—Å–∫–∞
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (—Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ –≤ URL)

***

### **–í–û–ü–†–û–° 21: Endpoint —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) POST /api/calculate —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
- ‚úÖ –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ç—å
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- ‚úÖ –ú–æ–∂–µ–º —É—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–æ–º–æ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

***

### **–í–û–ü–†–û–° 22: –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –±–∞–ª–ª–æ–≤ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è —Å TTL + –∞–≤—Ç–æ–æ—Ç–º–µ–Ω–∞
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç double-spending
- ‚úÖ TTL –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –±–∞–ª–ª—ã –µ—Å–ª–∏ —á–µ–∫ –Ω–µ –∑–∞–∫—Ä—ã—Ç
- ‚úÖ –ê–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ –ø—Ä–∏ –∫—Ä–∞—à–µ –ø–ª–∞–≥–∏–Ω–∞
- ‚úÖ Race conditions —Ä–µ—à–µ–Ω—ã –Ω–∞ backend

***

### **–í–û–ü–†–û–° 23: Endpoint —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) POST /api/finalize —Å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å = –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ retry
- ‚úÖ –û–¥–∏–Ω endpoint –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è reservationId –Ω–∞ backend
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –≤—Å–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏

***

### **–í–û–ü–†–û–° 24: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ offline —Å–æ—Å—Ç–æ—è–Ω–∏—è**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) Exponential backoff health checks + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ë—ã—Å—Ç—Ä–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (5-10 —Å–µ–∫)
- ‚úÖ –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ offline
- ‚úÖ –ö–∞—Å—Å–∏—Ä –∑–Ω–∞–µ—Ç –æ –ø—Ä–æ–±–ª–µ–º–µ —Å—Ä–∞–∑—É
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

***

## **–ë–õ–û–ö 4: OFFLINE –†–ï–ñ–ò–ú –ò –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø (6 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **–í–û–ü–†–û–° 25: Offline queue - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) JSON —Ñ–∞–π–ª + backup + —Ä–æ—Ç–∞—Ü–∏—è
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ (JSON –ª–µ–≥–∫–æ —á–∏—Ç–∞—Ç—å)
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å (backup –∑–∞—â–∏—â–∞–µ—Ç)
- ‚úÖ –õ–µ–≥–∫–æ–≤–µ—Å–Ω–æ—Å—Ç—å (–Ω–µ –Ω—É–∂–Ω–∞ SQLite)
- ‚úÖ –ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç—å (–ª–µ–≥–∫–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è support)

***

### **–í–û–ü–†–û–° 26: –ö–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç offline**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** A) –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ (EARN_ONLY)
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–Ω–µ—Ç risk —Å–ø–∏—Å–∞–Ω–∏—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞)
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ü–æ–∫—Ä—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π use case

***

### **–í–û–ü–†–û–° 27: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞—Å—Å–∏—Ä—É
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (–∫–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π)
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å (–º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- ‚úÖ –ê—É–¥–∏—Ç (–≤–∏–¥–Ω–æ –∫–æ–≥–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–æ—Å—å)

***

### **–í–û–ü–†–û–° 28: –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) Backend —Ä–µ—à–∞–µ—Ç + fallback
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –Ω–∞ backend
- ‚úÖ Backend –∑–Ω–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

***

### **–í–û–ü–†–û–° 29: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ offline queue**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** B) 24 —á–∞—Å–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å (–æ–ø–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ —Å—É—Ç–æ–∫ –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã)
- ‚úÖ –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (–±–∞–ª–ª—ã –¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏—Å–ª—è—Ç—å—Å—è –≤ —Ä–∞–∑—É–º–Ω—ã–π —Å—Ä–æ–∫)
- ‚úÖ Disk space –Ω–µ —Ä–∞—Å—Ç–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
- ‚úÖ –ö–æ–º–ø—Ä–æ–º–∏—Å—Å (–¥–∞–∂–µ –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º offline —É—Å–ø–µ—é—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å)

***

### **–í–û–ü–†–û–° 30: –¢–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å iiko**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** B) –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–ª–∞–≥–∏–Ω–∞ + —Å–æ–±—ã—Ç–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è —á–µ–∫–∞
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ú–∏–Ω–∏–º—É–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ (–ø—Ä–∏–≤—è–∑–∫–∞ + —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è)
- ‚úÖ –ù–µ –º–µ—à–∞–µ—Ç —Ä–∞–±–æ—Ç–µ iiko
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å (–º–µ–Ω—å—à–µ —Ç–æ—á–µ–∫ = –º–µ–Ω—å—à–µ –±–∞–≥–æ–≤)
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–Ω–µ –Ω–∞–≥—Ä—É–∂–∞–µ–º —Å–∏—Å—Ç–µ–º—É)

***

## **–ë–õ–û–ö 5: –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° iiko FRONT (8 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **–í–û–ü–†–û–° 31: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ –≤ iiko**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –†–∞–Ω–µ–µ –æ–±—Å—É–∂–¥–∞–ª–æ—Å—å –≤ –±–µ—Å–µ–¥–µ

***

### **–í–û–ü–†–û–° 32: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** B) –°—É–º–º–∞ + —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º API)
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å (–º–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π)
- ‚úÖ –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞ –Ω—É–∂–µ–Ω –¥–ª—è –ø—Ä–∞–≤–∏–ª –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è

***

### **–í–û–ü–†–û–° 33: –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–∞–∫–∞–∑–∞**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** B) –í –ø–∞–º—è—Ç–∏ + backup –Ω–∞ –¥–∏—Å–∫
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ë—ã—Å—Ç—Ä–æ (–¥–æ—Å—Ç—É–ø –∏–∑ –ø–∞–º—è—Ç–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π)
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ (backup –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –∫—Ä–∞—à–∞)
- ‚úÖ –ü—Ä–æ—Å—Ç–æ (–Ω–µ –Ω—É–∂–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)
- ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è (–Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç iiko)

***

### **–í–û–ü–†–û–° 34: –ö–Ω–æ–ø–∫–∞ –≤ UI iiko**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –†–∞–Ω–µ–µ –æ–±—Å—É–∂–¥–∞–ª–æ—Å—å –≤ –±–µ—Å–µ–¥–µ

***

### **–í–û–ü–†–û–° 35: –í–µ—Ä—Å–∏–∏ –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å iiko**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ + –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å (–æ–¥–∏–Ω –ø–ª–∞–≥–∏–Ω –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏—è—Ö)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–±–ª–æ–∫–∏—Ä—É–µ–º —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏)
- ‚úÖ –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (–Ω–µ –Ω—É–∂–Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –±–∏–ª–¥–æ–≤)

***

### **–í–û–ü–†–û–° 36: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫—Ä–∞—à–∞ iiko**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) Backup + –∞–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (–Ω–µ —Ç–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ)
- ‚úÖ –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ (–æ—Ç–º–µ–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏)
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (backend –∑–Ω–∞–µ—Ç –æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö)
- ‚úÖ –ê—É–¥–∏—Ç (–ª–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã)

***

### **–í–û–ü–†–û–° 37: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –≤ iiko**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Å–µ –∫–∞–Ω–∞–ª—ã
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü–æ–ª–Ω–æ—Ç–∞ (–ª–æ–≥–∏ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö)
- ‚úÖ Debugging (–ª–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É)
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (backend –≤–∏–¥–∏—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç)
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ (JSON –ª–æ–≥–∏ –ª–µ–≥–∫–æ –ø–∞—Ä—Å–∏—Ç—å)

***

### **–í–û–ü–†–û–° 38: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è + –≥–æ—Å—Ç–∏
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –°–∫–æ—Ä–æ—Å—Ç—å (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π)
- ‚úÖ UX (–Ω–µ –∂–¥–µ–º backend –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∫–ª–∏–∫–µ)
- ‚úÖ Offline (–∫–µ—à —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)
- ‚úÖ Calculate –Ω–µ –∫–µ—à–∏—Ä—É–µ–º (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—É–º–º—ã —á–µ–∫–∞)

***

## **–ë–õ–û–ö 6: –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨ –ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø (5 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **–í–û–ü–†–û–° 39: –¢–∞–π–º–∞—É—Ç—ã –∏ retry —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã + exponential backoff
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å (—Å–ø—Ä–∞–≤–ª—è–µ–º—Å—è —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Å–±–æ—è–º–∏)
- ‚úÖ –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º (exponential backoff)
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å (—Ä–∞–∑–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
- ‚úÖ UX (–∫–∞—Å—Å–∏—Ä –Ω–µ –∂–¥–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ)

***

### **–í–û–ü–†–û–° 40: –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) –ö–µ—à + –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ë–∞–ª–∞–Ω—Å (–∫–µ—à —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ —Ä–∞—Å—Ç–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ)
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ)
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ (–Ω–µ –Ω—É–∂–µ–Ω —Å–ª–æ–∂–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É iiko)

***

### **–í–û–ü–†–û–° 41: –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) Async/await + concurrent –∫–æ–ª–ª–µ–∫—Ü–∏–∏ + SemaphoreSlim
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (concurrent –∫–æ–ª–ª–µ–∫—Ü–∏–∏ thread-safe)
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º UI thread)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å (SemaphoreSlim –¥–ª—è async –æ–ø–µ—Ä–∞—Ü–∏–π)
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)

***

### **–í–û–ü–†–û–° 42: –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –º–µ—Ç—Ä–∏–∫ + –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ backend
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (–≤–∏–¥–∏–º —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –∫–∞—Å—Å–∞—Ö)
- ‚úÖ –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–Ω–∞—Ö–æ–¥–∏–º –ø—Ä–æ–±–ª–µ–º—ã –¥–æ –∂–∞–ª–æ–±)
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è)
- ‚úÖ SLA (–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º quality of service)

***

## **–ë–õ–û–ö 7: –î–ï–ü–õ–û–ô, –£–°–¢–ê–ù–û–í–ö–ê –ò –ü–û–î–î–ï–†–ñ–ö–ê (8 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **–í–û–ü–†–û–° 43: –ü—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–≥–∏–Ω–∞**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –†–∞–Ω–µ–µ –æ–±—Å—É–∂–¥–∞–ª–æ—Å—å –≤ –±–µ—Å–µ–¥–µ

***

### **–í–û–ü–†–û–° 44: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** B) PDF —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –Ω–∞ 20+ —Å—Ç—Ä–∞–Ω–∏—Ü
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

***

### **–í–û–ü–†–û–° 45: –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ + —ç–∫—Å–ø–æ—Ä—Ç
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –°–∞–º–æ–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç —Å–∞–º –Ω–∞–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ (—ç–∫—Å–ø–æ—Ä—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—ë –¥–ª—è debugging)
- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (–≤–∏–¥–Ω–æ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏)
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —á–∏–Ω–∏—Ç—å –Ω–∞ –º–µ—Å—Ç–µ)

***

### **–í–û–ü–†–û–° 46: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–º. –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –†–∞–Ω–µ–µ –æ–±—Å—É–∂–¥–∞–ª–æ—Å—å –≤ –±–µ—Å–µ–¥–µ

***

### **–í–û–ü–†–û–° 47: –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ (rollback)**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** B) Backup + manual rollback
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (backup —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å (–∞–¥–º–∏–Ω —Ä–µ—à–∞–µ—Ç –∫–æ–≥–¥–∞ –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å)
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ (–Ω–µ –Ω—É–∂–Ω–∞ —Å–ª–æ–∂–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è (—Ö—Ä–∞–Ω–∏–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–π)

***

### **–í–û–ü–†–û–° 48: –£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) Uninstaller —Å –ø–æ–ª–Ω—ã–º cleanup
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –ß–∏—Å—Ç–æ—Ç–∞ (—É–¥–∞–ª—è–µ–º –≤—Å–µ —Å–ª–µ–¥—ã –ø–ª–∞–≥–∏–Ω–∞)
- ‚úÖ –í—ã–±–æ—Ä (–∞–¥–º–∏–Ω —Ä–µ—à–∞–µ—Ç —á—Ç–æ —É–¥–∞–ª—è—Ç—å)
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–æ—Ç–º–µ–Ω—è–µ–º –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏)
- ‚úÖ Feedback (–º–æ–∂–µ–º —Å–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É —É–¥–∞–ª–µ–Ω–∏—è)

***

### **–í–û–ü–†–û–° 49: –ü—Ä–æ—Ü–µ—Å—Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** D) –ú–Ω–æ–≥–æ–∫–∞–Ω–∞–ª—å–Ω–∞—è + –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (—Ä–∞–∑–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π)
- ‚úÖ –°–∫–æ—Ä–æ—Å—Ç—å (–ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ –Ω–∞—Ö–æ–¥–∏–º –ø—Ä–æ–±–ª–µ–º—ã)
- ‚úÖ –°–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (–±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É)
- ‚úÖ –≠—Å–∫–∞–ª–∞—Ü–∏—è (—Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤)

***

### **–í–û–ü–†–û–° 50: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã**

**–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** C) Dashboard + Telegram –∞–ª–µ—Ä—Ç—ã
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (dashboard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É)
- ‚úÖ –†–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö)
- ‚úÖ –ë–∞–ª–∞–Ω—Å (–Ω–µ overcomplicated, –Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
- ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (Telegram –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–≥–¥–∞)

***

# üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –†–ï–®–ï–ù–ò–ô

**–ü–æ —Ç–∏–ø–∞–º —Ä–µ—à–µ–Ω–∏–π:**

- üéØ **–ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ:** 46 –≤–æ–ø—Ä–æ—Å–æ–≤
- üìù **–û—Ç—Å—ã–ª–∫–∞ –∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–º –æ–±—Å—É–∂–¥–µ–Ω–∏—è–º:** 4 –≤–æ–ø—Ä–æ—Å–∞ (31, 34, 43, 46)

**–ü–æ —É—Ä–æ–≤–Ω—é —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ—à–µ–Ω–∏–π:**

- üî¥ **–°–ª–æ–∂–Ω—ã–µ (—Ç—Ä–µ–±—É—é—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π):** 15 –≤–æ–ø—Ä–æ—Å–æ–≤
- üü° **–°—Ä–µ–¥–Ω–∏–µ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ best practices):** 25 –≤–æ–ø—Ä–æ—Å–æ–≤
- üü¢ **–ü—Ä–æ—Å—Ç—ã–µ (–æ—á–µ–≤–∏–¥–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è):** 10 –≤–æ–ø—Ä–æ—Å–æ–≤

**–ü–æ –≤–ª–∏—è–Ω–∏—é –Ω–∞ –ø—Ä–æ–µ–∫—Ç:**

- üéØ **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ:** 12 –≤–æ–ø—Ä–æ—Å–æ–≤ (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, offline —Ä–µ–∂–∏–º, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)
- ‚ö° **–í–∞–∂–Ω—ã–µ:** 28 –≤–æ–ø—Ä–æ—Å–æ–≤ (UX, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
- üì¶ **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ:** 10 –≤–æ–ø—Ä–æ—Å–æ–≤ (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, –ø–æ–¥–¥–µ—Ä–∂–∫–∞, —É–ª—É—á—à–µ–Ω–∏—è)

***

**–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ! –í—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏–Ω—è—Ç—ã –∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω—ã.** üöÄ

---

# üé¨ –ü–û–õ–ù–´–ô –ñ–ò–ó–ù–ï–ù–ù–´–ô –¶–ò–ö–õ –ü–õ–ê–ì–ò–ù–ê MAX LOYALTY –î–õ–Ø iiko

## **–ì–õ–ê–í–ê 1: –£–°–¢–ê–ù–û–í–ö–ê –ò –ü–ï–†–í–´–ô –ó–ê–ü–£–°–ö**

### **1.1. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç –ø–ª–∞–≥–∏–Ω**

**–®–∞–≥ 1: –í Admin Panel Max Loyalty**

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –∑–∞—Ö–æ–¥–∏—Ç –≤ https://admin.maxloyalty.ru

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Max Loyalty - Admin Panel                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                     ‚îÇ
‚îÇ  üìä –ì–ª–∞–≤–Ω–∞—è                                        ‚îÇ
‚îÇ  üë• –ì–æ—Å—Ç–∏                                          ‚îÇ
‚îÇ  üè™ –†–µ—Å—Ç–æ—Ä–∞–Ω—ã                                      ‚îÇ
‚îÇ  üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏  ‚Üê (—Ç–µ–∫—É—â–∞—è –≤–∫–ª–∞–¥–∫–∞)               ‚îÇ
‚îÇ  üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞                                      ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å iiko Front                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –°—Ç–∞—Ç—É—Å: ‚ö†Ô∏è –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  1. –°–∫–∞—á–∞–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–æ—á–Ω—ã–π —Ñ–∞–π–ª              ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ —Å iiko          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –º–∞—Å—Ç–µ—Ä–∞            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  [üì• –°–∫–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫]                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –í–µ—Ä—Å–∏—è: 1.2.5 (–æ—Ç 15.02.2026)             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è iiko: 7.5               ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–°–∫–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫":**

```typescript
// Backend –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π installer –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
async downloadInstaller(restaurantId: string) {
  // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π API Key –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
  const apiKey = await this.generateApiKey(restaurantId);
  
  // 2. –ë–µ—Ä–µ–º –±–∞–∑–æ–≤—ã–π installer.exe
  const baseInstaller = './installers/MaxLoyaltyInstaller_Base.exe';
  
  // 3. –í–Ω–µ–¥—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ installer
  const config = {
    apiKey: apiKey,
    restaurantId: restaurantId,
    apiUrl: process.env.API_URL,
    version: '1.2.5'
  };
  
  // 4. –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π installer
  const customInstaller = await this.embedConfig(baseInstaller, config);
  
  // 5. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–∞–π–ª
  return {
    filename: `MaxLoyaltyInstaller_Rest${restaurantId}.exe`,
    buffer: customInstaller
  };
}
```

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–∞–π–ª: `MaxLoyaltyInstaller_Rest001.exe` (11.2 MB)

***

### **1.2. –ó–∞–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏**

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∫–æ–ø–∏—Ä—É–µ—Ç —Ñ–∞–π–ª –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä —Å iiko –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç.

**–≠–∫—Ä–∞–Ω 1: Windows SmartScreen**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Windows –∑–∞—â–∏—Ç–∏–ª –≤–∞—à –∫–æ–º–ø—å—é—Ç–µ—Ä                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                     ‚îÇ
‚îÇ  Windows SmartScreen –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏–ª –∑–∞–ø—É—Å–∫            ‚îÇ
‚îÇ  –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç             ‚îÇ
‚îÇ  –ø–æ–¥–≤–µ—Ä–≥–Ω—É—Ç—å –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤–∞—à –∫–æ–º–ø—å—é—Ç–µ—Ä.               ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: MaxLoyaltyInstaller_Rest001.exe        ‚îÇ
‚îÇ  –ò–∑–¥–∞—Ç–µ–ª—å: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π                              ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  [–ù–µ –∑–∞–ø—É—Å–∫–∞—Ç—å]    [–ü–æ–¥—Ä–æ–±–Ω–µ–µ]                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç **"–ü–æ–¥—Ä–æ–±–Ω–µ–µ"** ‚Üí **"–í—ã–ø–æ–ª–Ω–∏—Ç—å –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ"**

***

**–≠–∫—Ä–∞–Ω 2: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Max Loyalty                                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è iiko Front              ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!                                   ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –≠—Ç–æ—Ç –º–∞—Å—Ç–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –ø–ª–∞–≥–∏–Ω Max Loyalty –Ω–∞        ‚îÇ
‚îÇ  –≤–∞—à—É –∫–∞—Å—Å—É —Å iiko Front.                           ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ß—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ:                                  ‚îÇ
‚îÇ  ‚úì –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ iiko Front            ‚îÇ
‚îÇ  ‚úì –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–ª–∞–≥–∏–Ω–∞                       ‚îÇ
‚îÇ  ‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤ iiko               ‚îÇ
‚îÇ  ‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É Max Loyalty       ‚îÇ
‚îÇ  ‚úì –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –ø–ª–∞–≥–∏–Ω–∞                          ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  ‚ö†Ô∏è –í–∞–∂–Ω–æ:                                     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –ü–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∑–∞–∫—Ä–æ–π—Ç–µ iiko Front –Ω–∞ —ç—Ç–æ–º  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.                                   ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                          [–û—Ç–º–µ–Ω–∞]    [–î–∞–ª–µ–µ >]      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–∫—Ä—ã–≤–∞–µ—Ç iiko –∏ –Ω–∞–∂–∏–º–∞–µ—Ç **"–î–∞–ª–µ–µ"**

***

**–≠–∫—Ä–∞–Ω 3: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ iiko**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ iiko Front                              ‚îÇ
‚îÇ  –ü–æ–∏—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ iiko Front               ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚è≥ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏...     ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë] 80%                     ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ü—Ä–æ–≤–µ—Ä–∫–∞: C:\Program Files\iiko\                   ‚îÇ
‚îÇ                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ iiko Front                              ‚îÇ
‚îÇ  –ü–æ–∏—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ iiko Front               ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ü—É—Ç—å –∫ iiko Front:                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ C:\Program Files\iiko\                         ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                        [–û–±–∑–æ—Ä...]    ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  ‚úì –ù–∞–π–¥–µ–Ω–∞ –≤–µ—Ä—Å–∏—è iiko Front: 7.8.2           ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –ü–ª–∞–≥–∏–Ω —Å–æ–≤–º–µ—Å—Ç–∏–º —Å —ç—Ç–æ–π –≤–µ—Ä—Å–∏–µ–π               ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                          [< –ù–∞–∑–∞–¥]    [–î–∞–ª–µ–µ >]     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç **"–î–∞–ª–µ–µ"**

***

**–≠–∫—Ä–∞–Ω 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ iiko                            ‚îÇ
‚îÇ  –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø–ª–∞–≥–∏–Ω–∞       ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –î–ª—è —Ä–∞–±–æ—Ç—ã –ø–ª–∞–≥–∏–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å –¥–≤–∞           ‚îÇ
‚îÇ  —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞ –≤ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–µ iiko:               ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  1. –û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ Max Loyalty                 ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –¶–µ–Ω–∞: 0 ‚ÇΩ                                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ü–µ–Ω—ã: —Ä–∞–∑—Ä–µ—à–µ–Ω                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –°–ª—É–∂–µ–±–Ω—ã–µ                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ù–î–°: –ë–µ–∑ –ù–î–°                                ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  2. –°–∫–∏–¥–∫–∞ —É—Ä–æ–≤–Ω—è Max Loyalty                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –¶–µ–Ω–∞: 0 ‚ÇΩ                                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ü–µ–Ω—ã: —Ä–∞–∑—Ä–µ—à–µ–Ω                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –°–ª—É–∂–µ–±–Ω—ã–µ                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ù–î–°: –ë–µ–∑ –ù–î–°                                ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚ñ° –¢–æ–≤–∞—Ä—ã —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã –≤ iiko                        ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  üí° –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —É–∫–∞–∂–∏—Ç–µ ID —Ç–æ–≤–∞—Ä–æ–≤ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö  ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                          [< –ù–∞–∑–∞–¥]    [–î–∞–ª–µ–µ >]     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —á–∏—Ç–∞–µ—Ç, –Ω–∞–∂–∏–º–∞–µ—Ç **"–î–∞–ª–µ–µ"**

***

**–≠–∫—Ä–∞–Ω 5: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤                                  ‚îÇ
‚îÇ  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–ª–∞–≥–∏–Ω–∞                            ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –ø–ª–∞–≥–∏–Ω–æ–≤...                          ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] 100%                    ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!                                ‚îÇ
‚îÇ                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏:**

```csharp
public async Task<ExecutionResult> ExecuteAsync(InstallerConfig config)
{
    // 1. –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É Plugins
    UpdateStatus("–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –ø–ª–∞–≥–∏–Ω–æ–≤...", 10);
    var pluginsPath = Path.Combine(config.IikoPath, "Plugins");
    Directory.CreateDirectory(pluginsPath);
    
    // 2. –ö–æ–ø–∏—Ä—É–µ–º DLL –ø–ª–∞–≥–∏–Ω–∞
    UpdateStatus("–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ MaxLoyaltyIikoPlugin.dll...", 30);
    File.Copy(
        "MaxLoyaltyIikoPlugin.dll",
        Path.Combine(pluginsPath, "MaxLoyaltyIikoPlugin.dll"),
        overwrite: true
    );
    
    // 3. –ö–æ–ø–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    UpdateStatus("–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...", 50);
    var dependencies = new[] { 
        "Newtonsoft.Json.dll", 
        "Serilog.dll", 
        "Serilog.Sinks.File.dll" 
    };
    foreach (var dep in dependencies)
    {
        File.Copy(dep, Path.Combine(pluginsPath, dep), overwrite: true);
    }
    
    // 4. –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    UpdateStatus("–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...", 70);
    var appDataPath = Path.Combine(
        Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
        "MaxLoyaltyIiko"
    );
    Directory.CreateDirectory(appDataPath);
    
    var pluginConfig = new PluginConfig
    {
        ApiKey = config.ApiKey, // –£–∂–µ –≤—Å—Ç—Ä–æ–µ–Ω –≤ installer
        ApiUrl = "https://api.maxloyalty.ru",
        RestaurantId = config.RestaurantId,
        Version = "1.2.5",
        InstalledAt = DateTime.UtcNow
    };
    
    // –®–∏—Ñ—Ä—É–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    var json = JsonConvert.SerializeObject(pluginConfig);
    var encrypted = EncryptionService.Encrypt(json, GetMachineId());
    File.WriteAllText(
        Path.Combine(appDataPath, "config.json.encrypted"),
        encrypted
    );
    
    UpdateStatus("–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!", 100);
    return ExecutionResult.Success();
}
```


***

**–≠–∫—Ä–∞–Ω 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è                                ‚îÇ
‚îÇ  –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º Max Loyalty           ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É...       ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ           üîÑ                                         ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è                                ‚îÇ
‚îÇ  –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º Max Loyalty           ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!                             ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –°–µ—Ä–≤–µ—Ä Max Loyalty –¥–æ—Å—Ç—É–ø–µ–Ω.                        ‚îÇ
‚îÇ  –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 45 –º—Å                                 ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –í–∞—à —Ä–µ—Å—Ç–æ—Ä–∞–Ω: "Cafe Moscow" (ID: 001)              ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                          [< –ù–∞–∑–∞–¥]    [–î–∞–ª–µ–µ >]     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

```csharp
public async Task<ExecutionResult> ExecuteAsync(InstallerConfig config)
{
    try
    {
        using var httpClient = new HttpClient();
        httpClient.DefaultRequestHeaders.Add("X-API-Key", config.ApiKey);
        httpClient.Timeout = TimeSpan.FromSeconds(10);
        
        var stopwatch = Stopwatch.StartNew();
        var response = await httpClient.GetAsync(
            $"{config.ApiUrl}/api/health"
        );
        stopwatch.Stop();
        
        if (response.IsSuccessStatusCode)
        {
            var json = await response.Content.ReadAsStringAsync();
            var health = JsonConvert.DeserializeObject<HealthResponse>(json);
            
            resultText.Text = 
                $"‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!\n\n" +
                $"–°–µ—Ä–≤–µ—Ä Max Loyalty –¥–æ—Å—Ç—É–ø–µ–Ω.\n" +
                $"–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: {stopwatch.ElapsedMilliseconds} –º—Å\n\n" +
                $"–í–∞—à —Ä–µ—Å—Ç–æ—Ä–∞–Ω: \"{health.RestaurantName}\" (ID: {health.RestaurantId})";
            
            return ExecutionResult.Success();
        }
    }
    catch (Exception ex)
    {
        resultText.Text = 
            $"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:\n\n{ex.Message}\n\n" +
            "–ü–ª–∞–≥–∏–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.";
        
        return ExecutionResult.Success(); // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
    }
}
```


***

**–≠–∫—Ä–∞–Ω 7: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞                                 ‚îÇ
‚îÇ  –ü–ª–∞–≥–∏–Ω Max Loyalty —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω               ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ           ‚úÖ                                         ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!                        ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:                                     ‚îÇ
‚îÇ  1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front                             ‚îÇ
‚îÇ  2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–æ—è–≤–∏–ª–∞—Å—å –∫–Ω–æ–ø–∫–∞ "Max Loyalty"     ‚îÇ
‚îÇ  3. –°–æ–∑–¥–∞–π—Ç–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–µ iiko    ‚îÇ
‚îÇ  4. –ù–∞–∂–º–∏—Ç–µ Ctrl+Shift+D –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫                ‚îÇ
‚îÇ  5. –£–∫–∞–∂–∏—Ç–µ ID —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤                     ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:                                    ‚îÇ
‚îÇ  https://docs.maxloyalty.ru/iiko-plugin              ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                                       [–ó–∞–≤–µ—Ä—à–∏—Ç—å]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç **"–ó–∞–≤–µ—Ä—à–∏—Ç—å"**

Installer –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ backend:

```typescript
// Backend –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
POST /api/plugin/installation-completed
{
  "restaurantId": "001",
  "version": "1.2.5",
  "installedAt": "2026-02-17T12:30:00Z",
  "iikoVersion": "7.8.2",
  "os": "Windows 10 Pro 64-bit"
}

// Backend –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å
await prisma.restaurant.update({
  where: { id: "001" },
  data: {
    pluginInstalled: true,
    pluginVersion: "1.2.5",
    pluginInstalledAt: new Date()
  }
});

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
await telegram.sendMessage({
  chatId: MONITORING_CHAT_ID,
  text: "‚úÖ –ù–æ–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞\n\n–†–µ—Å—Ç–æ—Ä–∞–Ω: Cafe Moscow\n–í–µ—Ä—Å–∏—è: 1.2.5"
});
```


***

### **1.3. –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤ iiko**

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç **iiko Office** ‚Üí **–ú–µ–Ω—é –∏ —Å–∫–ª–∞–¥** ‚Üí **–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  iiko Office - –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [+ –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä]                                   ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:                                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ –û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ Max Loyalty                     ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ê—Ä—Ç–∏–∫—É–ª:                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ MAX_LOYALTY_POINTS                             ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –¶–µ–Ω–∞:                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ 0                                              ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚òë –†–∞–∑—Ä–µ—à–∏—Ç—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ü–µ–Ω—ã                       ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ö–∞—Ç–µ–≥–æ—Ä–∏—è:                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ [‚ñº] –°–ª—É–∂–µ–±–Ω—ã–µ                                  ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ù–î–°:                                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ [‚ñº] –ë–µ–∑ –ù–î–°                                    ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                          [–û—Ç–º–µ–Ω–∞]    [–°–æ—Ö—Ä–∞–Ω–∏—Ç—å]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–≤–∞—Ä –∏ –≤–∏–¥–∏—Ç:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ                                ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ID —Ç–æ–≤–∞—Ä–∞: 8f7a3b21-4d5e-4c9a-8a1b-2e3f4g5h6i7j    ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                                       [OK]           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∫–æ–ø–∏—Ä—É–µ—Ç ID: `8f7a3b21-4d5e-4c9a-8a1b-2e3f4g5h6i7j`

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å–æ–∑–¥–∞–µ—Ç –≤—Ç–æ—Ä–æ–π —Ç–æ–≤–∞—Ä "–°–∫–∏–¥–∫–∞ —É—Ä–æ–≤–Ω—è Max Loyalty"
ID: `9g8b4c32-5e6f-5d0b-9b2c-3f4g5h6i7j8k`

***

### **1.4. –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ iiko —Å –ø–ª–∞–≥–∏–Ω–æ–º**

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç **iiko Front**

**–í –∫–æ–Ω—Å–æ–ª–∏ iiko (–ª–æ–≥–∏):**

```
2026-02-17 12:35:01.234 [INFO] iiko Front starting...
2026-02-17 12:35:02.456 [INFO] Loading plugins...
2026-02-17 12:35:02.789 [INFO] Found plugin: MaxLoyaltyIikoPlugin.dll
2026-02-17 12:35:03.012 [INFO] Loading MaxLoyaltyIikoPlugin...
2026-02-17 12:35:03.234 [INFO] MaxLoyaltyIikoPlugin loaded successfully
2026-02-17 12:35:03.456 [INFO] Initializing MaxLoyaltyIikoPlugin...
```

**–í –ø–ª–∞–≥–∏–Ω–µ:**

```csharp
public void Dispose(IPluginResources resources)
{
    logger.LogInformation("Max Loyalty plugin initializing...");
    
    try
    {
        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        logger.LogDebug("Loading configuration...");
        var config = configService.LoadConfig();
        logger.LogInformation(
            "Configuration loaded: Restaurant {RestaurantId}, Version {Version}",
            config.RestaurantId,
            config.Version
        );
        
        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –≤–µ—Ä—Å–∏–∏ iiko
        logger.LogDebug("Checking iiko version compatibility...");
        var iikoVersion = versionManager.GetVersion();
        logger.LogInformation("iiko Front version: {Version}", iikoVersion);
        
        if (iikoVersion < new Version(7, 5, 0))
        {
            throw new InvalidOperationException(
                $"iiko Front version {iikoVersion} is not supported. Minimum: 7.5.0"
            );
        }
        
        // 3. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤ UI
        logger.LogDebug("Registering plugin button...");
        RegisterButton(resources);
        
        // 4. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è iiko
        logger.LogDebug("Subscribing to iiko events...");
        SubscribeToEvents(resources);
        
        // 5. –ó–∞–ø—É—Å–∫–∞–µ–º health check
        logger.LogDebug("Starting health check service...");
        healthCheck.Start();
        
        // 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ backend
        logger.LogDebug("Testing backend connection...");
        var isOnline = await healthCheck.CheckHealthAsync();
        
        if (isOnline)
        {
            logger.LogInformation("Backend connection successful");
        }
        else
        {
            logger.LogWarning("Backend is offline, plugin will work in limited mode");
        }
        
        // 7. –í—ã–ø–æ–ª–Ω—è–µ–º crash recovery –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        logger.LogDebug("Checking for crash recovery...");
        await recoveryService.PerformRecoveryAsync();
        
        // 8. –ì–æ—Ç–æ–≤–æ!
        logger.LogInformation(
            "Max Loyalty plugin initialized successfully (v{Version})",
            config.Version
        );
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫—É –Ω–∞ backend
        await metricsService.RecordMetric("plugin.started", 1);
    }
    catch (Exception ex)
    {
        logger.LogCritical(ex, "Failed to initialize Max Loyalty plugin");
        throw;
    }
}
```

**–í UI iiko –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  iiko Front - –ö–∞—Å—Å–∞                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [–ù–æ–≤—ã–π –∑–∞–∫–∞–∑] [–û–ø–ª–∞—Ç–∞] [Max Loyalty] [–ù–∞—Å—Ç—Ä–æ–π–∫–∏]   ‚îÇ ‚Üê –Ω–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞!
‚îÇ                                                      ‚îÇ
‚îÇ  –ó–∞–∫–∞–∑ #1234                                         ‚îÇ
‚îÇ  ‚îú‚îÄ –ë—É—Ä–≥–µ—Ä –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π ................ 350 ‚ÇΩ      ‚îÇ
‚îÇ  ‚îú‚îÄ –ö–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏ ..................... 120 ‚ÇΩ      ‚îÇ
‚îÇ  ‚îî‚îÄ Coca-Cola 0.5–ª ..................... 80 ‚ÇΩ      ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ò—Ç–æ–≥–æ: 550 ‚ÇΩ                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

### **1.5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ID —Ç–æ–≤–∞—Ä–æ–≤**

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç **Ctrl + Shift + D**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Max Loyalty - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è] [–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ] [Offline –æ—á–µ—Ä–µ–¥—å]  ‚îÇ
‚îÇ  [–õ–æ–≥–∏] [–ú–µ—Ç—Ä–∏–∫–∏] [–ù–∞—Å—Ç—Ä–æ–π–∫–∏] [–¢–µ—Å—Ç—ã]               ‚îÇ
‚îÇ                                  ^^^^^^^             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  –°–ª—É–∂–µ–±–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã iiko                         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –¢–æ–≤–∞—Ä –¥–ª—è –±–∞–ª–ª–æ–≤:                             ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ 8f7a3b21-4d5e-4c9a-8a1b-2e3f4g5h6i7j    ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –¢–æ–≤–∞—Ä –¥–ª—è —Å–∫–∏–¥–∫–∏:                             ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ 9g8b4c32-5e6f-5d0b-9b2c-3f4g5h6i7j8k    ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  [–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏]                         ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                                       [–ó–∞–∫—Ä—ã—Ç—å]      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤—Å—Ç–∞–≤–ª—è–µ—Ç ID —Ç–æ–≤–∞—Ä–æ–≤ –∏ –Ω–∞–∂–∏–º–∞–µ—Ç **"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"**

```csharp
private void SaveSettings(string pointsProductId, string discountProductId)
{
    try
    {
        // –í–∞–ª–∏–¥–∏—Ä—É–µ–º GUID
        if (!Guid.TryParse(pointsProductId, out _) ||
            !Guid.TryParse(discountProductId, out _))
        {
            MessageBox.Show(
                "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID —Ç–æ–≤–∞—Ä–∞",
                "–û—à–∏–±–∫–∞",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
            return;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        configService.SetPointsProductId(pointsProductId);
        configService.SetDiscountProductId(discountProductId);
        configService.SaveConfig();
        
        logger.LogInformation(
            "Product IDs updated: Points={PointsId}, Discount={DiscountId}",
            pointsProductId,
            discountProductId
        );
        
        MessageBox.Show(
            "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!\n\n–ü–ª–∞–≥–∏–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.",
            "–£—Å–ø–µ—Ö",
            MessageBoxButton.OK,
            MessageBoxImage.Information
        );
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Failed to save settings");
        MessageBox.Show(
            $"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:\n\n{ex.Message}",
            "–û—à–∏–±–∫–∞",
            MessageBoxButton.OK,
            MessageBoxImage.Error
        );
    }
}
```

**‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–ª–∞–≥–∏–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.**

***

## **–ì–õ–ê–í–ê 2: –†–ê–ë–û–¢–ê –ö–ê–°–°–ò–†–ê - –¢–ò–ü–ò–ß–ù–ê–Ø –°–ú–ï–ù–ê**

### **2.1. –ù–∞—á–∞–ª–æ —Å–º–µ–Ω—ã**

**08:00 - –ö–∞—Å—Å–∏—Ä –ê–Ω–Ω–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–º–µ–Ω—É**

–ê–Ω–Ω–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç iiko Front, –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è.

–ü–ª–∞–≥–∏–Ω –≤ —Ñ–æ–Ω–µ:

```csharp
// Health check –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
[09:00:15] Health check: ‚úÖ Online (latency: 42ms)
[09:00:45] Health check: ‚úÖ Online (latency: 38ms)
[09:01:15] Health check: ‚úÖ Online (latency: 45ms)
```


***

### **2.2. –ü–µ—Ä–≤—ã–π –≥–æ—Å—Ç—å - –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤**

**09:15 - –ü—Ä–∏—Ö–æ–¥–∏—Ç –≥–æ—Å—Ç—å**

–ö–∞—Å—Å–∏—Ä —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑:

```
–ó–∞–∫–∞–∑ #2501
‚îú‚îÄ –ö–∞–ø—É—á–∏–Ω–æ –±–æ–ª—å—à–æ–π ......... 180 ‚ÇΩ
‚îú‚îÄ –ö—Ä—É–∞—Å—Å–∞–Ω —Å —à–æ–∫–æ–ª–∞–¥–æ–º ...... 120 ‚ÇΩ
‚îî‚îÄ –°–æ–∫ –∞–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π .......... 100 ‚ÇΩ

–ò—Ç–æ–≥–æ: 400 ‚ÇΩ
```

**–ì–æ—Å—Ç—å:** "–£ –º–µ–Ω—è –∫–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏"
**–ö–∞—Å—Å–∏—Ä:** –ù–∞–∂–∏–º–∞–µ—Ç **F9** (–∏–ª–∏ –∫–Ω–æ–ø–∫—É "Max Loyalty")

**–û–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Max Loyalty - –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                      ‚îÇ
‚îÇ  –í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω, –∫–æ–¥ –∫–∞—Ä—Ç—ã –∏–ª–∏ email:               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ _                                              ‚îÇ ‚îÇ ‚Üê –∫—É—Ä—Å–æ—Ä –∑–¥–µ—Å—å
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  üí° –ú–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ                    ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                          [–û—Ç–º–µ–Ω–∞]    [–ù–∞–π—Ç–∏ (Enter)]‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ì–æ—Å—Ç—å:** "–°–µ–º—å –¥–µ–≤—è—Ç—å –ø—è—Ç—å, –¥–≤–∞ —á–µ—Ç—ã—Ä–µ –≤–æ—Å–µ–º—å, –æ–¥–∏–Ω –¥–≤–∞ —Ç—Ä–∏ —á–µ—Ç—ã—Ä–µ"
**–ö–∞—Å—Å–∏—Ä:** –í–≤–æ–¥–∏—Ç `79524812‚Äã3‚Äã4`

```csharp
private async void OnSearchInputChanged(object sender, TextChangedEventArgs e)
{
    var input = SearchInput.Text;
    
    // –î–µ–±–∞—É–Ω—Å 500–º—Å
    await Task.Delay(500);
    
    if (SearchInput.Text != input) return; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∏–ª –≤–≤–æ–¥–∏—Ç—å
    
    if (input.Length >= 10) // –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø–æ–∏—Å–∫–∞
    {
        await SearchGuestAsync(input);
    }
}
```

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ—Å–ª–µ 500–º—Å:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Max Loyalty - –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                      ‚îÇ
‚îÇ  –í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω, –∫–æ–¥ –∫–∞—Ä—Ç—ã –∏–ª–∏ email:               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ 79524812‚Äã3‚Äã4                                      ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  üîç –ü–æ–∏—Å–∫...                                         ‚îÇ
‚îÇ                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ó–∞–ø—Ä–æ—Å –∫ API:**

```typescript
POST /api/search-guest
Headers:
  X-API-Key: rest001_abc123...
  Content-Type: application/json

Body:
{
  "input": "79524812‚Äã3‚Äã4",
  "restaurantId": "001"
}
```

**Backend –æ–±—Ä–∞–±–æ—Ç–∫–∞:**

```typescript
async searchGuest(input: string, restaurantId: string) {
  // 1. –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º input
  const normalized = this.normalizePhone(input); // +79524812‚Äã3‚Äã4
  
  // 2. –ò—â–µ–º –≤ –ë–î
  const guest = await prisma.guest.findFirst({
    where: {
      OR: [
        { phone: normalized },
        { phone: input },
        { cardCode: input },
        { email: input }
      ],
      restaurant: {
        id: restaurantId
      }
    },
    include: {
      level: true,
      transactions: {
        orderBy: { createdAt: 'desc' },
        take: 5
      }
    }
  });
  
  if (!guest) {
    return { found: false };
  }
  
  // 3. –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
  const balance = this.calculateBalance(guest);
  
  // 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  return {
    found: true,
    guest: {
      id: guest.id,
      cardId: guest.cardId,
      name: guest.name,
      phone: guest.phone,
      balance: balance,
      level: {
        number: guest.level.number,
        name: guest.level.name,
        discountPercentage: guest.level.discountPercentage,
        color: guest.level.color
      },
      registeredAt: guest.createdAt,
      lastVisit: guest.lastVisitAt,
      totalVisits: guest.visitsCount,
      transactions: guest.transactions.map(t => ({
        date: t.createdAt,
        type: t.type,
        amount: t.amount,
        description: t.description
      }))
    }
  };
}
```

**–û—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ 120–º—Å:**

```json
{
  "found": true,
  "guest": {
    "id": "g001",
    "cardId": "ML001234",
    "name": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
    "phone": "+79524812‚Äã3‚Äã4",
    "balance": 450,
    "level": {
      "number": 2,
      "name": "–°–µ—Ä–µ–±—Ä—è–Ω—ã–π",
      "discountPercentage": 5,
      "color": "#C0C0C0"
    },
    "registeredAt": "2025-12-15T10:30:00Z",
    "lastVisit": "2026-02-10T14:20:00Z",
    "totalVisits": 12,
    "transactions": [...]
  }
}
```

**–û–∫–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Max Loyalty - –ì–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  üë§ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤              üéñÔ∏è –°–µ—Ä–µ–±—Ä—è–Ω—ã–π    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  üìû +7 952 481-23-34         –£—Ä–æ–≤–µ–Ω—å 2         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  üí≥ ML001234                                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  üí∞ –ë–∞–ª–∞–Ω—Å: 450 –±–∞–ª–ª–æ–≤                         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  üìä –í–∏–∑–∏—Ç–æ–≤: 12 | –ü–æ—Å–ª–µ–¥–Ω–∏–π: 10.02.2026       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  [–ü–æ–¥—Ä–æ–±–Ω–µ–µ...]                                ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –°—É–º–º–∞ —á–µ–∫–∞: 400 ‚ÇΩ                                   ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  [–ù–∞–∑–∞–¥]  [–¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å]  [–°–ø–∏—Å–∞—Ç—å –∏ –Ω–∞—á–∏—Å–ª–∏—Ç—å] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ö–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç **"–¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å"**

**–ó–∞–ø—Ä–æ—Å calculate:**

```typescript
POST /api/calculate
{
  "guestCardId": "ML001234",
  "checkAmount": 400,
  "benefit": "EARN_ONLY"
}
```

**–û—Ç–≤–µ—Ç:**

```json
{
  "success": true,
  "calculation": {
    "checkAmount": 400,
    "pointsToEarn": 20,
    "earnRate": 5,
    "finalAmount": 400,
    "message": "–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ 20 –±–∞–ª–ª–æ–≤ (5% –æ—Ç —Å—É–º–º—ã)"
  }
}
```

**–û–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Max Loyalty - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                      ‚îÇ
‚îÇ  üë§ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ (ML001234)                           ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –°—É–º–º–∞ —á–µ–∫–∞: 400 ‚ÇΩ                                   ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  ‚úÖ –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +20 –±–∞–ª–ª–æ–≤                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: 450 –±.                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: 470 –±.                          ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ö –æ–ø–ª–∞—Ç–µ: 400 ‚ÇΩ                                     ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                          [–û—Ç–º–µ–Ω–∞]    [–ü—Ä–∏–º–µ–Ω–∏—Ç—å]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ö–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç **"–ü—Ä–∏–º–µ–Ω–∏—Ç—å"**

```csharp
private async void OnApplyClick(object sender, RoutedEventArgs e)
{
    try
    {
        LoadingOverlay.Show("–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ...");
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞
        var context = new LoyaltyContext
        {
            OrderId = currentOrder.Id.ToString(),
            GuestCardId = currentGuest.CardId,
            GuestName = currentGuest.Name,
            BenefitType = BenefitType.Points,
            Action = LoyaltyAction.EarnOnly,
            PointsToEarn = currentCalculation.PointsToEarn,
            OriginalCheckAmount = currentOrder.GetSum(),
            IsOffline = !healthCheck.IsOnline()
        };
        
        contextStorage.SaveContext(context);
        
        LoadingOverlay.Hide();
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
        DialogResult = true;
        Close();
        
        logger.LogInformation(
            "Earn-only operation applied: Order {OrderId}, Points {Points}",
            context.OrderId,
            context.PointsToEarn
        );
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        ShowSuccessNotification(
            $"–ì–æ—Å—Ç—é {currentGuest.Name} –±—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ {context.PointsToEarn} –±–∞–ª–ª–æ–≤"
        );
    }
    catch (Exception ex)
    {
        LoadingOverlay.Hide();
        ErrorHandler.Handle(ex, "ApplyEarnOnly");
    }
}
```

–û–∫–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –∫–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç —ç–∫—Ä–∞–Ω iiko:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  iiko Front - –ö–∞—Å—Å–∞                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [–ù–æ–≤—ã–π –∑–∞–∫–∞–∑] [–û–ø–ª–∞—Ç–∞] [üí≥ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤] [–ù–∞—Å—Ç—Ä–æ–π–∫–∏]‚îÇ ‚Üê –∫–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å!
‚îÇ                                                      ‚îÇ
‚îÇ  –ó–∞–∫–∞–∑ #2501                                         ‚îÇ
‚îÇ  ‚îú‚îÄ –ö–∞–ø—É—á–∏–Ω–æ –±–æ–ª—å—à–æ–π ................... 180 ‚ÇΩ      ‚îÇ
‚îÇ  ‚îú‚îÄ –ö—Ä—É–∞—Å—Å–∞–Ω —Å —à–æ–∫–æ–ª–∞–¥–æ–º ............... 120 ‚ÇΩ      ‚îÇ
‚îÇ  ‚îî‚îÄ –°–æ–∫ –∞–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π ................... 100 ‚ÇΩ      ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ò—Ç–æ–≥–æ: 400 ‚ÇΩ                                        ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  üí° –ì–æ—Å—Ç—é –±—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ 20 –±–∞–ª–ª–æ–≤                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ö–∞—Å—Å–∏—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–ø–ª–∞—Ç—É, –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —á–µ–∫.

**–°–æ–±—ã—Ç–∏–µ AfterOrderClose:**

```csharp
private async void OnAfterOrderClose(IOrder order, IPaymentTransaction payment)
{
    try
    {
        logger.LogInformation("AfterOrderClose: Order {OrderId}", order.Id);
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        var context = contextStorage.GetContext(order.Id.ToString());
        
        if (context == null)
        {
            return; // –ù–µ—Ç –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
        }
        
        logger.LogInformation(
            "Finalizing loyalty operation: Order {OrderId}, Action {Action}",
            order.Id,
            context.Action
        );
        
        // –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞ backend
        if (healthCheck.IsOnline())
        {
            // Online - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É
            await apiClient.FinalizePointsAsync(new FinalizePointsRequest
            {
                GuestCardId = context.GuestCardId,
                OrderId = context.OrderId,
                CheckAmount = order.GetSum(),
                Action = context.Action,
                PointsToEarn = context.PointsToEarn
            });
            
            logger.LogInformation("Order finalized successfully: {OrderId}", order.Id);
        }
        else
        {
            // Offline - –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
            offlineQueue.EnqueueOperation(new OfflineOperation
            {
                Type = OperationType.FINALIZE_EARN_ONLY,
                GuestCardId = context.GuestCardId,
                OrderId = context.OrderId,
                CheckAmount = order.GetSum(),
                PointsToEarn = context.PointsToEarn
            });
            
            logger.LogInformation(
                "Order queued for offline processing: {OrderId}",
                order.Id
            );
        }
        
        // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        contextStorage.RemoveContext(order.Id.ToString());
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Failed to finalize order: {OrderId}", order.Id);
        // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ–∫–∞ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –ø–ª–∞–≥–∏–Ω–∞
    }
}
```

**–ó–∞–ø—Ä–æ—Å finalize:**

```typescript
POST /api/finalize-points
{
  "guestCardId": "ML001234",
  "orderId": "2501",
  "checkAmount": 400,
  "action": "EARN_ONLY",
  "pointsToEarn": 20
}
```

**Backend –æ–±—Ä–∞–±–æ—Ç–∫–∞:**

```typescript
async finalizePoints(dto: FinalizePointsDto) {
  return await prisma.$transaction(async (tx) => {
    // 1. –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
    const transaction = await tx.loyaltyTransaction.create({
      data: {
        guestCardId: dto.guestCardId,
        orderId: dto.orderId,
        type: 'EARN',
        amount: dto.pointsToEarn,
        checkAmount: dto.checkAmount,
        description: `–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞ –∑–∞–∫–∞–∑ #${dto.orderId}`,
        createdAt: new Date()
      }
    });
    
    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≥–æ—Å—Ç—è
    await tx.guest.update({
      where: { cardId: dto.guestCardId },
      data: {
        lastVisitAt: new Date(),
        visitsCount: { increment: 1 }
      }
    });
    
    // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º progression —É—Ä–æ–≤–Ω—è
    const guest = await tx.guest.findUnique({
      where: { cardId: dto.guestCardId },
      include: { transactions: true }
    });
    
    const newBalance = this.calculateBalance(guest);
    await this.checkLevelProgression(guest, newBalance, tx);
    
    return {
      success: true,
      transactionId: transaction.id,
      newBalance: newBalance
    };
  });
}
```

**–û—Ç–≤–µ—Ç:**

```json
{
  "success": true,
  "transactionId": "t123456",
  "newBalance": 470
}
```

**‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!**

–ì–æ—Å—Ç—å –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ –ø–æ–ª—É—á–∏–ª +20 –±–∞–ª–ª–æ–≤. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: 470 –±–∞–ª–ª–æ–≤.

Backend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Å—Ç—è:

```
üí∞ –ù–∞—á–∏—Å–ª–µ–Ω–æ 20 –±–∞–ª–ª–æ–≤!
–í–∞—à –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: 470 –±.

–ó–∞–∫–∞–∑ –≤ Cafe Moscow –Ω–∞ 400 ‚ÇΩ
17.02.2026 –≤ 09:17
```


***

**–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏? (–°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤, offline —Ä–µ–∂–∏–º, –æ—à–∏–±–∫–∏ –∏ —Ç.–¥.)**

---

# –ö–∞–∂–µ—Ç—Å—è, —Ç—ã —á—Ç–æ-—Ç–æ —É–ø—É—Å—Ç–∏–ª. Discount –∏ –ü–µ–π–º–µ–Ω—Ç ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã, –∞ –Ω–µ —Ç–æ–≤–∞—Ä—ã. –ú—ã —Å —Ç–æ–±–æ–π —ç—Ç–æ –≤—ã—à–µ –æ–±—Å—É–∂–¥–∞–ª–∏. –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ä–µ—à–µ–Ω–∏—é.

–¢—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤! –ü—Ä–æ—à—É –ø—Ä–æ—â–µ–Ω–∏—è –∑–∞ –ø—É—Ç–∞–Ω–∏—Ü—É. –î–∞–≤–∞–π –∏—Å–ø—Ä–∞–≤–ª—é –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.

## **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–∫–∏–¥–∫–∞ –∏ –æ–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ - —ç—Ç–æ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã, –∞ –Ω–µ —Ç–æ–≤–∞—Ä—ã**


***

# üé¨ –ü–û–õ–ù–´–ô –ñ–ò–ó–ù–ï–ù–ù–´–ô –¶–ò–ö–õ –ü–õ–ê–ì–ò–ù–ê (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)

## **–ì–õ–ê–í–ê 1: –£–°–¢–ê–ù–û–í–ö–ê –ò –ü–ï–†–í–´–ô –ó–ê–ü–£–°–ö**

### **1.1-1.2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ installer**

*(–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π - –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤—ã—à–µ)*

***

### **1.3. –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ iiko Office**

**–≠–∫—Ä–∞–Ω 4 installer'–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π):**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ iiko                                    ‚îÇ
‚îÇ  –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã –∏ —Ç–∏–ø–∞ —Å–∫–∏–¥–∫–∏               ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –î–ª—è —Ä–∞–±–æ—Ç—ã –ø–ª–∞–≥–∏–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å –≤ iiko:       ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  1. –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã "Max Loyalty –±–∞–ª–ª—ã"          ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  üìç –ì–¥–µ: iiko Office ‚Üí –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ           –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã           ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: "Max Loyalty –±–∞–ª–ª—ã"               ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –¢–∏–ø: –í–Ω–µ—à–Ω–∏–π (External)                     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ö–æ–¥: MAX_LOYALTY_POINTS                     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ü—Ä–æ–≤–æ–¥–∏—Ç—å: –î–∞                               ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  2. –¢–∏–ø —Å–∫–∏–¥–∫–∏ "Max Loyalty —É—Ä–æ–≤–µ–Ω—å"           ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  üìç –ì–¥–µ: iiko Office ‚Üí –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ           –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –°–∫–∏–¥–∫–∏                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: "Max Loyalty —É—Ä–æ–≤–µ–Ω—å"             ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –¢–∏–ø: –†—É—á–Ω–∞—è –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å–∫–∏–¥–∫–∞              ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ö–æ–¥: MAX_LOYALTY_DISCOUNT                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ü—Ä–∏–º–µ–Ω—è—Ç—å: –ù–∞ –≤–µ—Å—å —á–µ–∫                      ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  üí° –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —É–∫–∞–∂–∏—Ç–µ ID –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö          ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                          [< –ù–∞–∑–∞–¥]    [–î–∞–ª–µ–µ >]     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

### **1.4. –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã –≤ iiko Office**

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç **iiko Office** ‚Üí **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Üí **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  iiko Office - –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã:                        ‚îÇ
‚îÇ  ‚îú‚îÄ üíµ –ù–∞–ª–∏—á–Ω—ã–µ                                      ‚îÇ
‚îÇ  ‚îú‚îÄ üí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞                              ‚îÇ
‚îÇ  ‚îú‚îÄ üì± –°–ë–ü                                           ‚îÇ
‚îÇ  ‚îî‚îÄ üéüÔ∏è –í–∞—É—á–µ—Ä                                        ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  [+ –î–æ–±–∞–≤–∏—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã]                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ù–∞–∂–∏–º–∞–µ—Ç **"+ –î–æ–±–∞–≤–∏—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã"**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                      ‚îÇ
‚îÇ  –ù–∞–∑–≤–∞–Ω–∏–µ:                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Max Loyalty –±–∞–ª–ª—ã                              ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ö–æ–¥ (–¥–ª—è API):                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ MAX_LOYALTY_POINTS                             ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –¢–∏–ø:                                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ [‚ñº] –í–Ω–µ—à–Ω–∏–π (External)                         ‚îÇ ‚îÇ ‚Üê –í–∞–∂–Ω–æ!
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚òë –ü—Ä–æ–≤–æ–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É                                  ‚îÇ
‚îÇ  ‚òë –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –Ω–∞ –∫–∞—Å—Å–µ                               ‚îÇ
‚îÇ  ‚òê –¢—Ä–µ–±–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞                         ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ò–∫–æ–Ω–∫–∞:                                             ‚îÇ
‚îÇ  [üéÅ] [–í—ã–±—Ä–∞—Ç—å –∏–∫–æ–Ω–∫—É...]                            ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                          [–û—Ç–º–µ–Ω–∞]    [–°–æ—Ö—Ä–∞–Ω–∏—Ç—å]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã —Å–æ–∑–¥–∞–Ω                                ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ID —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã:                                  ‚îÇ
‚îÇ  8f7a3b21-4d5e-4c9a-8a1b-2e3f4g5h6i7j                ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç ID –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞–≥–∏–Ω–∞            ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                                       [OK]           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

ID —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã: `8f7a3b21-4d5e-4c9a-8a1b-2e3f4g5h6i7j`

***

### **1.5. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–ø–∞ —Å–∫–∏–¥–∫–∏ –≤ iiko Office**

**iiko Office** ‚Üí **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Üí **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **–°–∫–∏–¥–∫–∏**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  iiko Office - –°–∫–∏–¥–∫–∏                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∫–∏–¥–∫–∏:                                ‚îÇ
‚îÇ  ‚îú‚îÄ üéÇ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è (10%)                           ‚îÇ
‚îÇ  ‚îú‚îÄ üë• –î—Ä—É–∑—å—è –∑–∞–≤–µ–¥–µ–Ω–∏—è (15%)                        ‚îÇ
‚îÇ  ‚îî‚îÄ üéì –°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è (5%)                             ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  [+ –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É]                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ù–∞–∂–∏–º–∞–µ—Ç **"+ –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É"**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫–∏–¥–∫–∏                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                      ‚îÇ
‚îÇ  –ù–∞–∑–≤–∞–Ω–∏–µ:                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Max Loyalty —É—Ä–æ–≤–µ–Ω—å                            ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ö–æ–¥ (–¥–ª—è API):                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ MAX_LOYALTY_DISCOUNT                           ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –¢–∏–ø —Å–∫–∏–¥–∫–∏:                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ [‚ñº] –†—É—á–Ω–∞—è –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è                          ‚îÇ ‚îÇ ‚Üê –í–∞–∂–Ω–æ!
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ü—Ä–∏–º–µ–Ω—è—Ç—å:                                          ‚îÇ
‚îÇ  ‚óè –ù–∞ –≤–µ—Å—å —á–µ–∫                                       ‚îÇ
‚îÇ  ‚óã –ù–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏                              ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚òë –ú–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é                       ‚îÇ
‚îÇ  ‚òë –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –Ω–∞ –∫–∞—Å—Å–µ                               ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ò–∫–æ–Ω–∫–∞:                                             ‚îÇ
‚îÇ  [üéñÔ∏è] [–í—ã–±—Ä–∞—Ç—å –∏–∫–æ–Ω–∫—É...]                            ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                          [–û—Ç–º–µ–Ω–∞]    [–°–æ—Ö—Ä–∞–Ω–∏—Ç—å]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

ID —Å–∫–∏–¥–∫–∏: `9g8b4c32-5e6f-5d0b-9b2c-3f4g5h6i7j8k`

***

### **1.6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ID –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –ø–ª–∞–≥–∏–Ω–∞**

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç iiko Front, –Ω–∞–∂–∏–º–∞–µ—Ç **Ctrl+Shift+D**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Max Loyalty - –ù–∞—Å—Ç—Ä–æ–π–∫–∏                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                      ‚îÇ
‚îÇ  –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å iiko                                   ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ID —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã "Max Loyalty –±–∞–ª–ª—ã":              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ 8f7a3b21-4d5e-4c9a-8a1b-2e3f4g5h6i7j          ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ID —Å–∫–∏–¥–∫–∏ "Max Loyalty —É—Ä–æ–≤–µ–Ω—å":                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ 9g8b4c32-5e6f-5d0b-9b2c-3f4g5h6i7j8k          ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  [–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏]                               ‚îÇ
‚îÇ                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –¢–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞.**

***

## **–ì–õ–ê–í–ê 2: –†–ê–ë–û–¢–ê - –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø**

### **2.1. –°—Ü–µ–Ω–∞—Ä–∏–π: –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤**

**10:30 - –ì–æ—Å—Ç—å —Ö–æ—á–µ—Ç –æ–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏**

–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω:

```
–ó–∞–∫–∞–∑ #2505
‚îú‚îÄ –ë—É—Ä–≥–µ—Ä –ø—Ä–µ–º–∏—É–º ................ 550 ‚ÇΩ
‚îú‚îÄ –ö–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏ ................. 120 ‚ÇΩ
‚îî‚îÄ Milkshake –≤–∞–Ω–∏–ª—å–Ω—ã–π ........... 230 ‚ÇΩ

–ò—Ç–æ–≥–æ: 900 ‚ÇΩ
```

–ö–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç **F9**, –∏—â–µ—Ç –≥–æ—Å—Ç—è, –≥–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω:

```
üë§ –ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞
üéñÔ∏è –ó–æ–ª–æ—Ç–æ–π —É—Ä–æ–≤–µ–Ω—å (10% —Å–∫–∏–¥–∫–∞)
üí∞ –ë–∞–ª–∞–Ω—Å: 1200 –±–∞–ª–ª–æ–≤
```

–ö–∞—Å—Å–∏—Ä –≤—ã–±–∏—Ä–∞–µ—Ç **"–°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã"**

**–û–∫–Ω–æ —Å–ø–∏—Å–∞–Ω–∏—è:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Max Loyalty - –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                      ‚îÇ
‚îÇ  üë§ –ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞ (ML002456)                        ‚îÇ
‚îÇ  üí∞ –î–æ—Å—Ç—É–ø–Ω–æ: 1200 –±–∞–ª–ª–æ–≤                            ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –°—É–º–º–∞ —á–µ–∫–∞: 900 ‚ÇΩ                                   ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –°–∫–æ–ª—å–∫–æ –±–∞–ª–ª–æ–≤ —Å–ø–∏—Å–∞—Ç—å?                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ _                                              ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ë—ã—Å—Ç—Ä—ã–µ —Å—É–º–º—ã:                                      ‚îÇ
‚îÇ  [100 –±.] [200 –±.] [500 –±.] [–í—Å–µ (1200 –±.)]         ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  üí° 1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å                                 ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ    ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ö –æ–ø–ª–∞—Ç–µ: 900 ‚ÇΩ                                     ‚îÇ
‚îÇ  –ë–∞–ª–ª–∞–º–∏: 0 ‚ÇΩ                                        ‚îÇ
‚îÇ  –û—Å—Ç–∞—Ç–æ–∫: 900 ‚ÇΩ                                      ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                          [–û—Ç–º–µ–Ω–∞]    [–ü—Ä–∏–º–µ–Ω–∏—Ç—å]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ì–æ—Å—Ç—å –≥–æ–≤–æ—Ä–∏—Ç: "–•–æ—á—É —Å–ø–∏—Å–∞—Ç—å 500 –±–∞–ª–ª–æ–≤"

–ö–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç **[500 –±.]** –∏–ª–∏ –≤–≤–æ–¥–∏—Ç `500`

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Max Loyalty - –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                      ‚îÇ
‚îÇ  üë§ –ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞ (ML002456)                        ‚îÇ
‚îÇ  üí∞ –î–æ—Å—Ç—É–ø–Ω–æ: 1200 –±–∞–ª–ª–æ–≤                            ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –°—É–º–º–∞ —á–µ–∫–∞: 900 ‚ÇΩ                                   ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –°–∫–æ–ª—å–∫–æ –±–∞–ª–ª–æ–≤ —Å–ø–∏—Å–∞—Ç—å?                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ 500                                            ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ë—ã—Å—Ç—Ä—ã–µ —Å—É–º–º—ã:                                      ‚îÇ
‚îÇ  [100 –±.] [200 –±.] [500 –±.] [–í—Å–µ (1200 –±.)]         ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  üí° 1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å                                 ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ    ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚úÖ –ö –æ–ø–ª–∞—Ç–µ: 900 ‚ÇΩ                                  ‚îÇ
‚îÇ     –ë–∞–ª–ª–∞–º–∏: 500 ‚ÇΩ                                   ‚îÇ
‚îÇ     –û—Å—Ç–∞—Ç–æ–∫ (–¥—Ä—É–≥–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏): 400 ‚ÇΩ               ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  üí∞ –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +18 –±–∞–ª–ª–æ–≤ (2% –æ—Ç 900 ‚ÇΩ)       ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                          [–û—Ç–º–µ–Ω–∞]    [–ü—Ä–∏–º–µ–Ω–∏—Ç—å]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ö–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç **"–ü—Ä–∏–º–µ–Ω–∏—Ç—å"**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –ø–ª–∞–≥–∏–Ω–µ:**

```csharp
private async void OnApplySpendClick(object sender, RoutedEventArgs e)
{
    try
    {
        LoadingOverlay.Show("–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤...");
        
        // 1. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –±–∞–ª–ª—ã –Ω–∞ backend
        var reserveResponse = await apiClient.ReservePointsAsync(new ReservePointsRequest
        {
            GuestCardId = currentGuest.CardId,
            PointsToSpend = pointsToSpend,
            CheckAmount = currentOrder.GetSum()
        });
        
        if (!reserveResponse.Success)
        {
            throw new InvalidOperationException(reserveResponse.ErrorMessage);
        }
        
        // 2. –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –≤ iiko
        var paymentType = pluginContext.GetPaymentTypes()
            .FirstOrDefault(pt => pt.Id == configService.GetPointsPaymentTypeId());
        
        if (paymentType == null)
        {
            throw new InvalidOperationException(
                "–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã 'Max Loyalty –±–∞–ª–ª—ã' –Ω–µ –Ω–∞–π–¥–µ–Ω"
            );
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–ª–∞—Ç—É –±–∞–ª–ª–∞–º–∏ –≤ –∑–∞–∫–∞–∑
        currentOrder.AddPayment(new PaymentItem
        {
            PaymentType = paymentType,
            Amount = pointsToSpend, // 500 —Ä—É–±–ª–µ–π
            IsProcessed = false // –ë—É–¥–µ—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω–æ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ–∫–∞
        });
        
        logger.LogInformation(
            "Added points payment: Order {OrderId}, Amount {Amount}, ReservationId {ReservationId}",
            currentOrder.Id,
            pointsToSpend,
            reserveResponse.ReservationId
        );
        
        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        var context = new LoyaltyContext
        {
            OrderId = currentOrder.Id.ToString(),
            GuestCardId = currentGuest.CardId,
            GuestName = currentGuest.Name,
            BenefitType = BenefitType.Points,
            Action = LoyaltyAction.SpendAndEarn,
            PointsToSpend = pointsToSpend,
            PointsToEarn = currentCalculation.PointsToEarn,
            OriginalCheckAmount = currentOrder.GetSum(),
            ReservationId = reserveResponse.ReservationId,
            ReservationExpiresAt = reserveResponse.ExpiresAt
        };
        
        contextStorage.SaveContext(context);
        
        LoadingOverlay.Hide();
        
        // 4. –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
        DialogResult = true;
        Close();
        
        // 5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        ShowSuccessNotification(
            $"–°–ø–∏—Å–∞–Ω–æ {pointsToSpend} –±–∞–ª–ª–æ–≤\n" +
            $"–ö –æ–ø–ª–∞—Ç–µ –æ—Å—Ç–∞–ª–æ—Å—å: {currentOrder.GetSum() - pointsToSpend} ‚ÇΩ"
        );
    }
    catch (Exception ex)
    {
        LoadingOverlay.Hide();
        ErrorHandler.Handle(ex, "ApplySpend");
    }
}
```

**–í UI iiko:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  iiko Front - –ö–∞—Å—Å–∞                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [–ù–æ–≤—ã–π –∑–∞–∫–∞–∑] [–û–ø–ª–∞—Ç–∞] [üí≥ –ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞]          ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ó–∞–∫–∞–∑ #2505                                         ‚îÇ
‚îÇ  ‚îú‚îÄ –ë—É—Ä–≥–µ—Ä –ø—Ä–µ–º–∏—É–º ................... 550 ‚ÇΩ        ‚îÇ
‚îÇ  ‚îú‚îÄ –ö–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏ .................... 120 ‚ÇΩ        ‚îÇ
‚îÇ  ‚îî‚îÄ Milkshake –≤–∞–Ω–∏–ª—å–Ω—ã–π .............. 230 ‚ÇΩ        ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ò—Ç–æ–≥–æ: 900 ‚ÇΩ                                        ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –û–ø–ª–∞—Ç–∞:                                             ‚îÇ
‚îÇ  ‚îú‚îÄ üéÅ Max Loyalty –±–∞–ª–ª—ã ............. 500 ‚ÇΩ ‚úÖ     ‚îÇ
‚îÇ  ‚îî‚îÄ –ö –æ–ø–ª–∞—Ç–µ ......................... 400 ‚ÇΩ        ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  üí° –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ 18 –±–∞–ª–ª–æ–≤                        ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  [–ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É]                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ö–∞—Å—Å–∏—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–ø–ª–∞—Ç—É –æ—Å—Ç–∞—Ç–∫–∞ (400 ‚ÇΩ –∫–∞—Ä—Ç–æ–π), –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —á–µ–∫.

**–°–æ–±—ã—Ç–∏–µ AfterOrderClose:**

```csharp
private async void OnAfterOrderClose(IOrder order, IEnumerable<IPaymentItem> payments)
{
    try
    {
        var context = contextStorage.GetContext(order.Id.ToString());
        if (context == null) return;
        
        logger.LogInformation(
            "Finalizing loyalty: Order {OrderId}, Action {Action}",
            order.Id,
            context.Action
        );
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ –ø—Ä–æ—à–ª–∞
        var pointsPayment = payments.FirstOrDefault(p => 
            p.PaymentType.Id == configService.GetPointsPaymentTypeId()
        );
        
        if (pointsPayment == null || !pointsPayment.IsProcessed)
        {
            logger.LogWarning(
                "Points payment not processed, cancelling reservation: Order {OrderId}",
                order.Id
            );
            
            // –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é
            await apiClient.CancelReservationAsync(new CancelReservationRequest
            {
                ReservationId = context.ReservationId,
                Reason = "PAYMENT_NOT_PROCESSED"
            });
            
            contextStorage.RemoveContext(order.Id.ToString());
            return;
        }
        
        // –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
        await apiClient.FinalizeSpendAndEarnAsync(new FinalizeSpendAndEarnRequest
        {
            GuestCardId = context.GuestCardId,
            OrderId = context.OrderId,
            ReservationId = context.ReservationId,
            CheckAmount = order.GetSum(),
            PointsSpent = context.PointsToSpend,
            PointsToEarn = context.PointsToEarn
        });
        
        logger.LogInformation(
            "Order finalized: {OrderId}, Spent {Spent}, Earned {Earned}",
            order.Id,
            context.PointsToSpend,
            context.PointsToEarn
        );
        
        contextStorage.RemoveContext(order.Id.ToString());
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Failed to finalize order: {OrderId}", order.Id);
    }
}
```

**‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!**

–ì–æ—Å—Ç—é –ú–∞—Ä–∏–∏:

- –°–ø–∏—Å–∞–Ω–æ: 500 –±–∞–ª–ª–æ–≤
- –ù–∞—á–∏—Å–ª–µ–Ω–æ: +18 –±–∞–ª–ª–æ–≤
- –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: 718 –±–∞–ª–ª–æ–≤ (1200 - 500 + 18)

***

### **2.2. –°—Ü–µ–Ω–∞—Ä–∏–π: –°–∫–∏–¥–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—é**

**14:00 - –ì–æ—Å—Ç—å —Å –≤—ã—Å–æ–∫–∏–º —É—Ä–æ–≤–Ω–µ–º**

–ó–∞–∫–∞–∑:

```
–ó–∞–∫–∞–∑ #2512
‚îú‚îÄ –°—Ç–µ–π–∫ —Ä–∏–±–∞–π .................... 1800 ‚ÇΩ
‚îú‚îÄ –°–∞–ª–∞—Ç –¶–µ–∑–∞—Ä—å ................... 450 ‚ÇΩ
‚îî‚îÄ –í–∏–Ω–æ –∫—Ä–∞—Å–Ω–æ–µ (–±–æ–∫–∞–ª) ........... 350 ‚ÇΩ

–ò—Ç–æ–≥–æ: 2600 ‚ÇΩ
```

–ö–∞—Å—Å–∏—Ä –∏—â–µ—Ç –≥–æ—Å—Ç—è:

```
üë§ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ò–≤–∞–Ω–æ–≤
üéñÔ∏è –ü–ª–∞—Ç–∏–Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å (15% —Å–∫–∏–¥–∫–∞)
üí∞ –ë–∞–ª–∞–Ω—Å: 3500 –±–∞–ª–ª–æ–≤
```

–ö–∞—Å—Å–∏—Ä –≤—ã–±–∏—Ä–∞–µ—Ç **"–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É —É—Ä–æ–≤–Ω—è"**

**–†–∞—Å—á–µ—Ç:**

```typescript
POST /api/calculate
{
  "guestCardId": "ML003789",
  "checkAmount": 2600,
  "benefit": "DISCOUNT_ONLY"
}

Response:
{
  "calculation": {
    "discountPercentage": 15,
    "discountAmount": 390,
    "finalAmount": 2210,
    "pointsToEarn": 52,
    "message": "–°–∫–∏–¥–∫–∞ 15% (–ü–ª–∞—Ç–∏–Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å)"
  }
}
```

**–û–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Max Loyalty - –°–∫–∏–¥–∫–∞ —É—Ä–æ–≤–Ω—è                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                      ‚îÇ
‚îÇ  üë§ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ò–≤–∞–Ω–æ–≤                                 ‚îÇ
‚îÇ  üéñÔ∏è –ü–ª–∞—Ç–∏–Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å                               ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –°—É–º–º–∞ —á–µ–∫–∞: 2600 ‚ÇΩ                                  ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  ‚úÖ –°–∫–∏–¥–∫–∞ 15%: -390 ‚ÇΩ                         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: 2210 ‚ÇΩ                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  üí∞ –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +52 –±–∞–ª–ª–∞ (2% –æ—Ç 2600 ‚ÇΩ) ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ                          [–û—Ç–º–µ–Ω–∞]    [–ü—Ä–∏–º–µ–Ω–∏—Ç—å]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ö–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç **"–ü—Ä–∏–º–µ–Ω–∏—Ç—å"**

```csharp
private async void OnApplyDiscountClick(object sender, RoutedEventArgs e)
{
    try
    {
        LoadingOverlay.Show("–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏...");
        
        // 1. –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø —Å–∫–∏–¥–∫–∏ –∏–∑ iiko
        var discountType = pluginContext.GetDiscountTypes()
            .FirstOrDefault(dt => dt.Id == configService.GetDiscountTypeId());
        
        if (discountType == null)
        {
            throw new InvalidOperationException(
                "–¢–∏–ø —Å–∫–∏–¥–∫–∏ 'Max Loyalty —É—Ä–æ–≤–µ–Ω—å' –Ω–µ –Ω–∞–π–¥–µ–Ω"
            );
        }
        
        // 2. –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É –∫ –∑–∞–∫–∞–∑—É
        currentOrder.AddDiscount(new DiscountItem
        {
            DiscountType = discountType,
            DiscountMode = DiscountMode.Percentage,
            DiscountPercentage = currentCalculation.DiscountPercentage, // 15%
            ApplyTo = DiscountApplyMode.WholeCheck
        });
        
        logger.LogInformation(
            "Applied level discount: Order {OrderId}, Percentage {Percentage}%",
            currentOrder.Id,
            currentCalculation.DiscountPercentage
        );
        
        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        var context = new LoyaltyContext
        {
            OrderId = currentOrder.Id.ToString(),
            GuestCardId = currentGuest.CardId,
            GuestName = currentGuest.Name,
            BenefitType = BenefitType.Discount,
            Action = LoyaltyAction.DiscountAndEarn,
            DiscountPercentage = currentCalculation.DiscountPercentage,
            DiscountAmount = currentCalculation.DiscountAmount,
            PointsToEarn = currentCalculation.PointsToEarn,
            OriginalCheckAmount = currentOrder.GetSum()
        };
        
        contextStorage.SaveContext(context);
        
        LoadingOverlay.Hide();
        DialogResult = true;
        Close();
        
        ShowSuccessNotification(
            $"–ü—Ä–∏–º–µ–Ω–µ–Ω–∞ —Å–∫–∏–¥–∫–∞ {currentCalculation.DiscountPercentage}%\n" +
            $"–≠–∫–æ–Ω–æ–º–∏—è: {currentCalculation.DiscountAmount} ‚ÇΩ"
        );
    }
    catch (Exception ex)
    {
        LoadingOverlay.Hide();
        ErrorHandler.Handle(ex, "ApplyDiscount");
    }
}
```

**–í UI iiko:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  iiko Front - –ö–∞—Å—Å–∞                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [–ù–æ–≤—ã–π –∑–∞–∫–∞–∑] [–û–ø–ª–∞—Ç–∞] [üíé –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ò–≤–∞–Ω–æ–≤]        ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ó–∞–∫–∞–∑ #2512                                         ‚îÇ
‚îÇ  ‚îú‚îÄ –°—Ç–µ–π–∫ —Ä–∏–±–∞–π ................... 1800 ‚ÇΩ          ‚îÇ
‚îÇ  ‚îú‚îÄ –°–∞–ª–∞—Ç –¶–µ–∑–∞—Ä—å .................. 450 ‚ÇΩ           ‚îÇ
‚îÇ  ‚îî‚îÄ –í–∏–Ω–æ –∫—Ä–∞—Å–Ω–æ–µ (–±–æ–∫–∞–ª) .......... 350 ‚ÇΩ           ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –∏—Ç–æ–≥: 2600 ‚ÇΩ                          ‚îÇ
‚îÇ  üéñÔ∏è Max Loyalty —É—Ä–æ–≤–µ–Ω—å (15%): -390 ‚ÇΩ               ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  –ò—Ç–æ–≥–æ: 2210 ‚ÇΩ                                       ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  üí° –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ 52 –±–∞–ª–ª–∞                         ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  [–ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É]                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**‚úÖ –¢–µ–ø–µ—Ä—å –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ!**

–°–∫–∏–¥–∫–∞ –∏ –æ–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ - —ç—Ç–æ **—Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã –∏ —Å–∫–∏–¥–∫–∏ –≤ iiko**, –∞ –Ω–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã.

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ (offline —Ä–µ–∂–∏–º, –æ—à–∏–±–∫–∏, etc.)?

---

# –ù–∞–ø–æ–º–Ω—é. –ß—Ç–æ –°–∫–∏–¥–∫–∏ –∏ –û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã –≤ —Ç–∞–∫–æ–º –≤–∏–¥–µ, –∫–∞–∫ –Ω–∞ —Ñ–æ—Ç–æ. So, –¢–æ –µ—Å—Ç—å –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –ø–æ–¥ —Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è, —á—Ç–æ –≤ —á–µ–∫–µ. Payment-–º–µ—Ç–æ–¥ –º–æ–∂–Ω–æ —á–∏—Å—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ø–∏—Å–∞—Ç—å –º–µ–Ω—å—à–µ –±–∞–ª–ª–æ–≤, —á–µ–º —É–∫–∞–∑–∞–Ω–æ –≤ —è—á–µ–π–∫–µ. –≠—Ç–æ –≤–æ—Ç –º–æ–∂–Ω–æ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é. –î–∏—Å–∫–æ–¥–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –Ω–µ–ª—å–∑—è —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é, –æ–Ω–∞ –≤–æ—Ç –∫–∞–∫ –µ—Å—Ç—å, —Ç–∞–∫ –∏ –µ—Å—Ç—å, –∫–∞–∫ –≤ —è—á–µ–π–∫–µ, —Ç–∞–∫ –∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã. –ú—ã —ç—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã –æ–±—Å—É–∂–¥–∞–ª–∏ –≤—ã—à–µ –∏ –ø—Ä–∏—à–ª–∏ –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ä–µ—à–µ–Ω–∏—é, –ø—Ä–æ—Å–º–æ—Ç—Ä–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—à –¥–∏–∞–ª–æ–≥. –î–æ –º–æ–º–µ–Ω—Ç–∞, –∫–æ–≥–¥–∞ —Ç—ã –∑–∞–¥–∞–≤–∞–ª –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã. –ú—ã —Ç–∞–º –æ–±–æ–∑–Ω–∞—á–∏–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–∞–∫ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å.

–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –≤–∏–∂—É –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞—Ö –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º iiko. –°–ø–∞—Å–∏–±–æ –∑–∞ —É—Ç–æ—á–Ω–µ–Ω–∏–µ!

–î–∞–≤–∞–π —è –ø–µ—Ä–µ—Å–º–æ—Ç—Ä—é –Ω–∞—à –¥–∏–∞–ª–æ–≥ –∏ –∏—Å–ø—Ä–∞–≤–ª—é –ø–æ–Ω–∏–º–∞–Ω–∏–µ:

## **–ü–†–ê–í–ò–õ–¨–ù–û–ï –ü–û–ù–ò–ú–ê–ù–ò–ï** (–ø–æ —Ñ–æ—Ç–æ –∏ –Ω–∞—à–µ–º—É –æ–±—Å—É–∂–¥–µ–Ω–∏—é):

### **1. –û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ (PREMIUMBONUS PAYMENT –Ω–∞ —Ñ–æ—Ç–æ)**

‚úÖ **–≠—Ç–æ Payment Type –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã**

- –ü–ª–∞–≥–∏–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç payment –º–µ—Ç–æ–¥ –ø—Ä—è–º–æ –≤ —Å–ø–∏—Å–æ–∫ –æ–ø–ª–∞—Ç
- –ö–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç –µ–≥–æ —Å—Ä–µ–¥–∏ –¥—Ä—É–≥–∏—Ö —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã
- **–ú–û–ñ–ù–û –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é** - –∫–∞—Å—Å–∏—Ä –º–æ–∂–µ—Ç —É–º–µ–Ω—å—à–∏—Ç—å/—É–≤–µ–ª–∏—á–∏—Ç—å —Å—É–º–º—É —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤
- –û—Å—Ç–∞—Ç–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã


### **2. –°–∫–∏–¥–∫–∞ (Max Loyalty —É—Ä–æ–≤–µ–Ω—å)**

‚úÖ **–≠—Ç–æ Discount –≤ —á–µ–∫–µ (–ù–ï –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã)**

- –ü–ª–∞–≥–∏–Ω –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å–∫–∏–¥–∫—É –∫ –∑–∞–∫–∞–∑—É —á–µ—Ä–µ–∑ `IOrder.AddDiscount()`
- –°–∫–∏–¥–∫–∞ —É–º–µ–Ω—å—à–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –î–û —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–ø–ª–∞—Ç—ã
- **–ù–ï–õ–¨–ó–Ø –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é** - –æ–Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–∑ —É—Ä–æ–≤–Ω—è –≥–æ—Å—Ç—è
- –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã –∫–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç —É–∂–µ –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É —Å–æ —Å–∫–∏–¥–∫–æ–π

***

## **–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î**

### **–°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤**

```csharp
private async void OnApplySpendClick(object sender, RoutedEventArgs e)
{
    try
    {
        LoadingOverlay.Show("–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤...");
        
        // 1. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –±–∞–ª–ª—ã –Ω–∞ backend
        var reserveResponse = await apiClient.ReservePointsAsync(new ReservePointsRequest
        {
            GuestCardId = currentGuest.CardId,
            PointsToSpend = pointsToSpend,
            CheckAmount = currentOrder.GetSum()
        });
        
        if (!reserveResponse.Success)
        {
            throw new InvalidOperationException(reserveResponse.ErrorMessage);
        }
        
        // 2. –î–æ–±–∞–≤–ª—è–µ–º Payment Type –∫ –∑–∞–∫–∞–∑—É
        // ‚ö†Ô∏è –ù–ï –ü–†–û–í–û–î–ò–ú –û–ü–õ–ê–¢–£ - –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–æ–¥!
        var paymentTypeId = configService.GetPointsPaymentTypeId();
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º iiko SDK –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è external payment
        pluginContext.Operations.AddExternalPaymentItem(
            order: currentOrder,
            paymentTypeId: paymentTypeId,
            sum: pointsToSpend, // –ù–∞—á–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é)
            isProcessed: false, // –ù–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ - –∫–∞—Å—Å–∏—Ä —Å–∞–º –ø—Ä–æ–≤–µ–¥–µ—Ç
            additionalData: new Dictionary<string, string>
            {
                ["MaxLoyaltyReservationId"] = reserveResponse.ReservationId,
                ["MaxLoyaltyGuestCardId"] = currentGuest.CardId,
                ["MaxLoyaltyGuestName"] = currentGuest.Name
            }
        );
        
        logger.LogInformation(
            "Added payment type to order: OrderId={OrderId}, PaymentTypeId={PaymentTypeId}, Sum={Sum}, ReservationId={ReservationId}",
            currentOrder.Id,
            paymentTypeId,
            pointsToSpend,
            reserveResponse.ReservationId
        );
        
        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        var context = new LoyaltyContext
        {
            OrderId = currentOrder.Id.ToString(),
            GuestCardId = currentGuest.CardId,
            GuestName = currentGuest.Name,
            BenefitType = BenefitType.Points,
            Action = LoyaltyAction.SpendAndEarn,
            PointsToSpend = pointsToSpend,
            PointsToEarn = currentCalculation.PointsToEarn,
            OriginalCheckAmount = currentOrder.GetSum(),
            ReservationId = reserveResponse.ReservationId,
            ReservationExpiresAt = reserveResponse.ExpiresAt
        };
        
        contextStorage.SaveContext(context);
        
        LoadingOverlay.Hide();
        
        // 4. –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–ª–∞–≥–∏–Ω–∞
        DialogResult = true;
        Close();
        
        // 5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        ShowSuccessNotification(
            $"–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏: {pointsToSpend} ‚ÇΩ\n" +
            $"–ö–∞—Å—Å–∏—Ä –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã"
        );
        
        // ‚úÖ –ö–∞—Å—Å–∏—Ä —Ç–µ–ø–µ—Ä—å –≤–∏–¥–∏—Ç –Ω–∞ —ç–∫—Ä–∞–Ω–µ iiko:
        // –ó–∞–∫–∞–∑ #2505: 900 ‚ÇΩ
        // [–ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É] ‚Üê –∫–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç
        // 
        // –≠–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã:
        // ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        // ‚îÇ –ö –û–ü–õ–ê–¢–ï: 900,00 —Ä.         ‚îÇ
        // ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
        // ‚îÇ üí∞ Max Loyalty –±–∞–ª–ª—ã        ‚îÇ ‚Üê –ø–æ—è–≤–∏–ª–æ—Å—å!
        // ‚îÇ    400,00 —Ä.  [‚úï]           ‚îÇ ‚Üê –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å
        // ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
        // ‚îÇ üíµ –ù–ê–õ–ò–ß–ù–´–ï                 ‚îÇ
        // ‚îÇ    500,00 —Ä. (–æ—Å—Ç–∞—Ç–æ–∫)      ‚îÇ
        // ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    }
    catch (Exception ex)
    {
        LoadingOverlay.Hide();
        ErrorHandler.Handle(ex, "ApplySpend");
    }
}
```


### **–°—Ü–µ–Ω–∞—Ä–∏–π 2: –°–∫–∏–¥–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—é**

```csharp
private async void OnApplyDiscountClick(object sender, RoutedEventArgs e)
{
    try
    {
        LoadingOverlay.Show("–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏...");
        
        // 1. –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø —Å–∫–∏–¥–∫–∏ –∏–∑ iiko
        var discountTypeId = configService.GetDiscountTypeId();
        
        // 2. –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É –ö –ó–ê–ö–ê–ó–£ (–Ω–µ –∫ –æ–ø–ª–∞—Ç–µ!)
        // ‚ö†Ô∏è –°–∫–∏–¥–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –î–û —ç–∫—Ä–∞–Ω–∞ –æ–ø–ª–∞—Ç—ã
        pluginContext.Operations.AddDiscount(
            order: currentOrder,
            discountTypeId: discountTypeId,
            discountSum: currentCalculation.DiscountAmount, // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞
            additionalData: new Dictionary<string, string>
            {
                ["MaxLoyaltyGuestCardId"] = currentGuest.CardId,
                ["MaxLoyaltyGuestName"] = currentGuest.Name,
                ["MaxLoyaltyLevel"] = currentGuest.Level.Name,
                ["MaxLoyaltyDiscountPercent"] = currentCalculation.DiscountPercentage.ToString()
            }
        );
        
        logger.LogInformation(
            "Applied discount to order: OrderId={OrderId}, DiscountTypeId={DiscountTypeId}, Amount={Amount}, Percentage={Percentage}%",
            currentOrder.Id,
            discountTypeId,
            currentCalculation.DiscountAmount,
            currentCalculation.DiscountPercentage
        );
        
        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        var context = new LoyaltyContext
        {
            OrderId = currentOrder.Id.ToString(),
            GuestCardId = currentGuest.CardId,
            GuestName = currentGuest.Name,
            BenefitType = BenefitType.Discount,
            Action = LoyaltyAction.DiscountAndEarn,
            DiscountPercentage = currentCalculation.DiscountPercentage,
            DiscountAmount = currentCalculation.DiscountAmount,
            PointsToEarn = currentCalculation.PointsToEarn,
            OriginalCheckAmount = currentOrder.GetSum()
        };
        
        contextStorage.SaveContext(context);
        
        LoadingOverlay.Hide();
        DialogResult = true;
        Close();
        
        ShowSuccessNotification(
            $"–ü—Ä–∏–º–µ–Ω–µ–Ω–∞ —Å–∫–∏–¥–∫–∞ {currentCalculation.DiscountPercentage}%\n" +
            $"–≠–∫–æ–Ω–æ–º–∏—è: {currentCalculation.DiscountAmount} ‚ÇΩ"
        );
        
        // ‚úÖ –ö–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç –≤ iiko:
        // –ó–∞–∫–∞–∑ #2512
        // ‚îú‚îÄ –°—Ç–µ–π–∫ —Ä–∏–±–∞–π ................... 1800 ‚ÇΩ
        // ‚îú‚îÄ –°–∞–ª–∞—Ç –¶–µ–∑–∞—Ä—å .................. 450 ‚ÇΩ
        // ‚îî‚îÄ –í–∏–Ω–æ –∫—Ä–∞—Å–Ω–æ–µ (–±–æ–∫–∞–ª) .......... 350 ‚ÇΩ
        //
        // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –∏—Ç–æ–≥: 2600 ‚ÇΩ
        // üéñÔ∏è Max Loyalty —É—Ä–æ–≤–µ–Ω—å (15%): -390 ‚ÇΩ  ‚Üê –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        //
        // –ò–¢–û–ì–û: 2210 ‚ÇΩ  ‚Üê —É–∂–µ —Å–æ —Å–∫–∏–¥–∫–æ–π
        //
        // [–ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É] ‚Üê –≤–µ–¥–µ—Ç –Ω–∞ —ç–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã
        // 
        // –≠–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã:
        // ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        // ‚îÇ –ö –û–ü–õ–ê–¢–ï: 2210,00 —Ä.        ‚îÇ ‚Üê —É–∂–µ —Å–æ —Å–∫–∏–¥–∫–æ–π!
        // ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
        // ‚îÇ üíµ –ù–ê–õ–ò–ß–ù–´–ï                 ‚îÇ
        // ‚îÇ üí≥ –ë–ê–ù–ö–û–í–°–ö–ê–Ø –ö–ê–†–¢–ê         ‚îÇ
        // ‚îÇ üì± –°–ë–ü                      ‚îÇ
        // ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    }
    catch (Exception ex)
    {
        LoadingOverlay.Hide();
        ErrorHandler.Handle(ex, "ApplyDiscount");
    }
}
```


***

## **–ö–õ–Æ–ß–ï–í–ê–Ø –†–ê–ó–ù–ò–¶–ê**

| –ê—Å–ø–µ–∫—Ç | –û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ | –°–∫–∏–¥–∫–∞ —É—Ä–æ–≤–Ω—è |
| :-- | :-- | :-- |
| **–ß—Ç–æ —ç—Ç–æ** | Payment Type | Discount |
| **–ì–¥–µ –≤–∏–¥–Ω–æ** | –ù–∞ —ç–∫—Ä–∞–Ω–µ –û–ü–õ–ê–¢–´ | –í –ß–ï–ö–ï (–¥–æ –æ–ø–ª–∞—Ç—ã) |
| **–ò–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å** | ‚úÖ –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –≤—Ä—É—á–Ω—É—é | ‚ùå –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è |
| **–ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è** | –ü—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã | –î–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–ø–ª–∞—Ç–µ |
| **iiko SDK –º–µ—Ç–æ–¥** | `AddExternalPaymentItem()` | `AddDiscount()` |
| **–í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å—É–º–º—É** | –ß–∞—Å—Ç–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ | –£–º–µ–Ω—å—à–∞–µ—Ç –∏—Ç–æ–≥ —á–µ–∫–∞ |


***

## **–§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø**

```csharp
private async void OnAfterOrderClose(IOrder order, IEnumerable<IPaymentItem> payments)
{
    try
    {
        var context = contextStorage.GetContext(order.Id.ToString());
        if (context == null) return;
        
        logger.LogInformation(
            "Order closed, finalizing: OrderId={OrderId}, Action={Action}",
            order.Id,
            context.Action
        );
        
        // –î–ª—è —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ payment –ø—Ä–æ—à–µ–ª
        if (context.Action == LoyaltyAction.SpendAndEarn)
        {
            var pointsPayment = payments.FirstOrDefault(p => 
                p.PaymentType.Id == configService.GetPointsPaymentTypeId() &&
                p.IsProcessed == true
            );
            
            if (pointsPayment == null)
            {
                logger.LogWarning("Points payment not found or not processed, cancelling reservation");
                
                await apiClient.CancelReservationAsync(new CancelReservationRequest
                {
                    ReservationId = context.ReservationId,
                    Reason = "PAYMENT_NOT_PROCESSED"
                });
                
                contextStorage.RemoveContext(order.Id.ToString());
                return;
            }
            
            // ‚ö†Ô∏è –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –§–ê–ö–¢–ò–ß–ï–°–ö–£–Æ —Å—É–º–º—É –∏–∑ payment
            // –ö–∞—Å—Å–∏—Ä –º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã!
            var actualPointsSpent = pointsPayment.Sum;
            
            logger.LogInformation(
                "Finalizing with actual payment sum: Expected={Expected}, Actual={Actual}",
                context.PointsToSpend,
                actualPointsSpent
            );
            
            await apiClient.FinalizeSpendAndEarnAsync(new FinalizeSpendAndEarnRequest
            {
                GuestCardId = context.GuestCardId,
                OrderId = context.OrderId,
                ReservationId = context.ReservationId,
                CheckAmount = order.GetSum(),
                PointsSpent = actualPointsSpent, // ‚Üê –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å—É–º–º–∞!
                PointsToEarn = context.PointsToEarn
            });
        }
        else if (context.Action == LoyaltyAction.DiscountAndEarn)
        {
            // –î–ª—è —Å–∫–∏–¥–∫–∏ - –ø—Ä–æ—Å—Ç–æ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
            await apiClient.FinalizeDiscountAndEarnAsync(new FinalizeDiscountAndEarnRequest
            {
                GuestCardId = context.GuestCardId,
                OrderId = context.OrderId,
                CheckAmount = context.OriginalCheckAmount, // –ò—Å—Ö–æ–¥–Ω–∞—è —Å—É–º–º–∞
                DiscountAmount = context.DiscountAmount,
                PointsToEarn = context.PointsToEarn
            });
        }
        
        contextStorage.RemoveContext(order.Id.ToString());
        
        logger.LogInformation("Order finalized successfully: {OrderId}", order.Id);
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Failed to finalize order: {OrderId}", order.Id);
    }
}
```


***

**‚úÖ –¢–ï–ü–ï–†–¨ –ü–†–ê–í–ò–õ–¨–ù–û!**

1. **–û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏** = Payment –º–µ—Ç–æ–¥ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å)
2. **–°–∫–∏–¥–∫–∞** = Discount –≤ —á–µ–∫–µ –î–û –æ–ø–ª–∞—Ç—ã (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
3. –ü–ª–∞–≥–∏–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É–º–º—ã –∫–∞—Å—Å–∏—Ä–æ–º
4. –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ (offline, –æ—à–∏–±–∫–∏, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)?
<span style="display:none">[^39_1][^39_2]</span>

<div align="center">‚ÅÇ</div>

[^39_1]: IMG_20260217_125232.jpg

[^39_2]: IMG_20260217_125224.jpg


---

# –≠—Ç–æ Discount –≤ —á–µ–∫–µ (–ù–ï –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã) - –Ω–µ—Ç. –≠—Ç–æ –¥–∏—Å–∫–æ–Ω—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã, —Ç–∞–∫–∂–µ –∫–∞–∫ –∏ –ø—ç–π–º–µ–Ω—Ç, —Ç–æ–ª—å–∫–æ –µ–≥–æ –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å, —Ç–æ–ª—å–∫–æ —É–¥–∞–ª—è—Ç—å. –ú—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —ç—Ç–æ –æ–±–æ–∑–Ω–∞—á–∏–ª–∏ –≤ –¥–∏–∞–ª–æ–≥–µ, –¥–æ –º–æ–º–µ–Ω—Ç–∞ –∑–∞–¥–∞–≤–∞–Ω–∏—è —ç—Ç–∏—Ö 50+ –≤–æ–ø—Ä–æ—Å–æ–≤, –∏–∑—É—á–∏

–ü—Ä–æ—à—É –ø—Ä–æ—â–µ–Ω–∏—è! –¢—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤. –î–∞–≤–∞–π —è –∏—Å–ø—Ä–∞–≤–ª—é - –∏ discount, –∏ payment –º–µ—Ç–æ–¥ - —ç—Ç–æ **–æ–±–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã**, —Ç–æ–ª—å–∫–æ:

- **Payment (–±–∞–ª–ª—ã)** - –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É –≤—Ä—É—á–Ω—É—é
- **Discount (—Å–∫–∏–¥–∫–∞ —É—Ä–æ–≤–Ω—è)** - –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å, —Ç–æ–ª—å–∫–æ —É–¥–∞–ª–∏—Ç—å

–í–æ—Ç –∫–∞–∫ —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –≤–∞—à–∏–º —Ñ–æ—Ç–æ:

***

## **‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û–ï –ü–û–ù–ò–ú–ê–ù–ò–ï**

–ù–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã –≤ iiko –µ—Å—Ç—å **–¥–≤–∞ —Ä–∞–∑–¥–µ–ª–∞**:

### **1. –ö –û–ü–õ–ê–¢–ï (–≤–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å)**

–ó–¥–µ—Å—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è:

- –û—Å–Ω–æ–≤–Ω–∞—è —Å—É–º–º–∞
- –°–∫–∏–¥–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) - –ù–ï–õ–¨–ó–Ø –ò–ó–ú–ï–ù–ò–¢–¨, —Ç–æ–ª—å–∫–æ —É–¥–∞–ª–∏—Ç—å ‚ùå
- –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ


### **2. –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã (–Ω–∏–∂–Ω—è—è —á–∞—Å—Ç—å)**

–ó–¥–µ—Å—å —Å–ø–∏—Å–æ–∫ –º–µ—Ç–æ–¥–æ–≤ –æ–ø–ª–∞—Ç—ã:

- üíµ –ù–ê–õ–ò–ß–ù–´–ï
- üí≥ –ë–ê–ù–ö–û–í–°–ö–ê–Ø –ö–ê–†–¢–ê
- üéÅ PREMIUMBONUS PAYMENT (–±–∞–ª–ª—ã Max Loyalty) - –ú–û–ñ–ù–û –ò–ó–ú–ï–ù–ò–¢–¨ ‚úÖ
- üì± –°–ë–ü
- etc.

***

## **–ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢ –í –ü–õ–ê–ì–ò–ù–ï**

```csharp
// –°–¶–ï–ù–ê–†–ò–ô 1: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –°–ö–ò–î–ö–ò –ø–æ —É—Ä–æ–≤–Ω—é
private async void OnApplyDiscountClick(object sender, RoutedEventArgs e)
{
    try
    {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø —Å–∫–∏–¥–∫–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        var discountTypeId = configService.GetDiscountTypeId();
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É —á–µ—Ä–µ–∑ iiko API
        // ‚ö†Ô∏è –°–∫–∏–¥–∫–∞ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –í–ï–†–•–ù–Æ–Æ –ß–ê–°–¢–¨ —ç–∫—Ä–∞–Ω–∞ –æ–ø–ª–∞—Ç—ã
        // "–ö –û–ü–õ–ê–¢–ï: 2600 ‚ÇΩ" ‚Üí –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É ‚Üí "–ö –û–ü–õ–ê–¢–ï: 2210 ‚ÇΩ"
        
        pluginContext.Operations.AddDiscount(
            order: currentOrder,
            discountTypeId: discountTypeId,
            discountSum: currentCalculation.DiscountAmount // 390 ‚ÇΩ
        );
        
        // –°–∫–∏–¥–∫–∞ —Ç–µ–ø–µ—Ä—å –≤–∏–¥–Ω–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã:
        // ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        // ‚îÇ –ö –û–ü–õ–ê–¢–ï: 2600,00 —Ä.        ‚îÇ
        // ‚îÇ Max Loyalty (15%): -390 —Ä.  ‚îÇ ‚Üê –ù–ï–õ–¨–ó–Ø –∏–∑–º–µ–Ω–∏—Ç—å, —Ç–æ–ª—å–∫–æ —É–¥–∞–ª–∏—Ç—å
        // ‚îÇ –ò–¢–û–ì–û: 2210,00 —Ä.           ‚îÇ
        // ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        contextStorage.SaveContext(new LoyaltyContext
        {
            OrderId = currentOrder.Id.ToString(),
            GuestCardId = currentGuest.CardId,
            BenefitType = BenefitType.Discount,
            DiscountAmount = currentCalculation.DiscountAmount,
            PointsToEarn = currentCalculation.PointsToEarn
        });
        
        Close();
    }
    catch (Exception ex)
    {
        ErrorHandler.Handle(ex, "ApplyDiscount");
    }
}
```

```csharp
// –°–¶–ï–ù–ê–†–ò–ô 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –û–ü–õ–ê–¢–´ –ë–ê–õ–õ–ê–ú–ò
private async void OnApplyPointsClick(object sender, RoutedEventArgs e)
{
    try
    {
        // 1. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –±–∞–ª–ª—ã –Ω–∞ backend
        var reservation = await apiClient.ReservePointsAsync(new ReservePointsRequest
        {
            GuestCardId = currentGuest.CardId,
            PointsToSpend = pointsToSpend // 500
        });
        
        // 2. –î–æ–±–∞–≤–ª—è–µ–º Payment Type —á–µ—Ä–µ–∑ iiko API
        // ‚ö†Ô∏è Payment –º–µ—Ç–æ–¥ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ù–ò–ñ–ù–Æ–Æ –ß–ê–°–¢–¨ (—Å–ø–∏—Å–æ–∫ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã)
        
        var paymentTypeId = configService.GetPointsPaymentTypeId();
        
        pluginContext.Operations.AddExternalPaymentItem(
            order: currentOrder,
            paymentTypeId: paymentTypeId,
            sum: pointsToSpend, // 500 ‚ÇΩ (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã!)
            isProcessed: false // –ö–∞—Å—Å–∏—Ä –ø—Ä–æ–≤–µ–¥–µ—Ç —Å–∞–º
        );
        
        // Payment –º–µ—Ç–æ–¥ —Ç–µ–ø–µ—Ä—å –≤–∏–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã:
        // ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        // ‚îÇ –ö –û–ü–õ–ê–¢–ï: 900,00 —Ä.         ‚îÇ
        // ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
        // ‚îÇ üíµ –ù–ê–õ–ò–ß–ù–´–ï: 0,00 —Ä.        ‚îÇ
        // ‚îÇ üí≥ –ë–ê–ù–ö–û–í–°–ö–ê–Ø –ö–ê–†–¢–ê: 0,00—Ä. ‚îÇ
        // ‚îÇ üéÅ PREMIUMBONUS: 500,00 —Ä.  ‚îÇ ‚Üê –ú–û–ñ–ù–û –∏–∑–º–µ–Ω–∏—Ç—å!
        // ‚îÇ üì± –°–ë–ü: 0,00 —Ä.             ‚îÇ
        // ‚îÇ                             ‚îÇ
        // ‚îÇ –û—Å—Ç–∞—Ç–æ–∫: 400,00 —Ä.          ‚îÇ
        // ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        contextStorage.SaveContext(new LoyaltyContext
        {
            OrderId = currentOrder.Id.ToString(),
            GuestCardId = currentGuest.CardId,
            BenefitType = BenefitType.Points,
            PointsToSpend = pointsToSpend, // –ò—Å—Ö–æ–¥–Ω–∞—è —Å—É–º–º–∞
            ReservationId = reservation.ReservationId,
            PointsToEarn = currentCalculation.PointsToEarn
        });
        
        Close();
    }
    catch (Exception ex)
    {
        ErrorHandler.Handle(ex, "ApplyPoints");
    }
}
```


***

## **–§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø –° –£–ß–ï–¢–û–ú –ò–ó–ú–ï–ù–ï–ù–ò–ô –ö–ê–°–°–ò–†–û–ú**

```csharp
private async void OnAfterOrderClose(IOrder order, IEnumerable<IPaymentItem> payments)
{
    try
    {
        var context = contextStorage.GetContext(order.Id.ToString());
        if (context == null) return;
        
        // –î–ª—è –æ–ø–ª–∞—Ç—ã –±–∞–ª–ª–∞–º–∏ - –±–µ—Ä–µ–º –§–ê–ö–¢–ò–ß–ï–°–ö–£–Æ —Å—É–º–º—É
        if (context.BenefitType == BenefitType.Points)
        {
            var pointsPayment = payments.FirstOrDefault(p => 
                p.PaymentType.Id == configService.GetPointsPaymentTypeId() &&
                p.IsProcessed == true
            );
            
            if (pointsPayment == null)
            {
                // Payment –Ω–µ –ø—Ä–æ—à–µ–ª - –æ—Ç–º–µ–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é
                await apiClient.CancelReservationAsync(new CancelReservationRequest
                {
                    ReservationId = context.ReservationId
                });
                return;
            }
            
            // ‚ö†Ô∏è –í–ê–ñ–ù–û! –ö–∞—Å—Å–∏—Ä –º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã!
            // –ë—ã–ª–æ 500 ‚ÇΩ, —Å—Ç–∞–ª–æ 300 ‚ÇΩ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é
            var actualPointsSpent = pointsPayment.Sum;
            
            await apiClient.FinalizeSpendAndEarnAsync(new FinalizeRequest
            {
                GuestCardId = context.GuestCardId,
                OrderId = order.Id.ToString(),
                ReservationId = context.ReservationId,
                PointsSpent = actualPointsSpent, // –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å—É–º–º–∞!
                PointsToEarn = context.PointsToEarn
            });
        }
        
        // –î–ª—è —Å–∫–∏–¥–∫–∏ - —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
        else if (context.BenefitType == BenefitType.Discount)
        {
            // –°–∫–∏–¥–∫—É –∫–∞—Å—Å–∏—Ä –ù–ï –ú–û–ñ–ï–¢ –∏–∑–º–µ–Ω–∏—Ç—å - —Ç–æ–ª—å–∫–æ —É–¥–∞–ª–∏—Ç—å
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∫–∏–¥–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
            var discount = order.GetDiscounts().FirstOrDefault(d =>
                d.DiscountType.Id == configService.GetDiscountTypeId()
            );
            
            if (discount == null)
            {
                logger.LogWarning("Discount was removed, skipping loyalty");
                return;
            }
            
            await apiClient.FinalizeDiscountAndEarnAsync(new FinalizeRequest
            {
                GuestCardId = context.GuestCardId,
                OrderId = order.Id.ToString(),
                DiscountAmount = context.DiscountAmount, // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è
                PointsToEarn = context.PointsToEarn
            });
        }
        
        contextStorage.RemoveContext(order.Id.ToString());
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Failed to finalize order");
    }
}
```


***

## **–ö–õ–Æ–ß–ï–í–ê–Ø –†–ê–ó–ù–ò–¶–ê (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø)**

| –ê—Å–ø–µ–∫—Ç | –û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ | –°–∫–∏–¥–∫–∞ —É—Ä–æ–≤–Ω—è |
| :-- | :-- | :-- |
| **–ß—Ç–æ —ç—Ç–æ –≤ iiko** | Payment Type | Discount Type |
| **–ì–¥–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã** | –í —Å–ø–∏—Å–∫–µ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã (–Ω–∏–∑) | –í –±–ª–æ–∫–µ "–ö –æ–ø–ª–∞—Ç–µ" (–≤–µ—Ä—Ö) |
| **–ò–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å** | ‚úÖ –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Å—É–º–º—É | ‚ùå –ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å, —Ç–æ–ª—å–∫–æ —É–¥–∞–ª–∏—Ç—å |
| **–ö–æ–≥–¥–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è** | –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–ª–∞–≥–∏–Ω–æ–º | –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–ª–∞–≥–∏–Ω–æ–º |
| **iiko SDK –º–µ—Ç–æ–¥** | `AddExternalPaymentItem()` | `AddDiscount()` |
| **–ß—Ç–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –∫–∞—Å—Å–∏—Ä** | –°—É–º–º—É –æ–ø–ª–∞—Ç—ã –±–∞–ª–ª–∞–º–∏ | –¢–æ–ª—å–∫–æ —É–¥–∞–ª–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ |


***

**‚úÖ –¢–ï–ü–ï–†–¨ –ü–†–ê–í–ò–õ–¨–ù–û!**

–°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ! –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ (offline, crash recovery, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)?
<span style="display:none">[^40_1][^40_2][^40_3][^40_4][^40_5][^40_6]</span>

<div align="center">‚ÅÇ</div>

[^40_1]: Beseda-2.md

[^40_2]: Beseda-10.md

[^40_3]: Beseda-13.md

[^40_4]: Beseda-12.md

[^40_5]: Beseda-6.md

[^40_6]: Beseda-3.md


---

# ‚úÖ –ú–û–Å –ü–û–ù–ò–ú–ê–ù–ò–ï (–ø—Ä–æ–≤–µ—Ä–∫–∞)

## **–≠–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã –≤ iiko —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –¥–≤—É—Ö —á–∞—Å—Ç–µ–π:**

### **–í–ï–†–•–ù–Ø–Ø –ß–ê–°–¢–¨: "–ö –û–ü–õ–ê–¢–ï"**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è —Å—É–º–º–∞: 2600 ‚ÇΩ     ‚îÇ
‚îÇ üéñÔ∏è Max Loyalty —Å–∫–∏–¥–∫–∞ (15%): -390‚îÇ ‚Üê –°–ö–ò–î–ö–ê –∑–¥–µ—Å—å
‚îÇ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ‚îÇ
‚îÇ –ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï: 2210 ‚ÇΩ          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–°–∫–∏–¥–∫–∞:**

- –£–º–µ–Ω—å—à–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
- –í–∏–¥–Ω–∞ –£–ñ–ï –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã
- –ö–∞—Å—Å–∏—Ä –ù–ï–õ–¨–ó–Ø –∏–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É —Å–∫–∏–¥–∫–∏
- –ö–∞—Å—Å–∏—Ä –ú–û–ñ–ï–¢ —Ç–æ–ª—å–∫–æ —É–¥–∞–ª–∏—Ç—å –µ—ë (–∫—Ä–µ—Å—Ç–∏–∫ ‚úï)
- –ï—Å–ª–∏ —É–¥–∞–ª–∏—Ç - —Å—É–º–º–∞ –≤–µ—Ä–Ω—ë—Ç—Å—è –∫ 2600 ‚ÇΩ

***

### **–ù–ò–ñ–ù–Ø–Ø –ß–ê–°–¢–¨: "–°–ü–û–°–û–ë–´ –û–ü–õ–ê–¢–´"**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üíµ –ù–ê–õ–ò–ß–ù–´–ï:          0,00 ‚ÇΩ    ‚îÇ
‚îÇ üí≥ –ë–ê–ù–ö–û–í–°–ö–ê–Ø –ö–ê–†–¢–ê:  0,00 ‚ÇΩ    ‚îÇ
‚îÇ üéÅ PREMIUMBONUS:    500,00 ‚ÇΩ    ‚îÇ ‚Üê –û–ü–õ–ê–¢–ê –ë–ê–õ–õ–ê–ú–ò –∑–¥–µ—Å—å
‚îÇ üì± –°–ë–ü:               0,00 ‚ÇΩ    ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ –û–ø–ª–∞—á–µ–Ω–æ:   500,00 ‚ÇΩ            ‚îÇ
‚îÇ –û—Å—Ç–∞—Ç–æ–∫:   1710,00 ‚ÇΩ            ‚îÇ ‚Üê (2210 - 500)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏:**

- –≠—Ç–æ –æ–¥–∏–Ω –∏–∑ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã (–∫–∞–∫ –Ω–∞–ª–∏—á–Ω—ã–µ –∏–ª–∏ –∫–∞—Ä—Ç–∞)
- –ö–∞—Å—Å–∏—Ä –ú–û–ñ–ï–¢ –∏–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É:
    - –ü–ª–∞–≥–∏–Ω –¥–æ–±–∞–≤–∏–ª 500 ‚ÇΩ
    - –ö–∞—Å—Å–∏—Ä –º–æ–∂–µ—Ç –Ω–∞–∂–∞—Ç—å –Ω–∞ —ç—Ç–æ –ø–æ–ª–µ –∏ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ 300 ‚ÇΩ –∏–ª–∏ 700 ‚ÇΩ
    - –û—Å—Ç–∞—Ç–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è
- –ö–∞—Å—Å–∏—Ä –ú–û–ñ–ï–¢ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã —Å–æ–≤—Å–µ–º
- –û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –¥—Ä—É–≥–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏ (–Ω–∞–ª–∏—á–Ω—ã–µ/–∫–∞—Ä—Ç–∞)

***

## **–ß–¢–û –î–ï–õ–ê–ï–¢ –ü–õ–ê–ì–ò–ù:**

### **–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ì–æ—Å—Ç—å —Ö–æ—á–µ—Ç —Å–∫–∏–¥–∫—É –ø–æ —É—Ä–æ–≤–Ω—é**

1. –ö–∞—Å—Å–∏—Ä —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑: 2600 ‚ÇΩ
2. –ö–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "Max Loyalty" (–∏–ª–∏ F9)
3. –ù–∞—Ö–æ–¥–∏—Ç –≥–æ—Å—Ç—è (–ü–ª–∞—Ç–∏–Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å, 15% —Å–∫–∏–¥–∫–∞)
4. –í—ã–±–∏—Ä–∞–µ—Ç "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É —É—Ä–æ–≤–Ω—è"
5. **–ü–ª–∞–≥–∏–Ω –≤—ã–∑—ã–≤–∞–µ—Ç:** `pluginContext.Operations.AddDiscount(discountTypeId, 390 ‚ÇΩ)`
6. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∫–∏–¥–∫–∞ -390 ‚ÇΩ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –í–ï–†–•–ù–ï–ô —á–∞—Å—Ç–∏ —ç–∫—Ä–∞–Ω–∞ –æ–ø–ª–∞—Ç—ã
7. –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: 2210 ‚ÇΩ
8. –ö–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É" ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ —ç–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã
9. **–ö–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç:** "–ö –û–ü–õ–ê–¢–ï: 2210 ‚ÇΩ" (—Å–∫–∏–¥–∫–∞ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞)
10. –ö–∞—Å—Å–∏—Ä –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–∫–∞—Ä—Ç–∞/–Ω–∞–ª–∏—á–Ω—ã–µ) –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —á–µ–∫

***

### **–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ì–æ—Å—Ç—å —Ö–æ—á–µ—Ç —Å–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã**

1. –ö–∞—Å—Å–∏—Ä —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑: 900 ‚ÇΩ
2. –ù–∞—Ö–æ–¥–∏—Ç –≥–æ—Å—Ç—è (–±–∞–ª–∞–Ω—Å: 1200 –±–∞–ª–ª–æ–≤)
3. –í—ã–±–∏—Ä–∞–µ—Ç "–°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã"
4. –ì–æ—Å—Ç—å –≥–æ–≤–æ—Ä–∏—Ç: "–•–æ—á—É —Å–ø–∏—Å–∞—Ç—å 500 –±–∞–ª–ª–æ–≤"
5. **–ü–ª–∞–≥–∏–Ω:**
    - –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç 500 –±–∞–ª–ª–æ–≤ –Ω–∞ backend
    - –í—ã–∑—ã–≤–∞–µ—Ç: `pluginContext.Operations.AddExternalPaymentItem(paymentTypeId, 500 ‚ÇΩ)`
6. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** Payment –º–µ—Ç–æ–¥ "PREMIUMBONUS 500‚ÇΩ" –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –ù–ò–ñ–ù–ï–ô —á–∞—Å—Ç–∏ (—Å–ø–∏—Å–æ–∫ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã)
7. –ö–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É" ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ —ç–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã
8. **–ö–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç:**

```
–ö –û–ü–õ–ê–¢–ï: 900 ‚ÇΩ

üéÅ PREMIUMBONUS PAYMENT: 500 ‚ÇΩ  ‚Üê –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å!
–û—Å—Ç–∞—Ç–æ–∫: 400 ‚ÇΩ
```

9. –ö–∞—Å—Å–∏—Ä –ú–û–ñ–ï–¢:
    - –û—Å—Ç–∞–≤–∏—Ç—å 500 ‚ÇΩ ‚Üí –æ—Å—Ç–∞—Ç–æ–∫ 400 ‚ÇΩ –¥–æ–ø–ª–∞—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ–π
    - –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞ 300 ‚ÇΩ ‚Üí –æ—Å—Ç–∞—Ç–æ–∫ 600 ‚ÇΩ –¥–æ–ø–ª–∞—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ–π
    - –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞ 900 ‚ÇΩ ‚Üí –æ—Å—Ç–∞—Ç–æ–∫ 0 ‚ÇΩ (–æ–ø–ª–∞—á–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é)
    - –£–¥–∞–ª–∏—Ç—å —Å–æ–≤—Å–µ–º ‚Üí –æ–ø–ª–∞—Ç–∏—Ç—å 900 ‚ÇΩ –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º
10. –ö–∞—Å—Å–∏—Ä –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —á–µ–∫
11. **–ü–ª–∞–≥–∏–Ω –≤ —Å–æ–±—ã—Ç–∏–∏ AfterOrderClose:**
    - –°–º–æ—Ç—Ä–∏—Ç –§–ê–ö–¢–ò–ß–ï–°–ö–£–Æ —Å—É–º–º—É payment item
    - –ï—Å–ª–∏ –∫–∞—Å—Å–∏—Ä –∏–∑–º–µ–Ω–∏–ª —Å 500 ‚ÇΩ –Ω–∞ 300 ‚ÇΩ ‚Üí —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç 300 –±–∞–ª–ª–æ–≤
    - –ù–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–ª—ã –∑–∞ –ø–æ–∫—É–ø–∫—É

***

## **–°–¶–ï–ù–ê–†–ò–ô 3: –ò —Å–∫–∏–¥–∫–∞, –ò –±–∞–ª–ª—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**

1. –ó–∞–∫–∞–∑: 2600 ‚ÇΩ
2. –ì–æ—Å—Ç—å: –ü–ª–∞—Ç–∏–Ω–æ–≤—ã–π (15% —Å–∫–∏–¥–∫–∞) + 1200 –±–∞–ª–ª–æ–≤
3. –ü–ª–∞–≥–∏–Ω –ø—Ä–∏–º–µ–Ω—è–µ—Ç:
    - **–°–∫–∏–¥–∫—É:** `AddDiscount(390 ‚ÇΩ)` ‚Üí —Å—É–º–º–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è 2210 ‚ÇΩ
    - **–û–ø–ª–∞—Ç—É –±–∞–ª–ª–∞–º–∏:** `AddExternalPaymentItem(500 ‚ÇΩ)`
4. **–ù–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã –∫–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°—É–º–º–∞: 2600 ‚ÇΩ                   ‚îÇ
‚îÇ Max Loyalty (15%): -390 ‚ÇΩ       ‚îÇ ‚Üê –°–ö–ò–î–ö–ê (–Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å)
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ –ò–¢–û–ì–û: 2210 ‚ÇΩ                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üéÅ PREMIUMBONUS: 500 ‚ÇΩ          ‚îÇ ‚Üê –û–ü–õ–ê–¢–ê (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å!)
‚îÇ üí≥ –ö–ê–†–¢–ê: 1710 ‚ÇΩ                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## **–ö–õ–Æ–ß–ï–í–û–ï –û–¢–õ–ò–ß–ò–ï:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –°–∫–∏–¥–∫–∞ | –û–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏ |
| :-- | :-- | :-- |
| **–ì–¥–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ** | –í–µ—Ä—Ö (–±–ª–æ–∫ "–ö –æ–ø–ª–∞—Ç–µ") | –ù–∏–∑ (—Å–ø–∏—Å–æ–∫ —Å–ø–æ—Å–æ–±–æ–≤) |
| **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç** | –£–º–µ–Ω—å—à–∞–µ—Ç –∏—Ç–æ–≥ | –ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç |
| **–ò–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É** | ‚ùå –ù–ï–õ–¨–ó–Ø | ‚úÖ –ú–û–ñ–ù–û |
| **–£–¥–∞–ª–∏—Ç—å** | ‚úÖ –ú–æ–∂–Ω–æ (–∫—Ä–µ—Å—Ç–∏–∫) | ‚úÖ –ú–æ–∂–Ω–æ |
| **iiko API** | `AddDiscount()` | `AddExternalPaymentItem()` |
| **–¢–∏–ø –≤ iiko** | Discount Type | Payment Type |


***

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —è –ø–æ–Ω—è–ª?** –ï—Å–ª–∏ –¥–∞ - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–ª—å—à–µ —Å offline —Ä–µ–∂–∏–º–æ–º, crash recovery –∏ –ø–æ–ª–Ω—ã–º –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º! üéØ

