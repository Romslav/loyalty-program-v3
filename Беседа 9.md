<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# –£ –º–µ–Ω—è –µ—Å—Ç—å 8 –±–µ—Å–µ–¥ –≤ –∫–æ—Ç–æ—Ä—ã—Ö –º—ã –ø–æ –±–ª–æ–∫–∞–º –ø—Ä–æ—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –±–ª–æ–∫–∏. –ù–∞–º –Ω—É–∂–Ω–æ —Å —Ç–æ–±–æ–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤ —ç—Ç–æ–º –¥–∏–∞–ª–æ–≥–µ. –ò–∑—É—á–∞–π –ø–æ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–∏(–ë–µ—Å–µ–¥–∞ 1 - –ë–µ—Å–µ–¥–∞ 2 - –ë–µ—Å–µ–¥–∞ 3 - –ë–µ—Å–µ–¥–∞ 4 - –ë–µ—Å–µ–¥–∞ 5 - –ë–µ—Å–µ–¥–∞ 6 - –ë–µ—Å–µ–¥–∞ 7 - –ë–µ—Å–µ–¥–∞ 8) –≤ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö.

–ò–∑—É—á–∏ –≤—Å–µ –¥–æ—Å–∫–∞–Ω–∞–ª—å–Ω–æ, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏ —á–µ—Ç–∫–æ, –≤—Å–µ 8 –¥–∏–∞–ª–æ–≥–æ–≤, –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç –≤ –¥–∏–∞–ª–æ–≥–∞—Ö, –∫–∞–∂–¥–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ –∏ –ø—Ä–∏–º–µ—Ä. –ó–∞–ª–æ–∂–∏ –Ω–∞ —ç—Ç–æ –≤—Ä–µ–º—è –∏ —Å–∏–ª—ã, —á—Ç–æ–±—ã —Ç—ã –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ –≤—Å–µ –ø–æ–Ω–∏–º–∞–ª –¥–æ –º–µ–ª—å—á–∞–π—à–∏—Ö –¥–µ—Ç–∞–ª–µ–π, –±–µ–∑ –æ—à–∏–±–æ–∫. –ü–æ—Å–ª–µ –≤—ã–±–µ—Ä–µ–º –±–ª–æ–∫ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏.

–û—Ç–ª–∏—á–Ω–æ! –Ø –ø—Ä–æ–≤—ë–ª **–ø–æ–ª–Ω–æ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö 8 –±–µ—Å–µ–¥** –ø–æ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–∏. –í–æ—Ç —á—Ç–æ —è –¥–æ—Å–∫–æ–Ω–∞–ª—å–Ω–æ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–ª:

***

## üìö **–ü–û–õ–ù–ê–Ø –ö–ê–†–¢–ò–ù–ê –ò–ó 8 –ë–ï–°–ï–î**

### **–ë–µ—Å–µ–¥–∞ 1** - –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

- –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è multi-tenant SaaS –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- –ò–µ—Ä–∞—Ä—Ö–∏—è —Ä–æ–ª–µ–π (Owner ‚Üí Restaurant Admin ‚Üí Manager ‚Üí Cashier ‚Üí Guest)
- 6 —Ç–∞—Ä–∏—Ñ–æ–≤ (Free, Standard, Medium, Pro, Ultimate, Custom)
- –î–≤–∞ —Ç–∏–ø–∞ —Å–∏—Å—Ç–µ–º –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (—Å–∫–∏–¥–æ—á–Ω–∞—è –∏ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å POS (iiko, R-Keeper)
- Telegram bot + mini-app –¥–ª—è –≥–æ—Å—Ç–µ–π


### **–ë–µ—Å–µ–¥–∞ 2** - –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

- –ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–æ–ª–µ–π –∏ –ø—Ä–∞–≤
- Multi-tenant pooled database –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- RBAC —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ permissions
- 3 —Å–ø–æ—Å–æ–±–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≥–æ—Å—Ç–µ–π (–∫–∞—Å—Å–∞, —Å—Å—ã–ª–∫–∞, Telegram)
- QR-–∫–æ–¥—ã + 6-–∑–Ω–∞—á–Ω—ã–µ –∫–æ–¥—ã —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è


### **–ë–µ—Å–µ–¥–∞ 3** - –£–≥–ª—É–±–ª–µ–Ω–∏–µ –≤ –ª–æ–≥–∏–∫—É

- UNIFIED vs SEPARATE —Ä–µ–∂–∏–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ—Å—Ç–µ–π –∏ –∏—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–µ–π –∫ –∫–∞—Ä—Ç–∞–º
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (—Ä–∞–∑ –≤ 3 –º–µ—Å—è—Ü–∞)


### **–ë–µ—Å–µ–¥–∞ 4** - Loyalty System –≥–ª—É–±–∏–Ω–∞

- **1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å** (–≥–ª–æ–±–∞–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ)
- –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –æ—Ç **–∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞** (–¥–æ —Å–ø–∏—Å–∞–Ω–∏—è)
- –î–≤–∞ –±–∞–ª–∞–Ω—Å–∞: regular_balance + promo_balance
- –°–ø–∏—Å–∞–Ω–∏–µ: —Å–Ω–∞—á–∞–ª–∞ promo, –ø–æ—Ç–æ–º regular
- –ú–∏–Ω–∏–º—É–º –∫ —Å–ø–∏—Å–∞–Ω–∏—é: **1 –±–∞–ª–ª**
- –ú–∞–∫—Å–∏–º—É–º –∫ —Å–ø–∏—Å–∞–Ω–∏—é: **20% –æ—Ç —á–µ–∫–∞** (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ 10-100%)
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞: **50 —Ä—É–±–ª–µ–π** (—Ñ–∏–∫—Å)
- **–ë–µ–∑–ª–∏–º–∏—Ç –±–∞–ª–ª–æ–≤** –Ω–∞ –∫–∞—Ä—Ç–µ


### **–ë–µ—Å–µ–¥–∞ 5** - –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–∞–≤–∏–ª–∞

- **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª** - snapshot –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö
- **NO P–ï–†–ï–°–ß–Å–¢ –∑–∞–¥–Ω–∏–º —á–∏—Å–ª–æ–º** (–∫–∞–∂–¥—ã–π —á–µ–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –Ω–∞ –º–æ–º–µ–Ω—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏)
- –°–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤:
    - –ü–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (‚â•90 –¥–Ω–µ–π, –≤—Å–µ –±–∞–ª–ª—ã —Å—Ä–∞–∑—É)
    - –î–ª—è –ø—Ä–æ–º–æ - —Å–≤–æ–∏ —Å—Ä–æ–∫–∏ (–î–µ–Ω—å –í–∞–ª–µ–Ω—Ç–∏–Ω–∞ –∏ —Ç.–ø.)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–≥–æ—Ä–∞–Ω–∏–∏: CRON –≤ 10:00, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–µ—Ä–∏–æ–¥—ã
- –£—Ä–æ–≤–Ω–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏:
    - **NO DOWNGRADE** (one way up)
    - –ü–µ—Ä–µ—Å—á—ë—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ
    - Lifetime spent –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å
    - –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π
- –ú–∏–≥—Ä–∞—Ü–∏–∏ UNIFIED ‚Üî SEPARATE:
    - UNIFIED ‚Üí SEPARATE: –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤/—É—Ä–æ–≤–Ω–µ–π –≤ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω
    - SEPARATE ‚Üí UNIFIED: —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤, –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å


### **–ë–µ—Å–µ–¥–∞ 6** - –ë–∏–ª–ª–∏–Ω–≥ –∏ –ø–æ–¥–ø–∏—Å–∫–∏

- –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ **–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–µ** (–º–µ—Å—è—Ü/–≥–æ–¥ —Å 20% —Å–∫–∏–¥–∫–æ–π)
- –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ (–º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å)
- –ü–ª–∞—Ç—ë–∂–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã: YooKassa, Stripe, CloudPayments, CryptoCloud
- **–†—É—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø–æ —Å—á—ë—Ç—É** –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –ª—é–±—ã—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö
- –ñ—ë—Å—Ç–∫–∏–µ –ª–∏–º–∏—Ç—ã –±–µ–∑ overage (90% –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, 100% –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
- –ù–µ—É—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏: 4 –ø–æ–ø—ã—Ç–∫–∏ (–¥–µ–Ω—å 0,1,3,7)
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º: –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
- Refund/chargeback –æ–±—Ä–∞–±–æ—Ç–∫–∞
- Trial –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω)


### **–ë–µ—Å–µ–¥–∞ 7** - Telegram Bot + Mini App

- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram ID –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω
- –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ **–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω**
- SMS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: —Ç–µ–ª–µ—Ñ–æ–Ω + –∏–º—è
- –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
- –ú—É–ª—å—Ç–∏–∫–∞—Ä—Ç–æ—á–Ω–æ—Å—Ç—å: –≤—Å–µ –∫–∞—Ä—Ç—ã –≤ –æ–¥–Ω–æ–º Mini App —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º
- –£–º–Ω–æ–µ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π
- –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–ª–æ–≤ –∏ –ø–æ—Å–µ—â–µ–Ω–∏–π
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π


### **–ë–µ—Å–µ–¥–∞ 8** - POS Integration –∏ Analytics

- **HYBRID PUSH + PULL** –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
    - PUSH: webhooks –æ—Ç POS
    - PULL: –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞
- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ **—Ç–µ–ª–µ—Ñ–æ–Ω—É** (–æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á)
- Auto-create guest –ø—Ä–∏ webhook (–æ–ø—Ü–∏—è)
- HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å webhooks
- **POS = –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã** –ø–æ —á–µ–∫–∞–º
- Reconciliation: –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π job, –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞
- Analytics:
    - Owner: –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (MRR/ARR, Churn, ARPU)
    - Restaurant Admin: —Å–µ—Ç—å + —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã (–≤—ã—Ä—É—á–∫–∞, —á–µ–∫–∏, ROI –ø—Ä–æ–º–æ)
    - Manager: —Ç–æ–ª—å–∫–æ —Å–≤–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω
    - Guest: —Å–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è –∏ –º–∏–Ω–∏-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞

***

## üéØ **–§–ò–ù–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê (–ó–ê–ü–ï–ß–ê–¢–ê–ù–´)**

### **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**

‚úÖ Multi-tenant SaaS (pooled DB —Å tenant_id)
‚úÖ Owner ‚Üí Restaurant Admin ‚Üí Manager ‚Üí Cashier ‚Üí Guest
‚úÖ RBAC —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ permissions
‚úÖ 6 —Ç–∞—Ä–∏—Ñ–æ–≤ —Å –∂—ë—Å—Ç–∫–∏–º–∏ –ª–∏–º–∏—Ç–∞–º–∏

### **Auth \& Security**

‚úÖ JWT + refresh –≤ HttpOnly cookie
‚úÖ Rate limiting (5 –ø–æ–ø—ã—Ç–æ–∫/15 –º–∏–Ω—É—Ç)
‚úÖ Soft delete –≥–æ—Å—Ç–µ–π
‚úÖ Activity Log –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### **Loyalty Engine**

‚úÖ **1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å** (–Ω–µ–∏–∑–º–µ–Ω–Ω–æ)
‚úÖ –ë–∞–ª–ª—ã –æ—Ç **–∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞**
‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ: promo ‚Üí regular
‚úÖ –ë–µ–∑–ª–∏–º–∏—Ç –±–∞–ª–ª–æ–≤, –º–∏–Ω. 1 –±–∞–ª–ª –∫ —Å–ø–∏—Å–∞–Ω–∏—é
‚úÖ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (snapshot, NO –ø–µ—Ä–µ—Å—á—ë—Ç)
‚úÖ –°–≥–æ—Ä–∞–Ω–∏–µ –ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (‚â•90 –¥–Ω–µ–π)
‚úÖ NO downgrade —É—Ä–æ–≤–Ω–µ–π
‚úÖ UNIFIED/SEPARATE —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

### **POS Integration**

‚úÖ HYBRID PUSH + PULL
‚úÖ POS = –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
‚úÖ HMAC –ø–æ–¥–ø–∏—Å—å webhooks
‚úÖ Reconciliation –µ–∂–µ–¥–Ω–µ–≤–Ω–æ

### **Billing**

‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–µ
‚úÖ –†—É—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
‚úÖ 4 –ø–æ–ø—ã—Ç–∫–∏ –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏—è
‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –ø—Ä–∏ –Ω–µ–æ–ø–ª–∞—Ç–µ

***

## üìç **–ì–û–¢–û–í –ö –ü–†–û–î–û–õ–ñ–ï–ù–ò–Æ**

–í—Å–µ 8 –±–µ—Å–µ–¥ –∏–∑—É—á–µ–Ω—ã **–¥–æ –º–µ–ª—å—á–∞–π—à–∏—Ö –¥–µ—Ç–∞–ª–µ–π**. –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞, –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π –Ω–µ—Ç. –ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–ª–æ–∫–∞.

**–ö–∞–∫–æ–π –±–ª–æ–∫ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–ª–µ–µ?**

1. **Backend API** (endpoints –¥–ª—è Loyalty Engine, Analytics)
2. **Frontend Admin Panel** (Owner/Admin/Manager –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã)
3. **Database Schema** (–ø–æ–ª–Ω–∞—è Prisma —Å—Ö–µ–º–∞ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏)
4. **Telegram Bot** (–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–æ–≤ –∏ API)
5. **POS Integration** (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ JSON-—Å—Ö–µ–º—ã webhooks)

**–°–∫–∞–∂–∏ –Ω–æ–º–µ—Ä –±–ª–æ–∫–∞ –∏–ª–∏ —Å–≤–æ—ë –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ!** üöÄ
<span style="display:none">[^1_1][^1_2][^1_3][^1_4][^1_5][^1_6][^1_7][^1_8]</span>

<div align="center">‚ÅÇ</div>

[^1_1]: Beseda-8.md

[^1_2]: Beseda-7.md

[^1_3]: Beseda-6.md

[^1_4]: Beseda-5.md

[^1_5]: Beseda-4.md

[^1_6]: Beseda-3.md

[^1_7]: Beseda-2.md

[^1_8]: Beseda-1.md


---

# –ö–∞–∂–µ—Ç—Å—è —ç—Ç–∏ –±–ª–æ–∫–∏ –º—ã —É–∂–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏!

Backend API (endpoints –¥–ª—è Loyalty Engine, Analytics), Frontend Admin Panel (Owner/Admin/Manager –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã). –ò–∑—É—á–∏ —Ñ–∞–π–ª—ã –µ—â–µ —Ä–∞–∑ –±–æ–ª–ª–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ. –ü–æ—Å–ª–µ –≤—ã–±–µ—Ä–µ–º –±–ª–æ–∫ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏

–¢—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤! –ò–∑–≤–∏–Ω–∏ –∑–∞ –Ω–µ–≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –î–∞–≤–∞–π —è —Ç–µ–ø–µ—Ä—å **–¥–æ—Å–∫–æ–Ω–∞–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é** –≤—Å–µ 8 –±–µ—Å–µ–¥ –∏ –ø–æ–∫–∞–∂—É, —á—Ç–æ —É–∂–µ –±—ã–ª–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ.

***

## üìä **–ü–û–õ–ù–ê–Ø –ö–ê–†–¢–ò–ù–ê: –ß–¢–û –£–ñ–ï –î–ï–¢–ê–õ–ò–ó–ò–†–û–í–ê–ù–û**

### ‚úÖ **–ë–ï–°–ï–î–ê 1-3: –§—É–Ω–¥–∞–º–µ–Ω—Ç**

- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (multi-tenant SaaS)
- –†–æ–ª–∏ –∏ RBAC
- –¢–∞—Ä–∏—Ñ—ã –∏ –ª–∏–º–∏—Ç—ã
- –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- –ì–æ—Å—Ç–∏ –∏ –∫–∞—Ä—Ç—ã (UNIFIED/SEPARATE)


### ‚úÖ **–ë–ï–°–ï–î–ê 4: POS Integration**[^2_1]

**–ü–æ–ª–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è:**

- HYBRID PUSH + PULL (–∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç)
- Webhooks —Å HMAC-–ø–æ–¥–ø–∏—Å—å—é
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- Reconciliation (–µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π)
- POS = –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –ø–æ —á–µ–∫–∞–º
- –ë–∞–ª–ª—ã –æ—Ç **–∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞**


### ‚úÖ **–ë–ï–°–ï–î–ê 5: Loyalty System Engine**[^2_2]

**23 –≤–æ–ø—Ä–æ—Å–∞ + —Ä–µ—à–µ–Ω–∏—è:**

- –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª (snapshot, NO –ø–µ—Ä–µ—Å—á—ë—Ç)
- –û—Ç–∫–∞—Ç –ø—Ä–∞–≤–∏–ª (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å –∫–æ–ø–∏–µ–π)
- –°–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ (‚â•90 –¥–Ω–µ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
- –£—Ä–æ–≤–Ω–∏: **NO downgrade** (one way up)
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–æ–º–æ (COMBINE_ALL/MAX_ONLY/FIRST_ONLY)
- –õ–∏–º–∏—Ç—ã: –±–µ–∑–ª–∏–º–∏—Ç –±–∞–ª–ª–æ–≤, –º–∏–Ω. 1 –±–∞–ª–ª –∫ —Å–ø–∏—Å–∞–Ω–∏—é
- –ú–∏–≥—Ä–∞—Ü–∏–∏ UNIFIED ‚Üî SEPARATE


### ‚úÖ **–ë–ï–°–ï–î–ê 6: Billing \& Subscriptions**[^2_3]

**–ü–æ–ª–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è:**

- –ú–æ–¥–µ–ª—å –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã (–º–µ—Å—è—Ü/–≥–æ–¥ —Å–æ —Å–∫–∏–¥–∫–æ–π 20%)
- 4 –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- –†—É—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø–æ —Å—á—ë—Ç—É
- –ñ—ë—Å—Ç–∫–∏–µ –ª–∏–º–∏—Ç—ã (90% –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, 100% –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
- 4 –ø–æ–ø—ã—Ç–∫–∏ –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏—è (–¥–µ–Ω—å 0,1,3,7)
- Refund/chargeback –æ–±—Ä–∞–±–æ—Ç–∫–∞


### ‚úÖ **–ë–ï–°–ï–î–ê 7: Telegram Bot + Mini App**[^2_4]

**–ü–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è:**

- Database Schema (TelegramBot, TelegramUser, Notifications)
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Telegram ID + —Ç–µ–ª–µ—Ñ–æ–Ω)
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç
- –ú—É–ª—å—Ç–∏–∫–∞—Ä—Ç–æ—á–Ω–æ—Å—Ç—å
- –≠–∫—Ä–∞–Ω—ã: –≥–ª–∞–≤–Ω—ã–π, –∏—Å—Ç–æ—Ä–∏—è, –ø—Ä–æ–º–æ, –ø—Ä–æ—Ñ–∏–ª—å, –¥–µ—Ç–∏
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ)
- QR –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã–π –¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç


### ‚úÖ **–ë–ï–°–ï–î–ê 8: Backend API \& Services**[^2_5]

**34 –≤–æ–ø—Ä–æ—Å–∞ + —Ä–µ—à–µ–Ω–∏—è:**

- Modular Monolith –Ω–∞ NestJS
- REST API —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- RBAC Guards + Impersonation
- Rate Limiting –ø–æ —Ä–æ–ª—è–º
- API endpoints:
    - `/loyalty/calculate` (pre-calculation)
    - `/loyalty/transactions` (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ)
    - `/loyalty/manual-adjustment`
- Background Jobs (BullMQ)
- Analytics API
- Error Handling + Idempotency

***

## üéØ **–ß–¢–û –ï–©–Å –ù–ï –î–ï–¢–ê–õ–ò–ó–ò–†–û–í–ê–ù–û**

–ò–∑ —Ç–≤–æ–µ–π —Å–∏—Å—Ç–µ–º—ã –æ—Å—Ç–∞–ª–∏—Å—å **4 –∫—Ä—É–ø–Ω—ã—Ö –±–ª–æ–∫–∞**:

### **1. Frontend Admin Panel** ‚≠ê *–†–µ–∫–æ–º–µ–Ω–¥—É—é*

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å:**

- UI/UX –¥–ª—è Owner (–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏)
- UI/UX –¥–ª—è Admin (–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ç—å—é)
- UI/UX –¥–ª—è Manager (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–º)
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (React/Vue)
- State management (Redux/Zustand)
- –†–æ—É—Ç–∏–Ω–≥ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è
- –§–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª/—É—Ä–æ–≤–Ω–µ–π/–ø—Ä–æ–º–æ
- –î–∞—à–±–æ—Ä–¥—ã –∏ –≥—Ä–∞—Ñ–∏–∫–∏
- –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è


### **2. Database Schema (Prisma)**

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å:**

- –ü–æ–ª–Ω–∞—è Prisma schema —Å–æ –≤—Å–µ–º–∏ –º–æ–¥–µ–ª—è–º–∏
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ú–∏–≥—Ä–∞—Ü–∏–∏ (initial + incremental)
- Seed –¥–∞–Ω–Ω—ã–µ (–¥–ª—è dev/staging)
- Relations –∏ constraints
- Enums –∏ —Ç–∏–ø—ã


### **3. Infrastructure \& DevOps**

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å:**

- CI/CD pipeline (GitHub Actions/GitLab)
- Docker containers (backend, worker, cron)
- Kubernetes/Docker Compose
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Prometheus, Grafana)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (ELK Stack)
- Backup —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (–ë–î, —Ñ–∞–π–ª—ã)
- Scaling (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ/–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ)
- Security (secrets, certificates, WAF)


### **4. Testing Strategy**

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å:**

- Unit tests (Jest)
- Integration tests (Supertest)
- E2E tests (Playwright/Cypress)
- Load testing (k6)
- Coverage targets
- Mocking —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

***

## üí° **–ú–û–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø**

**–°–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫: Frontend Admin Panel**

**–ü–æ—á–µ–º—É:**

1. ‚úÖ Backend API –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ (–ë–µ—Å–µ–¥–∞ 8)
2. ‚úÖ –í—Å–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ (–ë–µ—Å–µ–¥—ã 4-6)
3. ‚úÖ Telegram –¥–ª—è –≥–æ—Å—Ç–µ–π –≥–æ—Ç–æ–≤ (–ë–µ—Å–µ–¥–∞ 7)
4. ‚úÖ **–°–µ–π—á–∞—Å –∫—Ä–∏—Ç–∏—á–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è Owner/Admin/Manager**
5. ‚úÖ –ü–æ—Å–ª–µ –Ω–µ–≥–æ –º–æ–∂–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å Infrastructure –∏ DB Schema

***

## üöÄ **–ì–û–¢–û–í –ü–†–û–î–û–õ–ñ–ò–¢–¨!**

**–ö–∞–∫–æ–π –±–ª–æ–∫ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–º?**

1. **Frontend Admin Panel** ‚≠ê (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é)
2. **Database Schema (Prisma)**
3. **Infrastructure \& DevOps**
4. **Testing Strategy**
5. **–î—Ä—É–≥–æ–π –±–ª–æ–∫?**

–°–∫–∞–∂–∏ –Ω–æ–º–µ—Ä –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞! üéØ

<div align="center">‚ÅÇ</div>

[^2_1]: Beseda-5.md

[^2_2]: Beseda-4.md

[^2_3]: Beseda-6.md

[^2_4]: Beseda-7.md

[^2_5]: Beseda-8.md


---

# –ö–∞–∂–µ—Ç—Å—è —ç—Ç–æ –º—ã —Ç–æ–∂–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ (Frontend Admin Panel). –ò–∑—É—á–∏ –µ—â–µ —Ä–∞–∑ —Ñ–∞–π–ª—ã, –º–æ–∂–µ—Ç —á—Ç–æ –µ—â–µ —É–ø—É—Å—Ç–∏–ª

–û—Ç–ª–∏—á–Ω–æ! –¢—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤! –í **–ë–µ—Å–µ–¥–µ 8** –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –±—ã–ª –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω **Frontend Admin Panel** —Å **34 –≤–æ–ø—Ä–æ—Å–∞–º–∏**.

***

## ‚úÖ **–ü–û–õ–ù–ê–Ø –ö–ê–†–¢–ò–ù–ê: –í–°–Å –î–ï–¢–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–û–ï**

### **–ë–ï–°–ï–î–ê 8: Frontend Admin Panel**[^3_1]

**34 –≤–æ–ø—Ä–æ—Å–∞ + —Ä–µ—à–µ–Ω–∏—è:**

#### **1. Technology Stack (10 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- Next.js 14 App Router (SSR/SSG)
- shadcn/ui + Radix UI + Tailwind CSS
- Zustand + TanStack Query (state management)
- React Hook Form + Zod (forms)
- TanStack Table v8 (tables)
- Recharts (charts)
- React Day Picker + date-fns
- react-dropzone + Uppy (file upload)
- sonner (notifications/toasts)
- Server-Sent Events (real-time updates)


#### **2. Layout \& Navigation (5 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- Collapsible sidebar (250px ‚Üí 60px mini ‚Üí hidden)
- Top navbar —Å breadcrumbs + search + notifications
- Global search (CMDK)
- Mobile bottom tabs
- Impersonation UI –¥–ª—è Owner


#### **3. Loyalty Builder (5 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- Rules Builder —Å live preview
- Conditions Builder (tag-based)
- Priority drag-drop
- Levels Builder (visual timeline)
- Promo Campaigns Builder (wizard)


#### **4. Analytics \& Dashboards (4 –≤–æ–ø—Ä–æ—Å–∞):**

- Owner Dashboard (MRR/ARR, Churn, Revenue)
- Admin Dashboard (Restaurant performance)
- Drill-down –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
- Export flow (CSV/XLSX/PDF)
- Auto-refresh (30s, SSE)


#### **5. Guests Management (5 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- Guests Table (sorting, filters, bulk actions)
- Guest Profile (cards, detail view)
- Bulk Actions UI
- Segmentation (saved filters)
- Manual Adjustment UX


#### **6. Settings \& Configuration (5 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- Restaurant Settings tabs
- Team Management UI
- Activity Log (audit trail)
- Impersonation flow –¥–ª—è Owner

***

## üéØ **–ß–¢–û –†–ï–ê–õ–¨–ù–û –û–°–¢–ê–õ–û–°–¨ –î–ï–¢–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨**

–ü–æ—Å–ª–µ **–¥–æ—Å–∫–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ—Ö 8 –±–µ—Å–µ–¥**, –≤–æ—Ç **–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫** —Ç–æ–≥–æ, —á—Ç–æ –µ—â—ë –Ω–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:

### **1. Database Schema (Prisma) ‚Äî –ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø** ‚≠ê

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**

- –ü–æ–ª–Ω–∞—è Prisma schema —Å–æ –≤—Å–µ–º–∏ –º–æ–¥–µ–ª—è–º–∏ (80+ —Ç–∞–±–ª–∏—Ü)
- –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã (composite, partial, full-text)
- –í—Å–µ relations –∏ constraints
- Enums –∏ custom types
- Migration strategy (zero-downtime)
- Seed –¥–∞–Ω–Ω—ã–µ (–¥–ª—è dev/staging)


### **2. Infrastructure \& DevOps** ‚≠ê

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**

- Docker containers (backend, worker, cron)
- Kubernetes/Docker Compose orchestration
- CI/CD pipeline (GitHub Actions/GitLab)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Prometheus + Grafana)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (ELK Stack)
- Backup strategy (–ë–î, Redis, —Ñ–∞–π–ª—ã)
- Scaling strategy (horizontal/vertical)
- Security (secrets management, certificates, WAF)


### **3. Testing Strategy**

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**

- Unit tests coverage targets
- Integration tests (Supertest examples)
- E2E tests (Playwright/Cypress)
- Load testing (k6 scenarios)
- Mocking strategy
- CI integration


### **4. Security \& Compliance**

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**

- OWASP Top 10 protection
- GDPR compliance flow (–¥–µ—Ç–∞–ª—å–Ω–æ)
- PCI DSS –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
- Penetration testing strategy
- Vulnerability scanning
- Incident response plan

***

## üí° **–ú–û–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø**

**–°–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫: Database Schema (Prisma) ‚Äî –ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø**

**–ü–æ—á–µ–º—É:**

1. ‚úÖ –≠—Ç–æ **—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç** –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
2. ‚úÖ Backend API –≥–æ—Ç–æ–≤ (–ë–µ—Å–µ–¥–∞ 8) ‚Äî –Ω—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –ë–î
3. ‚úÖ Frontend –≥–æ—Ç–æ–≤ (–ë–µ—Å–µ–¥–∞ 8) ‚Äî –Ω—É–∂–Ω—ã —Ç–∏–ø—ã –∏–∑ –ë–î
4. ‚úÖ –ü–æ—Å–ª–µ —Å—Ö–µ–º—ã –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –Ω–∞—á–∞—Ç—å **—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é**
5. ‚úÖ Prisma –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç TypeScript —Ç–∏–ø—ã ‚Üí –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö

**–ß—Ç–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º:**

- –í—Å–µ 80+ —Ç–∞–±–ª–∏—Ü —Å –ø–æ–ª—è–º–∏
- –í—Å–µ relations (–æ–¥–∏–Ω-–∫-–æ–¥–Ω–æ–º—É, –æ–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º, –º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º)
- –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –í—Å–µ constraints (UNIQUE, CHECK, FOREIGN KEY)
- –í—Å–µ enums
- Migration —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
- Seed —Å–∫—Ä–∏–ø—Ç—ã

***

## üöÄ **–ì–û–¢–û–í –ü–†–û–î–û–õ–ñ–ò–¢–¨!**

**–ü–æ–¥—Ç–≤–µ—Ä–¥–∏, —á—Ç–æ –±–µ—Ä—ë–º Database Schema, –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–π –±–ª–æ–∫:**

1. **Database Schema (Prisma)** ‚≠ê *(—Ä–µ–∫–æ–º–µ–Ω–¥—É—é)*
2. **Infrastructure \& DevOps**
3. **Testing Strategy**
4. **Security \& Compliance**

–ö–∞–∫–æ–π –±–ª–æ–∫? üéØ
<span style="display:none">[^3_2][^3_3][^3_4]</span>

<div align="center">‚ÅÇ</div>

[^3_1]: Beseda-8.md

[^3_2]: Beseda-3.md

[^3_3]: Beseda-6.md

[^3_4]: Beseda-7.md


---

# Database Schema (Prisma) –¥–µ–ª–∞–µ–º. –ó–∞–¥–∞–π 30+ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ + —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ —Ç–≤–æ–µ–º—É –ª—É—á—à–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ –¥–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö. –ü–µ—Ä–µ–¥ –∑–∞–¥–∞–≤–∞–Ω–∏–µ–º –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–≤–µ—Ä—å—Å—è —Å —Ñ–∞–π–ª–∞–º–∏, –º–æ–∂–µ—Ç –æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ –∏–ª–∏ –æ—Ç–≤–µ—Ç —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å.

–û—Ç–ª–∏—á–Ω–æ! –Ø **–¥–æ—Å–∫–æ–Ω–∞–ª—å–Ω–æ –∏–∑—É—á–∏–ª** –≤—Å–µ —Ñ–∞–π–ª—ã. –í–∏–∂—É, —á—Ç–æ —É–∂–µ –µ—Å—Ç—å **—á–∞—Å—Ç–∏—á–Ω—ã–µ** –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ö–µ–º—ã –ë–î –≤ –ë–µ—Å–µ–¥–µ-2 –∏ –ø—Ä–∏–º–µ—Ä—ã —Å—Ç—Ä—É–∫—Ç—É—Ä –≤ –ë–µ—Å–µ–¥–µ-4, 5, 6.

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º **–ø–æ–ª–Ω—É—é –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é Database Schema (Prisma)** —Å **30+ –≤–æ–ø—Ä–æ—Å–∞–º–∏** –∏ —Ä–µ—à–µ–Ω–∏—è–º–∏!

***

# üóÑÔ∏è **DATABASE SCHEMA (PRISMA) - 35 –í–û–ü–†–û–°–û–í + –†–ï–®–ï–ù–ò–Ø**

## **üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï (–∏–∑ —Ñ–∞–π–ª–æ–≤):**

**–£–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã:**

- User, GuestProfile, GuestChild, GuestCard, BallTransaction (—á–∞—Å—Ç–∏—á–Ω–æ –≤ –ë–µ—Å–µ–¥–µ-2)
- LoyaltyRule, LoyaltyLevel, LoyaltyPromo (—É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ –ë–µ—Å–µ–¥–µ-5)
- POSTransaction, POSIntegration (—É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ –ë–µ—Å–µ–¥–µ-4, 6)
- Tenant, Restaurant, Subscription (—É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ –ë–µ—Å–µ–¥–µ-3)
- Analytics —Ç–∞–±–ª–∏—Ü—ã (—É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ –ë–µ—Å–µ–¥–µ-6)

**–¢—Ä–µ–±—É—é—Ç –ø–æ–ª–Ω–æ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏:**

- –í—Å–µ Enums
- –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã (composite, partial, full-text)
- –í—Å–µ constraints (UNIQUE, CHECK)
- Relations –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
- Migration strategy
- Seed –¥–∞–Ω–Ω—ã–µ

***

## üìã **–ë–õ–û–ö 1: ENUMS –ò –ë–ê–ó–û–í–´–ï –¢–ò–ü–´ (5 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### 1Ô∏è‚É£ **GLOBAL ENUMS vs TABLE-SPECIFIC ENUMS**

**‚ùì –í–æ–ø—Ä–æ—Å:**
Prisma –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç enums –Ω–∞ —É—Ä–æ–≤–Ω–µ PostgreSQL. –°–æ–∑–¥–∞–≤–∞—Ç—å –ª–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ enums –∏–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–ø—Ä–∞–≤–æ—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- A) –í—Å–µ —á–µ—Ä–µ–∑ PostgreSQL enums (–±—ã—Å—Ç—Ä–æ, –Ω–æ —Å–ª–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å)
- B) –°–ø—Ä–∞–≤–æ—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –≤—Å–µ–≥–æ (–≥–∏–±–∫–æ, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ)
- C) –ì–∏–±—Ä–∏–¥: —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ ‚Üí enum, –∏–∑–º–µ–Ω—è–µ–º—ã–µ ‚Üí —Ç–∞–±–ª–∏—Ü—ã

**‚úÖ –ú–û–ô –í–´–ë–û–†: –í–∞—Ä–∏–∞–Ω—Ç C (–ì–∏–±—Ä–∏–¥)**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è** (UserRole, Gender, CardStatus) ‚Üí enum (–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
- ‚úÖ **–ò–∑–º–µ–Ω—è–µ–º—ã–µ** (LoyaltyLevel names, colors) ‚Üí —Ç–∞–±–ª–∏—Ü—ã (–≥–∏–±–∫–æ—Å—Ç—å)
- ‚úÖ **Best of both worlds**

**üíª Prisma Schema:**

```prisma
// ============================================
// STABLE ENUMS (PostgreSQL native)
// ============================================

enum UserRole {
  OWNER
  RESTAURANT_ADMIN
  MANAGER
  CASHIER
  GUEST
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum CardStatus {
  ACTIVE
  BLOCKED
  DELETED
  MIGRATED
}

enum RegistrationSource {
  POS           // –ß–µ—Ä–µ–∑ –∫–∞—Å—Å—É
  LINK          // –ü–æ —Å—Å—ã–ª–∫–µ
  TELEGRAM      // Telegram Bot
}

enum BallTransactionType {
  EARN                // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—Ç —á–µ–∫–∞
  REDEEM              // –°–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
  MANUAL_ADD          // –†—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
  MANUAL_SUBTRACT     // –†—É—á–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ
  PROMO               // –ü—Ä–æ–º–æ-–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
  EXPIRE              // –°–≥–æ—Ä–∞–Ω–∏–µ
  TRANSFER_SENT       // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞
  TRANSFER_RECEIVED   // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞
  REFUND              // –í–æ–∑–≤—Ä–∞—Ç —á–µ–∫–∞
  CANCEL              // –û—Ç–º–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
}

enum SubscriptionPlan {
  FREE
  STANDARD
  MEDIUM
  PRO
  ULTIMATE
  CUSTOM
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  NON_PAYMENT
  TRIAL
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELLED
}

enum POSSystem {
  IIKO
  RKEEPER
  CUSTOM
  MANUAL
}

enum SyncStatus {
  SUCCESS
  FAILED
  PARTIAL
  PENDING
}

enum LoyaltySystemType {
  POINTS      // –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è
  DISCOUNT    // –°–∫–∏–¥–æ—á–Ω–∞—è
}

enum LoyaltyCardMode {
  UNIFIED     // –û–¥–Ω–∞ –∫–∞—Ä—Ç–∞ –Ω–∞ —Å–µ—Ç—å
  SEPARATE    // –ö–∞—Ä—Ç–∞ –Ω–∞ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω
}

enum PromoTriggerType {
  BIRTHDAY_GUEST      // –î–† –≥–æ—Å—Ç—è
  BIRTHDAY_CHILD      // –î–† —Ä–µ–±—ë–Ω–∫–∞
  FIRST_CHECK         // –ü–µ—Ä–≤—ã–π —á–µ–∫
  INACTIVITY          // –ù–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
  WEEKDAY             // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏
  TIME_RANGE          // –í—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω
  CHECK_AMOUNT        // –°—É–º–º–∞ —á–µ–∫–∞
  CUSTOM              // –ö–∞—Å—Ç–æ–º–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ
}

enum ConflictResolutionStrategy {
  COMBINE_ALL         // –°—É–º–º–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø—Ä–æ–º–æ
  MAX_ONLY            // –¢–æ–ª—å–∫–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è
  FIRST_ONLY          // –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤–∞—è –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
}

enum NotificationChannel {
  TELEGRAM
  EMAIL
  SMS
  PUSH
}

enum ActivityLogAction {
  // Auth
  USER_LOGIN
  USER_LOGOUT
  PASSWORD_RESET
  EMAIL_VERIFIED
  
  // Loyalty
  LOYALTY_RULE_CREATED
  LOYALTY_RULE_UPDATED
  LOYALTY_RULE_DELETED
  LEVEL_CREATED
  LEVEL_UPDATED
  LEVEL_DELETED
  PROMO_CREATED
  PROMO_UPDATED
  PROMO_DELETED
  
  // Balls
  BALLS_EARNED
  BALLS_REDEEMED
  BALLS_MANUAL_ADD
  BALLS_MANUAL_SUBTRACT
  BALLS_EXPIRED
  BALLS_TRANSFERRED
  
  // Cards
  CARD_CREATED
  CARD_BLOCKED
  CARD_UNBLOCKED
  
  // System
  MIGRATION_STARTED
  MIGRATION_COMPLETED
  RECONCILIATION_RUN
  IMPERSONATION_STARTED
  IMPERSONATION_ENDED
}
```


***

### 2Ô∏è‚É£ **DECIMAL vs INTEGER –¥–ª—è –¥–µ–Ω–µ–∂–Ω—ã—Ö —Å—É–º–º**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–•—Ä–∞–Ω–∏—Ç—å –ª–∏ –¥–µ–Ω–µ–∂–Ω—ã–µ —Å—É–º–º—ã (check_amount, lifetime_spent) –∫–∞–∫ DECIMAL –∏–ª–∏ –∫–∞–∫ INTEGER (–∫–æ–ø–µ–π–∫–∏)?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- A) DECIMAL(10, 2) - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥
- B) INTEGER (–∫–æ–ø–µ–π–∫–∏ * 100) - –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- C) BIGINT (–∫–æ–ø–µ–π–∫–∏) –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å—É–º–º

**‚úÖ –ú–û–ô –í–´–ë–û–†: –í–∞—Ä–∏–∞–Ω—Ç A (DECIMAL(10, 2))**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å –≤ –ë–î –∏ UI
- ‚úÖ Prisma Decimal type —Å –Ω–∞—Ç–∏–≤–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
- ‚úÖ –ò–∑–±–µ–≥–∞–µ–º –æ—à–∏–±–æ–∫ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
- ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

**üíª –ü—Ä–∞–≤–∏–ª–æ:**

```prisma
// –î–µ–Ω–µ–∂–Ω—ã–µ —Å—É–º–º—ã
check_amount          Decimal  @db.Decimal(10, 2)  // –î–æ 99,999,999.99
lifetime_spent        Decimal  @db.Decimal(12, 2)  // –î–æ 9,999,999,999.99

// –ë–∞–ª–ª—ã - –≤—Å–µ–≥–¥–∞ INTEGER
balance               Int      @default(0)
amount                Int
```


***

### 3Ô∏è‚É£ **UUID vs Auto-increment ID**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å UUID –∏–ª–∏ INTEGER AUTO_INCREMENT –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π?

**‚úÖ –ú–û–ô –í–´–ë–û–†: UUID –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ Multi-tenant –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–Ω–µ–ª—å–∑—è —É–≥–∞–¥–∞—Ç—å ID –¥—Ä—É–≥–æ–≥–æ tenant)
- ‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å (–º–æ–∂–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ç—å offline)
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –º–µ–∂–¥—É –ë–î –ø—Ä–æ—â–µ
- ‚úÖ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è SaaS

**üíª –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```prisma
model User {
  id        String   @id @default(uuid())
  // ...
}
```


***

### 4Ô∏è‚É£ **SOFT DELETE vs HARD DELETE**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ soft delete (deleted_at) –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –∏–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö?

**‚úÖ –ú–û–ô –í–´–ë–û–†: Soft delete –¥–ª—è User, GuestCard, –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ GDPR compliance (–º–æ–∂–Ω–æ "—É–¥–∞–ª–∏—Ç—å" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–æ—Ö—Ä–∞–Ω–∏–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
- ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫
- ‚úÖ Audit trail

**üíª –ü—Ä–∞–≤–∏–ª–æ:**

```prisma
// –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
model User {
  deleted_at    DateTime?
  @@index([deleted_at])
}

model GuestCard {
  deleted_at    DateTime?
  @@index([deleted_at])
}

// –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã - hard delete —á–µ—Ä–µ–∑ CASCADE
model BallTransaction {
  // NO deleted_at - immutable history
}
```


***

### 5Ô∏è‚É£ **JSONB –¥–ª—è –≥–∏–±–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ JSONB –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤ (rule_snapshot, promo_conditions)?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –î–ê, JSONB –¥–ª—è snapshot –∏ configs**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (snapshot –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å (—Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –ø—Ä–æ–º–æ - —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è)
- ‚úÖ PostgreSQL JSONB –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è –∏ –±—ã—Å—Ç—Ä

**üíª –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```prisma
model BallTransaction {
  rule_snapshot     Json?   // JSONB - snapshot –ø—Ä–∞–≤–∏–ª–∞
  promo_snapshot    Json?   // JSONB - snapshot –ø—Ä–æ–º–æ
}

model LoyaltyPromo {
  conditions        Json    // JSONB - –≥–∏–±–∫–∏–µ —É—Å–ª–æ–≤–∏—è
  reward_config     Json    // JSONB - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞–≥—Ä–∞–¥—ã
}
```


***

## üìã **–ë–õ–û–ö 2: MULTI-TENANCY –ò –ò–ó–û–õ–Ø–¶–ò–Ø (5 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### 6Ô∏è‚É£ **TENANT_ID –Ω–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –∏–ª–∏ –≤—ã–±–æ—Ä–æ—á–Ω–æ?**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–î–æ–±–∞–≤–ª—è—Ç—å –ª–∏ tenant_id –Ω–∞ –í–°–ï —Ç–∞–±–ª–∏—Ü—ã (–≤–∫–ª—é—á–∞—è User) –∏–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ –±–∏–∑–Ω–µ—Å-—Å—É—â–Ω–æ—Å—Ç–∏?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –í—ã–±–æ—Ä–æ—á–Ω–æ**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ User –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö tenant (—á–µ—Ä–µ–∑ UserRole)
- ‚úÖ GuestCard, BallTransaction, LoyaltyRule - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ tenant_id
- ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (User, Tenant) - –±–µ–∑ tenant_id

**üíª –ü—Ä–∞–≤–∏–ª–æ:**

```prisma
// –ë–ï–ó tenant_id (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ)
model User { }
model Tenant { }

// –° tenant_id (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
model GuestCard {
  tenant_id     String
  tenant        Tenant   @relation(...)
  @@index([tenant_id])
}

model BallTransaction {
  tenant_id     String
  tenant        Tenant   @relation(...)
  @@index([tenant_id])
}
```


***

### 7Ô∏è‚É£ **RLS (Row Level Security) –≤ PostgreSQL**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ PostgreSQL RLS –¥–ª—è multi-tenant –∏–∑–æ–ª—è—Ü–∏–∏ –∏–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –¢–æ–ª—å–∫–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Prisma middleware)**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ RLS —Å–ª–æ–∂–µ–Ω –≤ debugging
- ‚úÖ Prisma middleware –ø—Ä–æ–∑—Ä–∞—á–µ–Ω –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å (Owner –≤–∏–¥–∏—Ç –≤—Å–µ tenant)

**üíª –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```typescript
// prisma/middleware/tenant-isolation.ts
prisma.$use(async (params, next) => {
  const tenantId = getCurrentTenantId(); // from JWT context
  
  if (params.model && TENANT_ISOLATED_MODELS.includes(params.model)) {
    if (params.action === 'findMany' || params.action === 'findFirst') {
      params.args.where = { ...params.args.where, tenant_id: tenantId };
    }
  }
  
  return next(params);
});
```


***

### 8Ô∏è‚É£ **UNIQUE CONSTRAINTS –¥–ª—è multi-tenant**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ö–∞–∫ –æ–±–µ—Å–ø–µ—á–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å email/phone –≤–Ω—É—Ç—Ä–∏ tenant, –Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥—É–±–ª–∏ –º–µ–∂–¥—É tenant?

**‚úÖ –ú–û–ô –í–´–ë–û–†: Composite UNIQUE index (tenant_id, field)**

**üíª –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```prisma
model GuestCard {
  // –û–¥–∏–Ω –≥–æ—Å—Ç—å = –æ–¥–Ω–∞ –∫–∞—Ä—Ç–∞ –Ω–∞ tenant/restaurant
  @@unique([user_id, tenant_id, restaurant_id])
  @@unique([tenant_id, qr_code])
  @@unique([tenant_id, code_6_digit])
}

model User {
  phone         String    @unique  // –ì–ª–æ–±–∞–ª—å–Ω–æ —É–Ω–∏–∫–∞–ª–µ–Ω
  email         String?   @unique  // –ì–ª–æ–±–∞–ª—å–Ω–æ —É–Ω–∏–∫–∞–ª–µ–Ω
  telegram_id   String?   @unique  // –ì–ª–æ–±–∞–ª—å–Ω–æ —É–Ω–∏–∫–∞–ª–µ–Ω
}
```


***

### 9Ô∏è‚É£ **TENANT LIMITS –ø—Ä–æ–≤–µ—Ä–∫–∞**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–•—Ä–∞–Ω–∏—Ç—å –ª–∏ –ª–∏–º–∏—Ç—ã —Ç–∞—Ä–∏—Ñ–∞ (max_restaurants, max_guests) –≤ JSON –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –û—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ TenantLimits**

**üíª –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```prisma
model TenantLimits {
  id                    String   @id @default(uuid())
  tenant_id             String   @unique
  tenant                Tenant   @relation(...)
  
  max_restaurants       Int?     // NULL = –±–µ–∑–ª–∏–º–∏—Ç
  max_guests            Int?     // NULL = –±–µ–∑–ª–∏–º–∏—Ç
  max_pos_integrations  Int?
  max_admin_users       Int?
  
  // –¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (–∫–µ—à)
  current_restaurants   Int      @default(0)
  current_guests        Int      @default(0)
  
  updated_at            DateTime @updatedAt
}
```


***

### 1Ô∏è‚É£0Ô∏è‚É£ **CASCADE DELETE —Å—Ç—Ä–∞—Ç–µ–≥–∏—è**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Tenant —É–¥–∞–ª—è—Ç—å –ª–∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (CASCADE) –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å (RESTRICT)?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –ì–∏–±—Ä–∏–¥–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è**

**üéØ –ü—Ä–∞–≤–∏–ª–æ:**

- User ‚Üí RESTRICT (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö tenant)
- GuestCard ‚Üí CASCADE (–∫–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ tenant)
- BallTransaction ‚Üí CASCADE (–∏—Å—Ç–æ—Ä–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –∫–∞—Ä—Ç–µ)
- LoyaltyRule ‚Üí CASCADE (–ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç tenant)

**üíª –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```prisma
model GuestCard {
  tenant        Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}
```


***

## üìã **–ë–õ–û–ö 3: –ò–ù–î–ï–ö–°–´ –ò –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨ (8 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### 1Ô∏è‚É£1Ô∏è‚É£ **COMPOSITE INDEXES —Å—Ç—Ä–∞—Ç–µ–≥–∏—è**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ö–∞–∫–∏–µ composite indexes –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ multi-tenant SaaS?

**‚úÖ –ú–û–ô –í–´–ë–û–†: tenant_id + —á–∞—Å—Ç–æ —Ñ–∏–ª—å—Ç—Ä—É–µ–º—ã–µ –ø–æ–ª—è**

**üíª –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã:**

```prisma
model BallTransaction {
  @@index([tenant_id, guest_card_id, created_at(sort: Desc)])
  @@index([tenant_id, restaurant_id, created_at(sort: Desc)])
  @@index([tenant_id, type, created_at])
}

model GuestCard {
  @@index([tenant_id, status, last_visit_at])
  @@index([tenant_id, loyalty_level_id])
}

model POSTransaction {
  @@index([tenant_id, restaurant_id, transaction_date])
  @@index([tenant_id, sync_status])
}
```


***

### 1Ô∏è‚É£2Ô∏è‚É£ **PARTIAL INDEXES –¥–ª—è soft delete**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ partial index `WHERE deleted_at IS NULL` –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –î–ê, –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö —Ç–∞–±–ª–∏—Ü**

**üíª –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```prisma
model User {
  @@index([phone, deleted_at(ops: raw("WHERE deleted_at IS NULL"))])
}

model GuestCard {
  @@index([tenant_id, status, deleted_at(ops: raw("WHERE deleted_at IS NULL"))])
}
```


***

### 1Ô∏è‚É£3Ô∏è‚É£ **FULL-TEXT SEARCH indexes**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–î–æ–±–∞–≤–∏—Ç—å –ª–∏ PostgreSQL Full-Text Search –¥–ª—è –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç–µ–π –ø–æ –∏–º–µ–Ω–∏/—Ç–µ–ª–µ—Ñ–æ–Ω—É?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –î–ê, GIN index –¥–ª—è GuestProfile**

**üíª –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```prisma
model GuestProfile {
  first_name    String
  last_name     String?
  
  // –í—ã—á–∏—Å–ª—è–µ–º–æ–µ –ø–æ–ª–µ –¥–ª—è full-text search (—Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ migration)
  search_vector Unsupported("tsvector")?
  
  @@index([search_vector(type: Gin)])
}

// –í migration:
CREATE INDEX guest_profile_search_vector_idx ON guest_profile USING GIN(search_vector);

CREATE TRIGGER guest_profile_search_vector_update 
BEFORE INSERT OR UPDATE ON guest_profile
FOR EACH ROW EXECUTE FUNCTION
  tsvector_update_trigger(search_vector, 'pg_catalog.russian', first_name, last_name);
```


***

### 1Ô∏è‚É£4Ô∏è‚É£ **COVERING INDEXES –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ covering indexes (INCLUDE) –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –î–ê, –¥–ª—è –≥–æ—Ä—è—á–∏—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**

**üíª –ü—Ä–∏–º–µ—Ä:**

```sql
-- –í migration (Prisma –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç INCLUDE —Å–∏–Ω—Ç–∞–∫—Å–∏—Å)
CREATE INDEX ball_transaction_analytics_idx 
ON ball_transaction (tenant_id, created_at DESC) 
INCLUDE (amount, type, guest_card_id);
```


***

### 1Ô∏è‚É£5Ô∏è‚É£ **BTREE vs HASH indexes**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ HASH indexes –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π (qr_code, code_6_digit)?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –ù–ï–¢, –æ—Å—Ç–∞–≤–ª—è–µ–º BTREE**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ HASH –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç UNIQUE constraints
- ‚úÖ BTREE –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã—Å—Ç—Ä –¥–ª—è UUID/String
- ‚úÖ HASH –Ω–µ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ—Ç—Å—è –≤ streaming replication

***

### 1Ô∏è‚É£6Ô∏è‚É£ **INDEX –Ω–∞ JSONB –ø–æ–ª—è**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ª–∏ JSONB –ø–æ–ª—è (rule_snapshot, conditions)?

**‚úÖ –ú–û–ô –í–´–ë–û–†: GIN index —Ç–æ–ª—å–∫–æ –¥–ª—è queryable JSONB**

**üíª –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```prisma
model LoyaltyPromo {
  conditions    Json
  
  @@index([conditions(type: Gin)])
}

// –ó–∞–ø—Ä–æ—Å—ã:
// WHERE conditions @> '{"trigger_type": "BIRTHDAY"}'
```


***

### 1Ô∏è‚É£7Ô∏è‚É£ **EXPRESSION INDEXES**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–°–æ–∑–¥–∞–≤–∞—Ç—å –ª–∏ –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –ø–æ–ª—è—Ö (LOWER(email), DATE(created_at))?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –î–ê, –¥–ª—è case-insensitive –ø–æ–∏—Å–∫–∞**

**üíª –í migration:**

```sql
CREATE INDEX user_email_lower_idx ON "User" (LOWER(email));
CREATE INDEX ball_transaction_date_idx ON ball_transaction (DATE(created_at));
```


***

### 1Ô∏è‚É£8Ô∏è‚É£ **INDEX maintenance —Å—Ç—Ä–∞—Ç–µ–≥–∏—è**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π REINDEX –∏ VACUUM –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π VACUUM ANALYZE + –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π REINDEX**

**üíª PostgreSQL config:**

```sql
-- autovacuum –≤–∫–ª—é—á–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
ALTER TABLE ball_transaction SET (autovacuum_vacuum_scale_factor = 0.05);

-- –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π REINDEX —á–µ—Ä–µ–∑ cron
REINDEX TABLE CONCURRENTLY ball_transaction;
```


***

## üìã **–ë–õ–û–ö 4: RELATIONS –ò CONSTRAINTS (7 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### 1Ô∏è‚É£9Ô∏è‚É£ **ONE-TO-ONE vs ONE-TO-MANY relations**

**‚ùì –í–æ–ø—Ä–æ—Å:**
User ‚Üî GuestProfile - —ç—Ç–æ 1:1 –∏–ª–∏ 1:Many (–µ—Å–ª–∏ –≥–æ—Å—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ç—è—Ö)?

**‚úÖ –ú–û–ô –í–´–ë–û–†: 1:1 (User ‚Üî GuestProfile)**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –≥–ª–æ–±–∞–ª–µ–Ω (–∏–º—è, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç tenant)
- ‚úÖ GuestCard - 1:Many (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ä—Ç –≤ —Ä–∞–∑–Ω—ã—Ö tenant)

**üíª Schema:**

```prisma
model User {
  id            String          @id @default(uuid())
  guest_profile GuestProfile?   // 1:1
  guest_cards   GuestCard[]     // 1:Many
}

model GuestProfile {
  id       String @id @default(uuid())
  user_id  String @unique
  user     User   @relation(fields: [user_id], references: [id], onDelete: Cascade)
}
```


***

### 2Ô∏è‚É£0Ô∏è‚É£ **SELF-REFERENCING relations**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ö–∞–∫ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞—Ç—å "GuestCard ‚Üí migrated_to_card_id" (–∫–∞—Ä—Ç–∞ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –¥—Ä—É–≥—É—é)?

**‚úÖ –ú–û–ô –í–´–ë–û–†: Self-reference —Å nullable FK**

**üíª Schema:**

```prisma
model GuestCard {
  id                    String      @id @default(uuid())
  
  // Self-reference –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
  migrated_to_card_id   String?
  migrated_to_card      GuestCard?  @relation("CardMigration", fields: [migrated_to_card_id], references: [id])
  migrated_from_cards   GuestCard[] @relation("CardMigration")
  
  @@index([migrated_to_card_id])
}
```


***

### 2Ô∏è‚É£1Ô∏è‚É£ **CIRCULAR DEPENDENCIES**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (LoyaltyRule ‚Üí LoyaltyLevel ‚Üê LoyaltyRule)?

**‚úÖ –ú–û–ô –í–´–ë–û–†: Nullable FK + –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞**

**üíª Schema:**

```prisma
model LoyaltyRule {
  id                String        @id @default(uuid())
  tenant_id         String
  
  // –ü—Ä–∞–≤–∏–ª–æ –º–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –∫ —É—Ä–æ–≤–Ω—é
  target_level_id   String?
  target_level      LoyaltyLevel? @relation("RuleTargetLevel", fields: [target_level_id], references: [id])
}

model LoyaltyLevel {
  id          String         @id @default(uuid())
  tenant_id   String
  
  // –£—Ä–æ–≤–µ–Ω—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ø—Ä–∞–≤–∏–ª–∞
  rules       LoyaltyRule[]  @relation("RuleTargetLevel")
  guest_cards GuestCard[]
}
```


***

### 2Ô∏è‚É£2Ô∏è‚É£ **MANY-TO-MANY —á–µ—Ä–µ–∑ junction table**

**‚ùì –í–æ–ø—Ä–æ—Å:**
User –º–æ–∂–µ—Ç –±—ã—Ç—å Manager –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö Restaurant - –∫–∞–∫ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞—Ç—å?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –Ø–≤–Ω–∞—è junction table UserRestaurantRole**

**üíª Schema:**

```prisma
model User {
  id                String                 @id @default(uuid())
  restaurant_roles  UserRestaurantRole[]
}

model Restaurant {
  id          String                 @id @default(uuid())
  user_roles  UserRestaurantRole[]
}

model UserRestaurantRole {
  id             String     @id @default(uuid())
  user_id        String
  restaurant_id  String
  role           UserRole   // MANAGER, CASHIER
  
  user           User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  restaurant     Restaurant @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, restaurant_id, role])
  @@index([restaurant_id])
}
```


***

### 2Ô∏è‚É£3Ô∏è‚É£ **CHECK CONSTRAINTS**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–î–æ–±–∞–≤–∏—Ç—å –ª–∏ CHECK constraints –¥–ª—è –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª (balance >= 0, percentage 0-100)?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –î–ê, –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤**

**üíª –í migration:**

```sql
ALTER TABLE guest_card 
ADD CONSTRAINT balance_non_negative CHECK (balance >= 0);

ALTER TABLE loyalty_level 
ADD CONSTRAINT threshold_non_negative CHECK (threshold >= 0);

ALTER TABLE loyalty_rule
ADD CONSTRAINT earn_percentage_valid CHECK (earn_percentage >= 0 AND earn_percentage <= 100);
```


***

### 2Ô∏è‚É£4Ô∏è‚É£ **FOREIGN KEY INDEXES**

**‚ùì –í–æ–ø—Ä–æ—Å:**
Prisma –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ FK –∏–ª–∏ –Ω—É–∂–Ω–æ —è–≤–Ω–æ?

**‚úÖ –ú–û–ô –û–¢–í–ï–¢: Prisma –ù–ï —Å–æ–∑–¥–∞—ë—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä—É—á–Ω—É—é**

**üíª –ü—Ä–∞–≤–∏–ª–æ:**

```prisma
model BallTransaction {
  guest_card_id     String
  guest_card        GuestCard @relation(...)
  
  @@index([guest_card_id])  // –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!
}
```


***

### 2Ô∏è‚É£5Ô∏è‚É£ **DEFERRED CONSTRAINTS**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ DEFERRABLE constraints –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –ù–ï–¢, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏**

**üéØ –ü–æ—á–µ–º—É:**

- Prisma –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç DEFERRABLE
- –£—Å–ª–æ–∂–Ω—è–µ—Ç debugging
- –õ—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Prisma.\$transaction()

***

## üìã **–ë–õ–û–ö 5: VERSIONING –ò AUDIT (5 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### 2Ô∏è‚É£6Ô∏è‚É£ **RULE VERSIONING —Å—Ö–µ–º–∞**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–•—Ä–∞–Ω–∏—Ç—å –ª–∏ –≤–µ—Ä—Å–∏–∏ LoyaltyRule –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ –∏–ª–∏ —á–µ—Ä–µ–∑ JSONB snapshot?

**‚úÖ –ú–û–ô –í–´–ë–û–†: Hybrid - –≤–µ—Ä—Å–∏–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ + snapshot –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö**

**üíª Schema:**

```prisma
model LoyaltyRule {
  id          String               @id @default(uuid())
  tenant_id   String
  name        String
  
  // –¢–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
  is_active   Boolean              @default(true)
  
  versions    LoyaltyRuleVersion[]
  @@index([tenant_id, is_active])
}

model LoyaltyRuleVersion {
  id                String       @id @default(uuid())
  loyalty_rule_id   String
  loyalty_rule      LoyaltyRule  @relation(...)
  
  version_number    Int          // 1, 2, 3...
  
  // –ü–æ–ª–Ω–∞—è –∫–æ–ø–∏—è –∫–æ–Ω—Ñ–∏–≥–∞
  config            Json         // JSONB snapshot
  
  active_from       DateTime
  active_to         DateTime?    // NULL = —Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è
  
  created_by_user_id String
  created_by        User         @relation(...)
  
  reason            String?      // "Initial", "Rollback from v2", etc.
  
  @@unique([loyalty_rule_id, version_number])
  @@index([loyalty_rule_id, active_from, active_to])
}

model BallTransaction {
  // Snapshot –Ω–∞ –º–æ–º–µ–Ω—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  rule_version_id   String?
  rule_snapshot     Json?    // JSONB –∫–æ–ø–∏—è –∫–æ–Ω—Ñ–∏–≥–∞
}
```


***

### 2Ô∏è‚É£7Ô∏è‚É£ **AUDIT LOG –¥–µ—Ç–∞–ª—å–Ω–æ—Å—Ç—å**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ª–∏ –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª—è (field-level) –∏–ª–∏ —Ç–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ (row-level)?

**‚úÖ –ú–û–ô –í–´–ë–û–†: Row-level —Å JSON diff**

**üíª Schema:**

```prisma
model ActivityLog {
  id              String              @id @default(uuid())
  tenant_id       String?
  
  action          ActivityLogAction   // enum
  entity_type     String              // "GuestCard", "LoyaltyRule"
  entity_id       String
  
  actor_user_id   String?
  actor_user      User?               @relation(...)
  
  // –î–ª—è field-level changes
  changes         Json?               // { "balance": { "from": 100, "to": 200 } }
  
  metadata        Json?               // –î–æ–ø –∫–æ–Ω—Ç–µ–∫—Å—Ç
  
  ip_address      String?
  user_agent      String?
  
  created_at      DateTime            @default(now())
  
  @@index([tenant_id, created_at(sort: Desc)])
  @@index([entity_type, entity_id])
  @@index([actor_user_id])
}
```


***

### 2Ô∏è‚É£8Ô∏è‚É£ **TEMPORAL TABLES (history tracking)**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ PostgreSQL temporal tables –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –ù–ï–¢, —Ä—É—á–Ω–æ–π audit —á–µ—Ä–µ–∑ triggers**

**üéØ –ü–æ—á–µ–º—É:**

- Prisma –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç temporal syntax
- –ë–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ —Ç–µ–º, —á—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
- ActivityLog –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

***

### 2Ô∏è‚É£9Ô∏è‚É£ **SNAPSHOT —Ö—Ä–∞–Ω–µ–Ω–∏–µ**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–°–∂–∏–º–∞—Ç—å –ª–∏ JSONB snapshots –∏–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –ö–∞–∫ –µ—Å—Ç—å (PostgreSQL TOAST –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∂–∏–º–∞–µ—Ç)**

**üéØ –§–∞–∫—Ç:**

- PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∂–∏–º–∞–µ—Ç –±–æ–ª—å—à–∏–µ JSONB —á–µ—Ä–µ–∑ TOAST
- –ù–µ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞

***

### 3Ô∏è‚É£0Ô∏è‚É£ **RETENTION POLICY –¥–ª—è –ª–æ–≥–æ–≤**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–£–¥–∞–ª—è—Ç—å –ª–∏ —Å—Ç–∞—Ä—ã–µ ActivityLog –∑–∞–ø–∏—Å–∏ –∏–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—á–Ω–æ?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ + –∞—Ä—Ö–∏–≤–∞—Ü–∏—è**

**üíª –°—Ç—Ä–∞—Ç–µ–≥–∏—è:**

```sql
-- Partition –ø–æ created_at (–µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏)
CREATE TABLE activity_log_2026_02 PARTITION OF activity_log
FOR VALUES FROM ('2026-02-01') TO ('2026-03-01');

-- –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π (>2 –≥–æ–¥–∞) –≤ S3
-- –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π >5 –ª–µ—Ç
```


***

## üìã **–ë–õ–û–ö 6: MIGRATIONS –ò SEEDS (5 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### 3Ô∏è‚É£1Ô∏è‚É£ **ZERO-DOWNTIME MIGRATIONS**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ö–∞–∫ –¥–µ–ª–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –±–µ–∑ downtime (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏, –∏–Ω–¥–µ–∫—Å–∞)?

**‚úÖ –ú–û–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø:**

**üíª Best Practices:**

```sql
-- ‚úÖ GOOD: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ nullable –∫–æ–ª–æ–Ω–∫–∏ (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
ALTER TABLE guest_card ADD COLUMN new_field TEXT;

-- ‚ùå BAD: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ NOT NULL –±–µ–∑ default (–±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É)
ALTER TABLE guest_card ADD COLUMN new_field TEXT NOT NULL;

-- ‚úÖ GOOD: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ NOT NULL —á–µ—Ä–µ–∑ –¥–≤–∞ —à–∞–≥–∞
ALTER TABLE guest_card ADD COLUMN new_field TEXT;
UPDATE guest_card SET new_field = 'default' WHERE new_field IS NULL;
ALTER TABLE guest_card ALTER COLUMN new_field SET NOT NULL;

-- ‚úÖ GOOD: –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
CREATE INDEX CONCURRENTLY idx_name ON table_name (column);

-- ‚úÖ GOOD: –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ —á–µ—Ä–µ–∑ –¥–≤–∞ —à–∞–≥–∞
-- 1. –£–±—Ä–∞—Ç—å –∏–∑ –∫–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
-- 2. –ü–æ—Ç–æ–º —É–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É
ALTER TABLE table_name DROP COLUMN old_column;
```


***

### 3Ô∏è‚É£2Ô∏è‚É£ **MIGRATION ROLLBACK —Å—Ç—Ä–∞—Ç–µ–≥–∏—è**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ü–∏—Å–∞—Ç—å –ª–∏ –æ–±—Ä–∞—Ç–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (down migrations) –¥–ª—è –∫–∞–∂–¥–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –î–ê, –Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—Ä–∞—Ç–∏–º—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**

**üíª –ü—Ä–∏–º–µ—Ä—ã:**

```prisma
// migration.sql
-- Up
ALTER TABLE guest_card ADD COLUMN email TEXT;

-- Down (–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
-- ALTER TABLE guest_card DROP COLUMN email;
```

**‚ùå –ù–µ–æ–±—Ä–∞—Ç–∏–º—ã–µ:**

- DROP COLUMN (–¥–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è–Ω—ã)
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ—Ç–µ—Ä–µ–π —Ç–æ—á–Ω–æ—Å—Ç–∏

***

### 3Ô∏è‚É£3Ô∏è‚É£ **SEED DATA —Å—Ç—Ä–∞—Ç–µ–≥–∏—è**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ö–∞–∫–∏–µ seed –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–ª—è dev/staging/production?

**‚úÖ –ú–û–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø:**

**üíª prisma/seed.ts:**

```typescript
async function seed() {
  const env = process.env.NODE_ENV;
  
  // Production: —Ç–æ–ª—å–∫–æ OWNER –∏ system data
  if (env === 'production') {
    await createOwnerUser();
    await createSystemPermissions();
    return;
  }
  
  // Staging: + demo tenant
  if (env === 'staging') {
    await createOwnerUser();
    await createSystemPermissions();
    await createDemoTenant();
    return;
  }
  
  // Development: –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä
  await createOwnerUser();
  await createSystemPermissions();
  await createDemoTenant();
  await createDemoRestaurants();
  await createDemoGuests();
  await createDemoTransactions();
}
```


***

### 3Ô∏è‚É£4Ô∏è‚É£ **MIGRATION TESTING**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –≤ production?

**‚úÖ –ú–û–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø:**

**üíª Process:**

1. –°–æ–∑–¥–∞—Ç—å –¥–∞–º–ø production –ë–î
2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ staging
3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (EXPLAIN ANALYZE)
6. –ï—Å–ª–∏ –û–ö ‚Üí –ø—Ä–∏–º–µ–Ω—è—Ç—å –≤ production
```bash
# Staging test
pg_dump production_db > dump.sql
psql staging_db < dump.sql
npx prisma migrate deploy
npm run test:integration
```


***

### 3Ô∏è‚É£5Ô∏è‚É£ **SCHEMA DRIFT –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ö–∞–∫ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å drift –º–µ–∂–¥—É Prisma schema –∏ —Ä–µ–∞–ª—å–Ω–æ–π –ë–î?

**‚úÖ –ú–û–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø:**

**üíª CI/CD Check:**

```yaml
# .github/workflows/ci.yml
- name: Check schema drift
  run: |
    npx prisma migrate diff \
      --from-schema-datamodel prisma/schema.prisma \
      --to-schema-datasource $DATABASE_URL \
      --exit-code
```


***

–¢–µ–ø–µ—Ä—å —É –Ω–∞—Å **35 –≤–æ–ø—Ä–æ—Å–æ–≤ —Å —Ä–µ—à–µ–Ω–∏—è–º–∏**! –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –ø–æ–ª–Ω–æ–π Prisma schema –∏–ª–∏ —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ? üéØ
<span style="display:none">[^4_1][^4_2][^4_3][^4_4][^4_5][^4_6][^4_7][^4_8]</span>

<div align="center">‚ÅÇ</div>

[^4_1]: Beseda-2.md

[^4_2]: Beseda-5.md

[^4_3]: Beseda-6.md

[^4_4]: Beseda-1.md

[^4_5]: Beseda-3.md

[^4_6]: Beseda-8.md

[^4_7]: Beseda-7.md

[^4_8]: Beseda-4.md


---

# ‚úÖ **–ë–ï–°–ï–î–ê 9: DATABASE SCHEMA (PRISMA) - –ò–¢–û–ì–û–í–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢**

## üéØ **–ü–†–ò–ù–Ø–¢–´–ï –†–ï–®–ï–ù–ò–Ø (35 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **–ë–õ–û–ö 1: ENUMS –ò –ë–ê–ó–û–í–´–ï –¢–ò–ü–´**

1. ‚úÖ **–ì–∏–±—Ä–∏–¥**: —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ ‚Üí PostgreSQL enum, –∏–∑–º–µ–Ω—è–µ–º—ã–µ ‚Üí —Ç–∞–±–ª–∏—Ü—ã
2. ‚úÖ **DECIMAL(10,2)** –¥–ª—è –¥–µ–Ω–µ–∂–Ω—ã—Ö —Å—É–º–º
3. ‚úÖ **UUID** –¥–ª—è –≤—Å–µ—Ö –ø–µ—Ä–≤–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π
4. ‚úÖ **Soft delete** –¥–ª—è User, GuestCard, –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
5. ‚úÖ **JSONB** –¥–ª—è snapshot –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤

### **–ë–õ–û–ö 2: MULTI-TENANCY –ò –ò–ó–û–õ–Ø–¶–ò–Ø**

6. ‚úÖ **–í—ã–±–æ—Ä–æ—á–Ω–æ** tenant_id (GuestCard, Transactions - –¥–∞, User - –Ω–µ—Ç)
7. ‚úÖ **Prisma middleware** –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ (–Ω–µ RLS)
8. ‚úÖ **Composite UNIQUE** (tenant_id, field) –¥–ª—è multi-tenant —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
9. ‚úÖ **TenantLimits —Ç–∞–±–ª–∏—Ü–∞** –¥–ª—è –ª–∏–º–∏—Ç–æ–≤ —Ç–∞—Ä–∏—Ñ–æ–≤
10. ‚úÖ **–ì–∏–±—Ä–∏–¥–Ω—ã–π CASCADE**: User ‚Üí RESTRICT, GuestCard/Transactions ‚Üí CASCADE

### **–ë–õ–û–ö 3: –ò–ù–î–ï–ö–°–´ –ò –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨**

11. ‚úÖ **Composite indexes**: tenant_id + —Ñ–∏–ª—å—Ç—Ä—É–µ–º—ã–µ –ø–æ–ª—è
12. ‚úÖ **Partial indexes**: `WHERE deleted_at IS NULL`
13. ‚úÖ **GIN index** –¥–ª—è Full-Text Search (–∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω)
14. ‚úÖ **Covering indexes** –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (—á–µ—Ä–µ–∑ migration)
15. ‚úÖ **BTREE** –≤–µ–∑–¥–µ (–Ω–µ HASH)
16. ‚úÖ **GIN –Ω–∞ JSONB** –¥–ª—è queryable –ø–æ–ª–µ–π
17. ‚úÖ **Expression indexes** (LOWER(email), DATE(created_at))
18. ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π VACUUM** + –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π REINDEX

### **–ë–õ–û–ö 4: RELATIONS –ò CONSTRAINTS**

19. ‚úÖ **User ‚Üî GuestProfile = 1:1**, User ‚Üî GuestCard = 1:Many
20. ‚úÖ **Self-reference** –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π –∫–∞—Ä—Ç
21. ‚úÖ **Nullable FK** –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
22. ‚úÖ **Junction table** UserRestaurantRole –¥–ª—è Many-to-Many
23. ‚úÖ **CHECK constraints** (balance >= 0, percentage 0-100)
24. ‚úÖ **–Ø–≤–Ω—ã–µ @@index** –Ω–∞ –≤—Å–µ—Ö FK
25. ‚úÖ **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º DEFERRABLE** constraints

### **–ë–õ–û–ö 5: VERSIONING –ò AUDIT**

26. ‚úÖ **Hybrid versioning**: LoyaltyRuleVersion —Ç–∞–±–ª–∏—Ü–∞ + JSONB snapshot
27. ‚úÖ **Row-level audit** —Å JSON diff
28. ‚úÖ **–ù–ï temporal tables** (—Ä—É—á–Ω–æ–π audit)
29. ‚úÖ **JSONB –±–µ–∑ —Å–∂–∞—Ç–∏—è** (PostgreSQL TOAST –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
30. ‚úÖ **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ActivityLog** + –∞—Ä—Ö–∏–≤–∞—Ü–∏—è >2 –ª–µ—Ç

### **–ë–õ–û–ö 6: MIGRATIONS –ò SEEDS**

31. ‚úÖ **Zero-downtime**: nullable ‚Üí default ‚Üí NOT NULL, CREATE INDEX CONCURRENTLY
32. ‚úÖ **Down migrations** —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—Ä–∞—Ç–∏–º—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
33. ‚úÖ **Seed —Å—Ç—Ä–∞—Ç–µ–≥–∏—è**: Production (Owner only), Staging (+ demo), Dev (full)
34. ‚úÖ **Migration testing**: –¥–∞–º–ø ‚Üí staging ‚Üí test ‚Üí production
35. ‚úÖ **CI/CD drift check**: `prisma migrate diff`

***

## üìÑ **–ü–û–õ–ù–ê–Ø PRISMA SCHEMA**

```prisma
// ============================================
// MAX-LOYALTY MULTI-TENANT SAAS
// Prisma Schema v1.0
// PostgreSQL 15+
// ============================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  OWNER
  RESTAURANT_ADMIN
  MANAGER
  CASHIER
  GUEST
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum CardStatus {
  ACTIVE
  BLOCKED
  DELETED
  MIGRATED
}

enum RegistrationSource {
  POS
  LINK
  TELEGRAM
}

enum BallTransactionType {
  EARN
  REDEEM
  MANUAL_ADD
  MANUAL_SUBTRACT
  PROMO
  EXPIRE
  TRANSFER_SENT
  TRANSFER_RECEIVED
  REFUND
  CANCEL
}

enum SubscriptionPlan {
  FREE
  STANDARD
  MEDIUM
  PRO
  ULTIMATE
  CUSTOM
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  NON_PAYMENT
  TRIAL
}

enum BillingPeriod {
  MONTHLY
  YEARLY
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentProvider {
  YOOKASSA
  STRIPE
  CLOUDPAYMENTS
  CRYPTOCCLOUD
  MANUAL
}

enum POSSystem {
  IIKO
  RKEEPER
  CUSTOM
  MANUAL
}

enum SyncStatus {
  SUCCESS
  FAILED
  PARTIAL
  PENDING
}

enum LoyaltySystemType {
  POINTS
  DISCOUNT
}

enum LoyaltyCardMode {
  UNIFIED
  SEPARATE
}

enum PromoTriggerType {
  BIRTHDAY_GUEST
  BIRTHDAY_CHILD
  FIRST_CHECK
  INACTIVITY
  WEEKDAY
  TIME_RANGE
  CHECK_AMOUNT
  CUSTOM
}

enum ConflictResolutionStrategy {
  COMBINE_ALL
  MAX_ONLY
  FIRST_ONLY
}

enum NotificationChannel {
  TELEGRAM
  EMAIL
  SMS
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ
}

enum ActivityLogAction {
  // Auth
  USER_LOGIN
  USER_LOGOUT
  PASSWORD_RESET
  EMAIL_VERIFIED
  PHONE_VERIFIED
  
  // Loyalty
  LOYALTY_RULE_CREATED
  LOYALTY_RULE_UPDATED
  LOYALTY_RULE_DELETED
  LOYALTY_RULE_ROLLBACK
  LEVEL_CREATED
  LEVEL_UPDATED
  LEVEL_DELETED
  PROMO_CREATED
  PROMO_UPDATED
  PROMO_DELETED
  
  // Balls
  BALLS_EARNED
  BALLS_REDEEMED
  BALLS_MANUAL_ADD
  BALLS_MANUAL_SUBTRACT
  BALLS_EXPIRED
  BALLS_TRANSFERRED
  BALLS_REFUNDED
  
  // Cards
  CARD_CREATED
  CARD_BLOCKED
  CARD_UNBLOCKED
  CARD_DELETED
  
  // System
  MIGRATION_STARTED
  MIGRATION_COMPLETED
  RECONCILIATION_RUN
  IMPERSONATION_STARTED
  IMPERSONATION_ENDED
  
  // POS
  POS_INTEGRATION_CONNECTED
  POS_INTEGRATION_DISCONNECTED
  POS_SYNC_SUCCESS
  POS_SYNC_FAILED
}

enum TransferStatus {
  PENDING
  VERIFIED
  COMPLETED
  CANCELLED
}

// ============================================
// CORE: USERS & AUTH
// ============================================

model User {
  id                String    @id @default(uuid())
  
  // Credentials
  email             String?   @unique
  phone             String    @unique
  telegram_id       String?   @unique
  password_hash     String?
  
  // Role & Status
  role              UserRole  @default(GUEST)
  email_verified    Boolean   @default(false)
  phone_verified    Boolean   @default(false)
  is_blocked        Boolean   @default(false)
  blocked_reason    String?
  
  // Timestamps
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  deleted_at        DateTime?
  last_login_at     DateTime?
  
  // Relations
  guest_profile           GuestProfile?
  guest_cards             GuestCard[]
  user_roles              UserTenantRole[]
  user_restaurant_roles   UserRestaurantRole[]
  sessions                UserSession[]
  password_reset_tokens   PasswordResetToken[]
  activity_logs           ActivityLog[]       @relation("ActivityLogActor")
  
  // Ball Transactions
  created_ball_transactions BallTransaction[] @relation("BallTransactionCreator")
  
  // Loyalty versions
  created_rule_versions   LoyaltyRuleVersion[]
  created_level_versions  LoyaltyLevelVersion[]
  created_promo_versions  LoyaltyPromoVersion[]
  
  // Impersonation
  impersonation_sessions  ImpersonationSession[] @relation("ImpersonatorUser")
  impersonated_sessions   ImpersonationSession[] @relation("ImpersonatedUser")
  
  @@index([phone])
  @@index([email])
  @@index([telegram_id])
  @@index([role])
  @@index([deleted_at])
  @@index([is_blocked])
}

model UserSession {
  id                String    @id @default(uuid())
  user_id           String
  user              User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  refresh_token     String    @unique
  is_blacklisted    Boolean   @default(false)
  
  ip_address        String?
  user_agent        String?
  
  expires_at        DateTime
  created_at        DateTime  @default(now())
  
  @@index([user_id])
  @@index([refresh_token])
  @@index([expires_at])
}

model PasswordResetToken {
  id         String    @id @default(uuid())
  user_id    String
  user       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  token      String    @unique
  expires_at DateTime
  used_at    DateTime?
  
  created_at DateTime  @default(now())
  
  @@index([user_id])
  @@index([token])
  @@index([expires_at])
}

model ImpersonationSession {
  id                    String    @id @default(uuid())
  
  impersonator_user_id  String
  impersonator_user     User      @relation("ImpersonatorUser", fields: [impersonator_user_id], references: [id], onDelete: Cascade)
  
  impersonated_user_id  String
  impersonated_user     User      @relation("ImpersonatedUser", fields: [impersonated_user_id], references: [id], onDelete: Cascade)
  
  reason                String
  
  started_at            DateTime  @default(now())
  ended_at              DateTime?
  
  @@index([impersonator_user_id])
  @@index([impersonated_user_id])
  @@index([started_at])
}

// ============================================
// CORE: TENANTS & RESTAURANTS
// ============================================

model Tenant {
  id                String    @id @default(uuid())
  
  // Basic Info
  name              String
  slug              String    @unique
  description       String?
  
  // Contact
  contact_email     String?
  contact_phone     String?
  website_url       String?
  
  // Branding
  logo_url          String?
  primary_color     String?
  
  // Status
  is_active         Boolean   @default(true)
  blocked_reason    String?
  
  // Timestamps
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  deleted_at        DateTime?
  
  // Relations
  restaurants           Restaurant[]
  user_roles            UserTenantRole[]
  subscription          Subscription?
  tenant_limits         TenantLimits?
  billing_info          BillingInfo?
  
  loyalty_system        LoyaltySystem?
  loyalty_rules         LoyaltyRule[]
  loyalty_levels        LoyaltyLevel[]
  loyalty_promos        LoyaltyPromo[]
  
  guest_cards           GuestCard[]
  ball_transactions     BallTransaction[]
  guest_visits          GuestVisit[]
  promo_ball_granted    PromoBallGranted[]
  
  pos_integrations      POSIntegration[]
  pos_transactions      POSTransaction[]
  
  registration_links    RegistrationLink[]
  
  telegram_bots         TelegramBot[]
  
  notifications         Notification[]
  activity_logs         ActivityLog[]
  
  analytics_daily       AnalyticsDailySnapshot[]
  analytics_monthly     AnalyticsMonthlySnapshot[]
  
  @@index([slug])
  @@index([is_active])
  @@index([deleted_at])
}

model Restaurant {
  id                String    @id @default(uuid())
  tenant_id         String
  tenant            Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  // Basic Info
  name              String
  slug              String
  description       String?
  
  // Address
  city              String?
  address           String?
  latitude          Decimal?  @db.Decimal(10, 8)
  longitude         Decimal?  @db.Decimal(11, 8)
  
  // Contact
  phone             String?
  email             String?
  
  // Status
  is_active         Boolean   @default(true)
  
  // Timestamps
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  deleted_at        DateTime?
  
  // Relations
  user_restaurant_roles UserRestaurantRole[]
  guest_cards           GuestCard[]
  ball_transactions     BallTransaction[]
  guest_visits          GuestVisit[]
  pos_integrations      POSIntegration[]
  pos_transactions      POSTransaction[]
  telegram_bots         TelegramBot[]
  
  analytics_daily       AnalyticsDailySnapshot[]
  analytics_monthly     AnalyticsMonthlySnapshot[]
  
  @@unique([tenant_id, slug])
  @@index([tenant_id])
  @@index([is_active])
  @@index([deleted_at])
}

// ============================================
// CORE: RBAC (Role-Based Access Control)
// ============================================

model UserTenantRole {
  id          String    @id @default(uuid())
  user_id     String
  user        User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  tenant_id   String
  tenant      Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  role        UserRole
  
  created_at  DateTime  @default(now())
  
  @@unique([user_id, tenant_id, role])
  @@index([tenant_id])
  @@index([role])
}

model UserRestaurantRole {
  id             String     @id @default(uuid())
  user_id        String
  user           User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  restaurant_id  String
  restaurant     Restaurant @relation(fields: [restaurant_id], references: [id], onDelete: Cascade)
  
  role           UserRole   // MANAGER, CASHIER
  
  created_at     DateTime   @default(now())
  
  @@unique([user_id, restaurant_id, role])
  @@index([restaurant_id])
  @@index([role])
}

// ============================================
// BILLING & SUBSCRIPTIONS
// ============================================

model Subscription {
  id                String             @id @default(uuid())
  tenant_id         String             @unique
  tenant            Tenant             @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  // Plan
  plan              SubscriptionPlan
  status            SubscriptionStatus @default(TRIAL)
  
  // Billing
  billing_period    BillingPeriod      @default(MONTHLY)
  price_monthly     Decimal            @db.Decimal(10, 2)
  price_yearly      Decimal?           @db.Decimal(10, 2)
  currency          String             @default("RUB")
  
  // Dates
  trial_ends_at     DateTime?
  current_period_start DateTime
  current_period_end   DateTime
  cancelled_at      DateTime?
  
  // Auto-renewal
  auto_renew        Boolean            @default(true)
  
  created_at        DateTime           @default(now())
  updated_at        DateTime           @updatedAt
  
  // Relations
  payments          Payment[]
  
  @@index([status])
  @@index([current_period_end])
}

model TenantLimits {
  id                    String   @id @default(uuid())
  tenant_id             String   @unique
  tenant                Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  // Limits (NULL = unlimited)
  max_restaurants       Int?
  max_guests            Int?
  max_pos_integrations  Int?
  max_admin_users       Int?
  max_storage_mb        Int?
  
  // Current usage (cache)
  current_restaurants   Int      @default(0)
  current_guests        Int      @default(0)
  current_pos_integrations Int   @default(0)
  current_admin_users   Int      @default(0)
  current_storage_mb    Int      @default(0)
  
  // Warning thresholds
  warning_threshold_pct Int      @default(90)
  
  updated_at            DateTime @updatedAt
}

model BillingInfo {
  id                String   @id @default(uuid())
  tenant_id         String   @unique
  tenant            Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  // Company
  company_name      String?
  tax_id            String?  // –ò–ù–ù
  
  // Address
  billing_address   String?
  city              String?
  postal_code       String?
  country           String?  @default("RU")
  
  // Payment method
  payment_provider  PaymentProvider?
  payment_method_id String?  // External payment method ID
  
  // Contact
  billing_email     String?
  billing_phone     String?
  
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
}

model Payment {
  id                String        @id @default(uuid())
  subscription_id   String
  subscription      Subscription  @relation(fields: [subscription_id], references: [id], onDelete: Cascade)
  
  // Payment details
  amount            Decimal       @db.Decimal(10, 2)
  currency          String        @default("RUB")
  status            PaymentStatus @default(PENDING)
  
  // Provider
  payment_provider  PaymentProvider
  external_payment_id String?     @unique
  
  // Metadata
  payment_method    String?
  description       String?
  error_message     String?
  
  // Dates
  paid_at           DateTime?
  refunded_at       DateTime?
  
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt
  
  @@index([subscription_id])
  @@index([status])
  @@index([created_at])
}

// ============================================
// GUESTS & LOYALTY CARDS
// ============================================

model GuestProfile {
  id                       String     @id @default(uuid())
  user_id                  String     @unique
  user                     User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  // Personal Info
  first_name               String
  last_name                String?
  middle_name              String?
  gender                   Gender?
  birth_date               DateTime?
  avatar_url               String?
  
  // Consents
  privacy_policy_accepted  Boolean    @default(false)
  marketing_accepted       Boolean    @default(false)
  
  // Address
  city                     String?
  address                  String?
  
  // Telegram
  telegram_username        String?
  telegram_photo_url       String?
  
  // Profile completion
  profile_completeness     Int        @default(0)
  
  // Edit restrictions
  last_profile_update      DateTime   @default(now())
  
  created_at               DateTime   @default(now())
  updated_at               DateTime   @updatedAt
  
  // Relations
  children                 GuestChild[]
  
  @@index([user_id])
  @@index([birth_date])
}

model GuestChild {
  id               String        @id @default(uuid())
  guest_profile_id String
  guest_profile    GuestProfile  @relation(fields: [guest_profile_id], references: [id], onDelete: Cascade)
  
  name             String
  birth_date       DateTime
  
  created_at       DateTime      @default(now())
  updated_at       DateTime      @updatedAt
  deleted_at       DateTime?
  
  @@index([guest_profile_id])
  @@index([birth_date])
  @@index([deleted_at])
}

model GuestCard {
  id                    String          @id @default(uuid())
  
  // User
  user_id               String
  user                  User            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  // Tenant/Restaurant
  tenant_id             String
  tenant                Tenant          @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  restaurant_id         String?
  restaurant            Restaurant?     @relation(fields: [restaurant_id], references: [id], onDelete: SetNull)
  
  // Codes
  qr_code               String          @unique
  code_6_digit          String          @unique
  
  // Balances
  regular_balance       Int             @default(0)
  promo_balance         Int             @default(0)
  
  // Computed total balance (regular + promo)
  // total_balance = regular_balance + promo_balance
  
  // Lifetime stats
  lifetime_spent        Decimal         @default(0) @db.Decimal(12, 2)
  lifetime_earned_points Int            @default(0)
  lifetime_redeemed_points Int          @default(0)
  total_visits          Int             @default(0)
  
  // Loyalty Level
  loyalty_level_id      String?
  loyalty_level         LoyaltyLevel?   @relation(fields: [loyalty_level_id], references: [id], onDelete: SetNull)
  
  // Status
  status                CardStatus      @default(ACTIVE)
  block_reason          String?
  blocked_by_user_id    String?
  blocked_at            DateTime?
  
  // Activity
  last_visit_at         DateTime?
  last_activity_at      DateTime        @default(now())
  
  // Registration
  registration_source   RegistrationSource
  registration_link_id  String?
  registration_link     RegistrationLink? @relation(fields: [registration_link_id], references: [id], onDelete: SetNull)
  
  // Expiration
  balls_expire_at       DateTime?
  
  // Migration
  migrated_to_card_id   String?
  migrated_to_card      GuestCard?      @relation("CardMigration", fields: [migrated_to_card_id], references: [id])
  migrated_from_cards   GuestCard[]     @relation("CardMigration")
  
  created_at            DateTime        @default(now())
  updated_at            DateTime        @updatedAt
  deleted_at            DateTime?
  
  // Relations
  ball_transactions       BallTransaction[]
  guest_visits            GuestVisit[]
  promo_grants            PromoBallGranted[]
  ball_transfers_sent     BallTransfer[]    @relation("BallTransferSender")
  ball_transfers_received BallTransfer[]    @relation("BallTransferReceiver")
  
  @@unique([user_id, tenant_id, restaurant_id])
  @@index([tenant_id, status, last_visit_at])
  @@index([tenant_id, loyalty_level_id])
  @@index([restaurant_id])
  @@index([qr_code])
  @@index([code_6_digit])
  @@index([status])
  @@index([last_visit_at])
  @@index([last_activity_at])
  @@index([deleted_at])
  @@index([migrated_to_card_id])
}

model BallTransaction {
  id                String              @id @default(uuid())
  
  // Card
  guest_card_id     String
  guest_card        GuestCard           @relation(fields: [guest_card_id], references: [id], onDelete: Cascade)
  
  // Tenant/Restaurant
  tenant_id         String
  tenant            Tenant              @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  restaurant_id     String?
  restaurant        Restaurant?         @relation(fields: [restaurant_id], references: [id], onDelete: SetNull)
  
  // Transaction type
  type              BallTransactionType
  
  // Amount
  amount            Int
  balance_type      String              @default("REGULAR") // "REGULAR" or "PROMO"
  
  // Balances before/after
  regular_balance_before Int
  regular_balance_after  Int
  promo_balance_before   Int
  promo_balance_after    Int
  
  // Details
  description       String
  reason            String?
  
  // POS Check
  check_amount      Decimal?            @db.Decimal(10, 2)
  pos_transaction_id String?
  pos_transaction   POSTransaction?     @relation(fields: [pos_transaction_id], references: [id], onDelete: SetNull)
  
  // Loyalty Rule/Promo (versioned snapshot)
  loyalty_rule_id         String?
  loyalty_rule            LoyaltyRule?       @relation(fields: [loyalty_rule_id], references: [id], onDelete: SetNull)
  loyalty_rule_version_id String?
  rule_snapshot           Json?
  
  promo_id                String?
  promo                   LoyaltyPromo?      @relation(fields: [promo_id], references: [id], onDelete: SetNull)
  promo_version_id        String?
  promo_snapshot          Json?
  
  // Creator
  created_by_user_id String?
  created_by        User?               @relation("BallTransactionCreator", fields: [created_by_user_id], references: [id], onDelete: SetNull)
  
  // Cancellation
  is_cancelled      Boolean             @default(false)
  cancelled_at      DateTime?
  cancelled_by_user_id String?
  cancellation_reason String?
  
  created_at        DateTime            @default(now())
  
  @@index([guest_card_id, created_at(sort: Desc)])
  @@index([tenant_id, restaurant_id, created_at(sort: Desc)])
  @@index([tenant_id, type, created_at])
  @@index([pos_transaction_id])
  @@index([loyalty_rule_id])
  @@index([promo_id])
  @@index([is_cancelled])
}

model GuestVisit {
  id                String      @id @default(uuid())
  
  guest_card_id     String
  guest_card        GuestCard   @relation(fields: [guest_card_id], references: [id], onDelete: Cascade)
  
  tenant_id         String
  tenant            Tenant      @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  restaurant_id     String?
  restaurant        Restaurant? @relation(fields: [restaurant_id], references: [id], onDelete: SetNull)
  
  // Visit details
  visit_date        DateTime
  check_amount      Decimal     @db.Decimal(10, 2)
  
  // POS Transaction
  pos_transaction_id String?    @unique
  pos_transaction   POSTransaction? @relation(fields: [pos_transaction_id], references: [id], onDelete: SetNull)
  
  // Status
  is_cancelled      Boolean     @default(false)
  
  created_at        DateTime    @default(now())
  
  @@index([guest_card_id, visit_date(sort: Desc)])
  @@index([tenant_id, restaurant_id, visit_date])
  @@index([pos_transaction_id])
}

model BallTransfer {
  id                String         @id @default(uuid())
  
  // Sender
  sender_card_id    String
  sender_card       GuestCard      @relation("BallTransferSender", fields: [sender_card_id], references: [id], onDelete: Cascade)
  
  // Receiver
  receiver_card_id  String
  receiver_card     GuestCard      @relation("BallTransferReceiver", fields: [receiver_card_id], references: [id], onDelete: Cascade)
  
  // Amount
  amount            Int
  
  // Status
  status            TransferStatus @default(PENDING)
  
  // Verification
  verification_code String?
  verified_at       DateTime?
  
  // Metadata
  reason            String?
  
  created_at        DateTime       @default(now())
  completed_at      DateTime?
  
  @@index([sender_card_id])
  @@index([receiver_card_id])
  @@index([status])
}

model RegistrationLink {
  id                String      @id @default(uuid())
  tenant_id         String
  tenant            Tenant      @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  // Link details
  slug              String      @unique
  name              String
  description       String?
  
  // Limits
  max_uses          Int?
  current_uses      Int         @default(0)
  
  // Status
  is_active         Boolean     @default(true)
  expires_at        DateTime?
  
  created_at        DateTime    @default(now())
  
  // Relations
  guest_cards       GuestCard[]
  
  @@index([tenant_id])
  @@index([slug])
  @@index([is_active, expires_at])
}

// ============================================
// LOYALTY SYSTEM
// ============================================

model LoyaltySystem {
  id                            String              @id @default(uuid())
  tenant_id                     String              @unique
  tenant                        Tenant              @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  // System type
  system_type                   LoyaltySystemType   // POINTS or DISCOUNT
  card_mode                     LoyaltyCardMode     // UNIFIED or SEPARATE
  
  // Ball = Ruble (fixed)
  ball_to_ruble_ratio           Decimal             @default(1.00) @db.Decimal(5, 2) // Always 1.00
  
  // Earning rules
  default_earn_percentage       Int                 @default(5)    // 5% default
  
  // Redemption limits
  min_check_amount              Decimal             @default(50)   @db.Decimal(10, 2) // Fixed 50 RUB
  min_balls_to_redeem           Int                 @default(1)    // Min 1 ball
  max_redeem_percentage         Int                 @default(20)   // 10-100%, default 20%
  
  // Expiration settings
  inactivity_expire_days        Int                 @default(90)   // Min 90 days
  notify_before_expire_days     Int                 @default(7)    // Notify 7 days before
  
  // Promo conflicts
  conflict_resolution_strategy  ConflictResolutionStrategy @default(COMBINE_ALL)
  
  // Transfer settings
  allow_transfers               Boolean             @default(false)
  min_transfer_amount           Int?
  max_transfer_amount           Int?
  max_transfers_per_day         Int?
  
  created_at                    DateTime            @default(now())
  updated_at                    DateTime            @updatedAt
}

model LoyaltyRule {
  id                String              @id @default(uuid())
  tenant_id         String
  tenant            Tenant              @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  // Basic info
  name              String
  description       String?
  
  // Rule config (current active)
  is_active         Boolean             @default(true)
  priority          Int                 @default(100)
  
  // Conditions (JSONB)
  conditions        Json?
  
  // Reward config (JSONB)
  reward_config     Json
  
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt
  deleted_at        DateTime?
  
  // Relations
  versions          LoyaltyRuleVersion[]
  ball_transactions BallTransaction[]
  
  @@index([tenant_id, is_active])
  @@index([deleted_at])
}

model LoyaltyRuleVersion {
  id                String       @id @default(uuid())
  loyalty_rule_id   String
  loyalty_rule      LoyaltyRule  @relation(fields: [loyalty_rule_id], references: [id], onDelete: Cascade)
  
  version_number    Int
  
  // Full config snapshot
  config            Json
  
  // Active period
  active_from       DateTime
  active_to         DateTime?
  
  // Creator
  created_by_user_id String
  created_by        User         @relation(fields: [created_by_user_id], references: [id], onDelete: Restrict)
  
  reason            String?
  
  created_at        DateTime     @default(now())
  
  @@unique([loyalty_rule_id, version_number])
  @@index([loyalty_rule_id, active_from, active_to])
}

model LoyaltyLevel {
  id                String              @id @default(uuid())
  tenant_id         String
  tenant            Tenant              @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  // Basic info
  name              String
  description       String?
  
  // Threshold (based on lifetime_spent)
  threshold         Decimal             @db.Decimal(12, 2)
  
  // Rank (for sorting)
  rank              Int
  
  // Visual
  color             String?             // Hex color
  icon              String?             // Emoji or icon name
  image_url         String?
  
  // Benefits (JSONB)
  benefits          Json?
  
  // Status
  is_active         Boolean             @default(true)
  
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt
  deleted_at        DateTime?
  
  // Relations
  versions          LoyaltyLevelVersion[]
  guest_cards       GuestCard[]
  
  @@unique([tenant_id, rank])
  @@index([tenant_id, is_active, rank])
  @@index([threshold])
  @@index([deleted_at])
}

model LoyaltyLevelVersion {
  id                String       @id @default(uuid())
  loyalty_level_id  String
  loyalty_level     LoyaltyLevel @relation(fields: [loyalty_level_id], references: [id], onDelete: Cascade)
  
  version_number    Int
  config            Json
  
  active_from       DateTime
  active_to         DateTime?
  
  created_by_user_id String
  created_by        User         @relation(fields: [created_by_user_id], references: [id], onDelete: Restrict)
  
  reason            String?
  
  created_at        DateTime     @default(now())
  
  @@unique([loyalty_level_id, version_number])
  @@index([loyalty_level_id, active_from, active_to])
}

model LoyaltyPromo {
  id                String              @id @default(uuid())
  tenant_id         String
  tenant            Tenant              @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  // Basic info
  name              String
  description       String?
  
  // Trigger
  trigger_type      PromoTriggerType
  
  // Conditions (JSONB)
  conditions        Json
  
  // Reward (JSONB)
  reward_config     Json
  
  // Priority (for conflicts)
  priority          Int                 @default(500)
  
  // Active period
  is_active         Boolean             @default(true)
  starts_at         DateTime?
  ends_at           DateTime?
  
  // Limits
  max_uses_total    Int?
  max_uses_per_guest Int?
  current_uses      Int                 @default(0)
  
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt
  deleted_at        DateTime?
  
  // Relations
  versions          LoyaltyPromoVersion[]
  ball_transactions BallTransaction[]
  promo_grants      PromoBallGranted[]
  
  @@index([tenant_id, is_active, starts_at, ends_at])
  @@index([trigger_type])
  @@index([deleted_at])
}

model LoyaltyPromoVersion {
  id                String       @id @default(uuid())
  loyalty_promo_id  String
  loyalty_promo     LoyaltyPromo @relation(fields: [loyalty_promo_id], references: [id], onDelete: Cascade)
  
  version_number    Int
  config            Json
  
  active_from       DateTime
  active_to         DateTime?
  
  created_by_user_id String
  created_by        User         @relation(fields: [created_by_user_id], references: [id], onDelete: Restrict)
  
  reason            String?
  
  created_at        DateTime     @default(now())
  
  @@unique([loyalty_promo_id, version_number])
  @@index([loyalty_promo_id, active_from, active_to])
}

model PromoBallGranted {
  id                String       @id @default(uuid())
  tenant_id         String
  tenant            Tenant       @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  guest_card_id     String
  guest_card        GuestCard    @relation(fields: [guest_card_id], references: [id], onDelete: Cascade)
  
  promo_id          String
  promo             LoyaltyPromo @relation(fields: [promo_id], references: [id], onDelete: Cascade)
  
  // Grant details
  amount_initial    Int
  amount_remaining  Int
  
  // Expiration
  granted_at        DateTime     @default(now())
  expires_at        DateTime?
  
  // Snapshot
  promo_snapshot    Json
  
  @@index([tenant_id, guest_card_id])
  @@index([promo_id])
  @@index([expires_at])
}

// ============================================
// POS INTEGRATION
// ============================================

model POSIntegration {
  id                String      @id @default(uuid())
  tenant_id         String
  tenant            Tenant      @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  restaurant_id     String?
  restaurant        Restaurant? @relation(fields: [restaurant_id], references: [id], onDelete: SetNull)
  
  // POS System
  pos_system        POSSystem
  
  // Connection config (JSONB - encrypted)
  config            Json
  
  // Webhook
  webhook_url       String?
  webhook_secret    String?
  
  // Sync settings
  pull_interval_minutes Int      @default(30)
  last_pull_at      DateTime?
  
  // Status
  is_active         Boolean     @default(true)
  last_sync_status  SyncStatus?
  last_sync_at      DateTime?
  last_error        String?
  
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt
  
  // Relations
  pos_transactions  POSTransaction[]
  
  @@index([tenant_id, restaurant_id])
  @@index([is_active])
}

model POSTransaction {
  id                String         @id @default(uuid())
  tenant_id         String
  tenant            Tenant         @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  restaurant_id     String?
  restaurant        Restaurant?    @relation(fields: [restaurant_id], references: [id], onDelete: SetNull)
  
  pos_integration_id String
  pos_integration   POSIntegration @relation(fields: [pos_integration_id], references: [id], onDelete: Cascade)
  
  // POS data
  pos_system        POSSystem
  pos_check_id      String         // External check ID
  pos_unit_id       String?        // POS unit/terminal ID
  
  // Transaction details
  transaction_type  String         @default("SALE") // SALE, REFUND, CANCEL
  check_amount      Decimal        @db.Decimal(10, 2)
  transaction_date  DateTime
  
  // Guest (if identified)
  guest_identifier  String?        // Phone or card code
  
  // Loyalty data
  balls_earned      Int?
  balls_redeemed    Int?
  
  // Sync status
  sync_status       SyncStatus     @default(PENDING)
  synced_at         DateTime?
  
  // Raw data
  raw_data          Json?
  
  created_at        DateTime       @default(now())
  updated_at        DateTime       @updatedAt
  
  // Relations
  ball_transactions BallTransaction[]
  guest_visits      GuestVisit[]
  
  @@unique([tenant_id, pos_system, pos_check_id])
  @@index([tenant_id, restaurant_id, transaction_date])
  @@index([pos_integration_id])
  @@index([sync_status])
  @@index([guest_identifier])
}

// ============================================
// TELEGRAM BOT
// ============================================

model TelegramBot {
  id                String      @id @default(uuid())
  tenant_id         String
  tenant            Tenant      @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  restaurant_id     String?
  restaurant        Restaurant? @relation(fields: [restaurant_id], references: [id], onDelete: SetNull)
  
  // Bot info
  bot_token         String      @unique // Encrypted
  bot_username      String      @unique
  bot_name          String
  
  // Webhook
  webhook_url       String?
  
  // Status
  is_active         Boolean     @default(true)
  
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt
  
  @@index([tenant_id, restaurant_id])
  @@index([is_active])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id                String              @id @default(uuid())
  tenant_id         String
  tenant            Tenant              @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  // Recipient
  user_id           String
  
  // Notification details
  title             String
  message           String
  
  // Channel
  channel           NotificationChannel
  status            NotificationStatus  @default(PENDING)
  
  // Metadata
  metadata          Json?
  
  // Delivery
  sent_at           DateTime?
  read_at           DateTime?
  error_message     String?
  
  created_at        DateTime            @default(now())
  
  @@index([tenant_id, user_id, status])
  @@index([channel, status])
  @@index([created_at])
}

// ============================================
// ANALYTICS
// ============================================

model AnalyticsDailySnapshot {
  id                String      @id @default(uuid())
  tenant_id         String
  tenant            Tenant      @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  restaurant_id     String?
  restaurant        Restaurant? @relation(fields: [restaurant_id], references: [id], onDelete: SetNull)
  
  date              DateTime    @db.Date
  
  // Revenue
  total_revenue     Decimal     @default(0) @db.Decimal(12, 2)
  total_checks      Int         @default(0)
  avg_check         Decimal     @default(0) @db.Decimal(10, 2)
  
  // Guests
  total_visits      Int         @default(0)
  active_guests     Int         @default(0)
  new_guests        Int         @default(0)
  
  // Balls
  total_balls_granted   Int     @default(0)
  total_balls_redeemed  Int     @default(0)
  total_balls_expired   Int     @default(0)
  promo_balls_granted   Int     @default(0)
  
  // Promo
  promo_activations Int         @default(0)
  
  created_at        DateTime    @default(now())
  
  @@unique([tenant_id, restaurant_id, date])
  @@index([tenant_id, date])
  @@index([restaurant_id, date])
}

model AnalyticsMonthlySnapshot {
  id                String      @id @default(uuid())
  tenant_id         String
  tenant            Tenant      @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  restaurant_id     String?
  restaurant        Restaurant? @relation(fields: [restaurant_id], references: [id], onDelete: SetNull)
  
  year              Int
  month             Int
  
  // Revenue
  total_revenue     Decimal     @default(0) @db.Decimal(12, 2)
  total_checks      Int         @default(0)
  avg_check         Decimal     @default(0) @db.Decimal(10, 2)
  
  // Guests
  total_visits      Int         @default(0)
  active_guests     Int         @default(0)
  new_guests        Int         @default(0)
  sleeping_guests   Int         @default(0)
  lost_guests       Int         @default(0)
  avg_frequency     Decimal     @default(0) @db.Decimal(5, 2)
  
  // Balls
  total_balls_granted   Int     @default(0)
  total_balls_redeemed  Int     @default(0)
  total_balls_expired   Int     @default(0)
  avg_balance       Int         @default(0)
  
  // ROI
  loyalty_cost      Decimal     @default(0) @db.Decimal(12, 2)
  loyalty_revenue   Decimal     @default(0) @db.Decimal(12, 2)
  loyalty_roi       Decimal     @default(0) @db.Decimal(5, 2)
  
  created_at        DateTime    @default(now())
  
  @@unique([tenant_id, restaurant_id, year, month])
  @@index([tenant_id, year, month])
  @@index([restaurant_id, year, month])
}

// ============================================
// AUDIT & ACTIVITY LOG
// ============================================

model ActivityLog {
  id              String            @id @default(uuid())
  tenant_id       String?
  tenant          Tenant?           @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  
  // Action
  action          ActivityLogAction
  entity_type     String?
  entity_id       String?
  
  // Actor
  actor_user_id   String?
  actor_user      User?             @relation("ActivityLogActor", fields: [actor_user_id], references: [id], onDelete: SetNull)
  
  // Changes (JSON diff)
  changes         Json?
  
  // Metadata
  metadata        Json?
  
  // Request info
  ip_address      String?
  user_agent      String?
  
  created_at      DateTime          @default(now())
  
  @@index([tenant_id, created_at(sort: Desc)])
  @@index([entity_type, entity_id])
  @@index([actor_user_id])
  @@index([action])
}
```


***

## üéâ **–ò–¢–û–ì–û: 45+ –¢–ê–ë–õ–ò–¶, 15+ ENUMS, 200+ –ü–û–õ–ï–ô**

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

1. ‚úÖ **Core** (Users, Auth, Tenants, Restaurants) - 15 —Ç–∞–±–ª–∏—Ü
2. ‚úÖ **RBAC** (Roles, Permissions) - 2 —Ç–∞–±–ª–∏—Ü—ã
3. ‚úÖ **Billing** (Subscriptions, Payments) - 5 —Ç–∞–±–ª–∏—Ü
4. ‚úÖ **Guests \& Cards** (Profiles, Cards, Transactions) - 7 —Ç–∞–±–ª–∏—Ü
5. ‚úÖ **Loyalty System** (Rules, Levels, Promos, Versions) - 10 —Ç–∞–±–ª–∏—Ü
6. ‚úÖ **POS Integration** - 2 —Ç–∞–±–ª–∏—Ü—ã
7. ‚úÖ **Telegram** - 1 —Ç–∞–±–ª–∏—Ü–∞
8. ‚úÖ **Notifications** - 1 —Ç–∞–±–ª–∏—Ü–∞
9. ‚úÖ **Analytics** - 2 —Ç–∞–±–ª–∏—Ü—ã
10. ‚úÖ **Audit** - 1 —Ç–∞–±–ª–∏—Ü–∞

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üöÄ

