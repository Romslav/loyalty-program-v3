

# API Documentation –¥–µ–ª–∞–µ–º. –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å—ã + –ø—Ä–µ–¥–ª–æ–∂–∏ –ª—É—á—à–∏–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã —Å–∞–º —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º

–ò–∑—É—á–∏–≤ –ë–µ—Å–µ–¥—É-13 –¥–µ—Ç–∞–ª—å–Ω–æ, —è –≤–∏–∂—É —á—Ç–æ –≤–æ–ø—Ä–æ—Å—ã 1‚Äì30 –ø–æ API Documentation **—É–∂–µ –±—ã–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω—ã** –≤ —Ç–æ–π –±–µ—Å–µ–¥–µ (—è –æ—à–∏–±—Å—è –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ—Ç–≤–µ—Ç–µ, –Ω–∞–ø–∏—Å–∞–≤ ¬´0/15¬ª). –ù–∏–∂–µ ‚Äî –ø–æ–ª–Ω—ã–π –±–ª–æ–∫, –∫–∞–∫ –æ–Ω –±—ã–ª –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω, –ø–ª—é—Å **–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã 31‚Äì45** –¥–ª—è –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–æ–π –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏.[^3_1]

***

# üìö API DOCUMENTATION \& WEBHOOKS ‚Äî –ü–û–õ–ù–´–ô –ë–õ–û–ö

## ‚úÖ –í–û–ü–†–û–°–´ 1‚Äì30 (–ë–µ—Å–µ–¥–∞ 13 ‚Äî –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ)

–ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –≤—Å–µ—Ö —Ä–µ—à–µ–Ω–∏–π:[^3_1]


| \# | –¢–µ–º–∞ | ‚úÖ –†–µ—à–µ–Ω–∏–µ |
| :-- | :-- | :-- |
| 1 | Documentation Tool | OpenAPI (Swagger auto-gen) + GitBook (guides) |
| 2 | Authentication | JWT (Frontend) + API Keys (server-to-server) |
| 3 | Rate Limiting | Per-tenant + Per-endpoint, Redis |
| 4 | API Versioning | URL `/api/v1`, `/api/v2` |
| 5 | Error Handling | RFC 7807 Problem Details |
| 6 | Webhook Events | Guest + Transaction lifecycle |
| 7 | Webhook Security | HMAC-SHA256 + Timestamp |
| 8 | Webhook Retry | Exponential backoff 6 –ø–æ–ø—ã—Ç–æ–∫ (6.5 –º–∏–Ω) |
| 9 | Pagination | Offset MVP, Cursor Phase 2 |
| 10 | Filtering | Multi-filter + Range + Search |
| 11 | Field Selection | `?fields=id,phone,balance` |
| 12 | Idempotency | Auto-hash (webhooks) + Client key (API) |
| 13 | SDK | TypeScript SDK; Python Phase 2 |
| 14 | Postman | Public Workspace |
| 15 | Changelog | –°—Ç—Ä–∞–Ω–∏—Ü–∞ + Email + RSS |
| 16 | Integration Guides | Quick Start + Use Cases (POS, CRM, Marketing) |
| 17 | Sandbox | Staging + Test API Keys (`mlk_test_...`) |
| 18 | Code Examples | cURL + JS + Python + PHP + Go |
| 19 | Status Page | Upptime (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π, GitHub Actions) |
| 20 | Security Guide | Guide + Checklist (10 –ø—É–Ω–∫—Ç–æ–≤) |
| 21 | Performance Tips | Guide + Benchmarks –ø–æ endpoint'–∞–º |
| 22 | GraphQL | REST MVP, GraphQL Phase 2 |
| 23 | Webhook Filtering | Event Subscription + Dynamic Update |
| 24 | Deprecation Policy | HTTP Header + Changelog + Email –∑–∞ 6 –º–µ—Å |
| 25 | API Analytics | –ú–µ—Ç—Ä–∏–∫–∏ + Breakdown –ø–æ endpoint'–∞–º |
| 26 | Request Logging | Logs + Search/Filter (30 –¥–Ω–µ–π, GDPR) |
| 27 | Mocking Tools | Postman Mock + Swagger Try It Out |
| 28 | Community Support | Telegram Group |
| 29 | SDK Auto-Generation | CI/CD OpenAPI ‚Üí codegen –ø—Ä–∏ –∫–∞–∂–¥–æ–º merge |
| 30 | Changelog Automation | Conventional Commits + API Diff (breaking change detection) |


***

## üî• –í–û–ü–†–û–°–´ 31‚Äì45 ‚Äî –£–ì–õ–£–ë–õ–Å–ù–ù–ê–Ø –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø


***

### 3Ô∏è‚É£1Ô∏è‚É£ –ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ –æ—à–∏–±–æ–∫ ‚Äî –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å error codes?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –£ –Ω–∞—Å —É–∂–µ RFC 7807 (Q5), –Ω–æ –Ω–µ—Ç –ø–æ–ª–Ω–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏, –ø—Ä–∏—á–∏–Ω–∞–º–∏, —Ä–µ—à–µ–Ω–∏—è–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –æ—à–∏–±–∫–∏. Developer –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å `GUEST_NOT_FOUND` –∏–ª–∏ `DUPLICATE_PHONE`.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ –ü–æ–ª–Ω—ã–π Error Catalog –≤ GitBook + machine-readable –≤ API**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- Stripe-style: –∫–∞–∂–¥–∞—è –æ—à–∏–±–∫–∞ = –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –ø—Ä–∏—á–∏–Ω–æ–π, —Ä–µ—à–µ–Ω–∏–µ–º, –ø—Ä–∏–º–µ—Ä–æ–º –∫–æ–¥–∞
- Machine-readable `errorCode` –≤ —Ç–µ–ª–µ –æ—Ç–≤–µ—Ç–∞ ‚Üí –∞–≤—Ç–æ–æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ SDK
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–º–æ–≥–∞–µ—Ç –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—É—é –æ—à–∏–±–∫—É

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ Error Response (RFC 7807):**

```json
{
  "type": "https://docs.max-loyalty.com/errors/GUEST_NOT_FOUND",
  "title": "Guest Not Found",
  "status": 404,
  "errorCode": "GUEST_NOT_FOUND",
  "detail": "Guest with phone +79991234567 not found in tenant TENANT-X",
  "instance": "/api/v1/guests?phone=79991234567",
  "requestId": "req_abc123",
  "timestamp": "2026-02-19T16:25:00Z",
  "help": "https://docs.max-loyalty.com/errors/GUEST_NOT_FOUND"
}
```

**–ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ –æ—à–∏–±–æ–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:**


| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | Error Code | HTTP | –û–ø–∏—Å–∞–Ω–∏–µ | –†–µ—à–µ–Ω–∏–µ |
| :-- | :-- | :-- | :-- | :-- |
| **Auth** | `INVALID_API_KEY` | 401 | API –∫–ª—é—á –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –æ—Ç–æ–∑–≤–∞–Ω | –ü—Ä–æ–≤–µ—Ä—å –∫–ª—é—á –≤ Admin Panel |
| **Auth** | `API_KEY_EXPIRED` | 401 | –ö–ª—é—á –∏—Å—Ç—ë–∫ | –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–ª—é—á |
| **Auth** | `INSUFFICIENT_PERMISSIONS` | 403 | –ù–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é | –ó–∞–ø—Ä–æ—Å–∏ `transactions:write` |
| **Auth** | `TOKEN_EXPIRED` | 401 | JWT access token –∏—Å—Ç—ë–∫ | –û–±–Ω–æ–≤–∏ —á–µ—Ä–µ–∑ refresh token |
| **Auth** | `MFA_REQUIRED` | 403 | –ù—É–∂–µ–Ω 2FA –¥–ª—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ | Step-up authentication |
| **Guest** | `GUEST_NOT_FOUND` | 404 | –ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω | –ü—Ä–æ–≤–µ—Ä—å —Ç–µ–ª–µ—Ñ–æ–Ω (—Ñ–æ—Ä–º–∞—Ç 79991234567) |
| **Guest** | `DUPLICATE_PHONE` | 409 | –¢–µ–ª–µ—Ñ–æ–Ω —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω | –ò—Å–ø–æ–ª—å–∑—É–π GET `/guests?phone=...` |
| **Guest** | `INVALID_PHONE_FORMAT` | 422 | –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞ | –§–æ—Ä–º–∞—Ç: `79991234567`, –±–µ–∑ `+` |
| **Guest** | `GUEST_CARD_NOT_FOUND` | 404 | –ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ | –ü—Ä–æ–≤–µ—Ä—å `cardId` –∏–ª–∏ —Å–æ–∑–¥–∞–π –∫–∞—Ä—Ç—É |
| **Loyalty** | `INSUFFICIENT_BALANCE` | 422 | –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è | –ü—Ä–æ–≤–µ—Ä—å `totalBalance` –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º |
| **Loyalty** | `MIN_CHECK_AMOUNT` | 422 | –°—É–º–º–∞ —á–µ–∫–∞ < 50 —Ä—É–± | –ú–∏–Ω–∏–º—É–º —á–µ–∫–∞: 50 —Ä—É–±–ª–µ–π |
| **Loyalty** | `REDEEM_LIMIT_EXCEEDED` | 422 | –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Å–ø–∏—Å–∞–Ω–∏—è | –ú–∞–∫—Å: `maxRedeemPercent`% –æ—Ç —á–µ–∫–∞ |
| **Loyalty** | `LOYALTY_SYSTEM_DISABLED` | 403 | –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∞ | Admin –≤–∫–ª—é—á–∞–µ—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö |
| **POS** | `DUPLICATE_CHECK` | 409 | –ß–µ–∫ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω (idempotency) | –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî –≤–µ—Ä–Ω–∏ `alreadyProcessed: true` |
| **POS** | `INVALID_HMAC_SIGNATURE` | 401 | HMAC –ø–æ–¥–ø–∏—Å—å –Ω–µ–≤–µ—Ä–Ω–∞—è | –ü—Ä–æ–≤–µ—Ä—å —Å–µ–∫—Ä–µ—Ç –∏ –∞–ª–≥–æ—Ä–∏—Ç–º sha256 |
| **POS** | `WEBHOOK_TIMESTAMP_EXPIRED` | 400 | Timestamp —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π –≤—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞ (NTP) |
| **POS** | `POS_INTEGRATION_NOT_FOUND` | 404 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ | –°–æ–∑–¥–∞–π —á–µ—Ä–µ–∑ Admin Panel |
| **Billing** | `SUBSCRIPTION_EXPIRED` | 402 | –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞ | –ü—Ä–æ–¥–ª–∏ –ø–æ–¥–ø–∏—Å–∫—É |
| **Billing** | `TENANT_LIMIT_REACHED` | 402 | –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —Ç–∞—Ä–∏—Ñ–∞ | –û–±–Ω–æ–≤–∏ —Ç–∞—Ä–∏—Ñ |
| **Rate** | `RATE_LIMIT_EXCEEDED` | 429 | –ü—Ä–µ–≤—ã—à–µ–Ω rate limit | Header: `Retry-After: 60` |
| **Server** | `INTERNAL_ERROR` | 500 | –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ | Retry —Å backoff; –µ—Å–ª–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è ‚Üí support |
| **Server** | `SERVICE_UNAVAILABLE` | 503 | –°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω | Retry —á–µ—Ä–µ–∑ 30-60 —Å–µ–∫ |

**NestJS —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```typescript
// libs/common/src/exceptions/app-exception.ts
export class AppException extends HttpException {
  constructor(
    errorCode: ErrorCode,
    httpStatus: number,
    detail: string,
    instance?: string,
  ) {
    super({
      type: `https://docs.max-loyalty.com/errors/${errorCode}`,
      title: ERROR_TITLES[errorCode],
      status: httpStatus,
      errorCode,
      detail,
      instance,
      help: `https://docs.max-loyalty.com/errors/${errorCode}`,
    }, httpStatus);
  }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
throw new AppException(
  'GUEST_NOT_FOUND',
  404,
  `Guest with phone ${phone} not found`,
  `/api/v1/guests?phone=${phone}`,
);
```


***

### 3Ô∏è‚É£2Ô∏è‚É£ –ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ Webhook Events ‚Äî –∫–∞–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –ø—É–±–ª–∏–∫—É–µ–º?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –í Q6 –≤—ã–±—Ä–∞–ª–∏ Guest + Transaction lifecycle, –Ω–æ –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∏ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π, –∏—Ö —Å—Ö–µ–º—ã –∏ –ø—Ä–∏–º–µ—Ä—ã payload'–æ–≤.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ 20 —Å–æ–±—ã—Ç–∏–π, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –¥–æ–º–µ–Ω–∞–º, —Å –ø–æ–ª–Ω—ã–º–∏ —Å—Ö–µ–º–∞–º–∏**

**–ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥:**

```typescript
// Webhook Event Types
enum WebhookEventType {
  // ‚îÄ‚îÄ –ì–æ—Å—Ç—å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  GUEST_CREATED       = 'guest.created',        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  GUEST_UPDATED       = 'guest.updated',        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
  GUEST_DELETED       = 'guest.deleted',        // –£–¥–∞–ª–µ–Ω–∏–µ (GDPR)
  GUEST_MERGED        = 'guest.merged',         // –°–ª–∏—è–Ω–∏–µ –¥—É–±–ª–µ–π

  // ‚îÄ‚îÄ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–∞–ª–ª–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  TRANSACTION_EARN    = 'transaction.earn',     // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ
  TRANSACTION_REDEEM  = 'transaction.redeem',   // –°–ø–∏—Å–∞–Ω–∏–µ
  TRANSACTION_REFUND  = 'transaction.refund',   // –í–æ–∑–≤—Ä–∞—Ç
  TRANSACTION_MANUAL  = 'transaction.manual',   // –†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞
  TRANSACTION_EXPIRE  = 'transaction.expire',   // –°–≥–æ—Ä–∞–Ω–∏–µ

  // ‚îÄ‚îÄ –£—Ä–æ–≤–Ω–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  LEVEL_UPGRADED      = 'level.upgraded',       // –ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è

  // ‚îÄ‚îÄ –ü—Ä–æ–º–æ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  PROMO_ACTIVATED     = 'promo.activated',      // –ü—Ä–æ–º–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
  PROMO_EXPIRED       = 'promo.expired',        // –ü—Ä–æ–º–æ –∏—Å—Ç–µ–∫–ª–æ

  // ‚îÄ‚îÄ POS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  POS_CHECK_PROCESSED = 'pos.check.processed',  // –ß–µ–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
  POS_SYNC_FAILED     = 'pos.sync.failed',      // –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

  // ‚îÄ‚îÄ –ë–∏–ª–ª–∏–Ω–≥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  SUBSCRIPTION_CREATED    = 'subscription.created',
  SUBSCRIPTION_RENEWED    = 'subscription.renewed',
  SUBSCRIPTION_CANCELLED  = 'subscription.cancelled',
  SUBSCRIPTION_EXPIRED    = 'subscription.expired',
  PAYMENT_SUCCEEDED       = 'payment.succeeded',
  PAYMENT_FAILED          = 'payment.failed',
}
```

**–ü—Ä–∏–º–µ—Ä payload (transaction.earn):**

```json
{
  "id": "evt_abc123",
  "type": "transaction.earn",
  "apiVersion": "v1",
  "createdAt": "2026-02-19T16:25:00Z",
  "tenantId": "tenant-uuid",
  "restaurantId": "rest-uuid",
  "data": {
    "transactionId": "txn-uuid",
    "guestId": "guest-uuid",
    "guestPhone": "79991234567",
    "cardId": "card-uuid",
    "earnedPoints": 200,
    "balanceType": "REGULAR",
    "balanceBefore": 2500,
    "balanceAfter": 2700,
    "checkAmount": 2000,
    "posCheckId": "CHK-123456",
    "posSystem": "IIKO_CLOUD",
    "appliedRule": {
      "ruleId": "rule-uuid",
      "ruleName": "–ë–∞–∑–æ–≤—ã–π –∫–µ—à–±—ç–∫ 10%",
      "earnPercent": 10
    },
    "cashierId": "cashier-uuid"
  }
}
```

**Webhook Subscription –º–æ–¥–µ–ª—å:**

```typescript
// POST /api/v1/webhooks/subscriptions
{
  "url": "https://your-crm.com/webhooks/max-loyalty",
  "events": ["guest.created", "transaction.earn", "level.upgraded"],
  "secret": "whsec_your32charssecret",
  "description": "CRM sync webhook",
  "isActive": true,
  "metadata": { "crmType": "HubSpot" }
}

// Response
{
  "id": "sub-abc123",
  "url": "https://your-crm.com/webhooks/max-loyalty",
  "events": ["guest.created", "transaction.earn", "level.upgraded"],
  "isActive": true,
  "createdAt": "2026-02-19T16:25:00Z",
  // Secret –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏)
  "signingSecret": "whsec_your32charssecret" // —Ç–æ–ª—å–∫–æ –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞ POST
}
```


***

### 3Ô∏è‚É£3Ô∏è‚É£ Interactive API Explorer ‚Äî "Try It Out" –ø—Ä—è–º–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** GitBook –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏–∫—É. –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å, –Ω–µ –≤—ã—Ö–æ–¥—è –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ Scalar (modern Swagger UI) –≤–º–µ—Å—Ç–æ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ Swagger UI**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- Scalar ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ Swagger UI (2024-2025 —Å—Ç–∞–Ω–¥–∞—Ä—Ç)
- –ö—Ä–∞—Å–∏–≤—ã–π UI, —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞, curl-—ç–∫—Å–ø–æ—Ä—Ç –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- –í—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ NestJS –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π
- –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π, open source

```typescript
// apps/backend/src/main.ts
import { ScalarApiReference } from '@scalar/nestjs-api-reference';

app.use('/docs', ScalarApiReference({
  spec: { url: '/api-json' },
  configuration: {
    title: 'Max Loyalty API',
    theme: 'moon', // –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
    darkMode: true,
    defaultHttpClient: {
      targetKey: 'node',
      clientKey: 'axios',
    },
    authentication: {
      preferredSecurityScheme: 'ApiKeyAuth',
      apiKey: { token: '' }, // –ü—É—Å—Ç–æ–π ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Å–≤–æ–π
    },
  },
}));
```

**–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:**

- –ü—Ä–æ–¥–∞–∫—à–µ–Ω: `https://api.max-loyalty.com/docs` (readonly, –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–ª—é—á–µ–π)
- Staging: `https://staging-api.max-loyalty.com/docs` (–ø–æ–ª–Ω—ã–π Try It Out)

***

### 3Ô∏è‚É£4Ô∏è‚É£ –ö–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å Pagination, Filtering, Sorting ‚Äî –µ–¥–∏–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ö–∞–∂–¥—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –ø–æ-—Ä–∞–∑–Ω–æ–º—É –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Üí Developer –ø—É—Ç–∞–µ—Ç—Å—è. –ù—É–∂–µ–Ω –µ–¥–∏–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –≤—Å–µ—Ö list-endpoints.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ –ï–¥–∏–Ω—ã–π Query Convention –¥–ª—è –≤—Å–µ—Ö list-endpoints**

```
// PAGINATION
GET /api/v1/guests?limit=50&offset=0
GET /api/v1/guests?limit=50&offset=50  ‚Üê —Å–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞

// SORTING
GET /api/v1/guests?sortBy=createdAt&sortOrder=desc

// FILTERING
GET /api/v1/guests?phone=7999...
GET /api/v1/transactions?type=EARN&dateFrom=2026-01-01&dateTo=2026-02-01
GET /api/v1/guests?level=GOLD&minBalance=1000&maxBalance=50000

// FIELD SELECTION
GET /api/v1/guests?fields=id,phone,firstName,totalBalance

// SEARCH (full-text)
GET /api/v1/guests?search=–ò–≤–∞–Ω
```

**–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Response Envelope:**

```json
{
  "data": [...],
  "pagination": {
    "total": 1247,
    "limit": 50,
    "offset": 0,
    "hasNext": true,
    "hasPrev": false,
    "nextOffset": 50
  },
  "meta": {
    "requestId": "req_abc123",
    "responseTime": 87
  }
}
```


***

### 3Ô∏è‚É£5Ô∏è‚É£ –ö–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å Multi-tenancy –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ò–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –µ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞ –∏ –æ–Ω –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–∏–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´Tenants \& Isolation¬ª –≤ GitBook**

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**

- API Key –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Ç–µ–Ω–∞–Ω—Ç—É ‚Äî –Ω–∏–∫–∞–∫–æ–≥–æ `tenantId` –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö
- –í—Å–µ —Ä–µ—Å—É—Ä—Å—ã (–≥–æ—Å—Ç–∏, –ø—Ä–∞–≤–∏–ª–∞, –ø—Ä–æ–º–æ) –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –ø–æ —Ç–µ–Ω–∞–Ω—Ç—É
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: Owner API (–æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–ª—é—á–∏, –≤–∏–¥–∏—Ç –≤—Å–µ —Ç–µ–Ω–∞–Ω—Ç—ã)
- –û—à–∏–±–∫–∞ `TENANT_LIMIT_REACHED` ‚Äî —Ç–∞—Ä–∏—Ñ–Ω—ã–π –ª–∏–º–∏—Ç, –Ω–µ –±–∞–≥

```typescript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º tenantId –≤ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å (–∏–∑ API Key)
// –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –ù–ï –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å tenantId –≤—Ä—É—á–Ω—É—é
GET /api/v1/guests   ‚Üê –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ —Ç–µ–Ω–∞–Ω—Ç—É –∫–ª—é—á–∞
// –ù–ï —Ç–∞–∫:
GET /api/v1/guests?tenantId=xxx ‚Üê —ç—Ç–æ –õ–ò–®–ù–ï–ï
```


***

### 3Ô∏è‚É£6Ô∏è‚É£ OpenAPI Spec ‚Äî –∫–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ï—Å–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–Ω—è–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä, –Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é ‚Äî –≤–æ–∑–Ω–∏–∫–∞–µ—Ç drift. –ù—É–∂–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ Swagger –≤—Å–µ–≥–¥–∞ = –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–¥.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ Code-First + CI/CD Spec Snapshot Test**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** Code-First (NestJS –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã ‚Üí OpenAPI) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –∫–æ–¥ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é. Snapshot test –ª–æ–≤–∏—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

```typescript
// NestJS Swagger decorators ‚Äî –∫–æ–¥ IS –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
@ApiOperation({ summary: 'Create guest', description: 'Register new loyalty card' })
@ApiBody({ type: CreateGuestDto })
@ApiResponse({ status: 201, type: GuestResponseDto, description: 'Guest created' })
@ApiResponse({ status: 409, description: 'Phone already registered' })
@Post()
async createGuest(@Body() dto: CreateGuestDto) {}
```

**CI/CD Snapshot Test:**

```yaml
# .github/workflows/api-spec.yml
- name: Check OpenAPI spec hasn't changed unexpectedly
  run: |
    npm run start &
    sleep 5
    curl http://localhost:3000/api-json > openapi-current.json
    
    # Compare with committed spec
    if ! diff openapi-committed.json openapi-current.json; then
      echo "‚ùå OpenAPI spec changed! Update openapi-committed.json"
      exit 1
    fi
```


***

### 3Ô∏è‚É£7Ô∏è‚É£ –ö–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å Idempotency –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –î–ª—è POS-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –∫—Ä–∏—Ç–∏—á–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å. –ï—Å–ª–∏ POS –æ—Ç–ø—Ä–∞–≤–∏—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —á–µ–∫ –¥–≤–∞–∂–¥—ã ‚Äî –±–∞–ª–ª—ã –¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏—Å–ª–∏—Ç—å—Å—è **–æ–¥–∏–Ω —Ä–∞–∑**.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´Idempotency¬ª —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ —Ç–µ—Å—Ç–∞–º–∏**

```markdown
## Idempotency

For financial operations (earning/redeeming points), Max Loyalty guarantees
idempotency - the same operation processed twice produces identical results.

### Automatic (Webhooks)
POS webhooks are deduplicated automatically by `posCheckId`:

```json
// First request ‚Üí processed, 200 balls earned
POST /api/v1/webhooks/pos/transaction
{ "posCheckId": "CHK-123456", "checkAmount": 2000 }
‚Üí { "success": true, "earnedPoints": 200 }

// Duplicate request ‚Üí same result, no double crediting
POST /api/v1/webhooks/pos/transaction  
{ "posCheckId": "CHK-123456", "checkAmount": 2000 }  // same checkId!
‚Üí { "success": true, "earnedPoints": 200, "alreadyProcessed": true }
```


### Manual (API Calls)

For manual API calls, provide `Idempotency-Key` header:

```bash
curl -X POST https://api.max-loyalty.com/api/v1/loyalty/manual-adjustment \
  -H "Idempotency-Key: adj_your_unique_key_here" \
  -d '{"guestCardId": "...", "amount": 500}'
```

```

***

### 3Ô∏è‚É£8Ô∏è‚É£ Developer Experience: –∫–∞–∫ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å Time-to-First-API-Call –¥–æ 5 –º–∏–Ω—É—Ç?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ß–µ–º –±—ã—Å—Ç—Ä–µ–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–≤—ã–π —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Äî —Ç–µ–º –≤—ã—à–µ –∫–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é. –¶–µ–ª—å: **5 –º–∏–Ω—É—Ç –æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–æ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞**.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ Onboarding Checklist + Pre-filled Postman Collection + Magic Token**

**5-–º–∏–Ω—É—Ç–Ω—ã–π –ø—É—Ç—å:**

```

–®–∞–≥ 1 (30 —Å–µ–∫): –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ staging-app.max-loyalty.com
–®–∞–≥ 2 (30 —Å–µ–∫): –ê–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ test tenant + —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (10 –≥–æ—Å—Ç–µ–π)
–®–∞–≥ 3 (1 –º–∏–Ω):  –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ API –∫–ª—é—á–∞ (mlk_test_...)
–®–∞–≥ 4 (1 –º–∏–Ω):  Fork Postman Collection ‚Üí –æ–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞
–®–∞–≥ 5 (2 –º–∏–Ω):  Run first request ‚Üí –≤–∏–¥–∏–º —Ä–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –¥–∞–Ω–Ω—ã–º–∏

```

**Postman Collection —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```

Max Loyalty API
‚îú‚îÄ‚îÄ üöÄ Quick Start (run these first!)
‚îÇ   ‚îú‚îÄ‚îÄ 1. Health Check
‚îÇ   ‚îú‚îÄ‚îÄ 2. Get My Tenant Info
‚îÇ   ‚îú‚îÄ‚îÄ 3. List Guests (pre-seeded 10 guests)
‚îÇ   ‚îú‚îÄ‚îÄ 4. Create Guest
‚îÇ   ‚îî‚îÄ‚îÄ 5. Process Transaction (earn balls)
‚îú‚îÄ‚îÄ üë§ Guests
‚îú‚îÄ‚îÄ üéØ Loyalty
‚îú‚îÄ‚îÄ üì± POS Webhooks
‚îú‚îÄ‚îÄ üí≥ Billing
‚îî‚îÄ‚îÄ ‚öôÔ∏è  Admin

```

**Pre-seeded staging –¥–∞–Ω–Ω—ã–µ** (—Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏):
- 10 —Ç–µ—Å—Ç–æ–≤—ã—Ö –≥–æ—Å—Ç–µ–π —Å –±–∞–ª–∞–Ω—Å–∞–º–∏ –∏ –∏—Å—Ç–æ—Ä–∏–µ–π
- 3 –ø—Ä–∞–≤–∏–ª–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- 2 –ø—Ä–æ–º–æ-–∫–∞–º–ø–∞–Ω–∏–∏
- 1 POS-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ sandbox-—Ä–µ–∂–∏–º–µ

***

### 3Ô∏è‚É£9Ô∏è‚É£ Webhook Debugging ‚Äî –∫–∞–∫ –ø–æ–º–æ—á—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –æ—Ç–ª–∞–¥–∏—Ç—å webhook?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –°–∞–º–∞—è —á–∞—Å—Ç–∞—è –ø—Ä–æ–±–ª–µ–º–∞: ¬´—è –æ—Ç–ø—Ä–∞–≤–ª—è—é webhook, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç¬ª. –ù—É–∂–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ production –ª–æ–≥–∞–º.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ Webhook Event Log –≤ Admin Panel + Replay + Test Trigger**

```typescript
// Webhook Event Log ‚Äî –∫–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è 30 –¥–Ω–µ–π
GET /api/v1/webhooks/subscriptions/{subId}/events
‚Üí {
  "data": [
    {
      "id": "evt_abc123",
      "type": "guest.created",
      "status": "DELIVERED",     // DELIVERED | FAILED | PENDING
      "attempts": 1,
      "statusCode": 200,
      "duration": 145,           // ms
      "createdAt": "2026-02-19T16:25:00Z",
      "deliveredAt": "2026-02-19T16:25:00.145Z",
      "nextRetryAt": null
    },
    {
      "id": "evt_def456",
      "type": "transaction.earn",
      "status": "FAILED",
      "attempts": 3,
      "lastError": "Connection timeout",
      "nextRetryAt": "2026-02-19T16:30:00Z"
    }
  ]
}

// Replay –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
POST /api/v1/webhooks/events/{eventId}/replay
‚Üí { "success": true, "newEventId": "evt_xyz789" }

// Test Trigger ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π event –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
POST /api/v1/webhooks/subscriptions/{subId}/test
{ "eventType": "guest.created" }
```

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:** –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

- **webhook.site** ‚Äî inspect webhooks –æ–Ω–ª–∞–π–Ω
- **ngrok** ‚Äî —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
- –ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: —à–∞–≥ –∑–∞ —à–∞–≥–æ–º

***

### 4Ô∏è‚É£0Ô∏è‚É£ API Rate Limits ‚Äî –∫–∞–∫ –¥–æ–Ω–æ—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã –¥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** Rate limit –≤ Q3 –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏, –Ω–æ –Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –æ —Ç–æ–º, –∫–∞–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —É–∑–Ω–∞—ë—Ç –æ —Å–≤–æ–∏—Ö –ª–∏–º–∏—Ç–∞—Ö –∏ –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å `429`.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ Response Headers + –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π + Retry-After + Burst mode**

**Response Headers –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:**

```
X-RateLimit-Limit: 1000          ‚Üê –ª–∏–º–∏—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥
X-RateLimit-Remaining: 847       ‚Üê –æ—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤
X-RateLimit-Reset: 1740004800    ‚Üê –∫–æ–≥–¥–∞ —Å–±—Ä–æ—Å–∏—Ç—Å—è (Unix timestamp)
X-RateLimit-Tier: standard       ‚Üê —Ç–∞—Ä–∏—Ñ
```

**–ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ (429):**

```json
{
  "type": "https://docs.max-loyalty.com/errors/RATE_LIMIT_EXCEEDED",
  "title": "Rate Limit Exceeded",
  "status": 429,
  "errorCode": "RATE_LIMIT_EXCEEDED",
  "detail": "You have exceeded 1000 requests per hour. Retry after 3600 seconds.",
  "retryAfter": 3600
}
```

**–¢–∞–±–ª–∏—Ü–∞ –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**


| Endpoint | Standard | Pro | Ultimate |
| :-- | :-- | :-- | :-- |
| –û–±—â–∏–π –ª–∏–º–∏—Ç | 1 000/—á | 5 000/—á | 20 000/—á |
| `POST /loyalty/transactions` | 120/–º–∏–Ω | 500/–º–∏–Ω | 2 000/–º–∏–Ω |
| `POST /webhooks/pos/*` | 20/10 —Å–µ–∫ | 100/10 —Å–µ–∫ | 500/10 —Å–µ–∫ |
| `GET /guests` | 200/–º–∏–Ω | 1 000/–º–∏–Ω | 5 000/–º–∏–Ω |
| –ü–µ—Ä–µ–≤–æ–¥—ã –±–∞–ª–ª–æ–≤ | 3/–º–∏–Ω | 10/–º–∏–Ω | 50/–º–∏–Ω |

**–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ SDK:**

```typescript
// TypeScript SDK ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –Ω–∞ 429
const client = new MaxLoyaltyClient({
  apiKey: process.env.MAX_LOYALTY_API_KEY,
  retry: {
    maxAttempts: 3,
    onRateLimit: 'wait', // 'wait' | 'throw'
  }
});
```


***

### 4Ô∏è‚É£1Ô∏è‚É£ –ö–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å Pagination –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** Offset pagination —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–ª–æ—Ö–æ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö (100k+ –≥–æ—Å—Ç–µ–π). Phase 2 ‚Äî cursor. –ù—É–∂–Ω–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏ migration path.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–∞ —Ä–µ–∂–∏–º–∞ —Å —è–≤–Ω—ã–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ–± –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö Offset**

**Offset Pagination (—Ç–µ–∫—É—â–∏–π ‚Äî v1):**

```bash
# –†–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ –¥–æ ~10 000 –∑–∞–ø–∏—Å–µ–π
GET /api/v1/guests?limit=50&offset=0
GET /api/v1/guests?limit=50&offset=50

# ‚ö†Ô∏è WARNING –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:
# Avoid offset > 10,000 ‚Äî performance degrades significantly
# For large exports, use the Bulk Export endpoint instead
```

**Cursor Pagination (Phase 2 ‚Äî v2):**

```bash
# –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
GET /api/v2/guests?limit=50
‚Üí { "data": [...], "nextCursor": "eyJpZCI6Ijg3NiJ9" }

# –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
GET /api/v2/guests?limit=50&cursor=eyJpZCI6Ijg3NiJ9

# –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞: —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –≤—Å—Ç–∞–≤–∫–∞–º–∏ –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏
```

**Bulk Export (–¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö):**

```typescript
// –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –¥–ª—è > 10k –∑–∞–ø–∏—Å–µ–π
POST /api/v1/exports
{ "type": "GUESTS", "filters": { "level": "GOLD" }, "format": "CSV" }
‚Üí { "exportId": "exp-abc123", "status": "PROCESSING" }

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
GET /api/v1/exports/exp-abc123
‚Üí { "status": "READY", "downloadUrl": "https://...", "expiresAt": "..." }
```


***

### 4Ô∏è‚É£2Ô∏è‚É£ –ö–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å Field Selection –∏ –∏–∑–±–µ–≥–∞—Ç—å over-fetching?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** `?fields=` –≤ Q11 –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω, –Ω–æ –Ω–µ—Ç –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö endpoint'–æ–≤ –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è, –∑–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ –†–∞–∑–¥–µ–ª ¬´Optimizing Response Size¬ª —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ bandwidth —ç–∫–æ–Ω–æ–º–∏–∏**

```bash
# –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç (3KB) ‚Äî –≤—Å–µ –ø–æ–ª—è –≥–æ—Å—Ç—è
GET /api/v1/guests/uuid-123

# –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (200 bytes) ‚Äî —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –¥–ª—è POS
GET /api/v1/guests/uuid-123?fields=id,phone,displayCode,totalBalance,level

# –î–ª—è —Å–ø–∏—Å–∫–∞ (Cashier Interface ‚Äî —Ç–æ–ª—å–∫–æ –∏–º—è –∏ –±–∞–ª–∞–Ω—Å)
GET /api/v1/guests?fields=id,phone,firstName,totalBalance&limit=10

# Nested fields
GET /api/v1/guests?fields=id,phone,card.totalBalance,card.level

# –û—Ç–≤–µ—Ç —Å ?fields= –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç –ø—É—Å—Ç—ã–µ –ø–æ–ª—è:
{
  "id": "guest-uuid",
  "phone": "79991234567",
  "firstName": "–ò–≤–∞–Ω",
  "card": {
    "totalBalance": 2500,
    "level": "SILVER"
  }
}
```


***

### 4Ô∏è‚É£3Ô∏è‚É£ API Keys ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, rotation, permissions scope?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã —Ñ–æ—Ä–º–∞—Ç—ã –∫–ª—é—á–µ–π, –Ω–æ –Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ lifecycle: —Å–æ–∑–¥–∞–Ω–∏–µ, permissions, rotation, revoke, audit log.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ Full API Key Lifecycle –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å permission matrix**

**Permission Scopes:**

```typescript
enum APIKeyScope {
  // Guests
  GUESTS_READ   = 'guests:read',    // GET /guests, GET /guests/:id
  GUESTS_WRITE  = 'guests:write',   // POST, PATCH /guests
  GUESTS_DELETE = 'guests:delete',  // DELETE /guests/:id

  // Transactions
  TRANSACTIONS_READ  = 'transactions:read',
  TRANSACTIONS_WRITE = 'transactions:write', // POST /loyalty/transactions

  // Webhooks
  WEBHOOKS_MANAGE = 'webhooks:manage', // CRUD subscriptions

  // Analytics (read-only)
  ANALYTICS_READ = 'analytics:read',

  // Admin (superscope ‚Äî –≤–∫–ª—é—á–∞–µ—Ç –≤—Å—ë)
  ADMIN = 'admin',
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ scopes –ø–æ use case:**


| Use Case | –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ Scopes |
| :-- | :-- |
| POS Integration | `guests:read`, `guests:write`, `transactions:write` |
| CRM Sync | `guests:read`, `webhooks:manage` |
| Analytics Dashboard | `analytics:read`, `guests:read` |
| Marketing Automation | `guests:read`, `webhooks:manage` |
| Full Access | `admin` |

**API Key Rotation Policy:**

```markdown
‚ö†Ô∏è Security Recommendation: Rotate API keys every 90 days

Rotation Process (zero-downtime):
1. Create new API key (same permissions)
2. Update your environment variable to new key
3. Deploy your application
4. Verify new key works in production
5. Revoke old key (Admin Panel ‚Üí API Keys ‚Üí Revoke)

Grace Period: Old key works for 24 hours after revocation
to prevent accidental lockout.
```


***

### 4Ô∏è‚É£4Ô∏è‚É£ API Documentation ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —è–∑—ã–∫–æ–≤ (RU/EN)?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –†–§ (–æ—Å–Ω–æ–≤–Ω–æ–π —Ä—ã–Ω–æ–∫), –Ω–æ –∏–º–µ–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é POS-–∞—É–¥–∏—Ç–æ—Ä–∏—é (iiko/R-Keeper –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –°–ù–ì –∏ –∑–∞ —Ä—É–±–µ–∂–æ–º).

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ –î–≤–∞ —è–∑—ã–∫–∞ —Å EN –∫–∞–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã (API, REST, HMAC) ‚Äî EN universal
- Integration guides: RU (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤) + EN (–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ)
- Error messages –≤ API: EN (–º–∞—à–∏–Ω–Ω–æ-—á–∏—Ç–∞–µ–º—ã–µ)
- Admin Panel UI: RU (–æ—Å–Ω–æ–≤–Ω–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è)

**GitBook —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```
docs.max-loyalty.com/           ‚Üê EN (default)
docs.max-loyalty.com/ru/        ‚Üê RU
```

**–ß—Ç–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ:**

1. Quick Start Guide ‚Äî RU –∏ EN
2. POS Integration Guide (iiko/R-Keeper) ‚Äî **RU-first** (—Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è)
3. Error Codes Reference ‚Äî EN (tech)
4. API Reference (Swagger) ‚Äî EN (tech)

***

### 4Ô∏è‚É£5Ô∏è‚É£ –§–∏–Ω–∞–ª—å–Ω—ã–π Documentation Health Check ‚Äî –∫–∞–∫ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∂–∏–≤–∞—è?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —É—Å—Ç–∞—Ä–µ–≤–∞–µ—Ç. –ù—É–∂–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: ‚úÖ Automated Documentation Health Check –≤ CI/CD**

```yaml
# .github/workflows/docs-health.yml
name: Documentation Health Check
on:
  schedule:
    - cron: '0 9 * * 1'   # –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 9:00

jobs:
  check-docs:
    steps:
      # 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Å—Å—ã–ª–∫–∏ –≤ GitBook
      - name: Check broken links
        run: npx linkinator https://docs.max-loyalty.com --recurse

      # 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ —Ä–∞–±–æ—Ç–∞—é—Ç
      - name: Test code examples
        run: node scripts/test-doc-examples.js
        env:
          API_KEY: ${{ secrets.STAGING_API_KEY }}

      # 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å OpenAPI spec drift
      - name: Check spec is up to date
        run: npm run check-openapi-drift

      # 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ error codes –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
      - name: Check error code coverage
        run: node scripts/check-error-docs.js

      # 5. –û—Ç—á—ë—Ç –≤ Slack/Telegram –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
      - name: Notify if docs outdated
        if: failure()
        run: node scripts/notify-docs-team.js
```


***

## üìä –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê –ë–õ–û–ö–ê

| –†–∞–∑–¥–µ–ª | –í–æ–ø—Ä–æ—Å–æ–≤ | –°—Ç–∞—Ç—É—Å |
| :-- | :-- | :-- |
| Core API (1‚Äì5) | 5 | ‚úÖ |
| Webhooks (6‚Äì12) | 7 | ‚úÖ |
| Developer Experience (13‚Äì20) | 8 | ‚úÖ |
| Advanced / Operations (21‚Äì30) | 10 | ‚úÖ |
| **–£–≥–ª—É–±–ª—ë–Ω–Ω—ã–µ (31‚Äì45)** | **15** | **‚úÖ –°–µ–π—á–∞—Å** |
| **–ò–¢–û–ì–û** | **45** | **‚úÖ** |


***

## üéØ –û–ë–©–ò–ô –ò–¢–û–ì –í–°–ï–ì–û –ü–†–û–ï–ö–¢–ê

–í—Å–µ **14 –±–ª–æ–∫–æ–≤** –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω—ã. –û–±—â–∏–π —Å—á—ë—Ç —Å —É—á—ë—Ç–æ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π —Å–µ—Å—Å–∏–∏:


| –ë–ª–æ–∫ | –í–æ–ø—Ä–æ—Å–æ–≤ |
| :-- | :-- |
| Loyalty System Engine | 23 |
| POS Integration | 36 |
| Billing \& Subscriptions | 23 |
| Telegram Bot + Mini App | 41 |
| Backend API (NestJS) | 30 |
| Database Schema (Prisma) | 35 |
| Frontend UI/UX | 35 |
| Notifications System | 36 |
| Infrastructure \& DevOps | 43 |
| Testing Strategy | 40 |
| Owner Dashboard | 35 |
| Manager/Cashier Dashboard | 50 |
| Security \& Compliance | 51 |
| **API Documentation** | **45** |
| **üèÜ –í–°–ï–ì–û** | **~523** |

**–í—Å—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞.** –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ‚Äî –≤—ã–±–∏—Ä–∞–µ–º: **–¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∫–æ–π-–ª–∏–±–æ –±–ª–æ–∫ –µ—â—ë –≥–ª—É–±–∂–µ** –∏–ª–∏ **–Ω–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–æ–¥—É–ª—è?** üöÄ

<div align="center">‚ÅÇ</div>

[^3_1]: Beseda-13.md


---

# üìã API DOCUMENTATION ‚Äî –í–û–ü–†–û–°–´ 31‚Äì45

## –§–æ—Ä–º–∞—Ç: –í–æ–ø—Ä–æ—Å ‚Üí –û—Ç–≤–µ—Ç ‚Üí –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ ‚Üí –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ


***

### 3Ô∏è‚É£1Ô∏è‚É£ –ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ –æ—à–∏–±–æ–∫ ‚Äî –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å error codes?

**–í–æ–ø—Ä–æ—Å:** –£ –Ω–∞—Å RFC 7807 (Q5), –Ω–æ –Ω–µ—Ç –ø–æ–ª–Ω–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ –æ—à–∏–±–æ–∫ —Å –ø—Ä–∏—á–∏–Ω–∞–º–∏ –∏ —Ä–µ—à–µ–Ω–∏—è–º–∏. –ö–∞–∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å Error Reference, —á—Ç–æ–±—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –º–æ–≥ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ–Ω—è—Ç—å, —á—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ?

**–û—Ç–≤–µ—Ç:** –ü–æ–ª–Ω—ã–π Error Catalog –≤ GitBook + machine-readable `errorCode` –≤ —Ç–µ–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –ö–∞–∂–¥–∞—è –æ—à–∏–±–∫–∞ = –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: –ø—Ä–∏—á–∏–Ω–∞, —Ä–µ—à–µ–Ω–∏–µ, –ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞, —Å—Å—ã–ª–∫–∞ –∏–∑ `type` –ø–æ–ª—è RFC 7807.

```json
{
  "type": "https://docs.max-loyalty.com/errors/GUEST_NOT_FOUND",
  "title": "Guest Not Found",
  "status": 404,
  "errorCode": "GUEST_NOT_FOUND",
  "detail": "Guest with phone 79991234567 not found in tenant TENANT-X",
  "instance": "/api/v1/guests?phone=79991234567",
  "requestId": "req_abc123",
  "timestamp": "2026-02-19T16:25:00Z",
  "help": "https://docs.max-loyalty.com/errors/GUEST_NOT_FOUND"
}
```

**–ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:**


| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | Error Code | HTTP | –†–µ—à–µ–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| Auth | `INVALID_API_KEY` | 401 | –ü—Ä–æ–≤–µ—Ä—å –∫–ª—é—á –≤ Admin Panel |
| Auth | `API_KEY_EXPIRED` | 401 | –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–ª—é—á |
| Auth | `INSUFFICIENT_PERMISSIONS` | 403 | –ó–∞–ø—Ä–æ—Å–∏ –Ω—É–∂–Ω—ã–π scope |
| Auth | `TOKEN_EXPIRED` | 401 | –û–±–Ω–æ–≤–∏ —á–µ—Ä–µ–∑ refresh token |
| Auth | `MFA_REQUIRED` | 403 | Step-up authentication |
| Guest | `GUEST_NOT_FOUND` | 404 | –ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (79991234567) |
| Guest | `DUPLICATE_PHONE` | 409 | –ò—Å–ø–æ–ª—å–∑—É–π GET `/guests?phone=...` |
| Guest | `INVALID_PHONE_FORMAT` | 422 | –§–æ—Ä–º–∞—Ç: `79991234567`, –±–µ–∑ `+` –∏ –ø—Ä–æ–±–µ–ª–æ–≤ |
| Guest | `GUEST_CARD_NOT_FOUND` | 404 | –ü—Ä–æ–≤–µ—Ä—å `cardId` –∏–ª–∏ —Å–æ–∑–¥–∞–π –∫–∞—Ä—Ç—É |
| Loyalty | `INSUFFICIENT_BALANCE` | 422 | –ü—Ä–æ–≤–µ—Ä—å `totalBalance` –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º |
| Loyalty | `MIN_CHECK_AMOUNT` | 422 | –ú–∏–Ω–∏–º—É–º —á–µ–∫–∞: 50 —Ä—É–±–ª–µ–π |
| Loyalty | `REDEEM_LIMIT_EXCEEDED` | 422 | –ú–∞–∫—Å: `maxRedeemPercent`% –æ—Ç —á–µ–∫–∞ |
| Loyalty | `LOYALTY_SYSTEM_DISABLED` | 403 | Admin –≤–∫–ª—é—á–∞–µ—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ç–µ–Ω–∞–Ω—Ç–∞ |
| POS | `DUPLICATE_CHECK` | 409 | –ù–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî –≤–µ—Ä–Ω–∏ `alreadyProcessed: true` |
| POS | `INVALID_HMAC_SIGNATURE` | 401 | –ü—Ä–æ–≤–µ—Ä—å —Å–µ–∫—Ä–µ—Ç –∏ –∞–ª–≥–æ—Ä–∏—Ç–º sha256 |
| POS | `WEBHOOK_TIMESTAMP_EXPIRED` | 400 | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π –≤—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞ (NTP) |
| POS | `POS_INTEGRATION_NOT_FOUND` | 404 | –°–æ–∑–¥–∞–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤ Admin Panel |
| Billing | `SUBSCRIPTION_EXPIRED` | 402 | –ü—Ä–æ–¥–ª–∏ –ø–æ–¥–ø–∏—Å–∫—É |
| Billing | `TENANT_LIMIT_REACHED` | 402 | –û–±–Ω–æ–≤–∏ —Ç–∞—Ä–∏—Ñ |
| Rate | `RATE_LIMIT_EXCEEDED` | 429 | Header `Retry-After: 60` |
| Server | `INTERNAL_ERROR` | 500 | Retry —Å backoff; –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è ‚Üí support |
| Server | `SERVICE_UNAVAILABLE` | 503 | Retry —á–µ—Ä–µ–∑ 30‚Äì60 —Å–µ–∫ |

**NestJS —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```typescript
export class AppException extends HttpException {
  constructor(errorCode: ErrorCode, httpStatus: number, detail: string) {
    super({
      type: `https://docs.max-loyalty.com/errors/${errorCode}`,
      title: ERROR_TITLES[errorCode],
      status: httpStatus,
      errorCode,
      detail,
      help: `https://docs.max-loyalty.com/errors/${errorCode}`,
    }, httpStatus);
  }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–µ–∑–¥–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ
throw new AppException('GUEST_NOT_FOUND', 404, `Guest with phone ${phone} not found`);
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- Stripe-style: –∫–∞–∂–¥—ã–π `errorCode` ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –∞–≤—Ç–æ–æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ SDK
- –ü–æ–ª–µ `help` ‚Üí –ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø—Ä—è–º–æ –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
- `requestId` ‚Üí —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø–∏—à–µ—Ç –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º ID, –Ω–µ –æ–ø–∏—Å—ã–≤–∞—è –ø—Ä–æ–±–ª–µ–º—É —Å–ª–æ–≤–∞–º–∏
- RFC 7807 = industry standard (–∏—Å–ø–æ–ª—å–∑—É—é—Ç Stripe, GitHub, Atlassian)

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –ü–æ–ª–Ω—ã–π Error Catalog –≤ GitBook + `AppException` –∫–ª–∞—Å—Å –≤ NestJS + `requestId` –≤ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ + `help` URL –ø—Ä—è–º–æ –≤ JSON

***

### 3Ô∏è‚É£2Ô∏è‚É£ –ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ Webhook Events ‚Äî –∫–∞–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –ø—É–±–ª–∏–∫—É–µ–º –∏ –≤ –∫–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ?

**–í–æ–ø—Ä–æ—Å:** –í Q6 –≤—ã–±—Ä–∞–ª–∏ ¬´Guest + Transaction lifecycle¬ª, –Ω–æ –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∏ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π —Å –∏–º–µ–Ω–∞–º–∏, —Å—Ö–µ–º–∞–º–∏ payload'–æ–≤ –∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –º—ã –ø—É–±–ª–∏–∫—É–µ–º?

**–û—Ç–≤–µ—Ç:** 20 —Å–æ–±—ã—Ç–∏–π, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ 5 –¥–æ–º–µ–Ω–∞–º. –ï–¥–∏–Ω–∞—è envelope-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π.

**–ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ —Å–æ–±—ã—Ç–∏–π:**


| –î–æ–º–µ–Ω | Event Type | –ö–æ–≥–¥–∞ |
| :-- | :-- | :-- |
| **Guest** | `guest.created` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è |
| **Guest** | `guest.updated` | –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è |
| **Guest** | `guest.deleted` | –£–¥–∞–ª–µ–Ω–∏–µ (GDPR) |
| **Guest** | `guest.merged` | –°–ª–∏—è–Ω–∏–µ –¥—É–±–ª–µ–π –∫–∞—Ä—Ç |
| **Transaction** | `transaction.earn` | –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ |
| **Transaction** | `transaction.redeem` | –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ |
| **Transaction** | `transaction.refund` | –í–æ–∑–≤—Ä–∞—Ç –±–∞–ª–ª–æ–≤ |
| **Transaction** | `transaction.manual` | –†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ Admin |
| **Transaction** | `transaction.expire` | –°–≥–æ—Ä–∞–Ω–∏–µ –ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ |
| **Level** | `level.upgraded` | –ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –≥–æ—Å—Ç—è |
| **Promo** | `promo.activated` | –ü—Ä–æ–º–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ –¥–ª—è –≥–æ—Å—Ç—è |
| **Promo** | `promo.expired` | –ü—Ä–æ–º–æ –∏—Å—Ç–µ–∫–ª–æ |
| **POS** | `pos.check.processed` | –ß–µ–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω —á–µ—Ä–µ–∑ POS |
| **POS** | `pos.sync.failed` | –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ POS |
| **Billing** | `subscription.created` | –ù–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ |
| **Billing** | `subscription.renewed` | –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ |
| **Billing** | `subscription.cancelled` | –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏ |
| **Billing** | `subscription.expired` | –ò—Å—Ç–µ—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ |
| **Billing** | `payment.succeeded` | –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ |
| **Billing** | `payment.failed` | –ù–µ—É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ |

**–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è Envelope-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```json
{
  "id": "evt_abc123",
  "type": "transaction.earn",
  "apiVersion": "v1",
  "createdAt": "2026-02-19T16:25:00Z",
  "tenantId": "tenant-uuid",
  "restaurantId": "rest-uuid",
  "data": {
    "transactionId": "txn-uuid",
    "guestId": "guest-uuid",
    "guestPhone": "79991234567",
    "cardId": "card-uuid",
    "earnedPoints": 200,
    "balanceType": "REGULAR",
    "balanceBefore": 2500,
    "balanceAfter": 2700,
    "checkAmount": 2000,
    "posCheckId": "CHK-123456",
    "posSystem": "IIKO_CLOUD",
    "appliedRule": {
      "ruleId": "rule-uuid",
      "ruleName": "–ë–∞–∑–æ–≤—ã–π –∫–µ—à–±—ç–∫ 10%",
      "earnPercent": 10
    }
  }
}
```

**Webhook Subscription API:**

```typescript
// –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
POST /api/v1/webhooks/subscriptions
{
  "url": "https://your-crm.com/webhooks/max-loyalty",
  "events": ["guest.created", "transaction.earn", "level.upgraded"],
  "secret": "whsec_your32charssecret",
  "description": "CRM sync webhook"
}

// –û—Ç–≤–µ—Ç ‚Äî secret –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
{
  "id": "sub-abc123",
  "signingSecret": "whsec_your32charssecret", // —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å!
  "isActive": true
}

// PATCH ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π
PATCH /api/v1/webhooks/subscriptions/sub-abc123
{ "events": ["guest.created", "transaction.earn"] }
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- 20 —Å–æ–±—ã—Ç–∏–π –ø–æ–∫—Ä—ã–≤–∞—é—Ç 100% use cases: CRM-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- –ï–¥–∏–Ω–∞—è envelope = —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø–∏—à–µ—Ç –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ `type`
- `id` —Å–æ–±—ã—Ç–∏—è ‚Üí –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è (—Å–æ—Ö—Ä–∞–Ω—è–µ–º `evt_id`, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–≤–∞–∂–¥—ã)
- `apiVersion` –≤ envelope ‚Üí –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ v2 —Å—Ç–∞—Ä—ã–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –≤–∏–¥—è—Ç –≤–µ—Ä—Å–∏—é –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** 20 —Å–æ–±—ã—Ç–∏–π –ø–æ 5 –¥–æ–º–µ–Ω–∞–º + –µ–¥–∏–Ω–∞—è envelope —Å `id/type/apiVersion/tenantId/data` + PATCH –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ + secret —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏

***

### 3Ô∏è‚É£3Ô∏è‚É£ Interactive API Explorer ‚Äî –∫–∞–∫–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è ¬´Try It Out¬ª?

**–í–æ–ø—Ä–æ—Å:** GitBook ‚Äî —Å—Ç–∞—Ç–∏–∫–∞. –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Ö–æ—á–µ—Ç –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –ø—Ä—è–º–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –±–µ–∑ Postman. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Swagger UI —É—Å—Ç–∞—Ä–µ–ª –∏ –Ω–µ–∫—Ä–∞—Å–∏–≤. –ß—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?

**–û—Ç–≤–µ—Ç:** Scalar ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ Swagger UI (2024‚Äì2025 de facto standard), –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è –≤ NestJS –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π.

```typescript
// apps/backend/src/main.ts
import { ScalarApiReference } from '@scalar/nestjs-api-reference';

app.use('/docs', ScalarApiReference({
  spec: { url: '/api-json' },
  configuration: {
    title: 'Max Loyalty API',
    theme: 'moon',         // —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ ‚Üí —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º–µ
    darkMode: true,
    defaultHttpClient: {
      targetKey: 'node',
      clientKey: 'axios',  // –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ —Å—Ä–∞–∑—É –≤ axios
    },
    authentication: {
      preferredSecurityScheme: 'ApiKeyAuth',
      apiKey: { token: '' }, // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Å–≤–æ–π –∫–ª—é—á
    },
  },
}));
```

**–ì–¥–µ –¥–æ—Å—Ç—É–ø–Ω–æ:**

- Production: `https://api.max-loyalty.com/docs` ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä (–±–µ–∑ Try It Out, –∫–ª—é—á–∏ –Ω–µ –Ω—É–∂–Ω—ã)
- Staging: `https://staging-api.max-loyalty.com/docs` ‚Äî –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π Try It Out —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –∫–ª—é—á–∞–º–∏

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- Scalar –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—ë–º–Ω—É—é —Ç–µ–º—É ‚Üí –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ —Å –Ω–∞—à–∏–º –¥–∏–∑–∞–π–Ω–æ–º
- –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤ –∫–æ–¥–∞: cURL, Node.js (axios), Python ‚Äî —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ø–∏—Ä—É–µ—Ç –≥–æ—Ç–æ–≤—ã–π –∫–æ–¥
- –í—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ –≤ NestJS = –Ω–æ–ª—å drift –º–µ–∂–¥—É –∫–æ–¥–æ–º –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π
- –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π, open source (MIT), –∞–∫—Ç–∏–≤–Ω–æ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è –≤ 2025‚Äì2026
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ Swagger UI ‚Äî –≤–∏–∑—É–∞–ª—å–Ω–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–µ–µ, –±—ã—Å—Ç—Ä–µ–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** Scalar –≤–º–µ—Å—Ç–æ Swagger UI, —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ `moon`, Try It Out —Ç–æ–ª—å–∫–æ –Ω–∞ staging, –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤ –∫–æ–¥–∞ –≤ axios/cURL/Python

***

### 3Ô∏è‚É£4Ô∏è‚É£ –ï–¥–∏–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç Pagination / Filtering / Sorting ‚Äî –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å Query Convention?

**–í–æ–ø—Ä–æ—Å:** –ö–∞–∂–¥—ã–π list-endpoint –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Üí —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø—É—Ç–∞–µ—Ç—Å—è. –ù—É–∂–µ–Ω –µ–¥–∏–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞.

**–û—Ç–≤–µ—Ç:** –ï–¥–∏–Ω—ã–π Query Convention –¥–ª—è –≤—Å–µ—Ö list-endpoints + —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Response Envelope —Å `data + pagination + meta`.

**Query Convention:**

```bash
# PAGINATION ‚Äî offset-based (MVP)
GET /api/v1/guests?limit=50&offset=0

# SORTING
GET /api/v1/guests?sortBy=createdAt&sortOrder=desc
# sortOrder: asc | desc

# FILTERING ‚Äî –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–æ–ª—è–º
GET /api/v1/transactions?type=EARN&dateFrom=2026-01-01&dateTo=2026-02-01
GET /api/v1/guests?level=GOLD&minBalance=1000&maxBalance=50000

# FULL-TEXT SEARCH
GET /api/v1/guests?search=–ò–≤–∞–Ω

# FIELD SELECTION
GET /api/v1/guests?fields=id,phone,firstName,totalBalance
```

**–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Response Envelope:**

```json
{
  "data": [ ...–º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤... ],
  "pagination": {
    "total": 1247,
    "limit": 50,
    "offset": 0,
    "hasNext": true,
    "hasPrev": false,
    "nextOffset": 50,
    "prevOffset": null
  },
  "meta": {
    "requestId": "req_abc123",
    "responseTime": 87
  }
}
```

**NestJS —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–æ–±—â–∏–π DTO):**

```typescript
// libs/common/src/dto/pagination.dto.ts
export class PaginationDto {
  @IsOptional() @IsInt() @Min(1) @Max(100)
  limit?: number = 50;

  @IsOptional() @IsInt() @Min(0)
  offset?: number = 0;

  @IsOptional() @IsString()
  sortBy?: string;

  @IsOptional() @IsEnum(['asc', 'desc'])
  sortOrder?: 'asc' | 'desc' = 'desc';

  @IsOptional() @IsString()
  search?: string;

  @IsOptional() @IsString()
  fields?: string; // comma-separated
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- –ï–¥–∏–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç ‚Üí —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑—É—á–∞–µ—Ç –æ–¥–∏–Ω —Ä–∞–∑, –ø—Ä–∏–º–µ–Ω—è–µ—Ç –≤–µ–∑–¥–µ
- `total` –≤ pagination ‚Üí —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –º–æ–∂–µ—Ç –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ç–æ—Ä –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- `requestId` –≤ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ ‚Üí —Ç—Ä–µ–π—Å–∏–Ω–≥ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É
- Max `limit=100` ‚Üí –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ `limit=999999`

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –ï–¥–∏–Ω—ã–π `PaginationDto` (–Ω–∞—Å–ª–µ–¥—É—é—Ç –≤—Å–µ list-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã) + —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π envelope `{data, pagination, meta}` + `limit` max 100 + `responseTime` –≤ ms

***

### 3Ô∏è‚É£5Ô∏è‚É£ –ö–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å Multi-tenancy –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä–æ–≤?

**–í–æ–ø—Ä–æ—Å:** –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω –ø–æ–Ω–∏–º–∞—Ç—å –∏–∑–æ–ª—è—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã –Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `tenantId` –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –æ–∂–∏–¥–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤. –ö–∞–∫ —ç—Ç–æ –æ–±—ä—è—Å–Ω–∏—Ç—å?

**–û—Ç–≤–µ—Ç:** –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´Tenant Isolation¬ª –≤ GitBook —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ —Ç–æ–≥–æ, —á—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∏ –ø–æ—á–µ–º—É.

```markdown
## Tenant Isolation

Your API Key is automatically scoped to your tenant.
You never need to pass tenantId in requests.

‚úÖ CORRECT:
GET /api/v1/guests
‚Üí Returns guests of YOUR restaurant only

‚ùå WRONG (ignored, will cause confusion):
GET /api/v1/guests?tenantId=xxx
‚Üí tenantId parameter is ignored ‚Äî isolation enforced server-side

‚ùå WRONG (will fail with 403):
GET /api/v1/tenants/other-tenant/guests
‚Üí 403 INSUFFICIENT_PERMISSIONS

## What this means for you:
- All responses already filtered to your tenant
- You CANNOT access other tenants' data (ever)
- If you manage multiple restaurant chains ‚Äî create separate API keys
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- –ß–∞—Å—Ç–∞—è –æ—à–∏–±–∫–∞ –Ω–æ–≤—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä–æ–≤: –ø–µ—Ä–µ–¥–∞—é—Ç `tenantId` –∏–∑ —Å—Ç–∞—Ä–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ API
- –Ø–≤–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å–Ω–∏–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ support-—Ç–∏–∫–µ—Ç–æ–≤
- –ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ ¬´–≤–∞—à –∫–ª—é—á = –≤–∞—à —Ç–µ–Ω–∞–Ω—Ç¬ª –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´Tenant Isolation¬ª –≤ GitBook + —è–≤–Ω—ã–π –ø—Ä–∏–º–µ—Ä ‚úÖ/‚ùå + –∑–∞–º–µ—Ç–∫–∞ –≤ Quick Start Guide

***

### 3Ô∏è‚É£6Ô∏è‚É£ OpenAPI Spec Drift ‚Äî –∫–∞–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è = –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–¥?

**–í–æ–ø—Ä–æ—Å:** –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–∏–ª –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä, –∑–∞–±—ã–ª –æ–±–Ω–æ–≤–∏—Ç—å Swagger-–¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–∏—Ç—Å—è —Å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é. –ö–∞–∫ —ç—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏?

**–û—Ç–≤–µ—Ç:** Code-First –ø–æ–¥—Ö–æ–¥ (NestJS –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã ‚Üí OpenAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) + CI/CD Snapshot Test, –∫–æ—Ç–æ—Ä—ã–π –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏.

**Code-First: –∫–æ–¥ IS –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**

```typescript
@ApiOperation({ summary: 'Create guest' })
@ApiBody({ type: CreateGuestDto })
@ApiResponse({ status: 201, type: GuestResponseDto })
@ApiResponse({ status: 409, description: 'Duplicate phone' })
@Post()
async createGuest(@Body() dto: CreateGuestDto) {}
```

**CI/CD Snapshot Test:**

```yaml
# .github/workflows/api-spec.yml
- name: Generate current OpenAPI spec
  run: |
    npm run start &
    sleep 5
    curl http://localhost:3000/api-json > openapi-current.json

- name: Compare with committed spec
  run: |
    if ! diff openapi-committed.json openapi-current.json; then
      echo "‚ùå OpenAPI spec changed unexpectedly!"
      echo "Run: npm run update-openapi-spec"
      exit 1
    fi
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–Ω–∞–º–µ—Ä–µ–Ω–Ω–æ–µ):**

```bash
# –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏ –∫–æ–º–º–∏—Ç–∏—Ç
npm run update-openapi-spec
git add openapi-committed.json
git commit -m "docs: update OpenAPI spec ‚Äî added guest.merge endpoint"
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- Code-First = –Ω–µ—Ç drift –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é (–∫–æ–¥ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚Äî –æ–¥–Ω–∞ —Å—É—â–Ω–æ—Å—Ç—å)
- Snapshot Test = —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ —Å–ª—É—á–∞–π–Ω–æ —Å–ª–æ–º–∞–ª –∫–æ–Ω—Ç—Ä–∞–∫—Ç ‚Äî CI –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç
- –ü—Ä–æ—Ü–µ—Å—Å ¬´—Å–ª–æ–º–∞–ª CI ‚Üí –æ–±–Ω–æ–≤–ª—è–π —Å–ø–µ–∫—É –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ¬ª —Å–æ–∑–¥–∞—ë—Ç –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö API
- GitBook –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å–ø–µ–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ webhook –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ merge

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** Code-First NestJS –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã + CI Snapshot Test + `npm run update-openapi-spec` –∫–æ–º–∞–Ω–¥–∞ + –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å GitBook —á–µ—Ä–µ–∑ webhook

***

### 3Ô∏è‚É£7Ô∏è‚É£ –ö–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å Idempotency –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π?

**–í–æ–ø—Ä–æ—Å:** POS-–∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω —á—ë—Ç–∫–æ –ø–æ–Ω–∏–º–∞—Ç—å: —á—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ webhook –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –¥–≤–∞–∂–¥—ã? –ö–∞–∫ —ç—Ç–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å—Ç—Ä–∞—Ö–∞ –ø–µ—Ä–µ–¥ –¥—É–±–ª—è–º–∏?

**–û—Ç–≤–µ—Ç:** –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´Idempotency¬ª —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–æ–≤ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–ª—è POS, —Ä—É—á–Ω–æ–π —á–µ—Ä–µ–∑ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è API).

```markdown
## Automatic (POS Webhooks) ‚Äî no action needed

Max Loyalty deduplicates POS webhooks automatically by `posCheckId`.
If your POS sends the same check twice ‚Äî balls are credited ONCE.

// First request ‚Äî processed normally
POST /api/v1/webhooks/pos/transaction
{ "posCheckId": "CHK-123456", "checkAmount": 2000 }
‚Üí { "success": true, "earnedPoints": 200, "alreadyProcessed": false }

// Duplicate ‚Äî same result, no double crediting
POST /api/v1/webhooks/pos/transaction
{ "posCheckId": "CHK-123456", "checkAmount": 2000 }
‚Üí { "success": true, "earnedPoints": 200, "alreadyProcessed": true }

‚úÖ Your retry logic is SAFE. Always retry on network errors.

## Manual (API Calls) ‚Äî use Idempotency-Key header

For your own retry logic, provide a unique key per operation:

curl -X POST /api/v1/loyalty/manual-adjustment \
  -H "Idempotency-Key: adj_$(uuidgen)" \
  -d '{"amount": 500, "reason": "Compensation"}'

// Same Idempotency-Key sent again ‚Üí returns cached result
// Different Idempotency-Key ‚Üí new operation
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- ¬´–í—Å–µ–≥–¥–∞ –¥–µ–ª–∞–π retry –ø—Ä–∏ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–µ¬ª ‚Äî —ç—Ç–æ –ü–†–ê–í–ò–õ–¨–ù–û, –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ —ç—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å
- `alreadyProcessed: true` –≤ –æ—Ç–≤–µ—Ç–µ = —è–≤–Ω—ã–π —Å–∏–≥–Ω–∞–ª –æ –¥—É–±–ª–µ (–Ω–µ —Å–∫—Ä—ã–≤–∞–µ–º, –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º)
- –ö–ª—é—á TTL 24 —á–∞—Å–∞ (Redis) ‚Üí –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –ª—é–±—ã–µ —Ä–∞–∑—É–º–Ω—ã–µ retry-—Å—Ü–µ–Ω–∞—Ä–∏–∏

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´Idempotency¬ª —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ ‚úÖ/‚ùå + `alreadyProcessed` —Ñ–ª–∞–≥ –≤ –æ—Ç–≤–µ—Ç–µ + Idempotency-Key header –¥–ª—è —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π + —è–≤–Ω–æ–µ ¬´retry is safe¬ª –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

***

### 3Ô∏è‚É£8Ô∏è‚É£ Time-to-First-API-Call ‚Äî –∫–∞–∫ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –¥–æ 5 –º–∏–Ω—É—Ç?

**–í–æ–ø—Ä–æ—Å:** –ß–µ–º –±—ã—Å—Ç—Ä–µ–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–≤—ã–π —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Äî —Ç–µ–º –≤—ã—à–µ —à–∞–Ω—Å, —á—Ç–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ—Å—Ç–æ–∏—Ç—Å—è. –ö–∞–∫ –≤—ã—Å—Ç—Ä–æ–∏—Ç—å onboarding, —á—Ç–æ–±—ã –æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–æ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–æ—à–ª–æ –Ω–µ –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç?

**–û—Ç–≤–µ—Ç:** Onboarding Checklist + Pre-seeded —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ + Pre-filled Postman Collection + Magic –æ–¥–∏–Ω –∫–ª–∏–∫.

**5-–º–∏–Ω—É—Ç–Ω—ã–π –ø—É—Ç—å:**

```
30 —Å–µ–∫  ‚Üí –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ staging-app.max-loyalty.com
30 —Å–µ–∫  ‚Üí –ê–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ tenant + 10 —Ç–µ—Å—Ç–æ–≤—ã—Ö –≥–æ—Å—Ç–µ–π —Å –±–∞–ª–∞–Ω—Å–∞–º–∏
1 –º–∏–Ω   ‚Üí –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ API –∫–ª—é—á–∞ (mlk_test_...)
1 –º–∏–Ω   ‚Üí Fork Postman Public Workspace ‚Üí –æ–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞
2 –º–∏–Ω   ‚Üí –ó–∞–ø—É—Å–∫–∞–µ–º "Quick Start ‚Üí 1. Health Check" ‚Üí –≤–∏–¥–∏–º —Ä–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
5 –º–∏–Ω   ‚úÖ –ü–µ—Ä–≤—ã–π —É—Å–ø–µ—à–Ω—ã–π API-–≤—ã–∑–æ–≤
```

**Pre-seeded staging –¥–∞–Ω–Ω—ã–µ (—Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):**

```typescript
// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ staging-–∞–∫–∫–∞—É–Ω—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è:
async seedStagingTenant(tenantId: string) {
  // 10 —Ç–µ—Å—Ç–æ–≤—ã—Ö –≥–æ—Å—Ç–µ–π —Å —Ä–∞–∑–Ω—ã–º–∏ –±–∞–ª–∞–Ω—Å–∞–º–∏ –∏ —É—Ä–æ–≤–Ω—è–º–∏
  await this.createTestGuests(tenantId, 10);
  // 3 –ø—Ä–∞–≤–∏–ª–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (Bronze 5%, Silver 10%, Gold 15%)
  await this.createDefaultRules(tenantId);
  // 2 –ø—Ä–æ–º–æ-–∫–∞–º–ø–∞–Ω–∏–∏ (–î–† + –ø–µ—Ä–≤—ã–π —á–µ–∫)
  await this.createSamplePromos(tenantId);
  // 1 POS-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Sandbox-—Ä–µ–∂–∏–º–µ
  await this.createSandboxPOS(tenantId);
}
```

**Postman Collection —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```
Max Loyalty API ‚Äî Quick Start
‚îú‚îÄ‚îÄ üöÄ Step 1: Health Check
‚îú‚îÄ‚îÄ üöÄ Step 2: Get My Tenant Info
‚îú‚îÄ‚îÄ üöÄ Step 3: List Test Guests (10 pre-created)
‚îú‚îÄ‚îÄ üöÄ Step 4: Create New Guest
‚îî‚îÄ‚îÄ üöÄ Step 5: Process Transaction (earn balls)
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- Pre-seeded –¥–∞–Ω–Ω—ã–µ = —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∏–¥–∏—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, –Ω–µ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
- Postman Collection —Å –≥–æ—Ç–æ–≤—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ = –Ω–µ—Ç –Ω—É–∂–¥—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å Base URL –∏ Headers –≤—Ä—É—á–Ω—É—é
- Stripe –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∞–∫–æ–π –∂–µ –ø–æ–¥—Ö–æ–¥ ‚Äî —ç—Ç–æ –ø—Ä–∏—á–∏–Ω–∞ –∏—Ö –≤—ã—Å–æ–∫–æ–π adoption rate

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** Auto-seed –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ staging-–∞–∫–∫–∞—É–Ω—Ç–∞ (10 –≥–æ—Å—Ç–µ–π, 3 –ø—Ä–∞–≤–∏–ª–∞, 2 –ø—Ä–æ–º–æ, 1 sandbox POS) + Postman Public Workspace —Å Quick Start collection + 5-—à–∞–≥–æ–≤—ã–π checklist –≤ –Ω–∞—á–∞–ª–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

***

### 3Ô∏è‚É£9Ô∏è‚É£ Webhook Debugging ‚Äî –∫–∞–∫ –ø–æ–º–æ—á—å –æ—Ç–ª–∞–¥–∏—Ç—å webhook?

**–í–æ–ø—Ä–æ—Å:** –°–∞–º–∞—è —á–∞—Å—Ç–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä–æ–≤: ¬´—è –æ—Ç–ø—Ä–∞–≤–ª—è—é webhook, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç¬ª. –ö–∞–∫ –¥–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏ –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É?

**–û—Ç–≤–µ—Ç:** Webhook Event Log –≤ Admin Panel + Replay –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è + Test Trigger + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ª–æ–∫–∞–ª—å–Ω—ã–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º.

**Webhook Event Log API:**

```typescript
// –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ (30 –¥–Ω–µ–π)
GET /api/v1/webhooks/subscriptions/{subId}/events?status=FAILED&limit=20
‚Üí {
  "data": [
    {
      "id": "evt_abc123",
      "type": "guest.created",
      "status": "DELIVERED",      // PENDING | DELIVERED | FAILED
      "attempts": 1,
      "statusCode": 200,
      "duration": 145,            // ms
      "deliveredAt": "2026-02-19T16:25:00Z"
    },
    {
      "id": "evt_def456",
      "type": "transaction.earn",
      "status": "FAILED",
      "attempts": 3,
      "lastError": "Connection timeout (read timeout: 30s)",
      "nextRetryAt": "2026-02-19T16:30:00Z"  // —Å–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞
    }
  ]
}

// Replay –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è (–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞)
POST /api/v1/webhooks/events/evt_def456/replay
‚Üí { "success": true, "newEventId": "evt_xyz789" }

// Test Trigger ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π payload
POST /api/v1/webhooks/subscriptions/sub-abc123/test
{ "eventType": "guest.created" }
‚Üí { "success": true, "eventId": "evt_test_123", "statusCode": 200 }
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**

```markdown
## Testing Webhooks Locally

Option 1: webhook.site (simplest)
1. Go to webhook.site ‚Äî copy unique URL
2. Register: POST /api/v1/webhooks/subscriptions {"url": "https://webhook.site/..."}
3. Trigger test: POST /api/v1/webhooks/subscriptions/{id}/test
4. See payload in real-time on webhook.site

Option 2: ngrok (local server)
1. ngrok http 3000
2. Register your ngrok URL as webhook
3. Test against your local application
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- Event Log + Replay = —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∞–º –Ω–∞—Ö–æ–¥–∏—Ç –∏ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- Test Trigger = –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- `lastError` —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º (–Ω–µ –ø—Ä–æ—Å—Ç–æ ¬´failed¬ª) = —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç –ø—Ä–∏—á–∏–Ω—É (timeout, 4xx, 5xx)
- 30 –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è = –º–æ–∂–Ω–æ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã –Ω–µ–¥–µ–ª—å–Ω–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** Webhook Event Log –≤ Admin Panel (30 –¥–Ω–µ–π) + Replay endpoint + Test Trigger + —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´Testing Webhooks¬ª —Å webhook.site –∏ ngrok –ø—Ä–∏–º–µ—Ä–∞–º–∏

***

### 4Ô∏è‚É£0Ô∏è‚É£ Rate Limits ‚Äî –∫–∞–∫ –¥–æ–Ω–æ—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã –¥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏?

**–í–æ–ø—Ä–æ—Å:** –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç 429 –∏ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç, –∫–∞–∫ –¥–æ–ª–≥–æ –∂–¥–∞—Ç—å, —Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å, –∏ –∫–∞–∫–∏–µ —É –Ω–µ–≥–æ –ª–∏–º–∏—Ç—ã –Ω–∞ –µ–≥–æ —Ç–∞—Ä–∏—Ñ–µ. –ö–∞–∫ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ –ª–∏–º–∏—Ç–∞—Ö –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ?

**–û—Ç–≤–µ—Ç:** Response Headers —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –ª–∏–º–∏—Ç–∞ –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ + —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π 429-–æ—Ç–≤–µ—Ç —Å `Retry-After` + –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º + –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –≤ SDK.

**Response Headers (–∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å):**

```http
HTTP/1.1 200 OK
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 847
X-RateLimit-Reset: 1740004800     ‚Üê Unix timestamp —Å–±—Ä–æ—Å–∞
X-RateLimit-Tier: standard
X-RateLimit-Endpoint-Limit: 120  ‚Üê –ª–∏–º–∏—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ endpoint
X-RateLimit-Endpoint-Remaining: 78
```

**429 –æ—Ç–≤–µ—Ç:**

```json
{
  "type": "https://docs.max-loyalty.com/errors/RATE_LIMIT_EXCEEDED",
  "status": 429,
  "errorCode": "RATE_LIMIT_EXCEEDED",
  "detail": "Exceeded 1000 requests/hour. 253 requests remaining this window.",
  "retryAfter": 3600,
  "limit": 1000,
  "remaining": 0,
  "resetAt": "2026-02-19T17:00:00Z"
}
```

**–¢–∞–±–ª–∏—Ü–∞ –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**


| Endpoint | Standard | Pro | Ultimate |
| :-- | :-- | :-- | :-- |
| –û–±—â–∏–π (–≤ —á–∞—Å) | 1 000 | 5 000 | 20 000 |
| `POST /loyalty/transactions` | 120/–º–∏–Ω | 500/–º–∏–Ω | 2 000/–º–∏–Ω |
| `POST /webhooks/pos/*` | 20/10 —Å–µ–∫ | 100/10 —Å–µ–∫ | 500/10 —Å–µ–∫ |
| `GET /guests` (—Å–ø–∏—Å–æ–∫) | 200/–º–∏–Ω | 1 000/–º–∏–Ω | 5 000/–º–∏–Ω |
| –ü–µ—Ä–µ–≤–æ–¥—ã –±–∞–ª–ª–æ–≤ | 3/–º–∏–Ω | 10/–º–∏–Ω | 50/–º–∏–Ω |

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –≤ SDK:**

```typescript
const client = new MaxLoyaltyClient({
  apiKey: process.env.MAX_LOYALTY_API_KEY,
  retry: {
    maxAttempts: 3,
    onRateLimit: 'wait', // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∂–¥—ë—Ç Retry-After —Å–µ–∫—É–Ω–¥
  }
});
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–µ headers = —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∏–¥–∏—Ç `Remaining: 3` –∏ –∑–∞–º–µ–¥–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –î–û 429
- `Retry-After` –≤ —Å–µ–∫—É–Ω–¥–∞—Ö = —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∑–Ω–∞–µ—Ç —Ç–æ—á–Ω–æ, –∫–æ–≥–¥–∞ –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
- –¢–∞–±–ª–∏—Ü–∞ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º = –º–æ—Ç–∏–≤–∞—Ü–∏—è –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `X-RateLimit-*` headers –≤ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ + `Retry-After` –≤ 429 + —Ç–∞–±–ª–∏—Ü–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ + `onRateLimit: 'wait'` —Ä–µ–∂–∏–º –≤ SDK

***

### 4Ô∏è‚É£1Ô∏è‚É£ Pagination ‚Äî –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Offset –∏ –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ Cursor?

**–í–æ–ø—Ä–æ—Å:** Offset pagination –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç –ø—Ä–∏ `offset > 10 000`. –ù—É–∂–Ω–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ –∏ –ø–æ–∫–∞–∑–∞—Ç—å path –∫ Cursor Pagination –≤ v2.

**–û—Ç–≤–µ—Ç:** –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–∞ —Ä–µ–∂–∏–º–∞ —Å —è–≤–Ω—ã–º–∏ ‚ö†Ô∏è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏ + Bulk Export –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö.

**Offset Pagination (v1 ‚Äî —Ç–µ–∫—É—â–∏–π):**

```bash
GET /api/v1/guests?limit=50&offset=0     # —Ö–æ—Ä–æ—à–æ
GET /api/v1/guests?limit=50&offset=50    # —Ö–æ—Ä–æ—à–æ
GET /api/v1/guests?limit=50&offset=9950  # ‚ö†Ô∏è –º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–∏ 10k+ –∑–∞–ø–∏—Å—è—Ö
```

**‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**

```markdown
Warning: Avoid offset > 10,000 ‚Äî PostgreSQL performance degrades.
For large exports, use the Bulk Export endpoint instead.
```

**Bulk Export (–¥–ª—è > 10k –∑–∞–ø–∏—Å–µ–π):**

```typescript
// –®–∞–≥ 1: –ó–∞–ø—Ä–æ—Å–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç
POST /api/v1/exports
{
  "type": "GUESTS",
  "filters": { "level": "GOLD", "minBalance": 1000 },
  "format": "CSV"   // CSV | JSON | XLSX
}
‚Üí { "exportId": "exp-abc123", "status": "PROCESSING" }

// –®–∞–≥ 2: Polling —Å—Ç–∞—Ç—É—Å–∞
GET /api/v1/exports/exp-abc123
‚Üí { "status": "READY", "downloadUrl": "https://r2.max-loyalty.com/...",
    "expiresAt": "2026-02-19T18:00:00Z", "rowCount": 45820 }

// –®–∞–≥ 3: –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª (URL –¥–µ–π—Å—Ç–≤—É–µ—Ç 1 —á–∞—Å)
GET https://r2.max-loyalty.com/exports/exp-abc123.csv
```

**Cursor Pagination (v2 ‚Äî Phase 2):**

```bash
GET /api/v2/guests?limit=50
‚Üí { "data": [...], "nextCursor": "eyJpZCI6Ijg3NiJ9" }

GET /api/v2/guests?limit=50&cursor=eyJpZCI6Ijg3NiJ9
‚Üí { "data": [...], "nextCursor": "eyJpZCI6IjkyMiJ9" }
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- –Ø–≤–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ = —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ —Å—Ç—Ä–æ–∏—Ç –ø–∞–≥–∏–Ω–∞—Ç–æ—Ä –¥–æ –º–∏–ª–ª–∏–æ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏
- Bulk Export = –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è ETL/analytics –∑–∞–¥–∞—á
- CSV/XLSX –≤ R2 = export –Ω–µ –≥—Ä—É–∑–∏—Ç API —Å–µ—Ä–≤–µ—Ä
- Cursor –≤ v2 = –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –∫–∞–∫ roadmap ‚Üí —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∑–Ω–∞–µ—Ç, –∫–æ–≥–¥–∞ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** Offset MVP (limit max 100, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ > 10k) + `POST /api/v1/exports` Bulk Export (async, polling, R2 URL) + Cursor Pagination –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –∫–∞–∫ v2

***

### 4Ô∏è‚É£2Ô∏è‚É£ Field Selection ‚Äî –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å `?fields=` —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ?

**–í–æ–ø—Ä–æ—Å:** –í Q11 –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∏ `?fields=`, –Ω–æ –Ω–µ—Ç –ø—Ä–∏–º–µ—Ä–æ–≤ —ç–∫–æ–Ω–æ–º–∏–∏ bandwidth –∏ –Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è, –∫–∞–∫–∏–µ –ø–æ–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞.

**–û—Ç–≤–µ—Ç:** –†–∞–∑–¥–µ–ª ¬´Optimizing Response Size¬ª —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ —ç–∫–æ–Ω–æ–º–∏–∏ + —Ç–∞–±–ª–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–ª–µ–π –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤.

**–ü—Ä–∏–º–µ—Ä—ã —ç–∫–æ–Ω–æ–º–∏–∏:**

```bash
# –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –≥–æ—Å—Ç—è ‚Äî 3KB (–≤—Å–µ –ø–æ–ª—è)
GET /api/v1/guests/uuid-123
‚Üí id, phone, firstName, lastName, email, birthDate, createdAt,
  card.totalBalance, card.regularBalance, card.promoBalance,
  card.level, card.levelProgress, card.qrCode, card.displayCode,
  card.visitCount, card.lifetimeSpent, profile.children, ...

# –î–ª—è Cashier Interface ‚Äî —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–µ ‚Äî 180 bytes (94% —ç–∫–æ–Ω–æ–º–∏—è)
GET /api/v1/guests/uuid-123?fields=id,phone,firstName,card.totalBalance,card.level,card.displayCode

# –î–ª—è POS –ø—Ä–µ–¥—Ä–∞—Å—á—ë—Ç–∞ ‚Äî 250 bytes
GET /api/v1/guests?phone=79991234567&fields=id,card.totalBalance,card.level,card.qrCode

# –î–ª—è CRM —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ‚Äî 400 bytes
GET /api/v1/guests?fields=id,phone,firstName,lastName,email,card.level,card.lifetimeSpent
```

**–¢–∞–±–ª–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–ª–µ–π (Guest):**


| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| `id` | string | UUID –≥–æ—Å—Ç—è |
| `phone` | string | –¢–µ–ª–µ—Ñ–æ–Ω (79991234567) |
| `firstName` | string | –ò–º—è |
| `lastName` | string | –§–∞–º–∏–ª–∏—è |
| `card.totalBalance` | number | –°—É–º–º–∞—Ä–Ω—ã–π –±–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤ |
| `card.regularBalance` | number | –û—Å–Ω–æ–≤–Ω—ã–µ –±–∞–ª–ª—ã |
| `card.promoBalance` | number | –ê–∫—Ü–∏–æ–Ω–Ω—ã–µ –±–∞–ª–ª—ã |
| `card.level` | string | –£—Ä–æ–≤–µ–Ω—å (BRONZE/SILVER/GOLD) |
| `card.displayCode` | string | 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –¥–ª—è –∫–∞—Å—Å—ã |
| `card.qrCode` | string | QR-–∫–æ–¥ (base64) |
| `card.lifetimeSpent` | number | –°—É–º–º–∞ –≤—Å–µ—Ö —á–µ–∫–æ–≤ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è |

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã —ç–∫–æ–Ω–æ–º–∏–∏ (94%) —É–±–µ–∂–¥–∞—é—Ç –ª—É—á—à–µ, —á–µ–º –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ ¬´bandwidth optimization¬ª
- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª–µ–π = —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –≥–∞–¥–∞–µ—Ç, –∫–∞–∫–æ–µ –ø–æ–ª–µ –∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è
- Nested fields (`card.totalBalance`) –ø–æ–∫—Ä—ã–≤–∞—é—Ç —Å–∞–º—ã–π —á–∞—Å—Ç—ã–π use case

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –†–∞–∑–¥–µ–ª ¬´Optimizing Response Size¬ª —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ —ç–∫–æ–Ω–æ–º–∏–∏ + —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª–µ–π –¥–ª—è Guest, Transaction, LoyaltyRule + –ø–æ–¥–¥–µ—Ä–∂–∫–∞ nested fields —á–µ—Ä–µ–∑ `.` –Ω–æ—Ç–∞—Ü–∏—é

***

### 4Ô∏è‚É£3Ô∏è‚É£ API Keys ‚Äî –ø–æ–ª–Ω—ã–π lifecycle: —Å–æ–∑–¥–∞–Ω–∏–µ, permissions, rotation, revoke?

**–í–æ–ø—Ä–æ—Å:** –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã —Ñ–æ—Ä–º–∞—Ç—ã –∫–ª—é—á–µ–π (`mlk_live_...`), –Ω–æ –Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ lifecycle: –∫–∞–∫–∏–µ scopes —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –∫–∞–∫ –¥–µ–ª–∞—Ç—å rotation –±–µ–∑ downtime, –∫–∞–∫ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —É—Ç–µ—á–∫—É.

**–û—Ç–≤–µ—Ç:** Permission Scopes Matrix + Zero-downtime rotation guide + Emergency revoke –ø—Ä–æ—Ü–µ–¥—É—Ä–∞.

**Permission Scopes:**


| Scope | –†–∞–∑—Ä–µ—à–∞–µ—Ç | –¢–∏–ø–∏—á–Ω—ã–π use case |
| :-- | :-- | :-- |
| `guests:read` | GET /guests, /guests/:id | CRM, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ |
| `guests:write` | POST, PATCH /guests | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥–æ—Å—Ç–µ–π |
| `guests:delete` | DELETE /guests/:id | GDPR-—É–¥–∞–ª–µ–Ω–∏–µ |
| `transactions:read` | GET /transactions | –ê–Ω–∞–ª–∏—Ç–∏–∫–∞, –æ—Ç—á—ë—Ç—ã |
| `transactions:write` | POST /loyalty/transactions | POS-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è |
| `webhooks:manage` | CRUD /webhooks/subscriptions | CRM, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ |
| `analytics:read` | GET /analytics/* | BI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã |
| `admin` | –í—Å—ë –≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–µ | –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã |

**–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ scopes –ø–æ use case:**


| Use Case | Scopes |
| :-- | :-- |
| POS Integration | `guests:read`, `guests:write`, `transactions:write` |
| CRM Sync | `guests:read`, `webhooks:manage` |
| Analytics Dashboard | `analytics:read`, `guests:read` |
| Marketing Automation | `guests:read`, `webhooks:manage` |
| Full Access | `admin` |

**Zero-downtime Rotation (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫–∞–∂–¥—ã–µ 90 –¥–Ω–µ–π):**

```markdown
Step 1: Create new API key (same permissions)
         ‚Üí mlk_live_NEW_KEY_HERE

Step 2: Update environment variable in your system
         MAX_LOYALTY_API_KEY=mlk_live_NEW_KEY_HERE

Step 3: Deploy your application

Step 4: Verify new key works (check your monitoring)

Step 5: Revoke old key
         Admin Panel ‚Üí Settings ‚Üí API Keys ‚Üí [Old Key] ‚Üí Revoke

‚è± Grace Period: Old key remains valid for 24 hours after revocation
               (prevents accidental lockout during deployment)
```

**Emergency Revoke (—É—Ç–µ—á–∫–∞ –∫–ª—é—á–∞):**

```markdown
1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ: Admin Panel ‚Üí API Keys ‚Üí [Compromised Key] ‚Üí Revoke Now
   ‚Üê —Ä–∞–±–æ—Ç–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –±–µ–∑ grace period

2. –ü—Ä–æ–≤–µ—Ä—å Activity Log –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
   GET /api/v1/audit?apiKeyId=...&dateFrom=...

3. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –∫–ª—é—á —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ scopes

4. –û–±–Ω–æ–≤–∏ –≤—Å–µ —Å–∏—Å—Ç–µ–º—ã
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- –ü—Ä–∏–Ω—Ü–∏–ø –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π: POS –Ω–µ –Ω—É–∂–µ–Ω `analytics:read` ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º —è–≤–Ω–æ
- 24-—á–∞—Å–æ–≤–æ–π grace period = –Ω–µ—Ç —Å—Ç—Ä–∞—Ö–∞ –¥–µ–ª–∞—Ç—å rotation (–Ω–µ—Ç —Ä–∏—Å–∫–∞ —Å–ª–æ–º–∞—Ç—å –ø—Ä–æ–¥–∞–∫—à–µ–Ω)
- Emergency revoke –±–µ–∑ grace period = –∫—Ä–∏—Ç–∏—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏ —É—Ç–µ—á–∫–µ

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** 8 scopes —Å Permission Matrix + —Ç–∞–±–ª–∏—Ü–∞ ¬´use case ‚Üí scopes¬ª + Zero-downtime rotation guide (5 —à–∞–≥–æ–≤) + 24—á grace period + –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π Emergency Revoke –ø—Ä–∏ —É—Ç–µ—á–∫–µ

***

### 4Ô∏è‚É£4Ô∏è‚É£ –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ‚Äî RU –∏–ª–∏ EN –∫–∞–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç?

**–í–æ–ø—Ä–æ—Å:** –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –†–§, –Ω–æ POS-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (iiko/R-Keeper) –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –°–ù–ì –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ. –ù—É–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é? –ù–∞ –∫–∞–∫–æ–º —è–∑—ã–∫–µ –ø–∏—Å–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?

**–û—Ç–≤–µ—Ç:** EN ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (API Reference, Error Codes), RU ‚Äî –ø–µ—Ä–≤–∏—á–Ω–æ –¥–ª—è Integration Guides (POS iiko/R-Keeper ‚Äî —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è).

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**


| –†–∞–∑–¥–µ–ª | EN | RU | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
| :-- | :-- | :-- | :-- |
| API Reference (Swagger) | ‚úÖ | ‚ùå | EN-only (tech) |
| Error Codes Reference | ‚úÖ | ‚ùå | EN-only (machine-readable) |
| Quick Start Guide | ‚úÖ | ‚úÖ | –û–±–∞ (MVP) |
| POS Integration Guide (iiko) | ‚úÖ | ‚úÖ | **RU-first** |
| POS Integration Guide (R-Keeper) | ‚úÖ | ‚úÖ | **RU-first** |
| SDK README | ‚úÖ | ‚ùå | EN-only |
| Admin Panel UI | ‚ùå | ‚úÖ | RU-only |

**GitBook —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```
docs.max-loyalty.com/         ‚Üê EN (default)
docs.max-loyalty.com/ru/      ‚Üê RU
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã (API, REST, HMAC, JSON) ‚Äî EN universal, –ø–µ—Ä–µ–≤–æ–¥ —Å–æ–∑–¥–∞—ë—Ç –ø—É—Ç–∞–Ω–∏—Ü—É
- POS-–∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä—ã –≤ –†–§ —á–∏—Ç–∞—é—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º ‚Äî —ç—Ç–æ –ø—Ä—è–º–æ –≤–ª–∏—è–µ—Ç –Ω–∞ adoption
- Error codes EN = —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑ –ª—é–±–æ–π —Å—Ç—Ä–∞–Ω—ã –º–æ–≥—É—Ç –≥—É–≥–ª–∏—Ç—å error code –±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–∞
- –î–≤–∞ —è–∑—ã–∫–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã: Quick Start + POS Guide ‚Äî —ç—Ç–æ 2 –¥–æ–∫—É–º–µ–Ω—Ç–∞

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** EN –¥–ª—è API Reference + Error Codes + SDK; RU –¥–ª—è Quick Start + POS Guides (iiko/R-Keeper); GitBook `/ru/` route; –º–∞—à–∏–Ω–æ—á–∏—Ç–∞–µ–º—ã–µ —á–∞—Å—Ç–∏ (errorCode, eventType) ‚Äî –≤—Å–µ–≥–¥–∞ EN

***

### 4Ô∏è‚É£5Ô∏è‚É£ Documentation Health ‚Äî –∫–∞–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ—Å—Ç–∞—ë—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π?

**–í–æ–ø—Ä–æ—Å:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —É—Å—Ç–∞—Ä–µ–≤–∞–µ—Ç. –ù–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏. –ß–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ —Å–ª–æ–º–∞–Ω—ã, —Å—Å—ã–ª–∫–∏ –±–∏—Ç—ã–µ. –ö–∞–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏?

**–û—Ç–≤–µ—Ç:** Automated Documentation Health Check ‚Äî GitHub Actions cron, –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç 4 –∞—Å–ø–µ–∫—Ç–∞.

```yaml
# .github/workflows/docs-health.yml
name: Documentation Health Check
on:
  schedule:
    - cron: '0 9 * * 1'  # –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ 09:00 UTC

jobs:
  docs-health:
    runs-on: ubuntu-latest
    steps:
      # 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∏—Ç—ã–µ —Å—Å—ã–ª–∫–∏ –≤ GitBook
      - name: Check broken links
        run: npx linkinator https://docs.max-loyalty.com --recurse --skip "localhost"
        # –ê–ª–µ—Ä—Ç–∏—Ç –µ—Å–ª–∏ –ª—é–±–∞—è —Å—Å—ã–ª–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 404

      # 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
      - name: Test code examples
        run: node scripts/test-doc-examples.js
        env:
          MAX_LOYALTY_API_KEY: ${{ secrets.STAGING_TEST_API_KEY }}
        # –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ curl/JS/Python –ø—Ä–∏–º–µ—Ä—ã –∏–∑ GitBook –ø—Ä–æ—Ç–∏–≤ staging

      # 3. OpenAPI drift ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚â† –∫–æ–¥
      - name: Check OpenAPI spec drift
        run: npm run check-openapi-drift
        # –ü–∞–¥–∞–µ—Ç –µ—Å–ª–∏ swagger –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç openapi-committed.json

      # 4. –í—Å–µ error codes –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
      - name: Check error code coverage
        run: node scripts/check-error-docs.js
        # –ü–∞—Ä—Å–∏—Ç –≤—Å–µ AppException –≤ –∫–æ–¥–µ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –≤ Error Catalog

      # 5. –û–ø–æ–≤–µ—â–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
      - name: Notify on failure
        if: failure()
        run: |
          curl -X POST ${{ secrets.TELEGRAM_BOT_URL }} \
            -d "text=‚ö†Ô∏è Documentation Health Check FAILED. Check GitHub Actions."
```

**–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏–º–µ—Ä–æ–≤ –∫–æ–¥–∞:**

```typescript
// scripts/test-doc-examples.ts
const examples = [
  { name: 'Create Guest', method: 'POST', url: '/api/v1/guests',
    body: { phone: '79991234567', firstName: 'Test' },
    expectedStatus: 201 },
  { name: 'Health Check', method: 'GET', url: '/health',
    expectedStatus: 200 },
  // ... –≤—Å–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ Quick Start Guide
];

for (const example of examples) {
  const res = await fetch(`${STAGING_URL}${example.url}`, {...});
  if (res.status !== example.expectedStatus) {
    console.error(`‚ùå ${example.name}: expected ${example.expectedStatus}, got ${res.status}`);
    process.exit(1);
  }
  console.log(`‚úÖ ${example.name}`);
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- Broken links = –ø–µ—Ä–≤–æ–µ, —á—Ç–æ –≤–∏–¥–∏—Ç –Ω–æ–≤—ã–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ ‚Üí —Å—Ä–∞–∑—É —Ç–µ—Ä—è–µ—Ç –¥–æ–≤–µ—Ä–∏–µ
- –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–º–µ—Ä–æ–≤ –∫–æ–¥–∞ = –≥–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ Quick Start Guide –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- Telegram-–æ–ø–æ–≤–µ—â–µ–Ω–∏–µ = –∫–æ–º–∞–Ω–¥–∞ —É–∑–Ω–∞—ë—Ç –æ –ø—Ä–æ–±–ª–µ–º–µ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —É—Ç—Ä–æ–º, –Ω–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
- Cron —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é = –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è drift, –Ω–µ –Ω–∞–≥—Ä—É–∂–∞–µ—Ç CI

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** GitHub Actions cron (–∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫) + 4 –ø—Ä–æ–≤–µ—Ä–∫–∏ (–±–∏—Ç—ã–µ —Å—Å—ã–ª–∫–∏, –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞, OpenAPI drift, error code coverage) + Telegram-–∞–ª–µ—Ä—Ç –∫–æ–º–∞–Ω–¥–µ –ø—Ä–∏ failure

***

## üìä –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê ‚Äî –í–û–ü–†–û–°–´ 31‚Äì45

| \# | –¢–µ–º–∞ | –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ |
| :-- | :-- | :-- |
| 31 | Error Catalog | RFC 7807 + 22 error codes + `AppException` + `help` URL |
| 32 | Webhook Events | 20 —Å–æ–±—ã—Ç–∏–π –ø–æ 5 –¥–æ–º–µ–Ω–∞–º + –µ–¥–∏–Ω–∞—è envelope + PATCH subscriptions |
| 33 | API Explorer | Scalar (—Ç—ë–º–Ω–∞—è —Ç–µ–º–∞) –≤–º–µ—Å—Ç–æ Swagger UI + Try It Out –Ω–∞ staging |
| 34 | Query Convention | –ï–¥–∏–Ω—ã–π DTO + `{data, pagination, meta}` envelope + limit max 100 |
| 35 | Multi-tenancy Docs | –°—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´Tenant Isolation¬ª + ‚úÖ/‚ùå –ø—Ä–∏–º–µ—Ä—ã |
| 36 | OpenAPI Drift | Code-First + CI Snapshot Test + –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å GitBook |
| 37 | Idempotency Docs | –°—Ç—Ä–∞–Ω–∏—Ü–∞ + `alreadyProcessed` —Ñ–ª–∞–≥ + Idempotency-Key header |
| 38 | Time-to-First-Call | Auto-seed staging + Postman Quick Start + 5-–º–∏–Ω—É—Ç–Ω—ã–π –ø—É—Ç—å |
| 39 | Webhook Debugging | Event Log 30 –¥–Ω–µ–π + Replay + Test Trigger + ngrok guide |
| 40 | Rate Limits Docs | `X-RateLimit-*` headers + `Retry-After` + —Ç–∞–±–ª–∏—Ü–∞ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º |
| 41 | Pagination Limits | Offset MVP + –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ > 10k + Bulk Export + Cursor v2 |
| 42 | Field Selection | –†–∞–∑–¥–µ–ª ¬´Optimizing Response Size¬ª + —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª–µ–π + nested `.` |
| 43 | API Keys Lifecycle | 8 scopes + rotation guide (5 —à–∞–≥–æ–≤) + 24—á grace + Emergency Revoke |
| 44 | –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è | EN tech, RU –¥–ª—è POS guides; `/ru/` GitBook route |
| 45 | Docs Health Check | GitHub Actions cron + 4 –ø—Ä–æ–≤–µ—Ä–∫–∏ + Telegram-–∞–ª–µ—Ä—Ç –∫–æ–º–∞–Ω–¥–µ |


---

# –í –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ –ø—Ä–æ–µ–∫—Ç—É –µ—â–µ –∏–¥—É—Ç –ø–ª–∞–≥–∏–Ω—ã –¥–ª—è –ø–æ—Å —Å–∏—Å—Ç–µ–º –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤

–¢–µ–ø–µ—Ä—å —É –º–µ–Ω—è –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –æ–±–æ–∏—Ö –ø–ª–∞–≥–∏–Ω–æ–≤. –í–æ—Ç –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑:

***

# üîå –ü–õ–ê–ì–ò–ù–´ –î–õ–Ø POS-–°–ò–°–¢–ï–ú ‚Äî –ü–û–õ–ù–´–ô –†–ê–ó–ë–û–†

## –ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç Backend-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

–ï—Å–ª–∏ –≤ –ë–µ—Å–µ–¥–µ-10 –º—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–ª–∏ **—Å–µ—Ä–≤–µ—Ä–Ω—É—é POS-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é** (webhooks, reconciliation, API), —Ç–æ –ø–ª–∞–≥–∏–Ω—ã ‚Äî —ç—Ç–æ **–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–ª–æ–π –Ω–∞ –∫–∞—Å—Å–æ–≤–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ**. –û–Ω–∏ –∂–∏–≤—É—Ç –≤–Ω—É—Ç—Ä–∏ –∫–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ –æ–±—â–∞—é—Ç—Å—è —Å –Ω–∞—à–∏–º –±—ç–∫–µ–Ω–¥–æ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –≤ –º–æ–º–µ–Ω—Ç –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –≥–æ—Å—Ç—è.[^5_1][^5_2]

***

## ‚ö° –ü–õ–ê–ì–ò–ù –î–õ–Ø IIKO FRONT

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ ‚Äî –æ–¥–Ω–∞ DLL –≤–Ω—É—Ç—Ä–∏ iiko

```
iiko Front (–æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞)
‚îî‚îÄ‚îÄ MaxLoyaltyIikoPlugin.dll  ‚Üê –Ω–∞—à –ø–ª–∞–≥–∏–Ω —á–µ—Ä–µ–∑ IFrontPlugin SDK
    ‚îú‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ ¬´Max Loyalty¬ª –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∫–∞—Å—Å–∏—Ä–∞
    ‚îú‚îÄ‚îÄ –î–≤–∞ —Ç–∏–ø–∞ –ø–ª–∞—Ç–µ–∂–µ–π: POINTS (editable) + DISCOUNT (non-editable)
    ‚îú‚îÄ‚îÄ LoyaltySearchWindow.xaml  ‚Üê –ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è
    ‚îú‚îÄ‚îÄ LoyaltyOperationWindow.xaml  ‚Üê –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ / —Å–ø–∏—Å–∞–Ω–∏–µ
    ‚îî‚îÄ‚îÄ LoyaltyApiClient.cs  ‚Üê HTTP –∫ –Ω–∞—à–µ–º—É NestJS backend
```

–°—Ç–µ–∫: **C\# .NET Framework 4.7.2**, WPF, iiko Front Plugin SDK, Serilog, Polly (retry).[^5_1]

### –ü–æ–ª–Ω—ã–π workflow –∫–∞—Å—Å–∏—Ä–∞ (—à–∞–≥–∏)

```
1. –ö–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç ¬´Max Loyalty¬ª
   ‚Üí LoyaltySearchWindow: –Ω—É–º–ø–∞–¥, –≤–≤–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ 6-digit –∫–æ–¥–∞

2. POST /api/pos-integration/iiko/search-guest
   ‚Üí –Ω–∞—à–ª–∏ –≥–æ—Å—Ç—è –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å

3. POST /api/pos-integration/iiko/calculate
   ‚Üí backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: benefitType (POINTS/DISCOUNT),
     regularBalance, promoBalance, maxAllowedToSpend, pointsToEarn

4. LoyaltyOperationWindow –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 2 –∫–Ω–æ–ø–∫–∏:
   [–ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã]  [–°–ø–∏—Å–∞—Ç—å 178 –±–∞–ª–ª–æ–≤]  [–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É 20%]

5a. –ï—Å–ª–∏ –°–ü–ò–°–ê–ù–ò–ï:
    POST /api/pos-integration/iiko/reserve-points
    ‚Üí backend —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç –±–∞–ª–ª—ã (reservationId)
    ‚Üí iiko —Å–æ–∑–¥–∞—ë—Ç –ø–ª–∞—Ç—ë–∂ —Ç–∏–ø–∞ MAXLOYALTY_POINTS (editable, —Å—É–º–º–∞ = –±–∞–ª–ª–∞–º)
    ‚Üí –∫–∞—Å—Å–∏—Ä –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É (OnPaymentEdited ‚Üí PUT /update-reservation)

5b. –ï—Å–ª–∏ –°–ö–ò–î–ö–ê:
    POST /api/pos-integration/iiko/reserve-discount
    ‚Üí iiko —Å–æ–∑–¥–∞—ë—Ç –ø–ª–∞—Ç—ë–∂ MAXLOYALTY_DISCOUNT (non-editable, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)

6. –ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–∞ ‚Üí —Å–æ–±—ã—Ç–∏–µ OnOrderClosed
    ‚Üí POST /api/pos-integration/iiko/finalize-points
       –∏–ª–∏ /finalize-discount
    ‚Üí backend –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–ª—ã

7. –ï—Å–ª–∏ backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí OfflineQueue (max 100 –æ–ø–µ—Ä–∞—Ü–∏–π, TTL 24—á)
   ‚Üí ProcessOfflineQueueAsync –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
```


### Payment Types ‚Äî –∫–ª—é—á–µ–≤–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞ iiko

```csharp
// POINTS ‚Äî editable: –∫–∞—Å—Å–∏—Ä –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É —Å–ø–∏—Å–∞–Ω–∏—è –≤—Ä—É—á–Ω—É—é
pointsPaymentType = operations.RegisterPaymentType(
    name: "MAXLOYALTY_POINTS",
    isEditable: true   // –∫–∞—Å—Å–∏—Ä –º–æ–∂–µ—Ç —É–º–µ–Ω—å—à–∏—Ç—å —Å—É–º–º—É
);

// DISCOUNT ‚Äî non-editable: —Å–∫–∏–¥–∫–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞, –∏–∑–º–µ–Ω–∏—Ç—å –Ω–µ–ª—å–∑—è
discountPaymentType = operations.RegisterPaymentType(
    name: "MAXLOYALTY_DISCOUNT",
    isEditable: false  // —Å–∫–∏–¥–∫–∞ –∑–∞—â–∏—â–µ–Ω–∞ –æ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
);
```

–ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ POINTS-–ø–ª–∞—Ç–µ–∂–∞ ‚Äî `OnPaymentEdited` ‚Üí `PUT /update-reservation` –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.[^5_1]

### Comment-—Ñ–æ—Ä–º–∞—Ç –ø–ª–∞—Ç–µ–∂–∞ (–ø–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)

```
MaxLoyalty|Type=POINTS|Guest={cardId}|Res={reservationId}
MaxLoyalty|Type=DISCOUNT|Percent={%}|Guest={cardId}|Res={reservationId}
```

–ò–º–µ–Ω–Ω–æ –∏–∑ —ç—Ç–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è `OnOrderClosed` –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è finalize-–∑–∞–ø—Ä–æ—Å–∞.[^5_1]

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å API Key

```csharp
// API Key —à–∏—Ñ—Ä—É–µ—Ç—Å—è AES-256 –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º –∫ –∂–µ–ª–µ–∑—É –∫–ª—é—á–æ–º
var machineKey = SHA256(machineId + "MaxLoyaltySalt");
var encryptedKey = AES_CBC_Encrypt(apiKey, machineKey);
// ‚Üí —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ appsettings.json –∫–∞–∫ Base64-—Å—Ç—Ä–æ–∫–∞
// ‚Üí –¥–∞–∂–µ –µ—Å–ª–∏ —Ñ–∞–π–ª —Å–∫–æ–ø–∏—Ä—É—é—Ç –Ω–∞ –¥—Ä—É–≥–æ–π –ü–ö ‚Äî —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –Ω–µ–ª—å–∑—è
```


### Offline —Ä–µ–∂–∏–º

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ü–æ–≤–µ–¥–µ–Ω–∏–µ |
| :-- | :-- |
| EarnOnly (—Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ) | –ù–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å (–±–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å) |
| Finalize –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ backend | –ü–∏—à–µ—Ç—Å—è –≤ `OfflineQueue` (JSON-—Ñ–∞–π–ª) |
| –î—É–±–ª–∏–∫–∞—Ç—ã –≤ –æ—á–µ—Ä–µ–¥–∏ | –ó–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ `idempotencyKey` |
| TTL –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ | 24 —á–∞—Å–∞ (–ø–æ—Å–ª–µ ‚Äî –ø–æ–º–µ—á–∞–µ—Ç—Å—è expired) |
| –ú–∞–∫—Å–∏–º—É–º –≤ –æ—á–µ—Ä–µ–¥–∏ | 100 –æ–ø–µ—Ä–∞—Ü–∏–π |

[^5_1]

***

## ‚öôÔ∏è –ü–õ–ê–ì–ò–ù –î–õ–Ø R-KEEPER ‚Äî –ü–†–ò–ù–¶–ò–ü–ò–ê–õ–¨–ù–û –ò–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### –ü–æ—á–µ–º—É –¥–≤–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ?

R-Keeper –Ω–µ –∏–º–µ–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ .NET SDK –∫–∞–∫ iiko. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **FarCard** ‚Äî —Å–∏—Å—Ç–µ–º—É –≤–Ω–µ—à–Ω–∏—Ö DLL –Ω–∞ C++. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–µ–ª—å–∑—è —Å–¥–µ–ª–∞—Ç—å –æ–¥–Ω—É C\# DLL.[^5_2]

```
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç 1: MaxLoyaltyRKeeper.dll  ‚Üê C++ Native DLL
              FarCard –≤—ã–∑—ã–≤–∞–µ—Ç –µ—ë –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ stdcall
              –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç: Initialize(), GetCardInfo(), ReservePoints(),
                            FinalizeTransaction(), Shutdown()

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç 2: MaxLoyaltyRKeeperUI.exe  ‚Üê C# .NET 4.7.2 WPF
              –û—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å, Floating Button –ø–æ–≤–µ—Ä—Ö R-Keeper
              –û–±—â–∞–µ—Ç—Å—è —Å DLL —á–µ—Ä–µ–∑ Shared Memory

Shared Memory: MemoryMappedFile "MaxLoyaltyRKeeperShared" (1 MB)
              –•—Ä–∞–Ω–∏—Ç: backendStatus, activeOrders (–∫–æ–Ω—Ç–µ–∫—Å—Ç—ã),
                      offlineQueue, metrics
```


### –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

```
R-KEEPER CASH STATION
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  R-Keeper 7.x                                        ‚îÇ
‚îÇ  ‚îî‚îÄ FarCard  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí MaxLoyaltyRKeeper.dll (C++)     ‚îÇ
‚îÇ                       ‚îÇ  Initialize()                ‚îÇ
‚îÇ                       ‚îÇ  GetCardInfo(phone/code)     ‚îÇ
‚îÇ                       ‚îÇ  ReservePoints(amount)       ‚îÇ
‚îÇ                       ‚îÇ  FinalizeTransaction(order)  ‚îÇ
‚îÇ                       ‚îÇ                              ‚îÇ
‚îÇ                       ‚îÇ  HTTP ‚Üí Backend API          ‚îÇ
‚îÇ                       ‚îÇ  Shared Memory (1MB) ‚Üê‚îÄ‚îÄ‚Üí    ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  MaxLoyaltyRKeeperUI.exe (C# WPF) ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å‚îÇ
‚îÇ  ‚îú‚îÄ FloatingButtonWindow (–ø–æ–≤–µ—Ä—Ö R-Keeper)           ‚îÇ
‚îÇ  ‚îú‚îÄ GuestSearchWindow                                ‚îÇ
‚îÇ  ‚îú‚îÄ PointsOperationWindow                            ‚îÇ
‚îÇ  ‚îú‚îÄ DiscountOperationWindow                          ‚îÇ
‚îÇ  ‚îî‚îÄ –ß–∏—Ç–∞–µ—Ç/–ø–∏—à–µ—Ç Shared Memory ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üï HTTPS
   Backend API (NestJS)
```


### Shared Memory ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ 1MB JSON

```json
{
  "version": "1.0.0",
  "backendStatus": {
    "isOnline": true,
    "lastCheckAt": "2026-02-18T00:30:45Z",
    "latencyMs": 45
  },
  "activeOrders": {
    "order12345": {
      "orderId": "order12345",
      "guestCardId": "card-uuid-abc",
      "benefitType": "POINTS",
      "pointsToSpend": 178.00,
      "maxAllowed": 178.00,
      "reservationId": "res-xyz789",
      "originalCheckAmount": 890.00,
      "stationId": "STATION001"
    }
  },
  "offlineQueue": [
    { "type": "FINALIZE_POINTS", "orderId": "...", "queuedAt": "..." }
  ],
  "metrics": {
    "totalTransactionsToday": 145,
    "totalPointsSpentToday": 12450.00,
    "averageResponseTimeMs": 120
  }
}
```


### R-Keeper XML API ‚Äî –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∫–∏–¥–∫–∞

R-Keeper –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç ¬´–ø–ª–∞—Ç—ë–∂ –±–∞–ª–ª–∞–º–∏¬ª –∫–∞–∫ iiko. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–Ω –ø—Ä–∏–Ω–∏–º–∞–µ—Ç **XML-–∫–æ–º–∞–Ω–¥—É –Ω–∞ —Å–∫–∏–¥–∫—É**:[^5_2]

```xml
<!-- –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—É—é —Å–∫–∏–¥–∫—É —á–µ—Ä–µ–∑ XML API -->
<RK7Query>
  <RK7CMD CMD="SaveOrder">
    <Order ident="order12345">
      <Discount>
        <Type>MANUAL</Type>
        <DiscountType>PERCENT</DiscountType>
        <Value>20.00</Value>
        <Reason>Max Loyalty - –°–µ—Ä–µ–±—Ä—è–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å</Reason>
      </Discount>
    </Order>
  </RK7CMD>
</RK7Query>
```

```xml
<!-- –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–∫–∞–∑–æ–≤ -->
<RK7Query>
  <RK7CMD CMD="GetOrderList">
    <Filter><Status>OPEN</Status></Filter>
  </RK7CMD>
</RK7Query>
```


### C++ DLL ‚Äî —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

```cpp
// FarCard –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é
extern "C" {
  __declspec(dllexport) int __stdcall Initialize(const char* configPath);
  __declspec(dllexport) int __stdcall GetCardInfo(const char* phone, CardInfo* outInfo);
  __declspec(dllexport) int __stdcall ReservePoints(const char* orderId, double amount);
  __declspec(dllexport) int __stdcall ReserveDiscount(const char* orderId, double percentage);
  __declspec(dllexport) int __stdcall UpdateReservation(const char* reservId, double newAmt);
  __declspec(dllexport) int __stdcall CancelReservation(const char* reservId);
  __declspec(dllexport) int __stdcall FinalizeTransaction(const char* reservId,
                                        double finalAmount, const char* orderId,
                                        const char* paymentTypesJson);
  __declspec(dllexport) void __stdcall Shutdown();
}
```


### –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ R-Keeper ‚Äî —Å–ª–æ–∂–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞

```
MaxLoyaltyRKeeperKassa1.exe  ‚Üê –∫–∞—Å—Ç–æ–º–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –ø–æ–¥ –∫–∞–∂–¥—É—é –∫–∞—Å—Å—É

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (UAC elevation)
2. –ü–æ–∏—Å–∫ R-Keeper (4 —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏):
   ‚Üí —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—É—Ç–∏ (C:\RK7, C:\Program Files\RK7)
   ‚Üí —Ä–µ–µ—Å—Ç—Ä (HKLM\SOFTWARE\UCS\RK7)
   ‚Üí –ø–æ–∏—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ RK7.exe
   ‚Üí deep scan –≤—Å–µ—Ö –¥–∏—Å–∫–æ–≤
   ‚Üí —Ä—É—á–Ω–æ–π –≤—ã–±–æ—Ä –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ DLL ‚Üí R-Keeper\Plugins\MaxLoyaltyRKeeper.dll
   (backup —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ –ø–µ—Ä–µ–¥ –∑–∞–º–µ–Ω–æ–π)
4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ FarCard (3 –ø–æ–ø—ã—Ç–∫–∏):
   ‚Üí XML API –∫–æ–º–∞–Ω–¥–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
   ‚Üí –ø—Ä–∞–≤–∫–∞ FarCard.xml (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
   ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ FarCard.xml + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤—Ä—É—á–Ω—É—é
5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ UI ‚Üí C:\MaxLoyaltyRKeeper\MaxLoyaltyRKeeperUI.exe
6. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ UI –≤ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ Windows (—Ä–µ–µ—Å—Ç—Ä)
7. –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: Backend API + R-Keeper XML API + Shared Memory
8. –≠–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–æ–≤
9. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å R-Keeper
```


***

## üìä –°–†–ê–í–ù–ï–ù–ò–ï –ü–õ–ê–ì–ò–ù–û–í

| –ü–∞—Ä–∞–º–µ—Ç—Ä | iiko Plugin | R-Keeper Plugin |
| :-- | :-- | :-- |
| **–¢–∏–ø –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** | IFrontPlugin SDK | FarCard External DLL |
| **–Ø–∑—ã–∫** | C\# .NET 4.7.2 | C++ DLL + C\# WPF |
| **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤** | 1 (dll) | 2 (dll + exe) |
| **UI** | WPF –æ–∫–Ω–∞ –≤–Ω—É—Ç—Ä–∏ iiko | Floating Button (–æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å) |
| **–°–≤—è–∑—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤** | –ù–µ –Ω—É–∂–Ω–∞ (–æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å) | Shared Memory 1MB |
| **–ü–ª–∞—Ç–µ–∂–∏** | IPaymentType (POINTS editable) | XML API (—Å–∫–∏–¥–∫–∞ –Ω–∞ —á–µ–∫) |
| **API –≤ POS** | iiko SDK events | R-Keeper XML API |
| **–£—Å—Ç–∞–Ω–æ–≤–∫–∞** | .dll –≤ Plugins + iiko restart | –°–ª–æ–∂–Ω—ã–π installer (7 —à–∞–≥–æ–≤) |
| **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–∞—Å—Å–∏—Ä–∞** | `operations.GetCurrentUser()` | `RK7CURRENTUSER` env var |
| **Offline** | OfflineQueueService (JSON —Ñ–∞–π–ª) | Shared Memory + JSON —Ñ–∞–π–ª |

[^5_1][^5_2]

***

## üîó –ö–ê–ö –ü–õ–ê–ì–ò–ù–´ –°–í–Ø–ó–ê–ù–´ –° BACKEND

### Backend API endpoints –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤ (–æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã)

```typescript
// iiko-specific endpoints
POST /api/pos-integration/iiko/search-guest
POST /api/pos-integration/iiko/calculate
POST /api/pos-integration/iiko/reserve-points
POST /api/pos-integration/iiko/reserve-discount
PUT  /api/pos-integration/iiko/update-reservation
POST /api/pos-integration/iiko/cancel-reservation
POST /api/pos-integration/iiko/finalize-points
POST /api/pos-integration/iiko/finalize-discount
POST /api/pos-integration/iiko/create-guest
GET  /api/pos-integration/iiko/config
GET  /api/pos-integration/iiko/latest-version    ‚Üê auto-update
POST /api/pos-integration/iiko/metrics

// r-keeper-specific endpoints (–∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ –ø–æ —Å–º—ã—Å–ª—É)
POST /api/pos-integration/rkeeper/search-guest
POST /api/pos-integration/rkeeper/calculate
POST /api/pos-integration/rkeeper/reserve-points
POST /api/pos-integration/rkeeper/reserve-discount
PUT  /api/pos-integration/rkeeper/update-reservation
POST /api/pos-integration/rkeeper/cancel-reservation
POST /api/pos-integration/rkeeper/finalize-points
POST /api/pos-integration/rkeeper/finalize-discount
POST /api/pos-integration/rkeeper/first-connect    ‚Üê –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
GET  /api/pos-integration/rkeeper/config
```

**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–æ–≤** ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ:[^5_2][^5_1]

```http
X-API-Key: rklive_xxxxx (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω AES-256, machine-bound)
X-Plugin-Version: 1.0.0
X-Restaurant-Id: rest-uuid
X-Installation-Id: inst-uuid
X-Tenant-Id: tenant-uuid
X-Terminal-Id: term-001
```


### –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è ‚Äî –∑–∞—á–µ–º –Ω—É–∂–Ω–∞?

```
–ü—Ä–æ–±–ª–µ–º–∞: –∫–∞—Å—Å–∏—Ä –æ—Ç–∫—Ä—ã–ª –æ–∫–Ω–æ, –Ω–æ –∑–∞–∫–∞–∑ –µ—â—ë –Ω–µ –∑–∞–∫—Ä—ã—Ç.
          –ß—Ç–æ –µ—Å–ª–∏ –≥–æ—Å—Ç—å –ø–µ—Ä–µ–¥—É–º–∞–ª —Å–ø–∏—Å—ã–≤–∞—Ç—å –±–∞–ª–ª—ã?

–†–µ—à–µ–Ω–∏–µ: –¥–≤—É—Ö—Ñ–∞–∑–Ω—ã–π commit
  1. reserve-points  ‚Üí backend –±–ª–æ–∫–∏—Ä—É–µ—Ç –±–∞–ª–ª—ã (—Å—Ç–∞—Ç—É—Å RESERVED, TTL 30 –º–∏–Ω)
  2. finalize-points ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∑–∞–∫–∞–∑–∞
     cancel-reservation ‚Üí –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ (–∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É¬ª)

–ë–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å–æ —Å—á—ë—Ç–∞ –¢–û–õ–¨–ö–û –ø—Ä–∏ finalize!
```


***

## üÜï –ß–¢–û –ù–£–ñ–ù–û –î–û–ë–ê–í–ò–¢–¨ –í –û–ë–©–£–Æ –ê–†–•–ò–¢–ï–ö–¢–£–†–£

–ü–ª–∞–≥–∏–Ω—ã –≤–≤–æ–¥—è—Ç **–Ω–æ–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏**, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –±—ã–ª–æ –≤ –ë–µ—Å–µ–¥–µ-9 (DB Schema):

```prisma
model IikoPluginInstallation {
  id           String   @id @default(uuid())
  tenantId     String
  restaurantId String
  apiKey       String   @unique
  pluginVersion String?
  status       PluginStatus  // PENDING_INSTALLATION | ACTIVE | REVOKED
  machineId    String?
  lastSeenAt   DateTime?
  firstConnectedAt DateTime?
  createdAt    DateTime @default(now())
}

model RKeeperPluginInstallation {
  id           String   @id @default(uuid())
  tenantId     String
  restaurantId String
  terminalName String
  stationId    String?
  xmlApiUrl    String
  apiKey       String   @unique
  status       PluginStatus
  machineId    String?
  pluginVersion String?
  installerDownloadUrl String?
  lastSeenAt   DateTime?
  firstConnectedAt DateTime?
}

model PointsReservation {
  id           String   @id @default(uuid())
  guestCardId  String
  orderId      String
  posSystem    POSSystem
  amount       Decimal
  status       ReservationStatus  // ACTIVE | FINALIZED | CANCELLED | EXPIRED
  expiresAt    DateTime  // TTL 30 –º–∏–Ω—É—Ç
  createdAt    DateTime @default(now())
  finalizedAt  DateTime?
  cancelledAt  DateTime?
  reason       String?   // –ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã
}

enum PluginStatus {
  PENDING_INSTALLATION
  ACTIVE
  REVOKED
  SUSPENDED
}

enum ReservationStatus {
  ACTIVE
  FINALIZED
  CANCELLED
  EXPIRED
}
```


***

## üì¶ –û–ë–ù–û–í–õ–Å–ù–ù–´–ô –ò–¢–û–ì –ë–õ–û–ö–û–í

| –ë–ª–æ–∫ | –°—Ç–∞—Ç—É—Å | –í–æ–ø—Ä–æ—Å–æ–≤ |
| :-- | :-- | :-- |
| –í—Å–µ 13 –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –±–ª–æ–∫–æ–≤ | ‚úÖ | ~523 |
| API Documentation (31‚Äì45) | ‚úÖ | 15 |
| **–ü–ª–∞–≥–∏–Ω iiko Front** | **‚úÖ –ò–∑—É—á–µ–Ω** | ‚Äî |
| **–ü–ª–∞–≥–∏–Ω R-Keeper** | **‚úÖ –ò–∑—É—á–µ–Ω** | ‚Äî |
| **–ù–æ–≤—ã–µ DB-–º–æ–¥–µ–ª–∏ (Installation, Reservation)** | **‚ö†Ô∏è –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å** | ‚Äî |

–ü–ª–∞–≥–∏–Ω—ã –¥–æ–±–∞–≤–ª—è—é—Ç **–Ω–æ–≤—ã–π —Å–ª–æ–π** –º–µ–∂–¥—É POS –∏ –±—ç–∫–µ–Ω–¥–æ–º. –•–æ—á–µ—à—å —É–≥–ª—É–±–∏—Ç—å—Å—è –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —á–∞—Å—Ç—å ‚Äî —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏, —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∏, Shared Memory, –∏–ª–∏ API endpoints –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤? üöÄ

<div align="center">‚ÅÇ</div>

[^5_1]: Plagin-iiko.md

[^5_2]: Plagin-r-kepper.md


---

# –î–∞–≤–∞–π –≤–æ –≤—Å–µ —ç—Ç–æ —É–≥–ª—É–±–∏–º—Å—è –∏ –ø—Ä–æ–ø–∏—à–µ–º. –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã + —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ —Ç–≤–æ–µ–º—É –ª—É—á—à–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º

–£ –º–µ–Ω—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –æ–±–æ–∏—Ö –ø–ª–∞–≥–∏–Ω–æ–≤. –í–æ—Ç **25 –≤–æ–ø—Ä–æ—Å–æ–≤** –ø–æ –≤—Å–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º —Ç–æ—á–∫–∞–º ‚Äî –æ—Ç —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π –¥–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ edge-cases.

***

---

# üìã POS –ü–õ–ê–ì–ò–ù–´ ‚Äî –ü–†–ò–ù–Ø–¢–´–ï –†–ï–®–ï–ù–ò–Ø Q1‚ÄìQ25

## –§–æ—Ä–º–∞—Ç: –í–æ–ø—Ä–æ—Å ‚Üí –û—Ç–≤–µ—Ç ‚Üí –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ ‚Üí –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ


***

## –ë–õ–û–ö A ‚Äî –†–ï–ó–ï–†–í–ê–¶–ò–ò –ò –§–ò–ù–ê–ù–°–û–í–ê–Ø –õ–û–ì–ò–ö–ê


***

### Q1 ‚Äî TTL –†–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –∏ Grace Window

**–í–æ–ø—Ä–æ—Å:** –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å `expiresAt` (TTL 30 –º–∏–Ω—É—Ç). –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ `finalize` –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è TTL? Backend –æ—Ç–∫–ª–æ–Ω—è–µ—Ç ‚Äî –∏ –∫–∞—Å—Å–∏—Ä —Ç–µ—Ä—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ –±–∞–Ω–∫–µ—Ç–µ –¥–ª–∏–Ω–æ–π 4 —á–∞—Å–∞?

**–û—Ç–≤–µ—Ç:** Backend –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `finalize` –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–º grace window (+60 –º–∏–Ω –ø–æ—Å–ª–µ `expiresAt`). –ò—Ç–æ–≥–æ: 30 –º–∏–Ω –∞–∫—Ç–∏–≤–Ω–∞—è —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è + 60 –º–∏–Ω grace = 90 –º–∏–Ω total. –ü–æ—Å–ª–µ 90 –º–∏–Ω ‚Äî —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –º–µ—Ä—Ç–≤–∞, –Ω—É–∂–Ω–∞ –Ω–æ–≤–∞—è.

```typescript
// backend: finalize-points handler
async finalizePoints(req: FinalizePointsRequest) {
  const reservation = await this.prisma.pointsReservation.findUnique({
    where: { id: req.reservationId }
  });

  if (reservation.status === 'EXPIRED') {
    const gracePeriodEnd = addMinutes(reservation.expiresAt, 60); // grace +60 –º–∏–Ω
    if (new Date() > gracePeriodEnd) {
      throw new AppException(
        'RESERVATION_EXPIRED', 422,
        'Reservation expired. Ask guest to re-apply loyalty card.'
      );
    }
    // –í–Ω—É—Ç—Ä–∏ grace window ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ–º, –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    logger.warn('Finalize within grace window after expiry', {
      reservationId: req.reservationId,
      expiredAt: reservation.expiresAt,
      gracePeriodEnd
    });
  }
  // ... –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—é
}
```

**–°—Ç–∞—Ç—É—Å–Ω–∞—è –º–∞—à–∏–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏:**

```
ACTIVE (0‚Äì30 –º–∏–Ω)
    ‚Üì –ø—Ä–∏ expiresAt
EXPIRED (30‚Äì90 –º–∏–Ω) ‚Üê finalize –µ—â—ë –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –≤ grace window
    ‚Üì –ø—Ä–∏ expiresAt + 60 –º–∏–Ω
DEAD (90+ –º–∏–Ω) ‚Üê finalize –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è —Å RESERVATION_EXPIRED
    ‚Üë CRON –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω –ø–µ—Ä–µ–≤–æ–¥–∏—Ç ACTIVE‚ÜíEXPIRED‚ÜíAUTO_CANCELLED
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ë–∞–Ω–∫–µ—Ç, –¥–ª–∏–Ω–Ω—ã–π –∑–∞–∫–∞–∑, –∑–∞–≤–∏—Å—à–∏–π —Ç–µ—Ä–º–∏–Ω–∞–ª ‚Äî –≤—Å—ë —ç—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ. –ñ—ë—Å—Ç–∫–∏–π 30-–º–∏–Ω—É—Ç–Ω—ã–π TTL = –ø–æ—Ç–µ—Ä—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. Stripe –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ö–æ–∂—É—é –º–æ–¥–µ–ª—å: authorization capture –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 7 –¥–Ω–µ–π. 90 –º–∏–Ω –ø–æ–∫—Ä—ã–≤–∞—é—Ç 99% —Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** TTL —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ = 30 –º–∏–Ω (`expiresAt`). Grace window –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è = +60 –º–∏–Ω. –ò—Ç–æ–≥–æ –º–∞–∫—Å–∏–º—É–º –¥–ª—è finalize = 90 –º–∏–Ω –æ—Ç –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏. –ü–æ—Å–ª–µ 90 –º–∏–Ω ‚Äî `RESERVATION_EXPIRED` 422. CRON –æ—á–∏—â–∞–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω.

***

### Q2 ‚Äî Crash POS –ø–æ—Å–ª–µ reserve, –¥–æ finalize

**–í–æ–ø—Ä–æ—Å:** –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ (`ACTIVE`), iiko/R-Keeper —É–ø–∞–ª. `OnOrderClosed` –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª. –ë–∞–ª–ª—ã –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞ ‚Äî –≥–æ—Å—Ç—å –Ω–µ –º–æ–∂–µ—Ç —Å–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑.

**–û—Ç–≤–µ—Ç:** Backend CRON –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –Ω–∞—Ö–æ–¥–∏—Ç –∑–∞–≤–∏—Å—à–∏–µ `ACTIVE` —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ —Å –∏—Å—Ç—ë–∫—à–∏–º `expiresAt` –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –∏—Ö –≤ `AUTO_CANCELLED`, —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É—è –±–∞–ª–ª—ã.

```typescript
// backend: cron job ‚Äî –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
@Cron('*/5 * * * *')
async cleanupExpiredReservations() {
  const now = new Date();

  // –ù–∞—Ö–æ–¥–∏–º ACTIVE —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ —Å –∏—Å—Ç—ë–∫—à–∏–º TTL (–ø—Ä–æ—Å—Ä–æ—á–µ–Ω—ã –Ω–∞ 5+ –º–∏–Ω)
  const stuckReservations = await this.prisma.pointsReservation.findMany({
    where: {
      status: 'ACTIVE',
      expiresAt: { lt: subMinutes(now, 5) }
    },
    include: { guestCard: true }
  });

  for (const res of stuckReservations) {
    await this.prisma.$transaction(async (tx) => {
      // 1. –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é
      await tx.pointsReservation.update({
        where: { id: res.id },
        data: {
          status: 'AUTO_CANCELLED',
          cancelledAt: now,
          cancelReason: 'AUTO_CLEANUP_NO_FINALIZE'
        }
      });

      // 2. –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∞–ª–ª—ã –≥–æ—Å—Ç—è
      await tx.loyaltyCard.update({
        where: { id: res.guestCardId },
        data: {
          reservedBalance: { decrement: res.amount }
        }
      });
    });

    logger.warn('Auto-cancelled stuck reservation', {
      reservationId: res.id,
      guestCardId: res.guestCardId,
      amount: res.amount,
      createdAt: res.createdAt,
      ageMinutes: differenceInMinutes(now, res.createdAt)
    });

    // 3. –ú–µ—Ç—Ä–∏–∫–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    await this.metricsService.increment('reservation.auto_cancelled');
  }
}
```

**–õ–æ–≥–∏–∫–∞ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞:**

```typescript
// –ü—Ä–∏ reserve-points: –±–∞–ª–∞–Ω—Å—ã –≥–æ—Å—Ç—è
regularBalance: 2450  ‚Üí  2272  (—É–º–µ–Ω—å—à–∏–ª–∏ –Ω–∞ 178)
reservedBalance: 0    ‚Üí  178   (–¥–æ–±–∞–≤–∏–ª–∏ –≤ reserved)

// –ü—Ä–∏ finalize-points: –±–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã
regularBalance: 2272 (–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è ‚Äî —É–∂–µ —É–º–µ–Ω—å—à–µ–Ω)
reservedBalance: 178 ‚Üí 0  (–æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º reserved)

// –ü—Ä–∏ AUTO_CANCEL:
regularBalance: 2272 ‚Üí 2450  (–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º)
reservedBalance: 178 ‚Üí 0     (–æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º reserved)
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ë–µ–∑ CRON cleanup ‚Äî crash –∫–∞—Å—Å—ã = –≤–µ—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±–∞–ª–ª–æ–≤ –≥–æ—Å—Ç—è. –ì–æ—Å—Ç—å –ø—Ä–∏–¥—ë—Ç –∑–∞–≤—Ç—Ä–∞, –ø–æ–ø—Ä–æ–±—É–µ—Ç —Å–ø–∏—Å–∞—Ç—å, –ø–æ–ª—É—á–∏—Ç ¬´–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤¬ª. CRON –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω = –º–∞–∫—Å–∏–º—É–º 5 –º–∏–Ω –∑–∞–º–æ—Ä–æ–∑–∫–∏ –ø–æ—Å–ª–µ –∫—Ä–∞—à–∞.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `@Cron('*/5 * * * *')` –Ω–∞ backend. –ù–∞—Ö–æ–¥–∏—Ç ACTIVE —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ —Å `expiresAt < now - 5–º–∏–Ω`. –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ `AUTO_CANCELLED`. –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç `reservedBalance` –≥–æ—Å—Ç—è —á–µ—Ä–µ–∑ Prisma transaction. –ú–µ—Ç—Ä–∏–∫–∞ `reservation.auto_cancelled` –≤ `plugin_metrics`.

***

### Q3 ‚Äî EarnOnly –≤ Offline Queue

**–í–æ–ø—Ä–æ—Å:** –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: `EarnOnly` (—Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ, –±–µ–∑ —Å–ø–∏—Å–∞–Ω–∏—è) –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ `OfflineQueue` –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ backend. –ì–æ—Å—Ç—å —É—Ö–æ–¥–∏—Ç ‚Äî –±–∞–ª–ª—ã –∑–∞ –æ–±–µ–¥ –Ω–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã, —Ö–æ—Ç—è –æ–Ω –∂–¥—ë—Ç –∏—Ö.

**–û—Ç–≤–µ—Ç:** `EarnOnly` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º —Ç–∏–ø–æ–º `EARN_ONLY` –∏ —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–º TTL 8 —á–∞—Å–æ–≤. –ü—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏ ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ö–∞—Å—Å–∏—Ä—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–Ω–µ –æ—à–∏–±–∫–∞).

```csharp
// iiko plugin: OnOrderClosed
private async Task FinalizeEarnOnlyOrder(IOrder order, LoyaltyContext context) {
    try {
        await apiClient.FinalizePointsAsync(new FinalizePointsRequest {
            GuestCardId = context.GuestCardId,
            OrderId = order.Id.ToString(),
            Action = LoyaltyAction.EarnOnly,
            PointsToEarn = context.PointsToEarn,
            CheckAmount = context.OriginalCheckAmount,
            // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
        });
        ShowSuccess($"–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ {context.PointsToEarn:N0} –±–∞–ª–ª–æ–≤");

    } catch (Exception ex) {
        // –ù–ï —Ç–µ—Ä—è–µ–º ‚Äî –ø–∏—à–µ–º –≤ –æ—á–µ—Ä–µ–¥—å —Å TTL 8—á
        offlineQueue.Enqueue(new OfflineOperation {
            Type = "EARN_ONLY",          // –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–∏–ø
            TtlHours = 8,                // TTL 8—á (–Ω–µ 24—á –∫–∞–∫ —É SPEND)
            IdempotencyKey = $"earn_{context.GuestCardId}_{order.Id}",
            Context = context,
            OrderId = order.Id.ToString()
        });

        metricsService.RecordMetric("loyalty.earn_only.queued", 1);
        logger.LogWarning("EarnOnly queued offline OrderId:{OrderId}", order.Id);

        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ ‚Äî –Ω–µ –æ—à–∏–±–∫–∞ (–∫–∞—Å—Å—É –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º)
        ShowWarning($"–°–≤—è–∑—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. {context.PointsToEarn:N0} –±–∞–ª–ª–æ–≤ –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏.");
    }
}
```

**TTL –ª–æ–≥–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏:**


| –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ | TTL | –ü–æ—á–µ–º—É |
| :-- | :-- | :-- |
| `FINALIZE_POINTS` (Spend) | 24—á | –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–æ—Å—Ç–∞–≤–∏—Ç—å |
| `FINALIZE_DISCOUNT` | 24—á | –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–æ—Å—Ç–∞–≤–∏—Ç—å |
| `EARN_ONLY` | 8—á | –ù–µ–∫—Ä–∏—Ç–∏—á–Ω–æ, –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —Å–º–µ–Ω—É (~12—á) |

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –¢–µ–∫—É—â–µ–µ ¬´–º–æ–ª—á–∞ –ø–æ—Ç–µ—Ä—è—Ç—å EarnOnly¬ª = –≥–æ—Å—Ç—å –∂–¥—ë—Ç –±–∞–ª–ª–æ–≤ –∑–∞ –∫–∞–∂–¥—ã–π –æ–±–µ–¥, –∞ –æ–Ω–∏ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç. 8-—á–∞—Å–æ–≤–æ–π TTL –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω–µ—Ü —Ä–∞–±–æ—á–µ–π —Å–º–µ–Ω—ã. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç Spend, EarnOnly –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–Ω—Å—ã ‚Äî —Ä–∏—Å–∫ –º–∏–Ω–∏–º–∞–ª–µ–Ω.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `EarnOnly` –ø–∏—à–µ—Ç—Å—è –≤ `OfflineQueue` —Å —Ç–∏–ø–æ–º `EARN_ONLY` –∏ TTL 8 —á–∞—Å–æ–≤. –ö–∞—Å—Å–∏—Ä—É ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–Ω–µ –æ—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä—É—é—â–∞—è –∫–∞—Å—Å—É). `IdempotencyKey` = –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. TTL Spend/Discount = 24—á –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

***

### Q4 ‚Äî –í–æ–∑–≤—Ä–∞—Ç —á–µ–∫–∞ (Refund)

**–í–æ–ø—Ä–æ—Å:** –ì–æ—Å—Ç—å –æ–ø–ª–∞—Ç–∏–ª —á–µ–∫, –ø–æ–ª—É—á–∏–ª –±–∞–ª–ª—ã –∑–∞ –Ω–µ–≥–æ. –ü–æ—Ç–æ–º —Å–¥–µ–ª–∞–ª –≤–æ–∑–≤—Ä–∞—Ç (—á–∞—Å—Ç—å –∏–ª–∏ –ø–æ–ª–Ω—ã–π). Backend –¥–æ–ª–∂–µ–Ω –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –±–∞–ª–ª—ã ‚Äî –Ω–æ –∫–∞–∫–æ–π –º–µ—Ö–∞–Ω–∏–∑–º?

**–û—Ç–≤–µ—Ç:** iiko/R-Keeper –≤—ã–∑—ã–≤–∞–µ—Ç `/finalize-refund` –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ. Backend –Ω–∞—Ö–æ–¥–∏—Ç –∏—Å—Ö–æ–¥–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é earn –ø–æ `posOrderId` –∏ —Å–æ–∑–¥–∞—ë—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Ç–∏–ø–∞ `REFUND`, —Å–≤—è–∑–∞–Ω–Ω—É—é —á–µ—Ä–µ–∑ `linkedTransactionId`.

```typescript
// backend: POST /api/pos-integration/iiko/finalize-refund
async finalizeRefund(req: FinalizeRefundRequest) {
  // 1. –ù–∞–π—Ç–∏ –∏—Å—Ö–æ–¥–Ω—É—é EARN —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ posOrderId
  const originalTx = await this.prisma.transaction.findFirst({
    where: {
      posOrderId: req.orderId,
      type: 'EARN',
      guestCard: { id: req.guestCardId }
    }
  });

  if (!originalTx) {
    // –ù–µ—Ç –±–∞–ª–ª–æ–≤ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ ‚Äî –Ω–æ—Ä–º (–∑–∞–∫–∞–∑ –±—ã–ª –±–µ–∑ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏)
    return { success: true, pointsReversed: 0, message: 'No points to reverse' };
  }

  // 2. –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  const refundRatio = req.refundAmount / req.originalAmount;
  const pointsToReverse = Math.floor(originalTx.amount * refundRatio);

  // 3. –ù–µ —É—Ö–æ–¥–∏–º –≤ –º–∏–Ω—É—Å ‚Äî —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –µ—Å—Ç—å –Ω–∞ –±–∞–ª–∞–Ω—Å–µ
  const card = await this.prisma.loyaltyCard.findUnique({ where: { id: req.guestCardId } });
  const availableToReverse = Math.min(pointsToReverse, card.regularBalance);

  if (availableToReverse === 0) {
    return { success: true, pointsReversed: 0, message: 'Points already spent, cannot reverse' };
  }

  // 4. –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Prisma transaction
  await this.prisma.$transaction(async (tx) => {
    // –°–æ–∑–¥–∞—ë–º REFUND —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    await tx.transaction.create({
      data: {
        type: 'REFUND',
        amount: -availableToReverse,
        guestCardId: req.guestCardId,
        posOrderId: req.orderId,
        linkedTransactionId: originalTx.id,  // –∞—É–¥–∏—Ç-—Ü–µ–ø–æ—á–∫–∞
        reason: 'POS_REFUND',
        posSystem: req.posSystem,
        restaurantId: req.restaurantId
      }
    });

    // –£–º–µ–Ω—å—à–∞–µ–º –±–∞–ª–∞–Ω—Å
    await tx.loyaltyCard.update({
      where: { id: req.guestCardId },
      data: { regularBalance: { decrement: availableToReverse } }
    });
  });

  return {
    success: true,
    pointsReversed: availableToReverse,
    newBalance: card.regularBalance - availableToReverse
  };
}
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –≤ iiko:**

```csharp
// iiko plugin: –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞
private void SubscribeToEvents() {
    operations.OrderClosed += OnOrderClosed;
    operations.PaymentEdited += OnPaymentEdited;
    operations.OrderRefunded += OnOrderRefunded;  // ‚Üê –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
}

private async void OnOrderRefunded(object sender, OrderRefundedEventArgs e) {
    var context = GetOrderLoyaltyContext(e.OriginalOrder);
    if (context == null) return; // –∑–∞–∫–∞–∑ –±—ã–ª –±–µ–∑ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏

    await apiClient.FinalizeRefundAsync(new FinalizeRefundRequest {
        GuestCardId = context.GuestCardId,
        OrderId = e.OriginalOrder.Id.ToString(),
        RefundAmount = e.RefundAmount,
        OriginalAmount = context.OriginalCheckAmount,
        RestaurantId = restaurantConfig.RestaurantId
    });
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ë–µ–∑ refund-—Ö—É–∫–∞ –≥–æ—Å—Ç—å –º–æ–∂–µ—Ç: –∑–∞–ø–ª–∞—Ç–∏—Ç—å 890‚ÇΩ, –ø–æ–ª—É—á–∏—Ç—å 45 –±–∞–ª–ª–æ–≤, —Å—Ä–∞–∑—É —Å–¥–µ–ª–∞—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –¥–µ–Ω–µ–≥ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–ª–ª—ã. `linkedTransactionId` —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª–Ω—É—é –∞—É–¥–∏—Ç-—Ü–µ–ø–æ—á–∫—É `earn ‚Üí refund`. –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç = —á–µ—Å—Ç–Ω—ã–π —Ä–∞—Å—á—ë—Ç –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –≤–æ–∑–≤—Ä–∞—Ç–µ.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –≠–Ω–¥–ø–æ–∏–Ω—Ç `POST /finalize-refund` (–¥–ª—è iiko –∏ rkeeper). –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π refund –ø–æ —Ñ–æ—Ä–º—É–ª–µ `originalPoints √ó (refundAmount / originalAmount)`. –ù–µ —É—Ö–æ–¥–∏–º –≤ –º–∏–Ω—É—Å. –°–æ–∑–¥–∞—ë–º `REFUND` —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å `linkedTransactionId`. –ü–æ–¥–ø–∏—Å–∫–∞ `operations.OrderRefunded` –≤ iiko-–ø–ª–∞–≥–∏–Ω–µ.

***

### Q5 ‚Äî Split Bill

**–í–æ–ø—Ä–æ—Å:** –°—Ç–æ–ª –Ω–∞ 4 —á–µ–ª–æ–≤–µ–∫–∞, –æ–¥–∏–Ω —Ö–æ—á–µ—Ç –æ–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏ —Å–≤–æ—é —á–∞—Å—Ç—å. –í iiko –∑–∞–∫–∞–∑ –¥–µ–ª–∏—Ç—Å—è –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ–∫–æ–≤ (`splitGroupId`). –ö–∞–∫ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –¥–≤–æ–π–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∫ split-—á–∞—Å—Ç—è–º –æ–¥–Ω–æ–≥–æ —Å—Ç–æ–ª–∞?

**–û—Ç–≤–µ—Ç:** Backend –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–∏–≤—è–∑–∫—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∫–æ –≤—Ç–æ—Ä–æ–π —á–∞—Å—Ç–∏ split-–∑–∞–∫–∞–∑–∞, –µ—Å–ª–∏ –ø–µ—Ä–≤–∞—è —É–∂–µ –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é.

```typescript
// backend: reserve-points
async reservePoints(req: ReservePointsRequest, installation: PluginInstallation) {

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º split-–≥—Ä—É–ø–ø—É (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω splitGroupId)
  if (req.splitGroupId) {
    const existingSplit = await this.prisma.pointsReservation.findFirst({
      where: {
        splitGroupId: req.splitGroupId,
        status: { in: ['ACTIVE', 'FINALIZED'] }
      }
    });

    if (existingSplit) {
      throw new AppException(
        'LOYALTY_ALREADY_APPLIED_TO_SPLIT', 422,
        'Loyalty already applied to another part of this split order. ' +
        'Only one split can use loyalty per table.'
      );
    }
  }

  // –°–æ–∑–¥–∞—ë–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é —Å splitGroupId
  const reservation = await this.prisma.pointsReservation.create({
    data: {
      // ...
      splitGroupId: req.splitGroupId ?? null,
      orderId: req.orderId,
      // ...
    }
  });

  return { success: true, reservationId: reservation.id };
}
```

```csharp
// iiko plugin: –ø–µ—Ä–µ–¥–∞—ë–º splitGroupId –µ—Å–ª–∏ –∑–∞–∫–∞–∑ —è–≤–ª—è–µ—Ç—Å—è split-—á–∞—Å—Ç—å—é
var reserveResponse = await apiClient.ReservePointsAsync(new ReserveRequest {
    GuestCardId = currentGuest.CardId,
    PointsToSpend = pointsToSpend,
    OrderId = currentOrder.Id.ToString(),
    SplitGroupId = currentOrder.SplitGroupId?.ToString(), // null –µ—Å–ª–∏ –Ω–µ split
    // ...
});
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∫ –¥–≤—É–º —á–∞—Å—Ç—è–º –æ–¥–Ω–æ–≥–æ split = –¥–≤–æ–π–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞ –æ–¥–∏–Ω —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ç–æ–ª. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ `splitGroupId` ‚Äî —á–∏—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ. –û–¥–∏–Ω —Å—Ç–æ–ª = –º–∞–∫—Å–∏–º—É–º –æ–¥–Ω–∞ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω–∞—è –ª–æ—è–ª—å–Ω–æ—Å—Ç—å.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –ü–æ–ª–µ `splitGroupId` –≤ `PointsReservation`. –ü—Ä–∏ `reserve-points` –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π/—Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ —Å —Ç–µ–º –∂–µ `splitGroupId`. –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ ‚Üí `LOYALTY_ALREADY_APPLIED_TO_SPLIT` 422. –ü–ª–∞–≥–∏–Ω—ã –ø–µ—Ä–µ–¥–∞—é—Ç `splitGroupId` –∏–∑ SDK (iiko) –∏–ª–∏ XML API (R-Keeper).

***

## –ë–õ–û–ö B ‚Äî OFFLINE –†–ï–ñ–ò–ú


***

### Q6 ‚Äî Overflow Offline Queue

**–í–æ–ø—Ä–æ—Å:** –ü—Ä–∏ 100 –æ–ø–µ—Ä–∞—Ü–∏—è—Ö –≤ –æ—á–µ—Ä–µ–¥–∏ —Ç–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ. –ö–∞—Å—Å–∏—Ä –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –≤–æ–æ–±—â–µ ‚Äî –∫–∞—Å—Å–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞.

**–û—Ç–≤–µ—Ç:** –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ overflow: `EARN_ONLY` ‚Äî –¥—Ä–æ–ø–∞–µ–º –º–æ–ª—á–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º, `SPEND`/`DISCOUNT` ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º —Å –æ—à–∏–±–∫–æ–π (—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã).

```csharp
public async Task EnqueueAsync(OfflineOperation operation) {
    var queue = await LoadQueueAsync();

    if (queue.Count >= MaxQueueSize) {

        if (operation.Type == "EARN_ONLY") {
            // EarnOnly ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ—Ç–µ—Ä—è—Ç—å –ø—Ä–∏ overflow
            logger.LogWarning(
                "Offline queue full ({Count}). Dropping EarnOnly for OrderId:{OrderId}",
                queue.Count, operation.OrderId);
            metricsService.RecordMetric("loyalty.earn_only.dropped", 1);

            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∫–∞—Å—Å–∏—Ä—É, –Ω–æ –∫–∞—Å—Å–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
            ShowWarning("–û—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. " +
                        "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
            return; // –Ω–µ –±—Ä–æ—Å–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
        }

        // SPEND / DISCOUNT –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º
        // –ù–µ–ª—å–∑—è —Å–ø–∏—Å—ã–≤–∞—Ç—å –±–∞–ª–ª—ã –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è backend
        logger.LogError(
            "Offline queue full ({Count}). Blocking SPEND/DISCOUNT for OrderId:{OrderId}",
            queue.Count, operation.OrderId);
        metricsService.RecordMetric("loyalty.queue.overflow_block", 1);

        throw new QueueOverflowException(
            "Offline queue is full (100 operations). Spend/Discount unavailable. " +
            "Please contact support or restore internet connection."
        );
    }

    // –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ –æ—á–µ—Ä–µ–¥—å
    operation.Id = Guid.NewGuid().ToString();
    operation.QueuedAt = DateTime.UtcNow;
    operation.Attempts = 0;
    queue.Add(operation);
    await SaveQueueAsync(queue);

    logger.LogWarning(
        "Operation queued offline Type:{Type}, OrderId:{OrderId}, QueueSize:{Size}",
        operation.Type, operation.OrderId, queue.Count);
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** 100 –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –æ—á–µ—Ä–µ–¥–∏ = —Ä–µ—Å—Ç–æ—Ä–∞–Ω –Ω–µ –∏–º–µ–ª —Å–≤—è–∑–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤. –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Å—Å—É –ø–æ–ª–Ω–æ—Å—Ç—å—é = –≤—Ç–æ—Ä–∞—è –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞. `EarnOnly` ‚Äî —ç—Ç–æ –±–æ–Ω—É—Å, –µ–≥–æ –ø–æ—Ç–µ—Ä—è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ. `SPEND` ‚Äî —ç—Ç–æ –¥–µ–Ω—å–≥–∏: –Ω–µ–ª—å–∑—è —Å–ø–∏—Å—ã–≤–∞—Ç—å —Å –±–∞–ª–∞–Ω—Å–∞ –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ (—Ä–∏—Å–∫ –¥–≤–æ–π–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏).

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏ `queue.Count >= 100`: `EARN_ONLY` ‚Äî –¥—Ä–æ–ø + –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∫–∞—Å—Å–∏—Ä—É (–∫–∞—Å—Å–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è). `SPEND` / `DISCOUNT` ‚Äî `QueueOverflowException` + –æ—à–∏–±–∫–∞ –∫–∞—Å—Å–∏—Ä—É. –ú–µ—Ç—Ä–∏–∫–∏ `loyalty.earn_only.dropped` –∏ `loyalty.queue.overflow_block` –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

***

### Q7 ‚Äî Idempotency –ø—Ä–∏ Reconciliation Offline Queue

**–í–æ–ø—Ä–æ—Å:** –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—á–µ—Ä–µ–¥–∏ –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤—è–∑–∏ –≤–æ–∑–º–æ–∂–Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—è: –æ–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —É—à–ª–∞ –Ω–∞ backend (–º–µ–¥–ª–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç), –Ω–æ –ø–ª–∞–≥–∏–Ω –ø–æ–ª—É—á–∏–ª `TimeoutException` –∏ –∑–∞–ø–∏—Å–∞–ª –µ—ë –≤ –æ—á–µ—Ä–µ–¥—å. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ ‚Äî –¥–≤–æ–π–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤.

**–û—Ç–≤–µ—Ç:** –ö–∞–∂–¥–∞—è offline-–æ–ø–µ—Ä–∞—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç `idempotencyKey` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏. Backend –∫–µ—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ Redis –Ω–∞ 24 —á–∞—Å–∞ –∏ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.

```csharp
// –ü–ª–∞–≥–∏–Ω: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º idempotencyKey –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
private OfflineOperation CreateOfflineOperation(LoyaltyContext context, string orderId, string type) {
    return new OfflineOperation {
        Type = type,
        IdempotencyKey = $"offline_{restaurantConfig.RestaurantId}_{orderId}_{context.GuestCardId}_{type}",
        TtlHours = type == "EARN_ONLY" ? 8 : 24,
        Context = context,
        OrderId = orderId,
        QueuedAt = DateTime.UtcNow,
        Attempts = 0
    };
}
```

```typescript
// backend: finalize-points —Å idempotency check (middleware)
@Injectable()
export class IdempotencyMiddleware implements NestMiddleware {
  constructor(private readonly redis: RedisService) {}

  async use(req: Request, res: Response, next: NextFunction) {
    const key = req.headers['x-idempotency-key'] as string;
    if (!key) return next();

    const cached = await this.redis.get(`idempotency:plugin:${key}`);
    if (cached) {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
      return res.status(200).json({
        ...JSON.parse(cached),
        alreadyProcessed: true
      });
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    const originalJson = res.json.bind(res);
    res.json = (body) => {
      this.redis.set(
        `idempotency:plugin:${key}`,
        JSON.stringify(body),
        'EX',
        86400 // TTL 24—á = –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π TTL offline –æ–ø–µ—Ä–∞—Ü–∏–∏
      );
      return originalJson(body);
    };

    next();
  }
}
```

```csharp
// –ü–ª–∞–≥–∏–Ω: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å idempotency-key –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
httpClient.DefaultRequestHeaders.Add("X-Idempotency-Key", operation.IdempotencyKey);
var response = await httpClient.PostAsync(endpoint, content);
// –ï—Å–ª–∏ alreadyProcessed: true ‚Äî –≤—Å—ë —Ö–æ—Ä–æ—à–æ, –æ–ø–µ—Ä–∞—Ü–∏—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ë–µ–∑ idempotency: –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è 3G –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ + –æ—á–µ—Ä–µ–¥—å –∏–∑ 50 –æ–ø–µ—Ä–∞—Ü–∏–π = –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ 50 –¥–≤–æ–π–Ω—ã—Ö –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –±–∞–ª–ª–æ–≤. Redis TTL 24—á —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º TTL offline-–æ—á–µ—Ä–µ–¥–∏.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `idempotencyKey` = `offline_{restaurantId}_{orderId}_{guestCardId}_{type}` ‚Äî –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –±–µ–∑ timestamp (–¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–∞—Ö). `X-Idempotency-Key` header –≤–æ –≤—Å–µ—Ö `finalize-*` –∑–∞–ø—Ä–æ—Å–∞—Ö –∏–∑ offline-–æ—á–µ—Ä–µ–¥–∏. Redis cache TTL 24—á. –û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç `alreadyProcessed: true` –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ.

***

## –ë–õ–û–ö C ‚Äî –£–°–¢–ê–ù–û–í–ö–ê –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï


***

### Q8 ‚Äî Admin Panel: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–Ω—Å—Ç–∞–ª–ª—è—Ü–∏—è–º–∏

**–í–æ–ø—Ä–æ—Å:** Backend —Å–æ–∑–¥–∞—ë—Ç installation –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç installer.exe. –ß—Ç–æ –¥–∞–ª—å—à–µ –≤–∏–¥–∏—Ç Admin –≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Äî –ø–æ–ª–Ω—ã–π lifecycle management —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–∞—Å—Å?

**–û—Ç–≤–µ—Ç:** –°—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´POS –ü–ª–∞–≥–∏–Ω—ã¬ª –≤ Admin Panel —Å real-time —Å—Ç–∞—Ç—É—Å–æ–º –≤—Å–µ—Ö –∫–∞—Å—Å, lifecycle management –∏ –±—ã—Å—Ç—Ä—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏.

```typescript
// backend endpoints –¥–ª—è Admin Panel
GET    /api/admin/plugin-installations?restaurantId=xxx    // —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–∞—Å—Å
POST   /api/admin/plugin-installations/iiko                // —Å–æ–∑–¥–∞—Ç—å iiko-—É—Å—Ç–∞–Ω–æ–≤–∫—É
POST   /api/admin/plugin-installations/rkeeper             // —Å–æ–∑–¥–∞—Ç—å rkeeper-—É—Å—Ç–∞–Ω–æ–≤–∫—É
GET    /api/admin/plugin-installations/:id                  // –¥–µ—Ç–∞–ª–∏ –∫–∞—Å—Å—ã
PATCH  /api/admin/plugin-installations/:id/ui-settings     // –æ–±–Ω–æ–≤–∏—Ç—å UI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
POST   /api/admin/plugin-installations/:id/regenerate-key  // –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å API Key
POST   /api/admin/plugin-installations/:id/force-update    // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
POST   /api/admin/plugin-installations/:id/request-logs    // –∑–∞–ø—Ä–æ—Å–∏—Ç—å –ª–æ–≥–∏
POST   /api/admin/plugin-installations/:id/revoke          // –æ—Ç–æ–∑–≤–∞—Ç—å
DELETE /api/admin/plugin-installations/:id                 // —É–¥–∞–ª–∏—Ç—å
GET    /api/admin/plugin-installations/:id/events          // –∏—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100)
GET    /api/admin/plugin-installations/:id/metrics         // –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—Å—Å—ã
```

**UI –≤ Admin Panel (Next.js):**

```
Admin Panel ‚Üí –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Üí POS –ü–ª–∞–≥–∏–Ω—ã

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  POS –ü–ª–∞–≥–∏–Ω—ã                                      [+ –î–æ–±–∞–≤–∏—Ç—å]     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  iiko Front                                                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ üü¢ –ö–∞—Å—Å–∞ 1 (term-001)      v1.2.0  45ms  —Å–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–µ–≥–æ–¥–Ω—è: 47  |  –ë–∞–ª–ª–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω–æ: 3,450        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    Offline –æ—á–µ—Ä–µ–¥—å: 0      |  –û—à–∏–±–æ–∫ —Å–µ–≥–æ–¥–Ω—è: 2              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    [–°–∫–∞—á–∞—Ç—å installer] [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚ñæ]                        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ üü° –ö–∞—Å—Å–∞ 2 (term-002)      v1.1.0  120ms  –æ–Ω–ª–∞–π–Ω   ‚ö†Ô∏è —É—Å—Ç–∞—Ä. ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    [–°–∫–∞—á–∞—Ç—å installer] [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚ñæ]                        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ üî¥ –ö–∞—Å—Å–∞ 3 (term-003)      v1.2.0  ‚Äî    –æ—Ñ–ª–∞–π–Ω 47 –º–∏–Ω  üö®   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    Offline –æ—á–µ—Ä–µ–¥—å: 3 –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–∂–∏–¥–∞—é—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    [–°–∫–∞—á–∞—Ç—å installer] [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚ñæ]                        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ  R-Keeper                                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ üü¢ –¢–µ—Ä–º–∏–Ω–∞–ª 1 (term-004)   v1.0.0  60ms  —Å–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    [–°–∫–∞—á–∞—Ç—å installer] [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚ñæ]                        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚ñæ (dropdown):
  üì•  –°–∫–∞—á–∞—Ç—å –Ω–æ–≤—ã–π installer
  üîÑ  –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  üîë  –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å API Key
  ‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∏ UI (–ø–æ–∑–∏—Ü–∏—è –∫–Ω–æ–ø–∫–∏, –∑–≤—É–∫–∏...)
  üìä  –ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100)
  üìã  –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ª–æ–≥–∏
  üö´  –û—Ç–æ–∑–≤–∞—Ç—å –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏—é
  üóë   –£–¥–∞–ª–∏—Ç—å
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** Admin –Ω–µ –¥–æ–ª–∂–µ–Ω —É–∑–Ω–∞–≤–∞—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∫–∞—Å—Å–æ–π –æ—Ç –∫–∞—Å—Å–∏—Ä–∞ —á–µ—Ä–µ–∑ 3 —á–∞—Å–∞. `lastSeenAt` –∏–∑ heartbeat + —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä = –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—Å–µ—Ö –∫–∞—Å—Å. –í–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞ –≤–∏–¥–Ω–∞ —Å—Ä–∞–∑—É ‚Üí Admin –∑–Ω–∞–µ—Ç, –∫–æ–≥–æ –Ω–∞–¥–æ –æ–±–Ω–æ–≤–∏—Ç—å.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´POS –ü–ª–∞–≥–∏–Ω—ã¬ª –≤ Admin Panel. –°—Ç–∞—Ç—É—Å: üü¢ –æ–Ω–ª–∞–π–Ω (heartbeat < 2 –º–∏–Ω) / üü° –æ–Ω–ª–∞–π–Ω —É—Å—Ç–∞—Ä–µ–ª (version < latest) / üî¥ –æ—Ñ–ª–∞–π–Ω (heartbeat > 10 –º–∏–Ω). –ü–æ–∫–∞–∑—ã–≤–∞–µ–º: –≤–µ—Ä—Å–∏—é, latency, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–µ–≥–æ–¥–Ω—è, —Ä–∞–∑–º–µ—Ä offline-–æ—á–µ—Ä–µ–¥–∏. Actions: —Å–∫–∞—á–∞—Ç—å installer, regenerate key, force update, request logs, revoke, delete.

***

### Q9 ‚Äî Heartbeat –ú–µ—Ö–∞–Ω–∏–∑–º

**–í–æ–ø—Ä–æ—Å:** –ù–µ—Ç —è–≤–Ω–æ–≥–æ heartbeat –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏. Backend –∑–Ω–∞–µ—Ç –æ `lastSeenAt` —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö. –ù–æ—á—å—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–µ—Ç ‚Äî –∫–∞—Å—Å–∞ –º–æ–ª—á–∏—Ç 12 —á–∞—Å–æ–≤, Admin –≤–∏–¥–∏—Ç –µ—ë ¬´–æ—Ñ–ª–∞–π–Ω¬ª —Ö–æ—Ç—è –æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç.

**–û—Ç–≤–µ—Ç:** –ü–ª–∞–≥–∏–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç heartbeat –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥. Backend –æ–±–Ω–æ–≤–ª—è–µ—Ç `lastSeenAt` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞, –∑–∞–ø—Ä–æ—Å –ª–æ–≥–æ–≤, —Ñ–ª–∞–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è).

```typescript
// backend: POST /api/pos-integration/heartbeat (–æ–±—â–∏–π –¥–ª—è iiko –∏ rkeeper)
async heartbeat(req: HeartbeatRequest, installation: PluginInstallation) {
  await this.prisma.pluginInstallation.update({
    where: { id: installation.id },
    data: {
      lastSeenAt: new Date(),
      pluginVersion: req.version,
      osVersion: req.osVersion,
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ heartbeat
      lastMetrics: {
        queueSize: req.metrics.queueSize,
        cpuUsage: req.metrics.cpuUsage,
        memoryMb: req.metrics.memoryMb,
        transactionsToday: req.metrics.transactionsToday,
        latencyP95: req.metrics.latencyP95
      }
    }
  });

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–º–∞–Ω–¥ –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞
  const pendingCommands = await this.prisma.pluginCommand.findMany({
    where: {
      installationId: installation.id,
      status: 'PENDING'
    }
  });

  // –û—Ç–≤–µ—á–∞–µ–º –ø–ª–∞–≥–∏–Ω—É —Å –∫–æ–º–∞–Ω–¥–∞–º–∏
  return {
    acknowledged: true,
    serverTime: new Date().toISOString(),
    commands: pendingCommands.map(c => ({
      commandId: c.id,
      type: c.type,       // RELOAD_CONFIG | REQUEST_LOGS | FORCE_UPDATE | SHOW_MESSAGE
      payload: c.payload
    })),
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º critical update
    criticalUpdateAvailable: await this.checkCriticalUpdate(
      req.version,
      installation.posSystem
    )
  };
}
```

```csharp
// iiko plugin: heartbeat –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫
private void StartHeartbeat() {
    _heartbeatTimer = new System.Timers.Timer(60_000); // 60 —Å–µ–∫
    _heartbeatTimer.Elapsed += async (s, e) => await SendHeartbeatAsync();
    _heartbeatTimer.AutoReset = true;
    _heartbeatTimer.Start();

    // –ü–µ—Ä–≤—ã–π heartbeat —á–µ—Ä–µ–∑ 5 —Å–µ–∫ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞
    Task.Delay(5_000).ContinueWith(async _ => await SendHeartbeatAsync());
}

private async Task SendHeartbeatAsync() {
    try {
        var response = await apiClient.HeartbeatAsync(new HeartbeatRequest {
            InstallationId = config.InstallationId,
            Version = GetPluginVersion(),
            OsVersion = Environment.OSVersion.ToString(),
            Metrics = new {
                QueueSize = offlineQueue.Count,
                CpuUsage = metricsService.GetCpuUsage(),
                MemoryMb = metricsService.GetMemoryMb(),
                TransactionsToday = metricsService.GetTransactionsToday(),
                LatencyP95 = metricsService.GetLatencyP95()
            }
        });

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –æ—Ç backend
        foreach (var cmd in response.Commands) {
            await ProcessCommandAsync(cmd);
        }

        if (response.CriticalUpdateAvailable) {
            ShowCriticalUpdateAlert();
        }

    } catch (Exception ex) {
        logger.LogWarning(ex, "Heartbeat failed (non-critical)");
        // –û—à–∏–±–∫–∞ heartbeat ‚Äî –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É
    }
}

private async Task ProcessCommandAsync(PluginCommand cmd) {
    switch (cmd.Type) {
        case "RELOAD_CONFIG":
            var newConfig = await apiClient.GetRestaurantConfigAsync();
            configService.SaveRestaurantConfig(newConfig);
            ApplyConfig(newConfig); // –ø—Ä–∏–º–µ–Ω—è–µ–º –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
            break;
        case "REQUEST_LOGS":
            await UploadLogsAsync(cmd.CommandId);
            break;
        case "FORCE_UPDATE":
            await CheckForUpdatesAsync(forceCheck: true);
            break;
        case "SHOW_MESSAGE":
            ShowAdminMessage(cmd.Payload["message"].ToString());
            break;
    }
    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    await apiClient.AckCommandAsync(cmd.CommandId);
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** Heartbeat —Ä–µ—à–∞–µ—Ç 4 –∑–∞–¥–∞—á–∏: —Å—Ç–∞—Ç—É—Å –∫–∞—Å—Å –≤ Admin Panel, push –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–æ–Ω—Ñ–∏–≥–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø–ª–∞–≥–∏–Ω–∞, remote log collection, push –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π. 60 —Å–µ–∫ = –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å—é –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ backend.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** Heartbeat –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫ –∏–∑ –ø–ª–∞–≥–∏–Ω–∞. Payload: version, osVersion, metrics (queueSize, cpu, memory, transactionsToday, latencyP95). Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `commands[]` (RELOAD_CONFIG | REQUEST_LOGS | FORCE_UPDATE | SHOW_MESSAGE) + `criticalUpdateAvailable`. –¢–∞–±–ª–∏—Ü–∞ `plugin_commands` –¥–ª—è –æ—á–µ—Ä–µ–¥–∏ –∫–æ–º–∞–Ω–¥. –ü–ª–∞–≥–∏–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∫–æ–º–∞–Ω–¥–æ–π `ACK`.

***

### Q10 ‚Äî Machine Binding: –°–æ—Å—Ç–∞–≤ machineId

**–í–æ–ø—Ä–æ—Å:** `machineId` = —Å–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è API Key. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—Å—è –æ–¥–Ω–∞ –∏–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (–∑–∞–º–µ–Ω–∞ –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–æ–π –ø–ª–∞—Ç—ã, –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ Windows) ‚Äî –ø–ª–∞–≥–∏–Ω –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è, –∫–ª—é—á –Ω–µ —Ä–∞—Å—à–∏—Ñ—Ä—É–µ—Ç—Å—è.

**–û—Ç–≤–µ—Ç:** `machineId` —Å—Ç—Ä–æ–∏—Ç—Å—è –∏–∑ 3 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏. –ü—Ä–∏ –ø–æ–ª–Ω–æ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ —Ö–æ—Ç—è –±—ã –¥–≤—É—Ö –∏–∑ —Ç—Ä—ë—Ö ‚Äî –ø–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç (tolerant matching).

```csharp
public static class MachineIdentifier {

    public static string GetMachineId() {
        var components = new List<string>();

        // –ò—Å—Ç–æ—á–Ω–∏–∫ 1: BIOS/UEFI UUID ‚Äî —Å–∞–º—ã–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π (–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –û–°)
        try {
            var uuid = GetWmiValue("Win32_ComputerSystemProduct", "UUID");
            // –ò—Å–∫–ª—é—á–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ UUID —É –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π
            var invalidUuids = new[] {
                "FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF",
                "00000000-0000-0000-0000-000000000000",
                "03000200-0400-0500-0006-000700080009"
            };
            if (!string.IsNullOrEmpty(uuid) && !invalidUuids.Contains(uuid)) {
                components.Add($"bios:{uuid.ToUpper()}");
            }
        } catch (Exception ex) {
            logger.Debug("Failed to get BIOS UUID: {ex}", ex.Message);
        }

        // –ò—Å—Ç–æ—á–Ω–∏–∫ 2: –°–∏—Å—Ç–µ–º–Ω—ã–π –¥–∏—Å–∫ Serial Number (–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–º–µ–Ω–µ –¥–∏—Å–∫–∞)
        try {
            var diskSerial = GetWmiValue("Win32_DiskDrive WHERE Index=0", "SerialNumber");
            if (!string.IsNullOrEmpty(diskSerial?.Trim())) {
                components.Add($"disk:{diskSerial.Trim().ToUpper()}");
            }
        } catch { }

        // –ò—Å—Ç–æ—á–Ω–∏–∫ 3: Hostname (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –º–µ–Ω–µ–µ —Å—Ç–∞–±–∏–ª–µ–Ω)
        components.Add($"host:{Environment.MachineName.ToUpper()}");

        if (components.Count == 0) {
            throw new Exception("Cannot determine machine identity. Please contact support.");
        }

        var combined = string.Join("|", components.OrderBy(c => c)); // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞
        using var sha256 = SHA256.Create();
        var hash = sha256.ComputeHash(Encoding.UTF8.GetBytes(combined + "MaxLoyaltySalt2026"));
        return Convert.ToHexString(hash).ToLower();
    }

    // –î–ª—è tolerant matching: –º–∏–Ω–∏–º—É–º 2 –∏–∑ 3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞—Å—Ç—å
    public static bool ValidateMachineBinding(string storedMachineId, MachineComponents current) {
        var stored = ParseStoredComponents(storedMachineId);
        int matches = 0;
        if (stored.BiosUuid == current.BiosUuid) matches++;
        if (stored.DiskSerial == current.DiskSerial) matches++;
        if (stored.Hostname == current.Hostname) matches++;
        return matches >= 2; // –¥–æ–ø—É—Å–∫–∞–µ–º –∑–∞–º–µ–Ω—É –æ–¥–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    }
}
```

**–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–∏ –∑–∞–º–µ–Ω–µ –∂–µ–ª–µ–∑–∞:**

```
Admin Panel ‚Üí –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Üí POS –ü–ª–∞–≥–∏–Ω—ã ‚Üí [–ö–∞—Å—Å–∞ 1] ‚Üí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí üîë –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å API Key

–®–∞–≥ 1: Admin –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å API Key¬ª
–®–∞–≥ 2: Backend —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π API Key, —Å—Ç–∞—Ä—ã–π –ø–æ–ª—É—á–∞–µ—Ç grace 30 –º–∏–Ω
–®–∞–≥ 3: Admin —Å–∫–∞—á–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π installer (—Å –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º)
–®–∞–≥ 4: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–∞ –Ω–æ–≤–æ–µ –∂–µ–ª–µ–∑–æ
–®–∞–≥ 5: –°—Ç–∞—Ä—ã–π –∫–ª—é—á –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 30 –º–∏–Ω
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –û–¥–Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ `machineId` = BIOS UUID ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–∞. Tolerant matching (2 –∏–∑ 3) = –ø—Ä–∏ –∑–∞–º–µ–Ω–µ –æ–¥–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –ø–ª–∞–≥–∏–Ω –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É. –°—Ç—Ä–æ–≥–∏–π matching (3 –∏–∑ 3) = –ª—é–±–∞—è –∑–∞–º–µ–Ω–∞ –∂–µ–ª–µ–∑–∞ –ª–æ–º–∞–µ—Ç –ø–ª–∞–≥–∏–Ω.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `machineId` = SHA256(BIOS UUID + HDD Serial + Hostname + —Å–æ–ª—å). Tolerant matching: –ø–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ –º–∏–Ω–∏–º—É–º 2 –∏–∑ 3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç. –ü—Ä–∏ –ø–æ–ª–Ω–æ–º –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è API Key —á–µ—Ä–µ–∑ Admin Panel. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞: Admin regenerate ‚Üí —Å–∫–∞—á–∞—Ç—å installer ‚Üí –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ –Ω–æ–≤–æ–µ –∂–µ–ª–µ–∑–æ.

***

## –ë–õ–û–ö D ‚Äî –û–ë–ù–û–í–õ–ï–ù–ò–Ø


***

### Q11 ‚Äî –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ vs –û–±—ã—á–Ω—ã–µ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–í–æ–ø—Ä–æ—Å:** –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞: `MessageBox.Show("–û–±–Ω–æ–≤–∏—Ç—å?", YesNo)`. –ö–∞—Å—Å–∏—Ä –º–æ–∂–µ—Ç –Ω–∞–∂–∞—Ç—å ¬´–ù–µ—Ç¬ª –Ω–∞ security patch. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏.

**–û—Ç–≤–µ—Ç:** –î–≤–∞ —Ä–µ–∂–∏–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: –æ–±—ã—á–Ω–æ–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ—à–∞–µ—Ç) –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ (countdown 5 –º–∏–Ω ‚Üí –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞).

```csharp
private async Task HandleUpdateNotificationAsync(UpdateInfo updateInfo) {
    if (updateInfo.IsCritical) {
        // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ç–ª–æ–∂–∏—Ç—å –Ω–∞ 5 –º–∏–Ω
        await ShowCriticalUpdateCountdownAsync(updateInfo, TimeSpan.FromMinutes(5));
    } else {
        // –û–ë–´–ß–ù–û–ï: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ—à–∞–µ—Ç
        var result = MessageBox.Show(
            $"–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è Max Loyalty {updateInfo.Version}\n\n" +
            $"–ò–∑–º–µ–Ω–µ–Ω–∏—è:\n{updateInfo.ChangeLog}\n\n" +
            $"–†–∞–∑–º–µ—Ä: {updateInfo.SizeBytes / 1024 / 1024} MB\n\n" +
            $"–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å?",
            "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ",
            MessageBoxButton.YesNo,
            MessageBoxImage.Information
        );
        if (result == MessageBoxResult.Yes) {
            await DownloadAndInstallUpdateAsync(updateInfo);
        }
    }
}

private async Task ShowCriticalUpdateCountdownAsync(UpdateInfo updateInfo, TimeSpan countdown) {
    // –û–∫–Ω–æ —Å countdown ‚Äî –∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–º–µ–Ω–∏—Ç—å¬ª –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
    var countdownWindow = new CriticalUpdateWindow {
        UpdateInfo = updateInfo,
        Countdown = countdown
    };
    countdownWindow.Show();

    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å–∫–∞—á–∏–≤–∞–µ–º –≤ —Ñ–æ–Ω–µ
    var downloadTask = DownloadUpdateAsync(updateInfo);

    // –ñ–¥—ë–º countdown
    await Task.Delay(countdown);
    countdownWindow.Close();

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º (—Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª —É–∂–µ –≥–æ—Ç–æ–≤)
    var installerPath = await downloadTask;
    await InstallUpdateAsync(installerPath);
}
```

```typescript
// backend: —Ñ–ª–∞–≥ isCritical –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–µ—Ä—Å–∏–∏
await this.prisma.pluginVersion.create({
  data: {
    platform: 'IIKO',
    version: '1.2.1',
    isCritical: true,       // ‚Üê —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Admin –ø—Ä–∏ —Ä–µ–ª–∏–∑–µ
    criticalReason: 'Security patch: API Key encryption vulnerability',
    changeLog: 'Critical security fix...',
    minVersionToForceUpdate: '1.0.0', // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ—Ö —Å –≤–µ—Ä—Å–∏–∏ 1.0.0+
    // ...
  }
});
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** Security patches = –∫—Ä–∏—Ç–∏—á–Ω–æ, –∫–∞—Å—Å–∏—Ä –Ω–µ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø—Ä–∞–≤–æ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è. 5-–º–∏–Ω—É—Ç–Ω—ã–π countdown = –≤—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç—å —Ç–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑. –§–æ–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–æ –≤—Ä–µ–º—è countdown = —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–Ω—ë—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ countdown –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `isCritical: boolean` –≤ `PluginVersion`. –û–±—ã—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: YesNo MessageBox. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ: `CriticalUpdateWindow` —Å countdown 5 –º–∏–Ω (–Ω–µ—Ç –∫–Ω–æ–ø–∫–∏ ¬´–û—Ç–º–µ–Ω–∏—Ç—å¬ª), —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–æ –≤—Ä–µ–º—è countdown, –∞–≤—Ç–æ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Å–ª–µ countdown. Backend Admin —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `isCritical` –ø—Ä–∏ —Ä–µ–ª–∏–∑–µ security patches.

***

### Q12 ‚Äî Rollback –ø—Ä–∏ –ü—Ä–æ–≤–∞–ª–µ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–í–æ–ø—Ä–æ—Å:** Installer –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ñ–∞–π–ª—ã. –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –º–æ–∂–µ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –∏–∑-–∑–∞ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π iiko/R-Keeper. –ë–µ–∑ rollback ‚Äî –ø–ª–∞–≥–∏–Ω –º—ë—Ä—Ç–≤.

**–û—Ç–≤–µ—Ç:** –ü–µ—Ä–µ–¥ –∑–∞–º–µ–Ω–æ–π —Ñ–∞–π–ª–æ–≤ ‚Äî backup. –ü–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã ‚Äî health check. –ü—Ä–∏ –ø—Ä–æ–≤–∞–ª–µ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ Admin.

```csharp
public async Task InstallUpdateAsync(string newInstallerPath) {
    var currentVersion = GetPluginVersion();
    var backupDir = Path.Combine(
        Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
        "MaxLoyaltyIiko", "backups", currentVersion
    );

    try {
        // –®–∞–≥ 1: –°–æ–∑–¥–∞—ë–º backup —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
        logger.LogInformation("Creating backup of v{Version} to {BackupDir}", currentVersion, backupDir);
        Directory.CreateDirectory(backupDir);
        File.Copy(GetCurrentDllPath(), Path.Combine(backupDir, "MaxLoyaltyIikoPlugin.dll"), overwrite: true);
        File.Copy(GetCurrentConfigPath(), Path.Combine(backupDir, "appsettings.json"), overwrite: true);

        // –®–∞–≥ 2: –ó–∞–ø—É—Å–∫–∞–µ–º installer
        logger.LogInformation("Running installer {Path}", newInstallerPath);
        var process = Process.Start(new ProcessStartInfo {
            FileName = newInstallerPath,
            Arguments = "--silent --update",
            UseShellExecute = true,
            Verb = "runas"
        });
        await process.WaitForExitAsync();

        if (process.ExitCode != 0) {
            throw new Exception($"Installer exited with code {process.ExitCode}");
        }

        // –®–∞–≥ 3: Health check –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ (–∂–¥—ë–º 15 —Å–µ–∫ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
        logger.LogInformation("Waiting for new version to initialize...");
        await Task.Delay(TimeSpan.FromSeconds(15));

        var isHealthy = await HealthCheckNewVersionAsync();
        if (!isHealthy) {
            throw new Exception("New version failed health check");
        }

        logger.LogInformation("Update to {NewVersion} successful", GetPluginVersion());
        // –£–≤–µ–¥–æ–º–ª—è–µ–º Admin –æ–± —É—Å–ø–µ—à–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        await apiClient.ReportUpdateResultAsync(new UpdateResult {
            Success = true,
            NewVersion = GetPluginVersion(),
            PreviousVersion = currentVersion
        });

    } catch (Exception ex) {
        logger.LogError(ex, "Update failed, initiating rollback to v{Version}", currentVersion);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback
        await RollbackAsync(backupDir, currentVersion);

        // –£–≤–µ–¥–æ–º–ª—è–µ–º Admin –æ –ø—Ä–æ–≤–∞–ª–µ
        await apiClient.ReportUpdateResultAsync(new UpdateResult {
            Success = false,
            Error = ex.Message,
            RolledBackTo = currentVersion,
            NewVersion = GetInstalledVersion()
        });

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ Admin –≤ –ø–∞–Ω–µ–ª–∏ –∏ Email
        // (backend —Å–∞–º –æ—Ç–ø—Ä–∞–≤–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ UpdateResult.Success = false)
    }
}

private async Task RollbackAsync(string backupDir, string targetVersion) {
    logger.LogWarning("Rolling back to v{Version}", targetVersion);
    File.Copy(
        Path.Combine(backupDir, "MaxLoyaltyIikoPlugin.dll"),
        GetCurrentDllPath(),
        overwrite: true
    );
    logger.LogInformation("Rollback to v{Version} complete", targetVersion);
}

private async Task<bool> HealthCheckNewVersionAsync() {
    try {
        var response = await httpClient.GetAsync(
            $"{config.BackendApiUrl}/api/health",
            new CancellationTokenSource(TimeSpan.FromSeconds(5)).Token
        );
        return response.IsSuccessStatusCode;
    } catch {
        return false;
    }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ë–µ–∑ rollback –æ–¥–Ω–æ –Ω–µ—É–¥–∞—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ = —Ä–µ—Å—Ç–æ—Ä–∞–Ω –±–µ–∑ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–æ –ø—Ä–∏—Ö–æ–¥–∞ IT-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ Admin = ¬´—Å–∞–º–æ –ø–æ—á–∏–Ω–∏–ª–æ—Å—å¬ª –≤ 99% —Å–ª—É—á–∞–µ–≤. Health check —á–µ—Ä–µ–∑ backend = –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ —Ç–æ–ª—å–∫–æ –∑–∞–ø—É—Å–∫, –Ω–æ –∏ —Å–µ—Ç–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** Backup —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º (–≤ `%AppData%\backups\{version}`). Silent installer + `WaitForExit`. Health check —á–µ—Ä–µ–∑ 15 —Å–µ–∫ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (GET `/api/health`). –ü—Ä–∏ –ø—Ä–æ–≤–∞–ª–µ ‚Äî `RollbackAsync` –∏–∑ backup. `POST /report-update-result` –Ω–∞ backend (Success –∏–ª–∏ Fail + Error). Admin –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –ø–∞–Ω–µ–ª–∏ –∏ email –ø—Ä–∏ –ø—Ä–æ–≤–∞–ª–µ.

***

## –ë–õ–û–ö E ‚Äî R-KEEPER –°–ü–ï–¶–ò–§–ò–ö–ê


***

### Q13 ‚Äî Shared Memory Race Conditions

**–í–æ–ø—Ä–æ—Å:** –î–≤–∞ R-Keeper —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –Ω–∞ –æ–¥–Ω–æ–π Windows-–º–∞—à–∏–Ω–µ (—Ä–µ–¥–∫–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ). `MemoryMappedFile` —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º `MaxLoyaltyRKeeperShared` ‚Üí –æ–±—â–∏–π –¥–ª—è –æ–±–æ–∏—Ö ‚Üí –∑–∞–∫–∞–∑—ã –ø–µ—Ä–µ–ø—É—Ç—ã–≤–∞—é—Ç—Å—è.

**–û—Ç–≤–µ—Ç:** –ò–º—è Shared Memory –≤–∫–ª—é—á–∞–µ—Ç `terminalId` + Named Mutex –¥–ª—è thread-safety –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö FarCard.

```cpp
// DLL C++: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å terminalId –≤ –∏–º–µ–Ω–∏
std::string sharedMemName = "MaxLoyaltyRKeeperShared_" + gTerminalId;
// –ù–∞–ø—Ä–∏–º–µ—Ä: "MaxLoyaltyRKeeperShared_term001"
gSharedMemory = std::make_unique<SharedMemoryManager>(sharedMemName, 1024 * 1024); // 1MB

// Named Mutex –¥–ª—è thread-safety (FarCard –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å DLL –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤)
std::string mutexName = "MaxLoyaltyMutex_" + gTerminalId;
HANDLE hMutex = CreateMutexA(NULL, FALSE, mutexName.c_str());

// –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ Shared Memory
DWORD waitResult = WaitForSingleObject(hMutex, 5000); // –∂–¥—ë–º max 5 —Å–µ–∫
if (waitResult == WAIT_OBJECT_0) {
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    gSharedMemory->WriteOrderContext(orderId, context);
    ReleaseMutex(hMutex);
} else {
    gLogger->Error("Mutex timeout ‚Äî skipping write to avoid deadlock");
}
```

```csharp
// UI (C# WPF): —á–∏—Ç–∞–µ—Ç –ø–æ —Ç–æ–º—É –∂–µ terminalId
var sharedMemName = $"MaxLoyaltyRKeeperShared_{config.TerminalId}";
_sharedMemory = new SharedMemoryService(sharedMemName, config.TerminalId);
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** Named Mutex –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race condition –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö FarCard callback-–≤—ã–∑–æ–≤–∞—Ö (FarCard –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å DLL –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ). `terminalId` –≤ –∏–º–µ–Ω–∏ = –ø–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –º–µ–∂–¥—É —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º–∏ –Ω–∞ –æ–¥–Ω–æ–π –º–∞—à–∏–Ω–µ.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –ò–º—è Shared Memory = `MaxLoyaltyRKeeperShared_{terminalId}`. Named Mutex = `MaxLoyaltyMutex_{terminalId}`. WaitForSingleObject timeout = 5 —Å–µ–∫ (–∑–∞—â–∏—Ç–∞ –æ—Ç deadlock). UI —á–∏—Ç–∞–µ—Ç –∏–∑ —Ç–æ–π –∂–µ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏ –ø–æ `terminalId` –∏–∑ `config.json`.

***

### Q14 ‚Äî FarCard Timeout 30 —Å–µ–∫

**–í–æ–ø—Ä–æ—Å:** FarCard –≤—ã–∑—ã–≤–∞–µ—Ç `GetCardInfo()` —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ. –¢–µ–∫—É—â–∏–π HTTP timeout = 30 —Å–µ–∫. –ï—Å–ª–∏ backend –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª ‚Äî R-Keeper –∂–¥—ë—Ç 30 —Å–µ–∫. –ö–∞—Å—Å–∞ ¬´–∑–∞–≤–∏—Å–ª–∞¬ª –¥–ª—è –∫–∞—Å—Å–∏—Ä–∞.

**–û—Ç–≤–µ—Ç:** –ñ—ë—Å—Ç–∫–∏–π timeout 5 —Å–µ–∫ –¥–ª—è `GetCardInfo`. –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –∫–æ–¥–∞ `-3` (backend offline). –ö–∞—Å—Å–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É –±–µ–∑ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏.

```cpp
extern "C" __declspec(dllexport) int __stdcall GetCardInfo(
    const char* cardNumber, CardInfo* outInfo) {

    if (!cardNumber || !outInfo) {
        gLogger->Error("GetCardInfo: Invalid parameters");
        return -1; // INVALID_PARAMS
    }

    gLogger->Info("GetCardInfo: %s", MaskCardNumber(cardNumber));

    // –ñ—ë—Å—Ç–∫–∏–π timeout 5 —Å–µ–∫ (–Ω–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–π timeout –∫–ª–∏–µ–Ω—Ç–∞)
    auto savedTimeout = ghttpClient->GetTimeout();
    ghttpClient->SetTimeout(5000); // 5 —Å–µ–∫ –¥–ª—è search

    try {
        std::string searchValue(cardNumber);
        bool isPhone = searchValue.length() >= 10 && searchValue[^7_0] == '7';

        json requestBody;
        if (isPhone) requestBody["phone"] = searchValue;
        else requestBody["code6Digit"] = searchValue;

        auto response = ghttpClient->Post(
            "/api/pos-integration/rkeeper/search-guest",
            requestBody.dump()
        );

        ghttpClient->SetTimeout(savedTimeout); // –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º

        if (response.statusCode == 401) {
            gLogger->Error("GetCardInfo: API Key revoked or invalid");
            return -4; // API_KEY_INVALID
        }

        if (response.statusCode != 200) {
            gLogger->Error("GetCardInfo: Backend returned %d", response.statusCode);
            return -2; // API_ERROR
        }

        auto responseData = json::parse(response.body);
        if (!responseData["found"].get<bool>()) {
            gLogger->Info("GetCardInfo: Guest not found");
            return -1; // NOT_FOUND
        }

        // –ó–∞–ø–æ–ª–Ω—è–µ–º CardInfo —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        auto guest = responseData["guest"];
        ZeroMemory(outInfo, sizeof(CardInfo));
        strncpy_s(outInfo->guestName, 255, guest["name"].get<std::string>().c_str(), _TRUNCATE);
        strncpy_s(outInfo->phone, 31, guest["phone"].get<std::string>().c_str(), _TRUNCATE);
        strncpy_s(outInfo->cardId, 63, guest["cardId"].get<std::string>().c_str(), _TRUNCATE);
        strncpy_s(outInfo->levelName, 127, guest["levelName"].get<std::string>().c_str(), _TRUNCATE);
        outInfo->regularBalance = guest["regularBalance"].get<double>();
        outInfo->promoBalance = guest["promoBalance"].get<double>();
        outInfo->totalBalance = guest["totalBalance"].get<double>();

        return 0; // SUCCESS

    } catch (const TimeoutException&) {
        ghttpClient->SetTimeout(savedTimeout);
        gLogger->Warn("GetCardInfo: Timeout after 5s ‚Äî backend offline");
        gSharedMemory->UpdateBackendStatus(false);
        return -3; // BACKEND_OFFLINE

    } catch (const std::exception& ex) {
        ghttpClient->SetTimeout(savedTimeout);
        gLogger->Error("GetCardInfo exception: %s", ex.what());
        return -2; // API_ERROR
    }
}
```

```csharp
// UI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–¥—ã –≤–æ–∑–≤—Ä–∞—Ç–∞
private async void OnSearchClick() {
    ShowLoading("–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è...");
    int result = DllInterop.GetCardInfo(searchInput, out CardInfo cardInfo);

    switch (result) {
        case 0:   OpenOperationWindow(cardInfo); break;
        case -1:  ShowNotFoundDialog(); break;
        case -2:  ShowError("–û—à–∏–±–∫–∞ API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."); break;
        case -3:
            ShowWarning("–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –õ–æ—è–ª—å–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.");
            // –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º ‚Äî –∫–∞—Å—Å–∏—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –æ–ø–ª–∞—Ç—É –±–µ–∑ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
            this.Close();
            break;
        case -4:  ShowError("API Key –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."); break;
    }
    HideLoading();
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** 30-—Å–µ–∫—É–Ω–¥–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º FarCard –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ = R-Keeper ¬´–∑–∞–≤–∏—Å¬ª –¥–ª—è –∫–∞—Å—Å–∏—Ä–∞ –Ω–∞ –ø–æ–ª–º–∏–Ω—É—Ç—ã. 5 —Å–µ–∫ = —Ä–∞–∑—É–º–Ω—ã–π UX –ø—Ä–µ–¥–µ–ª –¥–ª—è –æ—Ç–≤–µ—Ç–∞ API. –í–æ–∑–≤—Ä–∞—Ç `-3` –≤–º–µ—Å—Ç–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è = R-Keeper –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É –±–µ–∑ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏, –∫–∞—Å—Å–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** Timeout –¥–ª—è `GetCardInfo` / `ReservePoints` = 5 —Å–µ–∫. Timeout –¥–ª—è `FinalizeTransaction` = 10 —Å–µ–∫ (—Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –¥–∞—ë–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏). –ö–æ–¥—ã: `0` (success), `-1` (not found), `-2` (API error), `-3` (timeout/offline), `-4` (key invalid). UI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –∫–æ–¥—ã –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π.

***

### Q15 ‚Äî Floating Button: –£–¥–∞–ª—ë–Ω–Ω—ã–µ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ UI

**–í–æ–ø—Ä–æ—Å:** –ü–æ–∑–∏—Ü–∏—è Floating Button –∑–∞–¥–∞—ë—Ç—Å—è –≤ `config.json` –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ. –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –∏–∑–º–µ–Ω–∏—Ç—å –µ—ë —É–¥–∞–ª—ë–Ω–Ω–æ. –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –≤–∞–∂–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ‚Äî –Ω—É–∂–µ–Ω –≤—ã–µ–∑–¥ —Ç–µ—Ö–Ω–∏–∫–∞.

**–û—Ç–≤–µ—Ç:** UI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ backend. –ü–ª–∞–≥–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ heartbeat response. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.

```typescript
// backend: Admin –º–µ–Ω—è–µ—Ç UI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ Admin Panel
async updateUiSettings(
  installationId: string,
  dto: UpdateUiSettingsDto
): Promise<void> {
  await this.prisma.pluginInstallation.update({
    where: { id: installationId },
    data: {
      uiSettings: {
        floatingButton: {
          position: dto.position,       // TopLeft | TopRight | BottomLeft | BottomRight
          size: dto.size,               // Small | Medium | Large
          opacity: dto.opacity,         // 0.3 ‚Äì 1.0
          edgeGestureEnabled: dto.edgeGestureEnabled,
        },
        sounds: { enabled: dto.soundsEnabled },
        keyboard: { size: dto.keyboardSize },
      },
      configVersion: { increment: 1 }  // –≤–µ—Ä—Å–∏—è –∫–æ–Ω—Ñ–∏–≥–∞ –¥–ª—è dirty-check
    }
  });

  // –°—Ç–∞–≤–∏–º –∫–æ–º–∞–Ω–¥—É –≤ –æ—á–µ—Ä–µ–¥—å ‚Äî –ø–ª–∞–≥–∏–Ω –ø–æ–ª—É—á–∏—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º heartbeat
  await this.prisma.pluginCommand.create({
    data: {
      installationId,
      type: 'RELOAD_CONFIG',
      payload: {},
      status: 'PENDING'
    }
  });
}
```

```csharp
// UI: –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
private void ApplyUiSettings(UiSettings settings) {
    Application.Current.Dispatcher.Invoke(() => {
        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º Floating Button
        var (left, top) = CalculatePosition(
            settings.FloatingButton.Position,
            settings.FloatingButton.Size
        );
        floatingButtonWindow.Left = left;
        floatingButtonWindow.Top = top;

        // –ò–∑–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä
        var size = settings.FloatingButton.Size switch {
            "Small" => 60.0,
            "Large" => 100.0,
            _ => 80.0 // Medium
        };
        floatingButtonWindow.Width = size;
        floatingButtonWindow.Height = size;

        // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
        floatingButtonWindow.Opacity = settings.FloatingButton.Opacity;

        // –ó–≤—É–∫–∏
        soundService.SetEnabled(settings.Sounds.Enabled);

        logger.LogInformation("UI settings applied: Position={Pos}, Size={Size}",
            settings.FloatingButton.Position, settings.FloatingButton.Size);
    });
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** Touch-screen –∫–∞—Å—Å—ã —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –∏–º–µ—é—Ç —Ä–∞–∑–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ R-Keeper –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –û–¥–Ω–∞ –∫–∞—Å—Å–∞ ‚Äî TopRight –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É ¬´–ó–∞–∫—Ä—ã—Ç—å –∑–∞–∫–∞–∑¬ª, –¥—Ä—É–≥–∞—è ‚Äî BottomLeft –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤. –£–¥–∞–ª—ë–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ = Admin –º–µ–Ω—è–µ—Ç –∑–∞ 10 —Å–µ–∫—É–Ω–¥, –≤—Å—Ç—É–ø–∞–µ—Ç –≤ —Å–∏–ª—É –≤ —Ç–µ—á–µ–Ω–∏–µ 60 —Å–µ–∫ (—Å–ª–µ–¥—É—é—â–∏–π heartbeat).

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `uiSettings` JSON –≤ `PluginInstallation` –Ω–∞ backend. Admin –º–µ–Ω—è–µ—Ç —á–µ—Ä–µ–∑ `PATCH /api/admin/plugin-installations/:id/ui-settings`. Backend —Å—Ç–∞–≤–∏—Ç –∫–æ–º–∞–Ω–¥—É `RELOAD_CONFIG` –≤ –æ—á–µ—Ä–µ–¥—å. –ü–ª–∞–≥–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º heartbeat (–¥–æ 60 —Å–µ–∫). `ApplyUiSettings` –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ `Dispatcher.Invoke`.

***

## –ë–õ–û–ö F ‚Äî –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì


***

### Q16 ‚Äî Dashboard –ó–¥–æ—Ä–æ–≤—å—è –ö–∞—Å—Å

**–í–æ–ø—Ä–æ—Å:** `DiagnosticsWindow` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–ª–∞–≥–∏–Ω–∞ (—Ç–æ–ª—å–∫–æ –∫–∞—Å—Å–∏—Ä –≤–∏–¥–∏—Ç). Admin –≤ –≤–µ–±-–ø–∞–Ω–µ–ª–∏ –Ω–µ –≤–∏–¥–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∏ –æ–¥–Ω–æ–π –∫–∞—Å—Å—ã ‚Äî —Å–ª–µ–ø–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥.

**–û—Ç–≤–µ—Ç:** –†–∞–∑–¥–µ–ª ¬´–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ‚Üí –ö–∞—Å—Å—ã¬ª –≤ Admin Panel —Å real-time —Å—Ç–∞—Ç—É—Å–æ–º, –∫–ª—é—á–µ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∏ –∞–ª–µ—Ä—Ç–∞–º–∏.

```typescript
// backend: GET /api/admin/monitoring/pos-health
async getPosHealthDashboard(tenantId: string, restaurantId?: string) {
  const installations = await this.prisma.pluginInstallation.findMany({
    where: { tenantId, ...(restaurantId && { restaurantId }) }
  });

  return installations.map(inst => {
    const lastSeenAgo = differenceInMinutes(new Date(), inst.lastSeenAt);
    const status = lastSeenAgo < 2 ? 'ONLINE'
                 : lastSeenAgo < 10 ? 'WARNING'
                 : 'OFFLINE';

    const latestVersion = getLatestVersion(inst.posSystem);
    const isOutdated = compareVersions(inst.pluginVersion, latestVersion) < 0;

    return {
      installationId: inst.id,
      terminalName: inst.terminalName,
      posSystem: inst.posSystem,
      status,                               // ONLINE | WARNING | OFFLINE
      lastSeenAgo,                          // –≤ –º–∏–Ω—É—Ç–∞—Ö
      pluginVersion: inst.pluginVersion,
      isOutdated,
      latestVersion,
      metrics: inst.lastMetrics,            // –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ heartbeat
      alerts: this.generateAlerts(inst),    // –º–∞—Å—Å–∏–≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤
    };
  });
}

private generateAlerts(inst: PluginInstallation): Alert[] {
  const alerts = [];
  if (inst.lastMetrics?.queueSize > 10)
    alerts.push({ type: 'QUEUE_LARGE', message: `Offline –æ—á–µ—Ä–µ–¥—å: ${inst.lastMetrics.queueSize} –æ–ø–µ—Ä–∞—Ü–∏–π` });
  if (differenceInMinutes(new Date(), inst.lastSeenAt) > 10)
    alerts.push({ type: 'OFFLINE', message: `–ù–µ –±—ã–ª–æ —Å–≤—è–∑–∏ ${differenceInMinutes(new Date(), inst.lastSeenAt)} –º–∏–Ω` });
  if (inst.lastMetrics?.latencyP95 > 1000)
    alerts.push({ type: 'HIGH_LATENCY', message: `P95 latency: ${inst.lastMetrics.latencyP95}ms` });
  return alerts;
}
```

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**

```typescript
// backend: cron –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞—Å—Å
@Cron('* * * * *')
async checkPosHealth() {
  const offlineInsts = await this.prisma.pluginInstallation.findMany({
    where: {
      status: 'ACTIVE',
      lastSeenAt: { lt: subMinutes(new Date(), 10) }, // –æ—Ñ–ª–∞–π–Ω > 10 –º–∏–Ω
      lastOfflineAlertSentAt: {                        // –Ω–µ —Å–ø–∞–º–∏–º ‚Äî —Ä–∞–∑ –≤ —á–∞—Å
        lt: subHours(new Date(), 1)
      }
    }
  });

  for (const inst of offlineInsts) {
    await this.notifications.send({
      to: inst.restaurant.adminEmail,
      template: 'pos-offline-alert',
      data: { terminalName: inst.terminalName, offlineMinutes: 10 }
    });
    await this.prisma.pluginInstallation.update({
      where: { id: inst.id },
      data: { lastOfflineAlertSentAt: new Date() }
    });
  }
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ë–µ–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ Admin Panel —Å–∏—Ç—É–∞—Ü–∏—è: –∫–∞—Å—Å–∞ —É—à–ª–∞ –≤ offline –≤ 10:00, Admin —É–∑–Ω–∞–ª –æ—Ç –≥–æ—Å—Ç—è —á–µ—Ä–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤ 14:00. 4 —á–∞—Å–∞ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. CRON + email-–∞–ª–µ—Ä—Ç = Admin –∑–Ω–∞–µ—Ç —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `GET /api/admin/monitoring/pos-health` ‚Äî –∞–≥—Ä–µ–≥–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∏–∑ `lastSeenAt` heartbeat-–æ–≤. –°—Ç–∞—Ç—É—Å—ã: ONLINE (< 2 –º–∏–Ω) / WARNING (2‚Äì10 –º–∏–Ω) / OFFLINE (> 10 –º–∏–Ω). –ê–ª–µ—Ä—Ç—ã: QUEUE_LARGE (> 10), OFFLINE, HIGH_LATENCY (P95 > 1000ms). Email-–∞–ª–µ—Ä—Ç –ø—Ä–∏ OFFLINE > 10 –º–∏–Ω, –∞–Ω—Ç–∏—Å–ø–∞–º —Ä–∞–∑ –≤ —á–∞—Å.

***

### Q17 ‚Äî –•—Ä–∞–Ω–µ–Ω–∏–µ –ú–µ—Ç—Ä–∏–∫ –ü–ª–∞–≥–∏–Ω–æ–≤

**–í–æ–ø—Ä–æ—Å:** –ú–µ—Ç—Ä–∏–∫–∏ (`loyalty.points.applied`, `loyalty.search.duration_ms` –∏ —Ç.–¥.) –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `POST /metrics`. –ö—É–¥–∞ –æ–Ω–∏ –ø–æ–ø–∞–¥–∞—é—Ç –Ω–∞ backend ‚Äî –≤ –æ—Å–Ω–æ–≤–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ?

**–û—Ç–≤–µ—Ç:** –û—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `plugin_metrics`. –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ Admin Dashboard, –Ω–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ä–∞–∑–¥–µ–ª—å–Ω–æ.

```prisma
model PluginMetric {
  id             String   @id @default(uuid())
  installationId String
  posSystem      POSSystem
  metricName     String   // loyalty.points.applied | loyalty.search.duration_ms | ...
  value          Float
  tags           Json     // { terminalId, restaurantId, tenantId }
  recordedAt     DateTime // –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫–∞—Å—Å–µ
  receivedAt     DateTime @default(now()) // –≤—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è backend

  installation   PluginInstallation @relation(fields: [installationId], references: [id])

  @@index([installationId, metricName, recordedAt])
  @@index([metricName, recordedAt])          // –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø–æ –º–µ—Ç—Ä–∏–∫–µ
  @@index([tags(ops: JsonbPathOps)])         // –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ restaurantId/tenantId
  @@index([recordedAt])                      // –¥–ª—è time-series –∑–∞–ø—Ä–æ—Å–æ–≤
}
```

**–û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Ç—Ä–∏–∫ –ø–∞–∫–µ—Ç–æ–º (–±–∞—Ç—á–∏–Ω–≥):**

```csharp
// –ü–ª–∞–≥–∏–Ω: –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –º–µ—Ç—Ä–∏–∫—É –æ—Ç–¥–µ–ª—å–Ω–æ ‚Äî —Å–æ–±–∏—Ä–∞–µ–º –∑–∞ 30 —Å–µ–∫
private readonly List<MetricPoint> _metricsBuffer = new();
private System.Timers.Timer _metricsFlushTimer;

public void RecordMetric(string name, double value, Dictionary<string, string>? tags = null) {
    lock (_metricsBuffer) {
        _metricsBuffer.Add(new MetricPoint {
            Name = name,
            Value = value,
            Tags = tags,
            Timestamp = DateTime.UtcNow
        });
    }
}

// –§–ª–∞—à–∏–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫ –∏–ª–∏ –ø—Ä–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–∏ 50 —Ç–æ—á–µ–∫
private async Task FlushMetricsAsync() {
    List<MetricPoint> batch;
    lock (_metricsBuffer) {
        if (_metricsBuffer.Count == 0) return;
        batch = new List<MetricPoint>(_metricsBuffer);
        _metricsBuffer.Clear();
    }

    await apiClient.PostMetricsAsync(batch);
    logger.LogDebug("Flushed {Count} metrics to backend", batch.Count);
}
```

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ SLO:**


| –ú–µ—Ç—Ä–∏–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | SLO / –ê–ª–µ—Ä—Ç |
| :-- | :-- | :-- |
| `loyalty.search.duration_ms` | –í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è | P95 < 500ms |
| `loyalty.reserve.duration_ms` | –í—Ä–µ–º—è —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ | P95 < 300ms |
| `loyalty.finalize.duration_ms` | –í—Ä–µ–º—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ | P95 < 500ms |
| `loyalty.error.network` | –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ | < 0.5% –æ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ |
| `loyalty.offline.queue_size` | –†–∞–∑–º–µ—Ä offline –æ—á–µ—Ä–µ–¥–∏ | –ê–ª–µ—Ä—Ç –ø—Ä–∏ > 10 |
| `loyalty.reservation.auto_cancelled` | –ó–∞–≤–∏—Å—à–∏–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ | –ê–ª–µ—Ä—Ç –ø—Ä–∏ > 5/–¥–µ–Ω—å |
| `loyalty.points.applied` | –ë–∞–ª–ª–æ–≤ —Å–ø–∏—Å–∞–Ω–æ | –ë–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ |
| `loyalty.discount.applied` | –°–∫–∏–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ | –ë–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ |
| `loyalty.earn_only.dropped` | EarnOnly –ø–æ—Ç–µ—Ä—è–Ω–æ | –ê–ª–µ—Ä—Ç –ø—Ä–∏ > 0 |

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –û—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ = —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ –∑–∞–≥—Ä—è–∑–Ω—è–µ—Ç –±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫—É (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –±–∞–ª–ª—ã). P95 latency < 500ms = SLO –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞, –ø—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ Admin –ø–æ–ª—É—á–∞–µ—Ç –∞–ª–µ—Ä—Ç.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `PluginMetric` —Ç–∞–±–ª–∏—Ü–∞ —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –ø–æ `(installationId, metricName, recordedAt)`. –ë–∞—Ç—á–∏–Ω–≥: –ø–ª–∞–≥–∏–Ω —Å–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ 30 —Å–µ–∫, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞–∫–µ—Ç–æ–º. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏: 9 –º–µ—Ç—Ä–∏–∫ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –≤—ã—à–µ. SLO: P95 < 500ms –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏. Retention: 90 –¥–Ω–µ–π –¥–ª—è `plugin_metrics`.

***

## –ë–õ–û–ö G ‚Äî UI/UX EDGE CASES


***

### Q18 ‚Äî –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ì–æ—Å—Ç—è –Ω–∞ –ö–∞—Å—Å–µ

**–í–æ–ø—Ä–æ—Å:** –ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ. `create-guest` —ç–Ω–¥–ø–æ–∏–Ω—Ç –µ—Å—Ç—å. –ù–æ —Å–∫–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø—Ä—è–º–æ –Ω–∞ –∫–∞—Å—Å–µ –≤ –æ—á–µ—Ä–µ–¥–∏ ‚Äî —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º—è, –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è?

**–û—Ç–≤–µ—Ç:** –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: —Ç–æ–ª—å–∫–æ —Ç–µ–ª–µ—Ñ–æ–Ω (—É–∂–µ –≤–≤–µ–¥—ë–Ω) + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∏–º—è (–æ–¥–Ω–æ –ø–æ–ª–µ). –û—Å—Ç–∞–ª—å–Ω–æ–µ –≥–æ—Å—Ç—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç –≤ Telegram Bot. –ö–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞ —Å—Ä–∞–∑—É.

```csharp
// iiko plugin: CreateGuestWindow
private async void OnCreateGuestConfirmClick(object sender, RoutedEventArgs e) {
    ShowLoading("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...");

    try {
        var createResponse = await apiClient.CreateGuestAsync(new CreateGuestRequest {
            Phone = _searchPhone,                              // —É–∂–µ –≤–≤–µ–¥—ë–Ω –≤ SearchWindow
            FirstName = FirstNameInput.Text.Trim().NullIfEmpty() // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
        });

        if (!createResponse.Success) {
            HideLoading();
            ShowError(createResponse.Error);
            return;
        }

        // –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –Ω–æ–≤—ã–º –≥–æ—Å—Ç–µ–º
        var guest = new GuestInfo {
            CardId = createResponse.GuestCardId,
            Name = FirstNameInput.Text.Trim().NullIfEmpty() ?? _searchPhone,
            Phone = _searchPhone,
            TotalBalance = 0,
            LevelName = "Bronze" // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å
        };

        HideLoading();
        ShowSuccess($"–ì–æ—Å—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω! –ö–æ–¥ –∫–∞—Ä—Ç—ã: {createResponse.Code6Digit}");

        // –ü–∞—É–∑–∞ 1 —Å–µ–∫ –¥–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è —Å –∫–æ–¥–æ–º, –∑–∞—Ç–µ–º ‚Äî –∫ –æ–ø–µ—Ä–∞—Ü–∏–∏
        await Task.Delay(1000);
        OpenOperationWindow(guest, calculateResponse: null); // calcResponse = null ‚Üí —Ç–æ–ª—å–∫–æ EarnOnly

    } catch (Exception ex) {
        HideLoading();
        HandleError(ex);
    }
}
```

```
FLOW: –ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SearchWindow: "–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –Ω–æ–º–µ—Ä—É 7999..."
              [–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å]  [–û—Ç–º–µ–Ω–∞]

  ‚Üì [–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å]

CreateGuestWindow (–º–∞–ª–µ–Ω—å–∫–æ–µ –æ–∫–Ω–æ):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥–æ—Å—Ç—è                  ‚îÇ
‚îÇ   üì± +7 999 123 45 67               ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ   –ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):               ‚îÇ
‚îÇ   [_________________________]        ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ          [–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å]  [–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

  ‚Üì –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

OperationWindow: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º EarnOnly
  "–ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞. –ö–æ–¥: 123456"
  "–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: 45 –±–∞–ª–ª–æ–≤"
  [‚úì –ù–∞—á–∏—Å–ª–∏—Ç—å]

  ‚Üì –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ ‚Äî Telegram Bot –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—É—à:
  "–í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏!
   –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤ ‚Üí /start"
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ù–∞ –∫–∞—Å—Å–µ –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–µ –º–µ—Å—Ç–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è. –ú–∏–Ω–∏–º—É–º = —Ç–µ–ª–µ—Ñ–æ–Ω (—É–∂–µ –∏–∑–≤–µ—Å—Ç–µ–Ω) + –∏–º—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. Telegram Bot –¥–æ–±–µ—Ä—ë—Ç –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ. –ö–∞—Ä—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è ‚Äî –≥–æ—Å—Ç—å –ø–æ–ª—É—á–∞–µ—Ç –±–∞–ª–ª—ã —Å –ø–µ—Ä–≤–æ–≥–æ –≤–∏–∑–∏—Ç–∞.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `CreateGuestWindow` = 1 –ø–æ–ª–µ ¬´–ò–º—è¬ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) + –∫–Ω–æ–ø–∫–∏ ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª / ¬´–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª. –¢–µ–ª–µ—Ñ–æ–Ω —É–∂–µ –ø–µ—Ä–µ–¥–∞–Ω –∏–∑ `SearchWindow`. `POST /create-guest` —Å `{ phone, firstName? }`. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º `code6Digit` –∫–∞—Å—Å–∏—Ä—É 1 —Å–µ–∫, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ `OperationWindow` –≤ —Ä–µ–∂–∏–º–µ `EarnOnly`. Backend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Telegram push –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

***

### Q19 ‚Äî –ù–µ—Å–∫–æ–ª—å–∫–æ –û—Ç–∫—Ä—ã—Ç—ã—Ö –ó–∞–∫–∞–∑–æ–≤ –≤ R-Keeper

**–í–æ–ø—Ä–æ—Å:** R-Keeper –Ω–∞ –æ–¥–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å—Ç–æ–ª–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. Floating Button –Ω–∞–∂–∞—Ç ‚Äî –¥–ª—è –∫–∞–∫–æ–≥–æ —Å—Ç–æ–ª–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å?

**–û—Ç–≤–µ—Ç:** –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç > 1 –∑–∞–∫–∞–∑ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º `OrderSelectWindow` —Å –≤—ã–±–æ—Ä–æ–º —Å—Ç–æ–ª–∞. –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —Ä–æ–≤–Ω–æ 1 ‚Äî —Å—Ä–∞–∑—É –∫ –ø–æ–∏—Å–∫—É –≥–æ—Å—Ç—è.

```csharp
// R-Keeper UI: FloatingButtonWindow OnClick
private async void OnLoyaltyButtonClick(object sender, RoutedEventArgs e) {
    ShowLoading("–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...");

    try {
        var openOrders = await rkeeperClient.GetOrderListAsync();
        HideLoading();

        if (openOrders.Count == 0) {
            ShowInfo("–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–∫–∞–∑–æ–≤.\n–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç–æ–ª –≤ R-Keeper –∏ –Ω–∞–∂–º–∏—Ç–µ —Å–Ω–æ–≤–∞.");
            return;
        }

        if (openOrders.Count == 1) {
            // –û–¥–∏–Ω –∑–∞–∫–∞–∑ ‚Äî —Å—Ä–∞–∑—É –∫ –ø–æ–∏—Å–∫—É –≥–æ—Å—Ç—è
            OpenGuestSearchWindow(openOrders[^7_0]);
            return;
        }

        // –ù–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–∫–∞–∑–æ–≤ ‚Äî –≤—ã–±–æ—Ä
        var selectWindow = new OrderSelectWindow(openOrders);
        if (selectWindow.ShowDialog() == true && selectWindow.SelectedOrder != null) {
            OpenGuestSearchWindow(selectWindow.SelectedOrder);
        }

    } catch (Exception ex) {
        HideLoading();
        HandleError(ex);
    }
}
```

```xaml
<!-- OrderSelectWindow.xaml -->
<Window Title="–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª" Width="400" Height="500">
  <Grid Margin="20">
    <TextBlock Text="–ö –∫–∞–∫–æ–º—É —Å—Ç–æ–ª—É –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å?"
               FontSize="16" FontWeight="SemiBold" Margin="0,0,0,15"/>

    <ListBox x:Name="OrdersList" SelectionMode="Single">
      <ListBox.ItemTemplate>
        <DataTemplate>
          <Grid Height="60" Margin="5">
            <!-- –°—Ç–æ–ª 5 | 3 –≥–æ—Å—Ç—è | 1,890‚ÇΩ -->
            <TextBlock Text="{Binding DisplayName}" FontSize="18" FontWeight="Bold"/>
            <TextBlock Text="{Binding Amount, StringFormat={}{0:N0}‚ÇΩ}"
                       HorizontalAlignment="Right" FontSize="16"/>
          </Grid>
        </DataTemplate>
      </ListBox.ItemTemplate>
    </ListBox>

    <Button Content="–í—ã–±—Ä–∞—Ç—å" Height="50" FontSize="16"
            IsEnabled="{Binding ElementName=OrdersList, Path=SelectedItem, Converter={...}}"
            Click="OnSelectClick" Margin="0,10,0,0"/>
  </Grid>
</Window>
```

**R-Keeper XML API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤:**

```xml
<RK7Query>
  <RK7CMD CMD="GetOrderList">
    <Filter><Status>OPEN</Status></Filter>
    <!-- –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–∫–∞–∑—ã —Ç–µ–∫—É—â–µ–π —Å—Ç–∞–Ω—Ü–∏–∏ -->
    <Filter><StationId>STATION001</StationId></Filter>
  </RK7CMD>
</RK7Query>
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ë–µ–∑ –≤—ã–±–æ—Ä–∞ –∑–∞–∫–∞–∑–∞ ‚Äî –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –∫ —Å–ª—É—á–∞–π–Ω–æ–º—É —Å—Ç–æ–ª—É (–ø–µ—Ä–≤–æ–º—É –≤ —Å–ø–∏—Å–∫–µ). –§–∏–ª—å—Ç—Ä –ø–æ `StationId` = –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–æ–ª—ã —Ç–µ–∫—É—â–µ–π –∫–∞—Å—Å–æ–≤–æ–π —Å—Ç–∞–Ω—Ü–∏–∏, –Ω–µ —Å–æ—Å–µ–¥–Ω–µ–π.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `GetOrderListAsync()` —Å —Ñ–∏–ª—å—Ç—Ä–æ–º `StationId`. –ï—Å–ª–∏ `count == 0` ‚Äî info-—Å–æ–æ–±—â–µ–Ω–∏–µ. –ï—Å–ª–∏ `count == 1` ‚Äî –ø—Ä—è–º–æ –∫ `GuestSearchWindow`. –ï—Å–ª–∏ `count > 1` ‚Äî `OrderSelectWindow` —Å –≤—ã–±–æ—Ä–æ–º. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º: –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π, —Å—É–º–º–∞ —á–µ–∫–∞.

***

### Q20 ‚Äî –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ö–Ω–æ–ø–∫–∏ –≤ iiko

**–í–æ–ø—Ä–æ—Å:** `operations.RegisterButton(buttonCategory: ButtonCategory.Additions)`. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∏ –∫–∞–∫ —ç—Ç–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ iiko?

**–û—Ç–≤–µ—Ç:** `ButtonCategory.Additions` ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è iiko Front 7.x. –ö–Ω–æ–ø–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è¬ª, –Ω–µ –≤ ¬´–û–ø–ª–∞—Ç–∞¬ª –∏ –Ω–µ –≤ ¬´–°–∫–∏–¥–∫–∏¬ª.

```csharp
// iiko plugin: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
private void RegisterButton() {
    // ButtonCategory.Additions = —Ä–∞–∑–¥–µ–ª –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
    // –ù–µ Payments (—Ç–∞–º —Ç–∏–ø—ã –æ–ø–ª–∞—Ç—ã) –∏ –Ω–µ Discounts (—Ç–∞–º —Å–∫–∏–¥–∫–∏)
    operations.RegisterButton(
        buttonText: "Max Loyalty",
        buttonCategory: ButtonCategory.Additions,
        handler: OnLoyaltyButtonClick,
        icon: LoadPluginIcon("MLIcon.png"),
        tooltip: "–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ Max Loyalty"
    );

    logger.LogInformation(
        "Button registered in ButtonCategory.Additions, iiko version: {Version}",
        GetIikoVersion()
    );
}
```

**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ iiko (–≤–∫–ª—é—á–∞–µ–º –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é):**

```markdown
## –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ Max Loyalty –≤ iiko Front

–ö–Ω–æ–ø–∫–∞ "Max Loyalty" –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ **"–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è"** –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∑–∞–∫–∞–∑–∞.

### –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ –ø–æ—è–≤–∏–ª–∞—Å—å –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–ª–∞–≥–∏–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –≤ –ø–∞–ø–∫–µ `{–ø—É—Ç—å –∫ iiko}\Plugins\` 
   –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ñ–∞–π–ª `MaxLoyaltyIikoPlugin.dll`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ iiko Front –ø–æ–ª–Ω–æ—Å—Ç—å—é (–Ω–µ –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ)
3. –û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±–æ–π –∑–∞–∫–∞–∑ ‚Üí –Ω–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª **"–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è"** (Additions)
4. –ö–Ω–æ–ø–∫–∞ **"Max Loyalty"** –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–∞–º

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏:
- iiko Back Office ‚Üí –≠–∫—Ä–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã ‚Üí –î–æ–±–∞–≤–ª–µ–Ω–∏—è
<span style="display:none">[^7_1][^7_2]</span>

<div align="center">‚ÅÇ</div>

[^7_1]: Plagin-iiko.md
[^7_2]: Plagin-r-kepper.md

---

# –ö–∞–∂–µ—Ç—Å—è —Ç—ã –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª

–ü—Ä–æ–¥–æ–ª–∂–∞—é —Å Q20 (–¥–æ–ø–∏—Å—ã–≤–∞—é) –∏ –¥–∞–ª—å—à–µ –¥–æ Q25.

***

### Q20 ‚Äî –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ö–Ω–æ–ø–∫–∏ –≤ iiko (–æ–∫–æ–Ω—á–∞–Ω–∏–µ)

```markdown
### –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–µ –≤ —Ç–æ–º –º–µ—Å—Ç–µ:
–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî ButtonCategory.Additions = —Ä–∞–∑–¥–µ–ª "–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è".
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞—Å—Å–∏—Ä –∏—â–µ—Ç –∫–Ω–æ–ø–∫—É –∏–º–µ–Ω–Ω–æ —Ç–∞–º, –∞ –Ω–µ –≤ "–û–ø–ª–∞—Ç–µ" –∏–ª–∏ "–°–∫–∏–¥–∫–∞—Ö".

### –ü–æ—á–µ–º—É Additions, –∞ –Ω–µ Payments?
- Payments = —Ç–∏–ø—ã –æ–ø–ª–∞—Ç—ã (–Ω–∞–ª–∏—á–Ω—ã–µ, –∫–∞—Ä—Ç–∞, –±–µ–∑–Ω–∞–ª)
- Discounts = —Å–∫–∏–¥–∫–∏ –±–µ–∑ –≤–Ω–µ—à–Ω–µ–π –ª–æ–≥–∏–∫–∏
- Additions = –∫–∞—Å—Ç–æ–º–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —Å –≤–Ω–µ—à–Ω–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π ‚Üê MAX LOYALTY –∑–¥–µ—Å—å
```

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `ButtonCategory.Additions` ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ iiko –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ `README.txt` –≤–Ω—É—Ç—Ä–∏ installer'–∞. iiko Back Office –ø—É—Ç—å: –≠–∫—Ä–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã ‚Üí –î–æ–ø–æ–ª–Ω–µ–Ω–∏—è ‚Üí –∫–Ω–æ–ø–∫–∞ ¬´Max Loyalty¬ª –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–∞–º. –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ iiko Front.

***

## –ë–õ–û–ö H ‚Äî BACKEND –ò DB


***

### Q21 ‚Äî –ï–¥–∏–Ω–∞—è –¢–∞–±–ª–∏—Ü–∞ –†–µ–∑–µ—Ä–≤–∞—Ü–∏–π

**–í–æ–ø—Ä–æ—Å:** –£ iiko –∏ R-Keeper –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã reserve/finalize. –ù—É–∂–Ω—ã –ª–∏ –¥–≤–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã `IikoPointsReservation` –∏ `RKeeperPointsReservation` ‚Äî –∏–ª–∏ –æ–¥–Ω–∞ –æ–±—â–∞—è?

**–û—Ç–≤–µ—Ç:** –ï–¥–∏–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `PointsReservation` —Å –ø–æ–ª–µ–º `posSystem`. –í—Å—è –ª–æ–≥–∏–∫–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π –æ–¥–∏–Ω–∞–∫–æ–≤–∞ ‚Äî —Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–µ—Ç —Å–º—ã—Å–ª–∞.

```prisma
model PointsReservation {
  id              String            @id @default(uuid())
  guestCardId     String
  orderId         String            // posOrderId –∏–∑ iiko/R-Keeper
  splitGroupId    String?           // –¥–ª—è split bill (Q5)
  posSystem       POSSystem         // IIKO | RKEEPER
  installationId  String            // –∫ –∫–∞–∫–æ–π –∫–∞—Å—Å–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞
  restaurantId    String

  benefitType     BenefitType       // POINTS | DISCOUNT
  amount          Decimal           @db.Decimal(10, 2)  // –±–∞–ª–ª–æ–≤ –∫ —Å–ø–∏—Å–∞–Ω–∏—é
  discountPercent Decimal?          @db.Decimal(5, 2)   // % —Å–∫–∏–¥–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è DISCOUNT)
  discountAmount  Decimal?          @db.Decimal(10, 2)  // —Å—É–º–º–∞ —Å–∫–∏–¥–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è DISCOUNT)
  pointsToEarn    Decimal?          @db.Decimal(10, 2)  // —Å–∫–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
  action          String?           // SPEND | EARN_ONLY

  status          ReservationStatus // ACTIVE | FINALIZED | CANCELLED | EXPIRED | AUTO_CANCELLED
  idempotencyKey  String            @unique

  expiresAt       DateTime          // +30 –º–∏–Ω –æ—Ç createdAt
  gracePeriodEnd  DateTime          // +90 –º–∏–Ω –æ—Ç createdAt (expiresAt + 60 –º–∏–Ω grace)

  createdAt       DateTime          @default(now())
  finalizedAt     DateTime?
  cancelledAt     DateTime?
  cancelReason    String?           // USER_UNBIND | AUTO_CLEANUP | SPLIT_CONFLICT
  linkedTxId      String?           // ID —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ—Å–ª–µ finalize

  guestCard       LoyaltyCard        @relation(fields: [guestCardId], references: [id])
  installation    PluginInstallation @relation(fields: [installationId], references: [id])

  @@index([guestCardId, status])
  @@index([expiresAt, status])           // –¥–ª—è CRON cleanup (Q2)
  @@index([orderId, posSystem])          // –ø–æ–∏—Å–∫ –ø–æ orderId
  @@index([idempotencyKey])              // –¥–ª—è idempotency check (Q7)
  @@index([splitGroupId, status])        // –¥–ª—è split bill check (Q5)
  @@index([installationId, createdAt])   // –¥–ª—è Admin Panel –º–µ—Ç—Ä–∏–∫ (Q8)
}

enum ReservationStatus {
  ACTIVE
  FINALIZED
  CANCELLED
  EXPIRED
  AUTO_CANCELLED   // CRON cleanup (Q2)
}

enum POSSystem {
  IIKO
  RKEEPER
}

enum BenefitType {
  POINTS
  DISCOUNT
}
```

**–ï–¥–∏–Ω–∞—è —Å—Ö–µ–º–∞ `PluginInstallation` (–æ–±–∞ POS):**

```prisma
model PluginInstallation {
  id             String    @id @default(uuid())
  tenantId       String
  restaurantId   String
  posSystem      POSSystem              // IIKO | RKEEPER
  terminalName   String
  terminalId     String?                // R-Keeper station ID
  stationId      String?                // R-Keeper station ID
  xmlApiUrl      String?                // —Ç–æ–ª—å–∫–æ R-Keeper
  apiKey         String                 // z–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á –≤ –ë–î
  apiKeyPrefix   String                 // ilk_ –∏–ª–∏ rkl_ ‚Äî –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
  machineId      String?                // –ø–æ—Å–ª–µ first-connect
  status         InstallationStatus    // PENDING_INSTALLATION | ACTIVE | REVOKED | DELETED
  pluginVersion  String?
  osVersion      String?

  // Heartbeat –¥–∞–Ω–Ω—ã–µ (Q9)
  lastSeenAt     DateTime?
  lastMetrics    Json?

  // UI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (Q15)
  uiSettings     Json?
  configVersion  Int       @default(1)

  // Revoke (Q24)
  revokedAt      DateTime?
  revokeReason   String?
  revokeGraceUntil DateTime?
  lastOfflineAlertSentAt DateTime?  // –∞–Ω—Ç–∏—Å–ø–∞–º (Q16)

  createdAt      DateTime  @default(now())
  createdBy      String

  reservations   PointsReservation[]
  metrics        PluginMetric[]
  commands       PluginCommand[]

  @@index([tenantId, restaurantId])
  @@index([apiKey])                    // –±—ã—Å—Ç—Ä—ã–π lookup –ø–æ –∫–ª—é—á—É
  @@index([lastSeenAt])                // –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Q16)
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ï–¥–∏–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ = –æ–¥–∏–Ω CRON cleanup, –æ–¥–Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –æ–¥–∏–Ω API. –ü–æ–ª–µ `posSystem` –¥–∞—ë—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Ç–∏–ø—É POS. –ï—Å–ª–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ä–∞–∑–æ–π–¥—ë—Ç—Å—è –≤ –±—É–¥—É—â–µ–º ‚Äî –º–∏–≥—Ä–∏—Ä—É–µ–º, –Ω–æ –¥–æ —ç—Ç–æ–≥–æ –¥–µ—Ä–∂–∏–º YAGNI.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –ï–¥–∏–Ω–∞—è `PointsReservation` + –µ–¥–∏–Ω–∞—è `PluginInstallation`. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è R-Keeper: `xmlApiUrl`, `stationId`, `terminalId`. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –ª–æ–≥–∏–∫–∏ Q2/Q5/Q7/Q15/Q16/Q24 ‚Äî –≤—Å–µ –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ. –î–≤–∞ enum: `POSSystem` (IIKO | RKEEPER), `ReservationStatus` (5 —Å—Ç–∞—Ç—É—Å–æ–≤).

***

### Q22 ‚Äî Plugin Version Management

**–í–æ–ø—Ä–æ—Å:** `GET /api/pos-integration/iiko/latest-version` –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å `downloadUrl` —Å installer'–æ–º. –û—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è URL? –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –±–∏–Ω–∞—Ä–Ω–∏–∫–∏ –≤–µ—Ä—Å–∏–π?

**–û—Ç–≤–µ—Ç:** –ë–∏–Ω–∞—Ä–Ω–∏–∫–∏ –≤ Cloudflare R2. –¢–∞–±–ª–∏—Ü–∞ `PluginVersion` —É–ø—Ä–∞–≤–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏. –ö–∞—Å—Ç–æ–º–Ω—ã–π installer per-installation –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ª–µ—Ç—É –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Å presigned URL (TTL 1 —á–∞—Å).

```prisma
model PluginVersion {
  id               String    @id @default(uuid())
  platform         POSSystem               // IIKO | RKEEPER
  version          String                  // "1.2.0" semver
  isActive         Boolean   @default(true)
  isCritical       Boolean   @default(false)
  criticalReason   String?

  // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
  minPosVersion    String?   // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è iiko/R-Keeper –¥–ª—è —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –ø–ª–∞–≥–∏–Ω–∞
  maxPosVersion    String?   // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è iiko/R-Keeper

  // R2 –∫–ª—é—á–∏
  dllR2Key         String    // plugins/iiko/v1.2.0/MaxLoyaltyIikoPlugin.dll
  installerTemplateR2Key String  // plugins/iiko/v1.2.0/MaxLoyaltyInstallerTemplate.exe

  changeLog        String
  sizeBytes        Int
  sha256Hash       String    // –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

  releasedAt       DateTime  @default(now())
  releasedBy       String    // adminUserId

  @@unique([platform, version])
  @@index([platform, isActive, releasedAt])
}
```

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ installer'–∞ per-installation:**

```typescript
// backend: GET /api/pos-integration/iiko/latest-version
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç presigned URL –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω—ã–π installer
async getLatestVersion(installation: PluginInstallation) {
  const latestVersion = await this.prisma.pluginVersion.findFirst({
    where: { platform: 'IIKO', isActive: true },
    orderBy: { releasedAt: 'desc' }
  });

  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π installer —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å
  // (–æ–±—ã—á–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
  return {
    currentVersion: installation.pluginVersion,
    latestVersion: latestVersion.version,
    isCritical: latestVersion.isCritical,
    criticalReason: latestVersion.criticalReason,
    changeLog: latestVersion.changeLog,
    sizeBytes: latestVersion.sizeBytes,
    sha256Hash: latestVersion.sha256Hash,
    needsUpdate: compareVersions(installation.pluginVersion, latestVersion.version) < 0,
    // downloadUrl –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
    downloadUrl: null
  };
}

// backend: POST /api/pos-integration/iiko/generate-download-url
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–∞–ª—å–Ω–æ —Ö–æ—á–µ—Ç —Å–∫–∞—á–∞—Ç—å
async generateDownloadUrl(installationId: string) {
  const installation = await this.prisma.pluginInstallation.findUnique({
    where: { id: installationId }
  });
  const latestVersion = await this.getActiveVersion('IIKO');

  // –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º manifest –≤ installer template
  const templateBuffer = await this.r2.getObject(latestVersion.installerTemplateR2Key);
  const manifest = this.buildManifest(installation, latestVersion);
  const customInstallerBuffer = await this.installerBuilder.embed(templateBuffer, manifest);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ R2 –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª (TTL 1 —á–∞—Å)
  const tempKey = `temp/installers/${installationId}_${Date.now()}.exe`;
  await this.r2.putObject(tempKey, customInstallerBuffer);

  // Presigned URL ‚Äî –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 1 —á–∞—Å
  const downloadUrl = await this.r2.getSignedUrl(tempKey, { expiresIn: 3600 });

  // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —á–µ—Ä–µ–∑ 1 —á–∞—Å (lifecycle rule –≤ R2)
  return { downloadUrl, expiresAt: addHours(new Date(), 1) };
}
```

**CI/CD pipeline –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏:**

```
GitHub Actions ‚Üí Build ‚Üí Test ‚Üí 
  ‚Üí Upload DLL/EXE to R2 (plugins/iiko/v{version}/)
  ‚Üí POST /api/admin/plugin-versions (—Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ –ë–î)
  ‚Üí Admin –≤ –ø–∞–Ω–µ–ª–∏ —Å—Ç–∞–≤–∏—Ç isCritical true/false
  ‚Üí –ü–ª–∞–≥–∏–Ω—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–ª–µ–¥—É—é—â–∏–π heartbeat
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** Presigned URL TTL 1 —á–∞—Å = installer –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è, API Key –≤ manifest –Ω–µ —É—Ç–µ—á—ë—Ç –∏–∑ R2. –ö–∞—Å—Ç–æ–º–Ω—ã–π installer per-installation = –∫–∞–∂–¥–∞—è –∫–∞—Å—Å–∞ –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π installer —Å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º API Key. –®–∞–±–ª–æ–Ω –æ–¥–∏–Ω –æ–±—â–∏–π ‚Äî –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –≤ manifest.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `PluginVersion` —Ç–∞–±–ª–∏—Ü–∞ + Cloudflare R2 –¥–ª—è –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤. `GET /latest-version` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –±–µ–∑ URL. `POST /generate-download-url` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç presigned URL (TTL 1—á) –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω—ã–π installer per-installation. Manifest –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ installer template –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏. CI/CD: GitHub Actions ‚Üí R2 upload ‚Üí `POST /api/admin/plugin-versions`.

***

### Q23 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ NestJS: DRY –¥–ª—è iiko –∏ R-Keeper

**–í–æ–ø—Ä–æ—Å:** –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã `/pos-integration/iiko/*` –∏ `/pos-integration/rkeeper/*` –¥—É–±–ª–∏—Ä—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (search-guest, calculate, reserve, finalize). –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–ø–∏–ø–∞—Å—Ç—ã?

**–û—Ç–≤–µ—Ç:** –û–±—â–∏–π `PosIntegrationService` —Å–æ –≤—Å–µ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π. –¢–æ–Ω–∫–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã —Ç–æ–ª—å–∫–æ –¥–ª—è routing –∏ auth. `PluginAuthGuard` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ø–ª–∞–≥–∏–Ω–∞ –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É API Key.

```typescript
// ‚îÄ‚îÄ‚îÄ –û–±—â–∏–π —Å–µ—Ä–≤–∏—Å (–≤—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@Injectable()
export class PosIntegrationService {

  async searchGuest(dto: SearchGuestDto, installation: PluginInstallation) {
    // –ï–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ ‚Äî –æ–¥–∏–Ω–∞–∫–æ–≤–∞ –¥–ª—è iiko –∏ R-Keeper
    const guest = dto.phone
      ? await this.guestService.findByPhone(dto.phone, installation.restaurantId)
      : await this.guestService.findByCode6(dto.code6Digit, installation.restaurantId);

    if (!guest) return { found: false };
    return { found: true, guest: this.mapToGuestInfo(guest) };
  }

  async calculate(dto: CalculateDto, installation: PluginInstallation) {
    // –ï–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –ª—å–≥–æ—Ç
    return this.loyaltyCalculator.calculate(dto, installation.restaurantId);
  }

  async reservePoints(dto: ReservePointsDto, installation: PluginInstallation) {
    // –ï–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ (—Å idempotency, split check –∏–∑ Q5/Q7)
    return this.reservationService.reserve(dto, installation);
  }

  async finalizePoints(dto: FinalizePointsDto, installation: PluginInstallation) {
    return this.reservationService.finalize(dto, installation);
  }

  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
}

// ‚îÄ‚îÄ‚îÄ –¢–æ–Ω–∫–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã (—Ç–æ–ª—å–∫–æ routing) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@Controller('pos-integration/iiko')
@UseGuards(PluginAuthGuard)                 // Guard –ø—Ä–æ–≤–µ—Ä—è–µ—Ç ilk_ –ø—Ä–µ—Ñ–∏–∫—Å
export class IikoController {
  constructor(private readonly posService: PosIntegrationService) {}

  @Post('search-guest')
  searchGuest(@Body() dto: SearchGuestDto, @Installation() inst: PluginInstallation) {
    return this.posService.searchGuest(dto, inst);
  }

  @Post('reserve-points')
  reservePoints(@Body() dto: ReservePointsDto, @Installation() inst: PluginInstallation) {
    return this.posService.reservePoints(dto, inst);
  }

  @Post('finalize-points')
  finalizePoints(@Body() dto: FinalizePointsDto, @Installation() inst: PluginInstallation) {
    return this.posService.finalizePoints(dto, inst);
  }
  // ... +6 –º–µ—Ç–æ–¥–æ–≤
}

@Controller('pos-integration/rkeeper')
@UseGuards(PluginAuthGuard)                 // Guard –ø—Ä–æ–≤–µ—Ä—è–µ—Ç rkl_ –ø—Ä–µ—Ñ–∏–∫—Å
export class RKeeperController {
  constructor(private readonly posService: PosIntegrationService) {}

  @Post('search-guest')
  searchGuest(@Body() dto: SearchGuestDto, @Installation() inst: PluginInstallation) {
    return this.posService.searchGuest(dto, inst);  // ‚Üê —Ç–æ—Ç –∂–µ —Å–µ—Ä–≤–∏—Å!
  }
  // ... –≤—Å–µ –º–µ—Ç–æ–¥—ã –¥–µ–ª–µ–≥–∏—Ä—É—é—Ç –≤ posService
}
```

**`PluginAuthGuard` ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ø–ª–∞–≥–∏–Ω–∞ –ø–æ API Key:**

```typescript
@Injectable()
export class PluginAuthGuard implements CanActivate {
  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const apiKey = request.headers['x-api-key'] as string;

    if (!apiKey) throw new UnauthorizedException('Missing X-API-Key header');

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É
    const posSystem: POSSystem = apiKey.startsWith('ilk_')  ? POSSystem.IIKO
                                : apiKey.startsWith('rkl_')  ? POSSystem.RKEEPER
                                : null;

    if (!posSystem) throw new UnauthorizedException('Invalid API Key format');

    // –ù–∞—Ö–æ–¥–∏–º installation –≤ –ë–î
    const installation = await this.prisma.pluginInstallation.findFirst({
      where: { apiKey, posSystem, status: 'ACTIVE' }
    });

    if (!installation) throw new UnauthorizedException('Invalid or revoked API Key');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º grace period –¥–ª—è revoked –∫–ª—é—á–µ–π (Q24)
    if (installation.status === 'REVOKED') {
      if (!installation.revokeGraceUntil || new Date() > installation.revokeGraceUntil) {
        throw new UnauthorizedException('API Key revoked');
      }
      // –í–Ω—É—Ç—Ä–∏ grace window ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º, –Ω–æ –ª–æ–≥–∏—Ä—É–µ–º
      this.logger.warn('Request within revoke grace period', { installationId: installation.id });
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º lastSeenAt (–Ω–µ —á–µ—Ä–µ–∑ heartbeat)
    // await this.prisma... ‚Äî –ù–ï –¥–µ–ª–∞–µ–º –∑–¥–µ—Å—å, —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ, —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ heartbeat

    request.installation = installation;
    return true;
  }
}

// Custom decorator –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è installation –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö
export const Installation = createParamDecorator(
  (data: unknown, ctx: ExecutionContext): PluginInstallation => {
    const request = ctx.switchToHttp().getRequest();
    return request.installation;
  }
);
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** DRY = –≤—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ. –¢–æ–Ω–∫–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã = —Ç–æ–ª—å–∫–æ routing + auth. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏ finalize ‚Äî –ø—Ä–∞–≤–∏–º –≤ –æ–¥–Ω–æ–º `PosIntegrationService`, –Ω–µ –≤ –¥–≤—É—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö. `@Installation()` –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä = —á–∏—Å—Ç—ã–π, —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º —Ç–µ–∫—É—â–µ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `PosIntegrationService` ‚Äî –≤—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞. `IikoController` –∏ `RKeeperController` ‚Äî —Ç–æ–ª—å–∫–æ routing, –¥–µ–ª–µ–≥–∏—Ä—É—é—Ç –≤ —Å–µ—Ä–≤–∏—Å. `PluginAuthGuard` ‚Äî –µ–¥–∏–Ω—ã–π guard, –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `posSystem` –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É –∫–ª—é—á–∞ (`ilk_` / `rkl_`). Custom decorator `@Installation()` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö. –û—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏: `IikoModule` –∏ `RKeeperModule`, –æ–±–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç `PosIntegrationModule`.

***

## –ë–õ–û–ö I ‚Äî –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨


***

### Q24 ‚Äî Revoke API Key: Grace Period

**–í–æ–ø—Ä–æ—Å:** –ü—Ä–∏ revoke –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏ ‚Äî –ø–ª–∞–≥–∏–Ω –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç —Ä–∞–±–æ—Ç–∞—Ç—å. –ï—Å–ª–∏ revoke –ø—Ä–æ–∏–∑–æ—à—ë–ª –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞ ‚Äî –∫–∞—Å—Å–∏—Ä —Ç–µ—Ä—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é. –ö–∞–∫ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ UX?

**–û—Ç–≤–µ—Ç:** Grace period –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–∏—á–∏–Ω—ã revoke. Security incidents ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ, –ø–ª–∞–Ω–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è ‚Äî —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π.

```typescript
// backend: POST /api/admin/plugin-installations/:id/revoke
enum RevokeReason {
  SUSPICIOUS_ACTIVITY = 'SUSPICIOUS_ACTIVITY',  // –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
  KEY_COMPROMISED     = 'KEY_COMPROMISED',       // –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
  HARDWARE_CHANGE     = 'HARDWARE_CHANGE',       // 30 –º–∏–Ω (–ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
  PLANNED_ROTATION    = 'PLANNED_ROTATION',      // 120 –º–∏–Ω (–ø–ª–∞–Ω–æ–≤–∞—è —Ä–æ—Ç–∞—Ü–∏—è)
  RESTAURANT_CLOSED   = 'RESTAURANT_CLOSED',     // 30 –º–∏–Ω
  MANUAL              = 'MANUAL',                // 30 –º–∏–Ω (default)
}

const GRACE_PERIODS: Record<RevokeReason, number> = {
  SUSPICIOUS_ACTIVITY:  0,    // –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ
  KEY_COMPROMISED:      0,    // –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
  HARDWARE_CHANGE:      30,   // –º–∏–Ω—É—Ç ‚Äî –≤—Ä–µ–º—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–≥–∏–Ω
  PLANNED_ROTATION:     120,  // –º–∏–Ω—É—Ç ‚Äî 2 —á–∞—Å–∞ –Ω–∞ —Å–ø–æ–∫–æ–π–Ω—É—é –∑–∞–º–µ–Ω—É
  RESTAURANT_CLOSED:    30,   // –º–∏–Ω—É—Ç
  MANUAL:               30,   // –º–∏–Ω—É—Ç ‚Äî default
};

async revokeInstallation(
  id: string,
  reason: RevokeReason,
  adminId: string,
  comment?: string
) {
  const gracePeriodMinutes = GRACE_PERIODS[reason];
  const now = new Date();

  await this.prisma.$transaction(async (tx) => {
    await tx.pluginInstallation.update({
      where: { id },
      data: {
        status: gracePeriodMinutes === 0 ? 'REVOKED' : 'REVOKING', // –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        revokedAt: gracePeriodMinutes === 0 ? now : null,
        revokeScheduledAt: now,
        revokeEffectiveAt: addMinutes(now, gracePeriodMinutes),
        revokeGraceUntil: addMinutes(now, gracePeriodMinutes),
        revokeReason: reason,
        revokeComment: comment,
        revokedBy: adminId,
      }
    });

    // –ê—É–¥–∏—Ç –ª–æ–≥
    await tx.auditLog.create({
      data: {
        type: 'PLUGIN_REVOKE_INITIATED',
        adminId,
        targetId: id,
        metadata: { reason, gracePeriodMinutes, comment }
      }
    });
  });

  // CRON –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –ø–µ—Ä–µ–≤–æ–¥–∏—Ç REVOKING ‚Üí REVOKED –ø–æ—Å–ª–µ grace period
  // (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ CleanupService)

  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ Admin
  await this.notifications.sendAdminAlert({
    type: 'PLUGIN_REVOKE',
    message: `Installation ${id} revoked. Reason: ${reason}. Grace: ${gracePeriodMinutes} min.`,
    urgency: gracePeriodMinutes === 0 ? 'HIGH' : 'NORMAL'
  });
}
```

**`PluginAuthGuard` –ø—Ä–∏ REVOKING —Å—Ç–∞—Ç—É—Å–µ:**

```typescript
// –í Guard (Q23) ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ grace period
if (installation.status === 'REVOKING') {
  const isWithinGrace = new Date() < installation.revokeGraceUntil;
  if (!isWithinGrace) {
    // Grace –∏—Å—Ç—ë–∫ ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º revoke
    await this.prisma.pluginInstallation.update({
      where: { id: installation.id },
      data: { status: 'REVOKED', revokedAt: new Date() }
    });
    throw new UnauthorizedException('API Key revoked');
  }
  // –í–Ω—É—Ç—Ä–∏ grace window ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å, –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
  this.logger.warn('Request from REVOKING installation within grace', {
    installationId: installation.id,
    graceExpiresAt: installation.revokeGraceUntil
  });
}
```

**–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ grace periods:**


| –ü—Ä–∏—á–∏–Ω–∞ | Grace | –°—Ü–µ–Ω–∞—Ä–∏–π |
| :-- | :-- | :-- |
| `SUSPICIOUS_ACTIVITY` | 0 –º–∏–Ω | –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ |
| `KEY_COMPROMISED` | 0 –º–∏–Ω | –ö–ª—é—á –ø–æ–ø–∞–ª –≤ –æ—Ç–∫—Ä—ã—Ç—ã–π –¥–æ—Å—Ç—É–ø |
| `HARDWARE_CHANGE` | 30 –º–∏–Ω | –°–º–µ–Ω–∞ –∂–µ–ª–µ–∑–∞ ‚Äî –≤—Ä–µ–º—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–≥–∏–Ω |
| `RESTAURANT_CLOSED` | 30 –º–∏–Ω | –†–µ—Å—Ç–æ—Ä–∞–Ω –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è |
| `MANUAL` | 30 –º–∏–Ω | Default |
| `PLANNED_ROTATION` | 120 –º–∏–Ω | –ü–ª–∞–Ω–æ–≤–∞—è —Ä–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π ‚Äî 2 —á–∞—Å–∞ –Ω–∞ –∑–∞–º–µ–Ω—É |

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π revoke –ø—Ä–∏ –ø–ª–∞–Ω–æ–≤–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ = –∫–∞—Å—Å–∏—Ä —Ç–µ—Ä—è–µ—Ç –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –±–∞–Ω–∫–µ—Ç–∞. 2-—á–∞—Å–æ–≤–æ–π grace = –∫–∞—Å—Å–∏—Ä —Å–ø–æ–∫–æ–π–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∑–∞–∫–∞–∑—ã, Admin —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π –ø–ª–∞–≥–∏–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ. –ü—Ä–∏ `SUSPICIOUS_ACTIVITY` ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ UX.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å `REVOKING` —Å `revokeGraceUntil`. `PluginAuthGuard` –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –≤ grace window (—Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º). CRON –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –ø–µ—Ä–µ–≤–æ–¥–∏—Ç `REVOKING ‚Üí REVOKED` –ø–æ—Å–ª–µ grace. Grace period: 0 –º–∏–Ω (security), 30 –º–∏–Ω (default/hardware/closed), 120 –º–∏–Ω (planned rotation).

***

### Q25 ‚Äî Remote Logs: –£–¥–∞–ª—ë–Ω–Ω—ã–π —Å–±–æ—Ä –ª–æ–≥–æ–≤ –∏–∑ Admin Panel

**–í–æ–ø—Ä–æ—Å:** Serilog –ø–∏—à–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –∫–∞—Å—Å–µ. –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–µ Support –¥–æ–ª–∂–µ–Ω —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –∏–¥—Ç–∏ –∫ —Ç–µ—Ä–º–∏–Ω–∞–ª—É –∏–ª–∏ –ø—Ä–æ—Å–∏—Ç—å –∫–∞—Å—Å–∏—Ä–∞ –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Ñ–∞–π–ª—ã –≤—Ä—É—á–Ω—É—é. –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å remote log collection?

**–û—Ç–≤–µ—Ç:** Admin –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–ó–∞–ø—Ä–æ—Å–∏—Ç—å –ª–æ–≥–∏¬ª ‚Üí backend —Å—Ç–∞–≤–∏—Ç –∫–æ–º–∞–Ω–¥—É `REQUEST_LOGS` ‚Üí –ø–ª–∞–≥–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç –µ—ë –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º heartbeat ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å—Ç—Ä–æ–∫ ‚Üí Admin –≤–∏–¥–∏—Ç –≤ –ø–∞–Ω–µ–ª–∏.

```typescript
// ‚îÄ‚îÄ‚îÄ Admin Panel: –∑–∞–ø—Ä–æ—Å –ª–æ–≥–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// POST /api/admin/plugin-installations/:id/request-logs
async requestLogs(installationId: string, options: RequestLogsOptions) {
  // –°–æ–∑–¥–∞—ë–º –∫–æ–º–∞–Ω–¥—É –≤ –æ—á–µ—Ä–µ–¥–∏ (–ø–ª–∞–≥–∏–Ω –ø–æ–ª—É—á–∏—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º heartbeat)
  const command = await this.prisma.pluginCommand.create({
    data: {
      installationId,
      type: 'REQUEST_LOGS',
      status: 'PENDING',
      payload: {
        date: options.date ?? new Date().toISOString().split('T')[^8_0], // —Å–µ–≥–æ–¥–Ω—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        maxLines: options.maxLines ?? 1000,
        minLevel: options.minLevel ?? 'Warning',  // Warning | Error | Information
        requestId: generateUuid()
      }
    }
  });

  return {
    requestId: command.id,
    status: 'PENDING',
    message: 'Logs will be available within 60‚Äì90 seconds (next heartbeat)',
    estimatedReadyAt: addSeconds(new Date(), 90)
  };
}

// POST /api/pos-integration/upload-logs (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–ª–∞–≥–∏–Ω–æ–º)
async uploadLogs(dto: UploadLogsDto, installation: PluginInstallation) {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥ –≤ –ë–î (–∏–ª–∏ R2 –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤)
  await this.prisma.pluginLog.create({
    data: {
      installationId: installation.id,
      commandId: dto.commandId,
      logDate: dto.logDate,
      content: dto.content,               // —Ç–µ–∫—Å—Ç –ª–æ–≥–∞ (–¥–æ 1000 —Å—Ç—Ä–æ–∫)
      lineCount: dto.lineCount,
      pluginVersion: dto.pluginVersion,
      uploadedAt: new Date()
    }
  });

  // –ü–æ–º–µ—á–∞–µ–º –∫–æ–º–∞–Ω–¥—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é
  await this.prisma.pluginCommand.update({
    where: { id: dto.commandId },
    data: { status: 'COMPLETED', completedAt: new Date() }
  });
}

// GET /api/admin/plugin-installations/:id/logs?commandId=xxx
async getLogs(installationId: string, commandId: string) {
  const log = await this.prisma.pluginLog.findFirst({
    where: { installationId, commandId }
  });
  if (!log) return { status: 'PENDING', content: null };
  return { status: 'READY', content: log.content, uploadedAt: log.uploadedAt };
}
```

**–ü–ª–∞–≥–∏–Ω: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã `REQUEST_LOGS` –∏–∑ heartbeat:**

```csharp
private async Task HandleRequestLogsCommandAsync(PluginCommand cmd) {
    try {
        var payload = JsonConvert.DeserializeObject<RequestLogsPayload>(cmd.Payload);
        var logDate = DateTime.Parse(payload.Date);
        var logFileName = $"plugin-{logDate:yyyy-MM-dd}.log";
        var logPath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "MaxLoyaltyRKeeper", "logs", logFileName  // –∏–ª–∏ MaxLoyaltyIiko –¥–ª—è iiko
        );

        if (!File.Exists(logPath)) {
            // –õ–æ–≥–æ–≤ –∑–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç ‚Äî —Å–æ–æ–±—â–∞–µ–º
            await apiClient.UploadLogsAsync(new UploadLogsRequest {
                CommandId = cmd.CommandId,
                LogDate = payload.Date,
                Content = $"[No log file found for {payload.Date}]",
                LineCount = 0,
                PluginVersion = GetPluginVersion()
            });
            return;
        }

        // –ß–∏—Ç–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å—Ç—Ä–æ–∫ (–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Å—å —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç—å)
        var lines = await ReadLastLinesAsync(logPath, payload.MaxLines);

        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É —É—Ä–æ–≤–Ω—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (payload.MinLevel != "Information") {
            lines = FilterByLevel(lines, payload.MinLevel);
        }

        var content = string.Join(Environment.NewLine, lines);

        logger.LogInformation(
            "Uploading {LineCount} log lines for date {Date} (command {CommandId})",
            lines.Count, payload.Date, cmd.CommandId);

        await apiClient.UploadLogsAsync(new UploadLogsRequest {
            CommandId = cmd.CommandId,
            LogDate = payload.Date,
            Content = content,
            LineCount = lines.Count,
            PluginVersion = GetPluginVersion()
        });

    } catch (Exception ex) {
        logger.LogError(ex, "Failed to upload logs for command {CommandId}", cmd.CommandId);
    }
}

// –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N —Å—Ç—Ä–æ–∫ (–±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ–≥–æ —Ñ–∞–π–ª–∞)
private async Task<List<string>> ReadLastLinesAsync(string path, int maxLines) {
    var lines = new List<string>();
    using var fs = new FileStream(path, FileMode.Open, FileAccess.Read, FileShare.ReadWrite);
    using var reader = new StreamReader(fs);
    // –ß–∏—Ç–∞–µ–º —Å –∫–æ–Ω—Ü–∞ —Ñ–∞–π–ª–∞
    var allLines = (await reader.ReadToEndAsync()).Split('\n');
    return allLines.TakeLast(maxLines).ToList();
}
```

**UI –≤ Admin Panel:**

```
Admin Panel ‚Üí POS –ü–ª–∞–≥–∏–Ω—ã ‚Üí [–ö–∞—Å—Å–∞ 1] ‚Üí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí üìã –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ª–æ–≥–∏

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ó–∞–ø—Ä–æ—Å –ª–æ–≥–æ–≤ ‚Äî –ö–∞—Å—Å–∞ 1 (iiko)                               ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  –î–∞—Ç–∞:     [19.02.2026 ‚ñæ]                                    ‚îÇ
‚îÇ  –£—Ä–æ–≤–µ–Ω—å:  [Warning –∏ –≤—ã—à–µ ‚ñæ]  (Warning | Error | All)       ‚îÇ
‚îÇ  –°—Ç—Ä–æ–∫:    [1000 ‚ñæ]            (100 | 500 | 1000)            ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  [–ó–∞–ø—Ä–æ—Å–∏—Ç—å –ª–æ–≥–∏]                                            ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∫–∞—Å—Å—ã... (~60 —Å–µ–∫)                    ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ  2026-02-19 19:45:12 [WRN] Offline queue size: 8             ‚îÇ
‚îÇ  2026-02-19 19:45:15 [ERR] Finalize failed: timeout          ‚îÇ
‚îÇ  2026-02-19 19:47:03 [WRN] Backend went offline              ‚îÇ
‚îÇ  2026-02-19 19:52:11 [INF] Backend is back online            ‚îÇ
‚îÇ                                                   [–°–∫–∞—á–∞—Ç—å ‚ñæ]‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Retention –ø–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è –ª–æ–≥–æ–≤ –≤ –ë–î:**

```typescript
// CRON: —É–¥–∞–ª—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
@Cron('0 3 * * *') // –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00
async cleanupUploadedLogs() {
  await this.prisma.pluginLog.deleteMany({
    where: { uploadedAt: { lt: subDays(new Date(), 7) } }
  });
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ë–µ–∑ remote logs Support —Å–ª–µ–ø–æ–π –ø—Ä–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ. 60-—Å–µ–∫—É–Ω–¥–Ω—ã–π heartbeat = –ª–æ–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ ~90 —Å–µ–∫ –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞. –ß–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 —Å—Ç—Ä–æ–∫ = –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º —Å–µ—Ç—å (–ª–æ–≥-—Ñ–∞–π–ª –º–æ–∂–µ—Ç –±—ã—Ç—å 50MB). `ReadLastLinesAsync` —Å `FileShare.ReadWrite` = —á–∏—Ç–∞–µ–º —Ñ–∞–π–ª –ø–æ–∫–∞ Serilog –≤ –Ω–µ–≥–æ –ø–∏—à–µ—Ç –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.

**‚úÖ –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** `pluginCommand` —Ç–∏–ø–∞ `REQUEST_LOGS` ‚Üí –ø–ª–∞–≥–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º heartbeat ‚Üí `ReadLastLinesAsync` (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 —Å—Ç—Ä–æ–∫, `FileShare.ReadWrite`) ‚Üí `POST /upload-logs` ‚Üí `pluginLog` —Ç–∞–±–ª–∏—Ü–∞ –≤ –ë–î ‚Üí Admin –≤–∏–¥–∏—Ç –≤ –ø–∞–Ω–µ–ª–∏ —á–µ—Ä–µ–∑ polling `GET /logs?commandId=xxx`. Retention 7 –¥–Ω–µ–π. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —É—Ä–æ–≤–Ω—é (Warning/Error/All) –∏ –¥–∞—Ç–µ. –ö–Ω–æ–ø–∫–∞ ¬´–°–∫–∞—á–∞—Ç—å¬ª –≤ Admin Panel.

***

## üìã –†–ï–ï–°–¢–† –í–°–ï–• –ü–†–ò–ù–Ø–¢–´–• –†–ï–®–ï–ù–ò–ô

| \# | –û–±–ª–∞—Å—Ç—å | –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ |
| :-- | :-- | :-- |
| Q1 | –†–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ | TTL 30 –º–∏–Ω + Grace +60 –º–∏–Ω = 90 –º–∏–Ω total |
| Q2 | –†–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ | CRON `*/5 * * * *` ‚Üí AUTO_CANCEL + unlock `reservedBalance` |
| Q3 | Offline | `EARN_ONLY` –≤ –æ—á–µ—Ä–µ–¥—å —Å TTL 8—á + –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∫–∞—Å—Å–∏—Ä—É |
| Q4 | –§–∏–Ω–∞–Ω—Å—ã | `POST /finalize-refund` ‚Üí –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π `REFUND` transaction |
| Q5 | –§–∏–Ω–∞–Ω—Å—ã | `splitGroupId` –≤ `PointsReservation` ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Ç–æ—Ä–æ–≥–æ split |
| Q6 | Offline | Overflow: EarnOnly –¥—Ä–æ–ø (no throw), Spend/Discount `QueueOverflowException` |
| Q7 | Offline | `idempotencyKey` = `offline_{restaurantId}_{orderId}_{guestCardId}_{type}` + Redis 24—á |
| Q8 | Admin Panel | –°—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´POS –ü–ª–∞–≥–∏–Ω—ã¬ª: —Å—Ç–∞—Ç—É—Å/–≤–µ—Ä—Å–∏—è/–º–µ—Ç—Ä–∏–∫–∏/actions per-installation |
| Q9 | Heartbeat | –ö–∞–∂–¥—ã–µ 60 —Å–µ–∫, payload: metrics, response: commands[] + criticalUpdateAvailable |
| Q10 | Security | `machineId` = SHA256(BIOS UUID + HDD Serial + Hostname), tolerant 2 –∏–∑ 3 |
| Q11 | –û–±–Ω–æ–≤–ª–µ–Ω–∏—è | `isCritical: true` ‚Üí countdown 5 –º–∏–Ω ‚Üí auto-install –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è |
| Q12 | –û–±–Ω–æ–≤–ª–µ–Ω–∏—è | Backup ‚Üí install ‚Üí health check 15 —Å–µ–∫ ‚Üí auto-rollback –ø—Ä–∏ –ø—Ä–æ–≤–∞–ª–µ |
| Q13 | R-Keeper | SharedMem –∏–º—è = `MaxLoyaltyRKeeperShared_{terminalId}` + Named Mutex |
| Q14 | R-Keeper | Timeout GetCardInfo = 5 —Å–µ–∫, FinalizeTransaction = 10 —Å–µ–∫, –∫–æ–¥ `-3` = offline |
| Q15 | UI | `uiSettings` –≤ –ë–î, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `RELOAD_CONFIG` –≤ heartbeat |
| Q16 | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | Dashboard: ONLINE/WARNING/OFFLINE + email-–∞–ª–µ—Ä—Ç > 10 –º–∏–Ω offline (–∞–Ω—Ç–∏—Å–ø–∞–º 1—á) |
| Q17 | –ú–µ—Ç—Ä–∏–∫–∏ | `PluginMetric` —Ç–∞–±–ª–∏—Ü–∞, –±–∞—Ç—á–∏–Ω–≥ 30 —Å–µ–∫, SLO: P95 < 500ms, retention 90 –¥–Ω–µ–π |
| Q18 | UX | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –∫–∞—Å—Å–µ: —Ç–æ–ª—å–∫–æ —Ç–µ–ª–µ—Ñ–æ–Ω + –æ–ø—Ü. –∏–º—è, –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞ —Å—Ä–∞–∑—É |
| Q19 | R-Keeper | `OrderSelectWindow` –ø—Ä–∏ count > 1, —Ñ–∏–ª—å—Ç—Ä –ø–æ `StationId` |
| Q20 | iiko | `ButtonCategory.Additions`, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ `README.txt` installer'–∞ |
| Q21 | DB | –ï–¥–∏–Ω–∞—è `PointsReservation` + –µ–¥–∏–Ω–∞—è `PluginInstallation` —Å –ø–æ–ª–µ–º `posSystem` |
| Q22 | –í–µ—Ä—Å–∏–∏ | `PluginVersion` + R2, presigned URL TTL 1—á, manifest –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ |
| Q23 | Backend | `PosIntegrationService` + —Ç–æ–Ω–∫–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã + `PluginAuthGuard` + `@Installation()` |
| Q24 | Security | Grace: 0 –º–∏–Ω (security), 30 –º–∏–Ω (default), 120 –º–∏–Ω (planned rotation) |
| Q25 | –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ | `REQUEST_LOGS` –∫–æ–º–∞–Ω–¥–∞ ‚Üí heartbeat ‚Üí `ReadLastLinesAsync` ‚Üí `upload-logs` ‚Üí Admin Panel |

<span style="display:none">[^8_1][^8_2]</span>

<div align="center">‚ÅÇ</div>

[^8_1]: Plagin-r-kepper.md

[^8_2]: Plagin-iiko.md


---

# –ü—Ä–æ–¥–æ–ª–∂–∏–º, —á—Ç–æ –¥–µ–ª–∞–µ–º –¥–∞–ª—å—à–µ?

–ú—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –ø–æ–ª–Ω—ã–π –±–ª–æ–∫ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –ø–æ POS-–ø–ª–∞–≥–∏–Ω–∞–º (Q1‚ÄìQ25). –í–æ—Ç –≥–¥–µ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –∏ —á—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ:

## ‚úÖ –ß—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ

–ü–æ POS-–ø–ª–∞–≥–∏–Ω–∞–º –∑–∞–∫—Ä—ã—Ç—ã –≤—Å–µ 5 –±–ª–æ–∫–æ–≤:

- **–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ª–æ–≥–∏–∫–∞** ‚Äî —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏, grace window, refund, split bill
- **Offline —Ä–µ–∂–∏–º** ‚Äî –æ—á–µ—Ä–µ–¥—å, idempotency, overflow
- **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** ‚Äî installer, Admin Panel, heartbeat
- **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è** ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ/–æ–±—ã—á–Ω—ã–µ, rollback
- **Backend/DB** ‚Äî —Å—Ö–µ–º–∞, DRY-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

***

## üîÄ –í–∞—Ä–∏–∞–Ω—Ç—ã —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞

### –í–∞—Ä–∏–∞–Ω—Ç 1 ‚Äî –§–∏–Ω–∞–ª—å–Ω–∞—è Prisma-—Å—Ö–µ–º–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é)

–ù–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª–Ω—É—é, —Ñ–∏–Ω–∞–ª—å–Ω—É—é `schema.prisma` —Å–æ –≤—Å–µ–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏ ‚Äî `PointsReservation`, `PluginInstallation`, `PluginVersion`, `PluginCommand`, `PluginMetric`, `PluginLog`, `LoyaltyTransaction`, `AuditLog` ‚Äî —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏, enum'–∞–º–∏ –∏ relation'–∞–º–∏. –≠—Ç–æ ¬´–∑–µ–º–ª—è¬ª –ø–æ–¥ –≤–µ—Å—å –¥–∞–ª—å–Ω–µ–π—à–∏–π –∫–æ–¥.

### –í–∞—Ä–∏–∞–Ω—Ç 2 ‚Äî NestJS: –ø–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

–ù–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª–Ω—ã–π `PosIntegrationModule` ‚Äî –≤—Å–µ —Ñ–∞–π–ª—ã, –∏–º–ø–æ—Ä—Ç—ã, `PluginAuthGuard`, DTO-–∫–ª–∞—Å—Å—ã —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π, exception filters, CRON-–∑–∞–¥–∞—á–∏. –ì–æ—Ç–æ–≤–æ –∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—é –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.

### –í–∞—Ä–∏–∞–Ω—Ç 3 ‚Äî C\# iiko-–ø–ª–∞–≥–∏–Ω: —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥

–ù–∞–ø–∏—Å–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π, production-ready –∫–æ–¥ –ø–ª–∞–≥–∏–Ω–∞: `Plugin.cs`, `LoyaltyApiClient.cs`, `OfflineQueueService.cs` (—Å —Ä–µ—à–µ–Ω–∏—è–º–∏ Q3/Q6/Q7), `HealthCheckService.cs` ‚Äî —Å–æ –≤—Å–µ–º–∏ –ø—Ä–∏–Ω—è—Ç—ã–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏ —É–∂–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏.

### –í–∞—Ä–∏–∞–Ω—Ç 4 ‚Äî C++/C\# R-Keeper DLL: —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥

–§–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ `MaxLoyaltyRKeeper.dll` ‚Äî `dllmain.cpp`, `exports.cpp` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ timeout'–∞–º–∏ (Q14), Named Mutex (Q13), `SharedMemoryService.cs`.

### –í–∞—Ä–∏–∞–Ω—Ç 5 ‚Äî –°–ª–µ–¥—É—é—â–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã

–ü–µ—Ä–µ–π—Ç–∏ –∫ –¥—Ä—É–≥–æ–π —á–∞—Å—Ç–∏ Max Loyalty: **Telegram Bot**, **Admin Panel (Next.js)**, **–º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**, **–¥–≤–∏–∂–æ–∫ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (–ø—Ä–∞–≤–∏–ª–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è)** –∏ —Ç.–¥.

***

## üí° –ú–æ—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

–ò–¥—Ç–∏ –≤ –ø–æ—Ä—è–¥–∫–µ **1 ‚Üí 2 ‚Üí 3 ‚Üí 4**:

- –°–Ω–∞—á–∞–ª–∞ **—Å—Ö–µ–º–∞ –ë–î** (–í–∞—Ä–∏–∞–Ω—Ç 1) ‚Äî –æ–Ω–∞ –Ω—É–∂–Ω–∞ –¥–ª—è –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ
- –ó–∞—Ç–µ–º **NestJS –º–æ–¥—É–ª—å** (–í–∞—Ä–∏–∞–Ω—Ç 2) ‚Äî backend-–æ—Å–Ω–æ–≤–∞
- –ó–∞—Ç–µ–º **–ø–ª–∞–≥–∏–Ω—ã** (3 –∏ 4) ‚Äî –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–¥

–ù–æ –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã ‚Äî —ç—Ç–æ —Ç–æ–∂–µ —Ä–∞–∑—É–º–Ω–æ. **–ö–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±–∏—Ä–∞–µ–º?**
<span style="display:none">[^9_1][^9_2]</span>

<div align="center">‚ÅÇ</div>

[^9_1]: Plagin-r-kepper.md

[^9_2]: Plagin-iiko.md

