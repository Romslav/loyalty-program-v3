<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# –£ –º–µ–Ω—è –µ—Å—Ç—å 14 –±–µ—Å–µ–¥ –≤ –∫–æ—Ç–æ—Ä—ã—Ö –º—ã –ø–æ –±–ª–æ–∫–∞–º –ø—Ä–æ—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –±–ª–æ–∫–∏. –ù–∞–º –Ω—É–∂–Ω–æ —Å —Ç–æ–±–æ–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤ —ç—Ç–æ–º –¥–∏–∞–ª–æ–≥–µ. –ò–∑—É—á–∞–π –ø–æ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–∏(–ë–µ—Å–µ–¥–∞ 1 - –ë–µ—Å–µ–¥–∞ 2 - –ë–µ—Å–µ–¥–∞ 3 - –ë–µ—Å–µ–¥–∞ 4 - –ë–µ—Å–µ–¥–∞ 5 - –ë–µ—Å–µ–¥–∞ 6 - –ë–µ—Å–µ–¥–∞ 7 - –ë–µ—Å–µ–¥–∞ 8 - –ë–µ—Å–µ–¥–∞ 9 - –ë–µ—Å–µ–¥–∞ 10 - –ë–µ—Å–µ–¥–∞ 11 - –ë–µ—Å–µ–¥–∞ 12 - –ë–µ—Å–µ–¥–∞ 13 - –ë–µ—Å–µ–¥–∞ 14) –≤ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö + 2 —Ñ–∞–π–ª–∞ —Å –ø–ª–∞–≥–∏–Ω–∞–º–∏ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.

–ò–∑—É—á–∏ –≤—Å–µ –¥–æ—Å–∫–∞–Ω–∞–ª—å–Ω–æ, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏ —á–µ—Ç–∫–æ, –≤—Å–µ 14 –¥–∏–∞–ª–æ–≥–æ–≤ –∏ 2 —Ñ–∞–π–ª–∞ —Å –ø–ª–∞–≥–∏–Ω–∞–º–∏, –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç –≤ –¥–∏–∞–ª–æ–≥–∞—Ö, –∫–∞–∂–¥–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ –∏ –ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ù–∞–π–¥–∏ –≤—Å–µ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –Ω–∏–º. –ó–∞–ª–æ–∂–∏ –Ω–∞ —ç—Ç–æ –≤—Ä–µ–º—è –∏ —Å–∏–ª—ã, —á—Ç–æ–±—ã —Ç—ã –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ –≤—Å–µ –ø–æ–Ω–∏–º–∞–ª –¥–æ –º–µ–ª—å—á–∞–π—à–∏—Ö –¥–µ—Ç–∞–ª–µ–π, –±–µ–∑ –æ—à–∏–±–æ–∫.
–ù–∞–π–¥–∏ –≤—Å–µ –±–ª–æ–∫–∏ —á—Ç–æ –º—ã —Å —Ç–æ–±–æ–π –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ –∏ –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –Ω–∏–º, –∏–∑—É—á–∏ –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ, –¥–æ –º–µ–ª–æ—á–µ–π –∫ –∫–∞–∫–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –ø—Ä–∏—à–ª–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –±–ª–æ–∫—É. –ü–æ—Å–ª–µ –±—É–¥–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é.

–Ø –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑—É—á–∏–ª –≤—Å–µ 14 –±–µ—Å–µ–¥ –∏ –æ–±–∞ —Ñ–∞–π–ª–∞ —Å –ø–ª–∞–≥–∏–Ω–∞–º–∏. –í–æ—Ç –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–µ–µ —Ä–µ–∑—é–º–µ –≤—Å–µ–≥–æ, —á—Ç–æ –±—ã–ª–æ –¥–µ—Ç–∞–ª—å–Ω–æ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ:

***

# üìã MAX-LOYALTY: –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –í–°–ï–• 14 –ë–ï–°–ï–î

–Ø –¥–æ—Å–∫–æ–Ω–∞–ª—å–Ω–æ –∏–∑—É—á–∏–ª –≤—Å–µ —Ñ–∞–π–ª—ã. –ù–∏–∂–µ ‚Äî –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ –≤—Å–µ–º–∏ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º–∏ –±–ª–æ–∫–∞–º–∏, —Ñ–∏–Ω–∞–ª—å–Ω—ã–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏ –∏ –¥–µ—Ç–∞–ª—è–º–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –∏–∑ –Ω–∏—Ö.

***

## üóÇÔ∏è –•–†–û–ù–û–õ–û–ì–ò–Ø –ü–†–û–†–ê–ë–û–¢–ê–ù–ù–´–• –ë–õ–û–ö–û–í

### –ë–µ—Å–µ–¥–∞ 1 ‚Äî –ù–∞—á–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞[1]

–ó–∞–ª–æ–∂–µ–Ω —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –≤—Å–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã: –∫–æ–Ω—Ü–µ–ø—Ü–∏—è multi-tenant SaaS –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º. –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã:

- **6 —Ä–æ–ª–µ–π**: Owner ‚Üí Restaurant Admin ‚Üí Manager ‚Üí Cashier ‚Üí Guest
- **6 —Ç–∞—Ä–∏—Ñ–æ–≤**: Free (—Ç–æ–ª—å–∫–æ Owner), Standard (1 —Ä–µ—Å—Ç–æ—Ä–∞–Ω, 500 –≥–æ—Å—Ç–µ–π), Medium (3 —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, 2000 –≥–æ—Å—Ç–µ–π), Pro (5 —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, 6000 –≥–æ—Å—Ç–µ–π), Ultimate (‚àû), Custom (–∫–∞—Å—Ç–æ–º–Ω—ã–µ –ª–∏–º–∏—Ç—ã)
- **2 —Ç–∏–ø–∞ —Å–∏—Å—Ç–µ–º –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏**: —Å–∫–∏–¥–æ—á–Ω–∞—è (% –æ—Ç —á–µ–∫–∞) –∏ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è (–±–∞–ª–ª—ã)
- **3 —Å–ø–æ—Å–æ–±–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≥–æ—Å—Ç–µ–π**: —á–µ—Ä–µ–∑ –∫–∞—Å—Å–∏—Ä–∞, –ø–æ —Å—Å—ã–ª–∫–µ, —á–µ—Ä–µ–∑ Telegram –±–æ—Ç
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å iiko –∏ R-Keeper
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ backend (NestJS), frontend (React), Telegram Bot + Mini App

***

### –ë–µ—Å–µ–¥–∞ 2 ‚Äî –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã + Guests \& Loyalty Cards[2]

–ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—Å–µ—Ö 6 —É—Ä–æ–≤–Ω–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –ë–î. –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –±–ª–æ–∫ **Guests \& Loyalty Cards**: 27+ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –≥–æ—Å—Ç—è, –∫–∞—Ä—Ç–∞–º –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –ø–æ Auth Flow:**

- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ —á–µ—Ä–µ–∑ —Å–ø–µ—Ü-—Å—Å—ã–ª–∫—É
- –õ–æ–≥–∏–Ω –ø–æ Email **–∏** Phone (–æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞)
- JWT Access Token (15 –º–∏–Ω) + Refresh Token –≤ HttpOnly Cookie (30 –¥–Ω–µ–π)
- Rate limiting: 5 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ 15 –º–∏–Ω—É—Ç ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ 30 –º–∏–Ω—É—Ç
- MFA: –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π
- –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏: –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ
- Social login: Email/Password + Telegram
- Guest: –±–µ–∑ –ø–∞—Ä–æ–ª—è ‚Äî —Ç–æ–ª—å–∫–æ —Ç–µ–ª–µ—Ñ–æ–Ω —Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –∏–ª–∏ Telegram ID

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –ø–æ –≥–æ—Å—Ç—è–º:**

- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ò–º—è + –¢–µ–ª–µ—Ñ–æ–Ω; –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è ‚Äî **–Ω–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ 3 –º–µ—Å—è—Ü–∞**
- –°–º–µ–Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚Äî –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ **–Ω–æ–≤–æ–≥–æ** –Ω–æ–º–µ—Ä–∞ (—Å—Ç–∞—Ä—ã–π –Ω–µ –Ω—É–∂–µ–Ω), –≤—Å–µ –±–∞–ª–ª—ã/—É—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è
- –î–µ—Ç–∏ ‚Äî –¥–æ 18 –ª–µ—Ç; –±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –≥–æ—Å—Ç—è
- QR + 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è **–ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏**; QR –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

***

### –ë–µ—Å–µ–¥–∞ 3 ‚Äî Loyalty System Builder + Analytics[3]

–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω –±–ª–æ–∫ **Loyalty System Builder** –∏ **Analytics \& Reports**.

**Loyalty Builder:**

- –í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–∫–∏–¥–æ—á–Ω—ã—Ö/–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
- –£—Ä–æ–≤–Ω–∏ (–±—Ä–æ–Ω–∑–∞, —Å–µ—Ä–µ–±—Ä–æ, –∑–æ–ª–æ—Ç–æ –∏ –ª—é–±—ã–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ)
- –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –≥–æ—Å—Ç–µ–π
- –ü—Ä–æ–º–æ-–∞–∫—Ü–∏–∏: –î–† –≥–æ—Å—Ç—è, –î–† —Ä–µ–±—ë–Ω–∫–∞, –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –ø–µ—Ä–≤—ã–π —á–µ–∫, –∫–∞—Å—Ç–æ–º–Ω—ã–µ
- –î–∏–∑–∞–π–Ω –∫–∞—Ä—Ç—ã: 10 –±–∞–∑–æ–≤—ã—Ö —Ñ–æ–Ω–æ–≤ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–µ–≥–æ + –ª–æ–≥–æ—Ç–∏–ø —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
- –†–µ–∂–∏–º—ã: UNIFIED (–æ–¥–Ω–∞ –∫–∞—Ä—Ç–∞ –Ω–∞ –≤—Å—é —Å–µ—Ç—å) / SEPARATE (–æ—Ç–¥–µ–ª—å–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞)

**Analytics:**

- Owner: MRR/ARR, Churn, ARPU, –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- Restaurant Admin: –≤—ã—Ä—É—á–∫–∞ –ø–æ —Å–µ—Ç–∏, ROI –ø—Ä–æ–º–æ, —Å–µ–≥–º–µ–Ω—Ç—ã –≥–æ—Å—Ç–µ–π, LTV
- Manager: —Ç–æ–ª—å–∫–æ —Å–≤–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω
- Guest: –ª–∏—á–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è (–±–∞–ª–ª—ã, –≤–∏–∑–∏—Ç—ã, —É—Ä–æ–≤–µ–Ω—å)
- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã: `AnalyticsDailySnapshot`, `AnalyticsMonthlySnapshot`, `GuestSegmentation`

***

### –ë–µ—Å–µ–¥–∞ 4 ‚Äî POS Integration (–±–∞–∑–æ–≤–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è)[4]

–ü–µ—Ä–≤–∞—è –≥–ª—É–±–æ–∫–∞—è –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å iiko / R-Keeper.

**–§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: HYBRID PUSH + PULL (webhooks + PULL –∫–∞–∂–¥—ã–µ **30 –º–∏–Ω—É—Ç** –∫–∞–∫ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞)
- **–ë–∞–ª–ª—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞** (–¥–æ —Å–ø–∏—Å–∞–Ω–∏—è). –ü—Ä–∏ —á–µ–∫–µ 2000—Ä, —Å–ø–∏—Å–∞–Ω–∏–∏ 100—Ä ‚Äî –±–∞–ª–ª—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –æ—Ç 2000—Ä
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: HMAC-SHA256 –ø–æ–¥–ø–∏—Å–∏ –Ω–∞ webhooks
- **–û—à–∏–±–∫–∏**: –≤—Å–µ —Ç—Ä–∏ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (PUSH + PULL + —Ä—É—á–Ω–∞—è –ø–µ—Ä–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
- **–°—Ç–∞—Ç—É—Å—ã —Å–∏–Ω–∫–æ–≤**: SUCCESS, FAILED, PARTIAL, PENDING
- **Admin** –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ API –∫–ª—é—á–∞–º (–≤–∏–¥–∏—Ç, –Ω–æ –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ + –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ)
- Admin –≤—ã–±–∏—Ä–∞–µ—Ç POS (iiko/R-Keeper) –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

***

### –ë–µ—Å–µ–¥–∞ 5 ‚Äî Loyalty Engine (–≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—Ä–∞–≤–∏–ª–∞, —É—Ä–æ–≤–Ω–∏)[5]

**23 –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞** ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è –±–µ—Å–µ–¥–∞.

**–ë–ª–æ–∫ B1 ‚Äî –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª:**

- –í–∞—Ä–∏–∞–Ω—Ç B: **–Ω–µ—Ç –ø–µ—Ä–µ—Å—á—ë—Ç–∞ –∑–∞–¥–Ω–∏–º —á–∏—Å–ª–æ–º** ‚Äî –∫–∞–∂–¥—ã–π —á–µ–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –Ω–∞ –º–æ–º–µ–Ω—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
- `BallTransaction` —Å–æ–¥–µ—Ä–∂–∏—Ç snapshot –ø—Ä–∞–≤–∏–ª–∞ (`rule_snapshot`)
- –û—Ç–∫–∞—Ç: —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ —Å –∫–æ–ø–∏–µ–π —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ (–∏—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)
- Emergency –ø–µ—Ä–µ—Å—á—ë—Ç: background job (RECALCULATE / ADJUST / NOTIFY_ONLY —Ä–µ–∂–∏–º—ã)

**–ë–ª–æ–∫ B2 ‚Äî UNIFIED/SEPARATE –º–∏–≥—Ä–∞—Ü–∏–∏:**

- UNIFIED ‚Üí SEPARATE: –±–∞–ª–ª—ã/—É—Ä–æ–≤–Ω–∏/–∏—Å—Ç–æ—Ä–∏—è **–∫–æ–ø–∏—Ä—É—é—Ç—Å—è** –≤ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω
- SEPARATE ‚Üí UNIFIED: –±–∞–ª–∞–Ω—Å—ã **—Å—É–º–º–∏—Ä—É—é—Ç—Å—è**, –±–µ—Ä—ë—Ç—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å, —Å—Ç–∞—Ä—ã–µ –∫–∞—Ä—Ç—ã ‚Üí `MIGRATED`

**–ë–ª–æ–∫ B3 ‚Äî –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–æ–º–æ:**

- –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: **COMBINE_ALL / MAX_ONLY / FIRST_ONLY**
- Override –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–∞—Ä –ø—Ä–æ–º–æ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `PromoBallGranted` —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π

**–ë–ª–æ–∫ B4 ‚Äî –°–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –∏ —É—Ä–æ–≤–Ω–∏:**

- **1 –±–∞–ª–ª = 1 —Ä—É–±–ª—é** ‚Äî –≥–ª–æ–±–∞–ª—å–Ω–æ–µ, –Ω–µ–∏–∑–º–µ–Ω—è–µ–º–æ–µ –ø—Ä–∞–≤–∏–ª–æ
- –ö–∞–∂–¥—ã–π `BallTransaction` –∏–º–µ–µ—Ç `expires_at` (—Ä–∞–∑–Ω—ã–µ —Å—Ä–æ–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤)
- FIFO –ø–æ—Ä—è–¥–æ–∫ —Å–≥–æ—Ä–∞–Ω–∏—è (–ø–µ—Ä–≤—ã–µ –ø—Ä–∏—à–µ–¥—à–∏–µ ‚Äî –ø–µ—Ä–≤—ã–µ —É—Ö–æ–¥—è—Ç)
- **–£—Ä–æ–≤–Ω–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–Ω–∏–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** (only way up); downgrade ‚Äî —Ç–æ–ª—å–∫–æ —è–≤–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ Admin
- –ü–µ—Ä–µ—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π ‚Äî –Ω–æ—á–Ω–æ–π CRON, —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ
- Lifetime spent –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–≥–æ—Ä–∞–Ω–∏–∏: CRON –≤ 10:00, –ø–µ—Ä–∏–æ–¥—ã –∏ –∫–∞–Ω–∞–ª—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç Admin

**–ë–ª–æ–∫ B5 ‚Äî –õ–∏–º–∏—Ç—ã:**

- –ú–∞–∫—Å–∏–º—É–º –±–∞–ª–ª–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ: **–±–µ–∑–ª–∏–º–∏—Ç**
- –ú–∏–Ω–∏–º—É–º –∫ —Å–ø–∏—Å–∞–Ω–∏—é: **1 –±–∞–ª–ª**
- –ú–∞–∫—Å–∏–º—É–º –∫ —Å–ø–∏—Å–∞–Ω–∏—é: **20% –æ—Ç —á–µ–∫–∞** (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ 10‚Äì100%)
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞: **50 —Ä—É–±–ª–µ–π** (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)

**–ë–ª–æ–∫ B6 ‚Äî –ü–æ—Ä—è–¥–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è:**

- –°–Ω–∞—á–∞–ª–∞ —Ç—Ä–∞—Ç—è—Ç—Å—è **–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ (promo_balance)**, –ø–æ—Ç–æ–º **–æ—Å–Ω–æ–≤–Ω—ã–µ (regular_balance)**
- –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏ —Å–ø–∏—Å—ã–≤–∞–µ–º, –∏ –Ω–∞—á–∏—Å–ª—è–µ–º –∫–µ—à–±—ç–∫ –æ—Ç –ø–æ–ª–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞

**–ë–ª–æ–∫ B7 ‚Äî –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ edge-cases:**

- –ñ—ë—Å—Ç–∫–∏–π –∑–∞–ø—Ä–µ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ –∫ –æ–¥–Ω–æ–º—É —á–µ–∫—É (UNIQUE constraint)
- Soft delete –≥–æ—Å—Ç—è: —Å—Ç–∞—Ç—É—Å `DELETED`, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞—Ç–∏—Ä–∞—é—Ç—Å—è, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ—Å—Ç–∞—ë—Ç—Å—è

***

### –ë–µ—Å–µ–¥–∞ 6 ‚Äî Billing \& Subscriptions[6]

**–ü–æ–ª–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã.**

**–ú–æ–¥–µ–ª—å –ø–æ–¥–ø–∏—Å–∫–∏:**

- –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (–º–µ—Å—è—Ü –∏–ª–∏ –≥–æ–¥)
- –ì–æ–¥ = –º–µ—Å—è—á–Ω–∞—è —Ü–µ–Ω–∞ √ó 12 √ó 0.8 (—Å–∫–∏–¥–∫–∞ 20%)
- –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ

**–ü–ª–∞—Ç—ë–∂–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã** (—á–µ—Ä–µ–∑ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é `PaymentProvider`): YooKassa, Stripe, CloudPayments, CryptoCloud

**–†—É—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞**: –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –ª—é–±—ã—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö. Invoice —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `PENDING_MANUAL_PAYMENT` ‚Üí Owner –ø–æ–º–µ—á–∞–µ—Ç –∫–∞–∫ `PAID`

**–õ–∏–º–∏—Ç—ã –ø–æ —Ç–∞—Ä–∏—Ñ—É:**

- 90% ‚Üí –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
- 100% ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –≥–æ—Å—Ç–µ–π/—Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ Admin'–æ–≤ —Ç–∞—Ä–∏—Ñ **–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç**

**–ù–µ—É—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏:** 4 –ø–æ–ø—ã—Ç–∫–∏ (–¥–µ–Ω—å 0, 1, 3, 7) ‚Üí `PAST_DUE` ‚Üí `CANCELLED_NON_PAYMENT`

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º:** –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã, –º–æ–∂–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É

**Refund/Chargeback:**

- `REFUNDED`, `PARTIALLY_REFUNDED`, `CHARGEBACK`
- Chargeback ‚Üí –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π `CANCELLED_CHARGEBACK`, tenant –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è

**Trial:** –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é **–≤—ã–∫–ª—é—á–µ–Ω**. –í–∞–ª—é—Ç–∞: RUB, —Ü–µ–Ω—ã —Å –ù–î–°

***

### –ë–µ—Å–µ–¥–∞ 7 ‚Äî Telegram Bot + Mini App[7]

**–§–∏–Ω–∞–ª—å–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è** –∏–∑ 41 –≤–æ–ø—Ä–æ—Å–∞ –ø–æ 8 –±–ª–æ–∫–∞–º.

**–°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞:**

- –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: Admin —Å–æ–∑–¥–∞—ë—Ç –±–æ—Ç–∞ —É @BotFather ‚Üí –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Üí –º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º webhook
- `TelegramBot.restaurant_id = null` –ø—Ä–∏ UNIFIED (–æ–¥–∏–Ω –±–æ—Ç –Ω–∞ –≤—Å—é —Å–µ—Ç—å); –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–æ—Ç –Ω–∞ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω –ø—Ä–∏ SEPARATE

**–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**

- Telegram ID + —Ç–µ–ª–µ—Ñ–æ–Ω (—Ç–µ–ª–µ—Ñ–æ–Ω **–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω**)
- SMS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤–≤–æ–¥–µ –Ω–æ–º–µ—Ä–∞
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: —Ç–µ–ª–µ—Ñ–æ–Ω + –∏–º—è, –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è

**–ö–∞—Ä—Ç–æ—á–∫–∞ –≥–æ—Å—Ç—è:**

- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω: –±–∞–ª–∞–Ω—Å, QR-–∫–æ–¥, 6-digit –∫–æ–¥, —É—Ä–æ–≤–µ–Ω—å, –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
- 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ **–≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç** (–±–µ–∑ —Å–∫—Ä—ã—Ç–∏—è)
- QR –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã–π **–¥–æ –ø–µ—Ä–≤–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏** (–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ), –ø–æ—Ç–æ–º –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- –ú—É–ª—å—Ç–∏–∫–∞—Ä—Ç–æ—á–Ω–æ—Å—Ç—å: –≤—Å–µ –∫–∞—Ä—Ç—ã –≤ –æ–¥–Ω–æ–º Mini App —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º

**–ò—Å—Ç–æ—Ä–∏—è –∏ –ø—Ä–æ—Ñ–∏–ª—å:**

- –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–ª–æ–≤ –∏ –ø–æ—Å–µ—â–µ–Ω–∏–π
- **–ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º** –≥–æ—Å—Ç—é: —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫, –≤—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º, –¥–∏–Ω–∞–º–∏–∫—É —Å—Ä–µ–¥–Ω–µ–≥–æ —á–µ–∫–∞
- –ü—Ä–æ—Ñ–∏–ª—å: —Å–º–µ–Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚Äî –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –Ω–æ–≤–æ–≥–æ; ¬´–¥–µ—Ç–∏¬ª —Ç–æ–ª—å–∫–æ –¥–æ 18 –ª–µ—Ç
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∫–∞—Ä—Ç—ã **–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è**

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**

- Telegram.WebApp.initData –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
- Webhook –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ **–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è**

***

### –ë–µ—Å–µ–¥–∞ 8 ‚Äî Backend API \& Services (Loyalty Engine)[8]

**34 –≤–æ–ø—Ä–æ—Å–∞ + —Ä–µ—à–µ–Ω–∏—è** –¥–ª—è –≤—Å–µ—Ö API –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤.

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:**

- **Modular Monolith** –Ω–∞ NestJS (–Ω–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –Ω–∞ —Å—Ç–∞—Ä—Ç–µ)
- **REST API** —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º (`/api/v1`)
- **RBAC Guards** + Impersonation (Owner)
- **Rate Limiting** –ø–æ —Ä–æ–ª—è–º (Redis)
- **Background Jobs**: BullMQ
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω–∞ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö endpoint'–∞—Ö

**–ö–ª—é—á–µ–≤—ã–µ endpoints:**

- `POST /api/v1/loyalty/calculate` ‚Äî –ø—Ä–µ–¥—Ä–∞—Å—á—ë—Ç –±–∞–ª–ª–æ–≤ –¥–ª—è POS
- `POST /api/v1/loyalty/transactions` ‚Äî —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
- `POST /api/v1/loyalty/manual-adjustment` ‚Äî —Ä—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞
- –ü–æ–ª–Ω—ã–µ CRUD –ø–æ —É—Ä–æ–≤–Ω—è–º/–ø—Ä–∞–≤–∏–ª–∞–º —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º

**Frontend Admin Panel (—Ç–æ–∂–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –≤ —ç—Ç–æ–π –±–µ—Å–µ–¥–µ):**

- Next.js 14 App Router
- shadcn/ui + Radix UI + Tailwind CSS
- Zustand + TanStack Query (state management)
- React Hook Form + Zod (—Ñ–æ—Ä–º—ã)
- TanStack Table v8 (—Ç–∞–±–ª–∏—Ü—ã)
- Recharts (–≥—Ä–∞—Ñ–∏–∫–∏)
- Collapsible sidebar: 250px ‚Üí 60px mini ‚Üí hidden
- Global search (CMDK)
- Loyalty Builder: Rules Builder —Å live preview, Conditions Builder, Priority drag-drop, Levels Builder (visual timeline), Promo Campaigns Builder (wizard)
- Auto-refresh 30s + SSE –¥–ª—è real-time

***

### –ë–µ—Å–µ–¥–∞ 9 ‚Äî Database Schema (Prisma)[9]

**–ü–æ–ª–Ω–∞—è Prisma Schema v1.0** ‚Äî 45+ —Ç–∞–±–ª–∏—Ü, 15+ enums, 200+ –ø–æ–ª–µ–π.

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏:**

- `User`, `Tenant`, `Restaurant`, `UserRole`, `UserPermission`
- `Subscription`, `Invoice`, `Payment`, `BillingInfo`, `TenantLimits`
- `LoyaltySystem`, `LoyaltyLevel`, `LoyaltyRule`, `LoyaltyRuleVersion`, `LoyaltyPromo`
- `GuestProfile`, `GuestCard`, `GuestChild`, `BallTransaction`, `GuestVisit`
- `POSIntegration`, `POSSync`, `POSTransaction`
- `TelegramBot`, `TelegramUser`, `TelegramSession`, `Notification`
- `AnalyticsDailySnapshot`, `AnalyticsMonthlySnapshot`, `GuestSegmentation`
- `ActivityLog`, `PromoBallGranted`, `RuleActivationLog`, `PasswordHistory`

**35+ –ø—Ä–∏–Ω—è—Ç—ã—Ö —Ä–µ—à–µ–Ω–∏–π**: –∏–Ω–¥–µ–∫—Å—ã, constraints, multi-tenancy —á–µ—Ä–µ–∑ `tenant_id` –≤–µ–∑–¥–µ, soft delete (`status = DELETED`)

***

### –ë–µ—Å–µ–¥–∞ 10 ‚Äî POS Integration (–¥–µ—Ç–∞–ª—å–Ω–∞—è JSON-—Å—Ö–µ–º–∞ + Notifications)[10]

**36 –≤–æ–ø—Ä–æ—Å–æ–≤** ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ JSON-—Å—Ö–µ–º—ã webhooks iiko/R-Keeper + –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è Notifications System.

**POS Integration —Ñ–∏–Ω–∞–ª:**

- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ JSON-—Å—Ö–µ–º—ã webhooks –æ—Ç iiko –∏ R-Keeper
- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≥–æ—Å—Ç—è –ø–æ **—Ç–µ–ª–µ—Ñ–æ–Ω—É** (–æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á)
- Auto-create guest –ø—Ä–∏ –ø–µ—Ä–≤–æ–º webhook (–æ–ø—Ü–∏—è –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)
- POS = **–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã** –ø–æ —á–µ–∫–∞–º; –ø—Ä–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è—Ö ‚Äî reconciliation job (–µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π) + –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- Sandbox-—Ä–µ–∂–∏–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**Notifications System:**

- Email: Resend (transactional) + SendGrid (marketing)
- Templates: React Email (JSX-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, type-safe)
- SMS: SMSC.ru (–æ—Å–Ω–æ–≤–Ω–æ–π –¥–ª—è –†–§) + Twilio (fallback)
- Retry logic: Exponential backoff (3 –ø–æ–ø—ã—Ç–∫–∏)
- Fallback: Telegram ‚Üí Email ‚Üí SMS
- Rate limiting: 10 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π/–¥–µ–Ω—å –Ω–∞ –≥–æ—Å—Ç—è
- Batching: LOW priority ‚Üí –≥—Ä—É–ø–ø–∏—Ä—É–µ–º 3+ –≤ –æ–¥–Ω–æ
- Inline QR –≤ welcome email

***

### –ë–µ—Å–µ–¥–∞ 11 ‚Äî Infrastructure \& DevOps + Testing Strategy[11]

**55 –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ** + **40 –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é**.

**–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–∞—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (MVP):**

- **Backend**: Fly.io (3 VM, always-on, zero-downtime)
- **Frontend**: Vercel (–∞–≤—Ç–æ–¥–µ–ø–ª–æ–π –∏–∑ GitHub)
- **PostgreSQL**: Neon (serverless, 3 GB free tier)
- **Redis**: Upstash (10K requests/day free)
- **S3 Storage**: Cloudflare R2 (10 GB free)
- **CI/CD**: GitHub Actions
- **Monitoring**: Prometheus + Grafana (self-hosted –Ω–∞ Fly.io)
- **Logging**: Grafana Loki (free)
- **Email**: Resend (3000/–º–µ—Å—è—Ü free)
- **SSL/DNS**: Cloudflare (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)

**Testing Strategy:**

- Unit tests (Jest): coverage ‚â•80%
- Integration tests (Supertest) —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î (TestContainers)
- E2E tests (Playwright)
- Load testing (k6)
- Security tests (tenant isolation, SQL injection, JWT tampering)
- Multi-tenancy isolation: Unit + Integration + Automated Penetration tests
- CI/CD: –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∫–∞–∂–¥–æ–º push

***

### –ë–µ—Å–µ–¥–∞ 12 ‚Äî UI/UX Design Specification[12]

**75+ –≤–æ–ø—Ä–æ—Å–æ–≤** ‚Äî –ø–æ–ª–Ω–∞—è –≤–∏–∑—É–∞–ª—å–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤.

**Dark Theme Design System:**

```
Background: #0a0a0a | Cards: #161616 | Border: #262626
Primary: #3b82f6 | Success: #10b981 | Danger: #ef4444 | Warning: #f59e0b
Font: Inter | –ú–µ—Ç—Ä–∏–∫–∏: text-3xl/4xl font-bold
```

**–ò–∫–æ–Ω–∫–∏**: —ç–º–æ–¥–∑–∏ (üçïü•áüìäüí∞) + —Å–∏–º–≤–æ–ª—ã (‚Üë‚Üì‚úì‚úï‚óè)

**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –ø–æ —Ä–æ–ª—è–º:**

- **Owner Dashboard**: MRR/ARR –∫–∞—Ä—Ç–æ—á–∫–∏, —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏, —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –∫–Ω–æ–ø–∫–∞ Impersonate —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **Admin Dashboard**: —Å–µ—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, Loyalty Builder (–≤–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä), —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Å—Ç—è–º–∏ (accordion cards –Ω–∞ mobile), POS —Å—Ç–∞—Ç—É—Å
- **Manager Dashboard**: —Ç–æ–ª—å–∫–æ —Å–≤–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω, read-only POS —Å—Ç–∞—Ç—É—Å + Test Connection
- **Cashier POS Interface**: —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π, —Ç–æ–ª—å–∫–æ –ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è + –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ

**Mobile (< 768px):** Hamburger + Bottom tabs, accordion cards –≤–º–µ—Å—Ç–æ —Ç–∞–±–ª–∏—Ü, Wizard –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Ñ–æ—Ä–º

***

### –ë–µ—Å–µ–¥–∞ 13 ‚Äî Security \& Compliance[13]

**40+ –≤–æ–ø—Ä–æ—Å–æ–≤** ‚Äî –ø–æ–ª–Ω—ã–π security audit.

**–§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**


| –û–±–ª–∞—Å—Ç—å | –†–µ—à–µ–Ω–∏–µ |
| :-- | :-- |
| JWT | RS256, access 5 –º–∏–Ω, refresh 14 –¥–Ω–µ–π + rotation + reuse detection |
| –ü–∞—Ä–æ–ª–∏ | argon2id, 10+ —Å–∏–º–≤–æ–ª–æ–≤, entropy check, history 5 –ø–∞—Ä–æ–ª–µ–π, 90 –¥–Ω–µ–π max age |
| MFA | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ Owner+Admin (TOTP+SMS), –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ Manager, Step-Up Auth –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π |
| –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö | AES-256-GCM at rest, TLS 1.3 in transit, field-level –¥–ª—è PII |
| GDPR | Soft delete, –ø—Ä–∞–≤–æ –Ω–∞ –∑–∞–±–≤–µ–Ω–∏–µ, —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö, cookie consent |
| PCI DSS | SAQ A (—Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, –Ω–µ —Ö—Ä–∞–Ω–∏–º –∫–∞—Ä—Ç—ã) |
| WAF | Cloudflare (DDoS, bot protection) |
| SIEM | ELK Stack, 40+ —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π, 5 –ø—Ä–∞–≤–∏–ª –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏, risk scoring 0‚Äì100 |
| Incident Response | NIST Framework, P1 < 1—á, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–∑–æ–ª—è—Ü–∏—è, War Room |
| –ü–µ–Ω—Ç–µ—Å—Ç | Annual external + internal, Bug Bounty (HackerOne) |

**Security Architecture**: 7 —Å–ª–æ—ë–≤ (Perimeter ‚Üí Auth ‚Üí Authorization ‚Üí Application ‚Üí Data ‚Üí Monitoring ‚Üí Incident Response)

***

### –ë–µ—Å–µ–¥–∞ 14 ‚Äî API Documentation + POS Plugins[14]

**45 –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ API Documentation** + —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø–ª–∞–≥–∏–Ω–æ–≤.

**API Documentation (–≤–æ–ø—Ä–æ—Å—ã 1‚Äì30, —Ñ–∏–Ω–∞–ª –∏–∑ –ë–µ—Å–µ–¥—ã 13):**


| \# | –¢–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ |
| :-- | :-- | :-- |
| 1 | Documentation Tool | OpenAPI (auto-gen) + GitBook |
| 2 | Auth | JWT (Frontend) + API Keys (server-to-server) |
| 4 | Versioning | URL `/api/v1`, `/api/v2` |
| 5 | Error Handling | RFC 7807 Problem Details |
| 7 | Webhook Security | HMAC-SHA256 + Timestamp |
| 8 | Webhook Retry | Exponential backoff, 6 –ø–æ–ø—ã—Ç–æ–∫ (6.5 –º–∏–Ω) |
| 9 | Pagination | Offset MVP, Cursor Phase 2 |
| 12 | Idempotency | Auto-hash (webhooks) + Client key (API) |
| 13 | SDK | TypeScript SDK; Python Phase 2 |
| 17 | Sandbox | Staging + Test API Keys (`mlk_test_...`) |
| 29 | SDK Auto-Gen | CI/CD OpenAPI ‚Üí codegen –ø—Ä–∏ –∫–∞–∂–¥–æ–º merge |

**–í–æ–ø—Ä–æ—Å—ã 31‚Äì45 (—É–≥–ª—É–±–ª—ë–Ω–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è):**

- –ü–æ–ª–Ω—ã–π Error Catalog (22 error codes –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º: Auth, Guest, Loyalty, POS, Billing, Rate, Server)
- Webhooks: versioning `v1/` prefix, signature verification, retry —Å exponential backoff
- Multi-tenancy –≤ API: –≤—Å–µ–≥–¥–∞ tenant context –∏–∑ JWT, –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ malicious params
- API Keys: 8 scopes + Permission Matrix, zero-downtime rotation (5 —à–∞–≥–æ–≤), 24—á grace period, Emergency Revoke
- –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è: EN –¥–ª—è API Reference, RU –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è Integration Guides

***

## üîå –ü–õ–ê–ì–ò–ù–´ –î–õ–Ø –ü–û–°-–°–ò–°–¢–ï–ú

### –ü–ª–∞–≥–∏–Ω iiko Front[15]

**–ü–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è C\# WPF –ø–ª–∞–≥–∏–Ω–∞.**

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:** C\# .NET 4.7.2+, WPF, iiko Front Plugin SDK, Serilog, MemoryCache, HttpClient + Polly

**Workflow –∫–∞—Å—Å–∏—Ä–∞:**

1. iiko Front ‚Üí –æ—Ç–∫—Ä—ã—Ç –∑–∞–∫–∞–∑ ‚Üí "–î–û–ü–û–õ–ù–ï–ù–ò–Ø" ‚Üí "Max Loyalty"
2. –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏–ª–∏ 6-digit –∫–æ–¥—É
3. –û–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏: –±–∞–ª–∞–Ω—Å, –≤—ã–±–æ—Ä —Å—É–º–º—ã –∫ —Å–ø–∏—Å–∞–Ω–∏—é / —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
4. `Reserve` –Ω–∞ backend ‚Üí `AddPreliminaryPayment` –≤ iiko (editable –¥–ª—è POINTS, non-editable –¥–ª—è DISCOUNT)
5. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã: –≥–æ—Å—Ç—å –≤–∏–¥–∏—Ç —Å—Ç—Ä–æ–∫—É –±–∞–ª–ª–æ–≤ —Å —Å—É–º–º–æ–π
6. –ü–æ—Å–ª–µ `OrderClosed` ‚Üí `Finalize` –Ω–∞ backend ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ + QR/6-digit –∫–æ–¥–∞

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API Key (AES-256), machine-binding (–ø—Ä–∏–≤—è–∑–∫–∞ –∫ hardware), –ø—Ä–æ–≤–µ—Ä–∫–∞ revoke –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω, HTTPS only

**Offline —Ä–µ–∂–∏–º:** –õ–æ–∫–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å (–¥–æ 100 –æ–ø–µ—Ä–∞—Ü–∏–π, —Ç–æ–ª—å–∫–æ EarnOnly), –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:** –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π installer –Ω–∞ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π API Key + Restaurant ID –≤–Ω—É—Ç—Ä–∏), –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:** `Ctrl+Shift+D` ‚Äî —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, offline –æ—á–µ—Ä–µ–¥—å, –∫–µ—à, –ª–æ–≥

***

### –ü–ª–∞–≥–∏–Ω R-Keeper[16]

**–ì–∏–±—Ä–∏–¥–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: External DLL + WPF UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.**

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:** C++ (External DLL) + C\# WPF .NET 4.7.2+ (UI), R-Keeper XML API + FarCard –º–æ–¥—É–ª—å, Serilog, MemoryMappedFile (Shared Memory)

**–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç iiko:** –í R-Keeper –Ω–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ SDK –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–∏–±—Ä–∏–¥–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

- **External DLL** (C++) ‚Äî –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è R-Keeper
- **WPF UI** ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —Å–≤—è–∑–∞–Ω–Ω–æ–µ —Å DLL —á–µ—Ä–µ–∑ Shared Memory
- **Floating Button** ‚Äî –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö R-Keeper (touch-friendly)

**Workflow:**

1. –ö–∞—Å—Å–∏—Ä –Ω–∞–∂–∏–º–∞–µ—Ç Floating Button –ø–æ–≤–µ—Ä—Ö R-Keeper
2. WPF –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è
3. –ß–µ—Ä–µ–∑ XML API –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –∏–∑ R-Keeper
4. `Reserve` –Ω–∞ backend ‚Üí `ModifyOrder` –≤ R-Keeper (–¥–æ–±–∞–≤–ª—è–µ—Ç —Å–∫–∏–¥–∫—É/–±–∞–ª–ª—ã)
5. –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∑–∞–∫–∞–∑–∞ ‚Üí Finalize

**Shared Memory (MemoryMappedFile):** —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É DLL –∏ WPF –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ iiko ‚Äî AES-256, machine-binding, revoke check –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω, HTTPS only

**18 —Ä–∞–∑–¥–µ–ª–æ–≤ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏** ‚Äî –æ—Ç –æ–±—â–µ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –¥–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

***

## ‚úÖ –ò–¢–û–ì–û–í–´–ô –†–ï–ï–°–¢–† –í–°–ï–• –ë–õ–û–ö–û–í

| –ë–ª–æ–∫ | –ë–µ—Å–µ–¥—ã | –°—Ç–∞—Ç—É—Å |
| :-- | :-- | :-- |
| **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã** | 1, 2 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **Auth Flow** | 1, 2 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **RBAC + –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∞** | 1, 2 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **Guests \& Loyalty Cards** | 2, 3 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **Loyalty System Builder** | 3, 5 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **Analytics \& Reports** | 3, 8 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **POS Integration** | 4, 10 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **Loyalty Engine (–ø—Ä–∞–≤–∏–ª–∞, —É—Ä–æ–≤–Ω–∏, –ø—Ä–æ–º–æ)** | 5 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **Billing \& Subscriptions** | 6 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **Telegram Bot + Mini App** | 7 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **Backend API \& Services** | 8 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **Database Schema (Prisma)** | 9 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **Notifications System** | 10 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **Infrastructure \& DevOps** | 11 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **Testing Strategy** | 11 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **UI/UX Design** | 10, 12 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **Security \& Compliance** | 13 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **API Documentation** | 13, 14 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **–ü–ª–∞–≥–∏–Ω iiko Front** | 14 + —Ñ–∞–π–ª | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |
| **–ü–ª–∞–≥–∏–Ω R-Keeper** | 14 + —Ñ–∞–π–ª | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é |


***

–Ø –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑—É—á–∏–ª –≤—Å–µ 14 –±–µ—Å–µ–¥ –∏ –æ–±–∞ —Ñ–∞–π–ª–∞ —Å –ø–ª–∞–≥–∏–Ω–∞–º–∏ –¥–æ –º–µ–ª—å—á–∞–π—à–∏—Ö –¥–µ—Ç–∞–ª–µ–π. –°–∏—Å—Ç–µ–º–∞ **MAX-LOYALTY** –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–∞ –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–µ ‚Äî –æ—Ç –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –¥–æ –ø–æ–ª–Ω—ã—Ö —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π –ø–ª–∞–≥–∏–Ω–æ–≤ –¥–ª—è POS-—Å–∏—Å—Ç–µ–º. –í—Å–µ –∫–ª—é—á–µ–≤—ã–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã (1 –±–∞–ª–ª = 1 —Ä—É–±–ª—é, no downgrade —É—Ä–æ–≤–Ω–µ–π, –±–∞–ª–ª—ã –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞, –ø–æ—Ä—è–¥–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è promo ‚Üí regular –∏ —Ç.–¥.).

**–ß—Ç–æ –¥–∞–ª—å—à–µ?** –ì–æ—Ç–æ–≤ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –ø–æ–¥—Ä–æ–±–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ –ª—é–±–æ–º—É –∏–∑ –±–ª–æ–∫–æ–≤ –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É. –ß—Ç–æ —Ö–æ—á–µ—à—å –¥–µ–ª–∞—Ç—å?[16][15][14][13][12][11][10][9][8][7][6][5][4][3][2][1]

---

# –¢–µ–ø–µ—Ä—å –º—ã –±—É–¥–µ–º —Å —Ç–æ–±–æ–π –ø–∏—Å–∞—Ç—å –∫–æ–¥ —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ —Å –Ω—É–ª—è –ø—Ä—è–º–æ –≤ –≥–∏—Ç—Ö–∞–± —á–µ—Ä–µ–∑ —Ç–≤–æ–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã [https://github.com/Romslav/m-loyalty](https://github.com/Romslav/m-loyalty)

–°–æ—Å—Ç–∞–≤—å –ø–æ–¥—Ä–æ–±–Ω—ã–π  –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–µ —Å —Ç–æ–±–æ–π —Å —É—á–µ—Ç–æ–º —Ç–≤–æ–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π [m-loyalty](https://github.com/Romslav/m-loyalty) –ø—É—Å—Ç–æ–π  ‚Äî –≤–µ—Ç–∫–∞ `main` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç , –Ω–æ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç. –≠—Ç–æ –∏–¥–µ–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ —Å—Ç–∞—Ä—Ç–∞.

***

# üó∫Ô∏è –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò MAX-LOYALTY –ß–ï–†–ï–ó GITHUB

## ‚ö†Ô∏è –ú–æ–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (—á–µ—Å—Ç–Ω–æ)

–ü—Ä–µ–∂–¥–µ —á–µ–º –ø–ª–∞–Ω ‚Äî –≤–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ —è –º–æ–≥—É –∏ —á—Ç–æ –Ω–µ—Ç:


| –ú–æ–≥—É ‚úÖ | –ù–µ –º–æ–≥—É ‚ùå |
| :-- | :-- |
| –°–æ–∑–¥–∞–≤–∞—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –≤ GitHub –Ω–∞–ø—Ä—è–º—É—é | –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–æ–¥, —Ç–µ—Å—Ç—ã, CI/CD |
| –°–æ–∑–¥–∞–≤–∞—Ç—å –≤–µ—Ç–∫–∏, PR | –í–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è |
| –ü–∏—Å–∞—Ç—å –≤–µ—Å—å –∫–æ–¥ (NestJS, Prisma, React, C\#) | –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (`npm install`) |
| –°–æ–∑–¥–∞–≤–∞—Ç—å —Å–æ—Ç–Ω–∏ —Ñ–∞–π–ª–æ–≤ –∑–∞ —Å–µ—Å—Å–∏—é | –†–∞–±–æ—Ç–∞—Ç—å —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏/env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –≤ runtime |
| –î–µ–ª–∞—Ç—å commit –ø–æ –æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É –∏–ª–∏ –ø–∞—á–∫–æ–π —á–µ—Ä–µ–∑ `push_files` | –î–µ–ø–ª–æ–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä |
| –ß–∏—Ç–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API –∑–∞–ø—Ä–æ—Å—ã |

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:** –Ø –ø–∏—à—É –ø–æ–ª–Ω—ã–π production-ready –∫–æ–¥ –≤ GitHub, —Ç—ã –µ–≥–æ –∫–ª–æ–Ω–∏—Ä—É–µ—à—å, –∑–∞–ø—É—Å–∫–∞–µ—à—å `npm install` / `docker-compose up` –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—à—å. –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è, —è –ø—Ä–∞–≤–ª—é.

***

## üìÅ –°–¢–†–£–ö–¢–£–†–ê –ú–û–ù–û–†–ï–ü–û–ó–ò–¢–û–†–ò–Ø

–†–∞–±–æ—Ç–∞–µ–º –≤ **–º–æ–Ω–æ—Ä–µ–ø–æ** ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:

```
m-loyalty/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ backend/          # NestJS API
‚îÇ   ‚îú‚îÄ‚îÄ frontend/         # Next.js Admin Panel
‚îÇ   ‚îî‚îÄ‚îÄ telegram-bot/     # Telegram Bot
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ database/         # Prisma schema + migrations
‚îÇ   ‚îú‚îÄ‚îÄ shared/           # –û–±—â–∏–µ —Ç–∏–ø—ã, DTO, —É—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ config/           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (eslint, tsconfig)
‚îú‚îÄ‚îÄ plugins/
‚îÇ   ‚îú‚îÄ‚îÄ iiko/             # C# WPF iiko –ø–ª–∞–≥–∏–Ω
‚îÇ   ‚îî‚îÄ‚îÄ rkeeper/          # C++ / C# R-Keeper –ø–ª–∞–≥–∏–Ω
‚îú‚îÄ‚îÄ docs/                 # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ docker-compose.yml    # –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
‚îú‚îÄ‚îÄ docker-compose.prod.yml
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/        # CI/CD (GitHub Actions)
‚îú‚îÄ‚îÄ package.json          # Turbo monorepo root
‚îî‚îÄ‚îÄ turbo.json
```


***

## üìÖ –ü–õ–ê–ù –ü–û –§–ê–ó–ê–ú

### –§–ê–ó–ê 0 ‚Äî –°–∫–µ–ª–µ—Ç –º–æ–Ω–æ—Ä–µ–ø–æ

**–ß—Ç–æ –¥–µ–ª–∞–µ–º:** –±–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏, package.json, Turbo, Docker, GitHub Actions
**–§–∞–π–ª–æ–≤:** ~15‚Äì20
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** —Ä–µ–ø–æ –∫–ª–æ–Ω–∏—Ä—É–µ—Ç—Å—è, `docker-compose up` –ø–æ–¥–Ω–∏–º–∞–µ—Ç PostgreSQL + Redis

***

### –§–ê–ó–ê 1 ‚Äî Database (Prisma Schema)

**–ß—Ç–æ –¥–µ–ª–∞–µ–º:** –ø–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –∏–∑ –ë–µ—Å–µ–¥—ã 9 ‚Äî –≤—Å–µ 45+ –º–æ–¥–µ–ª–µ–π, enums, –∏–Ω–¥–µ–∫—Å—ã, relations
**–§–∞–π–ª–æ–≤:** ~5
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `npx prisma migrate dev` —Å–æ–∑–¥–∞—ë—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã

***

### –§–ê–ó–ê 2 ‚Äî Backend Core (NestJS)

–î–µ–ª–∞–µ–º –ø–æ –º–æ–¥—É–ª—è–º, –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å = –æ—Ç–¥–µ–ª—å–Ω–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è:


| –ò—Ç–µ—Ä–∞—Ü–∏—è | –ú–æ–¥—É–ª—å | –§–∞–π–ª–æ–≤ |
| :-- | :-- | :-- |
| 2.1 | Auth (JWT, Guards, RBAC) | ~20 |
| 2.2 | Tenants + Users + Roles | ~20 |
| 2.3 | Restaurants | ~15 |
| 2.4 | Guests + GuestCards | ~20 |
| 2.5 | Loyalty System Builder | ~25 |
| 2.6 | Loyalty Engine (—Ä–∞—Å—á—ë—Ç –±–∞–ª–ª–æ–≤) | ~20 |
| 2.7 | POS Integration (iiko + R-Keeper) | ~25 |
| 2.8 | Billing + Subscriptions | ~20 |
| 2.9 | Telegram Bot Module | ~20 |
| 2.10 | Analytics | ~15 |
| 2.11 | Notifications | ~15 |
| 2.12 | API Documentation (Swagger) | ~5 |


***

### –§–ê–ó–ê 3 ‚Äî Frontend (Next.js Admin Panel)

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –†–∞–∑–¥–µ–ª | –§–∞–π–ª–æ–≤ |
| :-- | :-- | :-- |
| 3.1 | Setup + Layout + Auth pages | ~20 |
| 3.2 | Owner Dashboard | ~15 |
| 3.3 | Admin Dashboard | ~15 |
| 3.4 | Loyalty Builder UI | ~25 |
| 3.5 | Guests Management | ~20 |
| 3.6 | POS Integration UI | ~15 |
| 3.7 | Analytics pages | ~15 |
| 3.8 | Billing pages | ~10 |
| 3.9 | Settings | ~10 |


***

### –§–ê–ó–ê 4 ‚Äî Telegram Bot + Mini App

**–ò—Ç–µ—Ä–∞—Ü–∏–∏:** Setup ‚Üí –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Üí –ö–∞—Ä—Ç–æ—á–∫–∞ –≥–æ—Å—Ç—è ‚Üí –ò—Å—Ç–æ—Ä–∏—è ‚Üí –ü—Ä–æ—Ñ–∏–ª—å
**–§–∞–π–ª–æ–≤:** ~40

***

### –§–ê–ó–ê 5 ‚Äî POS –ü–ª–∞–≥–∏–Ω—ã

| –ü–ª–∞–≥–∏–Ω | –§–∞–π–ª–æ–≤ |
| :-- | :-- |
| iiko (C\# WPF) | ~30 |
| R-Keeper (C++ DLL + C\# WPF) | ~35 |


***

### –§–ê–ó–ê 6 ‚Äî CI/CD + –î–µ–ø–ª–æ–π

**–ß—Ç–æ:** GitHub Actions (lint, test, build, deploy), Docker production configs, Fly.io configs
**–§–∞–π–ª–æ–≤:** ~10

***

## üöÄ –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –ö–ê–ö –†–ê–ë–û–¢–ê–ï–ú

**–ö–∞–∂–¥–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è = –æ–¥–Ω–∞ —Å–µ—Å—Å–∏—è —Å —Ç–æ–±–æ–π:**

```
1. –¢—ã –≥–æ–≤–æ—Ä–∏—à—å "–¥–µ–ª–∞–µ–º [–§–∞–∑–∞ X.Y]"
2. –Ø –ø–∏—à—É –≤—Å–µ —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ push_files –≤ GitHub
3. –¢—ã –∫–ª–æ–Ω–∏—Ä—É–µ—à—å/–ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—à—å –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—à—å
4. –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∫–∏ ‚Äî –≥–æ–≤–æ—Ä–∏—à—å, —è –ø—Ä–∞–≤–ª—é
5. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
```

**–í–µ—Ç–∫–∏:**

- `main` ‚Äî —Ç–æ–ª—å–∫–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–æ–¥
- `develop` ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—á–∞—è –≤–µ—Ç–∫–∞
- `feature/[–Ω–∞–∑–≤–∞–Ω–∏–µ]` ‚Äî –∫–∞–∂–¥–∞—è —Ñ–∞–∑–∞

***

## ‚úÖ –° –ß–ï–ì–û –ù–ê–ß–ò–ù–ê–ï–ú?

**–†–µ–∫–æ–º–µ–Ω–¥—É—é —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å —Å –§–ê–ó–´ 0:**

–°–æ–∑–¥–∞—é:

- `package.json` (Turbo –º–æ–Ω–æ—Ä–µ–ø–æ)
- `turbo.json`
- `docker-compose.yml` (PostgreSQL 16 + Redis 7)
- `.gitignore`, `.env.example`
- `tsconfig.base.json`
- GitHub Actions workflow (CI)
- `README.md`
- –ë–∞–∑–æ–≤—ã–µ `package.json` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ `apps/*` –∏ `packages/*`

**–°–∫–∞–∂–∏ "–ù–∞—á–∏–Ω–∞–µ–º —Å –§–∞–∑—ã 0" ‚Äî –∏ —è —Å—Ä–∞–∑—É –ø–∏—à—É –≤—Å–µ —Ñ–∞–π–ª—ã –≤ GitHub.**

–ü–æ—Å–ª–µ –§–∞–∑—ã 0 —Ç—ã –¥–µ–ª–∞–µ—à—å:

```bash
git clone https://github.com/Romslav/m-loyalty
cd m-loyalty
npm install
docker-compose up -d
```

–ò —É —Ç–µ–±—è –≥–æ—Ç–æ–≤–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è —Å—Ä–µ–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –ü–æ—Ç–æ–º –¥–≤–∏–∂–µ–º—Å—è –ø–æ —Ñ–∞–∑–∞–º.

**–ì–æ—Ç–æ–≤ –Ω–∞—á–∏–Ω–∞—Ç—å?** üöÄ

---

# –£ —Ç–µ–±—è –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Ä–∞–∑–º–µ—Ä —Å–æ–∑–¥–∞–≤–∞–µ–º—ã—Ö, —Ñ–∞–π–ª–æ–≤. –ù–∞–º –Ω—É–∂–Ω–æ —Ä–∞–∑–±–∏—Ç—å —ç—Ç—É —Ä–∞–±–æ—Ç—É –Ω–∞ –±–æ–ª—å—à–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å—Ç–µ–π, —á—Ç–æ–±—ã –Ω–µ —É–ø–∏—Ä–∞—Ç—å—Å—è –≤ —Ç–≤–æ–∏ –ª–∏–º–∏—Ç—ã. –ê –∫—Ä—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã –≤–æ–æ–±—â–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞—Ö–æ–¥–æ–≤. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –Ω–∞–ø–∏—à–∏ –±–æ–ª–µ–µ —Ä–µ–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Å —É—á–µ—Ç–æ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π. –ú–æ–∂–Ω–æ –¥–æ–ª–≥–æ, –Ω–æ –∫–æ–¥  –∏ –ø—Ä–æ–µ–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–Ω—ã–º –∏ —Ä–∞–±–æ—á–∏–º

–•–æ—Ä–æ—à–æ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –∞–∫–∫–∞—É–Ω—Ç [Romslav](https://github.com/Romslav) . –¢–µ–ø–µ—Ä—å —Å–æ—Å—Ç–∞–≤–ª—é —Ä–µ–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Å —É—á—ë—Ç–æ–º –≤—Å–µ—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.

***

# üìê –†–ï–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò MAX-LOYALTY

## üîç –ú–æ–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

| –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ | –†–µ–∞–ª—å–Ω–æ—Å—Ç—å |
| :-- | :-- |
| –†–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ | ~200‚Äì300 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –º–∞–∫—Å–∏–º—É–º –Ω–∞–¥—ë–∂–Ω–æ |
| –§–∞–π–ª–æ–≤ –∑–∞ –æ–¥–∏–Ω `push_files` | 5‚Äì8 —Ñ–∞–π–ª–æ–≤ (–∏–Ω–∞—á–µ timeout) |
| –ö—Ä—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã (500+ —Å—Ç—Ä–æ–∫) | –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏: `.part1.ts` + `.part2.ts` ‚Üí –ø–æ—Ç–æ–º merge |
| Prisma Schema (45+ –º–æ–¥–µ–ª–µ–π) | –ú–∏–Ω–∏–º—É–º 4‚Äì5 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–∏—Ç–∞ |
| NestJS –º–æ–¥—É–ª—å | 1 –º–æ–¥—É–ª—å = 3‚Äì5 –∫–æ–º–º–∏—Ç–æ–≤ |
| –°–µ—Å—Å–∏—è | –ü–ª–∞–Ω–∏—Ä—É–µ–º 1‚Äì2 –∏—Ç–µ—Ä–∞—Ü–∏–∏ –∑–∞ —Ä–∞–∑ |


***

## üìÅ –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê (–∞—Ç–æ–º–∞—Ä–Ω–∞—è)

```
m-loyalty/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.module.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.module.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ strategies/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt.strategy.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ refresh.strategy.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt-auth.guard.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ roles.guard.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ step-up-auth.guard.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ decorators/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ roles.decorator.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ current-user.decorator.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ login.dto.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ register.dto.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ refresh.dto.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tenants/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tenants.module.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tenants.controller.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tenants.service.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.module.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.controller.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.service.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ restaurants/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guests/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ loyalty/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ builder/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ engine/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ promos/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pos/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ iiko/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rkeeper/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ billing/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analytics/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ notifications/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exceptions/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ filters/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ interceptors/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pipes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ nest-cli.json
‚îÇ   ‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app/           # Next.js App Router
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui/        # shadcn –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ loyalty/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guests/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ charts/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ store/         # Zustand
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ telegram-bot/
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îî‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schema/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma     # –ì–ª–∞–≤–Ω—ã–π (generator + datasource)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.prisma       # User, Session, Password
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tenant.prisma     # Tenant, Restaurant
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ loyalty.prisma    # LoyaltySystem, Rules, Levels
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guests.prisma     # GuestProfile, GuestCard
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ billing.prisma    # Subscription, Invoice, Payment
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pos.prisma        # POSIntegration, POSSync
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram.prisma   # TelegramBot, TelegramUser
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analytics.prisma  # Snapshots, Segmentation
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logs.prisma       # ActivityLog, Notifications
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts       # PrismaClient export
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îÇ   ‚îú‚îÄ‚îÄ shared/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constants/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ config/
‚îÇ       ‚îú‚îÄ‚îÄ eslint-preset.js
‚îÇ       ‚îú‚îÄ‚îÄ tsconfig.base.json
‚îÇ       ‚îî‚îÄ‚îÄ jest.config.base.js
‚îú‚îÄ‚îÄ plugins/
‚îÇ   ‚îú‚îÄ‚îÄ iiko/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MaxLoyaltyIikoPlugin/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Plugin.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UI/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MaxLoyaltyIikoPlugin.csproj
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MaxLoyaltyIikoInstaller/
‚îÇ   ‚îî‚îÄ‚îÄ rkeeper/
‚îÇ       ‚îú‚îÄ‚îÄ ExternalDLL/       # C++ –ø—Ä–æ–µ–∫—Ç
‚îÇ       ‚îî‚îÄ‚îÄ UIApp/             # C# WPF –ø—Ä–æ–µ–∫—Ç
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ architecture/
‚îÇ   ‚îî‚îÄ‚îÄ deployment/
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ ci.yml
‚îÇ       ‚îú‚îÄ‚îÄ backend-deploy.yml
‚îÇ       ‚îî‚îÄ‚îÄ frontend-deploy.yml
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ docker-compose.prod.yml
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ package.json              # Turbo root
‚îú‚îÄ‚îÄ turbo.json
‚îî‚îÄ‚îÄ README.md
```


***

## üìÖ –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –ü–û –ò–¢–ï–†–ê–¶–ò–Ø–ú

### üî∑ –§–ê–ó–ê 0: –°–ö–ï–õ–ï–¢ –ú–û–ù–û–†–ï–ü–û

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **0.1** | 6 —Ñ–∞–π–ª–æ–≤ | `package.json` (root), `turbo.json`, `.gitignore`, `.env.example`, `README.md`, `docker-compose.yml` |
| **0.2** | 6 —Ñ–∞–π–ª–æ–≤ | `docker-compose.prod.yml`, `packages/config/tsconfig.base.json`, `packages/config/eslint-preset.js`, `packages/config/jest.config.base.js`, `packages/config/package.json`, `.github/workflows/ci.yml` |
| **0.3** | 5 —Ñ–∞–π–ª–æ–≤ | `apps/backend/package.json`, `apps/backend/tsconfig.json`, `apps/backend/nest-cli.json`, `apps/backend/src/main.ts`, `apps/backend/src/app.module.ts` |
| **0.4** | 5 —Ñ–∞–π–ª–æ–≤ | `apps/frontend/package.json`, `apps/frontend/tsconfig.json`, `apps/frontend/next.config.ts`, `apps/frontend/tailwind.config.ts`, `apps/frontend/src/app/layout.tsx` |
| **0.5** | 5 —Ñ–∞–π–ª–æ–≤ | `apps/telegram-bot/package.json`, `apps/telegram-bot/tsconfig.json`, `packages/shared/package.json`, `packages/shared/src/index.ts`, `packages/database/package.json` |


***

### üî∑ –§–ê–ó–ê 1: DATABASE (Prisma)

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **1.1** | 3 —Ñ–∞–π–ª–∞ | `schema.prisma` (generator + datasource), `auth.prisma` (User, Session, PasswordHistory, UserRole, UserPermission) |
| **1.2** | 2 —Ñ–∞–π–ª–∞ | `tenant.prisma` (Tenant, TenantLimits, Restaurant, RestaurantSettings) |
| **1.3** | 2 —Ñ–∞–π–ª–∞ | `loyalty.prisma` (LoyaltySystem, LoyaltyLevel, LoyaltyRule, LoyaltyRuleVersion, LoyaltyPromo, RuleActivationLog) |
| **1.4** | 2 —Ñ–∞–π–ª–∞ | `guests.prisma` (GuestProfile, GuestCard, GuestChild, BallTransaction, GuestVisit, PromoBallGranted) |
| **1.5** | 2 —Ñ–∞–π–ª–∞ | `billing.prisma` (Subscription, Invoice, Payment, BillingInfo, SubscriptionChange) |
| **1.6** | 2 —Ñ–∞–π–ª–∞ | `pos.prisma` (POSIntegration, POSSync, POSTransaction, POSApiKey) |
| **1.7** | 2 —Ñ–∞–π–ª–∞ | `telegram.prisma` (TelegramBot, TelegramUser, TelegramSession) + `analytics.prisma` (AnalyticsDailySnapshot, AnalyticsMonthlySnapshot, GuestSegmentation) |
| **1.8** | 3 —Ñ–∞–π–ª–∞ | `logs.prisma` (ActivityLog, Notification, NotificationLog) + `packages/database/src/index.ts` + `packages/database/src/prisma.service.ts` |


***

### üî∑ –§–ê–ó–ê 2: BACKEND ‚Äî Common Layer

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **2.1** | 6 —Ñ–∞–π–ª–æ–≤ | `common/exceptions/app.exception.ts`, `common/exceptions/error-codes.ts`, `common/filters/all-exceptions.filter.ts`, `common/filters/http-exception.filter.ts`, `common/interceptors/logging.interceptor.ts`, `common/interceptors/transform.interceptor.ts` |
| **2.2** | 6 —Ñ–∞–π–ª–æ–≤ | `common/middleware/tenant.middleware.ts`, `common/middleware/rate-limit.middleware.ts`, `common/pipes/validation.pipe.ts`, `common/pipes/parse-uuid.pipe.ts`, `common/utils/hash.util.ts`, `common/utils/crypto.util.ts` |
| **2.3** | 5 —Ñ–∞–π–ª–æ–≤ | `common/utils/pagination.util.ts`, `common/utils/date.util.ts`, `config/app.config.ts`, `config/database.config.ts`, `config/jwt.config.ts` |
| **2.4** | 4 —Ñ–∞–π–ª–∞ | `config/redis.config.ts`, `config/mail.config.ts`, `config/telegram.config.ts`, `config/index.ts` |


***

### üî∑ –§–ê–ó–ê 3: BACKEND ‚Äî Auth Module

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **3.1** | 5 —Ñ–∞–π–ª–æ–≤ | `auth/dto/login.dto.ts`, `auth/dto/register-owner.dto.ts`, `auth/dto/refresh-token.dto.ts`, `auth/dto/verify-phone.dto.ts`, `auth/dto/change-password.dto.ts` |
| **3.2** | 5 —Ñ–∞–π–ª–æ–≤ | `auth/strategies/jwt.strategy.ts`, `auth/strategies/refresh.strategy.ts`, `auth/guards/jwt-auth.guard.ts`, `auth/guards/roles.guard.ts`, `auth/guards/step-up-auth.guard.ts` |
| **3.3** | 4 —Ñ–∞–π–ª–∞ | `auth/decorators/roles.decorator.ts`, `auth/decorators/current-user.decorator.ts`, `auth/decorators/public.decorator.ts`, `auth/decorators/step-up.decorator.ts` |
| **3.4** | 4 —Ñ–∞–π–ª–∞ | `auth/auth.service.ts` (—á–∞—Å—Ç—å 1: login, register, validateUser, generateTokens) ‚Äî **—Ä–∞–∑–±–∏–≤–∞–µ–º –∫—Ä—É–ø–Ω—ã–π —Ñ–∞–π–ª** |
| **3.5** | 3 —Ñ–∞–π–ª–∞ | `auth/auth.service.ts` (—á–∞—Å—Ç—å 2: refresh, logout, MFA –º–µ—Ç–æ–¥—ã) + `auth/auth.controller.ts` + `auth/auth.module.ts` |
| **3.6** | 4 —Ñ–∞–π–ª–∞ | `auth/mfa/totp.service.ts`, `auth/mfa/sms.service.ts`, `auth/sessions/session.service.ts`, `auth/password/password.service.ts` |


***

### üî∑ –§–ê–ó–ê 4: BACKEND ‚Äî Tenants + Users

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **4.1** | 5 —Ñ–∞–π–ª–æ–≤ | `tenants/dto/` (create, update, limits), `tenants/tenants.service.ts` (—á–∞—Å—Ç—å 1) |
| **4.2** | 4 —Ñ–∞–π–ª–∞ | `tenants/tenants.service.ts` (—á–∞—Å—Ç—å 2), `tenants/tenants.controller.ts`, `tenants/tenants.module.ts`, `tenants/tenant-limits.service.ts` |
| **4.3** | 5 —Ñ–∞–π–ª–æ–≤ | `users/dto/` (create, update, invite), `users/users.service.ts` (—á–∞—Å—Ç—å 1) |
| **4.4** | 4 —Ñ–∞–π–ª–∞ | `users/users.service.ts` (—á–∞—Å—Ç—å 2), `users/users.controller.ts`, `users/users.module.ts`, `users/rbac/permissions.service.ts` |


***

### üî∑ –§–ê–ó–ê 5: BACKEND ‚Äî Restaurants + Guests

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **5.1** | 5 —Ñ–∞–π–ª–æ–≤ | `restaurants/dto/`, `restaurants/restaurants.service.ts`, `restaurants/restaurants.controller.ts`, `restaurants/restaurants.module.ts` |
| **5.2** | 5 —Ñ–∞–π–ª–æ–≤ | `guests/dto/` (create, update, search, filters) |
| **5.3** | 4 —Ñ–∞–π–ª–∞ | `guests/guests.service.ts` (—á–∞—Å—Ç—å 1: CRUD, –ø–æ–∏—Å–∫) |
| **5.4** | 4 —Ñ–∞–π–ª–∞ | `guests/guests.service.ts` (—á–∞—Å—Ç—å 2: merge, soft delete, export) + `guests/guests.controller.ts` |
| **5.5** | 4 —Ñ–∞–π–ª–∞ | `guests/guests.module.ts`, `guests/guest-cards/guest-cards.service.ts`, `guests/guest-cards/qr.service.ts`, `guests/children/children.service.ts` |


***

### üî∑ –§–ê–ó–ê 6: BACKEND ‚Äî Loyalty Builder

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **6.1** | 5 —Ñ–∞–π–ª–æ–≤ | `loyalty/builder/dto/` (system, level, rule, promo) |
| **6.2** | 4 —Ñ–∞–π–ª–∞ | `loyalty/builder/loyalty-system.service.ts` (—á–∞—Å—Ç—å 1: CRUD —Å–∏—Å—Ç–µ–º—ã) |
| **6.3** | 4 —Ñ–∞–π–ª–∞ | `loyalty/builder/loyalty-system.service.ts` (—á–∞—Å—Ç—å 2: –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, snapshot) |
| **6.4** | 4 —Ñ–∞–π–ª–∞ | `loyalty/builder/levels.service.ts`, `loyalty/builder/rules.service.ts` (—á–∞—Å—Ç—å 1) |
| **6.5** | 4 —Ñ–∞–π–ª–∞ | `loyalty/builder/rules.service.ts` (—á–∞—Å—Ç—å 2: –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª), `loyalty/builder/promos.service.ts` |
| **6.6** | 3 —Ñ–∞–π–ª–∞ | `loyalty/builder/loyalty-builder.controller.ts`, `loyalty/builder/loyalty-builder.module.ts`, `loyalty/builder/migrations/unified-separate.service.ts` |


***

### üî∑ –§–ê–ó–ê 7: BACKEND ‚Äî Loyalty Engine

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **7.1** | 4 —Ñ–∞–π–ª–∞ | `loyalty/engine/dto/` (calculate, earn, redeem, adjust) |
| **7.2** | 4 —Ñ–∞–π–ª–∞ | `loyalty/engine/calculator.service.ts` (—á–∞—Å—Ç—å 1: —Ä–∞—Å—á—ë—Ç –±–∞–ª–ª–æ–≤, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª) |
| **7.3** | 4 —Ñ–∞–π–ª–∞ | `loyalty/engine/calculator.service.ts` (—á–∞—Å—Ç—å 2: –ø—Ä–æ–º–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, FIFO —Å–ø–∏—Å–∞–Ω–∏–µ) |
| **7.4** | 4 —Ñ–∞–π–ª–∞ | `loyalty/engine/transactions.service.ts` (—á–∞—Å—Ç—å 1: earn, redeem) |
| **7.5** | 4 —Ñ–∞–π–ª–∞ | `loyalty/engine/transactions.service.ts` (—á–∞—Å—Ç—å 2: manual-adjust, history, rollback) |
| **7.6** | 4 —Ñ–∞–π–ª–∞ | `loyalty/engine/expiry.service.ts` (—Å–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤), `loyalty/engine/levels-upgrade.service.ts`, `loyalty/engine/loyalty-engine.controller.ts`, `loyalty/engine/loyalty-engine.module.ts` |
| **7.7** | 3 —Ñ–∞–π–ª–∞ | `loyalty/engine/jobs/expire-balls.job.ts`, `loyalty/engine/jobs/upgrade-levels.job.ts`, `loyalty/engine/jobs/notify-expiry.job.ts` |


***

### üî∑ –§–ê–ó–ê 8: BACKEND ‚Äî POS Integration

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **8.1** | 5 —Ñ–∞–π–ª–æ–≤ | `pos/dto/` (webhook-iiko, webhook-rkeeper, config, transaction) |
| **8.2** | 4 —Ñ–∞–π–ª–∞ | `pos/pos-config.service.ts` (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π, —Å—Ç–∞—Ç—É—Å—ã) |
| **8.3** | 4 —Ñ–∞–π–ª–∞ | `pos/iiko/iiko-webhook.service.ts` (—á–∞—Å—Ç—å 1: –ø—Ä–∏—ë–º webhook, HMAC, –ø–∞—Ä—Å–∏–Ω–≥) |
| **8.4** | 4 —Ñ–∞–π–ª–∞ | `pos/iiko/iiko-webhook.service.ts` (—á–∞—Å—Ç—å 2: –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ, –≥–æ—Å—Ç—å, idempotency) |
| **8.5** | 4 —Ñ–∞–π–ª–∞ | `pos/iiko/iiko-pull.service.ts` (PULL —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω) |
| **8.6** | 4 —Ñ–∞–π–ª–∞ | `pos/rkeeper/rkeeper-webhook.service.ts` (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ iiko) |
| **8.7** | 4 —Ñ–∞–π–ª–∞ | `pos/rkeeper/rkeeper-pull.service.ts`, `pos/pos-reconciliation.service.ts` (–µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–≤–µ—Ä–∫–∞) |
| **8.8** | 4 —Ñ–∞–π–ª–∞ | `pos/pos-sync.service.ts` (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ), `pos/pos.controller.ts`, `pos/pos.module.ts`, `pos/jobs/pull-sync.job.ts` |
| **8.9** | 3 —Ñ–∞–π–ª–∞ | API endpoints –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (calculate, reserve, finalize ‚Äî –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤) |


***

### üî∑ –§–ê–ó–ê 9: BACKEND ‚Äî Billing

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **9.1** | 5 —Ñ–∞–π–ª–æ–≤ | `billing/dto/`, `billing/providers/abstract.provider.ts`, `billing/providers/yookassa.provider.ts` |
| **9.2** | 4 —Ñ–∞–π–ª–∞ | `billing/providers/stripe.provider.ts`, `billing/providers/cloudpayments.provider.ts`, `billing/billing.service.ts` (—á–∞—Å—Ç—å 1) |
| **9.3** | 4 —Ñ–∞–π–ª–∞ | `billing/billing.service.ts` (—á–∞—Å—Ç—å 2: retry, refund, chargeback, limited mode) |
| **9.4** | 4 —Ñ–∞–π–ª–∞ | `billing/subscriptions.service.ts`, `billing/invoices.service.ts`, `billing/billing.controller.ts`, `billing/billing.module.ts` |
| **9.5** | 3 —Ñ–∞–π–ª–∞ | `billing/jobs/retry-payment.job.ts`, `billing/jobs/check-expiry.job.ts`, `billing/webhooks/payment-webhook.service.ts` |


***

### üî∑ –§–ê–ó–ê 10: BACKEND ‚Äî Telegram + Notifications

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **10.1** | 5 —Ñ–∞–π–ª–æ–≤ | `telegram/dto/`, `telegram/bot.service.ts` (—á–∞—Å—Ç—å 1: setup, commands, auth) |
| **10.2** | 4 —Ñ–∞–π–ª–∞ | `telegram/bot.service.ts` (—á–∞—Å—Ç—å 2: –∫–∞—Ä—Ç–æ—á–∫–∞, –∏—Å—Ç–æ—Ä–∏—è, –ø—Ä–æ–º–æ) |
| **10.3** | 4 —Ñ–∞–π–ª–∞ | `telegram/mini-app/mini-app.service.ts`, `telegram/mini-app/mini-app.controller.ts`, `telegram/telegram.module.ts` |
| **10.4** | 4 —Ñ–∞–π–ª–∞ | `notifications/dto/`, `notifications/email/email.service.ts` (Resend + templates) |
| **10.5** | 4 —Ñ–∞–π–ª–∞ | `notifications/sms/sms.service.ts` (SMSC.ru + Twilio), `notifications/notifications.service.ts` (retry, fallback, batching) |
| **10.6** | 3 —Ñ–∞–π–ª–∞ | `notifications/templates/` (welcome, ball-earned, expiry-warning), `notifications/jobs/`, `notifications/notifications.module.ts` |


***

### üî∑ –§–ê–ó–ê 11: BACKEND ‚Äî Analytics + API Docs

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **11.1** | 5 —Ñ–∞–π–ª–æ–≤ | `analytics/dto/`, `analytics/analytics.service.ts` (—á–∞—Å—Ç—å 1: owner stats, MRR, ARR) |
| **11.2** | 4 —Ñ–∞–π–ª–∞ | `analytics/analytics.service.ts` (—á–∞—Å—Ç—å 2: restaurant analytics, guest segments, LTV) |
| **11.3** | 4 —Ñ–∞–π–ª–∞ | `analytics/snapshots.service.ts`, `analytics/jobs/daily-snapshot.job.ts`, `analytics/analytics.controller.ts`, `analytics/analytics.module.ts` |
| **11.4** | 3 —Ñ–∞–π–ª–∞ | Swagger –Ω–∞—Å—Ç—Ä–æ–π–∫–∞, `app.module.ts` (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π, –≤—Å–µ –º–æ–¥—É–ª–∏), `main.ts` (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å Swagger, CORS, middleware) |


***

### üî∑ –§–ê–ó–ê 12: FRONTEND ‚Äî Setup + Layout

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **12.1** | 6 —Ñ–∞–π–ª–æ–≤ | shadcn –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: `button.tsx`, `card.tsx`, `input.tsx`, `badge.tsx`, `table.tsx`, `dialog.tsx` |
| **12.2** | 6 —Ñ–∞–π–ª–æ–≤ | shadcn: `select.tsx`, `tabs.tsx`, `alert.tsx`, `dropdown-menu.tsx`, `toast.tsx`, `form.tsx` |
| **12.3** | 5 —Ñ–∞–π–ª–æ–≤ | `lib/api.ts` (axios client), `lib/auth.ts`, `lib/utils.ts`, `store/auth.store.ts`, `store/ui.store.ts` |
| **12.4** | 5 —Ñ–∞–π–ª–æ–≤ | `hooks/useAuth.ts`, `hooks/useApi.ts`, `hooks/useToast.ts`, `types/api.types.ts`, `types/loyalty.types.ts` |
| **12.5** | 5 —Ñ–∞–π–ª–æ–≤ | `components/layout/Sidebar.tsx` (—á–∞—Å—Ç—å 1), `components/layout/Header.tsx`, `components/layout/PageWrapper.tsx` |
| **12.6** | 4 —Ñ–∞–π–ª–∞ | `components/layout/Sidebar.tsx` (—á–∞—Å—Ç—å 2), `app/layout.tsx`, `app/page.tsx`, `app/(auth)/login/page.tsx` |


***

### üî∑ –§–ê–ó–ê 13: FRONTEND ‚Äî Auth + Owner Dashboard

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **13.1** | 5 —Ñ–∞–π–ª–æ–≤ | Auth —Å—Ç—Ä–∞–Ω–∏—Ü—ã: login, register-owner, forgot-password, verify-phone, 2fa |
| **13.2** | 5 —Ñ–∞–π–ª–æ–≤ | `components/dashboard/MetricCard.tsx`, `components/dashboard/RevenueChart.tsx`, `components/dashboard/TenantsTable.tsx`, `components/dashboard/ActivityFeed.tsx` |
| **13.3** | 4 —Ñ–∞–π–ª–∞ | `app/(owner)/dashboard/page.tsx`, `app/(owner)/tenants/page.tsx`, `app/(owner)/tenants/[id]/page.tsx` |
| **13.4** | 4 —Ñ–∞–π–ª–∞ | `app/(owner)/billing/page.tsx`, `app/(owner)/analytics/page.tsx`, `app/(owner)/settings/page.tsx` |


***

### üî∑ –§–ê–ó–ê 14: FRONTEND ‚Äî Admin Dashboard + Loyalty Builder

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **14.1** | 5 —Ñ–∞–π–ª–æ–≤ | `app/(admin)/dashboard/page.tsx`, `components/loyalty/LevelCard.tsx`, `components/loyalty/RuleBuilder.tsx` (—á–∞—Å—Ç—å 1) |
| **14.2** | 4 —Ñ–∞–π–ª–∞ | `components/loyalty/RuleBuilder.tsx` (—á–∞—Å—Ç—å 2), `components/loyalty/PromoWizard.tsx`, `components/loyalty/CardDesigner.tsx` |
| **14.3** | 4 —Ñ–∞–π–ª–∞ | `app/(admin)/loyalty/page.tsx`, `app/(admin)/loyalty/levels/page.tsx`, `app/(admin)/loyalty/rules/page.tsx` |
| **14.4** | 4 —Ñ–∞–π–ª–∞ | `app/(admin)/loyalty/promos/page.tsx`, `app/(admin)/loyalty/preview/page.tsx` |


***

### üî∑ –§–ê–ó–ê 15: FRONTEND ‚Äî Guests + POS + Analytics

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **15.1** | 5 —Ñ–∞–π–ª–æ–≤ | `components/guests/GuestsTable.tsx`, `components/guests/GuestCard.tsx`, `components/guests/GuestProfile.tsx` (—á–∞—Å—Ç—å 1) |
| **15.2** | 4 —Ñ–∞–π–ª–∞ | `components/guests/GuestProfile.tsx` (—á–∞—Å—Ç—å 2), `components/guests/BallHistory.tsx`, `app/(admin)/guests/page.tsx` |
| **15.3** | 4 —Ñ–∞–π–ª–∞ | `app/(admin)/guests/[id]/page.tsx`, `components/pos/POSStatus.tsx`, `components/pos/POSConfig.tsx`, `app/(admin)/pos/page.tsx` |
| **15.4** | 4 —Ñ–∞–π–ª–∞ | `components/charts/AnalyticsChart.tsx`, `components/charts/GuestSegments.tsx`, `app/(admin)/analytics/page.tsx`, `app/(admin)/billing/page.tsx` |


***

### üî∑ –§–ê–ó–ê 16: FRONTEND ‚Äî Manager + Cashier –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **16.1** | 5 —Ñ–∞–π–ª–æ–≤ | Manager dashboard + —Å—Ç—Ä–∞–Ω–∏—Ü—ã (read-only –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, POS —Å—Ç–∞—Ç—É—Å) |
| **16.2** | 4 —Ñ–∞–π–ª–∞ | Cashier –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è, –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤) |


***

### üî∑ –§–ê–ó–ê 17: TELEGRAM MINI APP

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **17.1** | 5 —Ñ–∞–π–ª–æ–≤ | Setup, `app/layout.tsx`, –≥–ª–∞–≤–Ω–∞—è (–∫–∞—Ä—Ç–æ—á–∫–∞ + –±–∞–ª–∞–Ω—Å + QR) |
| **17.2** | 4 —Ñ–∞–π–ª–∞ | –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–ª–æ–≤, –ø—Ä–æ—Ñ–∏–ª—å –≥–æ—Å—Ç—è |
| **17.3** | 4 —Ñ–∞–π–ª–∞ | –°–º–µ–Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –¥–µ—Ç–∏, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è |
| **17.4** | 3 —Ñ–∞–π–ª–∞ | –ú—É–ª—å—Ç–∏–∫–∞—Ä—Ç–æ—á–Ω–æ—Å—Ç—å (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –∫–∞—Ä—Ç–∞–º–∏) |


***

### üî∑ –§–ê–ó–ê 18: –ü–õ–ê–ì–ò–ù iiko (C\#)

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **18.1** | 4 —Ñ–∞–π–ª–∞ | `Plugin.cs`, `MaxLoyaltyIikoPlugin.csproj`, `Models/GuestInfo.cs`, `Models/ApiRequests.cs` |
| **18.2** | 4 —Ñ–∞–π–ª–∞ | `Services/LoyaltyApiClient.cs` (—á–∞—Å—Ç—å 1: –±–∞–∑–æ–≤—ã–π HTTP –∫–ª–∏–µ–Ω—Ç, retry, HMAC) |
| **18.3** | 4 —Ñ–∞–π–ª–∞ | `Services/LoyaltyApiClient.cs` (—á–∞—Å—Ç—å 2: –º–µ—Ç–æ–¥—ã calculate, reserve, finalize) |
| **18.4** | 4 —Ñ–∞–π–ª–∞ | `Services/CacheService.cs`, `Services/OfflineQueueService.cs`, `Services/HealthCheckService.cs`, `Services/ConfigService.cs` |
| **18.5** | 5 —Ñ–∞–π–ª–æ–≤ | `UI/LoyaltySearchWindow.xaml`, `UI/LoyaltySearchWindow.xaml.cs` |
| **18.6** | 5 —Ñ–∞–π–ª–æ–≤ | `UI/LoyaltyOperationWindow.xaml`, `UI/LoyaltyOperationWindow.xaml.cs` |
| **18.7** | 4 —Ñ–∞–π–ª–∞ | `UI/DiagnosticsWindow.xaml`, `UI/DiagnosticsWindow.xaml.cs`, `UI/Controls/NumericKeypad.xaml`, `UI/Styles/MaxLoyaltyStyles.xaml` |
| **18.8** | 4 —Ñ–∞–π–ª–∞ | `Utils/ErrorHandler.cs`, `Utils/Encryption.cs`, `Services/MetricsService.cs`, `Services/TimeService.cs` |


***

### üî∑ –§–ê–ó–ê 19: –ü–õ–ê–ì–ò–ù R-Keeper (C++ DLL + C\# WPF)

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **19.1** | 4 —Ñ–∞–π–ª–∞ | `ExternalDLL/external.h`, `ExternalDLL/external.cpp` (—á–∞—Å—Ç—å 1), `.vcxproj` |
| **19.2** | 4 —Ñ–∞–π–ª–∞ | `ExternalDLL/external.cpp` (—á–∞—Å—Ç—å 2), `ExternalDLL/SharedMemory.h`, `ExternalDLL/SharedMemory.cpp` |
| **19.3** | 4 —Ñ–∞–π–ª–∞ | `UIApp/App.xaml`, `UIApp/MainWindow.xaml`, `UIApp/Services/LoyaltyApiClient.cs`, `UIApp/Services/SharedMemoryService.cs` |
| **19.4** | 4 —Ñ–∞–π–ª–∞ | `UIApp/Windows/SearchWindow.xaml`, `UIApp/Windows/OperationWindow.xaml` |
| **19.5** | 4 —Ñ–∞–π–ª–∞ | `UIApp/Services/RKeeperXmlApi.cs` (XML API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è), `UIApp/Services/OfflineQueue.cs`, `UIApp/Services/FloatingButton.cs` |
| **19.6** | 3 —Ñ–∞–π–ª–∞ | `UIApp/Utils/Encryption.cs`, `UIApp/Services/ConfigService.cs`, `UIApp/MaxLoyaltyRKeeper.csproj` |


***

### üî∑ –§–ê–ó–ê 20: CI/CD + –î–µ–ø–ª–æ–π –∫–æ–Ω—Ñ–∏–≥–∏

| –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **20.1** | 4 —Ñ–∞–π–ª–∞ | `.github/workflows/ci.yml` (lint + test + build), `.github/workflows/backend-deploy.yml` (Fly.io) |
| **20.2** | 4 —Ñ–∞–π–ª–∞ | `.github/workflows/frontend-deploy.yml` (Vercel), `fly.toml`, `Dockerfile.backend`, `Dockerfile.frontend` |
| **20.3** | 3 —Ñ–∞–π–ª–∞ | `docker-compose.prod.yml` (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π), `apps/backend/src/health/health.controller.ts`, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è `docs/deployment/README.md` |


***

## üìä –ò–¢–û–ì–û

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
| :-- | :-- |
| **–í—Å–µ–≥–æ —Ñ–∞–∑** | 20 |
| **–í—Å–µ–≥–æ –∏—Ç–µ—Ä–∞—Ü–∏–π** | ~100 |
| **–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤** | ~450‚Äì500 |
| **–°–µ—Å—Å–∏–π –ø—Ä–∏–º–µ—Ä–Ω–æ** | 50‚Äì70 (–ø–æ 1‚Äì2 –∏—Ç–µ—Ä–∞—Ü–∏–∏) |
| **–í—Ä–µ–º—è** | 3‚Äì5 –Ω–µ–¥–µ–ª—å –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã |


***

## üéØ –ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´

1. **–ö–∞–∂–¥—É—é —Å–µ—Å—Å–∏—é** ‚Äî –Ω–∞–∑—ã–≤–∞–µ—à—å –∏—Ç–µ—Ä–∞—Ü–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–î–µ–ª–∞–µ–º 0.1")
2. **–Ø —Å–æ–∑–¥–∞—é** —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ `push_files` –≤ –≤–µ—Ç–∫—É `develop`
3. **–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã** ‚Äî PR –∏–∑ `develop` –≤ `main`
4. **–ö—Ä—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã** (>200 —Å—Ç—Ä–æ–∫) ‚Äî –≤—Å–µ–≥–¥–∞ –¥—Ä–æ–±–ª—é –Ω–∞ —á–∞—Å—Ç–∏ –∑–∞—Ä–∞–Ω–µ–µ
5. **–ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –≤–ª–µ–∑** ‚Äî –≥–æ–≤–æ—Ä–∏—à—å, —è –¥–æ–±–∞–≤–ª—è—é –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
6. **–ü—Ä–æ–≤–µ—Ä–∫–∞** ‚Äî —Ç—ã —Ç–µ—Å—Ç–∏—Ä—É–µ—à—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã (0, 1, 2 –∏ —Ç.–¥.)

***

**–ì–æ—Ç–æ–≤ –Ω–∞—á–∏–Ω–∞—Ç—å —Å –ò—Ç–µ—Ä–∞—Ü–∏–∏ 0.1?** –°–∫–∞–∂–∏ ‚Äî –∏ —è —Å—Ä–∞–∑—É —Å–æ–∑–¥–∞—é –ø–µ—Ä–≤—ã–µ 6 —Ñ–∞–π–ª–æ–≤ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π. üöÄ

---

# –£–≤–µ–ª–∏—á—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤, —á—Ç–æ–±—ã –º—ã —Ç–æ—á–Ω–æ –Ω–µ —É–ø–∏—Ä–∞–ª–∏—Å—å –≤ –ø–æ—Ç–æ–ª–æ–∫, –ø–æ—Å–ª–µ –Ω–∞—á–Ω–µ–º

–û—Ç–ª–∏—á–Ω–æ, —Ç–µ–ø–µ—Ä—å —É –º–µ–Ω—è –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –¥–µ—Ç–∞–ª–µ–π –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤. –°–æ—Å—Ç–∞–≤–ª—è—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–ª–∞–Ω.

***

# üìê –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò MAX-LOYALTY

## ‚öñÔ∏è –ñ—ë—Å—Ç–∫–∏–µ –ª–∏–º–∏—Ç—ã (—Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ª–∏–º–∏—Ç |
| :-- | :-- |
| –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ | **‚â§ 120 —Å—Ç—Ä–æ–∫** |
| –§–∞–π–ª–æ–≤ –∑–∞ –æ–¥–∏–Ω `push_files` | **‚â§ 5 —Ñ–∞–π–ª–æ–≤** |
| –ö—Ä—É–ø–Ω—ã–π —Å–µ—Ä–≤–∏—Å (>120 —Å—Ç—Ä–æ–∫) | **–†–∞–∑–±–∏–≤–∞—Ç—å: `.service.part1.ts` + `.part2.ts`** ‚Äî –ø–æ—Ç–æ–º —Å–∫–ª–µ–∏–≤–∞–µ–º –≤ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª |
| –ö—Ä—É–ø–Ω—ã–π Prisma —Ñ–∞–π–ª | **‚â§ 5 –º–æ–¥–µ–ª–µ–π –Ω–∞ —Ñ–∞–π–ª** |
| React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç | **‚â§ 100 —Å—Ç—Ä–æ–∫** |
| SQL/Prisma –º–∏–≥—Ä–∞—Ü–∏—è | **1 —Å—Ö–µ–º–∞ = 1 –∏—Ç–µ—Ä–∞—Ü–∏—è** |


***

## üìÅ –ò–¢–û–ì–û–í–ê–Ø –°–¢–†–£–ö–¢–£–†–ê

```
m-loyalty/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ backend/src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/           # JWT, Guards, RBAC, MFA, Impersonation
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tenants/        # Multi-tenant —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users/          # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —Ä–æ–ª–∏, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ restaurants/    # –†–µ—Å—Ç–æ—Ä–∞–Ω—ã, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guests/         # –ì–æ—Å—Ç–∏, –∫–∞—Ä—Ç—ã, –¥–µ—Ç–∏, QR
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ loyalty/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ builder/    # –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ engine/     # –†–∞—Å—á—ë—Ç –±–∞–ª–ª–æ–≤, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ promos/     # –ü—Ä–æ–º–æ-–∫–∞–º–ø–∞–Ω–∏–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pos/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ iiko/       # Webhook + PULL
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rkeeper/    # Webhook + PULL
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ billing/        # –ü–æ–¥–ø–∏—Å–∫–∏, –∏–Ω–≤–æ–π—Å—ã, –ø–ª–∞—Ç–µ–∂–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram/       # Bot + Mini App
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analytics/      # Owner/Admin/Manager/Guest
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notifications/  # Email, SMS, Telegram push
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sse/            # Server-Sent Events
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/             # Guards, Filters, Interceptors, Utils
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config/             # –í—Å–µ –∫–æ–Ω—Ñ–∏–≥–∏
‚îÇ   ‚îú‚îÄ‚îÄ frontend/src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app/                # Next.js App Router
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (auth)/         # login, register, reset
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (owner)/        # Owner dashboard
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ (admin)/        # Admin dashboard
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui/             # shadcn –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout/         # Sidebar, Navbar, Breadcrumbs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guests/         # GuestsTable, GuestProfile
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ loyalty/        # RuleBuilder, LevelTimeline, PromoWizard
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ charts/         # Recharts –æ–±—ë—Ä—Ç–∫–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ store/              # Zustand
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ telegram-bot/src/
‚îÇ       ‚îú‚îÄ‚îÄ scenes/             # –î–∏–∞–ª–æ–≥–∏
‚îÇ       ‚îú‚îÄ‚îÄ services/
‚îÇ       ‚îî‚îÄ‚îÄ mini-app/
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma   # –ë–∞–∑–æ–≤—ã–π (generator + datasource)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/         # –ü–æ 4-5 –º–æ–¥–µ–ª–µ–π –≤ —Ñ–∞–π–ª
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ shared/src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constants/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ config/
‚îú‚îÄ‚îÄ plugins/
‚îÇ   ‚îú‚îÄ‚îÄ iiko/                   # C# WPF
‚îÇ   ‚îî‚îÄ‚îÄ rkeeper/                # C++ DLL + C# WPF
‚îú‚îÄ‚îÄ .github/workflows/
‚îú‚îÄ‚îÄ docs/
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ turbo.json
‚îî‚îÄ‚îÄ package.json
```


***

## üóìÔ∏è –ü–û–õ–ù–´–ô –ü–õ–ê–ù ‚Äî 200+ –ò–¢–ï–†–ê–¶–ò–ô

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 0: –ú–û–ù–û–†–ï–ü–û –°–ö–ï–õ–ï–¢ ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **0.1** | Root –∫–æ–Ω—Ñ–∏–≥–∏ | 4 | `package.json`, `turbo.json`, `.gitignore`, `.env.example` |
| **0.2** | Docker + README | 4 | `docker-compose.yml`, `docker-compose.prod.yml`, `README.md`, `.github/workflows/ci.yml` |
| **0.3** | Config package | 4 | `packages/config/package.json`, `packages/config/tsconfig.base.json`, `packages/config/eslint-preset.js`, `packages/config/jest.config.base.js` |
| **0.4** | Backend scaffold | 5 | `apps/backend/package.json`, `apps/backend/tsconfig.json`, `apps/backend/nest-cli.json`, `apps/backend/.env.example`, `apps/backend/src/main.ts` |
| **0.5** | Frontend scaffold | 5 | `apps/frontend/package.json`, `apps/frontend/tsconfig.json`, `apps/frontend/next.config.ts`, `apps/frontend/tailwind.config.ts`, `apps/frontend/postcss.config.js` |
| **0.6** | Frontend globals | 4 | `apps/frontend/src/app/layout.tsx`, `apps/frontend/src/app/page.tsx`, `apps/frontend/src/app/globals.css`, `apps/frontend/src/lib/utils.ts` |
| **0.7** | Telegram scaffold | 4 | `apps/telegram-bot/package.json`, `apps/telegram-bot/tsconfig.json`, `apps/telegram-bot/src/main.ts`, `apps/telegram-bot/src/app.module.ts` |
| **0.8** | Shared package | 4 | `packages/shared/package.json`, `packages/shared/tsconfig.json`, `packages/shared/src/index.ts`, `packages/shared/src/types/index.ts` |
| **0.9** | Database package | 4 | `packages/database/package.json`, `packages/database/tsconfig.json`, `packages/database/src/index.ts`, `packages/database/src/prisma.service.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 1: PRISMA SCHEMA ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **1.1** | –≠–Ω—É–º—ã | 3 | `schema.prisma` (generator+datasource), `enums.prisma` (–≤—Å–µ enum: UserRole, Gender, CardStatus, BallTransactionType, SubscriptionPlan...) |
| **1.2** | –¢–µ–Ω–∞–Ω—Ç—ã | 2 | `tenant.prisma` (Tenant, TenantLimits, TenantSettings) |
| **1.3** | Auth + Users | 2 | `auth.prisma` (User, UserSession, PasswordHistory, UserPermission) |
| **1.4** | –†–µ—Å—Ç–æ—Ä–∞–Ω—ã | 2 | `restaurant.prisma` (Restaurant, RestaurantSettings, RestaurantHours) |
| **1.5** | –ì–æ—Å—Ç–∏ | 2 | `guests.prisma` (GuestProfile, GuestChild) |
| **1.6** | –ö–∞—Ä—Ç—ã –≥–æ—Å—Ç–µ–π | 2 | `guest-cards.prisma` (GuestCard, GuestVisit) |
| **1.7** | –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ | 2 | `transactions.prisma` (BallTransaction, BallTransfer) |
| **1.8** | Loyalty —Å–∏—Å—Ç–µ–º–∞ | 2 | `loyalty-system.prisma` (LoyaltySystem, LoyaltySystemConfig) |
| **1.9** | –ü—Ä–∞–≤–∏–ª–∞ –∏ —É—Ä–æ–≤–Ω–∏ | 2 | `loyalty-rules.prisma` (LoyaltyRule, LoyaltyRuleVersion, LoyaltyLevel) |
| **1.10** | –ü—Ä–æ–º–æ | 2 | `loyalty-promos.prisma` (LoyaltyPromo, PromoBallGranted, PromoActivation) |
| **1.11** | –ë–∏–ª–ª–∏–Ω–≥ | 2 | `billing.prisma` (Subscription, SubscriptionChange) |
| **1.12** | –ò–Ω–≤–æ–π—Å—ã + –ü–ª–∞—Ç–µ–∂–∏ | 2 | `payments.prisma` (Invoice, Payment, BillingInfo) |
| **1.13** | POS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ | 2 | `pos.prisma` (POSIntegration, POSApiKey, POSSync) |
| **1.14** | POS —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ | 2 | `pos-transactions.prisma` (POSTransaction) |
| **1.15** | Telegram | 2 | `telegram.prisma` (TelegramBot, TelegramUser, TelegramSession) |
| **1.16** | –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | 2 | `analytics.prisma` (AnalyticsDailySnapshot, AnalyticsMonthlySnapshot, GuestSegmentation) |
| **1.17** | –õ–æ–≥–∏ | 2 | `logs.prisma` (ActivityLog, Notification, NotificationLog) |
| **1.18** | –ò–Ω–¥–µ–∫—Å—ã –∏ —Ñ–∏–Ω–∞–ª | 2 | –§–∏–Ω–∞–ª—å–Ω—ã–π `schema.prisma` —Å `@@index`, `@@unique`, seed —Ñ–∞–π–ª `seed.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 2: BACKEND ‚Äî SHARED/COMMON ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **2.1** | Error codes | 4 | `common/exceptions/error-codes.enum.ts`, `common/exceptions/app.exception.ts`, `common/exceptions/business.exceptions.ts`, `common/exceptions/http-exception-messages.ts` |
| **2.2** | Filters | 4 | `common/filters/all-exceptions.filter.ts`, `common/filters/http-exception.filter.ts`, `common/filters/prisma-exception.filter.ts`, `common/filters/validation-exception.filter.ts` |
| **2.3** | Interceptors | 4 | `common/interceptors/logging.interceptor.ts`, `common/interceptors/transform.interceptor.ts`, `common/interceptors/timeout.interceptor.ts`, `common/interceptors/idempotency.interceptor.ts` |
| **2.4** | Middleware | 4 | `common/middleware/tenant.middleware.ts`, `common/middleware/rate-limit.middleware.ts`, `common/middleware/request-id.middleware.ts`, `common/middleware/logger.middleware.ts` |
| **2.5** | Pipes | 3 | `common/pipes/validation.pipe.ts`, `common/pipes/parse-uuid.pipe.ts`, `common/pipes/trim-strings.pipe.ts` |
| **2.6** | Utils —á.1 | 4 | `common/utils/hash.util.ts`, `common/utils/crypto.util.ts`, `common/utils/qr.util.ts`, `common/utils/digit-code.util.ts` |
| **2.7** | Utils —á.2 | 4 | `common/utils/pagination.util.ts`, `common/utils/date.util.ts`, `common/utils/phone.util.ts`, `common/utils/currency.util.ts` |
| **2.8** | Decorators | 4 | `common/decorators/api-paginated.decorator.ts`, `common/decorators/tenant-id.decorator.ts`, `common/decorators/skip-transform.decorator.ts`, `common/decorators/idempotency.decorator.ts` |
| **2.9** | –ö–æ–Ω—Ñ–∏–≥–∏ —á.1 | 4 | `config/app.config.ts`, `config/database.config.ts`, `config/jwt.config.ts`, `config/redis.config.ts` |
| **2.10** | –ö–æ–Ω—Ñ–∏–≥–∏ —á.2 | 4 | `config/mail.config.ts`, `config/telegram.config.ts`, `config/sms.config.ts`, `config/index.ts` |
| **2.11** | App module | 3 | `app.module.ts` (–Ω–∞—á–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è), `app.controller.ts` (health check), `app.service.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 3: BACKEND ‚Äî AUTH MODULE ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **3.1** | Auth DTO —á.1 | 5 | `dto/login.dto.ts`, `dto/register-owner.dto.ts`, `dto/refresh-token.dto.ts`, `dto/verify-phone.dto.ts`, `dto/change-password.dto.ts` |
| **3.2** | Auth DTO —á.2 | 4 | `dto/forgot-password.dto.ts`, `dto/reset-password.dto.ts`, `dto/impersonate.dto.ts`, `dto/enable-mfa.dto.ts` |
| **3.3** | JWT —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ | 4 | `strategies/jwt.strategy.ts`, `strategies/refresh-jwt.strategy.ts`, `strategies/telegram.strategy.ts`, `strategies/types.ts` |
| **3.4** | Guards | 5 | `guards/jwt-auth.guard.ts`, `guards/roles.guard.ts`, `guards/permissions.guard.ts`, `guards/step-up-auth.guard.ts`, `guards/tenant-access.guard.ts` |
| **3.5** | –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã | 5 | `decorators/roles.decorator.ts`, `decorators/permissions.decorator.ts`, `decorators/current-user.decorator.ts`, `decorators/public.decorator.ts`, `decorators/step-up.decorator.ts` |
| **3.6** | Password service | 3 | `services/password.service.ts`, `services/password-history.service.ts`, `services/otp.service.ts` |
| **3.7** | Session service | 3 | `services/session.service.ts`, `services/refresh-token.service.ts`, `services/token.service.ts` |
| **3.8** | MFA service | 3 | `services/mfa.service.ts`, `services/totp.service.ts`, `services/sms-auth.service.ts` |
| **3.9** | Auth service —á.1 | 3 | `auth.service.ts` —á–∞—Å—Ç—å 1: `login()`, `registerOwner()`, `validateUser()`, `generateTokens()` |
| **3.10** | Auth service —á.2 | 3 | `auth.service.ts` —á–∞—Å—Ç—å 2: `refresh()`, `logout()`, `logoutAll()`, `impersonate()` |
| **3.11** | Auth service —á.3 | 2 | `auth.service.ts` —á–∞—Å—Ç—å 3: MFA –º–µ—Ç–æ–¥—ã, `changePassword()`, `forgotPassword()`, `resetPassword()` |
| **3.12** | Auth controller | 3 | `auth.controller.ts`, `auth.module.ts`, `auth.types.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 4: BACKEND ‚Äî TENANTS + USERS ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **4.1** | Tenants DTO | 4 | `dto/create-tenant.dto.ts`, `dto/update-tenant.dto.ts`, `dto/tenant-limits.dto.ts`, `dto/tenant-filter.dto.ts` |
| **4.2** | Tenants service —á.1 | 3 | `tenants.service.ts` —á.1: `create()`, `findAll()`, `findOne()`, `update()` |
| **4.3** | Tenants service —á.2 | 3 | `tenants.service.ts` —á.2: `block()`, `changePlan()`, `getLimitsUsage()`, `checkLimits()` |
| **4.4** | Tenants limits | 3 | `tenant-limits.service.ts`, `tenant-usage.service.ts`, `tenants.controller.ts` |
| **4.5** | Tenants module | 2 | `tenants.module.ts`, `tenants.types.ts` |
| **4.6** | Users DTO | 5 | `dto/create-user.dto.ts`, `dto/update-user.dto.ts`, `dto/invite-user.dto.ts`, `dto/user-filter.dto.ts`, `dto/change-role.dto.ts` |
| **4.7** | Users service —á.1 | 3 | `users.service.ts` —á.1: `create()`, `findAll()`, `findOne()`, `findByEmail()`, `findByPhone()` |
| **4.8** | Users service —á.2 | 3 | `users.service.ts` —á.2: `update()`, `invite()`, `block()`, `delete()`, `changeRole()` |
| **4.9** | RBAC service | 3 | `rbac/permissions.service.ts`, `rbac/role-permissions.map.ts`, `rbac/rbac.types.ts` |
| **4.10** | Users controller | 3 | `users.controller.ts`, `users.module.ts`, `users.types.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 5: BACKEND ‚Äî RESTAURANTS ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **5.1** | Restaurants DTO | 4 | `dto/create-restaurant.dto.ts`, `dto/update-restaurant.dto.ts`, `dto/restaurant-settings.dto.ts`, `dto/restaurant-filter.dto.ts` |
| **5.2** | Restaurants service —á.1 | 3 | `restaurants.service.ts` —á.1: `create()`, `findAll()`, `findOne()`, `update()` |
| **5.3** | Restaurants service —á.2 | 3 | `restaurants.service.ts` —á.2: `delete()`, `getStats()`, `getSettings()`, `updateSettings()` |
| **5.4** | Restaurants controller | 3 | `restaurants.controller.ts`, `restaurants.module.ts`, `restaurants.types.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 6: BACKEND ‚Äî GUESTS ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **6.1** | Guests DTO —á.1 | 5 | `dto/create-guest.dto.ts`, `dto/update-guest.dto.ts`, `dto/guest-filter.dto.ts`, `dto/search-guest.dto.ts`, `dto/register-guest.dto.ts` |
| **6.2** | Guests DTO —á.2 | 4 | `dto/change-phone.dto.ts`, `dto/merge-guests.dto.ts`, `dto/export-guests.dto.ts`, `dto/bulk-action.dto.ts` |
| **6.3** | Guests service —á.1 | 3 | `guests.service.ts` —á.1: `create()`, `findAll()` —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏, `findOne()`, `search()` |
| **6.4** | Guests service —á.2 | 3 | `guests.service.ts` —á.2: `update()`, `changePhone()`, `softDelete()`, `export()` |
| **6.5** | Guests service —á.3 | 3 | `guests.service.ts` —á.3: `mergeGuests()`, `bulkAction()`, `getSegments()` |
| **6.6** | Children service | 3 | `children/children.service.ts`, `children/children.dto.ts`, `children/age-validator.ts` |
| **6.7** | Guest cards —á.1 | 3 | `guest-cards/guest-cards.service.ts` —á.1: `create()`, `findOne()`, `findByPhone()`, `findByQR()` |
| **6.8** | Guest cards —á.2 | 3 | `guest-cards/guest-cards.service.ts` —á.2: `block()`, `unblock()`, `regenerateQR()`, `regenerateCode()` |
| **6.9** | QR service | 3 | `guest-cards/qr.service.ts`, `guest-cards/digit-code.service.ts`, `guest-cards/guest-cards.types.ts` |
| **6.10** | Guests controller | 3 | `guests.controller.ts`, `guests.module.ts`, `guest-cards/guest-cards.controller.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 7: BACKEND ‚Äî LOYALTY BUILDER ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **7.1** | Builder DTO —á.1 | 5 | `dto/create-loyalty-system.dto.ts`, `dto/update-loyalty-system.dto.ts`, `dto/create-level.dto.ts`, `dto/update-level.dto.ts`, `dto/reorder-levels.dto.ts` |
| **7.2** | Builder DTO —á.2 | 5 | `dto/create-rule.dto.ts`, `dto/update-rule.dto.ts`, `dto/create-promo.dto.ts`, `dto/update-promo.dto.ts`, `dto/conflict-strategy.dto.ts` |
| **7.3** | Loyalty system service —á.1 | 3 | `loyalty-system.service.ts` —á.1: `create()`, `findByTenant()`, `getConfig()`, `updateConfig()` |
| **7.4** | Loyalty system service —á.2 | 3 | `loyalty-system.service.ts` —á.2: `setMode()`, `migrateUnifiedToSeparate()`, `migrateSeparateToUnified()` |
| **7.5** | Levels service —á.1 | 3 | `levels.service.ts` —á.1: `create()`, `findAll()`, `update()`, `reorder()` |
| **7.6** | Levels service —á.2 | 3 | `levels.service.ts` —á.2: `delete()` —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º –≥–æ—Å—Ç–µ–π, `recalculate()`, `checkGuestsOnLevel()` |
| **7.7** | Rules service —á.1 | 3 | `rules.service.ts` —á.1: `create()`, `findAll()`, `findOne()`, `activate()` |
| **7.8** | Rules service —á.2 | 3 | `rules.service.ts` —á.2: `update()` —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º, `deactivate()`, `archive()`, `getRuleHistory()` |
| **7.9** | Promos service —á.1 | 3 | `promos.service.ts` —á.1: `create()`, `findAll()`, `findOne()`, `activate()` |
| **7.10** | Promos service —á.2 | 3 | `promos.service.ts` —á.2: `update()`, `deactivate()`, `getEligiblePromos()`, `setConflictStrategy()` |
| **7.11** | Builder controller | 4 | `loyalty-builder.controller.ts`, `levels.controller.ts`, `rules.controller.ts`, `promos.controller.ts` |
| **7.12** | Builder module | 3 | `loyalty-builder.module.ts`, `builder.types.ts`, `builder.constants.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 8: BACKEND ‚Äî LOYALTY ENGINE ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **8.1** | Engine DTO | 5 | `dto/calculate.dto.ts`, `dto/earn.dto.ts`, `dto/redeem.dto.ts`, `dto/manual-adjust.dto.ts`, `dto/transfer.dto.ts` |
| **8.2** | Calculator —á.1 | 3 | `calculator.service.ts` —á.1: `calculateEarning()`, `applyRules()`, `findApplicableRules()` |
| **8.3** | Calculator —á.2 | 3 | `calculator.service.ts` —á.2: `calculatePromos()`, `resolvePromoConflicts()`, `validateRedemption()` |
| **8.4** | Calculator —á.3 | 3 | `calculator.service.ts` —á.3: `calculateRedemptionSplit()` (FIFO promo‚Üíregular), `getRedeemLimits()`, `buildCalculationResult()` |
| **8.5** | Transactions service —á.1 | 3 | `transactions.service.ts` —á.1: `processTransaction()` (Prisma interactive transaction, pessimistic lock) |
| **8.6** | Transactions service —á.2 | 3 | `transactions.service.ts` —á.2: `earn()`, `redeem()`, `earnAndRedeem()`, idempotency —á–µ—Ä–µ–∑ `posCheckId` |
| **8.7** | Transactions service —á.3 | 3 | `transactions.service.ts` —á.3: `manualAdjust()`, `transfer()`, `rollback()`, `getHistory()` |
| **8.8** | Expiry service | 3 | `expiry.service.ts`: FIFO —Å–≥–æ—Ä–∞–Ω–∏–µ, `getExpiringSoon()`, `expireBalls()` |
| **8.9** | Levels upgrade | 3 | `levels-upgrade.service.ts`: `checkAndUpgrade()`, `recalculateGuestLevel()`, `batchRecalculate()` |
| **8.10** | Engine jobs | 4 | `jobs/expire-balls.job.ts`, `jobs/upgrade-levels.job.ts`, `jobs/notify-expiry.job.ts`, `jobs/reconcile-balances.job.ts` |
| **8.11** | Engine controller | 3 | `loyalty-engine.controller.ts` (calculate, transactions, manual, transfer) |
| **8.12** | Engine module | 3 | `loyalty-engine.module.ts`, `engine.types.ts`, `engine.constants.ts` (1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å, FIFO, –ª–∏–º–∏—Ç—ã) |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 9: BACKEND ‚Äî POS INTEGRATION ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **9.1** | POS DTO | 5 | `dto/pos-config.dto.ts`, `dto/iiko-webhook.dto.ts`, `dto/rkeeper-webhook.dto.ts`, `dto/pos-transaction.dto.ts`, `dto/manual-sync.dto.ts` |
| **9.2** | POS config service | 3 | `pos-config.service.ts`: `create()`, `update()`, `getDecryptedKey()`, `testConnection()`, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π |
| **9.3** | POS security | 3 | `security/hmac.service.ts` (HMAC-SHA256 –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è), `security/ip-whitelist.service.ts`, `security/api-key.service.ts` |
| **9.4** | iiko webhook —á.1 | 3 | `iiko/iiko-webhook.service.ts` —á.1: –ø—Ä–∏—ë–º, –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è HMAC, –ø–∞—Ä—Å–∏–Ω–≥ —Å–æ–±—ã—Ç–∏—è |
| **9.5** | iiko webhook —á.2 | 3 | `iiko/iiko-webhook.service.ts` —á.2: –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –≥–æ—Å—Ç—è, idempotency, –≤—ã–∑–æ–≤ Loyalty Engine |
| **9.6** | iiko PULL | 3 | `iiko/iiko-pull.service.ts`: PULL –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î, reconciliation |
| **9.7** | R-Keeper webhook —á.1 | 3 | `rkeeper/rkeeper-webhook.service.ts` —á.1: XML –ø–∞—Ä—Å–∏–Ω–≥, –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è |
| **9.8** | R-Keeper webhook —á.2 | 3 | `rkeeper/rkeeper-webhook.service.ts` —á.2: –æ–±—Ä–∞–±–æ—Ç–∫–∞, –≤—ã–∑–æ–≤ Engine |
| **9.9** | R-Keeper PULL | 3 | `rkeeper/rkeeper-pull.service.ts`, `rkeeper/xml-api.service.ts` |
| **9.10** | POS sync logger | 3 | `pos-sync.service.ts` (SUCCESS/FAILED/PARTIAL/PENDING), `pos-reconciliation.service.ts` |
| **9.11** | POS jobs | 3 | `jobs/pull-sync.job.ts` (BullMQ), `jobs/reconciliation.job.ts`, `jobs/retry-failed.job.ts` |
| **9.12** | POS API endpoints | 3 | `pos.controller.ts` (calculate, reserve, finalize –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤), `pos.module.ts`, `pos.types.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 10: BACKEND ‚Äî BILLING ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **10.1** | Billing DTO | 5 | `dto/create-subscription.dto.ts`, `dto/change-plan.dto.ts`, `dto/create-invoice.dto.ts`, `dto/process-payment.dto.ts`, `dto/refund.dto.ts` |
| **10.2** | Abstract provider | 3 | `providers/abstract.payment-provider.ts`, `providers/payment-provider.types.ts`, `providers/provider.factory.ts` |
| **10.3** | YooKassa provider | 3 | `providers/yookassa.provider.ts` —á.1: `createPayment()`, `getPayment()` |
| **10.4** | YooKassa provider —á.2 | 2 | `providers/yookassa.provider.ts` —á.2: `refund()`, `handleWebhook()` |
| **10.5** | Stripe provider | 3 | `providers/stripe.provider.ts`: `createPayment()`, `refund()`, `handleWebhook()` |
| **10.6** | CloudPayments | 3 | `providers/cloudpayments.provider.ts`: `createPayment()`, `refund()`, `handleWebhook()` |
| **10.7** | Subscriptions service —á.1 | 3 | `subscriptions.service.ts` —á.1: `create()`, `getActive()`, `change–ø–ª–∞–Ω()` |
| **10.8** | Subscriptions service —á.2 | 3 | `subscriptions.service.ts` —á.2: `cancel()`, `reactivate()`, `checkExpiry()`, `applyLimitedMode()` |
| **10.9** | Billing service —á.1 | 3 | `billing.service.ts` —á.1: `processPayment()`, `createInvoice()`, `markPaid()` |
| **10.10** | Billing service —á.2 | 3 | `billing.service.ts` —á.2: `refund()`, `handleChargeback()`, `getInvoiceHistory()` |
| **10.11** | Billing jobs | 3 | `jobs/retry-payment.job.ts` (day 0,1,3,7), `jobs/check-expiry.job.ts`, `jobs/send-invoice.job.ts` |
| **10.12** | Billing controller | 3 | `billing.controller.ts`, `billing-webhook.controller.ts`, `billing.module.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 11: BACKEND ‚Äî TELEGRAM ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **11.1** | Telegram DTO | 4 | `dto/setup-bot.dto.ts`, `dto/telegram-auth.dto.ts`, `dto/send-message.dto.ts`, `dto/mini-app-auth.dto.ts` |
| **11.2** | Bot setup service | 3 | `bot-setup.service.ts`: `validateToken()`, `setupWebhook()`, `setCommands()`, `deleteWebhook()` |
| **11.3** | Telegram auth | 3 | `telegram-auth.service.ts`: `authenticateUser()`, `validateInitData()` (HMAC-SHA256), `linkAccount()` |
| **11.4** | Bot scenes —á.1 | 3 | `scenes/start.scene.ts`, `scenes/auth.scene.ts`, `scenes/card.scene.ts` |
| **11.5** | Bot scenes —á.2 | 3 | `scenes/history.scene.ts`, `scenes/profile.scene.ts`, `scenes/children.scene.ts` |
| **11.6** | Bot service —á.1 | 3 | `bot.service.ts` —á.1: setup, –∫–æ–º–∞–Ω–¥—ã `/start`, `/card`, `/balance` |
| **11.7** | Bot service —á.2 | 3 | `bot.service.ts` —á.2: push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –æ–±—Ä–∞–±–æ—Ç–∫–∞ `my_chat_member`, blocked/unblocked |
| **11.8** | Mini App service | 3 | `mini-app/mini-app.service.ts`: –∫–∞—Ä—Ç–æ—á–∫–∞, –∏—Å—Ç–æ—Ä–∏—è, –ø—Ä–æ—Ñ–∏–ª—å |
| **11.9** | Mini App controller | 3 | `mini-app/mini-app.controller.ts`, `telegram.controller.ts` (webhook), `telegram.module.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 12: BACKEND ‚Äî NOTIFICATIONS ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **12.1** | Notifications DTO | 4 | `dto/send-notification.dto.ts`, `dto/notification-settings.dto.ts`, `dto/notification-template.dto.ts`, `dto/batch-notification.dto.ts` |
| **12.2** | Email service | 3 | `email/email.service.ts` (Resend), `email/email.templates.ts`, `email/email.types.ts` |
| **12.3** | SMS service | 3 | `sms/sms.service.ts` (SMSC.ru + Twilio fallback), `sms/sms.types.ts`, `sms/sms.constants.ts` |
| **12.4** | Notifications service —á.1 | 3 | `notifications.service.ts` —á.1: `send()`, `sendBatch()`, channel routing (Telegram‚ÜíSMS‚ÜíEmail) |
| **12.5** | Notifications service —á.2 | 3 | `notifications.service.ts` —á.2: `retry()` (3 –ø–æ–ø—ã—Ç–∫–∏), `getHistory()`, `markAsRead()`, `updateSettings()` |
| **12.6** | Notification jobs | 3 | `jobs/send-birthday.job.ts`, `jobs/send-inactivity.job.ts`, `jobs/send-expiry.job.ts` |
| **12.7** | Notifications controller | 3 | `notifications.controller.ts`, `notifications.module.ts`, `notifications.types.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 13: BACKEND ‚Äî ANALYTICS + SSE ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **13.1** | Analytics DTO | 4 | `dto/analytics-filter.dto.ts`, `dto/date-range.dto.ts`, `dto/export-analytics.dto.ts`, `dto/guest-segment.dto.ts` |
| **13.2** | Owner analytics —á.1 | 3 | `owner-analytics.service.ts` —á.1: `getMRR()`, `getARR()`, `getChurn()`, `getARPU()` |
| **13.3** | Owner analytics —á.2 | 3 | `owner-analytics.service.ts` —á.2: `getActiveTenants()`, `getRevenueByPlan()`, `getGrowth()`, `getPlatformMetrics()` |
| **13.4** | Restaurant analytics —á.1 | 3 | `restaurant-analytics.service.ts` —á.1: `getRevenueTrend()`, `getGuestGrowth()`, `getLoyaltyROI()` |
| **13.5** | Restaurant analytics —á.2 | 3 | `restaurant-analytics.service.ts` —á.2: `getGuestSegments()`, `getLTV()`, `getBallsStats()`, `getTopGuests()` |
| **13.6** | Snapshots service | 3 | `snapshots.service.ts`: `createDailySnapshot()`, `createMonthlySnapshot()`, `querySnapshot()` |
| **13.7** | Analytics jobs | 3 | `jobs/daily-snapshot.job.ts` (CRON 02:00), `jobs/monthly-snapshot.job.ts`, `jobs/segmentation.job.ts` |
| **13.8** | Export service | 3 | `export.service.ts`: `toCSV()`, `toXLSX()`, `toPDF()` |
| **13.9** | SSE service | 3 | `sse/sse.service.ts`, `sse/sse.controller.ts`, `sse/sse.types.ts` |
| **13.10** | Analytics controller | 3 | `analytics.controller.ts`, `analytics.module.ts`, `sse/sse.module.ts` |
| **13.11** | App module —Ñ–∏–Ω–∞–ª | 3 | `app.module.ts` (–≤—Å–µ –º–æ–¥—É–ª–∏ + BullMQ + Redis), `main.ts` (Swagger, CORS, validation pipe, helmet) |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 14: FRONTEND ‚Äî UI –ö–û–ú–ü–û–ù–ï–ù–¢–´ (shadcn) ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **14.1** | shadcn base —á.1 | 5 | `components/ui/button.tsx`, `components/ui/input.tsx`, `components/ui/label.tsx`, `components/ui/card.tsx`, `components/ui/badge.tsx` |
| **14.2** | shadcn base —á.2 | 5 | `components/ui/table.tsx`, `components/ui/dialog.tsx`, `components/ui/select.tsx`, `components/ui/tabs.tsx`, `components/ui/separator.tsx` |
| **14.3** | shadcn base —á.3 | 5 | `components/ui/alert.tsx`, `components/ui/dropdown-menu.tsx`, `components/ui/popover.tsx`, `components/ui/tooltip.tsx`, `components/ui/skeleton.tsx` |
| **14.4** | shadcn base —á.4 | 5 | `components/ui/checkbox.tsx`, `components/ui/radio-group.tsx`, `components/ui/switch.tsx`, `components/ui/textarea.tsx`, `components/ui/avatar.tsx` |
| **14.5** | shadcn advanced | 5 | `components/ui/progress.tsx`, `components/ui/scroll-area.tsx`, `components/ui/sheet.tsx`, `components/ui/command.tsx`, `components/ui/sonner.tsx` |
| **14.6** | shadcn forms | 3 | `components/ui/form.tsx`, `components/ui/calendar.tsx`, `components/ui/date-picker.tsx` |
| **14.7** | lib + store —á.1 | 5 | `lib/api.ts` (axios + interceptors), `lib/auth.ts`, `lib/utils.ts`, `lib/validations.ts`, `lib/upload.ts` |
| **14.8** | store | 4 | `store/auth.store.ts`, `store/ui.store.ts` (Zustand persist), `store/notifications.store.ts`, `store/restaurant.store.ts` |
| **14.9** | types | 4 | `types/api.types.ts`, `types/loyalty.types.ts`, `types/guest.types.ts`, `types/analytics.types.ts` |
| **14.10** | hooks —á.1 | 5 | `hooks/useAuth.ts`, `hooks/useApi.ts`, `hooks/useToast.ts`, `hooks/useDebounce.ts`, `hooks/usePagination.ts` |
| **14.11** | hooks —á.2 | 4 | `hooks/useSSE.ts` (EventSource), `hooks/useRestaurant.ts`, `hooks/usePermissions.ts`, `hooks/useExport.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 15: FRONTEND ‚Äî LAYOUT ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **15.1** | Sidebar —á.1 | 3 | `components/layout/Sidebar.tsx` —á.1: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, menuItems, –∏–∫–æ–Ω–∫–∏, CSS –ø–µ—Ä–µ—Ö–æ–¥—ã |
| **15.2** | Sidebar —á.2 | 3 | `components/layout/Sidebar.tsx` —á.2: mini —Ä–µ–∂–∏–º (60px), hover tooltips, localStorage persist |
| **15.3** | Navbar | 3 | `components/layout/Navbar.tsx` —á.1: breadcrumbs, global search –∫–Ω–æ–ø–∫–∞ |
| **15.4** | Navbar —á.2 | 3 | `components/layout/Navbar.tsx` —á.2: notifications bell, restaurant selector, user menu |
| **15.5** | Global search | 3 | `components/layout/GlobalSearch.tsx` (CMDK: –≥–æ—Å—Ç–∏, –ø—Ä–∞–≤–∏–ª–∞, –ø—Ä–æ–º–æ), `components/layout/Breadcrumbs.tsx` |
| **15.6** | Notifications bell | 3 | `components/layout/NotificationsBell.tsx` (Popover, scroll area, mark as read) |
| **15.7** | Impersonation banner | 2 | `components/layout/ImpersonationBanner.tsx`, `components/layout/AlertBanner.tsx` |
| **15.8** | Page wrapper | 3 | `components/layout/PageWrapper.tsx`, `components/layout/PageHeader.tsx`, `components/layout/EmptyState.tsx` |
| **15.9** | App layouts | 4 | `app/(auth)/layout.tsx`, `app/(owner)/layout.tsx`, `app/(admin)/layout.tsx`, `app/(manager)/layout.tsx` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 16: FRONTEND ‚Äî AUTH –°–¢–†–ê–ù–ò–¶–´ ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **16.1** | Login page | 3 | `app/(auth)/login/page.tsx`, `app/(auth)/login/LoginForm.tsx`, `app/(auth)/login/TelegramLoginButton.tsx` |
| **16.2** | Register page | 3 | `app/(auth)/register/page.tsx`, `app/(auth)/register/RegisterOwnerForm.tsx` |
| **16.3** | Password + 2FA | 4 | `app/(auth)/forgot-password/page.tsx`, `app/(auth)/reset-password/page.tsx`, `app/(auth)/2fa/page.tsx`, `app/(auth)/verify-phone/page.tsx` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 17: FRONTEND ‚Äî OWNER DASHBOARD ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **17.1** | KPI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã | 4 | `components/dashboard/MetricCard.tsx`, `components/dashboard/TrendBadge.tsx`, `components/dashboard/LimitBar.tsx`, `components/dashboard/StatusBadge.tsx` |
| **17.2** | Charts —á.1 | 3 | `components/charts/MRRTrendChart.tsx` (ComposedChart Bar+Line), `components/charts/RevenueByPlanChart.tsx` (Donut) |
| **17.3** | Charts —á.2 | 3 | `components/charts/ChurnChart.tsx`, `components/charts/ActiveTenantsChart.tsx`, `components/charts/GrowthChart.tsx` |
| **17.4** | Tenants table | 3 | `components/owner/TenantsTable.tsx` —á.1: –∫–æ–ª–æ–Ω–∫–∏, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, —Ñ–∏–ª—å—Ç—Ä—ã |
| **17.5** | Tenants table —á.2 | 3 | `components/owner/TenantsTable.tsx` —á.2: pagination, bulk actions, export dropdown |
| **17.6** | Tenant details modal | 3 | `components/owner/TenantDetailsModal.tsx` —á.1: Tabs, Overview tab |
| **17.7** | Tenant details —á.2 | 3 | `components/owner/TenantDetailsModal.tsx` —á.2: Billing tab, Analytics tab |
| **17.8** | Tenant details —á.3 | 3 | `components/owner/TenantDetailsModal.tsx` —á.3: Team tab, Activity Log tab |
| **17.9** | Change plan modal | 3 | `components/owner/ChangePlanModal.tsx` (RadioGroup plans, impact summary, reason) |
| **17.10** | Alerts + live | 3 | `components/owner/CriticalAlerts.tsx`, `hooks/useOwnerLiveUpdates.ts` (SSE) |
| **17.11** | Owner dashboard | 3 | `app/(owner)/dashboard/page.tsx`, `app/(owner)/dashboard/useOwnerDashboard.ts` |
| **17.12** | Owner pages | 4 | `app/(owner)/tenants/page.tsx`, `app/(owner)/billing/page.tsx`, `app/(owner)/analytics/page.tsx`, `app/(owner)/settings/page.tsx` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 18: FRONTEND ‚Äî ADMIN DASHBOARD ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **18.1** | Admin KPIs | 3 | `components/admin/KPIGrid.tsx` (Guests, Revenue, Balls, Loyalty ROI), `components/admin/QuickActions.tsx` |
| **18.2** | Admin charts —á.1 | 3 | `components/charts/GuestGrowthChart.tsx`, `components/charts/RevenueBallsChart.tsx` |
| **18.3** | Admin charts —á.2 | 3 | `components/charts/LoyaltyLevelsDonut.tsx`, `components/charts/TopGuestsLeaderboard.tsx` |
| **18.4** | Admin dashboard page | 3 | `app/(admin)/dashboard/page.tsx`, `app/(admin)/dashboard/useAdminDashboard.ts`, `hooks/useAdminLiveUpdates.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 19: FRONTEND ‚Äî GUESTS MANAGEMENT ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **19.1** | Guests table —á.1 | 3 | `components/guests/GuestsTable.tsx` —á.1: –∫–æ–ª–æ–Ω–∫–∏ (–∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –±–∞–ª–∞–Ω—Å, —É—Ä–æ–≤–µ–Ω—å, –≤–∏–∑–∏—Ç—ã, lifetime) |
| **19.2** | Guests table —á.2 | 3 | `components/guests/GuestsTable.tsx` —á.2: TanStack virtualizer (10K —Å—Ç—Ä–æ–∫), bulk select, actions dropdown |
| **19.3** | Guest search + filters | 3 | `components/guests/GuestSearch.tsx` (phone/email/QR/code6), `components/guests/GuestFilters.tsx` —á.1 |
| **19.4** | Guest filters —á.2 | 3 | `components/guests/GuestFilters.tsx` —á.2 (level, status, balance range, visits range, birthday month, last visit) |
| **19.5** | Quick filters | 2 | `components/guests/QuickFilters.tsx` (VIP, At Risk, Birthday Month, New, High Balance) |
| **19.6** | Bulk actions | 3 | `components/guests/BulkActionsBar.tsx` (fixed bottom bar: export, add balls, notify, tag, delete) |
| **19.7** | Guest profile —á.1 | 3 | `components/guests/GuestProfile.tsx` —á.1: Overview tab (info, loyalty card, lifetime stats) |
| **19.8** | Guest profile —á.2 | 3 | `components/guests/GuestProfile.tsx` —á.2: Transactions tab (—Ç–∞–±–ª–∏—Ü–∞ BallTransaction) |
| **19.9** | Guest profile —á.3 | 3 | `components/guests/GuestProfile.tsx` —á.3: Visits tab, Children tab |
| **19.10** | Guest profile —á.4 | 3 | `components/guests/GuestProfile.tsx` —á.4: Activity Log tab, Analytics tab (RFM, Lifetime trend) |
| **19.11** | Manual adjust modal | 3 | `components/guests/ManualAdjustModal.tsx` (ADD/SUBTRACT, reason, notify toggle, audit preview) |
| **19.12** | Guest pages | 4 | `app/(admin)/guests/page.tsx`, `app/(admin)/guests/[id]/page.tsx`, `app/(admin)/guests/[id]/useGuestProfile.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 20: FRONTEND ‚Äî LOYALTY BUILDER ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **20.1** | Rule builder —á.1 | 3 | `components/loyalty/RuleBuilder.tsx` —á.1: —Ñ–æ—Ä–º–∞ –ø—Ä–∞–≤–∏–ª–∞ (–Ω–∞–∑–≤–∞–Ω–∏–µ, –ø—Ä–æ—Ü–µ–Ω—Ç, –º–∏–Ω. —Å—É–º–º–∞, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏) |
| **20.2** | Rule builder —á.2 | 3 | `components/loyalty/RuleBuilder.tsx` —á.2: —É—Å–ª–æ–≤–∏—è (Conditions Builder tag-based), live preview |
| **20.3** | Rule builder —á.3 | 3 | `components/loyalty/RuleBuilder.tsx` —á.3: –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–∏—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π, diff) |
| **20.4** | Level timeline | 3 | `components/loyalty/LevelTimeline.tsx` (visual drag-and-drop timeline —É—Ä–æ–≤–Ω–µ–π) |
| **20.5** | Level card | 3 | `components/loyalty/LevelCard.tsx` (–∏–∫–æ–Ω–∫–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ, –ø–æ—Ä–æ–≥, —Ü–≤–µ—Ç, –∫–æ–ª-–≤–æ –≥–æ—Å—Ç–µ–π) |
| **20.6** | Promo wizard —á.1 | 3 | `components/loyalty/PromoWizard.tsx` —á.1: Step1 —Ç–∏–ø –ø—Ä–æ–º–æ (BIRTHDAY, INACTIVITY, FIRSTCHECK...) |
| **20.7** | Promo wizard —á.2 | 3 | `components/loyalty/PromoWizard.tsx` —á.2: Step2 —É—Å–ª–æ–≤–∏—è, Step3 –Ω–∞–≥—Ä–∞–¥–∞, Step4 preview |
| **20.8** | Conflict strategy | 2 | `components/loyalty/ConflictStrategy.tsx` (COMBINE_ALL / MAX_ONLY / FIRST_ONLY + overrides) |
| **20.9** | Card designer | 3 | `components/loyalty/CardDesigner.tsx` (10 —Ñ–æ–Ω–æ–≤, –∑–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–µ–≥–æ, –ª–æ–≥–æ—Ç–∏–ø, preview) |
| **20.10** | Loyalty pages —á.1 | 4 | `app/(admin)/loyalty/page.tsx`, `app/(admin)/loyalty/rules/page.tsx`, `app/(admin)/loyalty/rules/[id]/page.tsx` |
| **20.11** | Loyalty pages —á.2 | 4 | `app/(admin)/loyalty/levels/page.tsx`, `app/(admin)/loyalty/promos/page.tsx`, `app/(admin)/loyalty/settings/page.tsx` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 21: FRONTEND ‚Äî POS + ANALYTICS + BILLING ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **21.1** | POS status | 3 | `components/pos/POSStatusCard.tsx` (SUCCESS/FAILED/PARTIAL + –ø–æ—Å–ª–µ–¥–Ω–∏–π sync), `components/pos/POSSyncLog.tsx` |
| **21.2** | POS config | 3 | `components/pos/POSConfig.tsx` (iiko/R-Keeper –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, API –∫–ª—é—á masked, test connection) |
| **21.3** | POS page | 2 | `app/(admin)/pos/page.tsx`, `app/(admin)/pos/usePosDashboard.ts` |
| **21.4** | Analytics charts —á.1 | 3 | `components/analytics/RevenueChart.tsx`, `components/analytics/GuestSegmentsChart.tsx` |
| **21.5** | Analytics charts —á.2 | 3 | `components/analytics/LTVChart.tsx`, `components/analytics/BallsFlowChart.tsx` |
| **21.6** | Analytics page | 3 | `app/(admin)/analytics/page.tsx`, `app/(admin)/analytics/useAnalytics.ts`, export dropdown |
| **21.7** | Billing components | 3 | `components/billing/SubscriptionCard.tsx`, `components/billing/InvoiceTable.tsx`, `components/billing/PaymentHistory.tsx` |
| **21.8** | Billing page | 2 | `app/(admin)/billing/page.tsx`, `app/(admin)/billing/useBilling.ts` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 22: FRONTEND ‚Äî MANAGER + CASHIER ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **22.1** | Manager dashboard | 4 | `app/(manager)/dashboard/page.tsx`, `app/(manager)/guests/page.tsx`, `app/(manager)/analytics/page.tsx`, `app/(manager)/pos/page.tsx` |
| **22.2** | Cashier interface —á.1 | 3 | `app/(cashier)/search/page.tsx` (–ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É/QR/–∫–æ–¥—É) |
| **22.3** | Cashier interface —á.2 | 3 | `app/(cashier)/transaction/page.tsx` (–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ, NumPad), `components/cashier/GuestCardPreview.tsx` |
| **22.4** | Cashier register | 3 | `app/(cashier)/register/page.tsx` (–±—ã—Å—Ç—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥–æ—Å—Ç—è), `app/(cashier)/layout.tsx` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 23: TELEGRAM MINI APP (Frontend) ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **23.1** | Mini App setup | 4 | `apps/telegram-miniapp/package.json`, `tsconfig.json`, `vite.config.ts`, `src/main.tsx` |
| **23.2** | Mini App layout | 3 | `src/App.tsx`, `src/components/layout/MiniAppLayout.tsx`, `src/hooks/useTelegramWebApp.ts` |
| **23.3** | Card screen | 3 | `src/screens/CardScreen.tsx` —á.1: –±–∞–ª–∞–Ω—Å, —É—Ä–æ–≤–µ–Ω—å, –∫–Ω–æ–ø–∫–∏ |
| **23.4** | QR screen | 3 | `src/screens/QRScreen.tsx` (QR + 6-digit, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, countdown) |
| **23.5** | –ò—Å—Ç–æ—Ä–∏—è | 3 | `src/screens/HistoryScreen.tsx` (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –≤–∏–∑–∏—Ç—ã, —Ñ–∏–ª—å—Ç—Ä) |
| **23.6** | –ü—Ä–æ—Ñ–∏–ª—å | 3 | `src/screens/ProfileScreen.tsx` (–¥–∞–Ω–Ω—ã–µ –≥–æ—Å—Ç—è, —Å–º–µ–Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ flow) |
| **23.7** | –î–µ—Ç–∏ | 3 | `src/screens/ChildrenScreen.tsx` (—Å–ø–∏—Å–æ–∫ –¥–µ—Ç–µ–π, –¥–æ–±–∞–≤–∏—Ç—å –¥–æ 18 –ª–µ—Ç, –î–†) |
| **23.8** | –ú—É–ª—å—Ç–∏–∫–∞—Ä—Ç–æ—á–Ω–æ—Å—Ç—å | 3 | `src/screens/SelectCardScreen.tsx` (UNIFIED/SEPARATE - –≤—ã–±–æ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞) |
| **23.9** | Auth flow | 3 | `src/screens/AuthScreen.tsx` (phone input, SMS verify, link Telegram) |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 24: PLUGIN iiko (C\#) ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **24.1** | –ü—Ä–æ–µ–∫—Ç scaffold | 4 | `MaxLoyaltyIikoPlugin.csproj`, `Plugin.cs` —á.1 (IFrontPlugin —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è), `AssemblyInfo.cs`, `packages.config` |
| **24.2** | Plugin.cs —á.2 | 2 | `Plugin.cs` —á.2: OnCheck, DiscountCalculate, –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–∞—Å—Å—ã |
| **24.3** | Models | 4 | `Models/GuestInfo.cs`, `Models/CalculateRequest.cs`, `Models/CalculateResponse.cs`, `Models/TransactionRequest.cs` |
| **24.4** | Models —á.2 | 3 | `Models/ApiError.cs`, `Models/Config.cs`, `Models/TransactionResult.cs` |
| **24.5** | ApiClient —á.1 | 3 | `Services/LoyaltyApiClient.cs` —á.1: HttpClient, –±–∞–∑–æ–≤—ã–π URL, auth header, HMAC –ø–æ–¥–ø–∏—Å—å |
| **24.6** | ApiClient —á.2 | 3 | `Services/LoyaltyApiClient.cs` —á.2: `Calculate()`, `Reserve()`, `Finalize()`, retry (3 –ø–æ–ø—ã—Ç–∫–∏) |
| **24.7** | ApiClient —á.3 | 2 | `Services/LoyaltyApiClient.cs` —á.3: `SearchGuest()`, `GetGuestCard()`, timeout handling |
| **24.8** | Cache + Offline | 3 | `Services/CacheService.cs` (in-memory TTL), `Services/OfflineQueueService.cs` (SQLite –æ—á–µ—Ä–µ–¥—å) |
| **24.9** | Config + Health | 3 | `Services/ConfigService.cs` (—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫), `Services/HealthCheckService.cs`, `Services/TimeService.cs` |
| **24.10** | Encryption + Errors | 3 | `Utils/Encryption.cs` (AES-256), `Utils/ErrorHandler.cs`, `Utils/HmacHelper.cs` |
| **24.11** | UI Search —á.1 | 3 | `UI/LoyaltySearchWindow.xaml` (—Ä–∞–∑–º–µ—Ç–∫–∞: –ø–æ–ª–µ –≤–≤–æ–¥–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç) |
| **24.12** | UI Search —á.2 | 3 | `UI/LoyaltySearchWindow.xaml.cs` (codebehind: –ø–æ–∏—Å–∫, –≤—ã–±–æ—Ä –≥–æ—Å—Ç—è) |
| **24.13** | UI Operation —á.1 | 3 | `UI/LoyaltyOperationWindow.xaml` (–±–∞–ª–∞–Ω—Å, –Ω–∞—á–∏—Å–ª–∏—Ç—å/—Å–ø–∏—Å–∞—Ç—å, NumPad) |
| **24.14** | UI Operation —á.2 | 3 | `UI/LoyaltyOperationWindow.xaml.cs` (codebehind: –ª–æ–≥–∏–∫–∞) |
| **24.15** | UI Diagnostics | 3 | `UI/DiagnosticsWindow.xaml`, `UI/DiagnosticsWindow.xaml.cs` (ping API, last sync, logs) |
| **24.16** | UI Controls + Styles | 3 | `UI/Controls/NumericKeypad.xaml`, `UI/Controls/NumericKeypad.xaml.cs`, `UI/Styles/MaxLoyaltyStyles.xaml` |
| **24.17** | Metrics + Installer | 3 | `Services/MetricsService.cs`, `MaxLoyaltyIikoInstaller/installer.iss` (Inno Setup), `README.md` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 25: PLUGIN R-Keeper (C++ + C\#) ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **25.1** | C++ DLL scaffold | 3 | `ExternalDLL/external.h`, `ExternalDLL/MaxLoyaltyRK.vcxproj`, `ExternalDLL/dllmain.cpp` |
| **25.2** | external.cpp —á.1 | 2 | `ExternalDLL/external.cpp` —á.1: —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (OnOrder, GetDiscount, Init) |
| **25.3** | external.cpp —á.2 | 2 | `ExternalDLL/external.cpp` —á.2: SharedMemory –∑–∞–ø–∏—Å—å, Launch WPF –ø—Ä–æ—Ü–µ—Å—Å, –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ |
| **25.4** | SharedMemory | 3 | `ExternalDLL/SharedMemory.h`, `ExternalDLL/SharedMemory.cpp` (named mutex, memory mapped file) |
| **25.5** | WPF App scaffold | 4 | `UIApp/MaxLoyaltyRKeeper.csproj`, `UIApp/App.xaml`, `UIApp/App.xaml.cs`, `UIApp/Properties/AssemblyInfo.cs` |
| **25.6** | SharedMemory C\# | 3 | `UIApp/Services/SharedMemoryService.cs` (—á–∏—Ç–∞–µ–º –∏–∑ DLL, –ø–∏—à–µ–º –æ—Ç–≤–µ—Ç) |
| **25.7** | API Client —á.1 | 3 | `UIApp/Services/LoyaltyApiClient.cs` —á.1: HttpClient, auth, HMAC |
| **25.8** | API Client —á.2 | 3 | `UIApp/Services/LoyaltyApiClient.cs` —á.2: Calculate, Finalize, SearchGuest |
| **25.9** | XML API service | 3 | `UIApp/Services/RKeeperXmlApi.cs` (–ø–∞—Ä—Å–∏–Ω–≥ XML –∑–∞–∫–∞–∑–∞, —Ç–æ–≤–∞—Ä—ã, —Å—Ç–æ–ª) |
| **25.10** | Offline + Config | 3 | `UIApp/Services/OfflineQueueService.cs`, `UIApp/Services/ConfigService.cs`, `UIApp/Utils/Encryption.cs` |
| **25.11** | Floating button | 3 | `UIApp/Services/FloatingButtonService.cs` (WPF TopMost –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö), `UIApp/Controls/FloatingButton.xaml` |
| **25.12** | UI Windows —á.1 | 3 | `UIApp/Windows/SearchWindow.xaml`, `UIApp/Windows/SearchWindow.xaml.cs` |
| **25.13** | UI Windows —á.2 | 3 | `UIApp/Windows/OperationWindow.xaml`, `UIApp/Windows/OperationWindow.xaml.cs` |
| **25.14** | UI Styles | 3 | `UIApp/Styles/MaxLoyaltyStyles.xaml`, `UIApp/Styles/Colors.xaml`, `UIApp/README.md` |


***

### ‚ïê‚ïê‚ïê –§–ê–ó–ê 26: CI/CD + –î–ï–ü–õ–û–ô ‚ïê‚ïê‚ïê

| \# | –ò—Ç–µ—Ä–∞—Ü–∏—è | –§–∞–π–ª—ã (‚â§5) | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **26.1** | GitHub Actions CI | 3 | `.github/workflows/ci.yml` (lint, typecheck, build), `.github/workflows/test.yml`, `.github/PULL_REQUEST_TEMPLATE.md` |
| **26.2** | Docker backend | 3 | `apps/backend/Dockerfile`, `apps/backend/.dockerignore`, `docker-compose.prod.yml` —Ñ–∏–Ω–∞–ª—å–Ω—ã–π |
| **26.3** | Docker frontend | 3 | `apps/frontend/Dockerfile`, `apps/frontend/.dockerignore`, `apps/telegram-bot/Dockerfile` |
| **26.4** | Deploy configs | 4 | `fly.toml` (backend), `apps/frontend/vercel.json`, `.github/workflows/deploy-backend.yml`, `.github/workflows/deploy-frontend.yml` |
| **26.5** | Docs —Ñ–∏–Ω–∞–ª | 4 | `docs/api/README.md`, `docs/architecture/README.md`, `docs/deployment/README.md`, `docs/plugins/README.md` |


***

## üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
| :-- | :-- |
| **–í—Å–µ–≥–æ —Ñ–∞–∑** | 26 |
| **–í—Å–µ–≥–æ –∏—Ç–µ—Ä–∞—Ü–∏–π** | **~230** |
| **–§–∞–π–ª–æ–≤ –∑–∞ –∏—Ç–µ—Ä–∞—Ü–∏—é** | 2‚Äì5 (–±–µ–∑–æ–ø–∞—Å–Ω–æ) |
| **–°—Ç—Ä–æ–∫ –Ω–∞ —Ñ–∞–π–ª** | ‚â§ 120 |
| **–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤** | ~550‚Äì600 |
| **–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã—Ö —Å–µ—Å—Å–∏–π** | ~100‚Äì120 |


***

## üéØ –ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´

1. **–ö–æ–º–∞–Ω–¥–∞**: `"–î–µ–ª–∞–µ–º [–Ω–æ–º–µ—Ä –∏—Ç–µ—Ä–∞—Ü–∏–∏]"` ‚Üí —è —Å–æ–∑–¥–∞—é —Ñ–∞–π–ª—ã –≤ –≤–µ—Ç–∫–µ `develop`
2. **–ö—Ä—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã**: `.service.ts` —Ä–∞–∑–±–∏–≤–∞—é—Ç—Å—è –Ω–∞ `part1/part2/part3` ‚Äî –≤ —Ñ–∏–Ω–∞–ª–µ —Å–∫–ª–µ–∏–≤–∞–µ–º
3. **–ü–æ—Å–ª–µ —Ñ–∞–∑—ã**: PR `develop ‚Üí main`, —Ç—ã –ø—Ä–æ–≤–µ—Ä—è–µ—à—å
4. **–ï—Å–ª–∏ —Ñ–∞–π–ª –±–æ–ª—å—à–æ–π**: –≥–æ–≤–æ—Ä–∏—à—å ‚Äî —è —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è—é –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã–º –∫–æ–º–º–∏—Ç–æ–º
5. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –§–∞–∑—ã 0‚Üí1‚Üí2‚Üí3 ‚Äî —ç—Ç–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç, –±–µ–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

***

**–ì–æ—Ç–æ–≤. –ù–∞—á–∏–Ω–∞–µ–º —Å –∏—Ç–µ—Ä–∞—Ü–∏–∏ 0.1?** üöÄ
<span style="display:none">[^4_1][^4_2][^4_3][^4_4]</span>

<div align="center">‚ÅÇ</div>

[^4_1]: Beseda-8.md

[^4_2]: Beseda-12.md

[^4_3]: Beseda-9.md

[^4_4]: Beseda-7.md


---

# –ò —ç—Ç–æ –±—É–¥—É—Ç –æ–±—Å–∞–ª—é—Ç–Ω–æ –ø–æ–ª–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–∏—Å—Ç–µ–º—ã —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –∏—Ç–µ—Ä–∞—Ü–∏–π, –∏–ª–∏ —É—Ä–µ–∑–∞–Ω–Ω—ã–µ? –ü—Ä–æ–≤–µ—Ä—å

–¢–µ–ø–µ—Ä—å —É –º–µ–Ω—è –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞. –î–∞–º —á–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç.

***

## ‚ö†Ô∏è –ß–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç: –ù–ï–¢, –ø–ª–∞–Ω –±—ã–ª –±—ã —É—Ä–µ–∑–∞–Ω–Ω—ã–º

–ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –ø—Ä–æ—Ç–∏–≤ –ø–ª–∞–Ω–∞ ‚Äî –≤–æ—Ç —á—Ç–æ —è –æ–±–Ω–∞—Ä—É–∂–∏–ª:

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å—Ç–∞—Ä–æ–≥–æ –ø–ª–∞–Ω–∞

**1. –§–∞–π–ª—ã –ø–æ 120 —Å—Ç—Ä–æ–∫ ‚Äî —ç—Ç–æ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞**

–†–µ–∞–ª—å–Ω—ã–π `auth.service.ts` –∏–∑ –Ω–∞—à–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç **9 —Å–µ—Ä–≤–∏—Å–æ–≤** –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –º–æ–¥—É–ª—è. –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π `GuestService` —Å —Ä–µ–∞–ª—å–Ω–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π –∑–∞–Ω–∏–º–∞–µ—Ç **500‚Äì800 —Å—Ç—Ä–æ–∫**. –ü—Ä–∏ –ª–∏–º–∏—Ç–µ 120 —Å—Ç—Ä–æ–∫ —Å–µ—Ä–≤–∏—Å —Ä–∞–∑–æ–±—å—ë—Ç—Å—è –Ω–∞ 6‚Äì7 "–∫—É—Å–∫–æ–≤" –±–µ–∑ —Å–≤—è–∑–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Äî —Ñ–∞–π–ª—ã –ø–æ–ª—É—á–∞—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º–∏ –æ–±—Ä—ã–≤–∫–∞–º–∏.

**2. –§–∞–∑—ã –±—ã–ª–∏ –Ω–µ–ø–æ–ª–Ω—ã–º–∏**

–Ø –ø—Ä–æ–ø—É—Å—Ç–∏–ª –≤ —Å—Ç–∞—Ä–æ–º –ø–ª–∞–Ω–µ:

- `ActivityLogService` ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å, —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ **–∫–∞–∂–¥–æ–º** —Å–µ—Ä–≤–∏—Å–µ
- `RoleService`, `PermissionService`, `RbacService`, `UserRoleService` ‚Äî —ç—Ç–æ 4 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–∞, –±—ã–ª–∞ –æ–¥–Ω–∞ –∏—Ç–µ—Ä–∞—Ü–∏—è
- `RegistrationLinkService` ‚Äî –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å —Å —Ç–æ–∫–µ–Ω–∞–º–∏, URL, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π ‚Äî –Ω–µ –±—ã–ª –≤—ã–¥–µ–ª–µ–Ω
- `GuestVisitService` ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä + —Å–µ—Ä–≤–∏—Å ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω
- `BallTransferService` ‚Äî 2-—à–∞–≥–æ–≤—ã–π —Ñ–ª–æ—É —Å SMS, Redis TTL, Prisma transaction ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω
- `POSTransaction` vs `BallTransaction` reconciliation ‚Äî —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞, –Ω–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∞
- **Telegram Mini App** ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–µ Vite/React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –≤ –ø–ª–∞–Ω–µ –±—ã–ª–∞ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞
- C++ DLL (`SharedMemory`, named mutex, memory mapped file) ‚Äî –≤ –ø–ª–∞–Ω–µ 3 –∏—Ç–µ—Ä–∞—Ü–∏–∏, —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–Ω–æ 6‚Äì8
- `SupportTicket` –º–æ–¥–µ–ª—å –∏ —Å–µ—Ä–≤–∏—Å ‚Äî –Ω–µ –±—ã–ª –Ω–∏–≥–¥–µ

**3. –¢–µ—Å—Ç—ã –±—ã–ª–∏ "–¥–ª—è –≥–∞–ª–æ—á–∫–∏"**

–í –¥–∏–∞–ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ `spec.ts` –∏ `e2e-spec.ts` —Ñ–∞–π–ª—ã —Å –º–æ–∫–∞–º–∏, `beforeEach`, `describe`, `it` ‚Äî —ç—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–æ 200‚Äì400 —Å—Ç—Ä–æ–∫ –∫–∞–∂–¥—ã–π. –í –ø–ª–∞–Ω–µ –Ω–∞ –≤—Å—ë —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–æ–¥–∏–ª–æ—Å—å 2‚Äì3 –∏—Ç–µ—Ä–∞—Ü–∏–∏.

**4. DTO –±—ã–ª–∏ –Ω–µ–¥–æ–æ—Ü–µ–Ω–µ–Ω—ã**

–¢–æ–ª—å–∫–æ –¥–ª—è `Guests` –º–æ–¥—É–ª—è: `CreateGuestDto`, `CreateGuestPOSDto`, `CreateGuestLinkDto`, `CreateGuestTelegramDto`, `UpdateGuestProfileDto`, `RequestPhoneChangeDto`, `ConfirmPhoneChangeDto`, `AddChildDto`, `UpdateChildDto`, `GetGuestsQueryDto`, `GetCardByQRDto`, `GetCardBy6DigitDto`, `GetCardByPhoneDto` + Response DTO ‚Äî —ç—Ç–æ **13+ —Ñ–∞–π–ª–æ–≤**, –∞ –≤ –ø–ª–∞–Ω–µ –±—ã–ª–æ 2 –∏—Ç–µ—Ä–∞—Ü–∏–∏ –ø–æ 5 —Ñ–∞–π–ª–æ–≤.

***

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥: —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤

| –¢–∏–ø —Ñ–∞–π–ª–∞ | –†–µ–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä | –ü–æ–¥—Ö–æ–¥ |
| :-- | :-- | :-- |
| `*.service.ts` (–∫—Ä—É–ø–Ω—ã–π) | 400‚Äì800 —Å—Ç—Ä–æ–∫ | –û–¥–∏–Ω –ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª, –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏ |
| `*.service.ts` (–ø—Ä–æ—Å—Ç–æ–π) | 100‚Äì250 —Å—Ç—Ä–æ–∫ | –û–¥–∏–Ω —Ñ–∞–π–ª |
| `*.controller.ts` | 150‚Äì300 —Å—Ç—Ä–æ–∫ | –û–¥–∏–Ω —Ñ–∞–π–ª |
| `*.module.ts` | 30‚Äì60 —Å—Ç—Ä–æ–∫ | –û–¥–∏–Ω —Ñ–∞–π–ª |
| `*.dto.ts` (–æ–¥–∏–Ω DTO) | 20‚Äì50 —Å—Ç—Ä–æ–∫ | 5‚Äì8 DTO –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ |
| `*.spec.ts` | 200‚Äì400 —Å—Ç—Ä–æ–∫ | –û–¥–∏–Ω —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–∏—Å |
| `*.e2e-spec.ts` | 150‚Äì300 —Å—Ç—Ä–æ–∫ | –û–¥–∏–Ω —Ñ–∞–π–ª –Ω–∞ –º–æ–¥—É–ª—å |
| Prisma schema | 600‚Äì800 —Å—Ç—Ä–æ–∫ | –û–¥–∏–Ω –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π —Ñ–∞–π–ª |
| C\# —Å–µ—Ä–≤–∏—Å | 150‚Äì300 —Å—Ç—Ä–æ–∫ | –û–¥–∏–Ω —Ñ–∞–π–ª |
| XAML + codebehind | 100‚Äì200 —Å—Ç—Ä–æ–∫ –∫–∞–∂–¥—ã–π | –ü–∞—Ä–∞ —Ñ–∞–π–ª–æ–≤ |

**–õ–∏–º–∏—Ç —Å—Ç—Ä–æ–∫ —É–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é.** –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫, —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ ‚Äî –±–µ–∑ –∑–∞–≥–ª—É—à–µ–∫, –±–µ–∑ TODO, –±–µ–∑ "–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å–ª–µ–¥—É–µ—Ç".

***

### üìã –ò—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∏—Ç–µ—Ä–∞—Ü–∏–π

1. **1 –∏—Ç–µ—Ä–∞—Ü–∏—è = 1‚Äì3 —Ñ–∞–π–ª–∞** (–Ω–µ 5), –Ω–æ –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª **–ø–æ–ª–Ω—ã–π**
2. –ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –±–æ–ª—å—à–æ–π (>400 —Å—Ç—Ä–æ–∫) ‚Äî –æ–Ω **–æ–¥–∏–Ω —Ñ–∞–π–ª —Ü–µ–ª–∏–∫–æ–º**, –∏—Ç–µ—Ä–∞—Ü–∏—è –ø–æ—Å–≤—è—â–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –µ–º—É
3. DTO –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å–º—ã—Å–ª—É: –≤—Å–µ DTO –æ–¥–Ω–æ–≥–æ –º–æ–¥—É–ª—è ‚Äî –æ–¥–∏–Ω —Ñ–∞–π–ª `*.dto.ts`
4. –¢–µ—Å—Ç—ã ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏, –Ω–µ "–¥–æ–±–∞–≤–∏–º –ø–æ—Ç–æ–º"
5. –ö–∞–∂–¥—ã–π `push_files` ‚Äî –º–∞–∫—Å–∏–º—É–º **3 —Ñ–∞–π–ª–∞**, –∑–∞—Ç–æ –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏

***

### üìä –ü–µ—Ä–µ—Å—á—ë—Ç –æ–±—ä—ë–º–∞

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ä—ã–π –ø–ª–∞–Ω | –†–µ–∞–ª—å–Ω—ã–π |
| :-- | :-- | :-- |
| Backend –∏—Ç–µ—Ä–∞—Ü–∏–∏ | ~80 | **~130** |
| Frontend –∏—Ç–µ—Ä–∞—Ü–∏–∏ | ~60 | **~85** |
| Telegram Mini App | ~9 | **~20** |
| –ü–ª–∞–≥–∏–Ω—ã (iiko + RK) | ~30 | **~45** |
| CI/CD + Docs | ~5 | **~8** |
| **–ò—Ç–æ–≥–æ** | **~230** | **~290** |


***

**–ì–æ—Ç–æ–≤ –ø–µ—Ä–µ—Å–æ—Å—Ç–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∏ –ø–æ–ª–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏. –ù–∞—á–∏–Ω–∞–µ–º?** üöÄ
<span style="display:none">[^5_1][^5_2][^5_3][^5_4][^5_5]</span>

<div align="center">‚ÅÇ</div>

[^5_1]: Beseda-1.md

[^5_2]: Beseda-3.md

[^5_3]: Beseda-2.md

[^5_4]: Beseda-6.md

[^5_5]: Beseda-4.md


---

# –ü–µ—Ä–µ—Å–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω —Ç–∞–∫, —á—Ç–æ–±—ã –≤—Å–µ –∫–æ–¥—ã –±—ã–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–Ω—ã–º–∏ –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–¥–∞–∫—à–Ω, –Ω–µ —É—Ä–µ–∑–∞–Ω–Ω—ã–µ

–¢–µ–ø–µ—Ä—å —É –º–µ–Ω—è –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã –∏–∑ –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–æ–≤. –°–æ—Å—Ç–∞–≤–ª—è—é –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π —á–µ—Å—Ç–Ω—ã–π –ø–ª–∞–Ω.

***

# üèóÔ∏è PRODUCTION-READY –ü–õ–ê–ù: MAX-LOYALTY

## –ü—Ä–∏–Ω—Ü–∏–ø—ã: **–ø–æ–ª–Ω—ã–µ —Ñ–∞–π–ª—ã, –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏, –±–µ–∑ TODO**


***

## ‚öôÔ∏è –ü–ê–†–ê–ú–ï–¢–†–´ –†–ê–ë–û–¢–´

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
| :-- | :-- |
| –§–∞–π–ª–æ–≤ –∑–∞ –æ–¥–∏–Ω `push_files` | **1‚Äì3 —Ñ–∞–π–ª–∞** |
| –°—Ç—Ä–æ–∫ –Ω–∞ —Ñ–∞–π–ª | **–±–µ–∑ –ª–∏–º–∏—Ç–∞** ‚Äî —Å—Ç–æ–ª—å–∫–æ, —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ–π –ª–æ–≥–∏–∫–∏ |
| –ó–∞–≥–ª—É—à–∫–∏ / TODO / "–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ" | **–ó–ê–ü–†–ï–©–ï–ù–´** |
| –¢–µ—Å—Ç—ã | –ü–æ–ª–Ω—ã–µ `describe/it/beforeEach/afterEach` —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –º–æ–∫–∞–º–∏ |
| DTO | –í—Å–µ –ø–æ–ª—è —Å `@ApiProperty`, `@IsString`, –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞–º–∏, –ø—Ä–∏–º–µ—Ä–∞–º–∏ |
| –°–µ—Ä–≤–∏—Å—ã | –í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é, —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏, –∫–µ—à–µ–º, –ª–æ–≥–∞–º–∏ |
| –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã | –í—Å–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã `@ApiTags`, `@ApiBearerAuth`, `@ApiResponse`, guards |


***

## üìÅ –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –ú–û–ù–û–†–ï–ü–û

```
max-loyalty/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ backend/                    # NestJS API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/           # JWT, guards, MFA, impersonation
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tenants/        # Multi-tenant, –ª–∏–º–∏—Ç—ã, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users/          # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —Ä–æ–ª–∏, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rbac/           # RoleService, PermissionService, RbacService
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ restaurants/    # –†–µ—Å—Ç–æ—Ä–∞–Ω—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guests/         # –ì–æ—Å—Ç–∏, –∫–∞—Ä—Ç—ã, –¥–µ—Ç–∏, –ø–µ—Ä–µ–≤–æ–¥—ã, –≤–∏–∑–∏—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ activity-log/   # –ï–¥–∏–Ω—ã–π –∞—É–¥–∏—Ç-–ª–æ–≥
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ loyalty/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ builder/    # –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: —Å–∏—Å—Ç–µ–º–∞, –ø—Ä–∞–≤–∏–ª–∞, —É—Ä–æ–≤–Ω–∏, –ø—Ä–æ–º–æ
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ engine/     # –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —ç–∫—Å–ø–∏—Ä–∞—Ü–∏—è, –∞–ø–≥—Ä–µ–π–¥
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pos/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ iiko/       # Webhook + PULL + reconciliation
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rkeeper/    # Webhook XML + PULL + reconciliation
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ billing/        # –ü–æ–¥–ø–∏—Å–∫–∏, –∏–Ω–≤–æ–π—Å—ã, –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram/       # Bot (Telegraf) + Mini App auth
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analytics/      # Owner / Admin / Manager / Guest + Export
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notifications/  # Email (Resend) + SMS (SMSC) + Telegram push
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sse/            # Server-Sent Events
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ storage/        # S3 uploads, presigned URLs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ decorators/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ filters/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ interceptors/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pipes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test/                   # E2E —Ç–µ—Å—Ç—ã (Supertest)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ frontend/                   # Next.js 14 App Router
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ (auth)/         # login, register, forgot, reset, 2fa
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ (owner)/        # Owner dashboard, tenants, billing, analytics
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ (admin)/        # Admin: guests, loyalty, pos, analytics, settings
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ (manager)/      # Manager dashboard
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ (cashier)/      # Cashier interface
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ui/             # shadcn/ui –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ layout/         # Sidebar, Navbar, Breadcrumbs, GlobalSearch
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ guests/         # GuestsTable, GuestProfile, ManualAdjust
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ loyalty/        # RuleBuilder, LevelTimeline, PromoWizard
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ analytics/      # Recharts –æ–±—ë—Ä—Ç–∫–∏
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ pos/            # POSStatus, POSConfig, POSSyncLog
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ billing/        # SubscriptionCard, InvoiceTable
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ owner/          # TenantsTable, TenantDetails, ChangePlan
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ store/              # Zustand (auth, ui, restaurant, notifications)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ lib/                # api client, utils, validations
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ types/
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ telegram-miniapp/           # Vite + React (–æ—Ç–¥–µ–ª—å–Ω—ã–π –¥–µ–ø–ª–æ–π)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ screens/            # Card, QR, History, Profile, Children, Transfer
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ services/
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ telegram-bot/               # NestJS + Telegraf
‚îÇ       ‚îî‚îÄ‚îÄ src/
‚îÇ           ‚îú‚îÄ‚îÄ scenes/             # start, auth, card, history, promo, support
‚îÇ           ‚îú‚îÄ‚îÄ handlers/
‚îÇ           ‚îú‚îÄ‚îÄ keyboards/
‚îÇ           ‚îî‚îÄ‚îÄ services/
‚îÇ
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ database/                   # Prisma schema + migrations + seed
‚îÇ   ‚îú‚îÄ‚îÄ shared/                     # –û–±—â–∏–µ —Ç–∏–ø—ã, —É—Ç–∏–ª–∏—Ç—ã, –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ config/                     # ESLint, TypeScript, Jest –ø—Ä–µ—Å–µ—Ç—ã
‚îÇ
‚îú‚îÄ‚îÄ plugins/
‚îÇ   ‚îú‚îÄ‚îÄ iiko/                       # C# WPF –ø–ª–∞–≥–∏–Ω (plugin.cs + UI + API client)
‚îÇ   ‚îî‚îÄ‚îÄ rkeeper/                    # C++ DLL + C# WPF –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ
‚îú‚îÄ‚îÄ .github/workflows/
‚îú‚îÄ‚îÄ docs/
‚îî‚îÄ‚îÄ docker-compose.yml
```


***

## üìã –ü–û–õ–ù–´–ô –ü–õ–ê–ù –ò–¢–ï–†–ê–¶–ò–ô

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 0 ‚Äî –ú–û–ù–û–†–ï–ü–û –°–ö–ï–õ–ï–¢ (9 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **0.1** | `package.json` (root) | Workspaces, turbo, scripts: dev/build/test/lint –≤—Å–µ apps |
|  | `turbo.json` | Pipeline: build‚Üítest‚Üílint, caching |
|  | `.gitignore` | Node, Prisma, Next.js, env, dist |
| **0.2** | `docker-compose.yml` | PostgreSQL 15, Redis 7, PgBouncer ‚Äî —Å health checks, volumes, env |
|  | `docker-compose.prod.yml` | Prod override: resource limits, restart policies |
|  | `.env.example` | –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ (50+ vars) |
| **0.3** | `packages/config/tsconfig.base.json` | –°—Ç—Ä–æ–≥–∏–π TS config, paths |
|  | `packages/config/eslint-preset.js` | NestJS + Next.js + Prettier rules |
|  | `packages/config/jest.config.base.js` | Base Jest config —Å coverage thresholds |
| **0.4** | `apps/backend/package.json` | –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: NestJS, Prisma, BullMQ, Redis, class-validator, Swagger, bcrypt, telegraf, jose, ioredis, node-cache, papaparse, exceljs, pdfkit |
|  | `apps/backend/tsconfig.json` | Extends base, paths –¥–ª—è –º–æ–¥—É–ª–µ–π |
|  | `apps/backend/nest-cli.json` | Webpack, assets |
| **0.5** | `apps/backend/src/main.ts` | Bootstrap: ValidationPipe, Swagger, CORS, Helmet, compression, rate limit global, shutdown hooks, logging |
|  | `apps/backend/src/app.module.ts` | –í—Å–µ –º–æ–¥—É–ª–∏ + ConfigModule + BullMQ + Redis + Prisma |
|  | `apps/backend/src/app.controller.ts` | Health check: GET `/health`, GET `/health/db`, GET `/health/redis` |
| **0.6** | `apps/frontend/package.json` | Next.js 14, Tailwind, shadcn, Zustand, TanStack Query, React Hook Form, Zod, Recharts, TanStack Table, date-fns, Axios, sonner |
|  | `apps/frontend/next.config.ts` | rewrites, headers, image domains, env |
|  | `apps/frontend/tailwind.config.ts` | shadcn preset, custom colours |
| **0.7** | `apps/frontend/src/app/layout.tsx` | Root layout: fonts, ThemeProvider, QueryProvider, Toaster |
|  | `apps/frontend/src/app/globals.css` | CSS variables –¥–ª—è shadcn + custom |
|  | `apps/frontend/src/lib/utils.ts` | `cn()`, `formatDate()`, `formatCurrency()`, `formatPhone()`, `truncate()`, `pluralize()` |
| **0.8** | `apps/telegram-miniapp/package.json` | Vite, React, TG Web App SDK, TanStack Query, Zustand, date-fns |
|  | `apps/telegram-miniapp/vite.config.ts` | Build config, base URL |
|  | `apps/telegram-miniapp/src/main.tsx` | App entry, QueryProvider, TelegramProvider |
| **0.9** | `apps/telegram-bot/package.json` | NestJS, Telegraf, node-telegram-bot-api |
|  | `apps/telegram-bot/src/main.ts` | Bootstrap bot |
|  | `apps/telegram-bot/src/app.module.ts` | TelegrafModule, ConfigModule, –≤—Å–µ —Å—Ü–µ–Ω—ã |
| **0.10** | `packages/database/package.json` | Prisma deps |
|  | `packages/database/src/prisma.service.ts` | PrismaService: connect, onModuleInit, enableShutdownHooks, query logging, middleware tenant isolation |
|  | `packages/database/src/prisma.module.ts` | PrismaModule global |
| **0.11** | `packages/shared/src/types/index.ts` | –í—Å–µ –æ–±—â–∏–µ TypeScript —Ç–∏–ø—ã: PaginatedResponse, ApiResponse, UserRole, Permission enum, TenantContext |
|  | `packages/shared/src/constants/index.ts` | –í—Å–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã: BALL_TO_RUBLE_RATIO=1, MIN_CHECK_AMOUNT=50, MAX_REDEEM_PERCENT=20, MAX_CHILDREN=3, TRANSFER_TTL=600, –∏ –¥—Ä. |
|  | `packages/shared/src/utils/index.ts` | `generateQRCode()`, `generate6DigitCode()`, `generateSlug()`, `maskPhone()`, `calculateAge()`, `isExpired()` |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 1 ‚Äî PRISMA SCHEMA (8 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **1.1** | `schema.prisma` —á.1 | Generator, datasource, –≤—Å–µ **ENUMS** (UserRole, Gender, CardStatus, RegistrationSource, BallTransactionType, TransferStatus, SubscriptionPlan, SubscriptionStatus, BillingPeriod, PaymentStatus, PaymentProvider, POSSystem, SyncStatus, LoyaltySystemType, LoyaltyCardMode, PromoTriggerType, ConflictResolutionStrategy, NotificationChannel, NotificationStatus, ActivityLogAction, TransferStatus) |
| **1.2** | `schema.prisma` —á.2 | **Auth models**: User (–≤—Å–µ –ø–æ–ª—è + soft delete + indexes), UserTenantRole, UserRestaurantRole, UserSession, PasswordResetToken, ImpersonationSession |
| **1.3** | `schema.prisma` —á.3 | **Tenants \& Billing**: Tenant, TenantLimits, BillingInfo, Restaurant, Subscription, SubscriptionHistory, Payment, Invoice |
| **1.4** | `schema.prisma` —á.4 | **Guests**: GuestProfile, GuestChild, GuestCard (UNIFIED/SEPARATE, –≤—Å–µ –±–∞–ª–∞–Ω—Å—ã, soft delete), RegistrationLink |
| **1.5** | `schema.prisma` —á.5 | **Transactions**: BallTransaction (–≤—Å–µ —Ç–∏–ø—ã, snapshot), BallTransfer (PENDING‚ÜíVERIFIED‚ÜíCOMPLETED), GuestVisit, PromoBallGranted |
| **1.6** | `schema.prisma` —á.6 | **Loyalty**: LoyaltySystem, LoyaltyRule + LoyaltyRuleVersion, LoyaltyLevel + LoyaltyLevelVersion, LoyaltyPromo + LoyaltyPromoVersion |
| **1.7** | `schema.prisma` —á.7 | **POS + Telegram + Analytics**: POSIntegration, POSTransaction, POSSync, TelegramBot, TelegramUser, TelegramSession, AnalyticsDailySnapshot, AnalyticsMonthlySnapshot |
| **1.8** | `schema.prisma` —á.8 | **Logs + Notifications**: ActivityLog (partition-ready), Notification, NotificationLog, GuestNotificationSettings. **–í—Å–µ composite/partial indexes**, CHECK constraints –≤ migration |
| **1.9** | `packages/database/prisma/migrations/` | `0001_initial.sql` ‚Äî zero-downtime: –≤—Å–µ CONCURRENT indexes, CHECK constraints |
|  | `packages/database/prisma/seed.ts` | –ü–æ–ª–Ω—ã–π seed: Owner, Tenant, 2 —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, —Ç–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω, LoyaltySystem, 3 —É—Ä–æ–≤–Ω—è, 3 –ø—Ä–∞–≤–∏–ª–∞, 2 –ø—Ä–æ–º–æ, 10 —Ç–µ—Å—Ç–æ–≤—ã—Ö –≥–æ—Å—Ç–µ–π —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 2 ‚Äî BACKEND COMMON (12 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **2.1** | `common/errors/error-codes.enum.ts` | –í—Å–µ ~50 –∫–æ–¥–æ–≤: Auth, Loyalty, Billing, POS, Validation, System |
|  | `common/errors/app.exception.ts` | `AppException extends HttpException` —Å `errorCode`, `details` |
|  | `common/errors/business.exceptions.ts` | 15+ –≥–æ—Ç–æ–≤—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π: `InsufficientBalanceException`, `CardBlockedException`, `LimitExceededException`, –∏ –¥—Ä. |
| **2.2** | `common/filters/all-exceptions.filter.ts` | Global filter: Prisma errors ‚Üí HTTP, AppException ‚Üí structured JSON, unknown ‚Üí 500. –õ–æ–≥–∏—Ä—É–µ—Ç stack trace. Request ID –∏–∑ header. |
|  | `common/filters/prisma-exception.filter.ts` | –ú–∞–ø–ø–∏–Ω–≥ –≤—Å–µ—Ö Prisma error codes: P2002‚Üí409, P2025‚Üí404, P2034‚Üíretry –∏ –¥—Ä. |
| **2.3** | `common/interceptors/logging.interceptor.ts` | –õ–æ–≥–∏—Ä—É–µ—Ç: method, path, statusCode, duration, userId, tenantId |
|  | `common/interceptors/transform.interceptor.ts` | –û–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç –≤ `{ success: true, data: ... }` |
|  | `common/interceptors/timeout.interceptor.ts` | 30 —Å–µ–∫ —Ç–∞–π–º–∞—É—Ç —Å `TimeoutError` |
| **2.4** | `common/interceptors/idempotency.interceptor.ts` | –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: —á–∏—Ç–∞–µ—Ç `Idempotency-Key` header, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Redis, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç 24—á, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π |
|  | `common/middleware/request-id.middleware.ts` | –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç UUID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, –ø–∏—à–µ—Ç –≤ header `X-Request-Id` |
|  | `common/middleware/tenant.middleware.ts` | –ò–∑–≤–ª–µ–∫–∞–µ—Ç `tenantId` –∏–∑ JWT, –ø–∏—à–µ—Ç –≤ `req.tenantId`, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–µ–Ω–∞–Ω—Ç–∞ —á–µ—Ä–µ–∑ Redis cache |
| **2.5** | `common/middleware/rate-limit.middleware.ts` | Per-role –ª–∏–º–∏—Ç—ã: GUEST=60, CASHIER=120, MANAGER=200, ADMIN=500, OWNER=1000, POS-webhooks=10/sec. Redis sliding window. Headers X-RateLimit-* |
|  | `common/pipes/validation.pipe.ts` | –ö–∞—Å—Ç–æ–º–Ω—ã–π ValidationPipe —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—à–∏–±–æ–∫ –≤ `{ field, value, constraints }` |
|  | `common/pipes/parse-uuid.pipe.ts` | UUID –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ |
| **2.6** | `common/decorators/current-user.decorator.ts` | `@CurrentUser()` –∏ `@CurrentUser('id')` |
|  | `common/decorators/current-tenant.decorator.ts` | `@CurrentTenant()` |
|  | `common/decorators/api-paginated.decorator.ts` | Swagger –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è paginated –æ—Ç–≤–µ—Ç–æ–≤ |
|  | `common/decorators/idempotency.decorator.ts` | `@RequiresIdempotencyKey()` ‚Äî metadata –¥–ª—è interceptor |
| **2.7** | `common/utils/hash.util.ts` | `hashPassword()`, `comparePassword()` (bcrypt, 12 rounds), `hashToken()` (SHA-256) |
|  | `common/utils/crypto.util.ts` | AES-256-GCM encrypt/decrypt –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è API –∫–ª—é—á–µ–π POS |
|  | `common/utils/qr.util.ts` | `generateQRCode()` ‚Äî crypto random 32 bytes hex, —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è caller'–æ–º |
|  | `common/utils/digit-code.util.ts` | `generate6DigitCode()` ‚Äî crypto random, –Ω–µ 000000 |
| **2.8** | `common/utils/pagination.util.ts` | `buildPaginationMeta()`, `parsePaginationQuery()`, `buildPrismaSkipTake()` |
|  | `common/utils/date.util.ts` | `isToday()`, `isBirthday()`, `daysBetween()`, `startOfDay()`, `isInactive(days)`, `formatRu()` |
|  | `common/utils/phone.util.ts` | `normalizePhone()` (‚Üí79xxxxxxxxx), `maskPhone()` (‚Üí79XX XXX XX 90), `isValidRuPhone()` |
| **2.9** | `config/app.config.ts` | `@nestjs/config` —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, joi –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö env |
|  | `config/database.config.ts` | DATABASE_URL, connection pool settings |
|  | `config/jwt.config.ts` | ACCESS_SECRET, REFRESH_SECRET, ACCESS_TTL=900, REFRESH_TTL=2592000 |
|  | `config/redis.config.ts` | Redis connection, retry strategy |
| **2.10** | `config/mail.config.ts` | Resend API key, from address, templates path |
|  | `config/sms.config.ts` | SMSC login/password, Twilio fallback |
|  | `config/telegram.config.ts` | BOT_TOKEN (shared), MINI_APP_URL, WEBHOOK_DOMAIN |
|  | `config/billing.config.ts` | YooKassa shop ID/secret, Stripe secret, CloudPayments keys |
| **2.11** | `common/services/redis.service.ts` | –ü–æ–ª–Ω—ã–π Redis —Å–µ—Ä–≤–∏—Å: `get/set/setex/del/keys/incr/expire/ttl/hset/hget/lpush/lrange`. –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π. |
|  | `common/services/cache.service.ts` | Multi-level cache: L1=NodeCache (in-memory, max 5 min), L2=Redis. –ú–µ—Ç–æ–¥—ã: `get/set/del/invalidatePattern`. CACHE_KEYS –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã. |
| **2.12** | `common/services/storage.service.ts` | S3 (AWS SDK v3): `uploadFile()`, `getPresignedUrl()`, `deleteFile()`, `getPublicUrl()`. Bucket: avatars, exports, loyalty-cards. |
|  | `common/services/queue.service.ts` | BullMQ wrapper: `addJob()`, `addBulk()`, `getJobStatus()`. Queue names enum. |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 3 ‚Äî AUTH MODULE (14 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **3.1** | `modules/auth/dto/auth.dto.ts` | `RegisterOwnerDto`, `LoginDto` (email –∏–ª–∏ phone), `RefreshTokenDto`, `ForgotPasswordDto`, `ResetPasswordDto`, `ChangePasswordDto`, `VerifyEmailDto`, `EnableMfaDto`, `VerifyMfaDto`, `ImpersonateDto` ‚Äî –≤—Å–µ —Å `@ApiProperty` –∏ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞–º–∏ |
| **3.2** | `modules/auth/strategies/jwt.strategy.ts` | JWT access token —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: payload validation, blacklist check –≤ Redis, tenantId –∏–∑ payload |
|  | `modules/auth/strategies/refresh-jwt.strategy.ts` | Refresh token –∏–∑ HttpOnly cookie, –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î |
|  | `modules/auth/strategies/types.ts` | `JwtPayload`, `RefreshPayload`, `ImpersonationPayload` |
| **3.3** | `modules/auth/guards/jwt-auth.guard.ts` | JwtAuthGuard: –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç `@Public()`, –¥–æ–±–∞–≤–ª—è–µ—Ç `req.user` |
|  | `modules/auth/guards/roles.guard.ts` | RolesGuard: —á–∏—Ç–∞–µ—Ç `@Roles()`, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `req.user.role` |
|  | `modules/auth/guards/permissions.guard.ts` | PermissionsGuard: —á–∏—Ç–∞–µ—Ç `@RequirePermission()`, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç user permissions |
|  | `modules/auth/guards/step-up-auth.guard.ts` | StepUpAuthGuard: –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Ç—Ä–µ–±—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (MFA –∏–ª–∏ –ø–∞—Ä–æ–ª—å) |
|  | `modules/auth/guards/tenant-access.guard.ts` | TenantAccessGuard: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ user –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç tenantId –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ |
| **3.4** | `modules/auth/decorators/roles.decorator.ts` | `@Roles(...roles)` |
|  | `modules/auth/decorators/permissions.decorator.ts` | `@RequirePermission(permission)` |
|  | `modules/auth/decorators/public.decorator.ts` | `@Public()` ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç JWT guard |
|  | `modules/auth/decorators/current-user.decorator.ts` | `@CurrentUser()` –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç |
|  | `modules/auth/decorators/step-up.decorator.ts` | `@StepUpAuth()` |
| **3.5** | `modules/auth/services/password.service.ts` | `hashPassword()`, `comparePassword()`, `validatePasswordStrength()` (–º–∏–Ω. 8 —Å–∏–º–≤–æ–ª–æ–≤, 1 —Ü–∏—Ñ—Ä–∞, 1 –±—É–∫–≤–∞), `generateRandomPassword()` |
|  | `modules/auth/services/password-history.service.ts` | –•—Ä–∞–Ω–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –ø–∞—Ä–æ–ª–µ–π, `isPasswordReused()` |
| **3.6** | `modules/auth/services/token.service.ts` | `generateAccessToken()`, `generateRefreshToken()`, `verifyAccessToken()`, `verifyRefreshToken()`, `revokeToken()`, `revokeAllUserTokens()` |
|  | `modules/auth/services/session.service.ts` | `createSession()` (max 5 sessions), `findSession()`, `invalidateSession()`, `getUserActiveSessions()`, `pruneOldSessions()` |
| **3.7** | `modules/auth/services/otp.service.ts` | `generateOTP()` (6 —Ü–∏—Ñ—Ä, crypto random), `saveOTP()` –≤ Redis TTL=10min, `verifyOTP()`, rate limit –ø–æ–ø—ã—Ç–æ–∫ (5 –ø–æ–ø—ã—Ç–æ–∫), `sendSmsOTP()` |
|  | `modules/auth/services/email-verification.service.ts` | `sendVerificationEmail()`, `verifyEmail()`, —Ç–æ–∫–µ–Ω 24—á |
| **3.8** | `modules/auth/services/mfa.service.ts` | TOTP: `generateSecret()`, `generateQRCodeUrl()`, `verifyTOTP()`, `enableMFA()`, `disableMFA()`, `verifyMFAOnLogin()` |
|  | `modules/auth/services/rate-limit.service.ts` | `checkLoginAttempts()` (5 –ø–æ–ø—ã—Ç–æ–∫ ‚Üí 30 –º–∏–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞), `recordFailedAttempt()`, `resetAttempts()` ‚Äî Redis sliding window |
| **3.9** | `modules/auth/services/auth.service.ts` —á.1 | `registerOwner()`: —Å–æ–∑–¥–∞—ë—Ç User + UserTenantRole(OWNER) + Tenant + TenantLimits + BillingInfo + LoyaltySystem –≤ –æ–¥–Ω–æ–π Prisma —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. `validateUser()`: bcrypt compare, rate limit check, isBlocked check |
| **3.10** | `modules/auth/services/auth.service.ts` —á.2 | `login()`: validate ‚Üí MFA check ‚Üí session create ‚Üí generate tokens ‚Üí set cookie. `refresh()`: verify refresh token ‚Üí rotate ‚Üí new tokens. `logout()`: blacklist token, delete session, clear cookie. `logoutAll()`: blacklist all user tokens |
| **3.11** | `modules/auth/services/auth.service.ts` —á.3 | `forgotPassword()`, `resetPassword()` (—Å –∏—Å—Ç–æ—Ä–∏–µ–π –ø–∞—Ä–æ–ª–µ–π), `changePassword()`, `impersonate()` (—Å–æ–∑–¥–∞—ë—Ç ImpersonationSession, –æ—Å–æ–±—ã–π JWT payload —Å `isImpersonating:true`), `stopImpersonation()` |
| **3.12** | `modules/auth/auth.controller.ts` | –í—Å–µ endpoints: POST /auth/register, /login, /refresh, /logout, /logout-all, /forgot-password, /reset-password, /change-password, /verify-email, /mfa/enable, /mfa/disable, /mfa/verify, /impersonate, /impersonate/stop, GET /auth/me, /auth/sessions |
|  | `modules/auth/auth.module.ts` | –í—Å–µ providers, JwtModule, PassportModule |
| **3.13** | `modules/auth/auth.service.spec.ts` | Unit —Ç–µ—Å—Ç—ã: `registerOwner`, `login` (success + wrong password + blocked + MFA), `refresh` (success + expired), `logout`, `forgotPassword`. –ü–æ–ª–Ω—ã–µ –º–æ–∫–∏ PrismaService, RedisService, MailService |
| **3.14** | `test/auth.e2e-spec.ts` | E2E: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Owner, –ª–æ–≥–∏–Ω, –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞, refresh, –ª–æ–≥–∞—É—Ç, rate limiting (6 –Ω–µ–≤–µ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫), MFA flow |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 4 ‚Äî RBAC MODULE (6 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **4.1** | `modules/rbac/rbac.types.ts` | `Permission` enum (~25 permissions: `create:guest`, `read:guest`, `manage:balls-manual`, `manage:loyalty-system`, ...), `RolePermissionsMap` ‚Äî —á—Ç–æ –º–æ–∂–µ—Ç –∫–∞–∂–¥–∞—è —Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|  | `modules/rbac/role-permissions.map.ts` | –ü–æ–ª–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ OWNER/RESTAURANTADMIN/MANAGER/CASHIER/GUEST ‚Üí Permission[] |
| **4.2** | `modules/rbac/services/role.service.ts` | `assignRole()`, `revokeRole()`, `getUserRoles()`, `getUserTenantRole()`, `getUserRestaurantRole()`, `hasRole()` |
|  | `modules/rbac/services/permission.service.ts` | `grantPermission()`, `revokePermission()`, `getUserPermissions()`, `hasPermission()`, `getEffectivePermissions()` (—Ä–æ–ª—å + –∫–∞—Å—Ç–æ–º–Ω—ã–µ) |
| **4.3** | `modules/rbac/services/rbac.service.ts` | `checkAccess(userId, tenantId, permission, restaurantId?)` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏. `canManageUser()` ‚Äî –∏–µ—Ä–∞—Ä—Ö–∏—è —Ä–æ–ª–µ–π. `canImpersonate()`. `getAccessibleRestaurants()`. |
|  | `modules/rbac/services/activity-log.service.ts` | `log(dto: CreateActivityLogDto)`: —Å–æ–∑–¥–∞—ë—Ç ActivityLog —Å tenantId, actorUserId, action, entityType/Id, changes (JSON diff), metadata, ip, userAgent |
| **4.4** | `modules/rbac/guards/role.guard.ts` | RoleGuard: –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ `@Roles()`, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á–µ—Ä–µ–∑ RbacService, 403 —Å –¥–µ—Ç–∞–ª—è–º–∏ |
|  | `modules/rbac/guards/permission.guard.ts` | PermissionGuard: –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ `@RequirePermission()`, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç effective permissions |
|  | `modules/rbac/guards/restaurant.guard.ts` | RestaurantGuard: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ user –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ restaurantId –∏–∑ params/body |
| **4.5** | `modules/rbac/rbac.controller.ts` | Admin endpoints: GET/POST `/rbac/users/:id/permissions`, GET/POST `/rbac/users/:id/roles`, GET `/rbac/roles`, GET `/rbac/activity-log` |
|  | `modules/rbac/rbac.module.ts` | Module —Å exports –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è guards |
| **4.6** | `modules/rbac/rbac.service.spec.ts` | Unit —Ç–µ—Å—Ç—ã: `checkAccess` –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π –∏ permissions, –∏–µ—Ä–∞—Ä—Ö–∏—è (Manager –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∞—Ç—å Admins), impersonation rules |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 5 ‚Äî TENANTS + USERS (10 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **5.1** | `modules/tenants/dto/tenant.dto.ts` | `CreateTenantDto`, `UpdateTenantDto`, `ChangePlanDto` (—Å reason), `BlockTenantDto`, `TenantFilterDto`, `TenantLimitsDto`, `UpdateBillingInfoDto` |
| **5.2** | `modules/tenants/services/tenants.service.ts` —á.1 | `create()` (Owner registration flow), `findAll()` (Owner —Ç–æ–ª—å–∫–æ, —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏), `findOne()`, `findBySlug()`, `update()` |
| **5.3** | `modules/tenants/services/tenants.service.ts` —á.2 | `block()`, `unblock()`, `changePlan()` (–æ–±–Ω–æ–≤–ª—è–µ—Ç TenantLimits, ActivityLog), `delete()` (soft, —Ç–æ–ª—å–∫–æ Owner), `getStats()` |
| **5.4** | `modules/tenants/services/tenant-limits.service.ts` | `checkRestaurantLimit()`, `checkGuestLimit()`, `checkPOSLimit()`, `incrementCounter()`, `decrementCounter()`, `getLimitsUsage()`. –ö–µ—à–∏—Ä—É–µ—Ç—Å—è –≤ Redis. |
|  | `modules/tenants/services/tenant-usage.service.ts` | –†–µ–∞–ª—å–Ω–æ —Å—á–∏—Ç–∞–µ—Ç –∏–∑ –ë–î: `recalculateLimits()` (CRON –µ–∂–µ–¥–Ω–µ–≤–Ω–æ), `getCurrentUsage()` |
| **5.5** | `modules/tenants/tenants.controller.ts` | OWNER: CRUD tenants, block, changePlan. ADMIN: GET own tenant info, update settings |
|  | `modules/tenants/tenants.module.ts` | Module |
| **5.6** | `modules/users/dto/user.dto.ts` | `CreateUserDto`, `UpdateUserDto`, `InviteUserDto` (email + role + restaurants), `UserFilterDto`, `ChangeRoleDto`, `BlockUserDto` |
| **5.7** | `modules/users/services/users.service.ts` —á.1 | `findAll()` (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –ø–æ —Ä–æ–ª–∏, —Å—Ç–∞—Ç—É—Å—É, —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É, –ø–æ–∏—Å–∫), `findOne()`, `findByEmail()`, `findByPhone()`, `findByTelegramId()` |
| **5.8** | `modules/users/services/users.service.ts` —á.2 | `create()`, `invite()` (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É + email), `update()`, `changeRole()`, `block()`, `unblock()`, `softDelete()`. –í—Å–µ —Å ActivityLog. |
| **5.9** | `modules/users/users.controller.ts` | OWNER: –≤—Å–µ users. ADMIN: users —Å–≤–æ–µ–≥–æ tenant. MANAGER: read-only –∫–∞—Å—Å–∏—Ä—ã. |
|  | `modules/users/users.module.ts` | Module |
| **5.10** | `modules/restaurants/dto/restaurant.dto.ts` | `CreateRestaurantDto`, `UpdateRestaurantDto`, `RestaurantSettingsDto`, `RestaurantFilterDto` |
|  | `modules/restaurants/services/restaurants.service.ts` | `create()` (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç—ã!), `findAll()`, `findOne()`, `update()`, `delete()` (soft), `getStats()` ‚Äî —Å—Ä–µ–¥–Ω–µ–µ –ø–æ—Å–µ—â–µ–Ω–∏–π, –≤—ã—Ä—É—á–∫–∞ |
|  | `modules/restaurants/restaurants.controller.ts` + `restaurants.module.ts` | CRUD endpoints —Å RBAC |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 6 ‚Äî GUESTS MODULE (20 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **6.1** | `modules/guests/dto/guest.dto.ts` | `CreateGuestDto`, `CreateGuestPOSDto`, `CreateGuestLinkDto`, `CreateGuestTelegramDto` ‚Äî –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å –ø–æ–ª–Ω—ã–º–∏ `@ApiProperty` |
| **6.2** | `modules/guests/dto/guest-profile.dto.ts` | `UpdateGuestProfileDto`, `RequestPhoneChangeDto`, `ConfirmPhoneChangeDto`, `AddChildDto`, `UpdateChildDto` |
| **6.3** | `modules/guests/dto/guest-card.dto.ts` | `GetCardByQRDto`, `GetCardBy6DigitDto`, `GetCardByPhoneDto`, `BlockGuestCardDto`, `UnblockGuestCardDto`, `GetGuestsQueryDto` (–≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã: level, status, balance range, birthday month, last visit, search, segment, pagination, sort) |
| **6.4** | `modules/guests/dto/ball-transaction.dto.ts` | `EarnBallsDto`, `RedeemBallsDto`, `ManualAddBallsDto`, `ManualSubtractBallsDto`, `CancelBallTransactionDto`, `GetBallTransactionsQueryDto` |
| **6.5** | `modules/guests/dto/ball-transfer.dto.ts` | `InitiateBallTransferDto`, `ConfirmBallTransferDto`, `CancelBallTransferDto` |
| **6.6** | `modules/guests/services/guest.service.ts` —á.1 | `createGuest()` ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π: —Å–æ–∑–¥–∞—ë—Ç User + GuestProfile + GuestCard –≤ –æ–¥–Ω–æ–π Prisma —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥—É–±–ª–∏ phone. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç QR + 6-digit –∫–æ–¥. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. ActivityLog. |
| **6.7** | `modules/guests/services/guest.service.ts` —á.2 | `createGuestPOS()`, `createGuestByLink()` (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω —Å—Å—ã–ª–∫–∏, maxUses), `createGuestTelegram()` (linkTelegramId). |
| **6.8** | `modules/guests/services/guest.service.ts` —á.3 | `findAll()` —Å –ø–æ–ª–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π (Prisma WHERE builder), `findOne()`, `findByPhone()`, `findByQR()`, `findBy6DigitCode()`, `search()` (full-text PostgreSQL) |
| **6.9** | `modules/guests/services/guest.service.ts` —á.4 | `updateProfile()` (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: 1 —Ä–∞–∑ –≤ 3 –º–µ—Å—è—Ü–∞), `requestPhoneChange()` (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SMS OTP), `confirmPhoneChange()` (–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç OTP, –æ–±–Ω–æ–≤–ª—è–µ—Ç), `softDelete()` (GDPR), `export()` (CSV/XLSX) |
| **6.10** | `modules/guests/services/guest.service.ts` —á.5 | `addChild()` (–º–∞–∫—Å 3), `updateChild()`, `deleteChild()` (soft delete). `mergeGuests()` ‚Äî –ø–µ—Ä–µ–Ω–æ—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã. `getSegments()` ‚Äî VIP/Regular/AtRisk/Lost/New. |
| **6.11** | `modules/guests/services/guest-card.service.ts` | `block()` (—Å ActivityLog + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ), `unblock()`, `regenerateQR()`, `regenerate6DigitCode()`, `requestDataDeletion()` (GDPR: —É–¥–∞–ª—è–µ—Ç User, –æ—Å—Ç–∞–≤–ª—è–µ—Ç –∞–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏), `migrateCard()` (UNIFIED‚ÜíSEPARATE) |
| **6.12** | `modules/guests/services/ball-transaction.service.ts` —á.1 | `earn()`: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞—Ä—Ç—É, —Å–æ–∑–¥–∞—ë—Ç BallTransaction(EARN), –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã (Prisma transaction + pessimistic lock), regenerateQR, createGuestVisit, ActivityLog, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ |
| **6.13** | `modules/guests/services/ball-transaction.service.ts` —á.2 | `redeem()`: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å, –ª–∏–º–∏—Ç —Å–ø–∏—Å–∞–Ω–∏—è (20% –æ—Ç —á–µ–∫–∞, –º–∏–Ω 50 RUB), FIFO (—Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–º–æ –±–∞–ª–ª—ã –ø–æ—Ç–æ–º –æ–±—ã—á–Ω—ã–µ), —Å–æ–∑–¥–∞—ë—Ç BallTransaction(REDEEM) —Å balanceBefore/After. `cancel()`: –æ—Ç–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. |
| **6.14** | `modules/guests/services/ball-transaction.service.ts` —á.3 | `manualAdd()` (MANAGER+, reason –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, audit), `manualSubtract()` (MANAGER+, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å), `getHistory()` (—Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Ç–∏–ø—É, –¥–∞—Ç–µ, —Å—É–º–º–µ, —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É), `getBalanceDetails()` (regular + promo + expires_at) |
| **6.15** | `modules/guests/services/ball-transfer.service.ts` | `initiateTransfer()`: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç—ã (min/max, daily), –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SMS OTP, —Å–æ–∑–¥–∞—ë—Ç BallTransfer(PENDING) –≤ Redis TTL=10min. `confirmTransfer()`: –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç OTP, Prisma transaction: withdraw sender ‚Üí deposit receiver, ActivityLog –æ–±–∞ –∫–æ–Ω—Ü–∞. `cancel()`. |
| **6.16** | `modules/guests/services/guest-visit.service.ts` | `createVisit()`, `getVisits()` (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏), `getStats()` (favorite day/time/restaurant), `cancelVisit()` |
| **6.17** | `modules/guests/services/registration-link.service.ts` | `createLink()` (slug + token + URL), `getLinkByToken()`, `getLinks()`, `getLinkStats()` (uses, conversion rate), `deactivate()`, `activate()` |
| **6.18** | `modules/guests/controllers/guest.controller.ts` | –í—Å–µ endpoints: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (4 —Å–ø–æ—Å–æ–±–∞), –ø–æ–∏—Å–∫ (QR/6-digit/phone/ID), —Å–ø–∏—Å–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏, –ø—Ä–æ—Ñ–∏–ª—å, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —Å–º–µ–Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –¥–µ—Ç–∏, merge, export, delete |
|  | `modules/guests/controllers/guest-card.controller.ts` | block, unblock, regenerate, GDPR delete |
|  | `modules/guests/controllers/ball-transaction.controller.ts` | earn, redeem, manual-add, manual-subtract, cancel, history |
|  | `modules/guests/controllers/ball-transfer.controller.ts` | initiate, confirm, cancel, history |
|  | `modules/guests/controllers/guest-visit.controller.ts` | history, stats |
|  | `modules/guests/controllers/registration-link.controller.ts` | CRUD —Å—Å—ã–ª–æ–∫ |
| **6.19** | `modules/guests/guests.module.ts` | –í—Å–µ providers, imports (LoyaltyModule, NotificationModule, ActivityLogModule) |
| **6.20** | `modules/guests/services/guest.service.spec.ts` | Unit —Ç–µ—Å—Ç—ã: `createGuest` (success, duplicate phone, limit exceeded), `createGuestByLink` (valid link, expired, maxUses), `updateProfile` (too soon), `requestPhoneChange`, `confirmPhoneChange` (wrong OTP). –ü–æ–ª–Ω—ã–µ –º–æ–∫–∏. |
|  | `test/guests.e2e-spec.ts` | E2E: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí –ø–æ–∏—Å–∫ –ø–æ QR ‚Üí –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ ‚Üí —Å–ø–∏—Å–∞–Ω–∏–µ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ ‚Üí –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 7 ‚Äî LOYALTY BUILDER (14 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **7.1** | `modules/loyalty/builder/dto/loyalty-system.dto.ts` | `CreateLoyaltySystemDto`, `UpdateLoyaltySystemDto` (–≤—Å–µ –ø–æ–ª—è: ballToRubleRatio, defaultEarnPercentage, minCheckAmount, minBallsToRedeem, maxRedeemPercentage, inactivityExpireDays, notifyBeforeExpireDays, conflictResolutionStrategy, allowTransfers, transfer limits) |
| **7.2** | `modules/loyalty/builder/dto/levels.dto.ts` | `CreateLevelDto`, `UpdateLevelDto`, `ReorderLevelsDto`, `DeleteLevelDto` (—Å `moveToLevelId` –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –≥–æ—Å—Ç–µ–π) |
|  | `modules/loyalty/builder/dto/rules.dto.ts` | `CreateRuleDto`, `UpdateRuleDto`, `RuleConditionsDto` (minCheckAmount, daysOfWeek, timeRange, guestLevel, restaurantId, productCategories), `RuleRewardDto` (earnPercent, bonusPoints, bonusPercent) |
| **7.3** | `modules/loyalty/builder/dto/promos.dto.ts` | `CreatePromoDto`, `UpdatePromoDto`, `PromoConditionsDto` (triggerType + —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞: birthday N days window, inactivity N days, firstCheck limit, weekday days, timeRange from/to, checkAmount min), `PromoRewardDto` (bonusPoints, bonusPercent, expiresInDays) |
| **7.4** | `modules/loyalty/builder/services/loyalty-system.service.ts` | `create()`, `findByTenant()`, `getConfig()`, `updateConfig()`, `setCardMode()` (UNIFIED‚ÜîSEPARATE ‚Äî —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π –∫–∞—Ä—Ç!), `getCardModeStats()` |
| **7.5** | `modules/loyalty/builder/services/levels.service.ts` —á.1 | `create()` (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å rank, threshold), `findAll()` (—Å –∫–æ–ª-–≤–æ–º –≥–æ—Å—Ç–µ–π –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ), `update()` —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º (—Å–æ–∑–¥–∞—ë—Ç LoyaltyLevelVersion), `reorder()` |
| **7.6** | `modules/loyalty/builder/services/levels.service.ts` —á.2 | `delete()` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –µ—Å—Ç—å –ª–∏ –≥–æ—Å—Ç–∏, –µ—Å–ª–∏ –µ—Å—Ç—å ‚Äî —Ç—Ä–µ–±—É–µ—Ç `moveToLevelId`, –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, `recalculateAllGuestLevels()` (batch job), `checkLevelUpgrade(guestCard)`, `getNextLevel()` |
| **7.7** | `modules/loyalty/builder/services/rules.service.ts` —á.1 | `create()` (—Å–æ–∑–¥–∞—ë—Ç Rule + –ø–µ—Ä–≤—É—é RuleVersion), `findAll()` (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏: active/inactive/archived, paginated), `findOne()`, `getVersionHistory()` |
| **7.8** | `modules/loyalty/builder/services/rules.service.ts` —á.2 | `update()` ‚Äî —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é RuleVersion, —Å—Ç–∞—Ä—É—é –∑–∞–∫—Ä—ã–≤–∞–µ—Ç (activeTo=now), –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å. `activate()`, `deactivate()`, `archive()`, invalidates Redis cache `loyalty:rules:active:tenantId` |
| **7.9** | `modules/loyalty/builder/services/promos.service.ts` —á.1 | `create()`, `findAll()`, `findOne()`, `update()` —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º, `activate()`, `deactivate()` |
| **7.10** | `modules/loyalty/builder/services/promos.service.ts` —á.2 | `getEligiblePromos(guestCard, restaurantId, checkAmount?)` ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ —Ç—Ä–∏–≥–µ—Ä—É, —É—Å–ª–æ–≤–∏—è–º, maxUses, period. `setConflictStrategy()`. `resolveConflicts(promos[], strategy)` ‚Äî COMBINE_ALL (—Å—É–º–º–∏—Ä—É–µ—Ç), MAX_ONLY (–ª—É—á—à–µ–µ), FIRST_ONLY (–ø–µ—Ä–≤–æ–µ –ø–æ priority). |
| **7.11** | `modules/loyalty/builder/controllers/loyalty-system.controller.ts` | GET/PUT `/loyalty/system` ‚Äî —Ç–æ–ª—å–∫–æ RESTAURANTADMIN+ |
|  | `modules/loyalty/builder/controllers/levels.controller.ts` | CRUD `/loyalty/levels` + POST `/loyalty/levels/recalculate` |
|  | `modules/loyalty/builder/controllers/rules.controller.ts` | CRUD `/loyalty/rules` + GET `/loyalty/rules/:id/versions` |
|  | `modules/loyalty/builder/controllers/promos.controller.ts` | CRUD `/loyalty/promos` + GET `/loyalty/promos/eligible?guestCardId=` |
| **7.12** | `modules/loyalty/builder/loyalty-builder.module.ts` | Module |
| **7.13** | `modules/loyalty/builder/services/rules.service.spec.ts` | Unit —Ç–µ—Å—Ç—ã: create rule ‚Üí version created, update rule ‚Üí new version, old version closed, conflict: COMBINE_ALL, MAX_ONLY, FIRST_ONLY |
| **7.14** | `modules/loyalty/builder/services/promos.service.spec.ts` | Unit —Ç–µ—Å—Ç—ã: BIRTHDAY promo eligibility (–¥–Ω–∏ –¥–æ/–ø–æ—Å–ª–µ), INACTIVITY N days, FIRSTCHECK maxUses, conflict resolution –≤—Å–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 8 ‚Äî LOYALTY ENGINE (16 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **8.1** | `modules/loyalty/engine/dto/engine.dto.ts` | `CalculateDto`, `ProcessTransactionDto` (earn+redeem –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ), `ManualAdjustDto`, `TransferDto`, `EarnOnlyDto`, `RedeemOnlyDto` ‚Äî –≤—Å–µ —Å Idempotency-Key |
| **8.2** | `modules/loyalty/engine/services/calculator.service.ts` —á.1 | `calculateEarning(checkAmount, guestCard, restaurantId, items?)`: –Ω–∞—Ö–æ–¥–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞, –ø—Ä–∏–º–µ–Ω—è–µ—Ç —É—Å–ª–æ–≤–∏—è (minCheck, weekday, timeRange, guestLevel, category), –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ —Å—á–∏—Ç–∞–µ—Ç earnPoints |
| **8.3** | `modules/loyalty/engine/services/calculator.service.ts` —á.2 | `resolveRuleConflicts(rules[], strategy)`: COMBINE_ALL —Å—É–º–º–∏—Ä—É–µ—Ç, MAX_ONLY –±–µ—Ä—ë—Ç –ª—É—á—à–µ–µ, `applyLevelBonus(earnPoints, guestLevel)`, `calculatePromoBonus(eligiblePromos[], baseEarn)`, `resolvePromoConflicts(promos[], strategy)` |
| **8.4** | `modules/loyalty/engine/services/calculator.service.ts` —á.3 | `calculateRedemption(requestedRedeem, guestCard, checkAmount)`: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç minCheckAmount (50 RUB), maxRedeemPercent (20% –æ—Ç —á–µ–∫–∞), splitFIFO (—Å–Ω–∞—á–∞–ª–∞ promoBalance, –ø–æ—Ç–æ–º regularBalance), `buildCalculationResult()` ‚Äî –ø–æ–ª–Ω—ã–π response |
| **8.5** | `modules/loyalty/engine/services/transaction.service.ts` —á.1 | `processTransaction(dto)`: –≤—Å—è –ª–æ–≥–∏–∫–∞ –≤ Prisma `$transaction([...], {isolationLevel: Serializable, maxWait: 5000, timeout: 10000})`. –®–∞–≥ 1: SELECT FOR UPDATE (pessimistic lock) –≥–æ—Å—Ç–µ–≤–æ–π –∫–∞—Ä—Ç—ã |
| **8.6** | `modules/loyalty/engine/services/transaction.service.ts` —á.2 | –®–∞–≥ 2: idempotency check —á–µ—Ä–µ–∑ `posCheckId` unique constraint. –®–∞–≥ 3: —Å–æ–∑–¥–∞—ë—Ç POSTransaction. –®–∞–≥ 4: –µ—Å–ª–∏ redeem > 0 ‚Üí FIFO —Å–ø–∏—Å–∞–Ω–∏–µ promo‚Üíregular, —Å–æ–∑–¥–∞—ë—Ç BallTransaction(REDEEM) —Å balanceBefore/After –∏ rulesSnapshot |
| **8.7** | `modules/loyalty/engine/services/transaction.service.ts` —á.3 | –®–∞–≥ 5: –µ—Å–ª–∏ earn > 0 ‚Üí —Å–æ–∑–¥–∞—ë—Ç BallTransaction(EARN). –®–∞–≥ 6: –µ—Å–ª–∏ –ø—Ä–æ–º–æ ‚Üí —Å–æ–∑–¥–∞—ë—Ç PromoBallGranted —Å expiresAt. –®–∞–≥ 7: update GuestCard (balances, lifetimeSpent, lastActivityAt). –®–∞–≥ 8: regenerateQR + regenerate6DigitCode. –®–∞–≥ 9: createGuestVisit. –®–∞–≥ 10: checkLevelUpgrade. Retry –Ω–∞ deadlock (3 –ø–æ–ø—ã—Ç–∫–∏, exp backoff 100/200/400ms). |
| **8.8** | `modules/loyalty/engine/services/transaction.service.ts` —á.4 | `manualAdjust(dto)`: MANAGER+, reason –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å –ø—Ä–∏ subtract, Prisma transaction, ActivityLog (oldValue/newValue), —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≥–æ—Å—Ç—é. `getTransactionHistory()`. `rollbackTransaction()` (—Ç–æ–ª—å–∫–æ –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ). |
| **8.9** | `modules/loyalty/engine/services/expiry.service.ts` | `getBallsExpiringSoon(tenantId, days)`: –Ω–∞—Ö–æ–¥–∏—Ç –∫–∞—Ä—Ç—ã –≥–¥–µ `lastActivityAt < now - inactivityExpireDays + notifyDays`. `expireBalls(guestCardId)`: FIFO ‚Äî —Å–Ω–∞—á–∞–ª–∞ ist–µ–∫–∞—é—Ç promo –±–∞–ª–ª—ã, –ø–æ—Ç–æ–º –æ–±—ã—á–Ω—ã–µ (–µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ N –¥–Ω–µ–π). –°–æ–∑–¥–∞—ë—Ç BallTransaction(EXPIRE). –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. ActivityLog. |
| **8.10** | `modules/loyalty/engine/services/levels-upgrade.service.ts` | `checkAndUpgrade(guestCard)`: –µ—Å–ª–∏ `lifetimeSpent >= nextLevel.threshold` ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç `loyaltyLevelId`, —Å–æ–∑–¥–∞—ë—Ç ActivityLog(LEVEL_UPGRADED), —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≥–æ—Å—Ç—é. ONE-WAY-UP: downgrade —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é Admin. `batchRecalculateAllGuests(tenantId)`: —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ –ø–æ 100 –≥–æ—Å—Ç–µ–π. |
| **8.11** | `modules/loyalty/engine/jobs/expire-balls.job.ts` | BullMQ Processor: CRON `0 3 * * *`. Batch –ø–æ 100 —Ç–µ–Ω–∞–Ω—Ç–∞–º ‚Üí –ø–æ 1000 –∫–∞—Ä—Ç. |
|  | `modules/loyalty/engine/jobs/notify-expiry.job.ts` | CRON `0 9 * * *`: –∑–∞ 7 –¥–Ω–µ–π –¥–æ —Å–≥–æ—Ä–∞–Ω–∏—è ‚Äî Telegram/Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ |
|  | `modules/loyalty/engine/jobs/upgrade-levels.job.ts` | CRON `0 2 * * *`: –ø–µ—Ä–µ—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π –≤—Å–µ—Ö –≥–æ—Å—Ç–µ–π |
|  | `modules/loyalty/engine/jobs/reconcile-balances.job.ts` | CRON `0 4 * * 1` (–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ): –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É–º–º–∞—Ä–Ω—ã–π BallTransaction == GuestCard.balance |
| **8.12** | `modules/loyalty/engine/loyalty-engine.controller.ts` | POST `/loyalty/calculate` (read-only, –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è), POST `/loyalty/transactions` (—Å Idempotency-Key), POST `/loyalty/manual-adjust`, POST `/loyalty/transfer/initiate`, POST `/loyalty/transfer/confirm` |
|  | `modules/loyalty/engine/loyalty-engine.module.ts` | Module + BullMQ queues |
| **8.13** | `modules/loyalty/engine/services/calculator.service.spec.ts` | –ü–æ–ª–Ω—ã–µ unit —Ç–µ—Å—Ç—ã (–∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤): calculateEarning (–±–∞–∑–æ–≤—ã–π 10%, —Å–æ —Å–∫–∏–¥–∫–æ–π –ø–æ—Å–ª–µ —Å–ø–∏—Å–∞–Ω–∏—è, Silver bonus 5%, COMBINE_ALL, MAX_ONLY), calculateRedemption (20% –ª–∏–º–∏—Ç, –±–∞–ª–∞–Ω—Å –º–µ–Ω—å—à–µ –ª–∏–º–∏—Ç–∞, minCheck 50 RUB), applyPromo (BIRTHDAY b–æ–Ω—É—Å, —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏) |
| **8.14** | `modules/loyalty/engine/services/transaction.service.spec.ts` | Unit —Ç–µ—Å—Ç—ã: processTransaction (earn+redeem, idempotency ‚Äî –≤—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, deadlock retry) |
| **8.15** | `test/loyalty-engine.e2e-spec.ts` | E2E (–∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤): calculate endpoint, transaction endpoint, idempotency, 401 –±–µ–∑ —Ç–æ–∫–µ–Ω–∞, 400 minCheck, balance update –≤ –ë–î |
| **8.16** | `test/load/loyalty-calculate.k6.js` | k6 load test (–∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤): stages 100‚Üí200 VU, 500 RPS, thresholds p95<500ms, errors<1% |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 9 ‚Äî POS INTEGRATION (16 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **9.1** | `modules/pos/dto/pos.dto.ts` | `CreatePOSIntegrationDto`, `UpdatePOSIntegrationDto` (config —à–∏—Ñ—Ä—É–µ—Ç—Å—è), `IikoWebhookDto`, `RKeeperWebhookDto` (XML parsed), `ManualSyncDto`, `POSCalculateDto`, `POSFinalizeDto` |
| **9.2** | `modules/pos/services/pos-config.service.ts` | `create()`: —à–∏—Ñ—Ä—É–µ—Ç API –∫–ª—é—á (AES-256-GCM), —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç. `getDecryptedConfig()`: —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –Ω–∞ –ª–µ—Ç—É. `testConnection()`: —Ä–µ–∞–ª—å–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å –∫ POS API. `update()`, `delete()`, `getAll()` |
| **9.3** | `modules/pos/security/hmac.service.ts` | `generateSignature(payload, secret)`: HMAC-SHA256. `verifySignature(payload, signature, secret)`: constant-time comparison. `generateWebhookSecret()`: crypto random. |
|  | `modules/pos/security/ip-whitelist.service.ts` | `checkIP(ip, tenantId)`: —Å–≤–µ—Ä—è–µ—Ç —Å —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–º–∏ IP –∏–∑ config. `addAllowedIP()`, `removeIP()`. |
|  | `modules/pos/security/api-key.service.ts` | `generatePOSApiKey()`, `hashApiKey()`, `validateApiKey(raw, hash)` |
| **9.4** | `modules/pos/iiko/iiko-webhook.service.ts` —á.1 | `handleWebhook(dto, signature, ip)`: 1) Verify HMAC. 2) Check IP whitelist. 3) Parse iiko event format (JSON). 4) –ù–∞–π—Ç–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω –ø–æ restaurantId. 5) Idempotency check –ø–æ `posCheckId`. 6) –ù–∞–π—Ç–∏ –≥–æ—Å—Ç—è –ø–æ phone –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ. |
| **9.5** | `modules/pos/iiko/iiko-webhook.service.ts` —á.2 | 7) –í—ã–∑–æ–≤ `loyaltyEngine.processTransaction()`. 8) –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å POSSync(SUCCESS/FAILED). 9) –û—Ç–≤–µ—Ç–∏—Ç—å iiko –≤ –∏—Ö —Ñ–æ—Ä–º–∞—Ç–µ. 10) –ï—Å–ª–∏ –≥–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —Å–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç—è –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å (config). –û–±—Ä–∞–±–æ—Ç–∫–∞ `REFUND` —Å–æ–±—ã—Ç–∏—è ‚Äî rollback —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. |
| **9.6** | `modules/pos/iiko/iiko-pull.service.ts` | `pullTransactions(integration)`: GET `iiko-api/v2/checks?since={lastPullAt}`. –ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ —á–µ–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `loyaltyEngine.processTransaction()`. `updateLastPullAt()`. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏—é iiko API. |
| **9.7** | `modules/pos/rkeeper/rkeeper-webhook.service.ts` —á.1 | `handleWebhook(rawXml, signature)`: 1) Parse XML ‚Üí JS object (xml2js). 2) Verify HMAC. 3) Extract: restaurantId, guestPhone, checkAmount, items, timestamp. |
| **9.8** | `modules/pos/rkeeper/rkeeper-webhook.service.ts` —á.2 | 4) –ù–∞–π—Ç–∏ –≥–æ—Å—Ç—è. 5) Idempotency. 6) `loyaltyEngine.processTransaction()`. 7) –û—Ç–≤–µ—Ç–∏—Ç—å XML –≤ —Ñ–æ—Ä–º–∞—Ç–µ R-Keeper. |
| **9.9** | `modules/pos/rkeeper/rkeeper-pull.service.ts` | `pullTransactions()`: XML API R-Keeper: `<GetChecks fromDate="..." toDate="...">`. –ü–∞—Ä—Å–∏—Ç XML. Reconciliation. |
|  | `modules/pos/rkeeper/rkeeper-xml-api.service.ts` | `buildXmlRequest()`, `parseXmlResponse()`, `getGuestBalance()` ‚Äî –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞ |
| **9.10** | `modules/pos/services/pos-sync.service.ts` | `logSync(integrationId, status, details)`: —Å–æ–∑–¥–∞—ë—Ç POSSync –∑–∞–ø–∏—Å—å. `getRecentSyncs()`. `markFailed(integrationId, error)`. `getStats(tenantId)`: SUCCESS rate, FAILED rate, last sync time. |
|  | `modules/pos/services/pos-reconciliation.service.ts` | –ü–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤: PULL –≤—Å–µ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —á–µ–∫–∏ ‚Üí —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ë–î ‚Üí –µ—Å–ª–∏ –Ω–µ—Ç –≤ –ë–î ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å—ã –≥–æ—Å—Ç–µ–π (allowable diff < 10 –±–∞–ª–ª–æ–≤). –°–æ–∑–¥–∞—ë—Ç `BallReconciliation` –∑–∞–ø–∏—Å–∏ –¥–ª—è Admin review. |
| **9.11** | `modules/pos/jobs/pos-pull.job.ts` | BullMQ: –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω –¥–ª—è –∫–∞–∂–¥–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ |
|  | `modules/pos/jobs/pos-reconciliation.job.ts` | CRON `0 4 * * *`: –ø–æ–ª–Ω—ã–π reconciliation |
|  | `modules/pos/jobs/pos-retry-failed.job.ts` | Retry FAILED webhooks: 3 –ø–æ–ø—ã—Ç–∫–∏, exp backoff |
| **9.12** | `modules/pos/pos-plugin.controller.ts` | –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤ (–Ω–µ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞): POST `/pos/plugin/calculate`, POST `/pos/plugin/reserve`, POST `/pos/plugin/finalize`, POST `/pos/plugin/search-guest`, POST `/pos/plugin/register-guest`. Auth –ø–æ API –∫–ª—é—á—É (–Ω–µ JWT). |
|  | `modules/pos/pos-webhook.controller.ts` | POST `/pos/webhooks/iiko`, POST `/pos/webhooks/rkeeper` ‚Äî –ø—É–±–ª–∏—á–Ω—ã–µ (–Ω–µ JWT, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è HMAC) |
|  | `modules/pos/pos-admin.controller.ts` | Admin: GET/POST/PUT/DELETE integrations, GET sync logs, POST manual-sync, GET reconciliation report |
| **9.13** | `modules/pos/pos.module.ts` | Module, BullMQ queues |
| **9.14** | `modules/pos/iiko/iiko-webhook.service.spec.ts` | Unit —Ç–µ—Å—Ç—ã: valid webhook, invalid HMAC ‚Üí 401, duplicate check (idempotency), guest not found ‚Üí create, refund event |
| **9.15** | `modules/pos/services/pos-reconciliation.service.spec.ts` | Unit —Ç–µ—Å—Ç—ã: reconcile –Ω–∞–π–¥–µ–Ω—ã –≤—Å–µ, reconcile –ø—Ä–æ–ø—É—â–µ–Ω webhook ‚Üí –æ–±—Ä–∞–±–æ—Ç–∞–Ω, balance mismatch ‚Üí alert |
| **9.16** | `test/pos.e2e-spec.ts` | E2E: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å iiko webhook ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å BallTransaction —Å–æ–∑–¥–∞–Ω ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –≥–æ—Å—Ç—è –æ–±–Ω–æ–≤–ª—ë–Ω |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 10 ‚Äî BILLING (14 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **10.1** | `modules/billing/dto/billing.dto.ts` | `CreateSubscriptionDto`, `ChangePlanDto` (plan + period + reason), `ProcessPaymentDto`, `RefundDto`, `CreateInvoiceDto`, `UpdateBillingInfoDto`, `WebhookDto` (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞) |
| **10.2** | `modules/billing/providers/abstract.payment-provider.ts` | `IPaymentProvider` interface: `createPayment()`, `getPayment()`, `refund()`, `handleWebhook()`, `createCustomer()`. `PaymentProviderFactory`. |
| **10.3** | `modules/billing/providers/yookassa.provider.ts` | –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è YooKassa API: `createPayment()` (—Å metadata, return_url), `getPayment()`, `refund()` (partial/full), `handleWebhook()` (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç IP whitelist YooKassa + signature), `mapStatus()` |
| **10.4** | `modules/billing/providers/stripe.provider.ts` | Stripe: `createPaymentIntent()`, `confirmPayment()`, `refund()`, `handleWebhook()` (Stripe signature verification), `createCustomer()` |
| **10.5** | `modules/billing/providers/cloudpayments.provider.ts` | CloudPayments: `charge()`, `refund()`, `handleWebhook()`, HMAC verification |
| **10.6** | `modules/billing/services/subscriptions.service.ts` —á.1 | `create()`: —Å–æ–∑–¥–∞—ë—Ç Subscription(TRIAL, 14 –¥–Ω–µ–π) –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. `getActive()`. `changePlan()`: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç downgrade/upgrade, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç st–æ–∏–º–æ—Å—Ç—å, —Å–æ–∑–¥–∞—ë—Ç SubscriptionHistory. `upgrade()` ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ. `downgrade()` ‚Äî —Å –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞. |
| **10.7** | `modules/billing/services/subscriptions.service.ts` —á.2 | `cancel()` (—Å –ø—Ä–∏—á–∏–Ω–æ–π), `reactivate()`, `applyLimitedMode()` ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –ø—Ä–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ (read-only), `checkExpiry()`, `getRenewalPrice()`, `applyPromoCode()` |
| **10.8** | `modules/billing/services/billing.service.ts` —á.1 | `processPayment(tenantId, amount, provider)`: —Å–æ–∑–¥–∞—ë—Ç Payment(PENDING), –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä, –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å. `createInvoice()`. `markInvoicePaid()`. |
| **10.9** | `modules/billing/services/billing.service.ts` —á.2 | `refund(paymentId, amount?, reason)`, `handleChargeback()`, `getInvoiceHistory()` (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏), `downloadInvoicePDF()` (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PDF —á–µ—Ä–µ–∑ pdfkit), `sendInvoiceEmail()` |
| **10.10** | `modules/billing/jobs/retry-payment.job.ts` | BullMQ: retry –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (day 0, 1, 3, 7). –ü–æ—Å–ª–µ 4 –Ω–µ—É–¥–∞—á ‚Üí NONPAYMENT ‚Üí `applyLimitedMode()` |
|  | `modules/billing/jobs/check-expiry.job.ts` | CRON –µ–∂–µ–¥–Ω–µ–≤–Ω–æ: –Ω–∞—Ö–æ–¥–∏—Ç –∏—Å—Ç–µ–∫–∞—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (7 –¥–Ω–µ–π, 3 –¥–Ω—è, 1 –¥–µ–Ω—å) |
|  | `modules/billing/jobs/send-invoice.job.ts` | –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–≤–æ–π—Å–∞ ‚Äî email —Å PDF |
| **10.11** | `modules/billing/billing.controller.ts` | OWNER: –≤—Å–µ tenants billing. ADMIN (own tenant): GET subscription, GET invoices, POST change-plan, PUT billing-info |
|  | `modules/billing/billing-webhook.controller.ts` | POST `/billing/webhooks/yookassa`, POST `/billing/webhooks/stripe`, POST `/billing/webhooks/cloudpayments` ‚Äî –ø—É–±–ª–∏—á–Ω—ã–µ |
|  | `modules/billing/billing.module.ts` | Module |
| **10.12** | `modules/billing/services/billing.service.spec.ts` | Unit —Ç–µ—Å—Ç—ã: processPayment success, processPayment failed ‚Üí Payment(FAILED), refund, invoice creation |
| **10.13** | `modules/billing/services/subscriptions.service.spec.ts` | Unit —Ç–µ—Å—Ç—ã: TRIAL ‚Üí STANDARD upgrade, changePlan downgrade (end of period), cancel, limited mode activation |
| **10.14** | `test/billing.e2e-spec.ts` | E2E: YooKassa webhook payment.succeeded ‚Üí Subscription –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞, Plan changed |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 11 ‚Äî TELEGRAM BOT + MINI APP API (12 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **11.1** | `modules/telegram/dto/telegram.dto.ts` | `SetupBotDto`, `TelegramAuthDto`, `MiniAppAuthDto` (initData), `SendMessageDto`, `TelegramWebhookDto` |
| **11.2** | `modules/telegram/services/bot-setup.service.ts` | `validateToken()` (getMe Telegram API), `setupWebhook(botToken, webhookUrl)`, `setCommands()`, `getWebhookInfo()`, `deleteWebhook()`, `setMenuButton()` (Web App button) |
| **11.3** | `modules/telegram/services/telegram-auth.service.ts` | `validateInitData(initData, botToken)`: HMAC-SHA256 –ø—Ä–æ–≤–µ—Ä–∫–∞ Telegram initData (–∞–ª–≥–æ—Ä–∏—Ç–º —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏). `authenticateUser(telegramId)`: –∏—â–µ—Ç TelegramUser ‚Üí User ‚Üí JWT. `linkAccount(userId, telegramId)`. `unlinkAccount(userId)`. |
| **11.4** | `apps/telegram-bot/src/scenes/start.scene.ts` | `/start` handler: –µ—Å–ª–∏ –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ‚Üí –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. Deep link `?start=restaurantId` ‚Äî –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É. |
|  | `apps/telegram-bot/src/scenes/auth.scene.ts` | Phone number request, SMS verification (6 —Ü–∏—Ñ—Ä), link to existing account. WizardScene —Å —à–∞–≥–∞–º–∏. |
| **11.5** | `apps/telegram-bot/src/scenes/card.scene.ts` | `/card` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å, —É—Ä–æ–≤–µ–Ω—å, QR-–∫–æ–¥ –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, 6-digit –∫–æ–¥, –∫–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å Mini App" |
|  | `apps/telegram-bot/src/scenes/history.scene.ts` | `/history` ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, inline pagination |
|  | `apps/telegram-bot/src/scenes/promo.scene.ts` | `/promo` ‚Äî –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–æ –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Å—Ç—è |
| **11.6** | `apps/telegram-bot/src/scenes/profile.scene.ts` | `/profile` ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–∏–º—è, –î–†) |
|  | `apps/telegram-bot/src/scenes/children.scene.ts` | –î–æ–±–∞–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –¥–µ—Ç–µ–π, –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ |
|  | `apps/telegram-bot/src/scenes/support.scene.ts` | `/support` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã, —Å–æ–∑–¥–∞—ë—Ç SupportTicket |
| **11.7** | `apps/telegram-bot/src/services/bot.service.ts` —á.1 | Setup telegraf instance, webhook handler, all scene registration, middleware (rate limit per telegramId: 10 req/min), error handler |
| **11.8** | `apps/telegram-bot/src/services/bot.service.ts` —á.2 | Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: `sendToUser(telegramId, message, options)`, —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ (BALLS_EARNED, LEVEL_UPGRADED, PROMO_AVAILABLE, BIRTHDAY, BALLS_EXPIRING), –æ–±—Ä–∞–±–æ—Ç–∫–∞ `my_chat_member` (blocked/unblocked ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç GuestProfile.tgBlocked) |
| **11.9** | `modules/telegram/services/mini-app.service.ts` | `getGuestCard(userId)`, `getHistory(userId, page)`, `getProfile(userId)`, `getChildren(userId)`, `updateProfile(userId, dto)`, `initiateTransfer(userId, dto)`, `confirmTransfer(userId, dto)`, `getPromos(userId)` |
| **11.10** | `modules/telegram/telegram.controller.ts` | POST `/telegram/webhook |

<span style="display:none">[^6_1][^6_2][^6_3][^6_4]</span>

<div align="center">‚ÅÇ</div>

[^6_1]: Beseda-9.md

[^6_2]: Beseda-8.md

[^6_3]: Beseda-2.md

[^6_4]: Beseda-1.md


---

# –ù–µ –∑–∞–∫–æ–Ω—á–∏–ª, –ø—Ä–æ–¥–æ–ª–∂–∏

–ü—Ä–æ–¥–æ–ª–∂–∞—é –ø–ª–∞–Ω —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å:

***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### (–ü–†–û–î–û–õ–ñ–ï–ù–ò–ï –§–ê–ó–´ 11 ‚Äî TELEGRAM BOT + MINI APP API)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **11.10** | `modules/telegram/telegram.controller.ts` | POST `/telegram/webhooks/:botToken` (–ø—É–±–ª–∏—á–Ω—ã–π, Telegram IP whitelist), POST `/telegram/setup` (Admin: –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ—Ç), GET `/telegram/status/:botId`, POST `/telegram/test-message`, DELETE `/telegram/webhook/:botId` |
|  | `modules/telegram/telegram-miniapp.controller.ts` | GET `/telegram/miniapp/card`, GET `/telegram/miniapp/history`, GET `/telegram/miniapp/profile`, PATCH `/telegram/miniapp/profile`, GET `/telegram/miniapp/promos`, POST `/telegram/miniapp/transfer/initiate`, POST `/telegram/miniapp/transfer/confirm` ‚Äî auth —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `initData` |
|  | `modules/telegram/telegram.module.ts` | TelegrafModule, —Å—Ü–µ–Ω—ã, BullMQ |
| **11.11** | `apps/telegram-miniapp/src/providers/TelegramProvider.tsx` | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç `WebApp.ready()`, `WebApp.expand()`, —á–∏—Ç–∞–µ—Ç `initData`, –ø–µ—Ä–µ–¥–∞—ë—Ç `user` —á–µ—Ä–µ–∑ context |
|  | `apps/telegram-miniapp/src/screens/CardScreen.tsx` | –ë–∞–ª–∞–Ω—Å (regular + promo), —É—Ä–æ–≤–µ–Ω—å —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º, QR-–∫–æ–¥ –∫–∞–∫ SVG, 6-digit –∫–æ–¥ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π —Å–º–µ–Ω—ã, –∫–Ω–æ–ø–∫–∏: –ò—Å—Ç–æ—Ä–∏—è, –ü—Ä–æ–º–æ, –ü—Ä–æ—Ñ–∏–ª—å |
|  | `apps/telegram-miniapp/src/screens/HistoryScreen.tsx` | –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –∫–∞–∂–¥–∞—è —Å –∏–∫–æ–Ω–∫–æ–π —Ç–∏–ø–∞, —Å—É–º–º–æ–π (+/-), –¥–∞—Ç–æ–π, —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–º. –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞. |
| **11.12** | `apps/telegram-miniapp/src/screens/ProfileScreen.tsx` | –ò–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ), –î–†, –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞ |
|  | `apps/telegram-miniapp/src/screens/ChildrenScreen.tsx` | –°–ø–∏—Å–æ–∫ –¥–µ—Ç–µ–π (max 3), —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–∏–º—è + –î–†), —É–¥–∞–ª–∏—Ç—å |
|  | `apps/telegram-miniapp/src/screens/TransferScreen.tsx` | –í–≤–æ–¥ 6-digit –∫–æ–¥–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è, —Å—É–º–º–∞, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ SMS, —É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞ |
|  | `apps/telegram-miniapp/src/screens/PromosScreen.tsx` | –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–æ: —Ç–∏–ø (Birthday, First Check, –∏ —Ç.–¥.), –±–æ–Ω—É—Å, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 12 ‚Äî ANALYTICS MODULE (14 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **12.1** | `modules/analytics/dto/analytics.dto.ts` | `OwnerPlatformMetricsQueryDto`, `RestaurantAnalyticsQueryDto` (period + restaurantId + filters), `ManagerAnalyticsQueryDto`, `GuestPersonalStatsQueryDto`, `ExportReportDto` (reportType, format, period, filters, columns), `DateRangeDto` |
| **12.2** | `modules/analytics/services/platform-metrics.service.ts` | `getPlatformMetrics(period)`: tenants (total/active/pastDue/new), revenue (MRR, ARR, totalRevenue, byPlan, byPeriod), churn (rate, cancelledThisMonth, reasons), payments (transactions, amounts), guests (totalAcrossAllTenants), loyalty (balls issued/redeemed/expired, redemptionRate) ‚Äî –∫–µ—à Redis 5 –º–∏–Ω |
| **12.3** | `modules/analytics/services/restaurant-analytics.service.ts` —á.1 | `getRestaurantStats(tenantId, restaurantId, period)`: overview (totalRevenue, totalChecks, averageCheck, totalGuests, activeGuests, newGuests, returningGuests, retentionRate), loyalty (ballsIssued, ballsRedeemed, ballsExpired, redemptionRate, avgBallsPerGuest, discountGivenViaPoints, roiLoyalty) |
| **12.4** | `modules/analytics/services/restaurant-analytics.service.ts` —á.2 | levels distribution (count + percent + avgCheck per level), promos performance (active count, activations, bonusIssued, conversionRate, topPromos —Å ROI), guestSegments (VIP/Regular/AtRisk/Lost —Å avgCheck –∏ daysInactive) |
| **12.5** | `modules/analytics/services/restaurant-analytics.service.ts` —á.3 | trends: revenueByDay (30 –¥–Ω–µ–π), guestsByWeek (4 –Ω–µ–¥–µ–ª–∏), posIntegration status, `getDrilldown(level/promo, period)` ‚Üí —Å–ø–∏—Å–æ–∫ –≥–æ—Å—Ç–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –¥–ª—è modal |
| **12.6** | `modules/analytics/services/manager-analytics.service.ts` | `getMyRestaurantStats(userId, period)`: —Ç–æ –∂–µ —á—Ç–æ restAdmin –Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –°–∫—Ä—ã–≤–∞–µ—Ç: billing, POS settings, cross-restaurant comparison |
| **12.7** | `modules/analytics/services/guest-analytics.service.ts` | `getPersonalStats(guestCardId, period)`: overview, visitPatterns (favoriteDay, favoriteTime, mostVisitedRestaurant), topDishes, recentVisits (last 10), promosUsed, achievements (Phase 2 –∑–∞–≥–ª—É—à–∫–∞), progressToNextLevel (lifetimeSpent / nextLevel.threshold %) |
| **12.8** | `modules/analytics/services/snapshots.service.ts` | `saveDailySnapshot(tenantId, restaurantId, date)`: –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `AnalyticsDailySnapshot`. `saveMonthlySnapshot()`. `getSnapshot(tenantId, restaurantId, date)` ‚Äî —Å–Ω–∞—á–∞–ª–∞ —á–∏—Ç–∞–µ—Ç snapshot, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å—á–∏—Ç–∞–µ—Ç live. |
| **12.9** | `modules/analytics/jobs/snapshots.job.ts` | CRON `0 1 * * *`: `saveDailySnapshot()` –¥–ª—è –≤—Å–µ—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ BullMQ (batch). CRON `0 2 1 * *`: monthly snapshot. |
|  | `modules/analytics/jobs/export.job.ts` | BullMQ processor: `RESTAURANT_PERFORMANCE`‚ÜíXLSX, `GUEST_LIST`‚ÜíXLSX/CSV, `TRANSACTIONS`‚ÜíCSV, `PROMO_ROI`‚ÜíXLSX. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤ S3, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email —Å —Å—Å—ã–ª–∫–æ–π (TTL 24—á). |
| **12.10** | `modules/analytics/services/export.service.ts` | `createExportJob(dto)`: —Å–æ–∑–¥–∞—ë—Ç BullMQ job, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `exportId`. `getExportStatus(exportId)`: Redis polling. `generateXLSX(data, columns)`: ExcelJS ‚Äî headers, row styles, autofit columns. `generateCSV(data)`: papaparse. `generatePDF(data)`: pdfkit —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º, —Ç–∞–±–ª–∏—Ü–µ–π, –∏—Ç–æ–≥–∞–º–∏. |
| **12.11** | `modules/analytics/analytics.controller.ts` | GET `/analytics/platform` (OWNER only), GET `/analytics/restaurant` (ADMIN/MANAGER), GET `/analytics/my-restaurant` (MANAGER), GET `/analytics/guest/me` (GUEST –≤ Telegram), POST `/analytics/export`, GET `/analytics/export/:exportId`, GET `/analytics/restaurant/drilldown` |
|  | `modules/analytics/analytics.module.ts` | Module + BullMQ queue |
| **12.12** | `modules/analytics/services/restaurant-analytics.service.spec.ts` | Unit —Ç–µ—Å—Ç—ã: getRestaurantStats (–ø—É—Å—Ç–æ–π –ø–µ—Ä–∏–æ–¥, –ø–µ—Ä–∏–æ–¥ —Å –¥–∞–Ω–Ω—ã–º–∏, retention rate calculation), getDrilldown (—Ñ–∏–ª—å—Ç—Ä –ø–æ —É—Ä–æ–≤–Ω—é) |
| **12.13** | `modules/analytics/services/export.service.spec.ts` | Unit —Ç–µ—Å—Ç—ã: generateXLSX (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞, –∫–æ–ª-–≤–æ —Å—Ç—Ä–æ–∫), generateCSV (encoding, delimiter), job status lifecycle |
| **12.14** | `test/analytics.e2e-spec.ts` | E2E: —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí GET platform metrics ‚Üí GET restaurant stats ‚Üí POST export ‚Üí poll status ‚Üí GET download URL |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 13 ‚Äî NOTIFICATIONS MODULE (16 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **13.1** | `modules/notifications/dto/notification.dto.ts` | `SendNotificationDto` (recipientId, recipientType, type, channels, priority, data, scheduledFor), `UpdateNotificationSettingsDto`, `GetNotificationsQueryDto` (limit, offset, status, type), `BulkSendDto` |
| **13.2** | `modules/notifications/providers/email.provider.ts` | Resend (transactional) + SendGrid (marketing): `sendTransactional(to, subject, html)`, `sendMarketing(recipientList, templateId, vars)`, `sendBulk(emails[])`, fallback SES |
| **13.3** | `modules/notifications/providers/sms.provider.ts` | SMSC.ru: `sendSMS(phone, message)`, `checkBalance()`, `getDeliveryStatus(smscId)`. Fallback Twilio. Rate: 1 SMS/—Å–µ–∫ per tenant. |
| **13.4** | `modules/notifications/providers/telegram.provider.ts` | `sendMessage(telegramId, text, keyboard?)`, `sendPhoto(telegramId, photoUrl, caption?)`, `sendDocument(telegramId, fileUrl, filename)`, `checkBlocked(telegramId)` ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç `GuestProfile.tgBlocked` |
| **13.5** | `modules/notifications/templates/email/BallsEarned.tsx` | React Email –∫–æ–º–ø–æ–Ω–µ–Ω—Ç: –ª–æ–≥–æ—Ç–∏–ø —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, –∏–º—è –≥–æ—Å—Ç—è, —Å—É–º–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤ (–∫—Ä—É–ø–Ω–æ), —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å, –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è, inline CSS, responsive |
|  | `modules/notifications/templates/email/LevelUpgraded.tsx` | –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º —É—Ä–æ–≤–Ω–µ–º, –∏–∫–æ–Ω–∫–∞/—Ü–≤–µ—Ç —É—Ä–æ–≤–Ω—è, –Ω–æ–≤—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ (benefits), –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞—Ä—Ç—É¬ª |
|  | `modules/notifications/templates/email/BallsExpiring.tsx` | –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ –∏ –¥–∞—Ç–∞ —Å–≥–æ—Ä–∞–Ω–∏—è, –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ—Ç—Ä–∞—Ç–∏—Ç—å —Å–µ–π—á–∞—Å¬ª |
|  | `modules/notifications/templates/email/BirthdayPromo.tsx` | –ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –¥–∏–∑–∞–π–Ω, –∏–º—è –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–∞, –±–æ–Ω—É—Å, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è, QR-–∫–æ–¥ |
|  | `modules/notifications/templates/email/Welcome.tsx` | –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã, QR-–∫–æ–¥ –∫–∞—Ä—Ç—ã, 6-digit –∫–æ–¥ |
| **13.6** | `modules/notifications/templates/telegram.templates.ts` | –®–∞–±–ª–æ–Ω—ã –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ Telegram (HTML —Ä–∞–∑–º–µ—Ç–∫–∞): `BALLS_EARNED`, `BALLS_REDEEMED`, `BALLS_EXPIRING`, `LEVEL_UPGRADED`, `PROMO_AVAILABLE`, `BIRTHDAY_PROMO`, `WELCOME`, `TRANSFER_RECEIVED`, `TRANSFER_REQUESTED` ‚Äî —Å emoji, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º —á–∏—Å–µ–ª |
|  | `modules/notifications/templates/sms.templates.ts` | –ö–æ—Ä–æ—Ç–∫–∏–µ SMS: –≤—Å–µ —Ç–∏–ø—ã –¥–æ 160 —Å–∏–º–≤–æ–ª–æ–≤ |
| **13.7** | `modules/notifications/services/notification.service.ts` —á.1 | `send(dto)`: 1) Deduplication check Redis (TTL 5 –º–∏–Ω). 2) Load GuestNotificationSettings. 3) Filter channels –ø–æ preferences + globalMute. 4) –°–æ—Ö—Ä–∞–Ω–∏—Ç—å `Notification(PENDING)` –≤ –ë–î. 5) –î–æ–±–∞–≤–∏—Ç—å –≤ BullMQ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º. |
| **13.8** | `modules/notifications/services/notification.service.ts` —á.2 | 6) `sendViaChannel(channel, dto)`: –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, —Ä–µ–Ω–¥–µ—Ä–∏—Ç —à–∞–±–ª–æ–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å. 7) Batching: LOW priority ‚Äî –∂–¥—ë—Ç 30 –º–∏–Ω, –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç digest. 8) `trackCost(tenantId, channel, cost)`. 9) Prometheus –º–µ—Ç—Ä–∏–∫–∏. |
| **13.9** | `modules/notifications/services/notification.service.ts` —á.3 | `getHistory(userId, query)`: —Å–ø–∏—Å–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏. `markAsRead(notificationId, userId)`. `markAllAsRead(userId)`. `getUnreadCount(userId)`. `bulkSend(dto)`: –¥–ª—è Admin ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ N –≥–æ—Å—Ç—è–º (–¥–æ–±–∞–≤–ª—è–µ—Ç –≤ BullMQ batch). |
| **13.10** | `modules/notifications/services/guest-settings.service.ts` | `getSettings(userId)`: –ø–æ–ª–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —Ç–∏–ø–∞–º –∏ –∫–∞–Ω–∞–ª–∞–º. `updateSettings(userId, dto)`: –æ–±–Ω–æ–≤–ª—è–µ—Ç `GuestNotificationSettings`. `setGlobalMute(userId, muted)`. `getAdminSettings(userId)`. `updateAdminSettings(userId, dto)` (Owner/Admin ‚Äî –∞–ª–µ—Ä—Ç—ã –ø–æ —Ç–∏–ø–∞–º). |
| **13.11** | `modules/notifications/services/template.service.ts` | `render(type, channel, locale, data, tenantId)`: 1) –ò—â–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–π —à–∞–±–ª–æ–Ω —Ç–µ–Ω–∞–Ω—Ç–∞ (–ë–î). 2) –ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî Handlebars compile —Å SafeProxy fallback. 3) –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π React Email / telegram.templates / sms.templates. `validateTemplate(body, availableVars)`. |
| **13.12** | `modules/notifications/jobs/send-notification.job.ts` | BullMQ Processor: adaptive retry (SERVERERROR‚Üíretry, CLIENTERROR‚ÜíUnrecoverableError, RATELIMIT‚ÜíDelayedError). Circuit breaker Redis (10 failures / 10 min window). DLQ: –ø—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –ø–æ–ø—ã—Ç–æ–∫ ‚Üí `NotificationDLQ` + Sentry alert. |
|  | `modules/notifications/jobs/batch-notifications.job.ts` | CRON `*/30 * * * *`: –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç LOW priority notifications –∑–∞ 30 –º–∏–Ω, —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç digest, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º |
| **13.13** | `modules/notifications/notifications.controller.ts` | POST `/notifications/send` (internal), GET `/notifications/my` (Guest + Admin), PUT `/notifications/:id/read`, PUT `/notifications/read-all`, GET `/notifications/settings`, PUT `/notifications/settings`, POST `/notifications/bulk` (Admin), GET `/admin/notifications/dlq`, POST `/admin/notifications/dlq/:id/retry`, POST `/admin/notifications/dlq/:id/dismiss` |
|  | `modules/notifications/notifications.module.ts` | Module, BullMQ queues (priority: 1=HIGH, 5=NORMAL, 10=LOW) |
| **13.14** | `modules/notifications/services/notification.service.spec.ts` | Unit —Ç–µ—Å—Ç—ã: send (dedup ‚Äî –≤—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è), send (globalMute ‚Äî –≤—Å–µ –∫–∞–Ω–∞–ª—ã —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è), channel filtering –ø–æ settings, template rendering (–∫–∞—Å—Ç–æ–º–Ω—ã–π ‚Üí Handlebars, –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π ‚Üí templates), circuit breaker (11 failures ‚Üí OPEN) |
| **13.15** | `modules/notifications/services/template.service.spec.ts` | Unit —Ç–µ—Å—Ç—ã: render —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º —à–∞–±–ª–æ–Ω–æ–º, render —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º, validate (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è), SafeProxy fallback |
| **13.16** | `test/notifications.e2e-spec.ts` | E2E: earn balls ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å Notification(PENDING) —Å–æ–∑–¥–∞–Ω ‚Üí BullMQ job –≤—ã–ø–æ–ª–Ω–µ–Ω ‚Üí Notification(DELIVERED) ‚Üí history endpoint ‚Üí mark as read |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 14 ‚Äî SSE MODULE (3 –∏—Ç–µ—Ä–∞—Ü–∏–∏)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **14.1** | `modules/sse/sse.service.ts` | `emit(userId, event, data)`: —á–µ—Ä–µ–∑ `EventEmitter2`. `emitTenant(tenantId, event, data)`: –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Ç–µ–Ω–∞–Ω—Ç–∞. Events: `notification`, `pos.webhook`, `balance.updated`, `guest.created`, `export.completed`, `permission.updated` |
| **14.2** | `modules/sse/sse.controller.ts` | GET `/sse/events` (JWT, SSE stream): `Observable<MessageEvent>`, –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ EventEmitter2 –ø–æ `userId`. Retry 3 —Å–µ–∫ –ø—Ä–∏ –æ–±—Ä—ã–≤–µ. Ping –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫. |
|  | `modules/sse/sse.module.ts` | Module, EventEmitter2 |
| **14.3** | `modules/notifications/hooks/use-sse.ts` | (Frontend) `useSSE()`: `EventSource`, `withCredentials:true`, –ø–æ–¥–ø–∏—Å–∫–∏ `notification/pos.webhook/balance.updated`, TanStack Query `invalidateQueries`, `sonner` —Ç–æ—Å—Ç. Auto-reconnect —Å exp backoff. |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 15 ‚Äî API DOCUMENTATION (6 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **15.1** | `common/services/api-key.service.ts` | `generateApiKey()` ‚Üí `mlk_live_...` prefix, `hashApiKey()` (SHA-256), `validateApiKey(raw)` ‚Üí `ApiKey` entity, `createApiKey(tenantId, name, permissions, expiresAt)`, `revokeApiKey(id)`, `listApiKeys(tenantId)`, `trackUsage(apiKeyId)` |
|  | `common/guards/api-key.guard.ts` | –ß–∏—Ç–∞–µ—Ç `X-API-Key` header, –≤—ã–∑—ã–≤–∞–µ—Ç `ApiKeyService.validate()`, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç permissions —á–µ—Ä–µ–∑ `RequirePermission` metadata |
|  | `common/guards/unified-auth.guard.ts` | –ü—Ä–æ–±—É–µ—Ç JWT ‚Üí –ø—Ä–æ–±—É–µ—Ç API Key ‚Üí 401. –°—Ç–∞–≤–∏—Ç `req.user` –≤ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —Ñ–æ—Ä–º–µ –≤ –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö |
| **15.2** | `common/guards/rate-limit.guard.ts` | –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: per-tenant sliding window –≤ Redis, endpoint-specific –ª–∏–º–∏—Ç—ã —á–µ—Ä–µ–∑ `@RateLimit(limit, window)` decorator, headers `X-RateLimit-*`, 429 —Å `Retry-After` |
|  | `common/decorators/rate-limit.decorator.ts` | `@RateLimit(limit: number, windowSeconds: number)` |
| **15.3** | `modules/api-docs/api-docs.service.ts` | `logRequest(req, res, duration)`: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Redis LPUSH (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000), `getRecentLogs(filters)`: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ method/status/endpoint/search, `clearOldLogs()` (CRON 24—á) |
|  | `modules/api-docs/api-docs.controller.ts` | GET `/admin/api-logs` (Admin+), GET `/admin/api-keys`, POST `/admin/api-keys`, DELETE `/admin/api-keys/:id`, POST `/admin/api-keys/:id/revoke` |
| **15.4** | `modules/api-docs/interceptors/request-logger.interceptor.ts` | –õ–æ–≥–∏—Ä—É–µ—Ç: method, path, statusCode, duration, userId, tenantId, requestBody (–±–µ–∑ –ø–∞—Ä–æ–ª–µ–π), responseSize |
|  | `modules/api-docs/services/changelog.service.ts` | Conventional Commits –ø–∞—Ä—Å–∏–Ω–≥, `getChangelog()` ‚Üí —á–∏—Ç–∞–µ—Ç `CHANGELOG.md`, `detectBreakingChanges(oldSpec, newSpec)` —á–µ—Ä–µ–∑ openapi-diff |
| **15.5** | `docs/openapi-spec.md` | –û–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö 60+ endpoints —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ request/response, authentication, rate limits |
|  | `docs/integration-guides/iiko.md` | –®–∞–≥-–∑–∞-—à–∞–≥–æ–º: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è webhook URL –≤ iiko, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ secret, —Ç–µ—Å—Ç, troubleshooting |
|  | `docs/integration-guides/rkeeper.md` | XML API –Ω–∞—Å—Ç—Ä–æ–π–∫–∞, plugin install, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è |
| **15.6** | `docs/integration-guides/pos-plugin.md` | –ì–∞–π–¥ –ø–æ –ø–ª–∞–≥–∏–Ω–∞–º: calculate ‚Üí reserve ‚Üí finalize flow, retry logic, offline mode |
|  | `.github/workflows/generate-sdks.yml` | CI: –ø—Ä–∏ –ø—É—à–µ –≤ main ‚Üí –∑–∞–ø—É—Å—Ç–∏—Ç—å backend ‚Üí —Å–∫–∞—á–∞—Ç—å openapi.json ‚Üí codegen TypeScript SDK ‚Üí codegen Python SDK ‚Üí publish npm + PyPI |
|  | `.github/workflows/api-changelog.yml` | CI: `standard-version` ‚Üí `CHANGELOG.md` ‚Üí openapi-diff ‚Üí –µ—Å–ª–∏ breaking changes ‚Üí email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 16 ‚Äî FRONTEND: LAYOUT + AUTH (10 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **16.1** | `apps/frontend/src/lib/api.ts` | Axios instance: baseURL, interceptors (attach JWT, refresh on 401, retry once), `apiClient.get/post/put/patch/delete` —Å TypeScript generics, error normalization |
|  | `apps/frontend/src/lib/auth.ts` | `getAccessToken()`, `setTokens()`, `clearTokens()`, `isTokenExpired()`, `scheduleRefresh()` |
|  | `apps/frontend/src/stores/auth-store.ts` | Zustand: `user`, `accessToken`, `isAuthenticated`, `login()`, `logout()`, `setUser()`. Persist –≤ localStorage (—Ç–æ–ª—å–∫–æ `user`, –Ω–µ —Ç–æ–∫–µ–Ω) |
| **16.2** | `apps/frontend/src/stores/ui-store.ts` | Zustand + persist: `isSidebarMini`, `selectedRestaurantId`, `openModals: Set<string>`, `openModal/closeModal`, `toggleSidebar`, `setSelectedRestaurant`, `theme` |
|  | `apps/frontend/src/stores/notification-store.ts` | Zustand: `notifications[]`, `unreadCount`, `addNotification()`, `markAsRead()`, `markAllAsRead()`, `loadNotifications()` |
| **16.3** | `apps/frontend/src/components/layout/Sidebar.tsx` | –ü–æ–ª–Ω—ã–π sidebar —Å: Logo, collapsible (250px/60px), –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –ø–æ —Ä–æ–ª–∏ (Owner/Admin/Manager/Cashier), –∞–∫—Ç–∏–≤–Ω—ã–π –ø—É–Ω–∫—Ç, `Tooltip` –≤ mini mode, `localStorage` persist, `transition-all` –∞–Ω–∏–º–∞—Ü–∏—è |
| **16.4** | `apps/frontend/src/components/layout/Navbar.tsx` | –ü–æ–ª–Ω—ã–π navbar: mobile toggle, `Breadcrumbs`, Global Search trigger (‚åòK), Notifications popover (badge + –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5), Restaurant selector (–µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ), User menu (avatar, name, role, Settings, Billing, Logout, Impersonate Owner) |
| **16.5** | `apps/frontend/src/components/layout/GlobalSearch.tsx` | `cmdk`: –ø–æ–∏—Å–∫ –ø–æ –≥–æ—Å—Ç—è–º/–ø—Ä–∞–≤–∏–ª–∞–º/–ø—Ä–æ–º–æ —á–µ—Ä–µ–∑ API —Å debounce 300ms, Recent searches –≤ localStorage, keyboard nav, ‚Üí `/guests/:id`, `/loyalty/rules/:id` |
|  | `apps/frontend/src/components/layout/Breadcrumbs.tsx` | –ê–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑ pathname, UUID —Å–µ–≥–º–µ–Ω—Ç—ã ‚Üí `useEntityName(type, id)` (cached query), truncate 30 —Å–∏–º–≤–æ–ª–æ–≤ |
| **16.6** | `apps/frontend/src/components/layout/DashboardLayout.tsx` | Sidebar + Navbar + main content area + mobile bottom nav |
|  | `apps/frontend/src/components/layout/MobileNav.tsx` | Bottom tabs –¥–ª—è 768px: –∏–∫–æ–Ω–∫–∏ + labels, active state, router push |
|  | `apps/frontend/src/components/layout/ImpersonationBanner.tsx` | –û—Ä–∞–Ω–∂–µ–≤—ã–π –±–∞–Ω–Ω–µ—Ä –ø—Ä–∏ impersonation: ¬´–í—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ –æ—Ç –∏–º–µ–Ω–∏ X¬ª, –∫–Ω–æ–ø–∫–∞ ¬´–í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞¬ª |
| **16.7** | `apps/frontend/src/app/(auth)/login/page.tsx` | –§–æ—Ä–º–∞ –ª–æ–≥–∏–Ω–∞: email/phone + –ø–∞—Ä–æ–ª—å, `React Hook Form` + `Zod`, toggle –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å, remember me, —Å—Å—ã–ª–∫–∞ ¬´–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å¬ª, –æ—à–∏–±–∫–∏ –ø–æ–ª—è, rate limit –æ—à–∏–±–∫–∞, MFA —à–∞–≥ (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω) |
|  | `apps/frontend/src/app/(auth)/register/page.tsx` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Owner: –∏–º—è –∫–æ–º–ø–∞–Ω–∏–∏, email, –ø–∞—Ä–æ–ª—å + –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, —Ç–µ–ª–µ—Ñ–æ–Ω, —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ |
|  | `apps/frontend/src/app/(auth)/forgot-password/page.tsx` | Email –ø–æ–ª–µ ‚Üí ¬´–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ¬ª —ç–∫—Ä–∞–Ω |
|  | `apps/frontend/src/app/(auth)/reset-password/page.tsx` | Token –∏–∑ URL, –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å + –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, strength indicator |
| **16.8** | `apps/frontend/src/hooks/use-auth.ts` | `useAuth()`: —á–∏—Ç–∞–µ—Ç auth-store, –º–µ—Ç–æ–¥—ã `login()`, `logout()`, `refresh()`. `useRequireAuth()` ‚Äî redirect –Ω–∞ /login –µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. `useRequireRole(role)` ‚Äî redirect –µ—Å–ª–∏ –Ω–µ—Ç —Ä–æ–ª–∏ |
|  | `apps/frontend/src/hooks/use-permissions.ts` | `usePermissions()`: —Å–ø–∏—Å–æ–∫ permissions –∏–∑ `user.permissions`, `can(permission)` boolean |
|  | `apps/frontend/src/hooks/use-sse.ts` | EventSource, reconnect, –ø–æ–¥–ø–∏—Å–∫–∏, TanStack Query invalidate, sonner toast |
| **16.9** | `apps/frontend/src/components/ui/` | –í—Å–µ shadcn –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (pre-built): Button, Input, Select, Checkbox, Switch, Badge, Card, Dialog, Sheet, Table, Tabs, Tooltip, Popover, Command, Avatar, Progress, Separator, Skeleton, Alert, AlertDialog, Form, Label, Textarea, DatePicker, DateRangePicker, DropdownMenu, Scroll Area |
| **16.10** | `apps/frontend/src/components/shared/EmptyState.tsx` | –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –∏–∫–æ–Ω–∫–æ–π, –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –æ–ø–∏—Å–∞–Ω–∏–µ–º, CTA –∫–Ω–æ–ø–∫–æ–π |
|  | `apps/frontend/src/components/shared/ErrorBoundary.tsx` | React Error Boundary, Sentry capture, ¬´–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å¬ª –∫–Ω–æ–ø–∫–∞ |
|  | `apps/frontend/src/components/shared/BulkActionsBar.tsx` | –ù–∏–∂–Ω—è—è –ø–ª–∞—à–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ: ¬´–í—ã–±—Ä–∞–Ω–æ N¬ª, –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π, ¬´–°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ¬ª |
|  | `apps/frontend/src/components/shared/DataTable.tsx` | TanStack Table v8 wrapper: —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, –ø–∞–≥–∏–Ω–∞—Ü–∏—è, –≤—ã–±–æ—Ä —Å—Ç—Ä–æ–∫, column visibility, export row, URL sync filters |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 17 ‚Äî FRONTEND: GUESTS MANAGEMENT (12 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **17.1** | `apps/frontend/src/hooks/use-guests.ts` | `useGuests(filters)` ‚Äî TanStack Query, `useGuest(id)`, `useCreateGuest()`, `useUpdateGuestProfile()`, `useBlockGuestCard()`, `useManualAdjust()`, `useGuestTransactions(guestCardId, filters)`, `useGuestVisits(guestCardId)` |
| **17.2** | `apps/frontend/src/app/(admin)/guests/page.tsx` | Server Component: SSR –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. Client: `GuestsPageClient` —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –≤ URL params |
|  | `apps/frontend/src/components/guests/GuestsTable.tsx` | TanStack Table: –∫–æ–ª–æ–Ω–∫–∏ (Name, Phone, Balance, Level, Visits, Lifetime, LastVisit, Status), resizable, pinnable ID, row selection, sort URL sync, paginated |
| **17.3** | `apps/frontend/src/components/guests/GuestsFilters.tsx` | –§–∏–ª—å—Ç—Ä—ã: –ø–æ–∏—Å–∫ (debounce), —É—Ä–æ–≤–µ–Ω—å (multi-select), —Å—Ç–∞—Ç—É—Å, –±–∞–ª–∞–Ω—Å range, –¥–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ range, –∏—Å—Ç–æ—á–Ω–∏–∫ (POS/Telegram/Link), —Å–µ–≥–º–µ–Ω—Ç, —Ä–µ—Å—Ç–æ—Ä–∞–Ω. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä. |
|  | `apps/frontend/src/components/guests/GuestSegments.tsx` | –ê–≤—Ç–æ-—Å–µ–≥–º–µ–Ω—Ç—ã (VIP/At-Risk/Lost/New/Birthday) + –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã |
| **17.4** | `apps/frontend/src/app/(admin)/guests/[id]/page.tsx` | Guest Profile page: `Tabs` (Overview, Transactions, Visits, Activity Log) |
|  | `apps/frontend/src/components/guests/GuestOverview.tsx` | –õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ (–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω, email, –î–†, –≥–æ—Ä–æ–¥), Loyalty —Å—Ç–∞—Ç—É—Å (—É—Ä–æ–≤–µ–Ω—å —Å badge, –±–∞–ª–∞–Ω—Å regular+promo, lifetime, visits, avgCheck), Quick Actions (Add/Remove balls, Block, Reset QR, Send Message) |
| **17.5** | `apps/frontend/src/components/guests/GuestTransactionsTab.tsx` | –¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: —Ç–∏–ø (–∏–∫–æ–Ω–∫–∞), —Å—É–º–º–∞ (+/-), –±–∞–ª–∞–Ω—Å –¥–æ/–ø–æ—Å–ª–µ, –¥–∞—Ç–∞, —Ä–µ—Å—Ç–æ—Ä–∞–Ω, —Ç–∏–ø —á–µ–∫–∞, –∫–Ω–æ–ø–∫–∞ Cancel (–¥–ª—è —Ä—É—á–Ω—ã—Ö). –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É. |
|  | `apps/frontend/src/components/guests/GuestVisitsTab.tsx` | –°–ø–∏—Å–æ–∫ –≤–∏–∑–∏—Ç–æ–≤: –¥–∞—Ç–∞, —Ä–µ—Å—Ç–æ—Ä–∞–Ω, —Å—É–º–º–∞ —á–µ–∫–∞, –±–∞–ª–ª—ã –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ/–ø–æ—Ç—Ä–∞—á–µ–Ω–æ, —Å—Ç–∞—Ç—É—Å |
|  | `apps/frontend/src/components/guests/GuestActivityLogTab.tsx` | Audit log: action, actor, changes (JSON diff –∫—Ä–∞—Å–∏–≤–æ), IP, –¥–∞—Ç–∞ |
| **17.6** | `apps/frontend/src/components/guests/CreateGuestModal.tsx` | –®–∞–≥–∏: 1) –§–ò–û + —Ç–µ–ª–µ—Ñ–æ–Ω + –î–†, 2) Email + –≥–æ—Ä–æ–¥, 3) –ö–∞–Ω–∞–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ + QR/6-digit preview. RHF + Zod. |
|  | `apps/frontend/src/components/guests/ManualAdjustmentModal.tsx` | –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (regular + promo), –¥–µ–π—Å—Ç–≤–∏–µ (Add/Remove), —Å—É–º–º–∞, —Ç–∏–ø (Regular/Promo), –ø—Ä–∏—á–∏–Ω–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞), ¬´–£–≤–µ–¥–æ–º–∏—Ç—å –≥–æ—Å—Ç—è¬ª checkbox, confirmation –¥–ª—è > 1000 |
| **17.7** | `apps/frontend/src/components/guests/BlockGuestModal.tsx` | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø—Ä–∏—á–∏–Ω—ã, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è—Ö |
|  | `apps/frontend/src/components/guests/BulkActionsGuests.tsx` | Bulk: Export (format picker), Add Balls (–≤—Å–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–º), Send Notification (Telegram/Email), Block/Unblock, Change Level |
| **17.8** | `apps/frontend/src/components/guests/GuestChildrenSection.tsx` | –°–ø–∏—Å–æ–∫ –¥–µ—Ç–µ–π (–∏–º—è + –î–† + –≤–æ–∑—Ä–∞—Å—Ç + ¬´–î–Ω–µ–π –¥–æ –î–†¬ª), –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å (modal —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –º–∞–∫—Å 3), —É–¥–∞–ª–∏—Ç—å —Å confirm |
|  | `apps/frontend/src/components/guests/GuestLevelProgress.tsx` | –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä: current lifetime ‚Üí next level threshold, –ø—Ä–æ—Ü–µ–Ω—Ç, —Å—É–º–º–∞ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è |
| **17.9** | `apps/frontend/src/components/guests/RegistrationLinksTable.tsx` | –¢–∞–±–ª–∏—Ü–∞ —Å—Å—ã–ª–æ–∫: –Ω–∞–∑–≤–∞–Ω–∏–µ, URL (copy), –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π, —Å—Ç–∞—Ç—É—Å, expires. –°–æ–∑–¥–∞—Ç—å/–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å |
|  | `apps/frontend/src/components/guests/CreateRegistrationLinkModal.tsx` | –ò–º—è, –æ–ø–∏—Å–∞–Ω–∏–µ, maxUses (null=unlimited), expiresAt, restaurantId (–µ—Å–ª–∏ SEPARATE mode) |
| **17.10** | `apps/frontend/src/app/(cashier)/page.tsx` | Cashier interface: –ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è (phone/QR/6-digit/–§–ò–û), –∫–∞—Ä—Ç–æ—á–∫–∞ –≥–æ—Å—Ç—è —Å –±–∞–ª–∞–Ω—Å–æ–º, –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è/—Å–ø–∏—Å–∞–Ω–∏—è, –∫–Ω–æ–ø–∫–∞ ¬´–û—Ñ–æ—Ä–º–∏—Ç—å¬ª |
|  | `apps/frontend/src/components/cashier/GuestCardCashier.tsx` | –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: —Ñ–æ—Ç–æ, –∏–º—è, –±–∞–ª–∞–Ω—Å, —É—Ä–æ–≤–µ–Ω—å, QR-–∫–æ–¥ |
|  | `apps/frontend/src/components/cashier/LoyaltyCalculator.tsx` | –ü–æ–ª–µ ¬´–°—É–º–º–∞ —á–µ–∫–∞¬ª, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç (GET /loyalty/calculate), –ø–æ–∫–∞–∑ –ø—Ä–∞–≤–∏–ª –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å, –ø–æ–ª–µ ¬´–°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª–æ–≤¬ª (—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º), –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å¬ª |
| **17.11** | `apps/frontend/src/hooks/use-loyalty-calculator.ts` | `useLoyaltyCalculate(guestCardId, checkAmount, redeemedPoints)` ‚Äî debounce 500ms, –∫–µ—à 30 —Å–µ–∫ |
|  | `apps/frontend/src/hooks/use-loyalty-transaction.ts` | `useLoyaltyTransaction()` ‚Äî mutation —Å Idempotency-Key (UUID –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è per-click), optimistic update –±–∞–ª–∞–Ω—Å–∞ |
| **17.12** | `apps/frontend/src/app/(admin)/guests/export/page.tsx` | Export wizard: –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –æ—Ç—á—ë—Ç–∞, —Ñ–æ—Ä–º–∞—Ç, –ø–µ—Ä–∏–æ–¥, —Ñ–∏–ª—å—Ç—Ä—ã, –∫–æ–ª–æ–Ω–∫–∏, –∫–Ω–æ–ø–∫–∞ ¬´–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª, polling —Å—Ç–∞—Ç—É—Å–∞, download |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 18 ‚Äî FRONTEND: LOYALTY BUILDER (10 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **18.1** | `apps/frontend/src/hooks/use-loyalty.ts` | `useLoyaltySystem()`, `useUpdateLoyaltySystem()`, `useLoyaltyLevels()`, `useCreateLevel()`, `useUpdateLevel()`, `useDeleteLevel()`, `useLoyaltyRules()`, `useCreateRule()`, `useUpdateRule()`, `useLoyaltyPromos()`, `useCreatePromo()`, `useUpdatePromo()` |
| **18.2** | `apps/frontend/src/app/(admin)/loyalty/rules/page.tsx` | –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª: DnD (dnd-kit) –¥–ª—è drag-to-reorder priority, badge —Å—Ç–∞—Ç—É—Å–∞, –∫–Ω–æ–ø–∫–∏ Edit/Activate/Deactivate/Archive, –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ |
|  | `apps/frontend/src/components/loyalty/RulesList.tsx` | DnD —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ + –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ priority |
| **18.3** | `apps/frontend/src/components/loyalty/RuleBuilder.tsx` | –§–æ—Ä–º–∞ + Live Preview. –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –Ω–∞–∑–≤–∞–Ω–∏–µ, earnPercent, —Å—Ç–∞—Ç—É—Å, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç. –ü—Ä–∞–≤–∞—è: –ø—Ä–µ–≤—å—é –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –≥–æ—Å—Ç—è (–ø—Ä–∏–º–µ—Ä —á–µ–∫–∞ 2000‚ÇΩ ‚Üí X –±–∞–ª–ª–æ–≤). |
|  | `apps/frontend/src/components/loyalty/ConditionsBuilder.tsx` | Tag-based builder: –∫–Ω–æ–ø–∫–∞ ¬´+ –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–∏–µ¬ª ‚Üí dropdown (minCheckAmount / daysOfWeek / timeRange / guestLevel / restaurant). –ö–∞–∂–¥–æ–µ —É—Å–ª–æ–≤–∏–µ ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º. AND –ª–æ–≥–∏–∫–∞. |
| **18.4** | `apps/frontend/src/app/(admin)/loyalty/levels/page.tsx` | Levels Builder: –≤–∏–∑—É–∞–ª—å–Ω–∞—è —Ç–∞–π–º–ª–∞–π–Ω (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è), –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –ø–æ—Ä–æ–≥–æ–º, —Ü–≤–µ—Ç–æ–º, –∏–∫–æ–Ω–∫–æ–π |
|  | `apps/frontend/src/components/loyalty/LevelsTimeline.tsx` | –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π timeline: —É—Ä–æ–≤–Ω–∏ –Ω–∞ –æ—Å–∏ (Bronze‚ÜíSilver‚ÜíGold‚Üí...), —Ç–µ–∫—É—â–µ–µ lifetimeSpent –≥–æ—Å—Ç—è –∫–∞–∫ —Ç–æ—á–∫–∞, –∫–æ–ª-–≤–æ –≥–æ—Å—Ç–µ–π –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ |
|  | `apps/frontend/src/components/loyalty/LevelEditModal.tsx` | –§–æ—Ä–º–∞: –Ω–∞–∑–≤–∞–Ω–∏–µ, threshold, earnBonus (%), —Ü–≤–µ—Ç (color picker), –∏–∫–æ–Ω–∫–∞ (emoji picker), benefits (textarea). –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –µ—Å–ª–∏ –µ—Å—Ç—å –≥–æ—Å—Ç–∏ –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ |
| **18.5** | `apps/frontend/src/app/(admin)/loyalty/promos/page.tsx` | –°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ: —Ç–∏–ø (badge), —Å—Ç–∞—Ç—É—Å, trigger, –ø–µ—Ä–∏–æ–¥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –∫–æ–ª-–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π |
|  | `apps/frontend/src/components/loyalty/PromoWizard.tsx` | 4-—à–∞–≥–æ–≤—ã–π wizard: 1) –¢–∏–ø (Birthday/Inactivity/FirstCheck/Weekday/TimeRange/CheckAmount/Custom) + —à–∞–±–ª–æ–Ω—ã, 2) –£—Å–ª–æ–≤–∏—è (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —Ç–∏–ø–∞), 3) –ù–∞–≥—Ä–∞–¥–∞ (bonusPoints / bonusPercent + expiresInDays), 4) –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø–µ—Ä–∏–æ–¥, –ª–∏–º–∏—Ç—ã, priority) |
| **18.6** | `apps/frontend/src/components/loyalty/PromoPreview.tsx` | –ü—Ä–µ–≤—å—é –ø—Ä–æ–º–æ –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –≤ –±–æ—Ç–µ: mock Telegram —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —ç–º–æ–¥–∑–∏ –∏ –¥–∞–Ω–Ω—ã–º–∏ |
|  | `apps/frontend/src/components/loyalty/ConflictStrategySelector.tsx` | Radio –≥—Ä—É–ø–ø–∞: COMBINE_ALL / MAX_ONLY / FIRST_ONLY —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏ –∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ |
| **18.7** | `apps/frontend/src/app/(admin)/loyalty/system/page.tsx` | LoyaltySystem Settings: —Ç–∏–ø (POINTS/DISCOUNT), cardMode (UNIFIED/SEPARATE ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏!), ballToRubleRatio, earnPercent, minCheckAmount, maxRedeemPercent, inactivityExpireDays, conflict strategy, transfer settings |
|  | `apps/frontend/src/components/loyalty/LoyaltySystemForm.tsx` | Tabbed —Ñ–æ—Ä–º–∞ —Å live –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è |
| **18.8** | `apps/frontend/src/app/(admin)/loyalty/rules/[id]/versions/page.tsx` | –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π –ø—Ä–∞–≤–∏–ª–∞: —Ç–∞–±–ª–∏—Ü–∞ —Å –¥–∞—Ç–∞/–∞–≤—Ç–æ—Ä/–ø—Ä–∏—á–∏–Ω–∞, diff –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏ (JSON diff –ø–æ–¥—Å–≤–µ—Ç–∫–∞) |
|  | `apps/frontend/src/components/loyalty/VersionHistory.tsx` | Accordion –≤–µ—Ä—Å–∏–π, –∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–∫–∞—Ç–∏—Ç—å –∫ –≤–µ—Ä—Å–∏–∏¬ª —Å confirm |
| **18.9** | `apps/frontend/src/app/(admin)/loyalty/promos/[id]/page.tsx` | –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–º–æ: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (activations, conversions, bonus issued, ROI), –∏—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π, —Å–ø–∏—Å–æ–∫ –≥–æ—Å—Ç–µ–π –ø–æ–ª—É—á–∏–≤—à–∏—Ö –ø—Ä–æ–º–æ |
| **18.10** | `apps/frontend/src/app/(admin)/loyalty/builder/page.tsx` | Unified builder page: –ª–µ–≤—ã–π sidebar —Å —Å–µ–∫—Ü–∏—è–º–∏ (–°–∏—Å—Ç–µ–º–∞, –£—Ä–æ–≤–Ω–∏, –ü—Ä–∞–≤–∏–ª–∞, –ü—Ä–æ–º–æ), right panel —Å content |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 19 ‚Äî FRONTEND: ANALYTICS + OWNER (10 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **19.1** | `apps/frontend/src/components/analytics/MetricCard.tsx` | KPI –∫–∞—Ä—Ç–æ—á–∫–∞: –∑–Ω–∞—á–µ–Ω–∏–µ, trend (+/- % vs –ø—Ä–æ—à–ª—ã–π –ø–µ—Ä–∏–æ–¥), sparkline mini-chart (Recharts), tooltip —Å –¥–µ—Ç–∞–ª—è–º–∏ |
|  | `apps/frontend/src/components/analytics/DateRangePicker.tsx` | Presets: Today, Last 7/30/90 days, This month, Custom. `react-day-picker` DayPicker `mode="range"`, locale ru |
| **19.2** | `apps/frontend/src/components/analytics/charts/` | `RevenueLineChart.tsx`, `GuestsByLevelPieChart.tsx`, `TopPromoBarChart.tsx`, `ChurnBarChart.tsx`, `RevenueByPlanDonutChart.tsx` ‚Äî –≤—Å–µ Recharts, `ResponsiveContainer`, –∫–∞—Å—Ç–æ–º–Ω—ã–π Tooltip, Legend, –∞–Ω–∏–º–∞—Ü–∏—è |
|  | `apps/frontend/src/components/analytics/DrillDownDrawer.tsx` | Sheet (right panel): –∑–∞–≥–æ–ª–æ–≤–æ–∫, —Ñ–∏–ª—å—Ç—Ä—ã, DataTable –≥–æ—Å—Ç–µ–π, Export –∫–Ω–æ–ø–∫–∞ |
| **19.3** | `apps/frontend/src/app/(admin)/analytics/page.tsx` | Restaurant Admin dashboard: DateRangePicker + restaurant selector, 4 KPI –∫–∞—Ä—Ç–æ—á–∫–∏, Revenue Trend (30 –¥–Ω–µ–π), Guests by Level (pie), Top Promos (bar), Loyalty ROI, Guest Segments (4 –∫–∞—Ä—Ç–æ—á–∫–∏ —Å drill-down) |
|  | `apps/frontend/src/hooks/use-analytics.ts` | `useRestaurantAnalytics(restaurantId, period)` ‚Äî refetchInterval 30000, `usePlatformMetrics(period)`, `useGuestAnalytics(period)`, `useExportReport()` |
| **19.4** | `apps/frontend/src/app/(owner)/dashboard/page.tsx` | Owner Platform Dashboard: MRR, ARR, Active Tenants, Churn Rate (4 KPI), Revenue by Plan (donut), Churn Analysis (bar by reason), Top Tenants (table), New Tenants trend (line) |
|  | `apps/frontend/src/components/owner/TenantHealthScore.tsx` | Score 0-100, —Ü–≤–µ—Ç (green/yellow/red), –ø—Ä–∏—á–∏–Ω—ã —Å–Ω–∏–∂–µ–Ω–∏—è, action –∫–Ω–æ–ø–∫–∞ |
| **19.5** | `apps/frontend/src/app/(owner)/tenants/page.tsx` | Tenants table: Name, Plan badge, Status badge, MRR, Guests count, LastActivity, Actions (View/Block/Change Plan/Impersonate). –§–∏–ª—å—Ç—Ä—ã: Plan, Status, –ø–æ–∏—Å–∫ |
|  | `apps/frontend/src/components/owner/TenantCard.tsx` | Desktop: table row. Mobile: Card view |
|  | `apps/frontend/src/components/owner/ChangePlanModal.tsx` | –í—ã–±–æ—Ä –ø–ª–∞–Ω–∞ (radio —Å —Ü–µ–Ω–∞–º–∏), –ø–µ—Ä–∏–æ–¥ (Monthly/Yearly), —Ä–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏, reason –ø–æ–ª–µ |
| **19.6** | `apps/frontend/src/app/(owner)/tenants/[id]/page.tsx` | Tenant detail: info, subscription, limits usage (progress bars), billing history, team members, restaurants list |
|  | `apps/frontend/src/components/owner/TenantLimitsUsage.tsx` | Progress bars: Restaurants / Guests / POS Integrations / Admin Users, warning –ø—Ä–∏ > 90% |
| **19.7** | `apps/frontend/src/app/(owner)/billing/page.tsx` | Owner billing: subscription card, invoices table (—Å download PDF), payment methods, MRR breakdown |
|  | `apps/frontend/src/app/(admin)/billing/page.tsx` | Admin billing: current plan, usage, upgrade CTA, invoices, billing info form |
| **19.8** | `apps/frontend/src/components/analytics/ExportModal.tsx` | Wizard: 1) –¢–∏–ø (Guests/Transactions/Promo ROI/Restaurant Performance), 2) –§–æ—Ä–º–∞—Ç (XLSX/CSV/PDF), 3) –ü–µ—Ä–∏–æ–¥, 4) –§–∏–ª—å—Ç—Ä—ã, 5) –ö–æ–ª–æ–Ω–∫–∏ (multi-select + drag reorder). –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ¬´–≠–∫—Å–ø–æ—Ä—Ç¬ª ‚Üí polling —Å—Ç–∞—Ç—É—Å–∞ ‚Üí ¬´–°–∫–∞—á–∞—Ç—å¬ª |
| **19.9** | `apps/frontend/src/app/(manager)/dashboard/page.tsx` | Manager Dashboard: —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, —É–ø—Ä–æ—â—ë–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏, –±–µ–∑ billing, POS —Å—Ç–∞—Ç—É—Å –≤–∏–¥–∂–µ—Ç |
|  | `apps/frontend/src/app/(manager)/activity-log/page.tsx` | Activity Log: read-only, —Ñ–∏–ª—å—Ç—Ä—ã (action, user, date range, search), —Ç–∞–±–ª–∏—Ü–∞ —Å –¥–µ—Ç–∞–ª—è–º–∏. Manager –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞. |
| **19.10** | `apps/frontend/src/app/(admin)/settings/page.tsx` | SettingsLayout —Å tabs: General, Loyalty System, POS Integration, Notifications, Team, Billing |
|  | `apps/frontend/src/app/(admin)/settings/team/page.tsx` | Team Management: —Ç–∞–±–ª–∏—Ü–∞ —Å —Ä–æ–ª—è–º–∏, Invite Modal (email + role + restaurants), Edit permissions, Remove |
|  | `apps/frontend/src/app/(admin)/settings/pos/page.tsx` | POS Integration settings: select POS, credentials form, webhook URL + copy, last sync status, Test Connection, Sync Log |
|  | `apps/frontend/src/app/(admin)/settings/notifications/page.tsx` | Notification Settings: –∫–∞–Ω–∞–ª—ã –ø–æ —Ç–∏–ø–∞–º —Å–æ–±—ã—Ç–∏–π, —à–∞–±–ª–æ–Ω—ã (Template Editor —Å live preview), Rate limits |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 20 ‚Äî INFRASTRUCTURE \& DEVOPS (12 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **20.1** | `Dockerfile.backend` | Multi-stage: 1) builder (node:20-alpine, npm ci, prisma generate, build), 2) runner (node:20-alpine, —Ç–æ–ª—å–∫–æ prod deps, non-root user `node`) |
|  | `Dockerfile.frontend` | Multi-stage: builder + runner, standalone output Next.js |
|  | `Dockerfile.worker` | –û—Ç–¥–µ–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ –¥–ª—è BullMQ workers (—Ç–æ—Ç –∂–µ –∫–æ–¥, entrypoint `worker.ts`) |
|  | `Dockerfile.bot` | Telegram bot |
| **20.2** | `docker-compose.yml` | –ü–æ–ª–Ω—ã–π: backend (—Å env, volumes, depends_on postgres+redis), frontend, worker, cron (separate container), bot, postgres (15, —Å init.sql), redis (7, —Å password, AOF persistence), pgbouncer, nginx (reverse proxy), all —Å health checks |
|  | `docker-compose.prod.yml` | Prod override: resource limits (memory/cpu), restart policies, no volumes mounts |
|  | `docker-compose.test.yml` | Test DB –∏ Redis –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É |
| **20.3** | `nginx/nginx.conf` | Reverse proxy: `/api/` ‚Üí backend:3000, `/` ‚Üí frontend:3001, WebSocket upgrade (SSE), gzip, rate limiting, security headers |
|  | `nginx/ssl.conf` | SSL —Ç–µ—Ä–º–∏–Ω–∞—Ü–∏—è (certbot), HSTS, TLS 1.2+ only |
| **20.4** | `.github/workflows/ci.yml` | CI: on push/PR ‚Üí lint + typecheck + unit tests + integration tests (test Docker Compose) + coverage report ‚Üí Codecov |
|  | `.github/workflows/cd-staging.yml` | CD Staging: on push main ‚Üí build images ‚Üí push to registry ‚Üí deploy to staging k8s ‚Üí smoke tests |
|  | `.github/workflows/cd-prod.yml` | CD Prod: on release tag ‚Üí same pipeline + manual approval ‚Üí deploy prod ‚Üí health check |
| **20.5** | `k8s/namespace.yaml` | Namespace `max-loyalty` |
|  | `k8s/backend-deployment.yaml` | Deployment: 3 replicas, rolling update (maxUnavailable=1), resource requests/limits, livenessProbe + readinessProbe, envFrom configmap+secret |
|  | `k8s/worker-deployment.yaml` | Worker: 2 replicas, lower resources |
|  | `k8s/hpa.yaml` | HPA: backend 3-10 replicas –ø–æ CPU > 70%, worker 2-8 –ø–æ queue depth |
| **20.6** | `k8s/services.yaml` | ClusterIP services –¥–ª—è backend, frontend, worker, bot |
|  | `k8s/ingress.yaml` | NGINX Ingress: api.max-loyalty.com ‚Üí backend, app.max-loyalty.com ‚Üí frontend, SSL |
|  | `k8s/configmap.yaml` | –í—Å–µ non-secret ENV vars |
|  | `k8s/secrets.yaml` | (Template) DATABASE_URL, JWT secrets, API keys ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ Vault |
| **20.7** | `k8s/postgres-statefulset.yaml` | PostgreSQL StatefulSet: PVC 100Gi, liveness/readiness probe, resource limits |
|  | `k8s/redis-statefulset.yaml` | Redis StatefulSet: AOF persistence, password, sentinel –¥–ª—è HA |
|  | `k8s/pgbouncer-deployment.yaml` | PgBouncer: 2 replicas, configmap —Å pgbouncer.ini |
| **20.8** | `monitoring/prometheus.yml` | Scrape configs: backend (/metrics), postgres-exporter, redis-exporter, node-exporter |
|  | `monitoring/alerts.yml` | AlertManager rules: HighCPU, HighMemory, LowDeliveryRate, HighLatency, POSWebhookFailed, DBConnectionPoolExhausted, QueueDepthHigh |
|  | `monitoring/grafana-dashboards/backend.json` | Grafana dashboard: RPS, latency p50/p95/p99, error rate, active connections, BullMQ queues |
| **20.9** | `monitoring/grafana-dashboards/business.json` | Business dashboard: MRR trend, new registrations/day, balls issued today, loyalty transactions/min, POS sync status |
|  | `monitoring/grafana-dashboards/notifications.json` | Notifications dashboard: delivery rate, latency, failed, cost by channel |
|  | `monitoring/loki-config.yaml` | Loki + Promtail: scrape Docker logs, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ JSON –ª–æ–≥–∏ |
| **20.10** | `scripts/backup.sh` | PostgreSQL dump ‚Üí S3 (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ, —Ö—Ä–∞–Ω–∏—Ç—å 30 –¥–Ω–µ–π), Redis BGSAVE ‚Üí S3, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram |
|  | `scripts/restore.sh` | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ S3 backup —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º |
|  | `scripts/health-check.sh` | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç backend, DB, Redis, BullMQ queues ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–ª–µ—Ä—Ç –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–∞–¥–∞–µ—Ç |
| **20.11** | `scripts/migrate.sh` | Zero-downtime migration: `prisma migrate deploy` + `REINDEX CONCURRENTLY` + smoke tests |
|  | `scripts/seed-prod.sh` | –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π seed prod: —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—ë—Ç Owner –µ—Å–ª–∏ –Ω–µ—Ç, –Ω–µ —É–¥–∞–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ |
|  | `scripts/generate-keys.sh` | –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã (JWT, AES, webhook secrets), –≤—ã–≤–æ–¥–∏—Ç `.env` |
| **20.12** | `.github/workflows/security-scan.yml` | Weekly: Trivy (Docker image scan) + npm audit + Snyk ‚Üí issues –≤ GitHub Security |
|  | `RUNBOOK.md` | –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: –∫–∞–∫ deploy, rollback, incident response, scaling |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 21 ‚Äî SECURITY (8 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **21.1** | `common/security/xss.filter.ts` | `DOMPurify` sanitize –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö input (—á–µ—Ä–µ–∑ `ValidationPipe` transform) |
|  | `common/security/sql-injection.guard.ts` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–∞ SQL-injection patterns (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–ª–æ–π –∫ Prisma parameterized queries) |
|  | `common/security/content-security-policy.middleware.ts` | CSP headers: `default-src 'self'`, `script-src 'self'`, `connect-src api.max-loyalty.com`, frame-ancestors |
| **21.2** | `common/security/encryption.service.ts` | AES-256-GCM –¥–ª—è POS API credentials (encrypt –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏, decrypt –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏), key rotation support |
|  | `common/security/hmac.service.ts` | Centralized HMAC-SHA256: –¥–ª—è webhook signatures, API key signing, link tokens |
|  | `common/security/audit.service.ts` | GDPR compliance: `exportPersonalData(userId)` ‚Üí JSON –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö, `deletePersonalData(userId)` ‚Üí anonymize + hard delete, `getDataRetentionPolicy()` |
| **21.3** | `apps/frontend/src/middleware.ts` | Next.js middleware: Auth check (JWT –∏–∑ cookie), role-based redirect, CSRF token validation |
|  | `apps/frontend/src/lib/csrf.ts` | CSRF token: generate –≤ cookie, validate –≤ header `X-CSRF-Token` |
|  | `common/middleware/security-headers.middleware.ts` | Helmet.js: X-Frame-Options, X-XSS-Protection, X-Content-Type-Options, HSTS, referrer-policy |
| **21.4** | `docs/security/owasp-checklist.md` | –ß–µ–∫–ª–∏—Å—Ç OWASP Top 10: A01 Broken Access Control ‚Üí RBAC+tenant isolation, A02 Cryptographic Failures ‚Üí AES-256, A03 Injection ‚Üí Prisma parameterized, A05 Security Misconfiguration ‚Üí Helmet+CSP, A07 Auth Failures ‚Üí Rate limit+MFA, A09 Logging ‚Üí ActivityLog+Sentry |
|  | `docs/security/gdpr-compliance.md` | GDPR flow: –¥–∞–Ω–Ω—ã–µ –∫–æ—Ç–æ—Ä—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è, lawful basis, right to access (export), right to erasure (anonymize), data retention policies |
| **21.5** | `docs/security/incident-response.md` | Playbook: –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ ‚Üí –∏–∑–æ–ª—è—Ü–∏—è ‚Üí —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (72—á GDPR) ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Üí post-mortem |
|  | `docs/security/pen-test-report-template.md` | –®–∞–±–ª–æ–Ω –¥–ª—è pentest: scope, –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è, findings (severity), remediation |
| **21.6** | `common/security/pci-dss.notes.md` | PCI DSS: –Ω–µ —Ö—Ä–∞–Ω–∏–º PAN, CVV, –ø–æ–ª–Ω—ã–µ card numbers. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (YooKassa/Stripe) ‚Äî –æ–Ω–∏ PCI certified. –ù–∞—à–∞ —Ä–æ–ª—å ‚Äî SAQ A (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è) |
| **21.7** | `test/security/` | `auth.security.spec.ts` ‚Äî SQL injection –ø–æ–ø—ã—Ç–∫–∏, XSS –≤ input fields, CSRF –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ ‚Üí 403, –±—Ä—É—Ç—Ñ–æ—Ä—Å ‚Üí 429, JWT tamper ‚Üí 401, expired token ‚Üí 401, –¥—Ä—É–≥–æ–π tenant data ‚Üí 403 |
| **21.8** | `.github/dependabot.yml` | Auto-update deps: npm weekly, Docker images monthly |
|  | `.github/workflows/codeql.yml` | GitHub CodeQL analysis: JavaScript/TypeScript SAST |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 22 ‚Äî PLUGIN (POS Desktop) (6 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **22.1** | `plugins/iiko/MaxLoyalty.Plugin.cs` | iiko plugin interface: `IPlugin`, `OnCheckOpened`, `OnCheckClosed`, `OnBeforePayment`, `OnAfterPayment` ‚Äî –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è |
| **22.2** | `plugins/iiko/ApiClient.cs` | HTTP –∫–ª–∏–µ–Ω—Ç –∫ backend: `SearchGuest(phone)`, `CalculateLoyalty(checkAmount, guestCardId)`, `ReserveBalls(guestCardId, amount)`, `FinalizeLoyalty(checkAmount, guestCardId, earned, redeemed)`, `RegisterGuest(phone, name)` ‚Äî retry, timeout 3 —Å–µ–∫, offline mode |
| **22.3** | `plugins/iiko/UI/LoyaltyPanel.xaml` + `.cs` | WPF –ø–∞–Ω–µ–ª—å –≤ iiko: –ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è, –±–∞–ª–∞–Ω—Å, –Ω–∞—á–∏—Å–ª–∏—Ç—å/—Å–ø–∏—Å–∞—Ç—å –±–∞–ª–ª–æ–≤, QR —Å–∫–∞–Ω–µ—Ä (—á–µ—Ä–µ–∑ –∫–∞–º–µ—Ä—É –∏–ª–∏ —Å—á–∏—Ç—ã–≤–∞—Ç–µ–ª—å), —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è |
| **22.4** | `plugins/rkeeper/MaxLoyaltyPlugin.cpp` | R-Keeper DLL: `GetLoyaltyInfo`, `ApplyDiscount`, `GetGuestInfo` ‚Äî C++ wrapper –Ω–∞–¥ HTTP –∫–ª–∏–µ–Ω—Ç–æ–º |
|  | `plugins/rkeeper/MaxLoyaltyClient.cs` | C\# WPF –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è R-Keeper: –∞–Ω–∞–ª–æ–≥ iiko UI |
| **22.5** | `plugins/shared/OfflineQueue.cs` | –õ–æ–∫–∞–ª—å–Ω–∞—è SQLite –æ—á–µ—Ä–µ–¥—å –æ–ø–µ—Ä–∞—Ü–∏–π –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞, sync –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏ |
| **22.6** | `plugins/shared/Config.cs` | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–∞: API URL, API Key, restaurantId, timeout, retry count ‚Äî –∏–∑ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ config —Ñ–∞–π–ª–∞ |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 23 ‚Äî –¢–ï–°–¢–´ (–ø–æ–ª–Ω—ã–µ) (8 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **23.1** | `test/setup/test-app.ts` | `createTestApp()` ‚Äî NestJS app —Å test DB, mocked external services (Resend, SMSC, Telegram), seeded data |
|  | `test/setup/seed.ts` | –ü–æ–ª–Ω—ã–π seed –¥–ª—è —Ç–µ—Å—Ç–æ–≤: Owner+Tenant, Admin+Manager+Cashier+Guest users, 2 —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, LoyaltySystem, 3 —É—Ä–æ–≤–Ω—è, 3 –ø—Ä–∞–≤–∏–ª–∞, 1 –ø—Ä–æ–º–æ, 5 –≥–æ—Å—Ç–µ–≤—ã—Ö –∫–∞—Ä—Ç —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ |
|  | `test/setup/mocks.ts` | –í—Å–µ –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã: Resend ‚Üí noop, SMSC ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –º–∞—Å—Å–∏–≤, Telegram ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –º–∞—Å—Å–∏–≤, S3 ‚Üí local filesystem, BullMQ ‚Üí synchronous execution |
| **23.2** | `test/auth.e2e-spec.ts` | 25+ —Ç–µ—Å—Ç–æ–≤: register‚Üílogin‚Üírefresh‚Üílogout, MFA flow, forgot/reset password, impersonation, rate limiting (6 –ø–æ–ø—ã—Ç–æ–∫), expired token, wrong tenant |
| **23.3** | `test/guests.e2e-spec.ts` | 20+ —Ç–µ—Å—Ç–æ–≤: —Å–æ–∑–¥–∞–Ω–∏–µ 4 —Å–ø–æ—Å–æ–±–∞–º–∏, –ø–æ–∏—Å–∫ (QR/6-digit/phone), –ø—Ä–æ—Ñ–∏–ª—å, —Å–º–µ–Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –¥–µ—Ç–∏ (max 3), GDPR export/delete |
| **23.4** | `test/loyalty-engine.e2e-spec.ts` | 25+ —Ç–µ—Å—Ç–æ–≤: calculate, earn+redeem, idempotency (–¥–≤–∞–∂–¥—ã ‚Üí –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è), manual adjust, transfer (SMS OTP flow), expiry job |
| **23.5** | `test/pos.e2e-spec.ts` | 15+ —Ç–µ—Å—Ç–æ–≤: iiko webhook (valid, invalid HMAC, duplicate, refund), rkeeper webhook (XML), PULL job, reconciliation |
| **23.6** | `test/billing.e2e-spec.ts` | 10+ —Ç–µ—Å—Ç–æ–≤: YooKassa webhook payment.succeeded, payment.cancelled, refund, plan change, invoice PDF |
| **23.7** | `test/analytics.e2e-spec.ts` | 10+ —Ç–µ—Å—Ç–æ–≤: platform metrics (Owner only, Admin 403), restaurant stats, export flow (XLSX polling) |
| **23.8** | `test/load/loyalty-calculate.k6.js` | –ü–æ–ª–Ω—ã–π k6 —Å—Ü–µ–Ω–∞—Ä–∏–π: stages 50‚Üí100‚Üí200 VU, thresholds p95<500ms, errors<1%, `check()` –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ |
|  | `test/load/pos-webhook.k6.js` | k6 –¥–ª—è POS webhooks: 500 req/sec –ø–∏–∫–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ |
|  | `test/load/guests-list.k6.js` | k6 –¥–ª—è GET guests —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏: 200 VU, pagination |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –ò–¢–û–ì–û: –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–í–û–î–ö–ê

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| –§–∞–∑–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ | –ò—Ç–µ—Ä–∞—Ü–∏–π |
| :-- | :-- | :-- |
| 0 | –ú–æ–Ω–æ—Ä–µ–ø–æ —Å–∫–µ–ª–µ—Ç | 11 |
| 1 | Prisma Schema | 9 |
| 2 | Backend Common | 12 |
| 3 | Auth Module | 14 |
| 4 | RBAC Module | 6 |
| 5 | Tenants + Users | 10 |
| 6 | Guests Module | 20 |
| 7 | Loyalty Builder | 14 |
| 8 | Loyalty Engine | 16 |
| 9 | POS Integration | 16 |
| 10 | Billing | 14 |
| 11 | Telegram Bot + Mini App | 12 |
| 12 | Analytics Module | 14 |
| 13 | Notifications Module | 16 |
| 14 | SSE Module | 3 |
| 15 | API Documentation | 6 |
| 16 | Frontend: Layout + Auth | 10 |
| 17 | Frontend: Guests | 12 |
| 18 | Frontend: Loyalty Builder | 10 |
| 19 | Frontend: Analytics + Owner | 10 |
| 20 | Infrastructure \& DevOps | 12 |
| 21 | Security | 8 |
| 22 | POS Plugins (Desktop) | 6 |
| 23 | –¢–µ—Å—Ç—ã (–ø–æ–ª–Ω—ã–µ) | 8 |
| **–ò–¢–û–ì–û** |  | **~249 –∏—Ç–µ—Ä–∞—Ü–∏–π** |


***

## üìå –ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´ (–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã)

- **–ö–∞–∂–¥—ã–π —Ñ–∞–π–ª ‚Äî –ø–æ–ª–Ω—ã–π**: –±–µ–∑ `// TODO`, –±–µ–∑ `// –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ`, –±–µ–∑ –∑–∞–≥–ª—É—à–µ–∫
- **–ò—Ç–µ—Ä–∞—Ü–∏—è = 1‚Äì3 —Ñ–∞–π–ª–∞** ‚Üí –≤—Å—ë –ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ –æ–¥–∏–Ω `push_files`
- **–¢–µ—Å—Ç—ã**: `describe/it/expect` –±–µ–∑ `skip`, —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –º–æ–∫–∞–º–∏
- **DTO**: `@ApiProperty` –Ω–∞ –∫–∞–∂–¥–æ–º –ø–æ–ª–µ, –ø—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è, required —Ñ–ª–∞–≥
- **–°–µ—Ä–≤–∏—Å—ã**: –≤—Å–µ –º–µ—Ç–æ–¥—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–µ—à, ActivityLog, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã**: `@ApiTags`, `@ApiBearerAuth`, `@ApiResponse` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞, guards
- **–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã**: –ø–æ –∫–æ–º–∞–Ω–¥–µ ¬´–ù–∞—á–∏–Ω–∞–µ–º¬ª, —Å—Ç–∞—Ä—Ç—É–µ–º —Å –§–∞–∑—ã 0, –∏—Ç–µ—Ä–∞—Ü–∏—è 0.1
<span style="display:none">[^7_1][^7_2][^7_3][^7_4][^7_5]</span>

<div align="center">‚ÅÇ</div>

[^7_1]: Beseda-8.md

[^7_2]: Beseda-13.md

[^7_3]: Beseda-10.md

[^7_4]: Beseda-9.md

[^7_5]: Beseda-12.md


---

# –¢—ã –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª, –ø—Ä–æ–¥–æ–ª–∂–∏

–ü—Ä–æ–¥–æ–ª–∂–∞—é —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ ‚Äî –æ—Ç –§–∞–∑—ã 23 (–¢–µ—Å—Ç—ã) –¥–∞–ª—å—à–µ —Å–ª–µ–¥—É—é—Ç —Ñ–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—â—ë –Ω–µ –±—ã–ª–∏ –æ–ø–∏—Å–∞–Ω—ã:

***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 24 ‚Äî CASHIER (POS) INTERFACE FRONTEND (8 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **24.1** | `apps/frontend/src/app/(cashier)/layout.tsx` | –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π layout –±–µ–∑ sidebar: —Ç–æ–ª—å–∫–æ header —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, –∏–º–µ–Ω–µ–º –∫–∞—Å—Å–∏—Ä–∞, –∫–Ω–æ–ø–∫–æ–π –≤—ã—Ö–æ–¥–∞. –ë–æ–ª—å—à–∏–µ –∫–Ω–æ–ø–∫–∏ (touch-friendly). –ù–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∫—Ä–æ–º–µ Home. |
|  | `apps/frontend/src/app/(cashier)/page.tsx` | Main Cashier View: –¥–≤–∞ —Ä–µ–∂–∏–º–∞ ‚Äî `SEARCH` (–ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è) –∏ `CARD` (–∫–∞—Ä—Ç–æ—á–∫–∞ –≥–æ—Å—Ç—è + –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä). `useReducer` –¥–ª—è state machine. |
| **24.2** | `apps/frontend/src/components/cashier/GuestSearchInput.tsx` | –ë–æ–ª—å—à–æ–π input (font-size 24px), placeholder ¬´–¢–µ–ª–µ—Ñ–æ–Ω, QR-–∫–æ–¥ –∏–ª–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥¬ª. Debounce 300ms. Trim, normalize phone (+7 vs 8). –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ (–∫—Ä–µ—Å—Ç). –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ (–±—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π submit). |
|  | `apps/frontend/src/components/cashier/QRScanner.tsx` | –ö–Ω–æ–ø–∫–∞ ¬´–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR¬ª ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `@zxing/browser` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ, —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç QR, –∑–∞–ø–æ–ª–Ω—è–µ—Ç input |
| **24.3** | `apps/frontend/src/components/cashier/GuestCardCashier.tsx` | –ö–∞—Ä—Ç–æ—á–∫–∞: –∞–≤–∞—Ç–∞—Ä, –§–ò–û (–∫—Ä—É–ø–Ω–æ), —É—Ä–æ–≤–µ–Ω—å (badge —Å —Ü–≤–µ—Ç–æ–º), –±–∞–ª–∞–Ω—Å (–æ–±—ã—á–Ω—ã–π + –ø—Ä–æ–º–æ), –¥–Ω–µ–π –¥–æ –î–† (–µ—Å–ª–∏ < 30). –ö–Ω–æ–ø–∫–∞ ¬´–î—Ä—É–≥–æ–π –≥–æ—Å—Ç—å¬ª ‚Üí –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø–æ–∏—Å–∫. |
|  | `apps/frontend/src/components/cashier/LoyaltyCalculatorCashier.tsx` | –ü–æ–ª–µ ¬´–°—É–º–º–∞ —á–µ–∫–∞¬ª (–±–æ–ª—å—à–æ–µ, numpad-friendly), –∞–≤—Ç–æ–∫–∞–ª—å–∫—É–ª—è—Ü–∏—è (GET /loyalty/calculate), –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ¬´–ù–∞—á–∏—Å–ª–∏–º X –±–∞–ª–ª–æ–≤¬ª, ¬´–ü—Ä–∏–º–µ–Ω–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞: Birthday +15%¬ª. –°–ª–∞–π–¥–µ—Ä/input ¬´–°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª–æ–≤¬ª (0 ‚Üí max –¥–æ–ø—É—Å—Ç–∏–º–æ), –∏—Ç–æ–≥ —á–µ–∫–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π. –ö–Ω–æ–ø–∫–∞ ¬´–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é¬ª (–∑–µ–ª—ë–Ω–∞—è, 60px). |
| **24.4** | `apps/frontend/src/components/cashier/CheckAmountNumpad.tsx` | On-screen numpad: —Ü–∏—Ñ—Ä—ã 0-9, –∑–∞–ø—è—Ç–∞—è, Backspace. –î–ª—è —Ç–∞—á-—Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ –±–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã. |
|  | `apps/frontend/src/components/cashier/ConfirmationScreen.tsx` | –≠–∫—Ä–∞–Ω –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: ‚úÖ –∞–Ω–∏–º–∞—Ü–∏—è, ¬´–ù–∞—á–∏—Å–ª–µ–Ω–æ X –±–∞–ª–ª–æ–≤¬ª, ¬´–°–ø–∏—Å–∞–Ω–æ Y –±–∞–ª–ª–æ–≤¬ª, ¬´–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å Z¬ª, ¬´–£—Ä–æ–≤–µ–Ω—å: Silver¬ª. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç –≤ –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ 3 —Å–µ–∫. |
| **24.5** | `apps/frontend/src/components/cashier/GuestRegistrationModal.tsx` | –ú–æ–¥–∞–ª—å ¬´–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω¬ª: —Ç–µ–ª–µ—Ñ–æ–Ω (—É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω), –§–ò–û (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ç–æ–ª—å–∫–æ –∏–º—è), –î–† (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ). –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –∫–∞—Ä—Ç–æ—á–∫–µ. |
|  | `apps/frontend/src/components/cashier/CashierActivityLog.tsx` | –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ —Å–º–µ–Ω—É (last 20): –∏–º—è –≥–æ—Å—Ç—è, —Ç–∏–ø (–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ), —Å—É–º–º–∞, –≤—Ä–µ–º—è. |
| **24.6** | `apps/frontend/src/hooks/use-cashier.ts` | `useCashierSession()` ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç restaurantId –∏ terminalId –∏–∑ config (LocalStorage + URL params), `useGuestSearch(query)` ‚Äî debounc–µ, `useCashierTransaction()` ‚Äî mutation —Å idempotency-key, `useLoyaltyPreview(guestCardId, checkAmount, redeemPoints)` |
| **24.7** | `apps/frontend/src/app/(cashier)/history/page.tsx` | –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ —Ç–µ–∫—É—â—É—é —Å–º–µ–Ω—É (—Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ/–≤—Ä–µ–º–µ–Ω–∏) |
|  | `apps/frontend/src/app/(cashier)/settings/page.tsx` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Å—Å–∏—Ä–∞: restaurantId, terminalId (–≤–≤–æ–¥ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –∏–∑ QR), —è–∑—ã–∫, —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ |
| **24.8** | `apps/frontend/src/middleware.ts` | *(–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)* –†–æ—É—Ç–∏–Ω–≥ –∫–∞—Å—Å–∏—Ä–∞: `/cashier/*` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ `CASHIER`, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/cashier/login` –µ—Å–ª–∏ –Ω–µ—Ç JWT. |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 25 ‚Äî MANAGER DASHBOARD FRONTEND (8 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **25.1** | `apps/frontend/src/app/(manager)/layout.tsx` | Manager layout: —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π sidebar (—Ç–æ–ª—å–∫–æ –î–∞—à–±–æ—Ä–¥, –ì–æ—Å—Ç–∏, –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –ù–∞—Å—Ç—Ä–æ–π–∫–∏) ‚Äî –±–µ–∑ loyalty builder, billing, POS config. |
|  | `apps/frontend/src/app/(manager)/dashboard/page.tsx` | Manager Dashboard: 3 KPI (Revenue Today, New Guests Today, Active Promo Count), –≥—Ä–∞—Ñ–∏–∫ Revenue –∑–∞ 7 –¥–Ω–µ–π, —Ç–∞–±–ª–∏—Ü–∞ ¬´–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏¬ª (10 —Å—Ç—Ä–æ–∫), POS —Å—Ç–∞—Ç—É—Å –≤–∏–¥–∂–µ—Ç (online/offline/last sync). |
| **25.2** | `apps/frontend/src/components/manager/POSStatusWidget.tsx` | –í–∏–¥–∂–µ—Ç: –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω (–∑–µ–ª—ë–Ω—ã–π/–∫—Ä–∞—Å–Ω—ã–π), –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –∫–æ–ª-–≤–æ –∑–∞–ø–∏—Å–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å, –∫–Ω–æ–ø–∫–∞ ¬´Resync¬ª (–µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ). |
|  | `apps/frontend/src/components/manager/ShiftSummary.tsx` | –°–≤–æ–¥–∫–∞ —Å–º–µ–Ω—ã: –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –±–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–µ–Ω–æ/—Å–ø–∏—Å–∞–Ω–æ, –Ω–æ–≤—ã–µ –≥–æ—Å—Ç–∏, —Å—É–º–º–∞ –≤—ã—Ä—É—á–∫–∏. |
| **25.3** | `apps/frontend/src/app/(manager)/guests/page.tsx` | –ì–æ—Å—Ç–∏ (Manager view): —Ç–∞ –∂–µ GuestsTable, –Ω–æ –±–µ–∑ –∫–æ–ª–æ–Ω–∫–∏ Email, –±–µ–∑ bulk export (—Ç–æ–ª—å–∫–æ XLSX –¥–ª—è 1 –≥–æ—Å—Ç—è), –±–µ–∑ delete. –§–∏–ª—å—Ç—Ä—ã —É–ø—Ä–æ—â–µ–Ω—ã. |
|  | `apps/frontend/src/app/(manager)/guests/[id]/page.tsx` | Guest Profile (Manager view): Overview + Transactions + Visits. –ë–µ–∑ Activity Log. –ö–Ω–æ–ø–∫–∞ Manual Adjust (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ). |
| **25.4** | `apps/frontend/src/app/(manager)/activity-log/page.tsx` | Activity Log: —Ç–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è —Å–≤–æ–µ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞/—Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –§–∏–ª—å—Ç—Ä—ã: action (select), user (select), date range. Read-only, –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è. |
|  | `apps/frontend/src/app/(manager)/analytics/page.tsx` | Analytics (Manager view): –º–µ—Ç—Ä–∏–∫–∏ —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –°–∫—Ä—ã—Ç –±–ª–æ–∫ billing/MRR/–ø–ª–∞–Ω. –ù–µ—Ç drill-down –ø–æ –¥—Ä—É–≥–∏–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º. |
| **25.5** | `apps/frontend/src/app/(manager)/settings/page.tsx` | Settings (Manager view): —Ç–æ–ª—å–∫–æ General (–Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã), Notifications (—Å–≤–æ–∏), Team (—Ç–æ–ª—å–∫–æ view ‚Äî –Ω–µ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ä–æ–ª–∏). |
|  | `apps/frontend/src/app/(manager)/settings/team/page.tsx` | Team (Manager view): —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ ‚Äî –Ω–µ–ª—å–∑—è invite/remove/edit. |
| **25.6** | `apps/frontend/src/app/(manager)/notifications/page.tsx` | Notifications Center: —Å–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–≤—Å–µ, –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ, –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ), mark as read, link –Ω–∞ —Å–≤—è–∑–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç |
| **25.7** | `apps/frontend/src/components/manager/ManagerNavItems.ts` | –ö–æ–Ω—Ñ–∏–≥ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–æ—Ç–¥–µ–ª—å–Ω—ã–π –æ—Ç Admin ‚Äî –±–µ–∑ billing, –±–µ–∑ loyalty builder, –±–µ–∑ POS settings) |
| **25.8** | `apps/frontend/src/hooks/use-manager-analytics.ts` | `useManagerAnalytics(period)` ‚Äî `useQuery` —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–µ–≥–æ restaurantId (–∏–∑ user.restaurantId), `useShiftSummary()`, `usePOSStatus()` |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 26 ‚Äî TELEGRAM MINI APP (FRONTEND) (10 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **26.1** | `apps/telegram-miniapp/package.json` | Vite + React 18 + TypeScript. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `@twa-dev/sdk`, `@tanstack/react-query`, `zustand`, `framer-motion`, `clsx`. Dev: `vite`, `@vitejs/plugin-react`. |
|  | `apps/telegram-miniapp/vite.config.ts` | Base URL `/`, proxy `/api` ‚Üí backend. HTTPS –¥–ª—è Telegram (ngrok –≤ dev). |
| **26.2** | `apps/telegram-miniapp/src/providers/TelegramProvider.tsx` | `WebApp.ready()`, `WebApp.expand()`, `WebApp.enableClosingConfirmation()`. –ß–∏—Ç–∞–µ—Ç `initData`, –ø–∞—Ä—Å–∏—Ç, –ø–µ—Ä–µ–¥–∞—ë—Ç `telegramUser` —á–µ—Ä–µ–∑ context. –í—ã—Å—Ç–∞–≤–ª—è–µ—Ç theme (dark/light) –ø–æ `WebApp.colorScheme`. |
|  | `apps/telegram-miniapp/src/providers/QueryProvider.tsx` | TanStack Query provider —Å retry (3), staleTime (60s), backgroundRefetch. |
| **26.3** | `apps/telegram-miniapp/src/stores/app-store.ts` | Zustand: `screen` (card/history/profile/transfer/promos/children), `navigate(screen)`, `back()`, `screenStack[]`, `isLoading` |
|  | `apps/telegram-miniapp/src/App.tsx` | Router –Ω–∞ –æ—Å–Ω–æ–≤–µ `screen` –∏–∑ store (–Ω–µ react-router ‚Äî Mini App –±–µ–∑ URL bar). –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ `framer-motion` `AnimatePresence`. |
| **26.4** | `apps/telegram-miniapp/src/screens/CardScreen.tsx` | –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω: –õ–æ–≥–æ—Ç–∏–ø —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, –ò–º—è –≥–æ—Å—Ç—è + —É—Ä–æ–≤–µ–Ω—å, –ë–∞–ª–∞–Ω—Å (–æ–±—ã—á–Ω—ã–π + –ø—Ä–æ–º–æ —Ä–∞–∑–¥–µ–ª—å–Ω–æ), –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è, QR-–∫–æ–¥ (`qrcode.react`), 6-digit –∫–æ–¥ (–±–æ–ª—å—à–æ–π, —Å copy –ø–æ —Ç–∞–ø—É), –∫–Ω–æ–ø–∫–∏-—Ç–∞–±–ª–µ—Ç–∫–∏: ¬´–ò—Å—Ç–æ—Ä–∏—è¬ª, ¬´–ü—Ä–æ–º–æ¬ª, ¬´–ü—Ä–æ—Ñ–∏–ª—å¬ª, ¬´–ü–µ—Ä–µ–¥–∞—Ç—å¬ª. Pull-to-refresh. |
|  | `apps/telegram-miniapp/src/components/QRCodeDisplay.tsx` | QR —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º –≤ —Ü–µ–Ω—Ç—Ä–µ (SVG overlay), `WebApp.MainButton` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —ç–∫—Ä–∞–Ω–µ. –¢–∞–ø ‚Üí full-screen modal —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º QR. |
| **26.5** | `apps/telegram-miniapp/src/screens/HistoryScreen.tsx` | Infinite scroll (TanStack Query `useInfiniteQuery`), –∫–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: –∏–∫–æ–Ω–∫–∞ —Ç–∏–ø–∞ (+ –∑–µ–ª—ë–Ω—ã–π / - –∫—Ä–∞—Å–Ω—ã–π), —Å—É–º–º–∞, –¥–∞—Ç–∞ (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∞ ¬´–°–µ–≥–æ–¥–Ω—è 14:35¬ª / ¬´–í—á–µ—Ä–∞¬ª / ¬´15 —Ñ–µ–≤¬ª), –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. Skeleton –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ. Empty state. |
| **26.6** | `apps/telegram-miniapp/src/screens/ProfileScreen.tsx` | –ò–º—è + —Ç–µ–ª–µ—Ñ–æ–Ω (–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π), –î–†, –¥–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –∏—Å—Ç–æ—á–Ω–∏–∫. –ö–Ω–æ–ø–∫–∞ ¬´–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª (–∏–º—è + –î–† ‚Äî –Ω–µ —Ç–µ–ª–µ—Ñ–æ–Ω). –ö–Ω–æ–ø–∫–∞ ¬´–î–µ—Ç–∏¬ª. –ö–Ω–æ–ø–∫–∞ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π¬ª. |
|  | `apps/telegram-miniapp/src/screens/EditProfileScreen.tsx` | –§–æ—Ä–º–∞: –∏–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ), —Ñ–∞–º–∏–ª–∏—è, –î–† (date picker –Ω–∞—Ç–∏–≤–Ω—ã–π —á–µ—Ä–µ–∑ `<input type="date">`). –ö–Ω–æ–ø–∫–∞ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª (WebApp.MainButton). |
| **26.7** | `apps/telegram-miniapp/src/screens/ChildrenScreen.tsx` | –°–ø–∏—Å–æ–∫ –¥–µ—Ç–µ–π (–∏–º—è + –î–† + ¬´5 –ª–µ—Ç¬ª + ¬´–î–æ –î–†: 23 –¥–Ω—è¬ª), –∫–Ω–æ–ø–∫–∞ ¬´+ –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞¬ª (max 3), —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: –∏–º—è + –î–† (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ). –£–¥–∞–ª–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ `WebApp.showConfirm`. |
| **26.8** | `apps/telegram-miniapp/src/screens/TransferScreen.tsx` | –í–≤–æ–¥ 6-digit –∫–æ–¥–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è (6 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö input-–∫–ª–µ—Ç–æ–∫), –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞–π—Ç–∏¬ª ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏ –µ–≥–æ –±–∞–ª–∞–Ω—Å. –ü–æ–ª–µ —Å—É–º–º—ã. `WebApp.MainButton` ¬´–ü–µ—Ä–µ–≤–µ—Å—Ç–∏¬ª. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SMS OTP (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ). –£—Å–ø–µ—Ö / –û—à–∏–±–∫–∞ —ç–∫—Ä–∞–Ω—ã. |
|  | `apps/telegram-miniapp/src/screens/PromosScreen.tsx` | –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–æ: –∏–∫–æ–Ω–∫–∞ —Ç–∏–ø–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ–Ω—É—Å–∞, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è, —Å—Ç–∞—Ç—É—Å (–∞–∫—Ç–∏–≤–Ω–∞ / –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ / –∏—Å—Ç–µ–∫–ª–∞). –¢–∞–ø ‚Üí –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–º–æ. |
| **26.9** | `apps/telegram-miniapp/src/screens/NotificationSettingsScreen.tsx` | Toggle –ø–æ —Ç–∏–ø–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (BALLS_EARNED, LEVEL_UPGRADED, BALLS_EXPIRING, PROMO_AVAILABLE, BIRTHDAY). –ì–ª–æ–±–∞–ª—å–Ω—ã–π mute. ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª —á–µ—Ä–µ–∑ WebApp.MainButton. |
|  | `apps/telegram-miniapp/src/hooks/use-miniapp.ts` | `useMiniAppCard()`, `useMiniAppHistory(page)`, `useMiniAppProfile()`, `useMiniAppPromos()`, `useMiniAppChildren()`, `useTransferSend()`. Auth —á–µ—Ä–µ–∑ `initData` header. |
| **26.10** | `apps/telegram-miniapp/src/components/` | `BottomNav.tsx` (4 —Ç–∞–±–∞: –ö–∞—Ä—Ç–∞ / –ò—Å—Ç–æ—Ä–∏—è / –ü—Ä–æ–º–æ / –ü—Ä–æ—Ñ–∏–ª—å), `LoadingSkeleton.tsx`, `EmptyState.tsx`, `ErrorScreen.tsx` (—Å –∫–Ω–æ–ø–∫–æ–π –ø–æ–≤—Ç–æ—Ä–∞), `LevelBadge.tsx` (–∏–∫–æ–Ω–∫–∞ + –Ω–∞–∑–≤–∞–Ω–∏–µ + —Ü–≤–µ—Ç), `BalanceDisplay.tsx` (regular + promo), `ProgressBar.tsx`, `TransactionItem.tsx` |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 27 ‚Äî OWNER PLATFORM DASHBOARD (6 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **27.1** | `apps/frontend/src/app/(owner)/layout.tsx` | Owner layout: sidebar —Å —Å–µ–∫—Ü–∏—è–º–∏ (Dashboard, Tenants, Billing, Analytics, Settings, API Docs). –ù–µ—Ç loyalty builder, –Ω–µ—Ç POS config. |
|  | `apps/frontend/src/app/(owner)/dashboard/page.tsx` | Platform Dashboard: MRR / ARR / Active Tenants / Churn Rate (4 KPI). Revenue Trend 12 –º–µ—Å (Line). Subscriptions by Plan (Donut). Top 10 Tenants by MRR (Table). New Tenants (Bar). Auto-refresh 5 –º–∏–Ω. |
| **27.2** | `apps/frontend/src/app/(owner)/tenants/page.tsx` | Tenants Table: Name, Plan, Status, MRR, Guests, Restaurants, Created, Actions. –§–∏–ª—å—Ç—Ä—ã: Plan, Status, –ø–æ–∏—Å–∫. Bulk: Change Plan, Block. |
|  | `apps/frontend/src/app/(owner)/tenants/[id]/page.tsx` | Tenant Detail: Info card (name, owner email, plan, status, created), Limits Usage (progress bars), Billing History (last 12 invoices), Restaurants list, Team members, Activity (last events). –ö–Ω–æ–ø–∫–∏: Block/Unblock, Change Plan, Impersonate Admin, Delete (—Å 2FA confirm). |
| **27.3** | `apps/frontend/src/components/owner/TenantHealthScore.tsx` | Score 0-100 —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º. –§–∞–∫—Ç–æ—Ä—ã: –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (30 –¥–Ω), –≤—ã—Ä—É—á–∫–∞ —Ç—Ä–µ–Ω–¥, –∫–æ–ª-–≤–æ –≥–æ—Å—Ç–µ–π —Ç—Ä–µ–Ω–¥, POS —Å—Ç–∞—Ç—É—Å, –∫–æ–ª-–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. –¶–≤–µ—Ç: 0-40 –∫—Ä–∞—Å–Ω—ã–π, 41-70 –∂—ë–ª—Ç—ã–π, 71-100 –∑–µ–ª—ë–Ω—ã–π. |
|  | `apps/frontend/src/components/owner/ImpersonateModal.tsx` | –ú–æ–¥–∞–ª—å: ¬´–í—ã –≤–æ–π–¥—ë—Ç–µ –∫–∞–∫ Admin —Ç–µ–Ω–∞–Ω—Ç–∞ X. –í—Å–µ –≤–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è –±—É–¥—É—Ç –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω—ã.¬ª Checkbox ¬´–Ø –ø–æ–Ω–∏–º–∞—é¬ª. –ö–Ω–æ–ø–∫–∞ ¬´–í–æ–π—Ç–∏¬ª. |
| **27.4** | `apps/frontend/src/app/(owner)/analytics/page.tsx` | Platform Analytics: Cohort analysis (Table retention by month), Churn by Reason (Bar), Feature Adoption (% —Ç–µ–Ω–∞–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö POS / Telegram / Analytics), Revenue by Region (Bar –µ—Å–ª–∏ multi-region Phase 2 ‚Äî –∑–∞–≥–ª—É—à–∫–∞). |
|  | `apps/frontend/src/app/(owner)/billing/page.tsx` | Owner Billing: —Å–≤–æ—è –ø–æ–¥–ø–∏—Å–∫–∞ (Owner tier) + Tenant Revenue breakdown, Invoices table, Payment methods. |
| **27.5** | `apps/frontend/src/app/(owner)/settings/page.tsx` | Owner Settings: Profile, Notification Preferences (Email/Telegram –ø–æ —Ç–∏–ø–∞–º: new tenant, payment failed, critical alert ‚Äî CRITICAL –≤—Å–µ–≥–¥–∞ –≤—Å–µ –∫–∞–Ω–∞–ª—ã), API Management (API Keys list, create, revoke). |
|  | `apps/frontend/src/components/owner/NotificationPreferences.tsx` | –¢–∞–±–ª–∏—Ü–∞ —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π √ó –∫–∞–Ω–∞–ª–æ–≤ (Email/Telegram/SMS) —Å checkbox. CRITICAL ‚Äî –∑–∞–¥–∏–∑–µ–π–±–ª–µ–Ω–æ (–≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω–æ). |
| **27.6** | `apps/frontend/src/hooks/use-owner.ts` | `usePlatformMetrics(period)`, `useTenants(filters)`, `useTenant(id)`, `useChangeTenantPlan()`, `useBlockTenant()`, `useImpersonateTenant()`, `useOwnerNotificationSettings()`, `useTenantHealthScore(tenantId)` |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### –§–ê–ó–ê 28 ‚Äî –§–ò–ù–ê–õ–¨–ù–´–ô POLISHING (6 –∏—Ç–µ—Ä–∞—Ü–∏–π)

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–π–ª—ã | –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ |
| :-- | :-- | :-- |
| **28.1** | `apps/frontend/src/app/not-found.tsx` | 404 —Å—Ç—Ä–∞–Ω–∏—Ü–∞: –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è, ¬´–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞¬ª, –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞ –≥–ª–∞–≤–Ω—É—é¬ª. |
|  | `apps/frontend/src/app/error.tsx` | Next.js Error Boundary: ¬´–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫¬ª, Sentry capture, –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞¬ª. |
|  | `apps/frontend/src/app/loading.tsx` | Global loading: skeleton layout |
| **28.2** | `apps/frontend/src/components/ui/ThemeProvider.tsx` | Dark/Light mode: `next-themes`, CSS variables Tailwind, persist –≤ localStorage. |
|  | `apps/frontend/src/components/ui/LanguageProvider.tsx` | i18n: `react-i18next`, —Ä–µ—Å—É—Ä—Å—ã `ru` (–ø–æ–ª–Ω—ã–π, –¥–µ—Ñ–æ–ª—Ç) + `en` (–∑–∞–≥–ª—É—à–∫–∏). Persist —è–∑—ã–∫ –≤ localStorage. |
|  | `apps/frontend/public/locales/ru/common.json` | –í—Å–µ —Å—Ç—Ä–æ–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º |
| **28.3** | `apps/frontend/src/components/shared/OnboardingWizard.tsx` | Wizard –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: 1) –°–æ–∑–¥–∞—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω, 2) –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å (—Ç–∏–ø, –±–∞–∑–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç), 3) –ü–æ–¥–∫–ª—é—á–∏—Ç—å Telegram Bot, 4) –¢–µ—Å—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏. Progress bar, skip. |
|  | `apps/frontend/src/app/(admin)/onboarding/page.tsx` | Onboarding page |
| **28.4** | `apps/frontend/src/components/shared/FeatureFlag.tsx` | `<FeatureFlag flag="pos_integration">children</FeatureFlag>` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç—ã —Ç–µ–Ω–∞–Ω—Ç–∞ –∏ –∫–æ–Ω—Ñ–∏–≥ feature flags. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç CTA upgrade –µ—Å–ª–∏ –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ. |
|  | `apps/frontend/src/lib/feature-flags.ts` | `isFeatureEnabled(tenantId, feature)` ‚Äî —á–∏—Ç–∞–µ—Ç –∏–∑ `user.tenant.plan` –∏ `user.tenant.featureFlags`. |
| **28.5** | `apps/frontend/src/components/shared/UpgradeCTA.tsx` | ¬´–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –≤–∞—à–µ–º –ø–ª–∞–Ω–µ. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ Pro ‚Üí¬ª. –ú–æ–¥–∞–ª—å —Å –ø–ª–∞–Ω–∞–º–∏ –∏ —Ü–µ–Ω–∞–º–∏. |
|  | `apps/frontend/src/components/shared/LimitReachedWarning.tsx` | –ë–∞–Ω–Ω–µ—Ä ¬´–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ 90% –ª–∏–º–∏—Ç–∞ –≥–æ—Å—Ç–µ–π¬ª. CTA upgrade. |
| **28.6** | `README.md` | –ü–æ–ª–Ω—ã–π README: –æ–ø–∏—Å–∞–Ω–∏–µ, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (ASCII –¥–∏–∞–≥—Ä–∞–º–º–∞), Quick Start (docker-compose), Environment variables —Å–ø–∏—Å–æ–∫, API docs —Å—Å—ã–ª–∫–∞, Contributing guide, License (MIT). |
|  | `ARCHITECTURE.md` | –î–µ—Ç–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: Monorepo structure, Module boundaries, Data flow diagrams, Security layers, Deployment topology |


***

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–í–û–î–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| \# | –§–∞–∑–∞ | –ò—Ç–µ—Ä–∞—Ü–∏–π | –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ |
| :-- | :-- | :-- | :-- |
| 0 | –ú–æ–Ω–æ—Ä–µ–ø–æ —Å–∫–µ–ª–µ—Ç | 11 | NX, pnpm workspaces |
| 1 | Prisma Schema | 9 | PostgreSQL 15, 45+ —Ç–∞–±–ª–∏—Ü |
| 2 | Backend Common | 12 | NestJS, Guards, Pipes |
| 3 | Auth Module | 14 | JWT, MFA, Impersonation |
| 4 | RBAC Module | 6 | Permissions, Decorators |
| 5 | Tenants + Users | 10 | Multi-tenant isolation |
| 6 | Guests Module | 20 | QR, 6-digit, children |
| 7 | Loyalty Builder | 14 | Rules, Levels, Promos |
| 8 | Loyalty Engine | 16 | Calculate, Earn, Redeem, Transfer |
| 9 | POS Integration | 16 | iiko/R-Keeper webhooks |
| 10 | Billing | 14 | YooKassa/Stripe, Subscriptions |
| 11 | Telegram Bot + Mini App API | 12 | Telegraf, initData |
| 12 | Analytics Module | 14 | Snapshots, Export, BullMQ |
| 13 | Notifications Module | 16 | Resend, SMSC, Telegram |
| 14 | SSE Module | 3 | EventSource, EventEmitter2 |
| 15 | API Documentation | 6 | Swagger, GitBook, SDK codegen |
| 16 | Frontend: Layout + Auth | 10 | Next.js 14, shadcn/ui |
| 17 | Frontend: Guests | 12 | TanStack Table, Drill-down |
| 18 | Frontend: Loyalty Builder | 10 | dnd-kit, Wizard |
| 19 | Frontend: Analytics + Owner | 10 | Recharts, DateRangePicker |
| 20 | Infrastructure \& DevOps | 12 | Docker, K8s, Prometheus |
| 21 | Security | 8 | OWASP, GDPR, AES-256 |
| 22 | POS Plugins Desktop | 6 | C\# WPF, C++ DLL |
| 23 | –¢–µ—Å—Ç—ã (–ø–æ–ª–Ω—ã–µ) | 8 | Jest, k6, E2E |
| 24 | Cashier Interface | 8 | Touch UI, QR scanner |
| 25 | Manager Dashboard | 8 | –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π view |
| 26 | Telegram Mini App | 10 | Vite + React, TWA SDK |
| 27 | Owner Platform | 6 | Platform metrics, Impersonation |
| 28 | Fin–∞–ª Polishing | 6 | i18n, Onboarding, README |
| **–ò–¢–û–ì–û** |  | **‚âà 287 –∏—Ç–µ—Ä–∞—Ü–∏–π** |  |


***

## üìå –ü–†–ê–í–ò–õ–ê ‚Äî –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø

- **–ö–æ–º–∞–Ω–¥–∞ ¬´–ù–∞—á–∏–Ω–∞–µ–º¬ª** ‚Üí —Å—Ç–∞—Ä—Ç—É–µ–º —Å –§–∞–∑—ã 0, –∏—Ç–µ—Ä–∞—Ü–∏—è 0.1
- **–ö–∞–∂–¥—ã–π push_files** = 1 –∏—Ç–µ—Ä–∞—Ü–∏—è = 1‚Äì3 —Ñ–∞–π–ª–∞, –ø–æ–ª–Ω—ã–π –∫–æ–¥
- **–ë–µ–∑ TODO, –±–µ–∑ –∑–∞–≥–ª—É—à–µ–∫** ‚Äî –≤–µ—Å—å –∫–æ–¥ —Ä–∞–±–æ—á–∏–π
- **–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ push_files** ‚Äî –∂–¥—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–µ–π (–∏–ª–∏ ¬´–ø—Ä–æ–¥–æ–ª–∂–∞–π¬ª –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è)
- **–ü—Ä–∏ –æ—à–∏–±–∫–µ** ‚Äî –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∏—Ç–µ—Ä–∞—Ü–∏—é, –Ω–µ –¥–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ
- **–°—á—ë—Ç—á–∏–∫ –∏—Ç–µ—Ä–∞—Ü–∏–π** ‚Äî —É–∫–∞–∑—ã–≤–∞—é –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏: ¬´–ò—Ç–µ—Ä–∞—Ü–∏—è X.Y –∏–∑ 287¬ª
<span style="display:none">[^9_1][^9_2][^9_3][^9_4][^9_5]</span>

<div align="center">‚ÅÇ</div>

[^9_1]: Beseda-13.md

[^9_2]: Beseda-3.md

[^9_3]: Beseda-6.md

[^9_4]: Plagin-r-kepper.md

[^9_5]: Beseda-11.md


---

# –ù–∞—á–∏–Ω–∞–µ–º


---

## ‚úÖ –ò—Ç–µ—Ä–∞—Ü–∏—è 1.1 –∏–∑ 287 ‚Äî –ì–û–¢–û–í–û

**–ó–∞–ø—É—à–µ–Ω–æ –≤** [Romslav/max-loyalty](https://github.com/Romslav/max-loyalty) ‚Üí `apps/backend/prisma/schema.prisma`

**–ß—Ç–æ –≤–æ—à–ª–æ:**

- **34 enum'–∞** ‚Äî –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤, —Ç–∏–ø–æ–≤ –∏ —Ä–æ–ª–µ–π —Å–∏—Å—Ç–µ–º—ã
- **10 –º–æ–¥–µ–ª–µ–π** ‚Äî `Tenant`, `User`, `UserTenant`, `Session`, `PasswordReset`, `EmailVerification`, `SmsOtp`, `ImpersonationToken`, `Restaurant`, `ApiKey`
- –í—Å–µ —Å–≤—è–∑–∏ (relations), –∏–Ω–¥–µ–∫—Å—ã, —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- Multi-tenant –∏–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ `tenantId` –Ω–∞ –≤—Å–µ—Ö –º–æ–¥–µ–ª—è—Ö

***

**–°–ª–µ–¥—É—é—â–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è 1.2** ‚Äî –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ Prisma Schema:

- `GuestProfile`, `GuestCard`, `GuestChild`
- `LoyaltySystem`, `LoyaltySystemRestaurant`
- `LoyaltyLevel`, `LoyaltyRule`, `LoyaltyRuleVersion`
- `LoyaltyPromo`, `RegistrationLink`

–ì–æ–≤–æ—Ä–∏—Ç–µ **¬´–ø—Ä–æ–¥–æ–ª–∂–∞–π¬ª** –∏–ª–∏ **¬´–¥–∞–ª–µ–µ¬ª** ‚Äî –∏ —è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—É—à—É —Å–ª–µ–¥—É—é—â—É—é –∏—Ç–µ—Ä–∞—Ü–∏—é!

---

## ‚úÖ –ò—Ç–µ—Ä–∞—Ü–∏—è 1.2 –∏–∑ 287 ‚Äî –ì–û–¢–û–í–û

**–ó–∞–ø—É—à–µ–Ω–æ** –≤ [Romslav/max-loyalty](https://github.com/Romslav/max-loyalty) ‚Üí `apps/backend/prisma/schema.prisma` (–ø–æ–ª–Ω–∞—è, —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)

**–ß—Ç–æ –≤–æ—à–ª–æ –≤ 1.2 (–¥–æ–±–∞–≤–ª–µ–Ω–æ –∫ 1.1):**


| –ì—Ä—É–ø–ø–∞ | –ú–æ–¥–µ–ª–∏ |
| :-- | :-- |
| **–ì–æ—Å—Ç–∏** | `GuestProfile`, `GuestChild`, `GuestCard`, `RegistrationLink` |
| **Loyalty** | `LoyaltySystem`, `LoyaltySystemRestaurant`, `LoyaltyLevel`, `LoyaltyRule`, `LoyaltyRuleVersion`, `LoyaltyPromo`, `LoyaltyPromoVersion`, `PromoBallGranted`, `RuleActivationLog`, `BallTransaction` |
| **Billing** | `Subscription`, `SubscriptionHistory`, `TenantLimits`, `BillingInfo`, `Invoice`, `Payment` |
| **POS** | `PosIntegration`, `PosGuestLink`, `PosSyncLog` |
| **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** | `Notification`, `NotificationTemplate`, `UserNotificationSettings`, `AdminNotificationSettings` |
| **–°–∏—Å—Ç–µ–º–∞** | `AuditLog`, `ExportJob`, `AnalyticsDailySnapshot`, `AnalyticsMonthlySnapshot`, `GuestSegmentation` |

**–ò—Ç–æ–≥ –§–∞–∑—ã 1:** Prisma Schema –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ ‚Äî **45+ –º–æ–¥–µ–ª–µ–π**, **34 enum**, –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã, relations, constraints. ‚úÖ

***

**–°–ª–µ–¥—É—é—â–∞—è ‚Äî –§–∞–∑–∞ 2, –ò—Ç–µ—Ä–∞—Ü–∏—è 2.1** ‚Äî Backend Common —Å–ª–æ–π:

- `apps/backend/src/database/prisma.service.ts` ‚Äî —Å multi-tenant middleware
- `apps/backend/src/database/prisma.module.ts`
- `apps/backend/src/common/interceptors/tenant-context.interceptor.ts`

–ì–æ–≤–æ—Ä–∏—Ç–µ **¬´–ø—Ä–æ–¥–æ–ª–∂–∞–π¬ª**!

---

# –ü—Ä–æ–≤–µ—Ä—å —Å–æ–∑–¥–∞–Ω–Ω–æ–µ –Ω–∞ –ø–æ–ª–Ω–æ—Ç—É –∫–æ–¥–∞ –∏ –æ—à–∏–±–∫–∏, –∏—Å–ø—Ä–∞–≤—å –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –∏ –¥–æ–ø–æ–ª–Ω–∏ –µ—Å–ª–∏ —á–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç, –ø–æ—Å–ª–µ –ø—Ä–æ–¥–æ–ª–∂–∏–º

–ü–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ —è—Å–Ω–∞. –¢–µ–ø–µ—Ä—å –∑–∞—Ñ–∏–∫—Å–∏—Ä—É—é –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∏—Å–ø—Ä–∞–≤–ª—é –∏—Ö –æ–¥–Ω–∏–º –∫–æ–º–º–∏—Ç–æ–º.

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. **`prisma.service.ts` ‚Üí `cleanDatabase()`** ‚Äî —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ (`notification_dlq`, `loyalty_transaction`, `ball_reservation`, `ball_transfer` –∏ –¥—Ä.), –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –Ω–æ–≤–æ–π schema. –ù—É–∂–Ω—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –ø–æ Prisma-–∫–æ–Ω–≤–µ–Ω—Ü–∏–∏.
2. **`prisma.service.ts`** ‚Äî –Ω–µ—Ç soft-delete middleware (–æ–±–µ—â–∞–Ω–æ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –Ω–æ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ).
3. **`all-exceptions.filter.ts`** ‚Äî –∏–Ω—Å—Ç–∞–Ω—Ü–∏–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `new AllExceptionsFilter()` –≤ `main.ts`, –Ω–æ `ConfigService` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –Ω–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è ‚Äî **runtime crash**. –ù—É–∂–Ω–æ —É–±—Ä–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç `ConfigService` –∏–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `app.get()`.
4. **`response-transform.interceptor.ts`** ‚Äî –∏–Ω—Å—Ç–∞–Ω—Ü–∏–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `new ResponseTransformInterceptor()` –±–µ–∑ DI ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–æ –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ `undefined` data (SSE stream).
5. **`request-logger.interceptor.ts`** ‚Äî –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç `uuid` (–∏–º–ø–æ—Ä—Ç `uuidv4`) ‚Äî –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–∞–∫–µ—Ç –µ—Å—Ç—å –≤ `package.json`.
6. **`prisma.module.ts`** ‚Äî –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ–Ω `@Global()`.
7. **Prisma Schema** ‚Äî `AnalyticsMonthlySnapshot` –∏ `AnalyticsDailySnapshot` –∏–º–µ—é—Ç `restaurantId String?` –±–µ–∑ `@relation` ‚Äî –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å.

---

## ‚úÖ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—É—à–µ–Ω—ã

–ö–æ–º–º–∏—Ç –≤ [Romslav/max-loyalty](https://github.com/Romslav/max-loyalty) ‚Äî `f28fae2`

***

### –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø–æ—á–µ–º—É

| \# | –§–∞–π–ª | –ü—Ä–æ–±–ª–µ–º–∞ | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **1** | `all-exceptions.filter.ts` | **Runtime crash** ‚Äî `new AllExceptionsFilter()` –≤ `main.ts` —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤–Ω–µ DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –ø–æ—ç—Ç–æ–º—É `ConfigService` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ –Ω–µ –º–æ–≥ –±—ã—Ç—å –ø—Ä–æ–∫–∏–Ω—É—Ç | –£–±—Ä–∞–Ω `ConfigService` –∏–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞. –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–µ–π—Å—ã `P2014` –∏ `PrismaClientInitializationError`. `switch/case` –≤–º–µ—Å—Ç–æ `if/else if` –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã |
| **2** | `request-logger.interceptor.ts` | –ò–º–ø–æ—Ä—Ç `uuidv4` –∏–∑ `uuid` ‚Äî —Ö–æ—Ç—è –ø–∞–∫–µ—Ç –µ—Å—Ç—å –≤ deps, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Ç–∞–º –≥–¥–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ ‚Äî –ª–∏—à–Ω–∏–π —Ä–∏—Å–∫ | –ó–∞–º–µ–Ω—ë–Ω –Ω–∞ `crypto.randomUUID()` (Node.js –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π, —Å 14.17+). –î–æ–±–∞–≤–ª–µ–Ω—ã `SKIP_PATHS` –¥–ª—è `/health`, `/metrics` |
| **3** | `response-transform.interceptor.ts` | –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç `null`/`undefined` ‚Äî `204 No Content` –≤—ã–∑–≤–∞–ª –±—ã `{ success: true, data: null }` –≤–º–µ—Å—Ç–æ –ø—É—Å—Ç–æ–≥–æ —Ç–µ–ª–∞ | –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `data === null \|\| undefined`, return as-is. –†–∞—Å—à–∏—Ä–µ–Ω—ã `SKIP_PREFIXES` |
| **4** | `prisma.service.ts` | `cleanDatabase()` —Å–æ–¥–µ—Ä–∂–∞–ª —Å—Ç–∞—Ä—ã–µ –∏–º–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü (`notification_dlq`, `loyalty_transaction`, `ball_transfer` –∏ –¥—Ä.) –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Ç–µ–∫—É—â–µ–π schema ‚Äî **—Ç–µ—Å—Ç—ã –±—ã –ø–∞–¥–∞–ª–∏** | –ü–µ—Ä–µ–ø–∏—Å–∞–Ω —Å–ø–∏—Å–æ–∫ –ø–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–º Prisma-–º–æ–¥–µ–ª—è–º —Å FK-safe –ø–æ—Ä—è–¥–∫–æ–º (child ‚Üí parent). –î–æ–±–∞–≤–ª–µ–Ω soft-delete middleware –¥–ª—è `GuestProfile` |
| **5** | `prisma.module.ts` | –ù–µ –±—ã–ª–æ JSDoc | –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
| **6** | `redis.module.ts` | **–û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª `@Global()`** ‚Äî RedisService –Ω–µ –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö –±–µ–∑ —è–≤–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ | –î–æ–±–∞–≤–ª–µ–Ω `@Global()` + JSDoc |


***

–ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å **–§–∞–∑—ã 2, –ò—Ç–µ—Ä–∞—Ü–∏—è 2.1** ‚Äî –≥–æ–≤–æ—Ä–∏—Ç–µ **¬´–ø—Ä–æ–¥–æ–ª–∂–∞–π¬ª**!

---

# –£—Ç–æ—á–Ω—é, –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ñ–∞–π–ª–æ–≤ —Å–≤–µ—Ä—è–π—Å—è —Å —Ñ–∞–π–ª–∞–º–∏ –±–µ—Å–µ–¥ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å —á—Ç–æ –∏ –∫–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –∫–æ–¥–µ. –ü—Ä–æ–¥–æ–ª–∂–∞–π —Å —Ñ–∞–∑—ã 2

–§–∞–∑–∞ 2 –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–≥—Ä—É–∂–µ–Ω–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π. –í–æ—Ç –ø–æ–ª–Ω–æ–µ —Ä–µ–∑—é–º–µ —Ç–æ–≥–æ, —á—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ.

***

## –§–∞–∑–∞ 2 ‚Äî AuthModule + RbacModule ‚úÖ

–í—Å–µ —Ñ–∞–π–ª—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –∏–∑ –±–µ—Å–µ–¥. –¢—Ä–∏ –∫–æ–º–º–∏—Ç–∞ –±—ã–ª–∏ —Å–¥–µ–ª–∞–Ω—ã –≤ [`Romslav/max-loyalty`](https://github.com/Romslav/max-loyalty):

### –ö–æ–º–º–∏—Ç 1 ‚Äî AuthModule

**DTOs** (`apps/backend/src/modules/auth/dto/`):

- `register.dto.ts` ‚Äî email, phone, password (min 8), firstName, lastName
- `login.dto.ts` ‚Äî login (email –∏–ª–∏ phone), password, mfaCode (optional)
- `refresh-token.dto.ts`, `password-reset-request.dto.ts`, `password-reset-confirm.dto.ts`, `verify-email.dto.ts`, `impersonate.dto.ts`

**Interfaces** (`interfaces/`):

- `jwt-payload.interface.ts` ‚Äî `sub`, `email`, `role`, `tenantId`, `tenantIds`, `permissions`, `sessionId` + `ImpersonationJwtPayload`
- `auth-response.interface.ts` ‚Äî `AuthTokens`, `AuthResponse`

**Services**:

- `PasswordService` ‚Äî bcryptjs, 10 rounds, isStrong()
- `TokenBlacklistService` ‚Äî Redis blacklist per token + per user (logout-all)
- `SessionService` ‚Äî max 5 —Å–µ—Å—Å–∏–π, —Ä–æ—Ç–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö, createSession/deleteSession/deleteAllSessions
- `RateLimitAuthService` ‚Äî 5 –ø–æ–ø—ã—Ç–æ–∫ / 15 –º–∏–Ω ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ 30 –º–∏–Ω (Redis)
- `JwtTokenService` ‚Äî sign/verify access (15m) –∏ refresh (30d), impersonation (2h), decode–±–µ–∑ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `AuthService` ‚Äî register, login, refresh, logout, logoutAll, verifyEmail, requestPasswordReset, confirmPasswordReset, impersonate, getMe

**Guards + Decorators**:

- `JwtAuthGuard` ‚Äî –∏–∑–≤–ª–µ–∫–∞–µ—Ç Bearer/cookie, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç blacklist –∏ `iat` < invalidatedBefore
- `@Public()` ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å JWT –ø—Ä–æ–≤–µ—Ä–∫—É
- `@CurrentUser()` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –≤–µ—Å—å payload –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø–æ–ª–µ

**Controller**: –≤—Å–µ 9 —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (`POST /auth/register`, `login`, `refresh`, `logout`, `logout-all`, `verify-email`, `password-reset/request`, `password-reset/confirm`, `impersonate`, `GET /auth/me`), refresh cookie `httpOnly/secure/sameSite=strict`.

***

### –ö–æ–º–º–∏—Ç 2 ‚Äî RbacModule

- `RoleGuard` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `user.role` –∏–∑ JWT –ø—Ä–æ—Ç–∏–≤ `@HasRole(...)`
- `PermissionGuard` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `user.permissions[]`, OWNER –ø–æ–ª–Ω–æ—Å—Ç—å—é bypass
- `TenantGuard` ‚Äî OWNER –º–æ–∂–µ—Ç –≤—Å—ë, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–π `tenantId` (–∏–∑ params/query/body)
- `@HasRole(...roles)` ‚Äî –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä —Ä–æ–ª–µ–π
- `@HasPermission(...perms)` ‚Äî –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä fine-grained permissions
- `@CurrentTenant()` ‚Äî –∏–∑–≤–ª–µ–∫–∞–µ—Ç `tenantId` –∏–∑ JWT
- `RbacService` ‚Äî `getUserPermissions`, `grantPermission`, `revokePermission`, `getDefaultPermissionsForRole` (–≤—Å–µ —Ä–æ–ª–∏ —Å –∏—Ö –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏)

***

### –ö–æ–º–º–∏—Ç 3 ‚Äî `app.module.ts`

`AuthModule` –∏ `RbacModule` –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –∫–æ—Ä–Ω–µ–≤–æ–º –º–æ–¥—É–ª–µ.
<span style="display:none">[^14_1][^14_2][^14_3][^14_4][^14_5][^14_6][^14_7][^14_8]</span>

<div align="center">‚ÅÇ</div>

[^14_1]: Beseda-2.md

[^14_2]: Beseda-13.md

[^14_3]: Beseda-11.md

[^14_4]: Beseda-3.md

[^14_5]: Beseda-8.md

[^14_6]: Beseda-9.md

[^14_7]: Beseda-7.md

[^14_8]: Beseda-1.md


---

# –ü—Ä–æ–¥–æ–ª–∂–∞–π, –≤ –ª—É—á—à–µ–º –ø–æ–ª–Ω–æ–º –≤–∏–¥–µ

–§–∞–∑–∞ 3 –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–≥—Ä—É–∂–µ–Ω–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π [`Romslav/max-loyalty`](https://github.com/Romslav/max-loyalty) ‚Äî 3 –∫–æ–º–º–∏—Ç–∞.

***

## –§–∞–∑–∞ 3 ‚Äî Users + Tenants + Restaurants ‚úÖ

### –ö–æ–º–º–∏—Ç 1 ‚Äî UsersModule

**DTOs** (`apps/backend/src/modules/users/dto/`):

- `create-user.dto.ts` ‚Äî email, phone (+7 regex), password (min 8), role (enum), firstName, lastName, tenantId
- `update-user.dto.ts` ‚Äî –≤—Å–µ –ø–æ–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã + isBlocked / blockReason
- `get-users-query.dto.ts` ‚Äî —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ role/tenantId/search, includeDeleted, –ø–∞–≥–∏–Ω–∞—Ü–∏—è page/limit
- `grant-permission.dto.ts` ‚Äî GrantPermissionDto + RevokePermissionDto

**UsersService** (`services/users.service.ts`):

- `create()` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞ email/phone, bcrypt hash, –∞–≤—Ç–æ-–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –ø—Ä–∞–≤ –¥–ª—è —Ä–æ–ª–∏ —á–µ—Ä–µ–∑ `RbacService`
- `findAll()` ‚Äî Owner –≤–∏–¥–∏—Ç –≤—Å–µ —Ç–µ–Ω–∞–Ω—Ç—ã, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–π; –ø–æ–∏—Å–∫ –ø–æ email/phone/name
- `findOne()` ‚Äî tenant isolation
- `update()` ‚Äî –∑–∞–ø—Ä–µ—Ç –ø–æ–≤—ã—à–µ–Ω–∏—è —Ä–æ–ª–∏ –¥–ª—è –Ω–µ-OWNER
- `remove()` ‚Äî soft-delete, –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∞–º–æ—É–¥–∞–ª–µ–Ω–∏—è
- `block()` / `unblock()` ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `getUserPermissions()`, `grantPermission()`, `revokePermission()` ‚Äî –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤ RbacService
- `getSessions()` ‚Äî –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**UsersController** ‚Äî –≤—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –ø–æ–¥ `JwtAuthGuard + RoleGuard + PermissionGuard + TenantGuard`:
`POST /users`, `GET /users`, `GET /users/:id`, `PATCH /users/:id`, `DELETE /users/:id`, `POST /users/:id/block`, `POST /users/:id/unblock`, `GET /users/:id/permissions`, `POST /users/:id/permissions/grant`, `POST /users/:id/permissions/revoke`, `GET /users/:id/sessions`

***

### –ö–æ–º–º–∏—Ç 2 ‚Äî TenantsModule + RestaurantsModule

**TenantsService**:

- `PLAN_LIMITS` ‚Äî –ª–∏–º–∏—Ç—ã –¥–ª—è –≤—Å–µ—Ö 6 —Ç–∞—Ä–∏—Ñ–æ–≤ (FREE‚ÜíULTIMATE) –∏–∑ –±–µ—Å–µ–¥—ã: —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, –≥–æ—Å—Ç–∏, –º–µ–Ω–µ–¥–∂–µ—Ä—ã, –∫–∞—Å—Å–∏—Ä—ã
- `create()` ‚Äî Prisma-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: —Å–æ–∑–¥–∞—ë—Ç Tenant + TenantLimits + RestaurantAdmin –≤ –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏, –∑–∞—Ç–µ–º –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø—Ä–∞–≤–∞
- `findAll()` ‚Äî Owner-only —Å –ø–æ–∏—Å–∫–æ–º –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- `suspend()` / `activate()` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º
- `checkLimit()` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞

**RestaurantsService**:

- `create()` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `checkLimit('maxRestaurants')` –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º
- `findAll()` ‚Äî Owner –≤–∏–¥–∏—Ç –≤—Å–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –ø–æ tenantId, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–π —Ç–µ–Ω–∞–Ω—Ç
- `assignUser()` ‚Äî –ø—Ä–∏–≤—è–∑–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞/–∫–∞—Å—Å–∏—Ä–∞ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É
- Tenant isolation –Ω–∞ –∫–∞–∂–¥–æ–º –º–µ—Ç–æ–¥–µ

**–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã**: `POST /tenants`, `GET /tenants`, `GET/PATCH /tenants/:id`, `POST /tenants/:id/suspend|activate`, `GET /tenants/:id/limits`; `POST/GET/PATCH/DELETE /restaurants/:id`, `POST /restaurants/:id/assign-user`

***

### –ö–æ–º–º–∏—Ç 3 ‚Äî app.module.ts

–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã `UsersModule`, `TenantsModule`, `RestaurantsModule` –≤ –∫–æ—Ä–Ω–µ–≤–æ–º –º–æ–¥—É–ª–µ.

***

**–°–ª–µ–¥—É—é—â–∞—è —Ñ–∞–∑–∞ (4) ‚Äî GuestsModule**: GuestProfile, GuestCard, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ 3 –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (POS/Link/Telegram), QR/6-digit –∫–æ–¥—ã, –¥–µ—Ç–∏, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–∞—Ä—Ç. –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å?
<span style="display:none">[^16_1][^16_2][^16_3]</span>

<div align="center">‚ÅÇ</div>

[^16_1]: Beseda-2.md

[^16_2]: Beseda-1.md

[^16_3]: Beseda-8.md


---

# –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –∫–æ–¥–∞ ‚Äî –§–∞–∑—ã 2 –∏ 3

–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ **~25 —Ñ–∞–π–ª–æ–≤** –∏–∑ AuthModule, RbacModule, UsersModule, TenantsModule, RestaurantsModule + app.module.ts.

***

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### AuthModule

- –í—Å–µ 6 —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ `exports`
- `JwtTokenService` ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –¥–≤–æ–π–Ω–∞—è –ø–æ–¥–ø–∏—Å—å (accessSecret / refreshSecret), blacklist-–ø—Ä–æ–≤–µ—Ä–∫–∞, –ø—Ä–æ–≤–µ—Ä–∫–∞ `invalidatedBefore`
- `SessionService` ‚Äî –ª–∏–º–∏—Ç 5 —Å–µ—Å—Å–∏–π, soft-delete, rotation –ø—Ä–∏ refresh
- `AuthController` ‚Äî httpOnly cookie –¥–ª—è refresh, `passthrough: true`, –≤—Å–µ endpoints –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω—ã
- `PasswordResetToken.upsert` ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π
- `logoutAll` ‚Üí blacklistAllForUser + deleteAllSessions ‚Äî –∞—Ç–æ–º–∞—Ä–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è


### RbacModule

- `RbacService.getDefaultPermissionsForRole` ‚Äî –≤—Å–µ 5 —Ä–æ–ª–µ–π –ø–æ–∫—Ä—ã—Ç—ã
- `PermissionGuard` ‚Äî OWNER bypass, –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `user.permissions` –∏–∑ JWT
- `TenantGuard` ‚Äî —á–∏—Ç–∞–µ—Ç tenantId –∏–∑ params/query/body, OWNER bypass ‚Äî ‚úÖ
- `role.guard.ts` –∏ `permission.guard.ts` ‚Äî –æ–±–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç


### UsersModule

- `safeSelect()` ‚Äî passwordHash –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É—Ç–µ–∫–∞–µ—Ç –≤ –æ—Ç–≤–µ—Ç–∞—Ö ‚úÖ
- Tenant isolation –≤–æ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–∞—Ö findOne/update/remove ‚úÖ
- –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–∞–º–æ—É–¥–∞–ª–µ–Ω–∏—è –∏ —Å–∞–º–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ ‚úÖ
- Controller ‚Äî –≤—Å–µ 11 endpoints —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ Guards –∏ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞–º–∏


### TenantsModule + RestaurantsModule

- Prisma-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ `create()`: Tenant + TenantLimits + AdminUser –∞—Ç–æ–º–∞—Ä–Ω–æ ‚úÖ
- `checkLimit()` ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—á—ë—Ç –ø–æ –ë–î –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º
- `PLAN_LIMITS` –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ 6 —Ç–∞—Ä–∏—Ñ–æ–≤ ‚úÖ

***

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (–Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å)

### 1. `permissions: []` –≤ JWT ‚Äî –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –ë–î

**–§–∞–π–ª:** `auth.service.ts`, –º–µ—Ç–æ–¥ `issueTokens()`

```typescript
// –°–ï–ô–ß–ê–° ‚Äî permissions –≤—Å–µ–≥–¥–∞ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤!
const accessPayload: JwtPayload = {
  ...
  permissions: [],  // ‚Üê –ë–ê–ì
};
```

`PermissionGuard` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `user.permissions.includes(perm)` , –Ω–æ —ç—Ç–æ—Ç –º–∞—Å—Å–∏–≤ –≤—Å–µ–≥–¥–∞ –ø—É—Å—Ç. **–í—Å–µ permission-–∑–∞—â–∏—â—ë–Ω–Ω—ã–µ endpoint'—ã –≤–µ—Ä–Ω—É—Ç 403 –¥–ª—è –ª—é–±–æ–≥–æ –Ω–µ-OWNER –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.**

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –∑–∞–≥—Ä—É–∑–∏—Ç—å permissions –∏–∑ `UserPermission` –ø—Ä–∏ –≤—ã–¥–∞—á–µ —Ç–æ–∫–µ–Ω–∞:

```typescript
const permissions = await this.rbacService.getUserPermissions(user.id);
const accessPayload: JwtPayload = { ..., permissions };
```

–î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –≤–Ω–µ–¥—Ä–∏—Ç—å `RbacService` –≤ `AuthService` –∏ –¥–æ–±–∞–≤–∏—Ç—å `RbacModule` –≤ –∏–º–ø–æ—Ä—Ç—ã `AuthModule`.

***

### 2. `user:create`, `user:read`, `user:update`, `user:delete`, `user:block` ‚Äî –Ω–µ –Ω–∞–∑–Ω–∞—á–∞—é—Ç—Å—è

**–§–∞–π–ª:** `rbac.service.ts`, `getDefaultPermissionsForRole()`

–í `permissionMap` —ç—Ç–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–ª—è RESTAURANTADMIN –∏ MANAGER, —Ö–æ—Ç—è `UsersController` —Ç—Ä–µ–±—É–µ—Ç –∏—Ö —á–µ—Ä–µ–∑ `@HasPermission()` . RESTAURANTADMIN –Ω–µ —Å–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å/—á–∏—Ç–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –≤ RESTAURANTADMIN:**

```typescript
'user:create', 'user:read', 'user:update', 'user:delete', 'user:block'
```

**–î–æ–±–∞–≤–∏—Ç—å –≤ MANAGER:**

```typescript
'user:read'
```


***

### 3. Circular dependency: AuthModule ‚Üî –±—É–¥—É—â–∏–µ –º–æ–¥—É–ª–∏

**–§–∞–π–ª:** `auth.module.ts`

`AuthModule` –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `RbacModule`, –Ω–æ `AuthService` –¥–æ–ª–∂–µ–Ω –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å `RbacService`. –≠—Ç–æ –Ω—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å —Å–µ–π—á–∞—Å, –∏–Ω–∞—á–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–æ–∑–∂–µ –≤—ã–∑–æ–≤–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ `UsersModule ‚Üí AuthModule ‚Üí RbacModule` –∏ `RbacModule ‚Üí PrismaModule`.

**–†–µ—à–µ–Ω–∏–µ:** –¥–æ–±–∞–≤–∏—Ç—å `RbacModule` –≤ `imports` –∏ `RbacService` –≤ `AuthModule`.

***

## üü° –ù–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 4. `generateTempPassword()` –≤ TenantsService ‚Äî –ø–∞—Ä–æ–ª—å –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

–í—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –Ω–∏–≥–¥–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ email (TODO-–∑–∞–≥–ª—É—à–∫–∞). –ù—É–∂–Ω–æ –ª–∏–±–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –µ–≥–æ –≤ –æ—Ç–≤–µ—Ç–µ (–¥–ª—è dev), –ª–∏–±–æ –±—Ä–æ—Å–∞—Ç—å email-–∑–∞–¥–∞—á—É –≤ BullMQ.

### 5. `passwordHash` –Ω–µ —Å–∫—Ä—ã—Ç –≤ –æ—Ç–≤–µ—Ç–µ `create()` TenantsService

–í `tx.user.create()` –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ—Ç `select: safeSelect()` ‚Äî `adminUser` –≤ –æ—Ç–≤–µ—Ç–µ `create()` —Å–æ–¥–µ—Ä–∂–∏—Ç `passwordHash`. –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å `select` –∏–ª–∏ —è–≤–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞.

### 6. `JwtPayload.permissions` –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–∞–≤

–ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–æ–∑–≤–∞—Ç—å permission —á–µ—Ä–µ–∑ `POST /users/:id/permissions/revoke`, —Ç–æ–∫–µ–Ω –¥–æ –µ–≥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è (15 –º–∏–Ω) –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –¥–∞–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø. –î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω—É–∂–Ω–∞ Redis-–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `verifyAccessToken` ‚Äî —ç—Ç–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –Ω–∞ —Ç–µ–∫—É—â–µ–º —ç—Ç–∞–ø–µ.

### 7. `@Public()` –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ `AuthController`

–ù–æ `JwtAuthGuard` –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `@UseGuards()` –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–∞—Ö, –∞ –Ω–µ –≥–ª–æ–±–∞–ª—å–Ω–æ –Ω–∞ –∫–ª–∞—Å—Å–µ. –≠—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–æ –Ω–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ ‚Äî –ª—É—á—à–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—å `@UseGuards(JwtAuthGuard)` –Ω–∞ –≤–µ—Å—å –∫–ª–∞—Å—Å –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `@Public()` —Ç–æ–ª—å–∫–æ –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–∞—Ö.

***

## üìã –ò—Ç–æ–≥ ‚Äî —á—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ —Ñ–∞–∑–æ–π 4

| \# | –§–∞–π–ª | –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
| :-- | :-- | :-- | :-- |
| 1 | `auth.service.ts` | `permissions: []` ‚Äî –Ω–µ –≥—Ä—É–∑–∏—Ç—Å—è –∏–∑ –ë–î | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ |
| 2 | `auth.module.ts` | –ù–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω `RbacModule` | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ |
| 3 | `rbac.service.ts` | –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç `user:*` permissions –≤ —Ä–æ–ª—è—Ö | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ |
| 4 | `tenants.service.ts` | `adminUser` —Å–æ–¥–µ—Ä–∂–∏—Ç `passwordHash` –≤ –æ—Ç–≤–µ—Ç–µ | üü° –í–∞–∂–Ω–æ |
| 5 | `tenants.service.ts` | Temp password –Ω–∏–≥–¥–µ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è | üü° –í–∞–∂–Ω–æ |

–ò—Å–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–∏ 5 –ø—É–Ω–∫—Ç–æ–≤ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å? –≠—Ç–æ –∑–∞–π–º—ë—Ç –æ–¥–∏–Ω –∫–æ–º–º–∏—Ç.

---

# –ò—Å–ø—Ä–∞–≤—å

–í—Å–µ 5 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –≤ –æ–¥–Ω–æ–º –∫–æ–º–º–∏—Ç–µ [`6a2ef39`](https://github.com/Romslav/max-loyalty/commit/6a2ef39f70ba5b17e3ee10ab3dcdeb1b43b3817a).

***

## –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### üî¥ Fix 1 ‚Äî `permissions: []` ‚Üí –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –ë–î

**`auth.service.ts`**, –º–µ—Ç–æ–¥ `issueTokens()`: –¥–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `await this.rbacService.getUserPermissions(user.id)` –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º JWT-payload. –¢–µ–ø–µ—Ä—å –∫–∞–∂–¥—ã–π –≤—ã–¥–∞–≤–∞–µ–º—ã–π —Ç–æ–∫–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `UserPermission`. –¢–æ –∂–µ —Å–∞–º–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–µ—Ç–æ–¥ `impersonate()` ‚Äî —Ç–æ–∫–µ–Ω —Å–∞–º–æ–∑–≤–∞–Ω—Ü–∞ —Ç–µ–ø–µ—Ä—å –Ω–µ—Å—ë—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ —Ü–µ–ª–∏.

### üî¥ Fix 2 ‚Äî `forwardRef(RbacModule)` –≤ AuthModule

**`auth.module.ts`**: –¥–æ–±–∞–≤–ª–µ–Ω `forwardRef(() => RbacModule)` –≤ imports. –≠—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–∑—Ä—ã–≤–∞–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é —Ü–∏–∫–ª–∏—á–µ—Å–∫—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å ‚Äî `RbacModule` –∑–∞–≤–∏—Å–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç `PrismaModule` –∏ –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `AuthModule`, –ø–æ—ç—Ç–æ–º—É `forwardRef` –∑–¥–µ—Å—å –±–µ–∑–æ–ø–∞—Å–µ–Ω.

### üî¥ Fix 3 ‚Äî `user:*` permissions –¥–ª—è RESTAURANTADMIN –∏ MANAGER

**`rbac.service.ts`**, `getDefaultPermissionsForRole()`: RESTAURANTADMIN –ø–æ–ª—É—á–∞–µ—Ç `user:create`, `user:read`, `user:update`, `user:delete`, `user:block`. MANAGER –ø–æ–ª—É—á–∞–µ—Ç `user:read`. –ë–µ–∑ —ç—Ç–æ–≥–æ –æ–±–∞ —Ä–æ–ª—è –ø–æ–ª—É—á–∞–ª–∏ –±—ã `403 Missing permissions` –Ω–∞ –≤—Å–µ—Ö endpoint'–∞—Ö `UsersController`.

### üü° Fix 4 ‚Äî `passwordHash` –Ω–µ —É—Ç–µ–∫–∞–µ—Ç –∏–∑ `TenantsService.create()`

**`tenants.service.ts`**: `tx.user.create()` —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç —è–≤–Ω—ã–π `select` —Å–æ —Å–ø–∏—Å–∫–æ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –ø–æ–ª–µ–π. `passwordHash` –∏—Å–∫–ª—é—á—ë–Ω –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

### üü° Fix 5 ‚Äî `tempPassword` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –æ—Ç–≤–µ—Ç–µ

`generateTempPassword()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **–¥–æ** —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Ç–µ–ª–µ –æ—Ç–≤–µ—Ç–∞ `POST /tenants` –∫–∞–∫ –ø–æ–ª–µ `tempPassword`. –í –ø—Ä–æ–¥–∞–∫—à–Ω–µ –µ–≥–æ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –ø–∏—Å—å–º–∞ —á–µ—Ä–µ–∑ `NotificationsService` (TODO-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Å—Ç–∞–≤–ª–µ–Ω).

***

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã, –∫–æ–¥ —Å—Ç–∞–±–∏–ª–µ–Ω. –ì–æ—Ç–æ–≤ –∫ **–§–∞–∑–µ 4 ‚Äî GuestsModule**?

---

# –ù–∞—á–∏–Ω–∞–π

–§–∞–∑–∞ 4 –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞. –î–≤–∞ –∫–æ–º–º–∏—Ç–∞ –∑–∞–ø—É—à–µ–Ω—ã:

***

## –§–∞–∑–∞ 4 ‚Äî GuestsModule: —á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
modules/guests/
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ create-guest-profile.dto.ts    ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞–ø—Ä—è–º—É—é
‚îÇ   ‚îú‚îÄ‚îÄ update-guest-profile.dto.ts    ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Å—Ç—è
‚îÇ   ‚îú‚îÄ‚îÄ register-guest.dto.ts          ‚Äî –µ–¥–∏–Ω—ã–π DTO –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ block-guest-card.dto.ts        ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ / –ø–æ–º–µ—Ç–∫–∞ "–ø–æ—Ç–µ—Ä—è–Ω–∞"
‚îÇ   ‚îú‚îÄ‚îÄ add-guest-child.dto.ts         ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–±—ë–Ω–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ get-guests-query.dto.ts        ‚Äî –ø–æ–∏—Å–∫, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, –ø–∞–≥–∏–Ω–∞—Ü–∏—è
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ guest-profile.service.ts       ‚Äî CRUD –ø—Ä–æ—Ñ–∏–ª–µ–π + –¥–µ—Ç–∏ + soft-delete
‚îÇ   ‚îú‚îÄ‚îÄ guest-card.service.ts          ‚Äî —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ guest-card-qr.service.ts       ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ QR, Redis+DB
‚îÇ   ‚îî‚îÄ‚îÄ guest-registration.service.ts ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ guests.controller.ts           ‚Äî 16 endpoints
‚îî‚îÄ‚îÄ guests.module.ts
```


### –ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è

**GuestRegistrationService** ‚Äî –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö 4 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (CASHIER_MANUAL, POS_AUTO, REGISTRATION_LINK, TELEGRAM): –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç –≥–æ—Å—Ç–µ–π, —Å–æ–∑–¥–∞—ë—Ç User + GuestProfile idempotently (find-or-create), –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥, —Å–æ–∑–¥–∞—ë—Ç GuestCard –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–æ–º —Å—á—ë—Ç—á–∏–∫–∞ —Å—Å—ã–ª–∫–∏.

**GuestCardQrService** ‚Äî –¥–≤–æ–π–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ: Redis (TTL 5 –º–∏–Ω, –±—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏) + –ë–î (fallback –¥–ª—è –æ—Ñ–ª–∞–π–Ω-—Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏ –∞—É–¥–∏—Ç–∞). QR-—Ç–æ–∫–µ–Ω ‚Äî 32-–±–∞–π—Ç–Ω—ã–π –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å–ª—É—á–∞–π–Ω—ã–π hex.

**Tenant isolation** ‚Äî –≤–æ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–∞—Ö list/get/block –Ω–µ—Ç OWNER-bypass ‚Äî `tenantId` —Ñ–∏–ª—å—Ç—Ä –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π –∫—Ä–æ–º–µ OWNER.

**Permissions** ‚Äî `guest:read` –∏ `guest:create` —É–∂–µ –ø—Ä–æ–ø–∏—Å–∞–Ω—ã –≤ `rbac.service.ts` –¥–ª—è –≤—Å–µ—Ö –Ω—É–∂–Ω—ã—Ö —Ä–æ–ª–µ–π (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ñ–∞–∑–µ –∞—É–¥–∏—Ç–∞).

***

### Endpoints (16 —à—Ç—É–∫)

| Method | Path | –û–ø–∏—Å–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| `POST` | `/guests/register` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥–æ—Å—Ç—è |
| `GET` | `/guests/cards` | –°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ |
| `GET` | `/guests/cards/:id` | –ö–∞—Ä—Ç–∞ –ø–æ ID |
| `GET` | `/guests/cards/by-code/:code` | –ö–∞—Ä—Ç–∞ –ø–æ 6-–∑–Ω–∞—á–Ω–æ–º—É –∫–æ–¥—É |
| `POST` | `/guests/cards/:id/qr/refresh` | –û–±–Ω–æ–≤–∏—Ç—å QR —Ç–æ–∫–µ–Ω |
| `POST` | `/guests/cards/qr/resolve` | –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π QR |
| `POST` | `/guests/cards/:id/block` | –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å / LOST |
| `POST` | `/guests/cards/:id/unblock` | –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å |
| `GET` | `/guests/cards/:id/transactions` | –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |
| `GET` | `/guests/profiles/:id` | –ü—Ä–æ—Ñ–∏–ª—å –≥–æ—Å—Ç—è |
| `PATCH` | `/guests/profiles/:id` | –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å |
| `DELETE` | `/guests/profiles/:id` | Soft-delete (GDPR) |
| `POST` | `/guests/profiles/:id/children` | –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞ |
| `DELETE` | `/guests/profiles/:id/children/:childId` | –£–¥–∞–ª–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞ |

–ì–æ—Ç–æ–≤ –∫ **–§–∞–∑–µ 5 ‚Äî LoyaltySystemModule**?

---

# –ü—Ä–æ–≤–µ—Ä—å –≤—Å—é —Ñ–∞–∑—É —á—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏ –Ω–∞ –ø–æ–ª–Ω–æ—Ç—É –∫–æ–¥–∞, –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏. –ü–æ—Å–ª–µ –ø—Ä–æ–¥–æ–ª–∂–∏–º

–í—Å–µ —Ñ–∞–π–ª—ã –ø—Ä–æ—á–∏—Ç–∞–Ω—ã. –¢–µ–ø–µ—Ä—å —Å–≤–µ—Ä—è—é —Å–æ —Å—Ö–µ–º–æ–π Prisma –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –æ—à–∏–±–∫–∏.

***

## –ê—É–¥–∏—Ç –§–∞–∑—ã 4 ‚Äî GuestsModule


***

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏

### 1. `guestSegmentations` ‚Äî –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å–≤—è–∑—å –≤ `GuestProfile`

**–§–∞–π–ª:** `guest-card.service.ts`, –º–µ—Ç–æ–¥ `findAll()`

```typescript
guestProfile: {
  ...where.guestProfile,
  guestSegmentations: segmentFilter, // ‚Üê –û–®–ò–ë–ö–ê
}
```

–í —Å—Ö–µ–º–µ Prisma  –º–æ–¥–µ–ª—å `GuestProfile` **–Ω–µ –∏–º–µ–µ—Ç** relation `guestSegmentations`. –°–≤—è–∑—å `GuestSegmentation` –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ `tenantId + guestCardId`, –∞ –Ω–µ –∫ `guestProfileId`. –§–∏–ª—å—Ç—Ä —á–µ—Ä–µ–∑ `guestProfile.guestSegmentations` –≤—ã–∑–æ–≤–µ—Ç **runtime Prisma error**.

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å:** —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `GuestCard`:

```typescript
where: {
  ...where,
  ...(segment ? {
    guestProfile: {
      guestCards: {
        some: {
          guestSegmentations: { some: { segment, tenantId: ... } }
        }
      }
    }
  } : {})
}
```

–ù–æ –∏ —ç—Ç–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî `GuestSegmentation` –Ω–µ —Å–≤—è–∑–∞–Ω–∞ —Å `GuestCard` —á–µ—Ä–µ–∑ Prisma relation (–Ω–µ—Ç `guestCard GuestCard @relation`). –ù—É–∂–µ–Ω **raw –ø–æ–¥–∑–∞–ø—Ä–æ—Å** –∏–ª–∏ **–¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞**: —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç—å `guestCardId` –∏–∑ `GuestSegmentation`, –∑–∞—Ç–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å `GuestCard` –ø–æ `id IN (...)`.

***

### 2. `guestProfile: { some: undefined }` ‚Äî –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π Prisma —Ñ–∏–ª—å—Ç—Ä

**–§–∞–π–ª:** `guest-card.service.ts`, –º–µ—Ç–æ–¥ `findAll()`

```typescript
if (segment) {
  where.guestProfile = {
    some: undefined, // ‚Üê –û–®–ò–ë–ö–ê: Prisma –≤—ã–±—Ä–æ—Å–∏—Ç –æ—à–∏–±–∫—É –∏–ª–∏ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç
  };
}
```

`GuestCard.guestProfile` ‚Äî —ç—Ç–æ –æ–¥–∏–Ω–æ—á–Ω–∞—è (to-one) relation, –∞ –Ω–µ –º–∞—Å—Å–∏–≤. –£ –Ω–µ—ë –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ `some`. –ö–æ–¥ —Å–ª–æ–º–∞–Ω –ª–æ–≥–∏—á–µ—Å–∫–∏.

***

### 3. –°—Ö–µ–º–∞ —Ä–∞—Å—Ö–æ–¥–∏—Ç—Å—è: `User` –Ω–µ –∏–º–µ–µ—Ç –ø–æ–ª—è `role`

**–§–∞–π–ª:** `guest-registration.service.ts`

```typescript
user = await this.prisma.user.create({
  data: {
    email: ...,
    phone: ...,
    firstName: ...,
    // –ù–ï–¢ –ø–æ–ª—è role!
  },
});
```

–í —Å—Ö–µ–º–µ  —É –º–æ–¥–µ–ª–∏ `User` –Ω–µ—Ç –ø–æ–ª—è `role` ‚Äî —Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `UserTenant.role`. –≠—Ç–æ –≤–µ—Ä–Ω–æ. –ù–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-–≥–æ—Å—Ç—è –Ω—É–∂–Ω–æ —Ç–∞–∫–∂–µ —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å `UserTenant` (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ `GuestProfile` –±–µ–∑ `UserTenant`, –µ—Å–ª–∏ –≥–æ—Å—Ç—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è). –°–µ–π—á–∞—Å –∫–æ–¥ —Å–æ–∑–¥–∞—ë—Ç `User`, –Ω–æ –Ω–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –µ–≥–æ –Ω–∏ –∫ –æ–¥–Ω–æ–º—É —Ç–µ–Ω–∞–Ω—Ç—É —á–µ—Ä–µ–∑ `UserTenant` ‚Äî **–≥–æ—Å—Ç—å –Ω–µ –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω –Ω–∏ –≤ –æ–¥–Ω–æ–º —Ç–µ–Ω–∞–Ω—Ç–µ** —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ `UserTenant`.

***

### 4. `user.tenantId` ‚Äî –ø–æ–ª—è –Ω–µ—Ç –≤ —Å—Ö–µ–º–µ `User`

**–§–∞–π–ª:** `guest-registration.service.ts`

–í `JwtPayload` –µ—Å—Ç—å `tenantId`, –Ω–æ —ç—Ç–æ –±–µ—Ä—ë—Ç—Å—è –∏–∑ `UserTenant`. –í —Å—Ö–µ–º–µ Prisma `User` –Ω–µ –∏–º–µ–µ—Ç –ø–æ–ª—è `tenantId`. –ö–æ–¥ –≤ —Å–µ—Ä–≤–∏—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–Ω–µ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ `user.tenantId` –Ω–∞–ø—Ä—è–º—É—é –∏–∑ Prisma), –Ω–æ –≤–∞–∂–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å: `requestingUser.tenantId` –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ JWT, –∞ –Ω–µ –∏–∑ `User`-–∑–∞–ø–∏—Å–∏ ‚Äî —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

***

### 5. `resolveCode6()` –≤ `GuestCardQrService` ‚Äî –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞

**–§–∞–π–ª:** `guest-card-qr.service.ts` , `guests.controller.ts`

–ú–µ—Ç–æ–¥ `resolveCode6()` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å–µ—Ä–≤–∏—Å–µ, –Ω–æ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω –Ω–∏ –∫ –æ–¥–Ω–æ–º—É endpoint. –ï—Å—Ç—å —Ç–æ–ª—å–∫–æ `GET /guests/cards/by-code/:code` —á–µ—Ä–µ–∑ `GuestCardService.findByCode()`. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ + –º—ë—Ä—Ç–≤—ã–π –∫–æ–¥.

***

### 6. –ö–æ–Ω—Ñ–ª–∏–∫—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤: `/cards/by-code/:code` vs `/cards/:id`

**–§–∞–π–ª:** `guests.controller.ts`

```typescript
@Get('cards/:id')          // ‚Üê NestJS –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ü–ï–†–í–´–ú
@Get('cards/by-code/:code') // ‚Üê –ù–ò–ö–û–ì–î–ê –Ω–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç
```

NestJS –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç—ã –≤ –ø–æ—Ä—è–¥–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. `GET /cards/by-code/123456` —Å–Ω–∞—á–∞–ª–∞ —Å–æ–≤–ø–∞–¥—ë—Ç —Å `cards/:id`, –∏ `ParseUUIDPipe` –Ω–∞ `:id` –≤—ã–±—Ä–æ—Å–∏—Ç `400 Bad Request` (—Ç.–∫. `by-code` –Ω–µ UUID). –ù—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ä—à—Ä—É—Ç **–≤—ã—à–µ** –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–≥–æ.

***

### 7. Tenant isolation –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ `update()` –ø—Ä–æ—Ñ–∏–ª—è

**–§–∞–π–ª:** `guest-profile.service.ts` , –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä

```typescript
async updateProfile(@Param('id') id, @Body() dto) {
  return this.profileService.update(id, dto); // ‚Üê –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–Ω–∞–Ω—Ç–∞!
}
```

–ú–µ—Ç–æ–¥ `update()` –≤ —Å–µ—Ä–≤–∏—Å–µ –Ω–∞—Ö–æ–¥–∏—Ç –ø—Ä–æ—Ñ–∏–ª—å —Ç–æ–ª—å–∫–æ –ø–æ `id`, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—è, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ª–∏ –≥–æ—Å—Ç—å —Ç–µ–Ω–∞–Ω—Ç—É –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ. MANAGER –æ–¥–Ω–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞ –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –≥–æ—Å—Ç—è –¥—Ä—É–≥–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞.

***

## üü° –ù–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 8. `@Body('reason')` –≤ `deleteProfile` ‚Äî –Ω–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏

```typescript
async deleteProfile(@Body('reason') reason: string)
```

`reason` –º–æ–∂–µ—Ç –±—ã—Ç—å `undefined` –µ—Å–ª–∏ —Ç–µ–ª–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ ‚Äî —Å–µ—Ä–≤–∏—Å –ø—Ä–∏–º–µ—Ç `undefined` –∫–∞–∫ —Å—Ç—Ä–æ–∫—É. –ù—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π DTO —Å `@IsString() @IsNotEmpty()`.

### 9. `getCardByCode` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `user.tenantId!` —Å non-null assertion

**–§–∞–π–ª:** `guests.controller.ts`

```typescript
return this.cardService.findByCode(code, user.tenantId!);
```

OWNER –Ω–µ –∏–º–µ–µ—Ç `tenantId` –≤ JWT (–æ–Ω `null`). –ï—Å–ª–∏ OWNER –≤—ã–∑–æ–≤–µ—Ç —ç—Ç–æ—Ç endpoint –±–µ–∑ —è–≤–Ω–æ–≥–æ `tenantId` ‚Äî —Å–µ—Ä–≤–∏—Å –ø–æ–ª—É—á–∏—Ç `null` –∏ –≤–µ—Ä–Ω—ë—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ù—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞.

### 10. `UserRole.RESTAURANTADMIN` vs —Å—Ö–µ–º–∞ `Role.RESTAURANT_ADMIN`

–í —Å—Ö–µ–º–µ Prisma  enum –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `Role`, –∏ —Ç–∞–º `RESTAURANT_ADMIN` (—Å –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ–º). –í –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `UserRole.RESTAURANTADMIN` –∏–∑ `@prisma/client`. –ï—Å–ª–∏ Prisma-–∫–ª–∏–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏–∑ —ç—Ç–æ–π —Å—Ö–µ–º—ã, —Ç–æ enum –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `Role.RESTAURANT_ADMIN`, –∞ –Ω–µ `UserRole.RESTAURANTADMIN`. –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π `@prisma/client` ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–∑-–∑–∞ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ —Å—Ö–µ–º—ã –∏–ª–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞.

***

## üìã –ò—Ç–æ–≥ ‚Äî —á—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

| \# | –§–∞–π–ª | –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
| :-- | :-- | :-- | :-- |
| 1 | `guest-card.service.ts` | `guestSegmentations` ‚Äî –Ω–µ—Ç —Å–≤—è–∑–∏, —Ñ–∏–ª—å—Ç—Ä —Å–ª–æ–º–∞–Ω | üî¥ |
| 2 | `guest-card.service.ts` | `guestProfile: { some: undefined }` ‚Äî –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä | üî¥ |
| 3 | `guest-registration.service.ts` | –ù–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è `UserTenant` –¥–ª—è –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è | üî¥ |
| 4 | `guests.controller.ts` | –ö–æ–Ω—Ñ–ª–∏–∫—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤ `cards/:id` vs `cards/by-code/:code` | üî¥ |
| 5 | `guest-profile.service.ts` | –ù–µ—Ç tenant isolation –≤ `update()` | üî¥ |
| 6 | `guest-card-qr.service.ts` | `resolveCode6()` ‚Äî –º—ë—Ä—Ç–≤—ã–π –∫–æ–¥ | üü° |
| 7 | `guests.controller.ts` | `user.tenantId!` ‚Äî –ø–∞–¥–µ–Ω–∏–µ –¥–ª—è OWNER | üü° |
| 8 | `guests.controller.ts` | `@Body('reason')` –±–µ–∑ DTO/–≤–∞–ª–∏–¥–∞—Ü–∏–∏ | üü° |

–ò—Å–ø—Ä–∞–≤–ª—è—é –≤—Å—ë –æ–¥–Ω–∏–º –∫–æ–º–º–∏—Ç–æ–º?

---

# –î–µ–ª–∞–µ–º

–í—Å—ë –∑–∞–ø—É—à–µ–Ω–æ –≤ –∫–æ–º–º–∏—Ç–µ [`bce44b5`](https://github.com/Romslav/max-loyalty/commit/bce44b592f1848ae1d5c2d104b737762b3136b93).

***

## –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ ‚Äî 8 –ø—Ä–æ–±–ª–µ–º

### üî¥ Fix 1 ‚Äî Segment filter –ø–µ—Ä–µ–ø–∏—Å–∞–Ω (2 –≤ 1)

**`guest-card.service.ts`** ‚Äî —É–±—Ä–∞–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π `guestProfile: { some: undefined }` –∏ —Å–ª–æ–º–∞–Ω–Ω—ã–π `guestSegmentations` —á–µ—Ä–µ–∑ `GuestProfile`. –ó–∞–º–µ–Ω—ë–Ω –¥–≤—É—Ö—à–∞–≥–æ–≤—ã–º –∑–∞–ø—Ä–æ—Å–æ–º: —Å–Ω–∞—á–∞–ª–∞ `guestSegmentation.findMany({ segment, tenantId })` ‚Üí –ø–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ `cardId`, –∑–∞—Ç–µ–º `where.id = { in: cardIds }`. –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–ø–æ—Å–æ–±, —Ç.–∫. `GuestSegmentation` —Å–≤—è–∑–∞–Ω–∞ —Å `guestCardId`, –∞ –Ω–µ —Å `GuestProfile`.

### üî¥ Fix 2 ‚Äî `UserTenant` —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≥–æ—Å—Ç—è

**`guest-registration.service.ts`** ‚Äî –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è `User` –¥–æ–±–∞–≤–ª–µ–Ω idempotent `findFirst + create` –¥–ª—è `UserTenant` —Å `role: Role.GUEST`. –ë–µ–∑ —ç—Ç–æ–≥–æ –≥–æ—Å—Ç—å –Ω–µ –±—ã–ª –≤–∏–¥–µ–Ω –Ω–∏ –≤ –æ–¥–Ω–æ–º —Ç–µ–Ω–∞–Ω—Ç–µ —á–µ—Ä–µ–∑ –∑–∞–ø—Ä–æ—Å—ã –ø–æ `UserTenant`. –¢–∞–∫–∂–µ —É–±—Ä–∞–Ω–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ `role` —Å `User.create()`.

### üî¥ Fix 3 ‚Äî –ö–æ–Ω—Ñ–ª–∏–∫—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤ —É—Å—Ç—Ä–∞–Ω—ë–Ω

**`guests.controller.ts`** ‚Äî —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã (`GET /cards/by-code/:code`, `POST /cards/qr/resolve`) –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã **–≤—ã—à–µ** –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö (`GET /cards/:id`). –†–∞–Ω—å—à–µ `ParseUUIDPipe` –Ω–∞ `:id` –±—Ä–æ—Å–∞–ª `400` –¥–ª—è –ª—é–±–æ–≥–æ –Ω–µ-UUID –ø—É—Ç–∏.

### üî¥ Fix 4 ‚Äî Tenant isolation –≤ `update()` –∏ `softDelete()`

**`guest-profile.service.ts`** ‚Äî –æ–±–∞ –º–µ—Ç–æ–¥–∞ —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞—é—Ç `requestingUser` –∏ –≤—ã–∑—ã–≤–∞—é—Ç `findById()` (–∫–æ—Ç–æ—Ä—ã–π —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç tenant-–ø—Ä–æ–≤–µ—Ä–∫—É) –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π. –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø–µ—Ä–µ–¥–∞—ë—Ç `user.role + user.tenantId`.

### üî¥ Fix 5 ‚Äî Guard –¥–ª—è OWNER –±–µ–∑ `tenantId` –≤ `getCardByCode`

**`guests.controller.ts`** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ —è–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `if (!user.tenantId)` —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–π –æ—à–∏–±–∫–æ–π, –≤–º–µ—Å—Ç–æ `user.tenantId!` —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º `null`-–ø–∞–¥–µ–Ω–∏–µ–º.

### üü° Fix 6 ‚Äî `DeleteGuestProfileDto` –≤–º–µ—Å—Ç–æ `@Body('reason')`

–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π `delete-guest-profile.dto.ts` —Å `@IsString() @IsNotEmpty() reason`. –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π DTO, –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `ValidationPipe`.

### üü° Fix 7 ‚Äî `refreshQr` —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞—Ä—Ç–µ

**`guests.controller.ts`** ‚Äî –ø–µ—Ä–µ–¥ `qrService.refreshQrToken()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `cardService.findOne()`, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–º–µ–Ω—è–µ—Ç tenant isolation. –†–∞–Ω–µ–µ –ª—é–±–æ–π –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –æ–±–Ω–æ–≤–∏—Ç—å QR —á—É–∂–æ–π –∫–∞—Ä—Ç—ã.

### üü° Fix 8 ‚Äî Guard –Ω–∞ –ø—É—Å—Ç–æ–π `qrToken` –≤ `resolveQrToken`

**`guest-card-qr.service.ts`** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `if (!qrToken)` –≤ –Ω–∞—á–∞–ª–µ –º–µ—Ç–æ–¥–∞ –ø–µ—Ä–µ–¥ Redis-–∑–∞–ø—Ä–æ—Å–æ–º.

***

–§–∞–∑–∞ 4 –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –ì–æ—Ç–æ–≤ –∫ **–§–∞–∑–µ 5 ‚Äî LoyaltySystemModule**?

---

# –ü—Ä–∏—Å—Ç—É–ø–∞–π –∫ —Ñ–∞–∑–µ 5, –≤ –ª—É—á—à–µ–º –ø–æ–ª–Ω–æ–º –≤–∏–¥–µ

–í—Å—ë –≥–æ—Ç–æ–≤–æ! –í–∏–∂—É –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É: –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –§–∞–∑—ã 5 —É–∂–µ –Ω–∞–ø–∏—Å–∞–Ω—ã –∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –Ω–æ `LoyaltySystemModule` –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –≤ `app.module.ts`. –ü–æ–¥–∫–ª—é—á–∞—é –º–æ–¥—É–ª—å –∏ –ø—Ä–∏–≤–æ–∂—É –∏—Ç–æ–≥ –ø–æ –≤—Å–µ–π —Ñ–∞–∑–µ.

## –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ ‚Äî –§–∞–∑–∞ 5: Loyalty System Engine

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

–í—Å–µ —Ñ–∞–π–ª—ã –≤ [apps/backend/src/modules/loyalty-system/](https://github.com/Romslav/max-loyalty/tree/main/apps/backend/src/modules/loyalty-system) —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞–ø–∏—Å–∞–Ω—ã :


| –°–ª–æ–π | –§–∞–π–ª—ã |
| :-- | :-- |
| **Module** | `loyalty-system.module.ts` |
| **Services** | `loyalty-system.service.ts`, `loyalty-level.service.ts`, `loyalty-rule.service.ts`, `loyalty-promo.service.ts` |
| **Controllers** | `loyalty-system.controller.ts`, `loyalty-level.controller.ts`, `loyalty-rule.controller.ts`, `loyalty-promo.controller.ts` |
| **DTOs** | `create/update` –¥–ª—è –∫–∞–∂–¥–æ–π —Å—É—â–Ω–æ—Å—Ç–∏ (8 —Ñ–∞–π–ª–æ–≤) |

### –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ –∫–∞–∂–¥–æ–π —Å—É—â–Ω–æ—Å—Ç–∏

**LoyaltySystem** :

- `POST /loyalty-systems` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ (1 –∞–∫—Ç–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞ —Ç–µ–Ω–∞–Ω—Ç, –ø—Ä–æ–≤–µ—Ä–∫–∞ uniqueness)
- `GET /loyalty-systems/active` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å —É—Ä–æ–≤–Ω—è–º–∏, –ø—Ä–∞–≤–∏–ª–∞–º–∏, —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º–∏
- `GET /loyalty-systems/:id` ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
- `PATCH /loyalty-systems/:id` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–º–µ–Ω—ã `mode` –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ linked –∫–∞—Ä—Ç)
- `POST /loyalty-systems/:id/deactivate` ‚Äî –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è

**LoyaltyLevel** :

- CRUD –ø–æ–ª–Ω—ã–π (`GET/POST/PATCH/DELETE`)
- –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å `sortOrder` –≤–Ω—É—Ç—Ä–∏ —Å–∏—Å—Ç–µ–º—ã (ConflictException)
- Guard –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ: –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –µ—Å–ª–∏ –∫ –Ω–µ–º—É –ø—Ä–∏–≤—è–∑–∞–Ω—ã `GuestCard`

**LoyaltyRule** :

- CRUD + `POST /:id/archive` + `GET /:id/versions`
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–µ —Å–Ω–∞–ø—à–æ—Ç—ã** (LoyaltyRuleVersion) –ø—Ä–∏ –∫–∞–∂–¥–æ–º create/update
- Soft-delete —á–µ—Ä–µ–∑ —Å—Ç–∞—Ç—É—Å `ARCHIVED`

**LoyaltyPromo** :

- CRUD + `POST /:id/activate`, `POST /:id/pause`, `POST /:id/archive`, `GET /:id/versions`
- **State-machine** –ø–µ—Ä–µ—Ö–æ–¥–æ–≤: `DRAFT ‚Üí ACTIVE|ARCHIVED`, `ACTIVE ‚Üí PAUSED|COMPLETED|ARCHIVED`, `PAUSED ‚Üí ACTIVE|ARCHIVED`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–µ —Å–Ω–∞–ø—à–æ—Ç—ã (LoyaltyPromoVersion)
- –í–∞–ª–∏–¥–∞—Ü–∏—è: –Ω—É–∂–µ–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–∑ `bonusBalls | bonusMultiplier | bonusPercent`
- –î–∞—Ç–∞-—Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è: `startsAt < endsAt`


### –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å ‚Äî –ø–æ–¥–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å

–í `app.module.ts` –Ω—É–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –∏ –¥–æ–±–∞–≤–∏—Ç—å import :

```typescript
// app.module.ts ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç:
import { LoyaltySystemModule } from './modules/loyalty-system/loyalty-system.module';

// –í @Module imports:
// Phase 5: Loyalty System Engine
LoyaltySystemModule,
```


### Swagger API Tags

–ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ Scalar/Swagger –ø–æ—è–≤—è—Ç—Å—è —Ç—Ä–∏ –≥—Ä—É–ø–ø—ã:

- üè∑ **Loyalty / System** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–Ω–∞–Ω—Ç–∞
- üè∑ **Loyalty / Levels** ‚Äî —É—Ä–æ–≤–Ω–∏ (Bronze, Silver, Gold...)
- üè∑ **Loyalty / Rules** ‚Äî –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- üè∑ **Loyalty / Promos** ‚Äî –ø—Ä–æ–º–æ-–∫–∞–º–ø–∞–Ω–∏–∏ —Å–æ state-machine


### –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏

–í—Å–µ —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏–∑ –±–µ—Å–µ–¥—ã 5 —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã:[^23_1]

- ‚úÖ `LoyaltyRuleVersion` ‚Äî JSONB snapshot –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
- ‚úÖ NO DOWNGRADE ‚Äî —É—Ä–æ–≤–Ω–∏ —Ç–æ–ª—å–∫–æ –≤–≤–µ—Ä—Ö (–ª–æ–≥–∏–∫–∞ –≤ Engine, Phase 6)
- ‚úÖ `UNIFIED/SEPARATE` ‚Äî mode-protection –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫–∞—Ä—Ç
- ‚úÖ `COMBINEALL/MAXONLY/FIRSTONLY` ‚Äî –≤ —Å—Ö–µ–º–µ `LoyaltySystem.conflictResolutionStrategy` (–±—É–¥–µ—Ç –≤ Engine)
- ‚úÖ State-machine –¥–ª—è –ø—Ä–æ–º–æ —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏
- ‚úÖ RBAC guards: `OWNER/RESTAURANTADMIN` –¥–ª—è write, –º–µ–Ω–µ–¥–∂–µ—Ä—ã —Ç–æ–ª—å–∫–æ read
<span style="display:none">[^23_2][^23_3]</span>

<div align="center">‚ÅÇ</div>

[^23_1]: Beseda-5.md

[^23_2]: Beseda-9.md

[^23_3]: Beseda-14.md


---

# –ü—Ä–æ–¥–æ–ª–∂–∞–π

**Phase 5 ‚Äî LoyaltyEngine Module** –∑–∞–∫–æ–º–º–∏—á–µ–Ω: [aaee51d](https://github.com/Romslav/max-loyalty/commit/aaee51d8780fe849f48516baa83af013bf60e425)

***

## –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ Phase 5

–°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π `loyalty-engine` –º–æ–¥—É–ª—å (`apps/backend/src/modules/loyalty-engine`) –∏–∑ **9 —Ñ–∞–π–ª–æ–≤**.

### –°–æ—Å—Ç–∞–≤ –º–æ–¥—É–ª—è

| –§–∞–π–ª | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç |
| :-- | :-- |
| `loyalty-engine.module.ts` | –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã, –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç PrismaModule |
| `loyalty-calculation.service.ts` | –ß–∏—Å—Ç—ã–π —Ä–∞—Å—á—ë—Ç –±–µ–∑ IO: earnPercent √ó multiplier, promo-matching, COMBINEALL / MAXONLY / FIRSTONLY, —É—Å–ª–æ–≤–∏—è –ø—Ä–∞–≤–∏–ª (minCheckAmount, daysOfWeek, timeRange) |
| `loyalty-earn.service.ts` | Earn —Å idempotency (`posTransactionId`), DB-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π, –∑–∞–ø–∏—Å—å—é BallTransaction + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º GuestCard + –≤—ã–∑–æ–≤–æ–º level-check |
| `loyalty-redeem.service.ts` | Redeem —Å promo-first deduction, maxRedeemPercent-guard, –º–µ—Ç–æ–¥ `preview` –¥–ª—è POS pre-check |
| `loyalty-manual.service.ts` | MANUAL_ADD / MANUAL_REMOVE —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º reason ‚â• 5 —Å–∏–º–≤–æ–ª–æ–≤, max ¬±100 000 —à–∞—Ä–æ–≤ |
| `loyalty-level-recalc.service.ts` | `checkAndUpgrade` (inline –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ earn, **no-downgrade**) + CRON `@'5 0 * * *'` (00:05 –ú–°–ö) —Å batching –ø–æ 200 –∫–∞—Ä—Ç |
| `loyalty-expiry.service.ts` | CRON –∏–Ω–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ `01:00` –ú–°–ö (regularBalance ‚Üí 0 –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ N –¥–Ω–µ–π) + CRON dated `02:00` –ú–°–ö (FIFO expiry –ø–æ `expiresAt`) |
| `loyalty-engine.controller.ts` | REST: `POST earn`, `POST redeem/preview`, `POST redeem`, `POST cards/:id/adjust`, `POST cards/:id/recalc-level`, `POST admin/trigger-expiry` |
| `dto/*.dto.ts` | `EarnBallsBodyDto`, `RedeemBallsBodyDto`, `ManualAdjustBodyDto` —Å class-validator |

### –ö–ª—é—á–µ–≤—ã–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ –∏–∑ –±–µ—Å–µ–¥

- **Promo-first**: –ø—Ä–∏ redeem —Å–Ω–∞—á–∞–ª–∞ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è `promoBalance`, –∑–∞—Ç–µ–º `regularBalance`
- **No downgrade**: —É—Ä–æ–≤–µ–Ω—å —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ç—ë—Ç ‚Äî –Ω–∏ CRON, –Ω–∏ inline –Ω–µ –ø–æ–Ω–∏–∂–∞—é—Ç —É—Ä–æ–≤–µ–Ω—å
- **Idempotency**: `earn` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `idempotencyKey = earn:{tenantId}:{posTransactionId}` –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é
- **Conflict resolution**: `COMBINEALL` / `MAXONLY` / `FIRSTONLY` –∏–∑ `LoyaltySystem.conflictResolutionStrategy`
- **Rounding**: FLOOR –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –≤ –±–µ—Å–µ–¥–µ 5)
- **Audit trail**: –∫–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç `BallTransaction` —Å `balanceBefore/After`, `operatorId`, `reason`

***

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** Phase 6 ‚Äî POS Webhook Handler (`/webhooks/pos-transaction`) –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç `LoyaltyEarnService` –∏–∑ —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è. –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å?
<span style="display:none">[^25_1][^25_2][^25_3]</span>

<div align="center">‚ÅÇ</div>

[^25_1]: Beseda-11.md

[^25_2]: Beseda-6.md

[^25_3]: Beseda-5.md


---

# –ü—Ä–æ–¥–æ–ª–∂–∞–π, –≤ –ª—É—á—à–µ–º –ø–æ–ª–Ω–æ–º –≤–∏–¥–µ

**Phase 6: POS Integration** –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø—É—à–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π [Romslav/max-loyalty](https://github.com/Romslav/max-loyalty) –≤ –æ–¥–∏–Ω –∫–æ–º–º–∏—Ç [16f5c77](https://github.com/Romslav/max-loyalty/commit/16f5c7706b5a2a92028da016f90d84cdd31809db).

***

## –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ ‚Äî Phase 6: POS Integration

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (HYBRID PUSH/PULL)

| –°–ª–æ–π | –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| **Module** | `pos-integration.module.ts` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤, 3 BullMQ –æ—á–µ—Ä–µ–¥–∏ |
| **Adapter Interface** | `pos-adapter.interface.ts` | `IPosAdapter`, `StandardizedPosTransaction`, `PosItem` |
| **Adapter Factory** | `pos-adapter.factory.ts` | –ê–≤—Ç–æ-–≤—ã–±–æ—Ä –∞–¥–∞–ø—Ç–µ—Ä–∞ –ø–æ payload |
| **iiko Cloud 2.0** | `iiko-cloud.adapter.ts` | OAuth2 JSON, detect by `correlationId` |
| **iiko Server 1.0** | `iiko-server.adapter.ts` | Legacy JSON, detect by `check-id` |
| **R-Keeper** | `rkeeper.adapter.ts` | XML + JSON auto-detect, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π XML parser |
| **HMAC Guard** | `webhook-signature.guard.ts` | SHA-256, replay protection ¬±5 min |
| **Guest Identification** | `guest-identification.service.ts` | Phone ‚Üí posGuestId ‚Üí auto-create |
| **Webhook Processing** | `webhook-processing.service.ts` | SALE / REFUND / CANCEL + –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å Redis+DB |
| **Pull Sync** | `pull-sync.service.ts` | CRON `*/30 * * * *`, manual trigger rate-limit 1/10 min |
| **Reconciliation** | `reconciliation.service.ts` | CRON `03:00 Europe/Moscow`, –∞–≤—Ç–æ-—Ñ–∏–∫—Å ‚â§1%, –∞–ª–µ—Ä—Ç >5% |
| **Webhook Processor** | `webhook.processor.ts` | BullMQ concurrency=10 |
| **Pull Sync Processor** | `pull-sync.processor.ts` | BullMQ concurrency=5, failure counter ‚Üí DEGRADED/ERROR |
| **Reconciliation Processor** | `reconciliation.processor.ts` | BullMQ concurrency=1 |
| **Webhook Controller** | `pos-webhook.controller.ts` | `POST /webhooks/pos/transaction`, rate-limit 20/10s, 202 Accepted |
| **Admin Controller** | `pos-admin.controller.ts` | CRUD, test-connection, sync, reconcile, pause/resume |
| **DTOs** | `create-pos-integration.dto.ts`, `update-pos-integration.dto.ts` | class-validator + Swagger |

### –ö–ª—é—á–µ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

- **SALE**: guard ‚Üí queue ‚Üí adapter.parse ‚Üí guestIdentification ‚Üí prisma.posTransaction.create ‚Üí loyaltyEarn
- **REFUND**: –Ω–∞—Ö–æ–¥–∏—Ç original transaction ‚Üí –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π reversal balls ‚Üí –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ BallTransaction
- **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: Redis TTL 24h (`webhook:tenantId:posSystem:posCheckId`) + DB UNIQUE constraint fallback
- **Auto-create guest**: –µ—Å–ª–∏ `autoCreateGuestOnWebhook=true` –∏ –µ—Å—Ç—å phone ‚Üí —Å–æ–∑–¥–∞—ë—Ç User + GuestProfile + GuestCard + POSGuestLink –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- **Consecutive failures**: 3 –ø–æ–¥—Ä—è–¥ ‚Üí `DEGRADED`, 48 (24—á) ‚Üí `ERROR`, notifyAdmin (wire –≤ Phase 8)

***

## –°–ª–µ–¥—É—é—â–∏–µ –±–ª–æ–∫–∏

| \# | –ú–æ–¥—É–ª—å | –°—Ç–∞—Ç—É—Å |
| :-- | :-- | :-- |
| Phase 1 | Auth + RBAC | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Phase 2 | Loyalty System + Rules Engine | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Phase 3 | Guests + Loyalty Cards | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Phase 4 | Billing + Subscriptions | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Phase 5 | Notification System | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| **Phase 6** | **POS Integration (iiko/R-Keeper)** | ‚úÖ **–¢–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ** |
| Phase 7 | Analytics \& Reports | üîú –°–ª–µ–¥—É—é—â–∏–π |
| Phase 8 | Telegram Bot + Mini App | üîú |
| Phase 9 | Database Schema (Prisma) | üîú |
| Phase 10 | Frontend (React/Next.js) | üîú |

–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å **Phase 7 ‚Äî Analytics \& Reports**? –ò–ª–∏ —Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–∏—Ç—å **Prisma schema** –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π Phase 6 (POSIntegration, POSTransaction, POSSync, BallReconciliation, POSGuestLink)?
<span style="display:none">[^27_1][^27_2][^27_3]</span>

<div align="center">‚ÅÇ</div>

[^27_1]: Beseda-6.md

[^27_2]: Beseda-10.md

[^27_3]: Beseda-4.md


---

# –ü—Ä–æ–≤–µ—Ä—å –∫–æ–¥ —Ñ–∞–∑ 5 –∏ 6 –Ω–∞ –ø–æ–ª–Ω–æ—Ç—É, –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∏ –æ—à–∏–±–∫–∏, –≤—Å–µ –ª–∏ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã –∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ª–∏ –≤–∏–¥–µ

–¢–µ–ø–µ—Ä—å —É –º–µ–Ω—è –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞. –ü—Ä–æ–≤–æ–∂—É –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑.

***

## –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç Phase 5 –∏ Phase 6

### ‚ö†Ô∏è Phase 5 ‚Äî Notification System: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

**–ú–æ–¥—É–ª—å `notifications` –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –º–µ—Å—Ç–µ.**

`libs/notifications/` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ `.gitkeep` ‚Äî –ø—É—Å—Ç—É—é –∑–∞–≥–ª—É—à–∫—É. –í `apps/backend/src/modules/` –ø–∞–ø–∫–∏ `notifications` **–Ω–µ—Ç –≤–æ–æ–±—â–µ** . –í–µ—Å—å Phase 5 —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≤–∏–¥–µ –∫–æ–¥–∞ –∏–∑ —á–∞—Ç–∞, –Ω–æ –Ω–∏ –æ–¥–∏–Ω —Ñ–∞–π–ª –Ω–µ –±—ã–ª –∑–∞–ø—É—à–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.

***

### ‚ö†Ô∏è Phase 6 ‚Äî POS Integration: –ü–†–û–ë–õ–ï–ú–´ –° –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï–ú –ò –°–¢–†–£–ö–¢–£–†–û–ô

**–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã –∞–¥–∞–ø—Ç–µ—Ä–æ–≤ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö:**

–í `adapters/` –∫–æ—Ä–Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏:

- `iiko-adapter-v1.ts` ‚Äî **–¥—É–±–ª–∏–∫–∞—Ç**, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ `adapters/iiko/iiko-cloud.adapter.ts`
- `rkeeper-adapter-v1.ts` ‚Äî **–¥—É–±–ª–∏–∫–∞—Ç**, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ `adapters/rkeeper/rkeeper.adapter.ts`
- `pos-adapter-factory.service.ts` ‚Äî **–¥—É–±–ª–∏–∫–∞—Ç**, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ `adapters/pos-adapter.factory.ts`

–í `services/` —Å—É—â–µ—Å—Ç–≤—É—é—Ç **—Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã** –∏–∑ –ø—Ä–æ—à–ª–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ —Ä—è–¥–æ–º —Å –Ω–æ–≤—ã–º–∏:

- `pos-webhook.service.ts` ‚Äî —Å—Ç–∞—Ä—ã–π (9162 bytes), –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å –Ω–æ–≤—ã–º `webhook-processing.service.ts`
- `pos-pull-sync.service.ts` ‚Äî —Å—Ç–∞—Ä—ã–π (6646 bytes), –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å –Ω–æ–≤—ã–º `pull-sync.service.ts`
- `pos-reconciliation.service.ts` ‚Äî —Å—Ç–∞—Ä—ã–π (6620 bytes), –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å –Ω–æ–≤—ã–º `reconciliation.service.ts`
- `pos-guest-link.service.ts` ‚Äî —Å—Ç–∞—Ä—ã–π (4717 bytes), –Ω–µ—Ç –≤ –º–æ–¥—É–ª–µ
- `pos-hmac.service.ts` ‚Äî —Å—Ç–∞—Ä—ã–π (1304 bytes), –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ guard

**–ú–æ–¥—É–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `ScheduleModule`** –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –Ω–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ `imports[]`  ‚Äî —ç—Ç–æ –æ—à–∏–±–∫–∞, CRON –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

***

–ò—Å–ø—Ä–∞–≤–ª—è—é –≤—Å—ë –∑–∞ –æ–¥–∏–Ω –∫–æ–º–º–∏—Ç:

---

# –ò—Å–ø—Ä–∞–≤—å –≤—Å–µ. –§–∞–π–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –ø–æ–ª–Ω–æ–º –ø—Ä–æ–¥–∞–∫—à–Ω –≤–∏–¥–µ

–¢–µ–ø–µ—Ä—å –ø—É—à—É –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∏ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ñ–∞–π–ª—ã –æ–¥–Ω–∏–º –±–æ–ª—å—à–∏–º –∫–æ–º–º–∏—Ç–æ–º:

---

# –î–∞–≤–∞–π

–ù–∞—á–∏–Ω–∞—é –ø—É—à–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã. –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤–ª—è—é Phase 6, –∑–∞—Ç–µ–º —Å–æ–∑–¥–∞—é –ø–æ–ª–Ω—ã–π Phase 5.

---

# –°–¥–µ–ª–∞–µ–º –≤ 2 –∫–æ–º–∏—Ç–∞, –Ω–∞—á–∏–Ω–∞–π

–û—Ç–ª–∏—á–Ω–æ, —É –º–µ–Ω—è –≤—Å–µ –¥–∞–Ω–Ω—ã–µ. –¢–µ–ø–µ—Ä—å –ø—É—à—É –¥–≤–∞ –∫–æ–º–º–∏—Ç–∞: –ø–µ—Ä–≤—ã–π ‚Äî Phase 6 fix, –≤—Ç–æ—Ä–æ–π ‚Äî Phase 5 –ø–æ–ª–Ω–æ—Å—Ç—å—é.
<span style="display:none">[^32_1][^32_2]</span>

<div align="center">‚ÅÇ</div>

[^32_1]: Beseda-7.md

[^32_2]: Beseda-10.md


---

# –î–∞–≤–∞–π

–û–±–∞ –∫–æ–º–º–∏—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—à–µ–Ω—ã –≤ [`Romslav/max-loyalty`](https://github.com/Romslav/max-loyalty) –≤–µ—Ç–∫—É `main`.

***

## –ß—Ç–æ –∑–∞–ø—É—à–µ–Ω–æ

**–ö–æ–º–º–∏—Ç 1 ‚Äî `d9970cb`** ‚Äî Phase 6 Fix:

- `pos-integration.module.ts` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω `ScheduleModule.forRoot()` –≤ `imports[]`, —É–±—Ä–∞–Ω—ã –≤—Å–µ –¥—É–±–ª–∏–∫–∞—Ç—ã, –µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫ providers
- `guest-identification.service.ts` ‚Äî –ø–æ–≥–ª–æ—Ç–∏–ª –ª–æ–≥–∏–∫—É `pos-guest-link.service.ts`, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: posGuestId ‚Üí phone ‚Üí auto-create
- `pull-sync.service.ts` ‚Äî CRON `*/30 * * * *` + manual trigger —Å cooldown 10 –º–∏–Ω (Redis)
- `reconciliation.service.ts` ‚Äî CRON `0 3 * * *` + auto-fix ‚â§1% + alert >5% + `PosSyncLog`
- `pos-adapter.interface.ts` / `pos-adapter.factory.ts` ‚Äî –ø–æ–ª–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã + `resolveBySystem()`
- `webhook-signature.guard.ts` ‚Äî HMAC-SHA256 + replay protection ¬±5 –º–∏–Ω
- `webhook.processor.ts` / `pull-sync.processor.ts` / `reconciliation.processor.ts` ‚Äî BullMQ processors (concurrency 10/5/1)

**–ö–æ–º–º–∏—Ç 2 ‚Äî `a9bcf1d`** ‚Äî Phase 5 Notifications System:

- `notifications.module.ts` ‚Äî –ø–æ–ª–Ω—ã–π –º–æ–¥—É–ª—å, BullMQ + ScheduleModule
- `notification.service.ts` ‚Äî create / list / markRead / markAllRead / countUnread
- `notification-dispatch.service.ts` ‚Äî —Ä–æ—É—Ç–∏–Ω–≥ –∫–∞–Ω–∞–ª–æ–≤: Telegram (free) ‚Üí Email (Resend) ‚Üí SMS (SMS.ru) —Å fallback
- `template.service.ts` ‚Äî Handlebars, built-in –¥–µ—Ñ–æ–ª—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ + DB-override
- 3 –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞: Telegram (per-tenant bot token), Email (Resend API), SMS (SMS.ru)
- `notification.processor.ts` ‚Äî BullMQ concurrency=20
- `expiry-notification.job.ts` ‚Äî CRON 10:00 Moscow, –±–∞—Ç—á 200, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∑–∞ 30/14/7/3/1 –¥–µ–Ω—å + EXPIRE –≤—á–µ—Ä–∞—à–Ω–∏—Ö
- 2 –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞: guest inbox + preferences management

---

# –ü—Ä–æ–≤–µ—Ä—å –≤—Å–µ —Ñ–∞–∑—ã —á—Ç–æ –º—ã —Å —Ç–æ–±–æ–π —Å–¥–µ–ª–∞–ª–∏, –≤—Å–µ 6, –Ω–∞ –ø–æ–ª–Ω–æ—Ç—É –∫–æ–¥–∞ –æ—à–∏–±–∫–∏ –∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è. –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–Ω—ã–µ –ø—Ä–æ–¥–∞–∫—à–Ω –∫–æ–¥—ã

–ê—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –ö–æ–º–º–∏—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π `2b5e078` –∑–∞–ø—É—à–µ–Ω –≤ [`Romslav/max-loyalty`](https://github.com/Romslav/max-loyalty).

***

## –ò—Ç–æ–≥–∏ –ø–æ–ª–Ω–æ–≥–æ –∞—É–¥–∏—Ç–∞ –≤—Å–µ—Ö 6 —Ñ–∞–∑

### –ß—Ç–æ –±—ã–ª–æ –Ω–∞–π–¥–µ–Ω–æ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

**Phase 6 ‚Äî POS Integration: –ê–¥–∞–ø—Ç–µ—Ä—ã**


| –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª | –°—Ç–∞—Ç—É—Å |
| :-- | :-- | :-- |
| `canHandle()` –ø—Ä–∏–Ω–∏–º–∞–ª `contentType` –∫–∞–∫ 2-–π –ø–∞—Ä–∞–º–µ—Ç—Ä ‚Äî –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É `IPosAdapter` | `rkeeper.adapter.ts` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω |
| `parse()` –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–ª `context: AdapterContext` ‚Äî –Ω–∞—Ä—É—à–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ | –í—Å–µ 3 –∞–¥–∞–ø—Ç–µ—Ä–∞ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω |
| `paymentMethods` –≤–æ–∑–≤—Ä–∞—â–∞–ª—Å—è –∫–∞–∫ `string[]` –≤–º–µ—Å—Ç–æ `PaymentMethodEntry[]` | `iiko-cloud`, `iiko-server` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω |
| –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ –º–µ—Ç–æ–¥—ã `fetchTransactions()` –∏ `testConnection()` | –í—Å–µ 3 –∞–¥–∞–ø—Ç–µ—Ä–∞ | ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã |
| `posSystem` = `'IIKOCLOUD'` –≤–º–µ—Å—Ç–æ `'IIKO_CLOUD'` (–Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ enum) | `iiko-cloud.adapter.ts` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω |

**Phase 6 ‚Äî POS Integration: –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏ —Å–µ—Ä–≤–∏—Å—ã**


| –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª | –°—Ç–∞—Ç—É—Å |
| :-- | :-- | :-- |
| `pullSyncService.triggerManualSync()` ‚Äî –º–µ—Ç–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `triggerManual()` | `pos-admin.controller.ts` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω |
| `reconciliationService.runDailyReconciliation()` ‚Äî –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `triggerManual(id, date)` | `pos-admin.controller.ts` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω |
| `this.prisma.posSync` ‚Äî –º–æ–¥–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å `posSyncLog` | `pos-admin.controller.ts` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω |
| `this.prisma.ballReconciliation` ‚Äî –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `posReconciliationAlert` | `pos-admin.controller.ts` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω |
| `pos-integration.controller.ts` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `PosPullSyncService` / `PosReconciliationService` –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ module providers | `pos-integration.controller.ts` | ‚úÖ –ü–æ–º–µ—á–µ–Ω deprecated |
| 4 —Å—Ç–∞—Ä—ã—Ö —Å–µ—Ä–≤–∏—Å–∞ (`pos-pull-sync`, `pos-reconciliation`, `pos-webhook`, `pos-guest-link`) ‚Äî –Ω–µ –≤ module, –Ω–æ –Ω–µ —É–¥–∞–ª–µ–Ω—ã, —Å–æ–∑–¥–∞–≤–∞–ª–∏ –ø—É—Ç–∞–Ω–∏—Ü—É | –í—Å–µ 4 —Ñ–∞–π–ª–∞ | ‚úÖ –ó–∞–º–µ–Ω–µ–Ω—ã deprecated-—Å—Ç–∞–±–∞–º–∏ |

**Phase 5 ‚Äî Notifications**


| –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª | –°—Ç–∞—Ç—É—Å |
| :-- | :-- | :-- |
| `ConfigModule` –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ `NotificationsModule`, —Ö–æ—Ç—è `EmailNotificationProvider` –∏ `SmsNotificationProvider` –∏—Å–ø–æ–ª—å–∑—É—é—Ç `ConfigService` | `notifications.module.ts` | ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `ConfigModule` |
| –û–±–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –Ω–µ –∏–º–µ–ª–∏ `@UseGuards(JwtAuthGuard)` ‚Äî —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –±—ã–ª–∏ –ø—É–±–ª–∏—á–Ω—ã–º–∏ | `notifications.controller.ts`, `notification-preferences.controller.ts` | ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω guard |
| `AuthRequest` —Ç–∏–ø —Å—Ç—Ä–æ–∏–ª—Å—è —á–µ—Ä–µ–∑ `Request & {...}` –±–µ–∑ –∞–ª–∏–∞—Å–∞ ‚Äî –Ω–µ—É–¥–æ–±–Ω–æ | –û–±–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ | ‚úÖ –í—ã–Ω–µ—Å–µ–Ω –≤ `type AuthRequest` |


***

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö —Ñ–∞–∑

- **Phase 1** (Tenants/Auth/RBAC) ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–µ—Ä–Ω–∞—è, —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
- **Phase 2** (Guests/Users) ‚Äî —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
- **Phase 3** (LoyaltyEngine: earn/redeem/expiry/levels/manual) ‚Äî 6 —Å–µ—Ä–≤–∏—Å–æ–≤, –≤—Å–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
- **Phase 4** (LoyaltySystem CRUD) ‚Äî –º–æ–¥—É–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- **Phase 5** (Notifications) ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω
- **Phase 6** (POS Integration) ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω


### –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏)

- **4 deprecated-—Ñ–∞–π–ª–∞** (`pos-pull-sync.service.ts`, `pos-reconciliation.service.ts`, `pos-webhook.service.ts`, `pos-guest-link.service.ts`) ‚Äî —Å—Ç–æ–∏—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—å –≤ Phase 7, —Å–µ–π—á–∞—Å –æ–Ω–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ `export {}` –∏ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Å–±–æ—Ä–∫—É
- **`pos-integration.service.ts`** –º–µ—Ç–æ–¥ `testConnection()` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≥–ª—É—à–∫—É (stub), –Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∞–¥–∞–ø—Ç–µ—Ä—ã –≤ Phase 7
- **`pos-integration.controller.ts`** (—Å—Ç–∞—Ä—ã–π) ‚Äî –ø–æ–º–µ—á–µ–Ω deprecated, –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –º–æ–¥—É–ª–µ, —É–¥–∞–ª–∏—Ç—å –≤ Phase 7

