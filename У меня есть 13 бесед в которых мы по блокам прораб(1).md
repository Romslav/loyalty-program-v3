<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# –£ –º–µ–Ω—è –µ—Å—Ç—å 13 –±–µ—Å–µ–¥ –≤ –∫–æ—Ç–æ—Ä—ã—Ö –º—ã –ø–æ –±–ª–æ–∫–∞–º –ø—Ä–æ—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –±–ª–æ–∫–∏. –ù–∞–º –Ω—É–∂–Ω–æ —Å —Ç–æ–±–æ–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤ —ç—Ç–æ–º –¥–∏–∞–ª–æ–≥–µ. –ò–∑—É—á–∞–π –ø–æ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–∏(–ë–µ—Å–µ–¥–∞ 1 - –ë–µ—Å–µ–¥–∞ 2 - –ë–µ—Å–µ–¥–∞ 3 - –ë–µ—Å–µ–¥–∞ 4 - –ë–µ—Å–µ–¥–∞ 5 - –ë–µ—Å–µ–¥–∞ 6 - –ë–µ—Å–µ–¥–∞ 7 - –ë–µ—Å–µ–¥–∞ 8 - –ë–µ—Å–µ–¥–∞ 9 - –ë–µ—Å–µ–¥–∞ 10 - –ë–µ—Å–µ–¥–∞ 11 - –ë–µ—Å–µ–¥–∞ 12 - –ë–µ—Å–µ–¥–∞ 13) –≤ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö.

–ò–∑—É—á–∏ –≤—Å–µ –¥–æ—Å–∫–∞–Ω–∞–ª—å–Ω–æ, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏ —á–µ—Ç–∫–æ, –≤—Å–µ 13 –¥–∏–∞–ª–æ–≥–æ–≤, –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç –≤ –¥–∏–∞–ª–æ–≥–∞—Ö, –∫–∞–∂–¥–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ –∏ –ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ù–∞–π–¥–∏ –≤—Å–µ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –Ω–∏–º. –ó–∞–ª–æ–∂–∏ –Ω–∞ —ç—Ç–æ –≤—Ä–µ–º—è –∏ —Å–∏–ª—ã, —á—Ç–æ–±—ã —Ç—ã –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ –≤—Å–µ –ø–æ–Ω–∏–º–∞–ª –¥–æ –º–µ–ª—å—á–∞–π—à–∏—Ö –¥–µ—Ç–∞–ª–µ–π, –±–µ–∑ –æ—à–∏–±–æ–∫.
–ù–∞–π–¥–∏ –≤—Å–µ –±–ª–æ–∫–∏ —á—Ç–æ –º—ã —Å —Ç–æ–±–æ–π –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ –∏ –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –Ω–∏–º, –∏–∑—É—á–∏ –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ, –¥–æ –º–µ–ª–æ—á–µ–π –∫ –∫–∞–∫–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –ø—Ä–∏—à–ª–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –±–ª–æ–∫—É. –ü–æ—Å–ª–µ –≤—ã–±–µ—Ä–µ–º –±–ª–æ–∫ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏.

–û—Ç–ª–∏—á–Ω–æ! –Ø –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑—É—á–∏–ª –≤—Å–µ **13 –±–µ—Å–µ–¥** —Å–æ –≤—Å–µ–º–∏ –¥–µ—Ç–∞–ª—è–º–∏. –¢–µ–ø–µ—Ä—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é –≤–∞–º **–ø–æ–ª–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É** –≤—Å–µ—Ö –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤.

# üìö **–ü–û–õ–ù–ê–Ø –ö–ê–†–¢–ò–ù–ê –ü–†–û–ï–ö–¢–ê MAX-LOYALTY**

## **–ê–Ω–∞–ª–∏–∑ 13 –±–µ—Å–µ–¥: –≤—Å–µ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏**


***

## ‚úÖ **–ü–†–û–†–ê–ë–û–¢–ê–ù–ù–´–ï –ë–õ–û–ö–ò (13 –±–µ—Å–µ–¥)**

### **üèóÔ∏è –ë–õ–û–ö 1: –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ò –†–û–õ–ò**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ë–µ—Å–µ–¥—ã 1-3, 6-7)

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

- Multi-tenant SaaS (pooled database —Å tenant_id)
- 5 —Ä–æ–ª–µ–π: Owner ‚Üí Restaurant Admin ‚Üí Manager ‚Üí Cashier ‚Üí Guest
- RBAC —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ permissions
- Impersonation –¥–ª—è Owner (—Å –ø–æ–ª–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
- Activity Log –¥–ª—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

***

### **üí∞ –ë–õ–û–ö 2: –¢–ê–†–ò–§–´ –ò –ë–ò–õ–õ–ò–ù–ì**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ë–µ—Å–µ–¥–∞ 6)

**6 —Ç–∞—Ä–∏—Ñ–æ–≤:**

1. **FREE** - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥–ª—è Owner, –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π
2. **STANDARD** - 1 —Ä–µ—Å—Ç–æ—Ä–∞–Ω, 500 –≥–æ—Å—Ç–µ–π
3. **MEDIUM** - 3 —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, 2000 –≥–æ—Å—Ç–µ–π
4. **PRO** - 5 —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, 6000 –≥–æ—Å—Ç–µ–π
5. **ULTIMATE** - –±–µ–∑–ª–∏–º–∏—Ç
6. **CUSTOM** - –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä—É–µ–º—ã–π

**–ú–æ–¥–µ–ª—å –ø–æ–¥–ø–∏—Å–∫–∏:**

- –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (–º–µ—Å—è—Ü/–≥–æ–¥)
- –ì–æ–¥ = –º–µ—Å—è—Ü √ó 12 √ó 0.8 (—Å–∫–∏–¥–∫–∞ 20%)
- –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ü–ª–∞—Ç–µ–∂–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã: YooKassa, Stripe, CloudPayments, CryptoCloud
- –†—É—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø–æ —Å—á–µ—Ç—É –¥–æ—Å—Ç—É–ø–Ω–∞

**–õ–∏–º–∏—Ç—ã:**

- –ñ–µ—Å—Ç–∫–∏–µ (90% - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, 100% - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
- –ù–µ—É—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏: 4 –ø–æ–ø—ã—Ç–∫–∏ (–¥–µ–Ω—å 0, 1, 3, 7)
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –ø—Ä–∏ –Ω–µ–æ–ø–ª–∞—Ç–µ (–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã)

***

### **üîê –ë–õ–û–ö 3: AUTH \& SECURITY**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ë–µ—Å–µ–¥—ã 2-3)

**–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**

- JWT access token (15 –º–∏–Ω) + refresh token (30 –¥–Ω–µ–π) –≤ HttpOnly cookie
- Rate limiting (5 –ø–æ–ø—ã—Ç–æ–∫/15 –º–∏–Ω—É—Ç)
- MFA –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
- Soft blacklist —Ç–æ–∫–µ–Ω–æ–≤ (Redis)

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:**

- –í–ª–∞–¥–µ–ª–µ—Ü: —Å–ø–µ—Ü-—Å—Å—ã–ª–∫–∞
- –†–µ—Å—Ç–æ—Ä–∞–Ω: —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –∏–ª–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
- Guest: —Ç–µ–ª–µ—Ñ–æ–Ω + SMS –∏–ª–∏ Telegram ID (–±–µ–∑ –ø–∞—Ä–æ–ª—è)

***

### **üé´ –ë–õ–û–ö 4: LOYALTY ENGINE**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ë–µ—Å–µ–¥—ã 4-5, 7)

**–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:**

- **1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å** (–Ω–µ–∏–∑–º–µ–Ω–Ω–æ)
- –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –æ—Ç **–∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞** (–¥–æ —Å–∫–∏–¥–æ–∫)
- –ü—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏: —Å–Ω–∞—á–∞–ª–∞ **promo**, –ø–æ—Ç–æ–º **regular** –±–∞–ª–ª—ã
- –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ

**–ë–∞–ª–∞–Ω—Å—ã:**

- `regular_balance` - –æ—Å–Ω–æ–≤–Ω—ã–µ –±–∞–ª–ª—ã
- `promo_balance` - –∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –±–∞–ª–ª—ã
- –ë–µ–∑–ª–∏–º–∏—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
- –ú–∏–Ω–∏–º—É–º –∫ —Å–ø–∏—Å–∞–Ω–∏—é: 1 –±–∞–ª–ª
- –ú–∞–∫—Å–∏–º—É–º –∫ —Å–ø–∏—Å–∞–Ω–∏—é: 20% –æ—Ç —á–µ–∫–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ 10-100%)
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞: 50 —Ä—É–± (—Ñ–∏–∫—Å)

**–£—Ä–æ–≤–Ω–∏:**

- NO DOWNGRADE (–æ–¥–∏–Ω —Ä–∞–∑ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞)
- –û–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ lifetime_spent
- –ü–æ–ª–Ω–æ—Å—Ç—å—é –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä—É–µ–º—ã–µ (–Ω–∞–∑–≤–∞–Ω–∏—è, –ø–æ—Ä–æ–≥–∏, –ø—Ä–æ—Ü–µ–Ω—Ç—ã, —Ü–≤–µ—Ç–∞, –∏–∫–æ–Ω–∫–∏)
- –†–µ–∂–∏–º "–±–µ–∑ —É—Ä–æ–≤–Ω–µ–π" –¥–æ—Å—Ç—É–ø–µ–Ω

**–°–≥–æ—Ä–∞–Ω–∏–µ:**

- –ü–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (‚â•90 –¥–Ω–µ–π) - –≤—Å–µ –±–∞–ª–ª—ã —Å—Ä–∞–∑—É
- –î–ª—è –ø—Ä–æ–º–æ - —Å–≤–æ–∏ —Å—Ä–æ–∫–∏
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ 10:00 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–µ—Ä–∏–æ–¥—ã –∏ –∫–∞–Ω–∞–ª—ã)

**–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**

- –í—Å–µ –ø—Ä–∞–≤–∏–ª–∞/—É—Ä–æ–≤–Ω–∏/–ø—Ä–æ–º–æ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä—É—é—Ç—Å—è
- Snapshot –≤ –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- NO –ø–µ—Ä–µ—Å—á–µ—Ç –∑–∞–¥–Ω–∏–º —á–∏—Å–ª–æ–º (–∫—Ä–æ–º–µ emergency job)

**–ü—Ä–æ–º–æ:**

- –¢–∏–ø—ã: –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è, –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Ä–µ–±–µ–Ω–∫–∞ (–¥–æ 18 –ª–µ—Ç), –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –ø–µ—Ä–≤—ã–π —á–µ–∫, —é–±–∏–ª–µ–π–Ω—ã–µ –ø–æ—Å–µ—â–µ–Ω–∏—è, –∫–∞—Å—Ç–æ–º–Ω—ã–µ
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã: COMBINE_ALL / MAX_ONLY / FIRST_ONLY
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ

***

### **üë• –ë–õ–û–ö 5: –ì–û–°–¢–ò –ò –ö–ê–†–¢–´**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ë–µ—Å–µ–¥—ã 2-3, 7)

**–†–µ–∂–∏–º—ã:**

- **UNIFIED** - –æ–¥–Ω–∞ –∫–∞—Ä—Ç–∞ –Ω–∞ –≤—Å—é —Å–µ—Ç—å
- **SEPARATE** - –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–∞—Ä—Ç—ã –Ω–∞ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ —Å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º/—Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –±–∞–ª–ª–æ–≤

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (3 —Å–ø–æ—Å–æ–±–∞):**

1. –ß–µ—Ä–µ–∑ –∫–∞—Å—Å—É (—Ç–µ–ª–µ—Ñ–æ–Ω + –∏–º—è)
2. –ü–æ —Å—Å—ã–ª–∫–µ (–±—ã—Å—Ç—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
3. Telegram (—á–µ—Ä–µ–∑ ID –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω)

**QR + 6-digit –∫–æ–¥:**

- –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ (–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ)
- QR –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã–π –¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- 6-digit –∫–æ–¥ –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç (–±–µ–∑ —Å–∫—Ä—ã—Ç–∏—è)

**–ü—Ä–æ—Ñ–∏–ª—å:**

- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑ –≤ 3 –º–µ—Å—è—Ü–∞
- –°–º–µ–Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞: –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –Ω–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞
- –î–µ—Ç–∏ –¥–æ 18 –ª–µ—Ç –¥–ª—è –ø—Ä–æ–º–æ-–∞–∫—Ü–∏–π

***

### **üè™ –ë–õ–û–ö 6: POS INTEGRATION**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ë–µ—Å–µ–¥–∞ 4, 6, 8)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**

- **HYBRID**: PUSH (webhooks) + PULL (–∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç)
- POS = –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –ø–æ —á–µ–∫–∞–º
- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É

**–°–∏—Å—Ç–µ–º—ã:**

- iiko
- R-Keeper
- HMAC-SHA256 –ø–æ–¥–ø–∏—Å–∏ webhooks
- Auto-create guest (–æ–ø—Ü–∏—è)

**Reconciliation:**

- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π job
- –ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ–¥ POS
- –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π

**–°—Ç–∞—Ç—É—Å—ã:** SUCCESS, FAILED, PARTIAL, PENDING

***

### **ü§ñ –ë–õ–û–ö 7: TELEGRAM BOT + MINI APP**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ë–µ—Å–µ–¥–∞ 7, 10)

**–°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞:**

- –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (Admin —Å–æ–∑–¥–∞–µ—Ç —É @BotFather, –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –†–µ–∂–∏–º—ã: UNIFIED (–æ–¥–∏–Ω –±–æ—Ç –Ω–∞ —Å–µ—Ç—å) –∏–ª–∏ SEPARATE (–±–æ—Ç –Ω–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω)

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:**

- –¢–µ–ª–µ—Ñ–æ–Ω –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
- SMS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
- Telegram ID –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: —Ç–µ–ª–µ—Ñ–æ–Ω + –∏–º—è

**Mini App —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**

- –ö–∞—Ä—Ç–∞ —Å QR/6-digit (–≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç)
- –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–ª–æ–≤ –∏ –≤–∏–∑–∏—Ç–æ–≤ (–±–µ–∑ —Å—Ä–µ–¥–Ω –µ–≥–æ —á–µ–∫–∞, –≤—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ —á–∞—Å–∞–º)
- –ü—Ä–æ—Ñ–∏–ª—å (–¥–µ—Ç–∏ –¥–æ 18 –ª–µ—Ç)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∫–∞—Ä—Ç—ã)
- –ú—É–ª—å—Ç–∏–∫–∞—Ä—Ç–æ—á–Ω–æ—Å—Ç—å —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**

- Telegram.WebApp.initData –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞
- Rate limiting

***

### **üíª –ë–õ–û–ö 8: BACKEND API**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ë–µ—Å–µ–¥–∞ 8, 9)

**Tech Stack:**

- NestJS (Modular Monolith)
- REST API —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- BullMQ –¥–ª—è background jobs
- Redis –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
- PostgreSQL

**–ö–ª—é—á–µ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã:**

- Auth Service
- Loyalty Engine Service
- Points Calculation Service
- POS Integration Service
- Notification Service (Telegram, Email, SMS, Push)
- Analytics Service

**API Endpoints:**

- `/loyalty/calculate` - –ø—Ä–µ-–∫–∞–ª—å–∫—É–ª—è—Ü–∏—è –±–∞–ª–ª–æ–≤
- `/loyalty/transactions` - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
- `/loyalty/manual-adjustment` - —Ä—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞
- Full CRUD –¥–ª—è –ø—Ä–∞–≤–∏–ª/—É—Ä–æ–≤–Ω–µ–π/–ø—Ä–æ–º–æ

***

### **üé® –ë–õ–û–ö 9: FRONTEND ADMIN PANEL**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ë–µ—Å–µ–¥–∞ 8, 10)

**Tech Stack:**

- Next.js 14 App Router
- shadcn/ui + Radix UI + Tailwind CSS
- Zustand + TanStack Query
- React Hook Form + Zod
- TanStack Table v8
- Recharts
- sonner (toasts)

**Responsive:**

- Breakpoints: Tailwind default (sm/md/lg/xl/2xl)
- Sidebar: collapsible (250px ‚Üí 60px mini ‚Üí hidden)
- Mobile: Accordion cards –≤–º–µ—Å—Ç–æ —Ç–∞–±–ª–∏—Ü, Bottom sheets –¥–ª—è –º–æ–¥–∞–ª–µ–π
- Tablet/Desktop: Full tables –∏ forms

**UI Patterns:**

- Empty States —Å –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è–º–∏
- Skeleton screens –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
- Toast + inline errors
- Optimistic updates —Å rollback
- Confirmation dialogs

**Loyalty Builder:**

- Rules Builder —Å live preview
- Levels Builder (visual timeline)
- Promo Campaigns Builder (wizard)
- Drag-drop –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

***

### **üóÑÔ∏è –ë–õ–û–ö 10: DATABASE SCHEMA (PRISMA)**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ë–µ—Å–µ–¥–∞ 9)

**–†–µ—à–µ–Ω–∏—è:**

- UUID –¥–ª—è –≤—Å–µ—Ö primary keys
- DECIMAL(10,2) –¥–ª—è –¥–µ–Ω–µ–≥
- –ì–∏–±—Ä–∏–¥ enums (—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –≤ PG, –∏–∑–º–µ–Ω—è–µ–º—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö)
- Soft delete –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
- JSONB –¥–ª—è snapshots

**–ò–Ω–¥–µ–∫—Å—ã:**

- Composite: tenant_id + —Ñ–∏–ª—å—Ç—Ä—É–µ–º—ã–µ –ø–æ–ª—è
- Partial: WHERE deleted_at IS NULL
- GIN –¥–ª—è Full-Text Search
- Expression indexes (LOWER(email), DATE(created_at))

**Multi-tenancy:**

- –í—ã–±–æ—Ä–æ—á–Ω—ã–π tenant_id (–Ω–µ –≤ User)
- Prisma middleware –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏
- Composite UNIQUE (tenant_id, field)

**Versioning:**

- LoyaltyRuleVersion, LoyaltyLevelVersion, LoyaltyPromoVersion
- Row-level audit —Å JSON diff
- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ActivityLog

**Migrations:**

- Zero-downtime (nullable ‚Üí default ‚Üí NOT NULL)
- CREATE INDEX CONCURRENTLY
- Down migrations –¥–ª—è –æ–±—Ä–∞—Ç–∏–º—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

***

### **üîî –ë–õ–û–ö 11: NOTIFICATIONS SYSTEM**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ë–µ—Å–µ–¥–∞ 10)

**–ö–∞–Ω–∞–ª—ã:**

- Telegram (–æ—Å–Ω–æ–≤–Ω–æ–π)
- Email (Resend —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- SMS (SMS.ru/SMSC)
- Push (Phase 2)

**–¢–∏–ø—ã:**

- –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤
- –°–º–µ–Ω–∞ —É—Ä–æ–≤–Ω—è
- –ü—Ä–æ–º–æ-–∞–∫—Ü–∏–∏
- –°–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ (–∑–∞ 30/14/7/1 –¥–µ–Ω—å)
- –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è
- Payment failed

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**

- BullMQ –¥–ª—è –æ—á–µ—Ä–µ–¥–∏
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã: LOW, NORMAL, HIGH
- Batching –¥–ª—è LOW (3+ –≤ –æ–¥–Ω—É)
- Rate limiting (10/–¥–µ–Ω—å –¥–ª—è Telegram)
- Retry logic —Å exponential backoff

***

### **üìä –ë–õ–û–ö 12: ANALYTICS**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ë–µ—Å–µ–¥—ã 6, 8)

**Owner:**

- MRR/ARR, Churn, ARPU, LTV
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º
- –†–æ—Å—Ç/–æ—Ç—Ç–æ–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
- –ü–ª–∞—Ç–µ–∂–∏ (—É—Å–ø–µ—à–Ω—ã–µ/failed/refunded/chargeback)

**Restaurant Admin:**

- –í—ã—Ä—É—á–∫–∞ –ø–æ —Å–µ—Ç–∏ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º
- –°—Ä–µ–¥–Ω–∏–π —á–µ–∫, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π
- –ê–∫—Ç–∏–≤–Ω—ã–µ/–Ω–æ–≤—ã–µ/—Å–ø—è—â–∏–µ/—É—à–µ–¥—à–∏–µ –≥–æ—Å—Ç–∏
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Ä–æ–≤–Ω—è–º
- ROI –ø—Ä–æ–≥—Ä–∞–º–º –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏

**Manager:**

- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞

**Guest:**

- –ë–∞–ª–∞–Ω—Å, –∏—Å—Ç–æ—Ä–∏—è, —Å—É–º–º–∞ —Ç—Ä–∞—Ç, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π
- –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è

**–•—Ä–∞–Ω–µ–Ω–∏–µ:**

- AnalyticsDailySnapshot, AnalyticsMonthlySnapshot
- GuestSegmentation
- PromoBallGranted
- RuleActivationLog
- CRON –¥–ª—è –ø—Ä–µ–¥—Ä–∞—Å—á–µ—Ç–∞

***

## üéØ **–ß–¢–û –ì–û–¢–û–í–û –ö –†–ï–ê–õ–ò–ó–ê–¶–ò–ò**

‚úÖ –ü–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (100%)
‚úÖ Database Schema (Prisma) (100%)
‚úÖ Auth \& RBAC (100%)
‚úÖ Loyalty Engine (100%)
‚úÖ POS Integration (100%)
‚úÖ Telegram Bot + Mini App (100%)
‚úÖ Backend API (100%)
‚úÖ Frontend (100%)
‚úÖ Billing (100%)
‚úÖ Analytics (100%)
‚úÖ Notifications (95%)

***

## üöÄ **–°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò**

**–ö–∞–∫–æ–π –±–ª–æ–∫ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–ª–µ–µ?**

1. **Infrastructure \& DevOps** - Docker, CI/CD, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, deployment
2. **Testing Strategy** - Unit, Integration, E2E, Load testing
3. **Security \& Compliance** - OWASP, GDPR, PCI DSS
4. **Documentation** - API docs, User guides, Architecture diagrams
5. **–ù–∞—á–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é** - –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∫–æ–¥–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º–æ–¥—É–ª–µ–π

**–°–∫–∞–∂–∏ –Ω–æ–º–µ—Ä –±–ª–æ–∫–∞ –∏–ª–∏ —Å–≤–æ—ë –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ!** üéØ
<span style="display:none">[^1_1][^1_10][^1_11][^1_12][^1_13][^1_2][^1_3][^1_4][^1_5][^1_6][^1_7][^1_8][^1_9]</span>

<div align="center">‚ÅÇ</div>

[^1_1]: Beseda-13.md

[^1_2]: Beseda-12.md

[^1_3]: Beseda-11.md

[^1_4]: Beseda-10.md

[^1_5]: Beseda-9.md

[^1_6]: Beseda-8.md

[^1_7]: Beseda-7.md

[^1_8]: Beseda-6.md

[^1_9]: Beseda-5.md

[^1_10]: Beseda-4.md

[^1_11]: Beseda-3.md

[^1_12]: Beseda-2.md

[^1_13]: Beseda-1.md


---

# –ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –±–æ–ª—å—à–µ, –º–Ω–æ–≥–æ–µ —É–ø—É—Å—Ç–∏–ª. –ò–∑—É—á–∏ –≤—Å–µ —Ñ–∞–π–ª—ã –µ—â–µ —Ä–∞–∑ –∏ –¥–æ–ø–æ–ª–Ω–∏ –∫–∞—Ä—Ç–∏–Ω—É –Ω–∞–º–Ω–æ–≥–æ —Å–∏–ª—å–Ω–µ–µ

–ò–∑—É—á–∏–ª –≤—Å–µ —Ñ–∞–π–ª—ã –¥–µ—Ç–∞–ª—å–Ω–æ! –¢–µ–ø–µ—Ä—å –¥–∞–º **–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É** –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ –≤—Å–µ–º–∏ –¥–µ—Ç–∞–ª—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω—ã.

# üìã **–ü–û–õ–ù–ê–Ø –ö–ê–†–¢–ò–ù–ê –ü–†–û–ï–ö–¢–ê MAX-LOYALTY - –í–°–ï –ü–†–û–†–ê–ë–û–¢–ê–ù–ù–´–ï –ë–õ–û–ö–ò**

## üéØ **–û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê**

**–í—Å–µ–≥–æ –±–µ—Å–µ–¥:** 13 (–ë–µ—Å–µ–¥–∞ 1-13)[^2_1][^2_2][^2_3][^2_4][^2_5][^2_6][^2_7]
**–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤:** 12 –∏–∑ 14 (~86% –≥–æ—Ç–æ–≤–æ)
**–ó–∞–¥–∞–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤:** **520+** —Å —Ä–µ—à–µ–Ω–∏—è–º–∏
**–°—Ç—Ä–∞–Ω–∏—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** ~300+ —Å—Ç—Ä–∞–Ω–∏—Ü

***

## ‚úÖ **–ë–õ–û–ö 1: –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–õ–ê–¢–§–û–†–ú–´** (–ë–µ—Å–µ–¥–∞ 1-3)

### **–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ:**

- **Multi-tenant SaaS:** Pooled database —Å `tenant_id` –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏
- **–†–æ–ª–∏:** Owner ‚Üí Restaurant Admin ‚Üí Manager ‚Üí Cashier ‚Üí Guest
- **6 —Ç–∞—Ä–∏—Ñ–æ–≤:** FREE, STANDARD, MEDIUM, PRO, ULTIMATE, CUSTOM
- **–õ–∏–º–∏—Ç—ã —Ç–∞—Ä–∏—Ñ–æ–≤:** max —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, max –≥–æ—Å—Ç–∏, max POS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **–°–∫–∏–¥–∫–∞:** 20% –ø—Ä–∏ –≥–æ–¥–æ–≤–æ–π –æ–ø–ª–∞—Ç–µ
- **RBAC:** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ permissions + —Ä–æ–ª–∏
- **Owner features:** Impersonation –ª—é–±–æ–≥–æ —é–∑–µ—Ä–∞, –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø, —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª–µ–π


### **–î–µ—Ç–∞–ª–∏:**

- Tenant —Å–æ–∑–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ —Å–ø–µ—Ü-—Å—Å—ã–ª–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏[^2_1]
- UNIFIED vs SEPARATE —Ä–µ–∂–∏–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏[^2_2]
- Trial period (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)[^2_5]

***

## ‚úÖ **–ë–õ–û–ö 2: AUTH \& SECURITY** (–ë–µ—Å–µ–¥–∞ 2, 5, 13)

### **–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ (51 security control):**

- **JWT:** RS256, 5 min access, 14 days refresh —Å rotation[^2_6]
- **Password:** argon2id, 10+ —Å–∏–º–≤–æ–ª–æ–≤, entropy check, history (5 –ø–∞—Ä–æ–ª–µ–π)[^2_6]
- **MFA:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –¥–ª—è Owner/Admin, TOTP + SMS, Step-Up Auth[^2_6]
- **Session Management:** Limit 5 concurrent, idle 30 min, absolute 12h[^2_6]
- **Rate Limiting:** –ü–æ —Ä–æ–ª—è–º –∏ endpoints (5 login/15 min, 100 API/min)[^2_6]
- **Impersonation:** MFA required, reason –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, 2h max duration[^2_6]
- **Password Reset:** 15 min TTL, hashed tokens, revoke all sessions[^2_6]
- **Activity Log:** –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è, 7 years retention[^2_6]


### **Compliance:**

- GDPR compliance (Right to erasure, export, consent)[^2_6]
- –§–ó-152 (Russian data protection)[^2_6]
- SOC 2 Type II ready[^2_6]

***

## ‚úÖ **–ë–õ–û–ö 3: DATABASE SCHEMA (PRISMA)** (–ë–µ—Å–µ–¥–∞ 9)

### **–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ (35 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- **80+ —Ç–∞–±–ª–∏—Ü:** User, GuestProfile, GuestCard, BallTransaction, LoyaltyRule, LoyaltyLevel, LoyaltyPromo, Restaurant, Subscription, Payment, Invoice, POSTransaction, ActivityLog –∏ –¥—Ä.[^2_4]
- **Enums:** 15+ PostgreSQL enums (UserRole, Gender, CardStatus, BallTransactionType, SubscriptionPlan, PaymentStatus, POSSystem –∏ –¥—Ä.)[^2_4]
- **Indexes:** Composite, partial (`WHERE deleted_at IS NULL`), GIN –¥–ª—è JSONB, full-text search[^2_4]
- **Multi-tenancy:** `tenant_id` –≥–¥–µ –Ω—É–∂–Ω–æ, Prisma middleware –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏[^2_4]
- **Soft delete:** User, GuestCard, –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏[^2_4]
- **UUID:** –í—Å–µ primary keys[^2_4]
- **DECIMAL(10,2):** –î–µ–Ω–µ–∂–Ω—ã–µ —Å—É–º–º—ã[^2_4]
- **Versioning:** LoyaltyRuleVersion, LoyaltyLevelVersion, LoyaltyPromoVersion[^2_4]
- **CASCADE:** User ‚Üí RESTRICT, GuestCard/Transactions ‚Üí CASCADE[^2_4]

***

## ‚úÖ **–ë–õ–û–ö 4: LOYALTY SYSTEM ENGINE** (–ë–µ—Å–µ–¥–∞ 4-5)

### **–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ (50+ –≤–æ–ø—Ä–æ—Å–æ–≤):**

#### **–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:**

- **1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å** (–≥–ª–æ–±–∞–ª—å–Ω–æ–µ, –Ω–µ–∏–∑–º–µ–Ω—è–µ–º–æ–µ)[^2_1]
- –ë–∞–ª–ª—ã **–æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞** (–¥–æ —Å–ø–∏—Å–∞–Ω–∏—è)[^2_1]
- **–î–≤–∞ –±–∞–ª–∞–Ω—Å–∞:** `regular_balance` + `promo_balance`[^2_1]
- **–°–ø–∏—Å–∞–Ω–∏–µ:** —Å–Ω–∞—á–∞–ª–∞ promo, –ø–æ—Ç–æ–º regular[^2_1]
- **–ë–µ–∑–ª–∏–º–∏—Ç –±–∞–ª–ª–æ–≤** –Ω–∞ –∫–∞—Ä—Ç–µ[^2_1]
- **–ú–∏–Ω–∏–º—É–º –∫ —Å–ø–∏—Å–∞–Ω–∏—é:** 1 –±–∞–ª–ª[^2_1]
- **–ú–∞–∫—Å–∏–º—É–º –∫ —Å–ø–∏—Å–∞–Ω–∏—é:** 20% –æ—Ç —á–µ–∫–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ 10-100%)[^2_1]
- **–ú–∏–Ω–∏–º—É–º —á–µ–∫–∞:** 50 —Ä—É–±–ª–µ–π (—Ñ–∏–∫—Å)[^2_1]


#### **–£—Ä–æ–≤–Ω–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏:**

- **NO DOWNGRADE** (one way up)[^2_1]
- –û–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ `lifetime_spent`[^2_1]
- –ü–µ—Ä–µ—Å—á—ë—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ (–Ω–æ—á–Ω–æ–π CRON)[^2_1]
- –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π[^2_1]


#### **–°–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤:**

- –ü–æ **–Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏** (‚â•90 –¥–Ω–µ–π, –≤—Å–µ –±–∞–ª–ª—ã —Å—Ä–∞–∑—É)[^2_1]
- –î–ª—è –ø—Ä–æ–º–æ - —Å–≤–æ–∏ —Å—Ä–æ–∫–∏ (–î–µ–Ω—å –í–∞–ª–µ–Ω—Ç–∏–Ω–∞, —Ç–æ–ª—å–∫–æ –¥–µ–Ω—å –ø—Ä–∞–∑–¥–Ω–∏–∫–∞ + —Å–ª–µ–¥—É—é—â–∏–π)[^2_1]
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: CRON –≤ 10:00, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–µ—Ä–∏–æ–¥—ã[^2_1]


#### **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**

- **Snapshot –≤ JSONB** –ø—Ä–∏ –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏[^2_1]
- **NO –ø–µ—Ä–µ—Å—á—ë—Ç –∑–∞–¥–Ω–∏–º —á–∏—Å–ª–æ–º** (–∫–∞–∂–¥—ã–π —á–µ–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –Ω–∞ –º–æ–º–µ–Ω—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏)[^2_1]
- –û—Ç–∫–∞—Ç –ø—Ä–∞–≤–∏–ª = —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ —Å –∫–æ–ø–∏–µ–π —Å—Ç–∞—Ä–æ–π[^2_1]


#### **–ü—Ä–æ–º–æ –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã:**

- –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø—Ä–æ–º–æ (–î–† –≥–æ—Å—Ç—è, –î–† —Ä–µ–±—ë–Ω–∫–∞, –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –ø–µ—Ä–≤—ã–π —á–µ–∫, –∫–∞—Å—Ç–æ–º–Ω—ã–µ)[^2_1]
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã: COMBINE_ALL / MAX_ONLY / FIRST_ONLY[^2_1]
- Override –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–∞—Ä –ø—Ä–æ–º–æ[^2_1]
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `PromoBallGranted`[^2_1]


#### **–ú–∏–≥—Ä–∞—Ü–∏–∏ UNIFIED ‚Üî SEPARATE:**

- UNIFIED ‚Üí SEPARATE: –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤/—É—Ä–æ–≤–Ω–µ–π –≤ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω[^2_1]
- SEPARATE ‚Üí UNIFIED: —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤, –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å[^2_1]

***

## ‚úÖ **–ë–õ–û–ö 5: POS INTEGRATION** (–ë–µ—Å–µ–¥–∞ 4, 6, 8)

### **–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ (36 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- **HYBRID PUSH + PULL:** Webhooks –æ—Ç POS + PULL –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç[^2_2][^2_1]
- **POS = –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã** –ø–æ —á–µ–∫–∞–º[^2_1]
- **HMAC-SHA256** –ø–æ–¥–ø–∏—Å—å webhooks[^2_1]
- **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** Transaction ID + idempotency key[^2_2]
- **Reconciliation:** –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π job, –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π[^2_1]
- **–°—Ç–∞—Ç—É—Å—ã —Å–∏–Ω–∫–∞:** SUCCESS / FAILED / PARTIAL / PENDING[^2_1]
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞:** iiko, R-Keeper, Custom, Manual[^2_2][^2_1]
- **Auto-create guest:** –ü—Ä–∏ webhook (–æ–ø—Ü–∏—è)[^2_1]
- **–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** –ü–æ **—Ç–µ–ª–µ—Ñ–æ–Ω—É** (–æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á)[^2_1]


### **–î–µ—Ç–∞–ª–∏:**

- Webhook retry: 4 –ø–æ–ø—ã—Ç–∫–∏ (–¥–µ–Ω—å 0, 1, 3, 7)[^2_2]
- Admin UI –¥–ª—è –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∫–∏ failed webhooks[^2_2]
- POS credentials —Ö—Ä–∞–Ω—è—Ç—Å—è encrypted[^2_2]

***

## ‚úÖ **–ë–õ–û–ö 6: BACKEND API (NESTJS)** (–ë–µ—Å–µ–¥–∞ 8)

### **–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ (80+ endpoints, 34 –≤–æ–ø—Ä–æ—Å–∞):**

#### **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**

- **Modular Monolith** –Ω–∞ NestJS[^2_2]
- REST API —Å **URL-based versioning** (`/api/v1/`)[^2_2]
- RBAC Guards + Impersonation[^2_2]
- Rate Limiting –ø–æ —Ä–æ–ª—è–º[^2_2]
- **Idempotency:** Redis + DB constraints[^2_2]


#### **–û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏:**

- **Auth Module:** Login, register, refresh, MFA, password reset
- **Loyalty Module:**
    - `/loyalty/calculate` (pre-calculation –¥–ª—è POS)
    - `/loyalty/transactions` (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ)
    - `/loyalty/manual-adjustment` (—Ä—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞)
- **Admin Module:** CRUD –¥–ª—è –ø—Ä–∞–≤–∏–ª, —É—Ä–æ–≤–Ω–µ–π, –ø—Ä–æ–º–æ
- **Analytics Module:** Metrics, RFM, cohort, ROI
- **POS Module:** Webhooks, reconciliation
- **Billing Module:** Subscriptions, payments, invoices


#### **Background Jobs (BullMQ):**

- Level recalculation (–Ω–æ—á–Ω–æ–π CRON)
- Ball expiration (CRON –≤ 10:00)
- Reconciliation (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
- Notification sending (–æ—á–µ—Ä–µ–¥—å)
- Analytics aggregation (–ø—Ä–µ–¥—Ä–∞—Å—á—ë—Ç)

***

## ‚úÖ **–ë–õ–û–ö 7: BILLING \& SUBSCRIPTIONS** (–ë–µ—Å–µ–¥–∞ 6)

### **–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ (20 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- **–ü–æ–¥–ø–∏—Å–∫–∞:** –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (–º–µ—Å—è—Ü/–≥–æ–¥ —Å 20% —Å–∫–∏–¥–∫–æ–π)[^2_5]
- **–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ:** –í–∫–ª—é—á–µ–Ω–æ (–º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å)[^2_5]
- **–ü–ª–∞—Ç—ë–∂–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã:** YooKassa, Stripe, CloudPayments, CryptoCloud[^2_5]
- **–†—É—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞:** –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –ª—é–±—ã—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö[^2_5]
- **–ñ—ë—Å—Ç–∫–∏–µ –ª–∏–º–∏—Ç—ã:** 90% –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, 100% –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞[^2_5]
- **–ù–µ—É—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏:** 4 –ø–æ–ø—ã—Ç–∫–∏ (–¥–µ–Ω—å 0, 1, 3, 7)[^2_5]
- **Grace period:** 7 –¥–Ω–µ–π –ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–∏[^2_5]
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º:** –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è[^2_5]
- **Refund/Chargeback:** –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ webhooks[^2_5]
- **Trial:** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω)[^2_5]


### **–ê–ø–≥—Ä–µ–π–¥/–î–∞—É–Ω–≥—Ä–µ–π–¥:**

- –ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Å –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –¥–æ–ø–ª–∞—Ç–æ–π[^2_5]
- –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ —Ç–µ–Ω–∞–Ω—Ç—É (—Å –ø—Ä–∏—á–∏–Ω–æ–π)[^2_5]

***

## ‚úÖ **–ë–õ–û–ö 8: TELEGRAM BOT + MINI APP** (–ë–µ—Å–µ–¥–∞ 7)

### **–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ (25 –≤–æ–ø—Ä–æ—Å–æ–≤):**

#### **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:**

- –ß–µ—Ä–µ–∑ **Telegram ID** –∏–ª–∏ **—Ç–µ–ª–µ—Ñ–æ–Ω**[^2_1]
- –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ **–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω**[^2_1]
- SMS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞[^2_1]
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: —Ç–µ–ª–µ—Ñ–æ–Ω + –∏–º—è[^2_1]
- –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è[^2_1]


#### **–§—É–Ω–∫—Ü–∏–∏:**

- –ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞–ª–∞–Ω—Å–∞ (regular + promo)[^2_1]
- QR-–∫–æ–¥ –∫–∞—Ä—Ç—ã (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏)[^2_1]
- 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ (–≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç)[^2_1]
- –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–ª–æ–≤ –∏ –ø–æ—Å–µ—â–µ–Ω–∏–π[^2_1]
- –ü—Ä–æ—Ñ–∏–ª—å (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –¥–µ—Ç–∏, –∫–∞—Ä—Ç—ã)[^2_1]
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (Telegram/Email/SMS)[^2_1]


#### **–ú—É–ª—å—Ç–∏–∫–∞—Ä—Ç–æ—á–Ω–æ—Å—Ç—å:**

- –í—Å–µ –∫–∞—Ä—Ç—ã –≤ –æ–¥–Ω–æ–º Mini App —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º[^2_1]
- –£–º–Ω–æ–µ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π[^2_1]


#### **Database Schema:**

- TelegramBot (id, token, tenant_id)[^2_1]
- TelegramUser (telegram_id, user_id, started_at)[^2_1]
- Notifications (channel, status, sent_at)[^2_1]

***

## ‚úÖ **–ë–õ–û–ö 9: FRONTEND ADMIN PANEL (UI/UX)** (–ë–µ—Å–µ–¥–∞ 8, 12)

### **–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ (34 –≤–æ–ø—Ä–æ—Å–∞ + –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å):**

#### **Tech Stack:**

- **Next.js 14 App Router** (SSR/SSG)[^2_7][^2_2]
- **shadcn/ui + Radix UI + Tailwind CSS**[^2_7][^2_2]
- **Zustand + TanStack Query** (state management)[^2_2]
- **React Hook Form + Zod** (forms)[^2_2]
- **TanStack Table v8** (tables)[^2_2]
- **Recharts** (charts)[^2_2]
- **CMDK** (global search)[^2_2]
- **Sonner** (toasts)[^2_2]
- **Server-Sent Events** (real-time)[^2_2]


#### **–í–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å (—Ç–µ–º–Ω–∞—è —Ç–µ–º–∞):**

- **–§–æ–Ω:** `#0a0a0a`[^2_7]
- **–ö–∞—Ä—Ç–æ—á–∫–∏:** `#161616`[^2_7]
- **–ê–∫—Ü–µ–Ω—Ç—ã:** –°–∏–Ω–∏–π `#3b82f6`, –ó–µ–ª—ë–Ω—ã–π `#10b981`, –ö—Ä–∞—Å–Ω—ã–π `#ef4444`[^2_7]
- **–¢–µ–∫—Å—Ç:** –ë–µ–ª—ã–π `#ffffff`, –°–µ—Ä—ã–π `#a1a1a1`[^2_7]
- **–ò–∫–æ–Ω–∫–∏:** –≠–º–æ–¥–∑–∏ (üçï, ü•á, üìä, üí∞)[^2_7]
- **–®—Ä–∏—Ñ—Ç:** Inter, font-weights 400-700[^2_7]


#### **Layout Patterns:**

- **Collapsible sidebar:** 250px ‚Üí 60px mini ‚Üí hidden[^2_2]
- **Top navbar:** Breadcrumbs + search + notifications[^2_2]
- **Global search (CMDK):** Cmd+K / Ctrl+K[^2_2]
- **Mobile bottom tabs**[^2_2]
- **Impersonation banner:** Red fixed top[^2_2]


#### **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

- **–ö–∞—Ä—Ç–æ—á–∫–∏ –º–µ—Ç—Ä–∏–∫:** –ö—Ä—É–ø–Ω–∞—è —Ü–∏—Ñ—Ä–∞ + –æ–ø–∏—Å–∞–Ω–∏–µ + –∏–∑–º–µ–Ω–µ–Ω–∏–µ (‚Üë/‚Üì)[^2_7]
- **–¢–∞–±–ª–∏—Ü—ã:** Hover —ç—Ñ—Ñ–µ–∫—Ç, —á–µ—Ä–µ–¥—É—é—â–∏–µ—Å—è —Å—Ç—Ä–æ–∫–∏, –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ[^2_7]
- **Badges:** –¶–≤–µ—Ç–Ω—ã–µ –¥–ª—è —Ç–∞—Ä–∏—Ñ–æ–≤ (PRO, STANDARD)[^2_7]
- **Status indicators:** ‚úì –ê–∫—Ç–∏–≤–µ–Ω, ‚úï –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω[^2_7]
- **Dropdown filters:** –ù–∞–¥ —Ç–∞–±–ª–∏—Ü–∞–º–∏[^2_7]


#### **–≠–∫—Ä–∞–Ω—ã Owner Dashboard:**

- KPI –º–µ—Ç—Ä–∏–∫–∏ (MRR, Churn, Active Tenants, Revenue Growth)[^2_7]
- Revenue Charts (MRR Trend, Revenue by Plan)[^2_7]
- Tenants Table (–ù–∞–∑–≤–∞–Ω–∏–µ, –¢–∞—Ä–∏—Ñ, –ì–æ—Å—Ç–∏, –î–æ—Ö–æ–¥, –°—Ç–∞—Ç—É—Å)[^2_7]
- Billing Summary (Active subscriptions, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)[^2_7]
- Activity Log[^2_7]

***

## ‚úÖ **–ë–õ–û–ö 10: MANAGER DASHBOARD** (–ë–µ—Å–µ–¥–∞-12 —Ñ—Ä–∞–≥–º–µ–Ω—Ç)

### **–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ (25 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- **–î–æ—Å—Ç—É–ø:** –¢–æ–ª—å–∫–æ –∫ –æ–¥–Ω–æ–º—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É[^2_7]
- **Dashboard:** KPIs (guests, transactions, revenue, avg check)[^2_7]
- **Guests:** –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø (CRUD, manual adjustment)[^2_7]
- **Loyalty:** Read + —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª/–ø—Ä–æ–º–æ (activation —Ç—Ä–µ–±—É–µ—Ç Admin approval)[^2_7]
- **Analytics:** –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º 5 —Ç–∞–±–∞–º[^2_7]
- **Settings:** Profile + Restaurant Info (read-only) + Notifications[^2_7]
- **Mobile:** –¢–µ –∂–µ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ —á—Ç–æ —É Admin[^2_7]

***

## ‚úÖ **–ë–õ–û–ö 11: CASHIER POS INTERFACE** (–ë–µ—Å–µ–¥–∞-12 —Ñ—Ä–∞–≥–º–µ–Ω—Ç)

### **–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ (25 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:** 4-–∑–Ω–∞—á–Ω—ã–π PIN-–∫–æ–¥ (–±–µ–∑ email)[^2_7]
- **–î–∏–∑–∞–π–Ω:** Touch-optimized (–∫–Ω–æ–ø–∫–∏ 80px+, –∫—Ä—É–ø–Ω—ã–π —Ç–µ–∫—Å—Ç)[^2_7]
- **–§—É–Ω–∫—Ü–∏–∏:**
    - –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è (—Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º—è, QR, 6-digit –∫–æ–¥)
    - –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ (–æ—Ç —Å—É–º–º—ã —á–µ–∫–∞)
    - –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ (–≤–∞–ª–∏–¥–∞—Ü–∏—è max 20%)
    - –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≥–æ—Å—Ç—è
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
    - NO —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –≥–æ—Å—Ç—è
    - NO —Ä—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –±–∞–ª–ª–æ–≤
    - NO —É–¥–∞–ª–µ–Ω–∏–µ –≥–æ—Å—Ç–µ–π
    - NO –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
    - NO —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
- **Security:**
    - Session timeout 15 min
    - Device fingerprint (terminal tracking)
    - Activity logging (–≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è)
    - Manager approval (high amounts >20,000‚ÇΩ)
- **Offline Support:**
    - IndexedDB (cache –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 100 –≥–æ—Å—Ç–µ–π)
    - Sync queue (pending transactions)
    - Offline indicator (warning banner)
- **Hardware:**
    - Thermal printer (ESC/POS protocol)
    - Barcode scanner (keyboard wedge)

***

## ‚úÖ **–ë–õ–û–ö 12: TESTING STRATEGY** (–ë–µ—Å–µ–¥–∞-10, 12)

### **–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ (40 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- **Unit Tests (Jest):** Coverage ‚â•80%, mock external deps[^2_2]
- **Integration Tests (Supertest):** API endpoints, auth flow[^2_2]
- **E2E Tests (Playwright):** Critical user flows[^2_2]
- **Load Testing (k6):** 1000 concurrent users, 95th percentile <500ms[^2_2]
- **Security Testing:** OWASP ZAP, penetration testing[^2_2]
- **CI Integration:** GitHub Actions, run on PR[^2_2]

***

## ‚úÖ **–ë–õ–û–ö 13: INFRASTRUCTURE \& DEVOPS** (–ë–µ—Å–µ–¥–∞ 10-11)

### **–ü—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ (47 –≤–æ–ø—Ä–æ—Å–æ–≤ + –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è):**

#### **–•–æ—Å—Ç–∏–Ω–≥ (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è):**

- **Backend:** Fly.io (3 VM √ó 256 MB, always-on)[^2_5]
- **Frontend:** Vercel (100 GB bandwidth, auto SSL)[^2_5]
- **PostgreSQL:** Neon.tech (3 GB storage, branching)[^2_5]
- **Redis:** Upstash (10K commands/day, serverless)[^2_5]
- **S3 Storage:** Cloudflare R2 (10 GB, unlimited bandwidth)[^2_5]
- **CI/CD:** GitHub Actions (2000 min/month)[^2_5]
- **Monitoring:** Better Stack (1 GB logs, 10 uptime monitors)[^2_5]


#### **Production Infrastructure:**

- **Docker:** Backend, Worker, Cron containers[^2_2]
- **Kubernetes:** Deployment manifests, autoscaling[^2_2]
- **Monitoring:** Prometheus + Grafana[^2_2]
- **Logging:** ELK Stack / Datadog[^2_2]
- **Backups:** PostgreSQL (daily), Redis (hourly), S3 (versioning)[^2_2]
- **Secrets:** AWS Secrets Manager / Vault[^2_2]
- **WAF:** Cloudflare (DDoS protection)[^2_2]


#### **Zero-Downtime Deployments:**

- Rolling updates (K8s)[^2_2]
- Blue-green deployments[^2_2]
- Database migrations (nullable ‚Üí default ‚Üí NOT NULL)[^2_2]
- CREATE INDEX CONCURRENTLY[^2_2]

***

## ‚è≥ **–ë–õ–û–ö–ò –í –†–ê–ó–†–ê–ë–û–¢–ö–ï (–æ—Å—Ç–∞–ª–æ—Å—å 2):**

### **1. NOTIFICATIONS SYSTEM** (–µ—â—ë –Ω–µ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ)

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å (~18 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- Multi-channel (Telegram, Email, SMS, Push)
- Templates (balls earned, level upgrade, birthday, promo, balance expiry)
- Scheduling \& batch sending
- Rate limiting (Telegram 30/sec, SMS cost optimization)
- Delivery tracking (sent, delivered, opened, clicked)
- Preferences (opt-in/opt-out per channel)
- Fallback strategy (Telegram ‚Üí SMS)
- Queue management (BullMQ)


### **2. API DOCUMENTATION \& WEBHOOKS** (–µ—â—ë –Ω–µ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–æ)

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å (~15 –≤–æ–ø—Ä–æ—Å–æ–≤):**

- REST API documentation (Swagger/OpenAPI)
- Authentication guide (JWT, API Keys)
- Webhook events (guest.created, transaction.completed, level.upgraded)
- Webhook security (HMAC signatures)
- Rate limits per endpoint
- SDK examples (TypeScript, Python, PHP)
- Error codes reference
- Postman collection

***

## üìä **–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–†–û–†–ê–ë–û–¢–ö–ò**

| **–ë–ª–æ–∫** | **–°—Ç–∞—Ç—É—Å** | **–í–æ–ø—Ä–æ—Å–æ–≤** | **–°—Ç—Ä–∞–Ω–∏—Ü** |
| :-- | :-- | :-- | :-- |
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã | ‚úÖ –ì–æ—Ç–æ–≤–æ | ~20 | ~15 |
| Auth \& Security | ‚úÖ –ì–æ—Ç–æ–≤–æ | 51 | ~40 |
| Database Schema | ‚úÖ –ì–æ—Ç–æ–≤–æ | 35 | ~35 |
| Loyalty System Engine | ‚úÖ –ì–æ—Ç–æ–≤–æ | 50+ | ~45 |
| POS Integration | ‚úÖ –ì–æ—Ç–æ–≤–æ | 36 | ~30 |
| Backend API (NestJS) | ‚úÖ –ì–æ—Ç–æ–≤–æ | 80+ | ~50 |
| Billing \& Subscriptions | ‚úÖ –ì–æ—Ç–æ–≤–æ | 20 | ~25 |
| Telegram Bot + Mini App | ‚úÖ –ì–æ—Ç–æ–≤–æ | 25 | ~20 |
| Frontend Admin Panel | ‚úÖ –ì–æ—Ç–æ–≤–æ | 34 | ~30 |
| Manager Dashboard | ‚úÖ –ì–æ—Ç–æ–≤–æ | 25 | ~15 |
| Cashier POS Interface | ‚úÖ –ì–æ—Ç–æ–≤–æ | 25 | ~15 |
| Testing Strategy | ‚úÖ –ì–æ—Ç–æ–≤–æ | 40 | ~20 |
| Infrastructure \& DevOps | ‚úÖ –ì–æ—Ç–æ–≤–æ | 47 | ~25 |
| **Notifications System** | üü° –û–∂–∏–¥–∞–Ω–∏–µ | ~18 | - |
| **API Documentation** | üü° –û–∂–∏–¥–∞–Ω–∏–µ | ~15 | - |
| **–ò–¢–û–ì–û** | **12/14** | **520+** | **365+** |


***

## üéØ **–ö–õ–Æ–ß–ï–í–´–ï –†–ï–®–ï–ù–ò–Ø (summary)**

### **1. Loyalty Engine:**

- 1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å (—Ñ–∏–∫—Å)
- –ë–∞–ª–ª—ã –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞
- NO downgrade —É—Ä–æ–≤–Ω–µ–π
- –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (snapshot, NO –ø–µ—Ä–µ—Å—á—ë—Ç)
- –°–≥–æ—Ä–∞–Ω–∏–µ –ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚â•90 –¥–Ω–µ–π


### **2. Multi-Tenancy:**

- Pooled database —Å `tenant_id`
- Prisma middleware –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏
- UNIFIED/SEPARATE —Ä–µ–∂–∏–º—ã —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏


### **3. Security:**

- JWT RS256 —Å refresh rotation
- MFA –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è Owner/Admin
- Argon2id –¥–ª—è –ø–∞—Ä–æ–ª–µ–π
- Activity Log (7 years retention)
- Impersonation —Å MFA + reason


### **4. POS Integration:**

- HYBRID PUSH + PULL
- POS = –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- HMAC –ø–æ–¥–ø–∏—Å—å webhooks
- Reconciliation –µ–∂–µ–¥–Ω–µ–≤–Ω–æ


### **5. Billing:**

- –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (–º–µ—Å—è—Ü/–≥–æ–¥ -20%)
- 4 –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (YooKassa, Stripe, CloudPayments, CryptoCloud)
- –ñ—ë—Å—Ç–∫–∏–µ –ª–∏–º–∏—Ç—ã (90% warning, 100% block)
- Grace period 7 –¥–Ω–µ–π


### **6. UI/UX:**

- –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ (shadcn/ui)
- –≠–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- Touch-optimized (–∫–Ω–æ–ø–∫–∏ 80px+)
- Real-time updates (SSE)
- Global search (CMDK)

***

## üöÄ **–ì–û–¢–û–í –ö –†–ê–ó–†–ê–ë–û–¢–ö–ï!**

**–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.** –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ:

1. Notifications System (~18 –≤–æ–ø—Ä–æ—Å–æ–≤)
2. API Documentation (~15 –≤–æ–ø—Ä–æ—Å–æ–≤)

**–ö–∞–∫–æ–π –±–ª–æ–∫ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–º?** üéØ
<span style="display:none">[^2_10][^2_8][^2_9]</span>

<div align="center">‚ÅÇ</div>

[^2_1]: Beseda-6.md

[^2_2]: Beseda-7.md

[^2_3]: Beseda-10.md

[^2_4]: Beseda-9.md

[^2_5]: Beseda-11.md

[^2_6]: Beseda-13.md

[^2_7]: Beseda-12.md

[^2_8]: Beseda-1.md

[^2_9]: Beseda-2.md

[^2_10]: Beseda-8.md


---

## üìö –ü–û–õ–ù–ê–Ø –≠–ù–¶–ò–ö–õ–û–ü–ï–î–ò–Ø –ü–†–û–ï–ö–¢–ê MAX-LOYALTY

–í–æ—Ç **–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –î–ï–¢–ê–õ–¨–ù–ê–Ø** –∫–∞—Ä—Ç–∏–Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞ –æ—Ç –ê –¥–æ –Ø:[^3_1][^3_2][^3_3]

### üèóÔ∏è **1. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê**

**Multi-tenant SaaS –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞** –¥–ª—è —Å–∏—Å—Ç–µ–º –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ —Å 6-—É—Ä–æ–≤–Ω–µ–≤–æ–π –∏–µ—Ä–∞—Ä—Ö–∏–µ–π –¥–æ—Å—Ç—É–ø–∞:

- **OWNER** ‚Üí –≤–ª–∞–¥–µ–ª–µ—Ü –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (—Ç—ã), –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
- **TENANT** ‚Üí —Ä–µ—Å—Ç–æ—Ä–∞–Ω/—Å–µ—Ç—å —Å –ø–æ–¥–ø–∏—Å–∫–æ–π
- **RESTAURANT_ADMIN** ‚Üí —É–ø—Ä–∞–≤–ª—è—é—â–∏–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–∞–≤–∞–º–∏)
- **MANAGER** ‚Üí –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω, –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–π)
- **CASHIER** ‚Üí –∫–∞—Å—Å–∏—Ä (—Ç–æ–ª—å–∫–æ POS –æ–ø–µ—Ä–∞—Ü–∏–∏)
- **GUEST** ‚Üí –∫–ª–∏–µ–Ω—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞


### üíé **2. –ö–õ–Æ–ß–ï–í–´–ï –û–°–û–ë–ï–ù–ù–û–°–¢–ò**

#### **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª**[^3_1]

- –ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª = –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
- **–ù–ò–ö–û–ì–î–ê** –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –±–∞–ª–ª—ã (—á–µ—Å—Ç–Ω–æ!)
- –ö–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ö—Ä–∞–Ω–∏—Ç `rule_snapshot` (–ø–æ–ª–Ω–∞—è –∫–æ–ø–∏—è –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç —á–µ–∫–∞)
- –û—Ç–∫–∞—Ç = —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ —Å –∫–æ–ø–∏–µ–π —Å—Ç–∞—Ä–æ–π


#### **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∞**[^3_3]

- RestaurantAdmin —Å–æ–∑–¥–∞–µ—Ç –¥—Ä—É–≥–∏—Ö Admin —Å —É—Ä–µ–∑–∞–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
- Manager –≤ –∏–∑–æ–ª—è—Ü–∏–∏, –Ω–æ Admin –º–æ–∂–µ—Ç –¥–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –¥—Ä—É–≥–∏–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º
- 50+ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö permissions (create:guest, manual:balls –∏ —Ç.–¥.)


#### **–°–∏—Å—Ç–µ–º–∞ –±–∞–ª–ª–æ–≤**[^3_1]

- **1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å** (–≥–ª–æ–±–∞–ª—å–Ω–æ, –Ω–µ–∏–∑–º–µ–Ω–Ω–æ!)
- –°–≥–æ—Ä–∞–Ω–∏–µ: –æ—Å–Ω–æ–≤–Ω—ã–µ –±–∞–ª–ª—ã - 90 –¥–Ω–µ–π, –∞–∫—Ü–∏–æ–Ω–Ω—ã–µ - –ø–æ —É—Å–ª–æ–≤–∏—è–º –∞–∫—Ü–∏–∏
- –°–ø–∏—Å–∞–Ω–∏–µ: —Å–Ω–∞—á–∞–ª–∞ –∞–∫—Ü–∏–æ–Ω–Ω—ã–µ, –ø–æ—Ç–æ–º –æ—Å–Ω–æ–≤–Ω—ã–µ
- –ú–∏–Ω–∏–º—É–º —Å–ø–∏—Å–∞–Ω–∏—è: 1 –±–∞–ª–ª, –º–∞–∫—Å–∏–º—É–º: 20% –æ—Ç —á–µ–∫–∞ (admin: 10-100%)
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —á–µ–∫: **50 —Ä—É–±–ª–µ–π** (–Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å)


#### **–ì–æ—Å—Ç—å –ù–ò–ö–û–ì–î–ê –Ω–µ —Ç–µ—Ä—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å**[^3_1]

- –ü—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ –ø–æ—Ä–æ–≥–æ–≤ —É—Ä–æ–≤–µ–Ω—å —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ç—ë—Ç –∏–ª–∏ –æ—Å—Ç–∞—ë—Ç—Å—è
- –ï—Å–ª–∏ –¥–æ–ª–∂–µ–Ω –±—ã–ª —É–ø–∞—Å—Ç—å (Bronze‚ÜíSilver‚ÜíBronze) ‚Üí –æ—Å—Ç–∞—ë—Ç—Å—è Silver —Å 0 –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: Admin **—É–¥–∞–ª—è–µ—Ç** —É—Ä–æ–≤–µ–Ω—å —Ü–µ–ª–∏–∫–æ–º ‚Üí –≤—ã–±–∏—Ä–∞–µ—Ç –∫—É–¥–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≥–æ—Å—Ç–µ–π


#### **–ú–∏–≥—Ä–∞—Ü–∏—è –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ —Å–∏—Å—Ç–µ–º**[^3_1]

- **UNIFIED‚ÜíSEPARATE**: –∫–∞—Ä—Ç–∞ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω (–≥–æ—Å—Ç—å –≤–∏–¥–∏—Ç –≤—Å–µ —Å–≤–æ–∏ –±–∞–ª–ª—ã –≤–µ–∑–¥–µ!)
- **SEPARATE‚ÜíUNIFIED**: –±–∞–ª–ª—ã –°–£–ú–ú–ò–†–£–Æ–¢–°–Ø, —É—Ä–æ–≤–µ–Ω—å = –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π


### üéØ **3. –°–ò–°–¢–ï–ú–ê –õ–û–Ø–õ–¨–ù–û–°–¢–ò**

#### **–¢–∏–ø—ã**

1. **DISCOUNT** (—Å–∫–∏–¥–æ—á–Ω–∞—è): 5%, 10%, 15% –Ω–∞ —á–µ–∫
2. **POINTS** (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è): –±–∞–ª–ª—ã = % –æ—Ç —á–µ–∫–∞

#### **–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è**

- Admin —Å–æ–∑–¥–∞—ë—Ç **–õ–Æ–ë–´–ï** –ø—Ä–∞–≤–∏–ª–∞ (x2 –ø–æ –ø—è—Ç–Ω–∏—Ü–∞–º, –±–æ–Ω—É—Å >5000‚ÇΩ)
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∞–≤–∏–ª: –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–∞–º–æ–µ –≤—ã–≥–æ–¥–Ω–æ–µ **–ò–õ–ò** –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è: –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥–æ—Å—Ç—è/–≥—Ä—É–ø–ø—ã


#### **–ü—Ä–æ–º–æ-–∞–∫—Ü–∏–∏**[^3_1]

- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ: –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è, –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –ø–µ—Ä–≤—ã–π —á–µ–∫
- **–ö–∞—Å—Ç–æ–º–Ω—ã–µ**: –ø–æ–ª–Ω–∞—è —Å–≤–æ–±–æ–¥–∞ (–ò/–ò–õ–ò/–ù–ï —É—Å–ª–æ–≤–∏—è)
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∞–∫—Ü–∏–π: Admin –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç (COMBINE_ALL / MAX_ONLY / FIRST_ONLY)


### üîê **4. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨**[^3_2]

#### **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**

- JWT **RS256** (–∞—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è)
- Access token: **5 –º–∏–Ω—É—Ç**
- Refresh token: **14 –¥–Ω–µ–π** + Rotation + Reuse Detection
- –ü–∞—Ä–æ–ª–∏: **argon2id** (winner Password Hashing Competition)
- MFA: TOTP + SMS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –¥–ª—è Owner/Admin)


#### **Audit Trail**

- –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è (–∫—Ç–æ, —á—Ç–æ, –∫–æ–≥–¥–∞, –æ—Ç–∫—É–¥–∞, IP)
- Owner impersonation ‚Üí –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å –ø–æ–º–µ—Ç–∫–æ–π
- –†—É—á–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –±–∞–ª–ª–æ–≤ ‚Üí –ø–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ


### ü§ñ **5. TELEGRAM BOT + MINI APP**

- –°–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ loyalty —Å–∏—Å—Ç–µ–º—ã
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: Telegram ID **–ò–õ–ò** –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- –§—É–Ω–∫—Ü–∏–∏: QR-–∫–æ–¥, –±–∞–ª–∞–Ω—Å, –∏—Å—Ç–æ—Ä–∏—è, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –¥–µ—Ç–∏, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- QR + 6-digit –∫–æ–¥ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è **–ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**


### üí≥ **6. POS –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø**[^3_3]

- **iiko** + **R-Keeper**
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: **PUSH (webhook) + PULL (backup –∫–∞–∂–¥—ã–π —á–∞—Å)**
- Reconciliation: –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–≤–µ—Ä–∫–∞, —Ä–∞–∑–ª–∏—á–∏—è >1% ‚Üí alert Admin
- –î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥ POS


### üìä **7. EDGE CASES**[^3_1]

#### **Orphaned –±–∞–ª–ª—ã**

- –ì–æ—Å—Ç—å —É–¥–∞–ª—ë–Ω, –Ω–æ –±–∞–ª–ª—ã –æ—Å—Ç–∞–ª–∏—Å—å ‚Üí monthly report Owner


#### **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–æ–º–æ**

- 3 –ø—Ä–æ–º–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è + —Å—Ä–µ–¥–∞ + –ø–µ—Ä–≤—ã–π —á–µ–∫)
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: Admin –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é


#### **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª**

- UNIQUE constraint: –æ–¥–Ω–æ –ø—Ä–∞–≤–∏–ª–æ = –º–∞–∫—Å–∏–º—É–º 1 —Ä–∞–∑ –Ω–∞ —á–µ–∫


#### **–°–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤**

- –î–ª—è –∫–∞–∂–¥–æ–π –∞–∫—Ü–∏–∏ —Å–≤–æ—ë —Å–≥–æ—Ä–∞–Ω–∏–µ (–ø—Ä–∏–º–µ—Ä: –î–µ–Ω—å –°–≤—è—Ç–æ–≥–æ –í–∞–ª–µ–Ω—Ç–∏–Ω–∞ - 1 –¥–µ–Ω—å)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: Admin –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç (–ø–µ—Ä–∏–æ–¥ + –∫–∞–Ω–∞–ª)


### üéõÔ∏è **8. ADMIN –ü–ê–ù–ï–õ–ò**

#### **Owner Panel**

- –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤—Å–µ—Ö tenant
- Impersonate –≤ –ª—é–±–æ–π –∞–∫–∫–∞—É–Ω—Ç
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞–º–∏ + billing


#### **Restaurant Admin Panel**

- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ loyalty —Å–∏—Å—Ç–µ–º—ã (–≤–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (Admin/Manager/Cashier)
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤—Å–µ–π —Å–µ—Ç–∏
- –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø—Ä–æ–º–æ-–∞–∫—Ü–∏–∏


#### **Manager Panel**

- –¢–æ–ª—å–∫–æ —Å–≤–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω (–∏–∑–æ–ª—è—Ü–∏—è)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Å—Ç—è–º–∏
- –†—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ (–µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)


#### **Cashier Interface**

- –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π POS –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç–µ–π
- –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤

–≠—Ç–æ **–ü–û–õ–ù–ê–Ø –ö–ê–†–¢–ò–ù–ê** –ø—Ä–æ–µ–∫—Ç–∞! –í—Å–µ 13 –±–µ—Å–µ–¥    –¥–µ—Ç–∞–ª—å–Ω–æ –∏–∑—É—á–µ–Ω—ã. –ì–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–∞–º! üöÄ[^3_2][^3_3][^3_1]

–ß—Ç–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–ª—å—à–µ?
<span style="display:none">[^3_4][^3_5][^3_6][^3_7][^3_8][^3_9]</span>

<div align="center">‚ÅÇ</div>

[^3_1]: Beseda-5.md

[^3_2]: Beseda-13.md

[^3_3]: Beseda-2.md

[^3_4]: Beseda-7.md

[^3_5]: Beseda-10.md

[^3_6]: Beseda-6.md

[^3_7]: Beseda-9.md

[^3_8]: Beseda-1.md

[^3_9]: Beseda-3.md


---

## üî• –°–í–ï–†–•–ì–õ–£–ë–û–ö–ò–ô –ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–Å–ù

–Ø –ø—Ä–æ–≤—ë–ª **–≠–ö–°–¢–†–ï–ú–ê–õ–¨–ù–û –î–ï–¢–ê–õ–¨–ù–û–ï –ò–ó–£–ß–ï–ù–ò–ï** –≤—Å–µ—Ö 13 –±–µ—Å–µ–¥. –í–æ—Ç **–ü–û–õ–ù–ê–Ø –≠–ù–¶–ò–ö–õ–û–ü–ï–î–ò–Ø** –ø—Ä–æ–µ–∫—Ç–∞ MAX-LOYALTY —Å –∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å–µ–º–∏ –Ω—é–∞–Ω—Å–∞–º–∏:[^4_1][^4_2][^4_3][^4_4][^4_5][^4_6]

***

## ‚ö° **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ë–ò–ó–ù–ï–°-–ü–†–ê–í–ò–õ–ê (–ù–µ–∑—ã–±–ª–µ–º—ã–µ –∑–∞–∫–æ–Ω—ã)**

### **üíé –ë–∞–ª–ª—ã - –°–≤—è—â–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞**

- **1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å** ‚Üí –ì–õ–û–ë–ê–õ–¨–ù–û, –Ω–µ–∏–∑–º–µ–Ω—è–µ–º–æ, –Ω–∞–≤—Å–µ–≥–¥–∞[^4_3]
- **–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –û–¢**: –∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞ **–î–û** —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤[^4_3]
- **–ú–∏–Ω–∏–º—É–º —Å–ø–∏—Å–∞–Ω–∏—è**: 1 –±–∞–ª–ª
- **–ú–∞–∫—Å–∏–º—É–º —Å–ø–∏—Å–∞–Ω–∏—è**: 20% –æ—Ç —á–µ–∫–∞ (admin –º–æ–∂–µ—Ç 10-100%)[^4_3]
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —á–µ–∫**: **50 —Ä—É–±–ª–µ–π HARDCODED** (–Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å!)[^4_3]
- **–ë–µ–∑–ª–∏–º–∏—Ç –Ω–∞ –∫–∞—Ä—Ç–µ**: –ì–æ—Å—Ç—å –º–æ–∂–µ—Ç –Ω–∞–∫–æ–ø–∏—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
- **–ü–æ—Ä—è–¥–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è**: 1Ô∏è‚É£ promo_balance ‚Üí 2Ô∏è‚É£ regular_balance[^4_3]


### **üèÜ –£—Ä–æ–≤–Ω–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ - –¢–æ–ª—å–∫–æ –≤–≤–µ—Ä—Ö!**

- **NO DOWNGRADE**: –ì–æ—Å—Ç—å –ù–ò–ö–û–ì–î–ê –Ω–µ —Ç–µ—Ä—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å![^4_3]
- **–ö—Ä–∏—Ç–µ—Ä–∏–π**: `lifetime_spent` (–≤—Å—è —Å—É–º–º–∞ —á–µ–∫–æ–≤ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è)
- **–ü–µ—Ä–µ—Å—á—ë—Ç**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 00:00 UTC, —Ç–æ–ª—å–∫–æ –ø–æ–≤—ã—à–µ–Ω–∏–µ
- **–ü—Ä–∏ –ø–æ–Ω–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞**: –ì–æ—Å—Ç—å –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ —Ç–µ–∫—É—â–µ–º —Å 0% –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
- **–£–¥–∞–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –∞–¥–º–∏–Ω–æ–º**: Admin –≤—ã–±–∏—Ä–∞–µ—Ç –∫—É–¥–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≥–æ—Å—Ç–µ–π


### **üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ - –ù–µ–∏–∑–º–µ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è**

- **NO –ü–ï–†–ï–°–ß–Å–¢** –∑–∞–¥–Ω–∏–º —á–∏—Å–ª–æ–º[^4_3]
- **rule_snapshot**: –ö–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ö—Ä–∞–Ω–∏—Ç –ø–æ–ª–Ω—É—é –∫–æ–ø–∏—é –ø—Ä–∞–≤–∏–ª–∞
- **–û—Ç–∫–∞—Ç**: –°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å –∫–æ–ø–∏–µ–π —Å—Ç–∞—Ä–æ–π
- **–ò—Å—Ç–æ—Ä–∏—è**: –ü–æ–ª–Ω–∞—è, –Ω–∞–≤—Å–µ–≥–¥–∞, –Ω–µ—É–¥–∞–ª—è–µ–º–∞—è


### **‚è∞ –°–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤**

- **–û—Å–Ω–æ–≤–Ω—ã–µ**: ‚â•90 –¥–Ω–µ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–≤—Å–µ —Å—Ä–∞–∑—É)[^4_3]
- **–ü—Ä–æ–º–æ**: –°–≤–æ–π —Å—Ä–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–π –∞–∫—Ü–∏–∏ (–î–µ–Ω—å –í–∞–ª–µ–Ω—Ç–∏–Ω–∞ - 1 –¥–µ–Ω—å)
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: Admin –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç (–∑–∞ 7/3/1 –¥–µ–Ω—å)
- **CRON**: 10:00 UTC –µ–∂–µ–¥–Ω–µ–≤–Ω–æ

***

## üë• **–†–û–õ–ò –ò –ü–†–ê–í–ê - –ü–û–õ–ù–ê–Ø –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø**

### **üåü OWNER (–í–ª–∞–¥–µ–ª–µ—Ü –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã)**

- **–î–æ—Å—Ç—É–ø**: –í—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞, –≤—Å–µ tenant[^4_2]
- **Impersonate**: –í –ª—é–±–æ–π –∞–∫–∫–∞—É–Ω—Ç (–ª–æ–≥–∏—Ä—É–µ—Ç—Å—è!)[^4_2]
- **–ú–æ–∂–µ—Ç**:
    - –°–æ–∑–¥–∞–≤–∞—Ç—å tenant —á–µ—Ä–µ–∑ —Å–ø–µ—Ü-—Å—Å—ã–ª–∫–∏[^4_4]
    - –í–∏–¥–µ—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É (MRR, ARR, Churn)
    - –ú–µ–Ω—è—Ç—å –ø–∞—Ä–æ–ª–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    - –£–ø—Ä–∞–≤–ª—è—Ç—å —Ç–∞—Ä–∏—Ñ–∞–º–∏ –∏ —Ü–µ–Ω–∞–º–∏[^4_4]
    - –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª—è—Ç—å tenant
    - –í–∏–¥–µ—Ç—å —Ñ–∏–Ω–∞–Ω—Å—ã –≤—Å–µ—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
- **–ù–ï –º–æ–∂–µ—Ç**: –£–ø—Ä–∞–≤–ª—è—Ç—å –≥–æ—Å—Ç—è–º–∏ –Ω–∞–ø—Ä—è–º—É—é (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ impersonate)
- **MFA**: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø (TOTP + SMS backup)[^4_6]


### **‚öôÔ∏è RESTAURANT_ADMIN (–£–ø—Ä–∞–≤–ª—è—é—â–∏–π)**

- **–û–±–ª–∞—Å—Ç—å**: –í—Å—è —Å–µ—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ —Å–≤–æ–µ–≥–æ tenant[^4_2]
- **–ú–æ–∂–µ—Ç**:
    - –°–æ–∑–¥–∞–≤–∞—Ç—å –¥—Ä—É–≥–∏—Ö Admin —Å **—É—Ä–µ–∑–∞–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏**[^4_2]
    - –°–æ–∑–¥–∞–≤–∞—Ç—å Manager (–ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É)
    - –°–æ–∑–¥–∞–≤–∞—Ç—å Cashier (–ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É)
    - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å loyalty —Å–∏—Å—Ç–µ–º—É (**UNIFIED** –∏–ª–∏ **SEPARATE**)[^4_5]
    - –°–æ–∑–¥–∞–≤–∞—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Å—Ç–µ–π
    - –†—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ (–ª–æ–≥–∏—Ä—É–µ—Ç—Å—è!)
    - –°–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ–º–æ-–∞–∫—Ü–∏–∏ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ + –∫–∞—Å—Ç–æ–º–Ω—ã–µ)[^4_3]
    - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–æ–º–æ (**COMBINE_ALL/MAX_ONLY/FIRST_ONLY**)[^4_3]
    - –í–∏–¥–µ—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –≤—Å–µ–π —Å–µ—Ç–∏
    - –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π
    - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø—Ä–∞–≤–∞ Manager/Cashier **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏**[^4_2]
    - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å POS (iiko, R-Keeper)[^4_4]
    - –°–æ–∑–¥–∞–≤–∞—Ç—å Telegram Bot –¥–ª—è —Å–µ—Ç–∏
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∞**: –î—Ä—É–≥–æ–π Admin –º–æ–∂–µ—Ç —É—Ä–µ–∑–∞—Ç—å –ø—Ä–∞–≤–∞
- **MFA**: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø (TOTP + SMS backup)[^4_6]


### **üëî MANAGER (–ú–µ–Ω–µ–¥–∂–µ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞)**

- **–û–±–ª–∞—Å—Ç—å**: **–¢–û–õ–¨–ö–û —Å–≤–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω** (–ø–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è!)[^4_2]
- **–ú–æ–∂–µ—Ç**:
    - –í–∏–¥–µ—Ç—å –≥–æ—Å—Ç–µ–π —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
    - –°–æ–∑–¥–∞–≤–∞—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Å—Ç–µ–π
    - –†—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ (–µ—Å–ª–∏ Admin —Ä–∞–∑—Ä–µ—à–∏–ª)
    - –ö–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ POS
    - –°–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞—Å—Å–∏—Ä–æ–≤ –¥–ª—è —Å–≤–æ–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
    - –í–∏–¥–µ—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É —Å–≤–æ–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
- **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ**: Admin –º–æ–∂–µ—Ç –¥–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –¥—Ä—É–≥–∏–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º[^4_2]
- **–£—Ä–µ–∑–∞–Ω–∏–µ**: Admin –º–æ–∂–µ—Ç —É–±—Ä–∞—Ç—å —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–ª–∞–º–∏[^4_2]
- **MFA**: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è (–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)


### **üí∞ CASHIER (–ö–∞—Å—Å–∏—Ä)**

- **–û–±–ª–∞—Å—Ç—å**: –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω, —Ç–æ–ª—å–∫–æ POS[^4_2]
- **–ú–æ–∂–µ—Ç**:
    - –ù–∞—á–∏—Å–ª—è—Ç—å/—Å–ø–∏—Å—ã–≤–∞—Ç—å –±–∞–ª–ª—ã —á–µ—Ä–µ–∑ POS
    - –°–æ–∑–¥–∞–≤–∞—Ç—å –≥–æ—Å—Ç–µ–π (phone + name –º–∏–Ω–∏–º—É–º)[^4_4]
    - –í–∏–¥–µ—Ç—å –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ –æ –≥–æ—Å—Ç—è—Ö
    - –î–æ–±–∞–≤–ª—è—Ç—å –¥–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ—Å—Ç—è—Ö
- **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ù–ï –≤–∏–¥–∏—Ç**: –ê–Ω–∞–ª–∏—Ç–∏–∫—É[^4_2]
- **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ**: Admin –º–æ–∂–µ—Ç –¥–∞—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫—É
- **MFA**: –ù–µ—Ç (—Ç–æ–ª—å–∫–æ SMS –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)


### **üé´ GUEST (–ì–æ—Å—Ç—å)**

- **–û–±–ª–∞—Å—Ç—å**: –¢–æ–ª—å–∫–æ —Å–≤–æ—è –∫–∞—Ä—Ç–∞[^4_2]
- **–ú–æ–∂–µ—Ç**:
    - –í–∏–¥–µ—Ç—å —Å–≤–æ—é –∫–∞—Ä—Ç—É –≤ Telegram Mini App
    - –í–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –±–∞–ª–ª–æ–≤ (–Ω–∞—á–∏—Å–ª–µ–Ω–∏—è/—Å–ø–∏—Å–∞–Ω–∏—è)
    - –í–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–µ—â–µ–Ω–∏–π + —á–µ–∫–∏[^4_5]
    - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å (**1 —Ä–∞–∑ –≤ 3 –º–µ—Å—è—Ü–∞**)[^4_5]
    - –î–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å –¥–µ—Ç–µ–π (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)[^4_5]
    - –í–∏–¥–µ—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    - –í–∏–¥–µ—Ç—å QR-–∫–æ–¥ + 6-digit –∫–æ–¥
- **–ù–ï –º–æ–∂–µ—Ç**: –ù–∏—á–µ–≥–æ –∫—Ä–æ–º–µ —Å–≤–æ–µ–π –∫–∞—Ä—Ç—ã
- **–ü–∞—Ä–æ–ª—å**: –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (auth —á–µ—Ä–µ–∑ Telegram ID –∏–ª–∏ phone)

***

## üîå **POS –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø - HYBRID –ê–†–•–ò–¢–ï–ö–¢–£–†–ê**

- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: **PUSH (webhook) + PULL (backup –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω)**[^4_1]
- **–°–∏—Å—Ç–µ–º—ã**: iiko, R-Keeper[^4_4]
- **–ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã**: **POS** (–Ω–µ –Ω–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞!)[^4_1]


### **Webhook –¥–µ—Ç–∞–ª–∏**

- **–ú–µ—Ç–æ–¥**: POST
- **–ü–æ–¥–ø–∏—Å—å**: HMAC-SHA256[^4_6]
- **–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≥–æ—Å—Ç—è**: phone (–æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á)[^4_1]
- **Auto-create**: –û–ø—Ü–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (—Å–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç—è –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω)[^4_1]
- **Retry**: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å exponential backoff
- **Timeout**: 30 —Å–µ–∫—É–Ω–¥


### **Reconciliation**

- **–ß–∞—Å—Ç–æ—Ç–∞**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00 UTC[^4_1]
- **–î–µ–π—Å—Ç–≤–∏–µ**: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö POS vs –Ω–∞—à–∞ –ë–î
- **–†–∞–∑–ª–∏—á–∏—è >1%**: Alert Admin[^4_1]
- **–ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞**: –ü–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥ POS (POS = –∏—Å—Ç–∏–Ω–∞)[^4_1]

***

## üí≥ **–¢–ê–†–ò–§–´ - 6 –ü–õ–ê–ù–û–í**

| –¢–∞—Ä–∏—Ñ | –†–µ—Å—Ç–æ—Ä–∞–Ω—ã | –ì–æ—Å—Ç–∏ | –¶–µ–Ω–∞/–º–µ—Å | –¶–µ–Ω–∞/–≥–æ–¥ |
| :-- | :-- | :-- | :-- | :-- |
| **FREE** | ‚àû | ‚àû | 0‚ÇΩ | 0‚ÇΩ |
| **STANDARD** | 1 | 500 | X‚ÇΩ | X‚ÇΩ √ó 9.6 |
| **MEDIUM** | 3 | 2000 | Y‚ÇΩ | Y‚ÇΩ √ó 9.6 |
| **PRO** | 5 | 6000 | Z‚ÇΩ | Z‚ÇΩ √ó 9.6 |
| **ULTIMATE** | ‚àû | ‚àû | W‚ÇΩ | W‚ÇΩ √ó 9.6 |
| **CUSTOM** | custom | custom | custom | custom |

[^4_4]

### **–õ–∏–º–∏—Ç—ã**

- **–¢–∏–ø**: –ñ–Å–°–¢–ö–ò–ï (hard limits), NO overage[^4_1]
- **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ**: 90% –ª–∏–º–∏—Ç–∞
- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞**: 100% –ª–∏–º–∏—Ç–∞ (–æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã)
- **–î–∞–Ω–Ω—ã–µ**: –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –¥–æ—Å—Ç—É–ø read-only


### **–ë–∏–ª–ª–∏–Ω–≥**

- **–ú–æ–¥–µ–ª—å**: –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (prepaid)[^4_1]
- **–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ**: –î–∞ (–º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å)
- **–ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã**: YooKassa, Stripe, CloudPayments, CryptoCloud[^4_1]
- **–†—É—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞**: –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –ª—é–±—ã—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö[^4_1]
- **–ù–µ—É—Å–ø–µ—Ö**: 4 –ø–æ–ø—ã—Ç–∫–∏ (–¥–µ–Ω—å 0, 1, 3, 7)[^4_1]
- **Trial**: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω)[^4_1]

***

## üîÑ **–ú–ò–ì–†–ê–¶–ò–ò –°–ò–°–¢–ï–ú**

### **UNIFIED ‚Üí SEPARATE**

- –ö–∞—Ä—Ç–∞ **–ö–û–ü–ò–†–£–ï–¢–°–Ø** –≤ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω[^4_3]
- –ë–∞–ª–ª—ã **–û–î–ò–ù–ê–ö–û–í–´–ï** –≤ –∫–∞–∂–¥–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ
- –£—Ä–æ–≤–µ–Ω—å **–û–î–ò–ù–ê–ö–û–í–´–ô** –≤ –∫–∞–∂–¥–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ
- –ò—Å—Ç–æ—Ä–∏—è **–ö–û–ü–ò–†–£–ï–¢–°–Ø** –ø–æ–ª–Ω–æ—Å—Ç—å—é
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ì–æ—Å—Ç—å –≤–∏–¥–∏—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –±–∞–ª–ª—ã –≤–æ –≤—Å–µ—Ö —Ç–æ—á–∫–∞—Ö


### **SEPARATE ‚Üí UNIFIED**

- –ö–∞—Ä—Ç—ã **–°–£–ú–ú–ò–†–£–Æ–¢–°–Ø** –≤ –æ–¥–Ω—É[^4_3]
- –ë–∞–ª–ª—ã **–°–£–ú–ú–ò–†–£–Æ–¢–°–Ø** (3√ó2000 = 6000)
- –£—Ä–æ–≤–µ–Ω—å **–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô** –∏–∑ –≤—Å–µ—Ö
- –ò—Å—Ç–æ—Ä–∏—è **–í–°–ï** —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è
- –°—Ç–∞—Ä—ã–µ –∫–∞—Ä—Ç—ã –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ **MIGRATED**
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ì–æ—Å—Ç—å –≤–∏–¥–∏—Ç –æ–±—â—É—é —Å—É–º–º—É –±–∞–ª–ª–æ–≤

***

## üì± **TELEGRAM BOT + MINI APP**

- **–°–æ–∑–¥–∞–Ω–∏–µ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ loyalty —Å–∏—Å—Ç–µ–º—ã[^4_1]
- **–û–¥–∏–Ω –±–æ—Ç**: –ù–∞ –≤–µ—Å—å tenant (–Ω–µ –Ω–∞ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω)
- **–ö–æ–º–∞–Ω–¥—ã**: /start, /card, /balance, /history, /settings, /support


### **Mini App —ç–∫—Ä–∞–Ω—ã**

1. **–ì–ª–∞–≤–Ω–∞—è**: QR-–∫–æ–¥ + 6-digit –∫–æ–¥ + –±–∞–ª–∞–Ω—Å + —É—Ä–æ–≤–µ–Ω—å + –ø—Ä–æ–≥—Ä–µ—Å—Å
2. **–ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–ª–æ–≤**: –î–∞—Ç–∞, –æ–ø–µ—Ä–∞—Ü–∏—è, —Å—É–º–º–∞, –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ, —Ä–µ—Å—Ç–æ—Ä–∞–Ω
3. **–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–µ—â–µ–Ω–∏–π**: –î–∞—Ç–∞, —Ä–µ—Å—Ç–æ—Ä–∞–Ω, —Å—É–º–º–∞ —á–µ–∫–∞, items, –±–∞–ª–ª—ã
4. **–ü—Ä–æ—Ñ–∏–ª—å**: –ò–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, email, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è, –¥–µ—Ç–∏ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ 1 —Ä–∞–∑ –≤ 3 –º–µ—Å—è—Ü–∞)
5. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ push, —Ç–∏–ø—ã, –≤—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è

### **–ú—É–ª—å—Ç–∏–∫–∞—Ä—Ç–æ—á–Ω–æ—Å—Ç—å**

- –í—Å–µ –∫–∞—Ä—Ç—ã –≤ –æ–¥–Ω–æ–º Mini App[^4_1]
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ: Dropdown –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è: –ö–∞–∂–¥–∞—è –∫–∞—Ä—Ç–∞ —Å–æ —Å–≤–æ–∏–º –¥–∏–∑–∞–π–Ω–æ–º/–ª–æ–≥–æ—Ç–∏–ø–æ–º

***

## üîê **SECURITY - –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê**

### **JWT**

- **–ê–ª–≥–æ—Ä–∏—Ç–º**: RS256 (–∞—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è)[^4_6]
- **Access token**: 5 –º–∏–Ω—É—Ç[^4_6]
- **Refresh token**: 14 –¥–Ω–µ–π + **rotation** + **reuse detection**[^4_6]
- **Blacklist**: Redis (–ø—Ä–∏ logout/password reset)


### **–ü–∞—Ä–æ–ª–∏**

- **–ê–ª–≥–æ—Ä–∏—Ç–º**: argon2id (winner Password Hashing Competition)[^4_6]
- **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è**: 10+ —Å–∏–º–≤–æ–ª–æ–≤, –∑–∞–≥–ª–∞–≤–Ω—ã–µ, —Ü–∏—Ñ—Ä—ã, —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª[^4_6]
- **Entropy**: 50+ bits (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ zxcvbn)
- **–ò—Å—Ç–æ—Ä–∏—è**: –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –ø–∞—Ä–æ–ª–µ–π[^4_6]
- **Max age**: 90 –¥–Ω–µ–π (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–º–µ–Ω–∞)[^4_6]


### **Rate Limiting**

- **Login**: 5 –ø–æ–ø—ã—Ç–æ–∫ / 15 –º–∏–Ω—É—Ç[^4_6]
- **Lockout**: 30 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ 5 –Ω–µ—É–¥–∞—á–Ω—ã—Ö
- **API**: 100 –∑–∞–ø—Ä–æ—Å–æ–≤ / –º–∏–Ω—É—Ç—É (–ø–æ IP)
- **POS webhook**: 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ / –º–∏–Ω—É—Ç—É (–ø–æ tenant)


### **Audit Log**

- **–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è**: –í–°–Å (–∫—Ç–æ, —á—Ç–æ, –∫–æ–≥–¥–∞, –æ—Ç–∫—É–¥–∞, IP, device)[^4_2]
- **–•—Ä–∞–Ω–µ–Ω–∏–µ**: 5 –ª–µ—Ç (compliance)
- **–ù–µ—É–¥–∞–ª—è–µ–º–æ**: –î–∞–∂–µ Owner –Ω–µ –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å
- **Critical operations**: Impersonation, —Ä—É—á–Ω—ã–µ –±–∞–ª–ª—ã, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞, —Å–æ–∑–¥–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ users, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª

***

## üóÑÔ∏è **–ë–ê–ó–ê –î–ê–ù–ù–´–•**

- **–í—Å–µ–≥–æ —Ç–∞–±–ª–∏—Ü**: 45+[^4_1]
- **–í—Å–µ–≥–æ ENUM**: 15+
- **–í—Å–µ–≥–æ –ø–æ–ª–µ–π**: 200+


### **–ö–ª—é—á–µ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã**

1. **User** - –û—Å–Ω–æ–≤–Ω–∞—è (–≤—Å–µ —Ä–æ–ª–∏)
2. **Tenant** - –†–µ—Å—Ç–æ—Ä–∞–Ω—ã/—Å–µ—Ç–∏ (—Å –ø–æ–¥–ø–∏—Å–∫–æ–π)
3. **Restaurant** - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–æ—á–∫–∏ –≤ —Å–µ—Ç–∏
4. **GuestProfile** - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≥–æ—Å—Ç–µ–π
5. **GuestCard** - –ö–∞—Ä—Ç—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
6. **BallTransaction** - –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–ª–æ–≤ (—Å rule_snapshot!)
7. **LoyaltyRule** - –ü—Ä–∞–≤–∏–ª–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
8. **LoyaltyRuleVersion** - –í–µ—Ä—Å–∏–∏ –ø—Ä–∞–≤–∏–ª (–Ω–µ—É–¥–∞–ª—è–µ–º—ã–µ)
9. **LoyaltyPromo** - –ü—Ä–æ–º–æ-–∞–∫—Ü–∏–∏
10. **POSTransaction** - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ POS
11. **ActivityLog** - Audit trail (–Ω–µ—É–¥–∞–ª—è–µ–º—ã–π)

***

## ‚úÖ **–ì–û–¢–û–í –ö –†–ê–ë–û–¢–ï!**

–Ø –∏–∑—É—á–∏–ª **–ê–ë–°–û–õ–Æ–¢–ù–û –í–°–Å** –∏–∑ 13 –±–µ—Å–µ–¥ –¥–æ—Å–∫–æ–Ω–∞–ª—å–Ω–æ. –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞, edge cases, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ - **–ü–û–õ–ù–û–°–¢–¨–Æ** –≤ –º–æ–µ–π –ø–∞–º—è—Ç–∏.[^4_5][^4_4][^4_6][^4_2][^4_3][^4_1]

**–ß—Ç–æ –¥–µ–ª–∞–µ–º –¥–∞–ª—å—à–µ?** üöÄ

<div align="center">‚ÅÇ</div>

[^4_1]: Beseda-9.md

[^4_2]: Beseda-2.md

[^4_3]: Beseda-5.md

[^4_4]: Beseda-1.md

[^4_5]: Beseda-3.md

[^4_6]: Beseda-13.md


---

## üî• –°–í–ï–†–•–ì–õ–£–ë–û–ö–û–ï –ò–ó–£–ß–ï–ù–ò–ï –ü–õ–ê–ì–ò–ù–ê iiko –ó–ê–í–ï–†–®–ï–ù–û!

–Ø –ø—Ä–æ–≤—ë–ª **–≠–ö–°–¢–†–ï–ú–ê–õ–¨–ù–û –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó** –≤—Å–µ–π —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è iiko Front. –í–æ—Ç **–ü–û–õ–ù–ê–Ø –≠–ù–¶–ò–ö–õ–û–ü–ï–î–ò–Ø** –ø–ª–∞–≥–∏–Ω–∞ —Å–æ –≤—Å–µ–º–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –¥–µ—Ç–∞–ª—è–º–∏:[^5_1]

***

## ‚öôÔ∏è **–ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–õ–ê–ì–ò–ù–ê**

### **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫**

- **–Ø–∑—ã–∫**: C\# (.NET Framework 4.7.2+)[^5_1]
- **UI**: WPF (Windows Presentation Foundation)
- **API**: iiko Front Plugin SDK
- **Backend**: REST API Max Loyalty (NestJS)
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: Serilog (structured logging)
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: MemoryCache
- **HTTP**: HttpClient + Polly (retry policies)
- **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞**: Windows 10/11, iiko Front 7.x+


### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞**

```
MaxLoyaltyIikoPlugin/
‚îú‚îÄ‚îÄ Plugin.cs (–≥–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å IFrontPlugin)
‚îú‚îÄ‚îÄ Services/ (8 —Å–µ—Ä–≤–∏—Å–æ–≤)
‚îú‚îÄ‚îÄ UI/ (4 –æ–∫–Ω–∞ + 2 –∫–æ–Ω—Ç—Ä–æ–ª–∞)
‚îú‚îÄ‚îÄ Models/ (5 –º–æ–¥–µ–ª–µ–π)
‚îú‚îÄ‚îÄ Validators/ (–≤–∞–ª–∏–¥–∞—Ü–∏—è)
‚îî‚îÄ‚îÄ Utils/ (ErrorHandler, RetryPolicy, Encryption)
```


***

## üöÄ **–£–°–¢–ê–ù–û–í–ö–ê –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø**

### **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫**

**–§–æ—Ä–º–∞—Ç**: `MaxLoyaltyInstaller_Restaurant123.exe`[^5_1]

**–°–æ–¥–µ—Ä–∂–∏—Ç**:

- MaxLoyaltyIikoPlugin.dll
- **–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π API Key** (–ø—Ä–∏–≤—è–∑–∫–∞ –∫ –º–∞—à–∏–Ω–µ!)
- URL backend API
- Restaurant ID

**–ü—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏**:

1. –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ iiko Front
2. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .dll –≤ `Plugins/`
3. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ –≤ `%AppData%/MaxLoyaltyIiko/`
4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–∞ –≤ iiko
5. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å iiko Front

### **InitializePlugin() - 10 —à–∞–≥–æ–≤**

1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (Serilog)[^5_1]
2. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ API Key)
3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
4. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ —Å backend
5. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º**[^5_1]
6. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –≤ "–î–û–ü–û–õ–ù–ï–ù–ò–Ø"
7. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Payment Types** (POINTS + DISCOUNT)
8. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è (OrderClosed, PaymentEdited)
9. –û–±—Ä–∞–±–æ—Ç–∫–∞ offline –æ—á–µ—Ä–µ–¥–∏
10. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–ª–∏–º–∏—Ç 50MB)

### **üîë Payment Types - –ö–†–ò–¢–ò–ß–ù–û!**

| Payment Type | Name | Editable | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **POINTS** | MAX_LOYALTY_POINTS | ‚úÖ **–î–ê** | –ö–∞—Å—Å–∏—Ä –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Å—É–º–º—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã |
| **DISCOUNT** | MAX_LOYALTY_DISCOUNT | ‚ùå **–ù–ï–¢** | –°—É–º–º–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞, –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å |

[^5_1]

***

## üé® **UI/UX WORKFLOW**

### **–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞**

```
iiko Front ‚Üí –û—Ç–∫—Ä—ã—Ç –∑–∞–∫–∞–∑ ‚Üí –î–û–ü–û–õ–ù–ï–ù–ò–Ø ‚Üí Max Loyalty
```

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `ButtonCategory.Additions`[^5_1]

### **–û–∫–Ω–æ 1: –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è**

- **–¢–∞–±—ã**: –¢–µ–ª–µ—Ñ–æ–Ω / 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
- **–ü–æ–ª–µ –≤–≤–æ–¥–∞**: `+7 ___ ___ __ __`
- **–¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞**: –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è (1-9, —Å—Ç–µ—Ä–µ—Ç—å, ‚úì)
- **–ö–Ω–æ–ø–∫–∏**: OK, –û—Ç–º–µ–Ω–∞, –°–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç—è
- **–í–Ω–∏–∑—É**: –°—É–º–º–∞ –∑–∞–∫–∞–∑–∞

**–õ–æ–≥–∏–∫–∞**:

1. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞
2. –í—ã–∑–æ–≤ `/search-guest`
3. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Ç—å
4. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Üí –≤—ã–∑–æ–≤ `/calculate`
5. –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏

### **–û–∫–Ω–æ 2: –û–ø–µ—Ä–∞—Ü–∏—è (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ —Å–∏—Å—Ç–µ–º—ã)**

#### **–í–∞—Ä–∏–∞–Ω—Ç A: POINTS (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏:      890,00 ‚ÇΩ    ‚îÇ
‚îÇ –ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å:  2 450,00 ‚ÇΩ üí∞ ‚îÇ
‚îÇ –î–æ—Å—Ç—É–ø–Ω–æ:           178,00 ‚ÇΩ    ‚îÇ
‚îÇ –°–ø–∏—Å–∞—Ç—å:         [____178__] ‚úèÔ∏è ‚îÇ  ‚Üê EDITABLE!
‚îÇ –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ:    +45 –±–∞–ª–ª–æ–≤  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ [–ù–∞—á–∏—Å–ª–∏—Ç—å] [–°–ø–∏—Å–∞—Ç—å] [–û—Ç–≤—è–∑–∞—Ç—å]‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


#### **–í–∞—Ä–∏–∞–Ω—Ç B: DISCOUNT (—Å–∫–∏–¥–æ—á–Ω–∞—è)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏:      890,00 ‚ÇΩ    ‚îÇ
‚îÇ –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏:         20% üéÅ   ‚îÇ
‚îÇ –°—É–º–º–∞ —Å–∫–∏–¥–∫–∏:       178,00 ‚ÇΩ    ‚îÇ  ‚Üê –§–ò–ö–°–ò–†–û–í–ê–ù–û!
‚îÇ –ö –æ–ø–ª–∞—Ç–µ:           712,00 ‚ÇΩ    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ [–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É] [–û—Ç–≤—è–∑–∞—Ç—å]   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## üí≥ **–ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ö –ó–ê–ö–ê–ó–£**

### **POINTS —Ä–µ–∂–∏–º (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π)**

**–®–∞–≥–∏**:

1. –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –±–∞–ª–ª–æ–≤: `POST /reserve-points`[^5_1]
2. –°–æ–∑–¥–∞–Ω–∏–µ payment: `operations.CreatePayment(pointsPaymentType, sum)`
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ: `operations.AddPreliminaryPayment(payment, order)`
4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: `LoyaltyContext` –≤ MemoryCache
5. –ú–µ—Ç—Ä–∏–∫–∞: `loyalty.points.applied`

**Payment comment**: `MaxLoyalty:Type=POINTS:Guest={cardId}:Res={reservationId}`

**OnPaymentEdited**:

- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–≤–æ–π —Å—É–º–º—ã (‚â§ maxAllowed)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏: `POST /update-reservation`
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞


### **DISCOUNT —Ä–µ–∂–∏–º (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)**

**–®–∞–≥–∏**:

1. –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è: `POST /reserve-discount`
2. –°–æ–∑–¥–∞–Ω–∏–µ **non-editable** payment
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫ –∑–∞–∫–∞–∑—É
4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
5. –ú–µ—Ç—Ä–∏–∫–∞: `loyalty.discount.applied`

**Payment comment**: `MaxLoyalty:Type=DISCOUNT:Percent={%}:Guest={cardId}:Res={reservationId}`

**OnPaymentEdited**:

- –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ ‚Üí **–≤–æ–∑–≤—Ä–∞—Ç –∫ –∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º–µ**
- Warning: "‚ö†Ô∏è –°–∫–∏–¥–∫–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞"[^5_1]


### **EARN ONLY —Ä–µ–∂–∏–º**

- **–ù–ï —Å–æ–∑–¥–∞–µ–º payment**
- –¢–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
- –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ–∫–∞ ‚Üí –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
- –ö–Ω–æ–ø–∫–∞: "–ù–∞—á–∏—Å–ª–∏—Ç—å" (–≤ –æ–∫–Ω–µ POINTS)

***

## ‚úÖ **–§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ö–†–´–¢–ò–ò –ß–ï–ö–ê**

**–°–æ–±—ã—Ç–∏–µ**: `OnOrderClosed` (–ø–æ–¥–ø–∏—Å–∫–∞ —á–µ—Ä–µ–∑ `operations.OrderClosed`)[^5_1]

### **–î–ª—è POINTS**

```csharp
await apiClient.FinalizePointsAsync({
  guestCardId,
  orderId,
  reservationId,
  checkAmount,              // –ò—Å—Ö–æ–¥–Ω–∞—è
  finalCheckAmount,         // –§–∏–Ω–∞–ª—å–Ω–∞—è (–º–æ–≥–ª–∞ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è)
  pointsSpent,              // –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è
  pointsToEarn,             // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ
  action,                   // SPEND / EARN_ONLY / BOTH
  paymentTypes,             // –í—Å–µ —Ç–∏–ø—ã –æ–ø–ª–∞—Ç—ã
  cashierName,
  orderType                 // DINE_IN / DELIVERY / TAKEAWAY
})
```


### **–î–ª—è DISCOUNT**

```csharp
await apiClient.FinalizeDiscountAsync({
  guestCardId,
  orderId,
  reservationId,
  checkAmount,
  finalCheckAmount,
  discountPercentage,
  discountAmount,
  paymentTypes,
  cashierName,
  orderType
})
```


### **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

- Try-catch –±–ª–æ–∫
- –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Üí **–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ offline queue**[^5_1]
- –ú–µ—Ç—Ä–∏–∫–∞: `loyalty.offline_queued`

***

## üîÑ **–û–¢–í–Ø–ó–ö–ê –ö–ê–†–¢–´**

**–ö–Ω–æ–ø–∫–∞**: "–û—Ç–≤—è–∑–∞—Ç—å" (–≤ –æ–∫–Ω–µ –æ–ø–µ—Ä–∞—Ü–∏–∏)[^5_1]

**–®–∞–≥–∏**:

1. –û—Ç–º–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏: `POST /cancel-reservation` (reason: USER_UNBIND)
2. –£–¥–∞–ª–µ–Ω–∏–µ payment: `operations.DeletePayment(payment, order)`
3. –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: `ClearOrderLoyaltyContext(order)`
4. –ú–µ—Ç—Ä–∏–∫–∞: `loyalty.card.unbound`

***

## üì° **BACKEND API - 12 ENDPOINTS**

### **–û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**

| Endpoint | Method | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
| :-- | :-- | :-- |
| `/search-guest` | POST | –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è (phone/code6Digit) |
| `/calculate` | POST | –†–∞—Å—á–µ—Ç –±–µ–Ω–µ—Ñ–∏—Ç–æ–≤ (POINTS/DISCOUNT) |
| `/reserve-points` | POST | –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –±–∞–ª–ª–æ–≤ |
| `/reserve-discount` | POST | –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è —Å–∫–∏–¥–∫–∏ |
| `/update-reservation` | POST | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ (–ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ payment) |
| `/cancel-reservation` | POST | –û—Ç–º–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ (–æ—Ç–≤—è–∑–∫–∞) |
| `/finalize-points` | POST | –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Å –±–∞–ª–ª–∞–º–∏ |
| `/finalize-discount` | POST | –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ —Å–∫–∏–¥–∫–æ–π |
| `/create-guest` | POST | –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç—è —Å –∫–∞—Å—Å—ã |
| `/config` | GET | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ |
| `/health` | GET | –ó–¥–æ—Ä–æ–≤—å–µ backend |
| `/metrics` | POST | –ú–µ—Ç—Ä–∏–∫–∏ (–±–∞—Ç—á –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω) |

[^5_1]

### **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**

```
X-API-Key: <encrypted_api_key>
X-Plugin-Version: 1.0.0
X-Restaurant-Id: <restaurant_id>
```


***

## üîí **–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨**

### **API Key —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ**

- **–ê–ª–≥–æ—Ä–∏—Ç–º**: AES-256[^5_1]
- **Key derivation**: `SHA256(machineId + 'MaxLoyaltySalt')`
- **Machine binding**: –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–∞—à–∏–Ω–µ
- **–•—Ä–∞–Ω–µ–Ω–∏–µ**: `%AppData%/MaxLoyaltyIiko/config.encrypted`
- **Revoke**: Backend –º–æ–∂–µ—Ç –æ—Ç–æ–∑–≤–∞—Ç—å –∫–ª—é—á –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç

**–ö–†–ò–¢–ò–ß–ù–û**: –ü–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–æ–π –º–∞—à–∏–Ω–µ, –≥–¥–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω![^5_1]

***

## üì¥ **OFFLINE –†–ï–ñ–ò–ú**

### **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ offline**

- **–ú–µ—Ç–æ–¥**: `HealthCheckService.CheckHealthAsync()`
- **–¢–∞–π–º–∞—É—Ç**: 2 —Å–µ–∫—É–Ω–¥—ã
- **–ß–∞—Å—Ç–æ—Ç–∞**: –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- **–°—Ç–∞—Ç—É—Å**: Healthy / Offline


### **Offline queue**

- **–•—Ä–∞–Ω–µ–Ω–∏–µ**: –õ–æ–∫–∞–ª—å–Ω—ã–π JSON —Ñ–∞–π–ª
- **–ú–∞–∫—Å–∏–º—É–º**: 100 –æ–ø–µ—Ä–∞—Ü–∏–π[^5_1]
- **TTL**: 24 —á–∞—Å–∞ (–ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è —É–¥–∞–ª—è–µ—Ç—Å—è)
- **–û–±—Ä–∞–±–æ—Ç–∫–∞**: –ü—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏


### **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤ offline**

‚úÖ **–ú–æ–∂–Ω–æ**: –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ (EarnOnly), –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–¥—É—Ç –≤ queue
‚ùå **–ù–µ–ª—å–∑—è**: –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏

[^5_1]

***

## üìä **–õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì**

### **Serilog**

- **–£—Ä–æ–≤–µ–Ω—å**: Information
- **Enrichers**: Plugin, Version, RestaurantId, MachineName
- **–ü—É—Ç—å**: `%AppData%/MaxLoyaltyIiko/logs/plugin-{Date}.log`
- **–†–æ—Ç–∞—Ü–∏—è**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ
- **–•—Ä–∞–Ω–µ–Ω–∏–µ**: 7 –¥–Ω–µ–π[^5_1]


### **–ú–µ—Ç—Ä–∏–∫–∏ (8 —Ç–∏–ø–æ–≤)**

```csharp
loyalty.points.applied         // –°—É–º–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è
loyalty.discount.applied       // –°—É–º–º–∞ —Å–∫–∏–¥–∫–∏
loyalty.search.duration_ms     // –í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞
loyalty.error.network          // –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
loyalty.offline_queue.size     // –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏
loyalty.order.finalized        // –§–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
loyalty.card.unbound           // –û—Ç–≤—è–∑–∫–∏
loyalty.points.edited          // –ò–∑–º–µ–Ω–µ–Ω–∏—è payment
```

**–û—Ç–ø—Ä–∞–≤–∫–∞**: –ë–∞—Ç—á –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –Ω–∞ `/api/pos-integration/iiko/metrics`[^5_1]

***

## üéõÔ∏è **–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê**

**–ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞**: `Ctrl+Shift+D`[^5_1]

**–í–∫–ª–∞–¥–∫–∏**: –û–±—â–µ–µ, –¢–µ—Å—Ç—ã, –õ–æ–≥–∏, –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**:

- –í–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞
- –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
- API URL
- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (üü¢/üî¥)
- –•—Ä–∞–Ω–∏–ª–∏—â–µ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ / **–ª–∏–º–∏—Ç 50MB**)
- Offline –æ—á–µ—Ä–µ–¥—å (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π)
- –ö–µ—à (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π)

**–§—É–Ω–∫—Ü–∏–∏**:

- –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö API endpoints)
- –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏

***

## üîÑ **–û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–õ–ê–ì–ò–ù–ê**

- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –ö–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
- **Endpoint**: `/api/pos-integration/iiko/latest-version`
- **Response**: `{ latestVersion, changelog, downloadUrl }`
- **–ü—Ä–æ—Ü–µ—Å—Å**: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ installer ‚Üí –ó–∞–ø—É—Å–∫ ‚Üí Shutdown iiko Front[^5_1]

***

## üéØ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ú–û–ú–ï–ù–¢–´**

### **1. Payment Types - –§–£–ù–î–ê–ú–ï–ù–¢–ê–õ–¨–ù–û!**

```
POINTS  ‚Üí isEditable: true  ‚úÖ (–∫–∞—Å—Å–∏—Ä –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å)
DISCOUNT ‚Üí isEditable: false ‚ùå (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ)
```


### **2. –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è + –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è**

```
Reserve (–ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏) ‚Üí Finalize (–ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ–∫–∞)
```

**–ï—Å–ª–∏ finalize —É–ø–∞–ª ‚Üí offline queue**[^5_1]

### **3. –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞ (LoyaltyContext)**

–•—Ä–∞–Ω–∏—Ç—Å—è –≤ **MemoryCache** –Ω–∞ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∑–∞–∫–∞–∑–∞:

- GuestCardId
- BenefitType (POINTS/DISCOUNT)
- Action (SPEND/EARN_ONLY/APPLY_DISCOUNT)
- ReservationId
- –í—Å–µ —Å—É–º–º—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã


### **4. Offline —Ä–µ–∂–∏–º**

- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ health check (2 —Å–µ–∫ —Ç–∞–π–º–∞—É—Ç)
- Queue: –º–∞–∫—Å–∏–º—É–º 100 –æ–ø–µ—Ä–∞—Ü–∏–π, TTL 24 —á–∞—Å–∞
- **–¢–æ–ª—å–∫–æ EarnOnly** –≤ offline!


### **5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**

- API Key –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω AES-256
- Machine binding (–Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏)
- Backend –º–æ–∂–µ—Ç –æ—Ç–æ–∑–≤–∞—Ç—å –∫–ª—é—á

***

## ‚úÖ **–ò–¢–û–ì–û: –ü–û–õ–ù–ê–Ø –ì–û–¢–û–í–ù–û–°–¢–¨**

–Ø –∏–∑—É—á–∏–ª **–í–°–Å** –≤ –ø–ª–∞–≥–∏–Ω–µ:[^5_1]

‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (C\#, WPF, 8 —Å–µ—Ä–≤–∏—Å–æ–≤, 4 –æ–∫–Ω–∞)
‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫—É (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π installer —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º)
‚úÖ UI/UX workflow (2 –æ–∫–Ω–∞, —Ü–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞)
‚úÖ Payment Types (editable vs non-editable)
‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ –∑–∞–∫–∞–∑—É (—Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è + –∫–æ–Ω—Ç–µ–∫—Å—Ç)
‚úÖ –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—é (OnOrderClosed event)
‚úÖ 12 API endpoints (search ‚Üí calculate ‚Üí reserve ‚Üí finalize)
‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (AES, machine binding, revoke)
‚úÖ Offline —Ä–µ–∂–∏–º (queue, TTL, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)
‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (Serilog, 7 –¥–Ω–µ–π)
‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (8 –º–µ—Ç—Ä–∏–∫, –±–∞—Ç—á –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω)
‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É (Ctrl+Shift+D)
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 24—á)

**–ì–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–∞–º!** üöÄ –ß—Ç–æ –¥–µ–ª–∞–µ–º –¥–∞–ª—å—à–µ?

<div align="center">‚ÅÇ</div>

[^5_1]: Plagin-iiko.md


---

## üî• **–ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø –ü–õ–ê–ì–ò–ù–ê –î–õ–Ø R-KEEPER**

–Ø –∏—Å—Å–ª–µ–¥–æ–≤–∞–ª –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å R-Keeper –∏ —Å–æ–∑–¥–∞–ª **–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ**. –í–æ—Ç —á—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å:[^6_1][^6_2][^6_3]

***

## ‚ö†Ô∏è **–ö–õ–Æ–ß–ï–í–û–ï –û–¢–õ–ò–ß–ò–ï –û–¢ iiko**

### **iiko –∏–º–µ–µ—Ç Plugin SDK**

```
‚úÖ –ü—Ä—è–º—ã–µ –ø–ª–∞–≥–∏–Ω—ã –≤ UI –∫–∞—Å—Å—ã (WPF –æ–∫–Ω–∞ –≤–Ω—É—Ç—Ä–∏ iiko Front)
‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Payment Types —á–µ—Ä–µ–∑ API
‚úÖ –°–æ–±—ã—Ç–∏—è OrderClosed, PaymentEdited
```


### **R-Keeper –ù–ï –∏–º–µ–µ—Ç Plugin SDK**

```
‚ùå –ù–µ—Ç –ø—Ä—è–º—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –≤ –∫–∞—Å—Å–µ
‚úÖ –ï—Å—Ç—å XML-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å + FarCard –º–æ–¥—É–ª—å
‚úÖ –ù—É–∂–Ω–æ –≤–Ω–µ—à–Ω–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```


***

## üéØ **–û–ü–¢–ò–ú–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï: –ì–ò–ë–†–ò–î–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê**

### **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (3 —á–∞—Å—Ç–∏)**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–∏–ø | –§—É–Ω–∫—Ü–∏—è | –†–∞–∑–º–µ—â–µ–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| **MaxLoyaltyRKeeper.dll** | C++ DLL | External.dll –¥–ª—è FarCard [^6_1] | –ö–∞—Å—Å–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä R-Keeper |
| **MaxLoyaltyRKeeperUI.exe** | WPF –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ | UI –¥–ª—è –∫–∞—Å—Å–∏—Ä–æ–≤ | –ö–∞—Å—Å–æ–≤—ã–µ —Å—Ç–∞–Ω—Ü–∏–∏ |
| **R-Keeper FarCard** | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–æ–¥—É–ª—å | –ü–æ—Å—Ä–µ–¥–Ω–∏–∫ –∫–∞—Å—Å–∞ ‚Üî DLL | **–ë–ï–°–ü–õ–ê–¢–ù–û!** [^6_1] |


***

## üèóÔ∏è **–°–•–ï–ú–ê –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    R-KEEPER CASH                            ‚îÇ
‚îÇ  –ö–∞—Å—Å–∏—Ä –ø—Ä–æ–∫–∞—Ç—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç—É/—Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           FarCard –º–æ–¥—É–ª—å (–ë–ï–°–ü–õ–ê–¢–ù–´–ô –≤ R-Keeper)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        MaxLoyaltyRKeeper.dll (–Ω–∞—à–∞ external.dll)           ‚îÇ
‚îÇ  ‚Ä¢ GetCardInfo()                                            ‚îÇ
‚îÇ  ‚Ä¢ CalculateBenefit()                                       ‚îÇ
‚îÇ  ‚Ä¢ ReservePoints() / ReserveDiscount()                      ‚îÇ
‚îÇ  ‚Ä¢ FinalizeTransaction()                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ HTTP/HTTPS
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ             Backend API (Max Loyalty)                       ‚îÇ
‚îÇ  /search-guest ‚Üí /calculate ‚Üí /reserve ‚Üí /finalize         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç UI:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       MaxLoyaltyRKeeperUI.exe (WPF, —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç—Ä–µ–π)        ‚îÇ
‚îÇ  ‚Ä¢ –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞: Ctrl+Shift+L                           ‚îÇ
‚îÇ  ‚Ä¢ –û–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è (–∞–Ω–∞–ª–æ–≥ iiko)                         ‚îÇ
‚îÇ  ‚Ä¢ –û–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ (POINTS/DISCOUNT)                         ‚îÇ
‚îÇ  ‚Ä¢ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ XML-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         R-Keeper Cash Server XML API                        ‚îÇ
‚îÇ  ‚Ä¢ GetOrderList (—Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤)                           ‚îÇ
‚îÇ  ‚Ä¢ SaveOrder + FarCard (–ø—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã)                    ‚îÇ
‚îÇ  ‚Ä¢ SaveOrder + Discount (–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## üíª **EXTERNAL.DLL –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø**

### **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è: FarCard + external.dll (–ë–ï–°–ü–õ–ê–¢–ù–û!)**[^6_1]

**–Ø–∑—ã–∫**: C++ (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ) –∏–ª–∏ C\# —á–µ—Ä–µ–∑ C++/CLI wrapper

**8 –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π**:

```cpp
// 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
int Initialize(const char* configPath);

// 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞—Ä—Ç–µ
int GetCardInfo(const char* cardNumber, CardInfo* outInfo);

// 3. –†–∞—Å—á–µ—Ç –±–µ–Ω–µ—Ñ–∏—Ç–∞ (POINTS –∏–ª–∏ DISCOUNT)
int CalculateBenefit(const char* cardId, double checkAmount, BenefitInfo* outBenefit);

// 4. –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –±–∞–ª–ª–æ–≤
int ReservePoints(const char* cardId, double pointsToSpend, char* outReservationId);

// 5. –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è —Å–∫–∏–¥–∫–∏
int ReserveDiscount(const char* cardId, double discountAmount, char* outReservationId);

// 6. –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ–∫–∞)
int FinalizeTransaction(const char* reservationId, double finalAmount, const char* orderId);

// 7. –û—Ç–º–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
int CancelReservation(const char* reservationId);

// 8. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
void Shutdown();
```

**–°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö**:

```cpp
struct CardInfo {
    char guestName[^6_256];
    char phone[^6_32];
    char cardId[^6_64];       // UUID
    char levelName[^6_128];
    double regularBalance;
    double promoBalance;
};

struct BenefitInfo {
    int benefitType;       // 0=POINTS, 1=DISCOUNT
    double maxAllowedToSpend;
    double pointsToEarn;
    double discountPercentage;
    double discountAmount;
};
```


***

## üé® **DESKTOP UI –ü–†–ò–õ–û–ñ–ï–ù–ò–ï**

### **MaxLoyaltyRKeeperUI.exe**

- **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è**: WPF + .NET 4.7.2+
- **–†–∞–∑–º–µ—â–µ–Ω–∏–µ**: –ù–∞ –∫–∞—Å—Å–æ–≤—ã—Ö —Å—Ç–∞–Ω—Ü–∏—è—Ö (–∞–≤—Ç–æ–∑–∞–ø—É—Å–∫)
- **–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è**: XML-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å R-Keeper —á–µ—Ä–µ–∑ HTTP[^6_4][^6_5]


### **4 –æ–∫–Ω–∞ (–∞–Ω–∞–ª–æ–≥ iiko –ø–ª–∞–≥–∏–Ω–∞)**

#### **1. –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ (—Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç—Ä–µ–π)**

```
üü¢ Max Loyalty - –ü–æ–¥–∫–ª—é—á–µ–Ω–æ
‚îú‚îÄ –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è (Ctrl+Shift+L)
‚îú‚îÄ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
‚îî‚îÄ –í—ã—Ö–æ–¥
```


#### **2. –û–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     MAX LOYALTY - R-KEEPER      ‚îÇ
‚îÇ  –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–ª–∏ –∫–æ–¥          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [–¢–µ–ª–µ—Ñ–æ–Ω]  [6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥]     ‚îÇ
‚îÇ  +7 ___ ___ __ __               ‚îÇ
‚îÇ  [^6_1][^6_2][^6_3]                      ‚îÇ
‚îÇ  [^6_4][^6_5][^6_6]                      ‚îÇ
‚îÇ  [^6_7][^6_8][^6_9]                      ‚îÇ
‚îÇ  [‚Üê][^6_0][‚úì]                      ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã R-Keeper:      ‚îÇ
‚îÇ  ‚Ä¢ –°—Ç–æ–ª 5 - 890‚ÇΩ [–í—ã–±—Ä–∞—Ç—å]     ‚îÇ
‚îÇ  ‚Ä¢ –°—Ç–æ–ª 12 - 1,450‚ÇΩ [–í—ã–±—Ä–∞—Ç—å]  ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  [OK] [–û—Ç–º–µ–Ω–∞] [–°–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç—è] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


#### **3. –û–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ (POINTS/DISCOUNT)**

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ iiko –ø–ª–∞–≥–∏–Ω—É**[^6_6]

#### **4. –û–∫–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**

- –°—Ç–∞—Ç—É—Å Backend API (üü¢/üî¥)
- –°—Ç–∞—Ç—É—Å R-Keeper XML (üü¢/üî¥)
- Offline queue
- –õ–æ–≥–∏

***

## üîÑ **WORKFLOW –†–ê–ë–û–¢–´**

### **–°—Ü–µ–Ω–∞—Ä–∏–π 1: POINTS (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è)**

1. –ö–∞—Å—Å–∏—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∑–∞–∫–∞–∑ –≤ R-Keeper
2. –ù–∞–∂–∏–º–∞–µ—Ç **Ctrl+Shift+L** ‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è MaxLoyaltyRKeeperUI
3. –í–≤–æ–¥–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω/–∫–æ–¥ –≥–æ—Å—Ç—è
4. UI ‚Üí external.dll ‚Üí Backend API `/search-guest` + `/calculate`
5. Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `benefitType=POINTS`
6. –û–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏: –∫–∞—Å—Å–∏—Ä –≤–≤–æ–¥–∏—Ç —Å—É–º–º—É —Å–ø–∏—Å–∞–Ω–∏—è
7. –ù–∞–∂–∏–º–∞–µ—Ç **–°–ø–∏—Å–∞—Ç—å** ‚Üí `/reserve-points`
8. UI –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç **XML –∫–æ–º–∞–Ω–¥—É** –≤ R-Keeper: –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É –∫ –∑–∞–∫–∞–∑—É[^6_5]
9. –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ–∫–∞ ‚Üí **FarCard –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –≤—ã–∑—ã–≤–∞–µ—Ç external.dll
10. external.dll ‚Üí `/finalize-points`

### **–°—Ü–µ–Ω–∞—Ä–∏–π 2: DISCOUNT (—Å–∫–∏–¥–æ—á–Ω–∞—è)**

1-4. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ
5. Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `benefitType=DISCOUNT`
6. –û–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞ (–Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å)
7. –ù–∞–∂–∏–º–∞–µ—Ç **–ü—Ä–∏–º–µ–Ω–∏—Ç—å** ‚Üí `/reserve-discount`
8. UI –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç **XML –∫–æ–º–∞–Ω–¥—É**: –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É –∫ –∑–∞–∫–∞–∑—É
9. FarCard ‚Üí external.dll ‚Üí `/finalize-discount`

***

## üì¶ **–£–°–¢–ê–ù–û–í–ö–ê**

### **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫**

`MaxLoyaltyRKeeperInstaller_Restaurant123.exe`

**–°–æ–¥–µ—Ä–∂–∏—Ç**:

- MaxLoyaltyRKeeper.dll
- MaxLoyaltyRKeeperUI.exe
- config.json (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π)

**–ü—Ä–æ—Ü–µ—Å—Å**:

1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ DLL –≤ `C:\RK7\`
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ **FarCard** –≤ R-Keeper Manager[^6_1]
3. –£–∫–∞–∑–∞–Ω–∏–µ –ø—É—Ç–∏ –∫ DLL
4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ UI –Ω–∞ –∫–∞—Å—Å–æ–≤—ã–µ —Å—Ç–∞–Ω—Ü–∏–∏
5. –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ UI
6. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–∞—Å—Å–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞

***

## ‚öñÔ∏è **–°–†–ê–í–ù–ï–ù–ò–ï –° iiko –ü–õ–ê–ì–ò–ù–û–ú**

| –ê—Å–ø–µ–∫—Ç | iiko Plugin | R-Keeper Solution |
| :-- | :-- | :-- |
| **UI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** | –ü—Ä—è–º–æ –≤ –∫–∞—Å—Å–µ | –û—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Ctrl+Shift+L) |
| **Payment Types** | Plugin SDK | XML –∫–æ–º–∞–Ω–¥—ã (—Å–∫–∏–¥–∫–∏) |
| **–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è** | OnOrderClosed event | FarCard –≤—ã–∑—ã–≤–∞–µ—Ç DLL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |
| **–ö–Ω–æ–ø–∫–∞** | –í –º–µ–Ω—é –î–û–ü–û–õ–ù–ï–ù–ò–Ø | –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞ / —Ç—Ä–µ–π |
| **–õ–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ë–µ—Å–ø–ª–∞—Ç–Ω–æ | **FarCard –ë–ï–°–ü–õ–ê–¢–ù–û!** [^6_1] |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** | –°—Ä–µ–¥–Ω—è—è (C\# WPF) | –í—ã—Å–æ–∫–∞—è (C++ DLL + WPF UI) |


***

## ‚úÖ **–ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –†–ï–®–ï–ù–ò–Ø**

### **–î–ª—è –±–∏–∑–Ω–µ—Å–∞**

- ‚úÖ **FarCard –º–æ–¥—É–ª—å –ë–ï–°–ü–õ–ê–¢–ù–´–ô** (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤ R-Keeper)[^6_1]
- ‚úÖ –û–¥–Ω–∞ DLL —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–∞—Ö
- ‚úÖ –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π UX —Å iiko –ø–ª–∞–≥–∏–Ω–æ–º
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–Ω–æ Backend API


### **–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**

- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∏–∑ iiko –ø–ª–∞–≥–∏–Ω–∞
- ‚úÖ –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ API endpoints
- ‚úÖ Shared UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (WPF)


### **–î–ª—è –∫–∞—Å—Å–∏—Ä–æ–≤**

- ‚úÖ –ü–æ—Ö–æ–∂–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ iiko
- ‚úÖ –¢–µ –∂–µ 2 –æ–∫–Ω–∞ (–ø–æ–∏—Å–∫ + –æ–ø–µ—Ä–∞—Ü–∏—è)
- ‚úÖ –ü—Ä–∏–≤—ã—á–Ω—ã–π workflow

***

## ‚ö†Ô∏è **–ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–û–ï –†–ï–®–ï–ù–ò–ï (–∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)**

**–¢–æ–ª—å–∫–æ UI –±–µ–∑ external.dll**:

- MaxLoyaltyRKeeperUI.exe –æ–±—â–∞–µ—Ç—Å—è —Å Backend API –Ω–∞–ø—Ä—è–º—É—é
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã –≤ R-Keeper —á–µ—Ä–µ–∑ XML[^6_4][^6_5]
- **–ü—Ä–æ—â–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ** (–≤–µ—Å—å –∫–æ–¥ –Ω–∞ C\#)
- **–ù–û**: –Ω–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ FarCard

***

## üéØ **–ò–¢–û–ì–û**

**–î–ª—è R-Keeper —Ä–µ–∞–ª–∏–∑—É–µ–º –ì–ò–ë–†–ò–î–ù–£–Æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É**:

```
external.dll (C++) ‚îÄ‚îê
                    ‚îú‚îÄ‚ñ∫ Backend API ‚óÑ‚îÄ –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ endpoints!
UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (C#) ‚îÄ‚îò

FarCard (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π) ‚Üí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
XML-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Üí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å iiko, –Ω–æ —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞.[^6_3][^6_2][^6_1]

**–ì–æ—Ç–æ–≤ –∫ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏!** üöÄ
<span style="display:none">[^6_10][^6_11]</span>

<div align="center">‚ÅÇ</div>

[^6_1]: http://soft.carbis.ru/loyalty_soft

[^6_2]: https://scan.osmicards.com/set_r_keeper

[^6_3]: https://int.carbis.ru/docs/Carbis_rkeeper_external_loyalty.pdf

[^6_4]: https://www.youtube.com/watch?v=TS8hiSnQoz8

[^6_5]: https://docs.rkeeper.ru/pages/viewpage.action?pageId=4056664

[^6_6]: Plagin-iiko.md

[^6_7]: https://rkeeper.ru/products/r_keeper/deliveryapi/

[^6_8]: https://docs.rkeeper.com/rkdlv/connection-via-api-23660107.html

[^6_9]: https://docs.rkeeper.ru/ws/white-server-api-v2-27845668.html

[^6_10]: https://docs.eda-platform.ru/ru/ecomm.docs/latest/Account-system/R-keeper_externalmenu

[^6_11]: https://dostavka.yandex.ru/integrations/modules/r-keeper/


---

## üéØ **–û–¢–õ–ò–ß–ù–ê–Ø –ú–´–°–õ–¨! –í–æ—Ç –û–ü–¢–ò–ú–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï –¥–ª—è Touch-Screen**

–ê–±—Å–æ–ª—é—Ç–Ω–æ –≤–µ—Ä–Ω–æ - –Ω–∞ POS-—Ç–µ—Ä–º–∏–Ω–∞–ª–∞—Ö —Ç–æ–ª—å–∫–æ —Å–µ–Ω—Å–æ—Ä–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã! –í–æ—Ç **–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ** –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Ç–æ–¥–æ–≤:

***

## üèÜ **–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–û–ï COMBO-–†–ï–®–ï–ù–ò–ï**

### **1. –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥) ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   R-Keeper Cash                     ‚îÇ
‚îÇ                              [ML]   ‚îÇ ‚Üê Floating Button
‚îÇ   –ó–∞–∫–∞–∑ #12345                      ‚îÇ   (60x60px, –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞)
‚îÇ   ‚Ä¢ –ü–∏—Ü—Ü–∞    500‚ÇΩ                   ‚îÇ
‚îÇ   ‚Ä¢ –ù–∞–ø–∏—Ç–æ–∫  100‚ÇΩ                   ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ   –ò—Ç–æ–≥–æ: 600‚ÇΩ                       ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ   [–û–ø–ª–∞—Ç–∏—Ç—å]  [–û—Ç–º–µ–Ω–∞]             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

[ML] = Max Loyalty –∫–Ω–æ–ø–∫–∞
‚Ä¢ –¶–≤–µ—Ç: #6366F1 (–∏–Ω–¥–∏–≥–æ)
‚Ä¢ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: 70% (–Ω–µ –º–µ—à–∞–µ—Ç)
‚Ä¢ –ü–æ–∑–∏—Ü–∏—è: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è (drag)
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏**:

- **–û–¥–∏–Ω–æ—á–Ω—ã–π —Ç–∞–ø** ‚Üí –û—Ç–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è
- **–î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ (1 —Å–µ–∫)** ‚Üí –†–µ–∂–∏–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (drag)
- **–î–≤–æ–π–Ω–æ–π —Ç–∞–ø** ‚Üí –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
- **–°–≤–∞–π–ø –≤–Ω–∏–∑ –æ—Ç –∫–Ω–æ–ø–∫–∏** ‚Üí –ë—ã—Å—Ç—Ä–æ–µ –º–µ–Ω—é

**–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã**:

```
[ML]  ‚Üê –û–±—ã—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
[MLüü¢] ‚Üê –ö–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ (–∑–µ–ª–µ–Ω–∞—è —Ç–æ—á–∫–∞)
```

**–í–∏–∑—É–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è**:

- –û–±—ã—á–Ω–æ–µ: 70% –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, 60x60px
- –ü—Ä–∏ –∫–∞—Å–∞–Ω–∏–∏: 100% –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, 70x70px (—É–≤–µ–ª–∏—á–µ–Ω–∏–µ)
- –° –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç–æ–π: –ü—É–ª—å—Å–∏—Ä—É—é—â–∞—è –∑–µ–ª–µ–Ω–∞—è —Ç–æ—á–∫–∞

***

### **2. R-Keeper –∫–∞—Å—Ç–æ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ) ‚≠ê‚≠ê‚≠ê‚≠ê**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   R-Keeper Cash                     ‚îÇ
‚îÇ   [–û–ø–ª–∞—Ç–∞][–°–∫–∏–¥–∫–∏][–ì–æ—Å—Ç–∏][MaxLoyalty]‚îÇ ‚Üê –ù–∞—à–∞ –∫–Ω–æ–ø–∫–∞
‚îÇ                                     ‚îÇ
‚îÇ   –ó–∞–∫–∞–∑ #12345                      ‚îÇ
‚îÇ   –ò—Ç–æ–≥–æ: 600‚ÇΩ                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ R-Keeper Manager**:

```
–ö–∞—Å—Å–æ–≤—ã–µ —Å—Ç–∞–Ω—Ü–∏–∏ ‚Üí –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Üí –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
‚îú‚îÄ ButtonText: "Max Loyalty"
‚îú‚îÄ ButtonIcon: ML_Icon.png
‚îú‚îÄ ButtonAction: RunExternalApp
‚îî‚îÄ AppPath: C:\MaxLoyalty\MaxLoyaltyRKeeperUI.exe
```

**–î–æ—Å—Ç—É–ø–Ω–æ**: R-Keeper 7.3+ (–Ω–µ –≤—Å–µ –≤–µ—Ä—Å–∏–∏)

***

### **3. Edge Gesture (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚≠ê‚≠ê‚≠ê‚≠ê**

```
                            ‚ïë ‚Üê –ê–∫—Ç–∏–≤–Ω–∞—è –∑–æ–Ω–∞ (10px)
                            ‚ïë
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïë‚îÄ‚îÄ‚îê
‚îÇ   R-Keeper Cash         ‚ïë  ‚îÇ
‚îÇ                         ‚ïë  ‚îÇ  –°–≤–∞–π–ø –≤–ª–µ–≤–æ
‚îÇ   –ó–∞–∫–∞–∑ #12345          ‚ïë  ‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ñ∫
‚îÇ                         ‚ïë  ‚îÇ  –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ
‚îÇ                         ‚ïë  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïë‚îÄ‚îÄ‚îò
```

**–í–∏–∑—É–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞**: –¢–æ–Ω–∫–∞—è –ø–æ–ª–æ—Å–∫–∞ 2px —Ü–≤–µ—Ç–∞ –±—Ä–µ–Ω–¥–∞ –Ω–∞ –∫—Ä–∞—é —ç–∫—Ä–∞–Ω–∞

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ**:

- **–ë—ã—Å—Ç—Ä—ã–π —Å–≤–∞–π–ø** ‚Üí –û–∫–Ω–æ –ø–æ–∏—Å–∫–∞
- **–ú–µ–¥–ª–µ–Ω–Ω—ã–π —Å–≤–∞–π–ø** ‚Üí –ë—ã—Å—Ç—Ä–æ–µ –º–µ–Ω—é

***

### **4. Hotkey (–∑–∞–ø–∞—Å–Ω–æ–π) ‚≠ê‚≠ê**

`Ctrl+Shift+L` - –¥–ª—è —Å–ª—É—á–∞–µ–≤ –∫–æ–≥–¥–∞ –µ—Å—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–º–µ–Ω–µ–¥–∂–µ—Ä—ã —Å –Ω–æ—É—Ç–±—É–∫–∞–º–∏)

***

## üé® **–ë–´–°–¢–†–û–ï –ú–ï–ù–Æ (—Å–≤–∞–π–ø –≤–Ω–∏–∑ –æ—Ç –∫–Ω–æ–ø–∫–∏)**

```
        [MLüü¢]
          ‚îÇ
          ‚ñº
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ üîç –ü–æ–∏—Å–∫     ‚îÇ
     ‚îÇ ‚ùå –û—Ç–≤—è–∑–∞—Ç—å  ‚îÇ
     ‚îÇ üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞‚îÇ
     ‚îÇ ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## üì± **–û–ö–ù–ê –î–õ–Ø TOUCH-SCREEN**

### **–û–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  MAX LOYALTY            ‚îÇ
‚îÇ  [–¢–µ–ª–µ—Ñ–æ–Ω][6-digit –∫–æ–¥] ‚îÇ ‚Üê –ö—Ä—É–ø–Ω—ã–µ —Ç–∞–±—ã
‚îÇ                         ‚îÇ
‚îÇ  +7 ___ ___ __ __       ‚îÇ ‚Üê –ö—Ä—É–ø–Ω–æ–µ –ø–æ–ª–µ (60px –≤—ã—Å–æ—Ç–∞)
‚îÇ                         ‚îÇ
‚îÇ    [7][8][9]            ‚îÇ ‚Üê –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
‚îÇ    [4][5][6]            ‚îÇ   80x80px –∫–Ω–æ–ø–∫–∏
‚îÇ    [1][2][3]            ‚îÇ
‚îÇ    [‚Üê][0][‚úì]            ‚îÇ
‚îÇ                         ‚îÇ
‚îÇ  [OK - –ù–∞–π—Ç–∏ –≥–æ—Å—Ç—è]     ‚îÇ ‚Üê –ö–Ω–æ–ø–∫–∏ –≤–æ –≤—Å—é —à–∏—Ä–∏–Ω—É
‚îÇ  [–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ]       ‚îÇ   70px –≤—ã—Å–æ—Ç–∞
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **–û–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ (POINTS)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤            ‚îÇ ‚Üê –ö—Ä—É–ø–Ω–æ 28px
‚îÇ  üí∞ 2,450‚ÇΩ              ‚îÇ ‚Üê –ë–∞–ª–∞–Ω—Å 36px
‚îÇ  ‚≠ê Gold                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏: 890‚ÇΩ   ‚îÇ
‚îÇ  –î–æ—Å—Ç—É–ø–Ω–æ: 178‚ÇΩ        ‚îÇ
‚îÇ                         ‚îÇ
‚îÇ  –°–ø–∏—Å–∞—Ç—å: ‚ïê‚óè‚ïê‚ïê‚ïê 178‚ÇΩ   ‚îÇ ‚Üê SLIDER –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–∞!
‚îÇ           ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫    ‚îÇ   (–¥–ª—è touch —É–¥–æ–±–Ω–µ–µ)
‚îÇ                         ‚îÇ
‚îÇ  –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +45   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [–ù–∞—á–∏—Å–ª–∏—Ç—å]            ‚îÇ ‚Üê –ö—Ä—É–ø–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
‚îÇ  [–°–ø–∏—Å–∞—Ç—å]              ‚îÇ   –∏–∫–æ–Ω–∫–∏ + —Ç–µ–∫—Å—Ç
‚îÇ  [–û—Ç–≤—è–∑–∞—Ç—å]             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## ‚öôÔ∏è **–ù–ê–°–¢–†–û–ô–ö–ò FLOATING BUTTON**

–î–æ–ª–≥–∏–π —Ç–∞–ø –Ω–∞ –∫–Ω–æ–ø–∫–µ ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ù–ê–°–¢–†–û–ô–ö–ò              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üìç –ü–æ–∑–∏—Ü–∏—è –∫–Ω–æ–ø–∫–∏      ‚îÇ
‚îÇ    [‚¨â][‚¨Ü][‚¨à]           ‚îÇ ‚Üê 8 preset –ø–æ–∑–∏—Ü–∏–π
‚îÇ    [‚¨Ö]   [‚û°]           ‚îÇ   + custom (drag)
‚îÇ    [‚¨ã][‚¨á][‚¨ä]           ‚îÇ
‚îÇ                         ‚îÇ
‚îÇ  üìè –†–∞–∑–º–µ—Ä              ‚îÇ
‚îÇ    ( ) Small  50px      ‚îÇ
‚îÇ    (‚Ä¢) Medium 60px      ‚îÇ
‚îÇ    ( ) Large  70px      ‚îÇ
‚îÇ                         ‚îÇ
‚îÇ  üé® –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å        ‚îÇ
‚îÇ    50% ‚ïê‚óè‚ïê‚ïê‚ïê‚ïê 70%       ‚îÇ
‚îÇ                         ‚îÇ
‚îÇ  üîä –ó–≤—É–∫–∏ [‚úì]           ‚îÇ
‚îÇ  üì≥ –í–∏–±—Ä–∞—Ü–∏—è [‚úì]        ‚îÇ
‚îÇ  üëÅÔ∏è –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ [ ]     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## üéØ **–°–†–ê–í–ù–ò–¢–ï–õ–¨–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê**

| –ú–µ—Ç–æ–¥ | –£–¥–æ–±—Å—Ç–≤–æ | –°–∫–æ—Ä–æ—Å—Ç—å | Touch-friendly | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è |
| :-- | :-- | :-- | :-- | :-- |
| **Floating Button** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê |
| **R-Keeper Button** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| **Edge Gesture** | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê |
| **Hotkey** | ‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê | ‚≠ê‚≠ê |


***

## ‚úÖ **–ò–¢–û–ì–û–í–ê–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø**

### **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–∞–µ–º**:

1. ‚úÖ **Floating Button** (–æ—Å–Ω–æ–≤–Ω–æ–π) - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω, –ª–µ–≥–∫–æ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è
2. ‚úÖ **R-Keeper Button** (–µ—Å–ª–∏ R-Keeper 7.3+) - –Ω–∞—Ç–∏–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
3. ‚úÖ **Hotkey** (Ctrl+Shift+L) - –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç

### **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ** (–≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö):

4. ‚ö†Ô∏è **Edge Gesture** - –¥–ª—è –æ–ø—ã—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è iiko –ø–ª–∞–≥–∏–Ω–∞**:

- **iiko**: –ö–Ω–æ–ø–∫–∞ –≤ –º–µ–Ω—é –î–û–ü–û–õ–ù–ï–ù–ò–Ø (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è)
- **R-Keeper**: Floating Button + Custom Button (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)

***

## üöÄ **–ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –†–ï–®–ï–ù–ò–Ø**

‚úÖ **–ù–µ —Ç—Ä–µ–±—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã** - –≤—Å—ë –Ω–∞ touch
‚úÖ **–ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø** - –æ–¥–∏–Ω —Ç–∞–ø –Ω–∞ –∫–Ω–æ–ø–∫—É
‚úÖ **–ù–µ –º–µ—à–∞–µ—Ç —Ä–∞–±–æ—Ç–µ** - –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è, –ø–µ—Ä–µ–º–µ—â–∞–µ–º–∞—è
‚úÖ **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ** - —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–π –≤–µ—Ä—Å–∏–∏ R-Keeper
‚úÖ **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ** - –∫–∞—Å—Å–∏—Ä —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ—Ç –∫–∞–∫ —É–¥–æ–±–Ω–æ
‚úÖ **–í–∏–∑—É–∞–ª—å–Ω—ã–π feedback** - –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã

**–ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏!** üé®

---

## ‚úÖ **–û–¢–õ–ò–ß–ù–û! –£–±–∏—Ä–∞–µ–º —Å–ª–∞–π–¥–µ—Ä—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç–∫—Ä–∞–Ω–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã**

–í—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤—ã - —Å–ª–∞–π–¥–µ—Ä—ã –Ω–∞ POS-—Ç–µ—Ä–º–∏–Ω–∞–ª–∞—Ö —Ä–∞–±–æ—Ç–∞—é—Ç –ø–ª–æ—Ö–æ –∏–∑-–∑–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–µ–Ω—Å–æ—Ä–∞. –í–æ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:

***

## üì± **–û–ö–ù–ê –° –≠–ö–†–ê–ù–ù–´–ú–ò –ö–õ–ê–í–ò–ê–¢–£–†–ê–ú–ò**

### **–û–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ POINTS (—Å —Ü–∏—Ñ—Ä–æ–≤–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –°–ü–ò–°–ê–ù–ò–ï –ë–ê–õ–õ–û–í            [‚úï]     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üë§ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤                     ‚îÇ
‚îÇ  üì± +7 999 123-45-67                ‚îÇ
‚îÇ  ‚≠ê Gold                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üí∞ –ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å                 ‚îÇ
‚îÇ     2 450,00 ‚ÇΩ                      ‚îÇ ‚Üê 36px –∫—Ä—É–ø–Ω–æ
‚îÇ                                     ‚îÇ
‚îÇ  –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏:        890,00 ‚ÇΩ    ‚îÇ
‚îÇ  –î–æ—Å—Ç—É–ø–Ω–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é:  178,00 ‚ÇΩ    ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª–æ–≤:  178         ‚îÇ  ‚îÇ ‚Üê –ü–æ–ª–µ –≤–≤–æ–¥–∞
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îÇ
‚îÇ     ‚îÇ  1  ‚îÇ  2  ‚îÇ  3  ‚îÇ             ‚îÇ
‚îÇ     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§             ‚îÇ
‚îÇ     ‚îÇ  4  ‚îÇ  5  ‚îÇ  6  ‚îÇ             ‚îÇ ‚Üê 80x80px –∫–Ω–æ–ø–∫–∏
‚îÇ     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§             ‚îÇ
‚îÇ     ‚îÇ  7  ‚îÇ  8  ‚îÇ  9  ‚îÇ             ‚îÇ
‚îÇ     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§             ‚îÇ
‚îÇ     ‚îÇ  ‚Üê  ‚îÇ  0  ‚îÇ MAX ‚îÇ             ‚îÇ ‚Üê MAX = –∑–µ–ª–µ–Ω–∞—è
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +45 –±–∞–ª–ª–æ–≤       ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  üí≥ –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã             ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  ‚ûï –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å           ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  ‚ùå –û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É             ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ö–Ω–æ–ø–∫–∞ MAX**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Å—Ç–∞–≤–ª—è–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—É—é —Å—É–º–º—É (178‚ÇΩ)

***

### **–û–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ DISCOUNT (–ë–ï–ó –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –°–ö–ò–î–ö–ò          [‚úï]     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üë§ –ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞                  ‚îÇ
‚îÇ  üì± +7 999 765-43-21                ‚îÇ
‚îÇ  ‚≠ê Silver (—Å–∫–∏–¥–∫–∞ 20%)             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üéÅ –í–∞—à–∞ —Å–∫–∏–¥–∫–∞                     ‚îÇ
‚îÇ     20%                             ‚îÇ ‚Üê 48px –æ–≥—Ä–æ–º–Ω–æ
‚îÇ                                     ‚îÇ
‚îÇ  –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏:        890,00 ‚ÇΩ    ‚îÇ
‚îÇ  –°—É–º–º–∞ —Å–∫–∏–¥–∫–∏:         178,00 ‚ÇΩ    ‚îÇ
‚îÇ  –ö –æ–ø–ª–∞—Ç–µ:             712,00 ‚ÇΩ    ‚îÇ
‚îÇ                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚ÑπÔ∏è –°–∫–∏–¥–∫–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –∏ –Ω–µ –º–æ–∂–µ—Ç   ‚îÇ
‚îÇ     –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞                   ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É           ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  ‚ùå –û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É             ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ù–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã** - —Å–∫–∏–¥–∫–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞, –Ω–µ—á–µ–≥–æ –≤–≤–æ–¥–∏—Ç—å!

***

### **–û–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥–æ—Å—Ç—è (–±—É–∫–≤–µ–Ω–Ω–∞—è + —Ü–∏—Ñ—Ä–æ–≤–∞—è)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ù–û–í–´–ô –ì–û–°–¢–¨                [‚úï]     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  –¢–µ–ª–µ—Ñ–æ–Ω *                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  +7 (___) ___-__-__           ‚îÇ  ‚îÇ ‚Üê –¢–∞–ø ‚Üí –¶–ò–§–†–û–í–ê–Ø
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  –ò–º—è *                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  –ò–≤–∞–Ω                         ‚îÇ  ‚îÇ ‚Üê –¢–∞–ø ‚Üí –ë–£–ö–í–ï–ù–ù–ê–Ø
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  ivan@mail.ru                 ‚îÇ  ‚îÇ ‚Üê –¢–∞–ø ‚Üí –ë–£–ö–í–ï–ù–ù–ê–Ø+@
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  ‚úÖ –°–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç—è              ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## ‚å®Ô∏è **–î–í–ê –¢–ò–ü–ê –ö–õ–ê–í–ò–ê–¢–£–†**

### **1. –¶–∏—Ñ—Ä–æ–≤–∞—è (80x80px –∫–Ω–æ–ø–∫–∏)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     [1]  [2]  [3]       ‚îÇ
‚îÇ     [4]  [5]  [6]       ‚îÇ
‚îÇ     [7]  [8]  [9]       ‚îÇ
‚îÇ     [‚Üê]  [0]  [‚úì]       ‚îÇ  ‚Üê ‚úì = –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–î–ª—è —Å—É–º–º—ã –±–∞–ª–ª–æ–≤:
‚îÇ     [‚Üê]  [0]  [MAX]     ‚îÇ  ‚Üê MAX = –∑–µ–ª–µ–Ω–∞—è –∫–Ω–æ–ø–∫–∞
```

**–§—É–Ω–∫—Ü–∏–∏**:

- `1-9, 0` - –≤–≤–æ–¥ —Ü–∏—Ñ—Ä—ã
- `‚Üê` - —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ü–∏—Ñ—Ä—É
- `‚úì` - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å (–∑–∞–∫—Ä—ã—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É)
- `MAX` - –≤—Å—Ç–∞–≤–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–∞–ª–ª–æ–≤)


### **2. –ë—É–∫–≤–µ–Ω–Ω–∞—è (45x60px –∫–Ω–æ–ø–∫–∏)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [–ô][–¶][–£][–ö][–ï][–ù][–ì][–®][–©][–ó][–•][–™]‚îÇ
‚îÇ  [–§][–´][–í][–ê][–ü][–†][–û][–õ][–î][–ñ][–≠] ‚îÇ
‚îÇ   [–Ø][–ß][–°][–ú][–ò][–¢][–¨][–ë][–Æ]      ‚îÇ
‚îÇ [‚áß]  [    –ü–†–û–ë–ï–õ      ]  [‚å´]       ‚îÇ
‚îÇ [–†–£–°] [EN] [123] [‚úì]                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–§—É–Ω–∫—Ü–∏–∏**:

- `–†–£–°/EN` - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞—Å–∫–ª–∞–¥–∫–∏
- `123` - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Ü–∏—Ñ—Ä–æ–≤—É—é
- `‚áß` - Shift (–∑–∞–≥–ª–∞–≤–Ω—ã–µ)
- `‚å´` - Backspace
- `‚úì` - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å

***

## üéØ **–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï**

| –ü–æ–ª–µ –≤–≤–æ–¥–∞ | –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ |
| :-- | :-- |
| –¢–µ–ª–µ—Ñ–æ–Ω | –¶–ò–§–†–û–í–ê–Ø (–∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç +7...) |
| 6-digit –∫–æ–¥ | –¶–ò–§–†–û–í–ê–Ø (–º–∞–∫—Å. 6 —Ü–∏—Ñ—Ä) |
| –°—É–º–º–∞ –±–∞–ª–ª–æ–≤ | –¶–ò–§–†–û–í–ê–Ø + –∫–Ω–æ–ø–∫–∞ MAX |
| –ò–º—è –≥–æ—Å—Ç—è | –ë–£–ö–í–ï–ù–ù–ê–Ø (–†–£–°, –ø–µ—Ä–≤–∞—è –∑–∞–≥–ª–∞–≤–Ω–∞—è) |
| Email | –ë–£–ö–í–ï–ù–ù–ê–Ø (EN, + —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã @.) |


***

## ‚ú® **–ü–û–í–ï–î–ï–ù–ò–ï –ö–õ–ê–í–ò–ê–¢–£–†**

**–û—Ç–∫—Ä—ã—Ç–∏–µ**:

- –¢—Ä–∏–≥–≥–µ—Ä: –¢–∞–ø –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
- –ê–Ω–∏–º–∞—Ü–∏—è: Slide up from bottom (300ms)
- Backdrop: –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (30%)

**–ó–∞–∫—Ä—ã—Ç–∏–µ**:

- –ö–Ω–æ–ø–∫–∞ `‚úì` (–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å)
- –¢–∞–ø –≤–Ω–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–¥–ª—è 6-digit –∫–æ–¥–∞ –ø–æ—Å–ª–µ 6 —Ü–∏—Ñ—Ä)

**Feedback**:

- –í–∏–∑—É–∞–ª—å–Ω—ã–π: –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—è–µ—Ç —Ü–≤–µ—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
- –ó–≤—É–∫–æ–≤–æ–π: –ö–æ—Ä–æ—Ç–∫–∏–π –∫–ª–∏–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –í–∏–±—Ä–∞—Ü–∏—è: Haptic feedback (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)

***

## üìä **–°–†–ê–í–ù–ï–ù–ò–ï: –ë—ã–ª–æ ‚Üí –°—Ç–∞–ª–æ**

| –ë—ã–ª–æ | –°—Ç–∞–ª–æ |
| :-- | :-- |
| ‚ùå –°–ª–∞–π–¥–µ—Ä –¥–ª—è —Å—É–º–º—ã | ‚úÖ –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ + MAX |
| ‚ùå –°–∏—Å—Ç–µ–º–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ | ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —ç–∫—Ä–∞–Ω–Ω–∞—è |
| ‚ùå –ü–ª–æ—Ö–æ–π –æ—Ç–∫–ª–∏–∫ touch | ‚úÖ –ö—Ä—É–ø–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ 80x80px |
| ‚ùå –ù–µ—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –≤–≤–æ–¥–∞ | ‚úÖ –ö–Ω–æ–ø–∫–∞ MAX –¥–ª—è –º–∞–∫—Å–∏–º—É–º–∞ |


***

## üöÄ **–ò–¢–û–ì–û: –§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï**

### **–î–ª—è iiko –ø–ª–∞–≥–∏–Ω–∞**:

‚úÖ –ö–Ω–æ–ø–∫–∞ –≤ –º–µ–Ω—é –î–û–ü–û–õ–ù–ï–ù–ò–Ø
‚úÖ 2 –æ–∫–Ω–∞ —Å —ç–∫—Ä–∞–Ω–Ω—ã–º–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏
‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ UI iiko Front

### **–î–ª—è R-Keeper –ø–ª–∞–≥–∏–Ω–∞**:

‚úÖ Floating Button (–ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è, –ø–µ—Ä–µ–º–µ—â–∞–µ–º–∞—è)
‚úÖ R-Keeper Custom Button (–µ—Å–ª–∏ R-Keeper 7.3+)
‚úÖ 2 –æ–∫–Ω–∞ —Å —ç–∫—Ä–∞–Ω–Ω—ã–º–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ iiko)
‚úÖ WPF Desktop –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

**–í—Å—ë –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è touch-screen POS —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤! –ú–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É.** üé®‚ú®

---

# –¢–µ–ø–µ—Ä—å —Å–¥–µ–ª–∞–π –ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø –ü–õ–ê–ì–ò–ù–ê MAX LOYALTY –¥–ª—è r-kepper —Å–æ –≤—Å–µ–º–∏ –¥–µ—Ç–∞–ª—è–º–∏, –æ—á–µ–Ω—å –ø–æ–¥—Ä–æ–±–Ω–æ

–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º **–ü–û–õ–ù–£–Æ –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Æ –¥–ª—è R-Keeper –ø–ª–∞–≥–∏–Ω–∞** –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å iiko –¥–æ–∫—É–º–µ–Ω—Ç–æ–º, –Ω–æ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π R-Keeper:[^9_1]

***

# üìò **–ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø –ü–õ–ê–ì–ò–ù–ê MAX LOYALTY –î–õ–Ø R-KEEPER**


***

## **üéØ 1. –û–ë–©–ï–ï –û–ü–ò–°–ê–ù–ò–ï**

### **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ Max Loyalty –≤ R-Keeper —á–µ—Ä–µ–∑ –≥–∏–±—Ä–∏–¥–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (external.dll + Desktop UI). –ü–æ–∑–≤–æ–ª—è–µ—Ç –∫–∞—Å—Å–∏—Ä–∞–º –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –∫–∞—Ä—Ç—ã –≥–æ—Å—Ç–µ–π –∫ –∑–∞–∫–∞–∑–∞–º, –ø—Ä–∏–º–µ–Ω—è—Ç—å –±–æ–Ω—É—Å—ã/—Å–∫–∏–¥–∫–∏ –∏ –Ω–∞—á–∏—Å–ª—è—Ç—å –±–∞–ª–ª—ã.

### **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:**

- **DLL**: C++ (Native) –∏–ª–∏ C\# —á–µ—Ä–µ–∑ C++/CLI wrapper
- **UI**: WPF + .NET Framework 4.7.2+
- **R-Keeper API**: XML-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–∞—Å—Å–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
- **Backend API**: REST API Max Loyalty (NestJS)
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: Serilog (structured logging)
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: MemoryCache
- **HTTP**: HttpClient + Polly (retry policies)
- **Shared Memory**: MemoryMappedFile –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏


### **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:**

- Windows 10/11
- R-Keeper 7.x+


### **üîë –ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç iiko:**

| –ê—Å–ø–µ–∫—Ç | iiko | R-Keeper |
| :-- | :-- | :-- |
| **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** | –ü—Ä—è–º–æ–π –ø–ª–∞–≥–∏–Ω (IFrontPlugin SDK) | –ì–∏–±—Ä–∏–¥–Ω–∞—è (external.dll + Desktop UI) |
| **UI** | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ iiko Front | –û—Ç–¥–µ–ª—å–Ω–æ–µ WPF –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ |
| **–ö–Ω–æ–ø–∫–∞** | –í –º–µ–Ω—é –î–û–ü–û–õ–ù–ï–ù–ò–Ø | Floating Button (touch-friendly) |
| **API** | Plugin SDK | XML-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å + FarCard |
| **–õ–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ë–µ—Å–ø–ª–∞—Ç–Ω–æ | FarCard –ë–ï–°–ü–õ–ê–¢–ù–û! |


***

## **üèóÔ∏è 2. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –†–ï–®–ï–ù–ò–Ø**

### **2.1. –¢—Ä–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. MaxLoyaltyRKeeper.dll (External.dll)           ‚îÇ
‚îÇ     ‚Ä¢ C++ DLL –¥–ª—è FarCard –º–æ–¥—É–ª—è                    ‚îÇ
‚îÇ     ‚Ä¢ –†–∞–∑–º–µ—â–µ–Ω–∏–µ: C:\RK7\Plugins\                   ‚îÇ
‚îÇ     ‚Ä¢ –§—É–Ω–∫—Ü–∏—è: –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç R-Keeper ‚Üí Backend API   ‚îÇ
‚îÇ     ‚Ä¢ –í—ã–∑—ã–≤–∞–µ—Ç—Å—è: FarCard –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. MaxLoyaltyRKeeperUI.exe (WPF –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)       ‚îÇ
‚îÇ     ‚Ä¢ C# .NET 4.7.2+                                ‚îÇ
‚îÇ     ‚Ä¢ –†–∞–∑–º–µ—â–µ–Ω–∏–µ: C:\MaxLoyalty\                    ‚îÇ
‚îÇ     ‚Ä¢ –§—É–Ω–∫—Ü–∏—è: UI –¥–ª—è –∫–∞—Å—Å–∏—Ä–æ–≤                      ‚îÇ
‚îÇ     ‚Ä¢ –ó–∞–ø—É—Å–∫: –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ + —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç—Ä–µ–π         ‚îÇ
‚îÇ     ‚Ä¢ Floating Button –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. R-Keeper FarCard (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–æ–¥—É–ª—å)          ‚îÇ
‚îÇ     ‚Ä¢ –ë–ï–°–ü–õ–ê–¢–ù–û (–≤—Ö–æ–¥–∏—Ç –≤ R-Keeper)                 ‚îÇ
‚îÇ     ‚Ä¢ –§—É–Ω–∫—Ü–∏—è: –ü–æ—Å—Ä–µ–¥–Ω–∏–∫ –∫–∞—Å—Å–∞ ‚Üî external.dll       ‚îÇ
‚îÇ     ‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∞: –ß–µ—Ä–µ–∑ R-Keeper Manager             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **2.2. –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:**

```
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ   R-KEEPER CASH      ‚îÇ
                   ‚îÇ  (–∫–∞—Å—Å–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è)  ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ                                         ‚îÇ
         ‚ñº                                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FarCard –º–æ–¥—É–ª—å ‚îÇ                    ‚îÇ XML API R-Keeper    ‚îÇ
‚îÇ  (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)   ‚îÇ                    ‚îÇ localhost:8080      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                                        ‚îÇ
         ‚ñº                                        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MaxLoyaltyRKeeper    ‚îÇ            ‚îÇ MaxLoyaltyRKeeperUI.exe  ‚îÇ
‚îÇ .dll (external.dll)  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ (WPF Desktop UI)         ‚îÇ
‚îÇ ‚Ä¢ GetCardInfo()      ‚îÇ  Shared    ‚îÇ ‚Ä¢ Floating Button        ‚îÇ
‚îÇ ‚Ä¢ ReservePoints()    ‚îÇ  Memory    ‚îÇ ‚Ä¢ Search Window          ‚îÇ
‚îÇ ‚Ä¢ FinalizeTransaction‚îÇ            ‚îÇ ‚Ä¢ Operation Window       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ                                   ‚îÇ
           ‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ         ‚îÇ
           ‚ñº         ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  Backend API         ‚îÇ
    ‚îÇ  Max Loyalty         ‚îÇ
    ‚îÇ  (NestJS)            ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **2.3. Shared Memory –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**

```csharp
// DLL –∏ UI –æ–±—â–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ MemoryMappedFile
MemoryMappedFile.CreateOrOpen("MaxLoyaltyRKeeperShared", 1MB);

// –°–æ–¥–µ—Ä–∂–∏—Ç:
{
  "activeOrders": {
    "order_123": {
      "guestCardId": "uuid",
      "reservationId": "res_456",
      "benefitType": "POINTS",
      "amount": 178.00
    }
  },
  "offlineQueue": [...],
  "backendStatus": "online"
}
```


***

## **‚öôÔ∏è 3. –£–°–¢–ê–ù–û–í–ö–ê –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø**

### **3.1. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫**

```
MaxLoyaltyRKeeperInstaller_Restaurant123.exe
‚îú‚îÄ‚îÄ MaxLoyaltyRKeeper.dll
‚îú‚îÄ‚îÄ MaxLoyaltyRKeeperUI.exe
‚îú‚îÄ‚îÄ Dependencies/
‚îÇ   ‚îú‚îÄ‚îÄ Newtonsoft.Json.dll
‚îÇ   ‚îú‚îÄ‚îÄ Serilog.dll
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ config.json (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π)
‚îú‚îÄ‚îÄ ML_Icon.png
‚îî‚îÄ‚îÄ README.txt
```

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ config.json:**

```json
{
  "backend_api_url": "https://api.maxloyalty.ru",
  "api_key_encrypted": "AES256_encrypted_string_here",
  "restaurant_id": "uuid",
  "rkeeper_xml_api_url": "http://localhost:8080/rk7api/v0/xmlinterface.xml",
  "rkeeper_api_key": "optional_rkeeper_key",
  "offline_queue_max_size": 100,
  "offline_queue_ttl_hours": 24,
  "log_path": "C:\\Logs\\MaxLoyaltyRKeeper\\",
  "log_retention_days": 7,
  "ui_settings": {
    "floating_button_enabled": true,
    "floating_button_position": "TopRight",
    "floating_button_size": "Medium",
    "floating_button_opacity": 0.7,
    "edge_gesture_enabled": false,
    "sounds_enabled": true,
    "vibration_enabled": true,
    "keyboard_size": "Medium"
  }
}
```


### **3.2. –ü—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (8 —à–∞–≥–æ–≤):**

**–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤**

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –ó–∞–ø—Ä–æ—Å UAC elevation

**–®–∞–≥ 2: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ R-Keeper**

```
–ê–≤—Ç–æ–ø–æ–∏—Å–∫:
- C:\RK7\
- C:\Program Files\UCS\RK7\
- Registry: HKLM\SOFTWARE\UCS\RK7

–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí –ó–∞–ø—Ä–æ—Å —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
```

**–®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ DLL**

```
–î–µ–π—Å—Ç–≤–∏–µ: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ MaxLoyaltyRKeeper.dll
–ü—É—Ç—å: C:\RK7\Plugins\MaxLoyaltyRKeeper.dll
Backup: –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è (–µ—Å–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
```

**–®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ UI**

```
–î–µ–π—Å—Ç–≤–∏–µ: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
–ü—É—Ç—å: C:\MaxLoyalty\MaxLoyaltyRKeeperUI.exe
Dependencies: –í—Å–µ DLL –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
Shortcut: –Ø—Ä–ª—ã–∫ –Ω–∞ —Ä–∞–±–æ—á–µ–º —Å—Ç–æ–ª–µ
```

**–®–∞–≥ 5: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**

```
–°–æ–∑–¥–∞–Ω–∏–µ: %AppData%\MaxLoyaltyRKeeper\config.json
–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ: AES-256 (machine-binding)
Key derivation: SHA256(HWID + 'MaxLoyaltySalt')
```

**–®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ FarCard**

```
–ú–µ—Ç–æ–¥: XML API –∏–ª–∏ –ø—Ä—è–º–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  ExternalDllPath: C:\RK7\Plugins\MaxLoyaltyRKeeper.dll
  LogLevel: 2
  TimeoutSeconds: 30
  RetryCount: 3
```

**–®–∞–≥ 7: –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ UI**

```
Registry: HKCU\Software\Microsoft\Windows\CurrentVersion\Run
–ó–Ω–∞—á–µ–Ω–∏–µ: "C:\MaxLoyalty\MaxLoyaltyRKeeperUI.exe --startup"
```

**–®–∞–≥ 8: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ R-Keeper**

```
–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞—Å—Å–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä
–û–ø—Ü–∏–∏: [–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å] [–ü–æ–∑–∂–µ]
–í–∞–∂–Ω–æ: DLL –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
```


***

## **üíª 4. EXTERNAL.DLL –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø**

### **4.1. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (8 —Ñ—É–Ω–∫—Ü–∏–π):**

```cpp
// 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
extern "C" __declspec(dllexport) int __stdcall 
Initialize(const char* configPath);

// 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞—Ä—Ç–µ
extern "C" __declspec(dllexport) int __stdcall 
GetCardInfo(const char* cardNumber, CardInfo* outInfo);

// 3. –†–∞—Å—á–µ—Ç –±–µ–Ω–µ—Ñ–∏—Ç–∞
extern "C" __declspec(dllexport) int __stdcall 
CalculateBenefit(const char* cardId, double checkAmount, BenefitInfo* outBenefit);

// 4. –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –±–∞–ª–ª–æ–≤
extern "C" __declspec(dllexport) int __stdcall 
ReservePoints(const char* cardId, double pointsToSpend, const char* orderId, char* outReservationId);

// 5. –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è —Å–∫–∏–¥–∫–∏
extern "C" __declspec(dllexport) int __stdcall 
ReserveDiscount(const char* cardId, double discountAmount, const char* orderId, char* outReservationId);

// 6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
extern "C" __declspec(dllexport) int __stdcall 
UpdateReservation(const char* reservationId, double newAmount);

// 7. –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
extern "C" __declspec(dllexport) int __stdcall 
FinalizeTransaction(const char* reservationId, double finalAmount, const char* orderId, const char* paymentTypesJson);

// 8. –û—Ç–º–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
extern "C" __declspec(dllexport) int __stdcall 
CancelReservation(const char* reservationId, const char* reason);

// 9. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
extern "C" __declspec(dllexport) void __stdcall 
Shutdown();
```


### **4.2. –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö:**

```cpp
struct CardInfo {
    char guestName[^9_256];
    char phone[^9_32];
    char cardId[^9_64];        // UUID
    char levelName[^9_128];
    int levelId;
    double regularBalance;
    double promoBalance;
    double totalBalance;
    char code6Digit[^9_8];
};

struct BenefitInfo {
    int benefitType;        // 0=POINTS, 1=DISCOUNT
    double maxAllowedToSpend;
    double pointsToEarn;
    double discountPercentage;
    double discountAmount;
    double checkAmount;
    double minCheckAmount;
};

struct OrderContext {
    char orderId[^9_64];
    char guestCardId[^9_64];
    char guestName[^9_256];
    int benefitType;
    int action;             // SPEND/EARN_ONLY/APPLY_DISCOUNT
    double pointsToSpend;
    double maxAllowed;
    double pointsToEarn;
    double discountPercentage;
    double discountAmount;
    char reservationId[^9_64];
    double originalCheckAmount;
    long long appliedAt;    // timestamp
};
```


### **4.3. –õ–æ–≥–∏–∫–∞ Initialize():**

```cpp
int Initialize(const char* configPath) {
    // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    auto config = LoadConfig(configPath);
    
    // 2. –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ API Key
    auto apiKey = DecryptApiKey(config["api_key_encrypted"]);
    
    // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HTTP –∫–ª–∏–µ–Ω—Ç–∞
    httpClient = new HttpClient(config["backend_api_url"], apiKey);
    
    // 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    ConfigureLogging(config["log_path"]);
    
    // 5. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ shared memory
    sharedMemory = OpenMemoryMappedFile("MaxLoyaltyRKeeperShared");
    
    // 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ backend
    if (!httpClient->HealthCheck()) {
        Log("WARNING: Backend offline at startup");
    }
    
    Log("MaxLoyaltyRKeeper.dll initialized successfully");
    return 0;
}
```


***

## **üé® 5. UI –ü–†–ò–õ–û–ñ–ï–ù–ò–ï - –°–¢–†–£–ö–¢–£–†–ê**

### **5.1. –ü—Ä–æ–µ–∫—Ç MaxLoyaltyRKeeperUI:**

```
MaxLoyaltyRKeeperUI/
‚îú‚îÄ‚îÄ App.xaml                          # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ Views/
‚îÇ   ‚îú‚îÄ‚îÄ FloatingButtonWindow.xaml     # –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ GuestSearchWindow.xaml        # –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è
‚îÇ   ‚îú‚îÄ‚îÄ PointsOperationWindow.xaml    # –û–ø–µ—Ä–∞—Ü–∏—è POINTS
‚îÇ   ‚îú‚îÄ‚îÄ DiscountOperationWindow.xaml  # –û–ø–µ—Ä–∞—Ü–∏—è DISCOUNT
‚îÇ   ‚îú‚îÄ‚îÄ CreateGuestWindow.xaml        # –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç—è
‚îÇ   ‚îú‚îÄ‚îÄ DiagnosticsWindow.xaml        # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ SettingsWindow.xaml           # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
‚îú‚îÄ‚îÄ ViewModels/
‚îÇ   ‚îú‚îÄ‚îÄ FloatingButtonViewModel.cs
‚îÇ   ‚îú‚îÄ‚îÄ GuestSearchViewModel.cs
‚îÇ   ‚îú‚îÄ‚îÄ PointsOperationViewModel.cs
‚îÇ   ‚îú‚îÄ‚îÄ DiscountOperationViewModel.cs
‚îÇ   ‚îú‚îÄ‚îÄ CreateGuestViewModel.cs
‚îÇ   ‚îú‚îÄ‚îÄ DiagnosticsViewModel.cs
‚îÇ   ‚îî‚îÄ‚îÄ SettingsViewModel.cs
‚îú‚îÄ‚îÄ UserControls/
‚îÇ   ‚îú‚îÄ‚îÄ NumericKeyboard.xaml          # –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ AlphabeticKeyboard.xaml       # –ë—É–∫–≤–µ–Ω–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ LoadingOverlay.xaml           # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ ErrorDialog.xaml              # –î–∏–∞–ª–æ–≥ –æ—à–∏–±–æ–∫
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyApiClient.cs           # Backend API –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ RKeeperXmlClient.cs           # R-Keeper XML API
‚îÇ   ‚îú‚îÄ‚îÄ SharedMemoryService.cs        # Shared memory
‚îÇ   ‚îú‚îÄ‚îÄ OfflineQueueService.cs        # Offline –æ—á–µ—Ä–µ–¥—å
‚îÇ   ‚îú‚îÄ‚îÄ ConfigService.cs              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ CacheService.cs               # –ö–µ—à
‚îÇ   ‚îú‚îÄ‚îÄ HealthCheckService.cs         # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
‚îÇ   ‚îú‚îÄ‚îÄ MetricsService.cs             # –ú–µ—Ç—Ä–∏–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ NotificationService.cs        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îú‚îÄ‚îÄ GuestInfo.cs
‚îÇ   ‚îú‚îÄ‚îÄ CalculateResponse.cs
‚îÇ   ‚îú‚îÄ‚îÄ OrderContext.cs
‚îÇ   ‚îú‚îÄ‚îÄ RKeeperOrder.cs
‚îÇ   ‚îî‚îÄ‚îÄ RestaurantConfig.cs
‚îî‚îÄ‚îÄ Utils/
    ‚îú‚îÄ‚îÄ Encryption.cs
    ‚îú‚îÄ‚îÄ ErrorHandler.cs
    ‚îî‚îÄ‚îÄ RetryPolicy.cs
```


***

## **üîò 6. FLOATING BUTTON - –î–ï–¢–ê–õ–¨–ù–û**

### **6.1. XAML —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è:**

```xaml
<Window x:Class="MaxLoyaltyRKeeperUI.Views.FloatingButtonWindow"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        Topmost="True"
        ShowInTaskbar="False"
        ResizeMode="NoResize"
        Width="60" Height="60">
    
    <Border CornerRadius="30" Background="#6366F1" 
            Opacity="0.7" 
            Effect="{StaticResource DropShadow}">
        <Grid>
            <TextBlock Text="ML" FontSize="24" FontWeight="Bold"
                       Foreground="White" 
                       HorizontalAlignment="Center" 
                       VerticalAlignment="Center"/>
            
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã -->
            <Ellipse Width="12" Height="12" Fill="#10B981"
                     HorizontalAlignment="Right" VerticalAlignment="Top"
                     Margin="0,5,5,0"
                     Visibility="{Binding HasActiveCard, Converter={StaticResource BoolToVisibility}}">
                <Ellipse.Triggers>
                    <!-- –ü—É–ª—å—Å–∞—Ü–∏—è -->
                    <EventTrigger RoutedEvent="Loaded">
                        <BeginStoryboard>
                            <Storyboard RepeatBehavior="Forever">
                                <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                 From="0.5" To="1.0" Duration="0:0:1"
                                                 AutoReverse="True"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Ellipse.Triggers>
            </Ellipse>
        </Grid>
    </Border>
</Window>
```


### **6.2. –ü–æ–≤–µ–¥–µ–Ω–∏–µ:**

```csharp
public partial class FloatingButtonWindow : Window
{
    private bool isDragging = false;
    private DateTime mouseDownTime;
    
    public FloatingButtonWindow()
    {
        InitializeComponent();
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ config
        LoadPosition();
        
        // –°–æ–±—ã—Ç–∏—è
        MouseDown += OnMouseDown;
        MouseMove += OnMouseMove;
        MouseUp += OnMouseUp;
        MouseEnter += OnMouseEnter;
        MouseLeave += OnMouseLeave;
    }
    
    // –û–¥–∏–Ω–æ—á–Ω—ã–π –∫–ª–∏–∫ ‚Üí –û—Ç–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫ –≥–æ—Å—Ç—è
    private void OnMouseUp(object sender, MouseButtonEventArgs e)
    {
        if (!isDragging && (DateTime.Now - mouseDownTime).TotalMilliseconds < 500)
        {
            OpenGuestSearchWindow();
        }
        isDragging = false;
    }
    
    // –î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ ‚Üí –†–µ–∂–∏–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    private void OnMouseDown(object sender, MouseButtonEventArgs e)
    {
        mouseDownTime = DateTime.Now;
        
        if (e.LeftButton == MouseButtonState.Pressed)
        {
            // –¢–∞–π–º–µ—Ä –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
            Task.Delay(1000).ContinueWith(t =>
            {
                if (Mouse.LeftButton == MouseButtonState.Pressed)
                {
                    Dispatcher.Invoke(() =>
                    {
                        isDragging = true;
                        ShowDragIndicator();
                    });
                }
            });
        }
    }
    
    // Drag
    private void OnMouseMove(object sender, MouseEventArgs e)
    {
        if (isDragging && e.LeftButton == MouseButtonState.Pressed)
        {
            DragMove();
            SavePosition();
        }
    }
    
    // Hover —ç—Ñ—Ñ–µ–∫—Ç
    private void OnMouseEnter(object sender, MouseEventArgs e)
    {
        AnimateOpacity(0.7, 1.0);
        AnimateScale(1.0, 1.1);
    }
    
    private void OnMouseLeave(object sender, MouseEventArgs e)
    {
        AnimateOpacity(1.0, 0.7);
        AnimateScale(1.1, 1.0);
    }
    
    // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
    private void InitializeContextMenu()
    {
        var menu = new ContextMenu();
        menu.Items.Add(new MenuItem { Header = "üîç –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è", Command = OpenSearchCommand });
        menu.Items.Add(new MenuItem { Header = "‚ùå –û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É", Command = UnbindCardCommand });
        menu.Items.Add(new MenuItem { Header = "üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞", Command = OpenDiagnosticsCommand });
        menu.Items.Add(new MenuItem { Header = "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", Command = OpenSettingsCommand });
        menu.Items.Add(new Separator());
        menu.Items.Add(new MenuItem { Header = "‚ùå –í—ã—Ö–æ–¥", Command = ExitCommand });
        
        ContextMenu = menu;
    }
}
```


### **6.3. –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**

```csharp
// 8 preset –ø–æ–∑–∏—Ü–∏–π
public enum ButtonPosition
{
    TopLeft,
    TopCenter,
    TopRight,      // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
    MiddleLeft,
    MiddleRight,
    BottomLeft,
    BottomCenter,
    BottomRight,
    Custom
}

private void LoadPosition()
{
    var config = ConfigService.Load();
    var position = config.UiSettings.FloatingButtonPosition;
    
    switch (position)
    {
        case "TopRight":
            Left = SystemParameters.PrimaryScreenWidth - 80;
            Top = 20;
            break;
        case "Custom":
            Left = config.UiSettings.CustomX;
            Top = config.UiSettings.CustomY;
            break;
        // ... –¥—Ä—É–≥–∏–µ –ø–æ–∑–∏—Ü–∏–∏
    }
}

private void SavePosition()
{
    var config = ConfigService.Load();
    config.UiSettings.CustomX = Left;
    config.UiSettings.CustomY = Top;
    config.UiSettings.FloatingButtonPosition = "Custom";
    ConfigService.Save(config);
}
```


***

## **üîç 7. –û–ö–ù–û –ü–û–ò–°–ö–ê –ì–û–°–¢–Ø**

### **7.1. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  MAX LOYALTY                  [‚úï]   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [  –¢–µ–ª–µ—Ñ–æ–Ω  ] [6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥]      ‚îÇ ‚Üê –¢–∞–±—ã
‚îÇ                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  +7 (999) 123-45-67          ‚îÇ  ‚îÇ ‚Üê –ü–æ–ª–µ –≤–≤–æ–¥–∞ 60px
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îÇ
‚îÇ     ‚îÇ  1  ‚îÇ  2  ‚îÇ  3  ‚îÇ             ‚îÇ
‚îÇ     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§             ‚îÇ
‚îÇ     ‚îÇ  4  ‚îÇ  5  ‚îÇ  6  ‚îÇ             ‚îÇ ‚Üê –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
‚îÇ     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§             ‚îÇ   80x80px –∫–Ω–æ–ø–∫–∏
‚îÇ     ‚îÇ  7  ‚îÇ  8  ‚îÇ  9  ‚îÇ             ‚îÇ
‚îÇ     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§             ‚îÇ
‚îÇ     ‚îÇ  ‚Üê  ‚îÇ  0  ‚îÇ  ‚úì  ‚îÇ             ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã:                   ‚îÇ
‚îÇ  ‚Ä¢ –°—Ç–æ–ª 5 - 890‚ÇΩ [–í—ã–±—Ä–∞—Ç—å]         ‚îÇ
‚îÇ  ‚Ä¢ –°—Ç–æ–ª 12 - 1,450‚ÇΩ [–í—ã–±—Ä–∞—Ç—å]      ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ     üîç –ù–∞–π—Ç–∏ –≥–æ—Å—Ç—è            ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ     ‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ         ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  –°—É–º–º–∞ –∑–∞–∫–∞–∑–∞: 890,00 ‚ÇΩ            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **7.2. ViewModel –ª–æ–≥–∏–∫–∞:**

```csharp
public class GuestSearchViewModel : ViewModelBase
{
    private string searchQuery;
    private ObservableCollection<RKeeperOrder> activeOrders;
    private RKeeperOrder selectedOrder;
    private bool isLoading;
    
    public ICommand SearchGuestCommand { get; }
    public ICommand CreateGuestCommand { get; }
    public ICommand SelectOrderCommand { get; }
    
    public async Task SearchGuestAsync()
    {
        if (string.IsNullOrEmpty(SearchQuery))
        {
            ShowError("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ –∫–æ–¥");
            return;
        }
        
        IsLoading = true;
        
        try
        {
            // 1. –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è —á–µ—Ä–µ–∑ Backend API
            var searchResponse = await loyaltyApiClient.SearchGuestAsync(new SearchRequest
            {
                Phone = IsPhone(SearchQuery) ? SearchQuery : null,
                Code6Digit = IsCode6(SearchQuery) ? SearchQuery : null
            });
            
            if (!searchResponse.Found)
            {
                var result = MessageBox.Show(
                    "–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ?",
                    "–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω",
                    MessageBoxButton.YesNo
                );
                
                if (result == MessageBoxResult.Yes)
                {
                    OpenCreateGuestWindow(SearchQuery);
                }
                return;
            }
            
            var guest = searchResponse.Guest;
            
            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±—Ä–∞–Ω –ª–∏ –∑–∞–∫–∞–∑
            if (SelectedOrder == null)
            {
                ShowError("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑ –∏–∑ —Å–ø–∏—Å–∫–∞");
                return;
            }
            
            // 3. Calculate
            var calcResponse = await loyaltyApiClient.CalculateAsync(new CalculateRequest
            {
                GuestCardId = guest.CardId,
                CheckAmount = SelectedOrder.Amount,
                OrderCategories = SelectedOrder.Categories,
                OrderType = SelectedOrder.Type,
                CalculateOnly = true
            });
            
            // 4. –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏
            OpenOperationWindow(guest, calcResponse, SelectedOrder);
        }
        catch (Exception ex)
        {
            HandleError(ex);
        }
        finally
        {
            IsLoading = false;
        }
    }
    
    private async Task LoadActiveOrdersAsync()
    {
        try
        {
            // –ó–∞–ø—Ä–æ—Å –∫ R-Keeper XML API
            var orders = await rkeeperXmlClient.GetOrderListAsync();
            ActiveOrders = new ObservableCollection<RKeeperOrder>(orders);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to load active orders");
        }
    }
}
```


### **7.3. R-Keeper XML API - GetOrderList:**

```csharp
public class RKeeperXmlClient
{
    private readonly HttpClient httpClient;
    private readonly string xmlApiUrl;
    
    public async Task<List<RKeeperOrder>> GetOrderListAsync()
    {
        var xml = @"
            <RK7Query>
              <RK7CMD CMD=""GetOrderList""/>
            </RK7Query>
        ";
        
        var response = await httpClient.PostAsync(
            xmlApiUrl,
            new StringContent(xml, Encoding.UTF8, "text/xml")
        );
        
        var responseXml = await response.Content.ReadAsStringAsync();
        
        // –ü–∞—Ä—Å–∏–Ω–≥ XML
        var doc = XDocument.Parse(responseXml);
        var orders = doc.Descendants("Order").Select(o => new RKeeperOrder
        {
            Id = o.Element("ident").Value,
            TableNumber = o.Element("Table")?.Value,
            Amount = decimal.Parse(o.Element("Amount").Value),
            Status = o.Element("Status").Value,
            Type = ParseOrderType(o.Element("OrderType")?.Value)
        }).ToList();
        
        return orders;
    }
}
```


***

## **üí≥ 8. –û–ö–ù–û –û–ü–ï–†–ê–¶–ò–ò (POINTS)**

### **8.1. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –°–ü–ò–°–ê–ù–ò–ï –ë–ê–õ–õ–û–í            [‚úï]     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üë§ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤                     ‚îÇ
‚îÇ  üì± +7 999 123-45-67                ‚îÇ
‚îÇ  ‚≠ê Gold                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üí∞ –ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å                 ‚îÇ
‚îÇ     2 450,00 ‚ÇΩ                      ‚îÇ ‚Üê 36px
‚îÇ                                     ‚îÇ
‚îÇ  –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏:        890,00 ‚ÇΩ    ‚îÇ
‚îÇ  –î–æ—Å—Ç—É–ø–Ω–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é:  178,00 ‚ÇΩ    ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª–æ–≤:  178         ‚îÇ  ‚îÇ ‚Üê –ü–æ–ª–µ –≤–≤–æ–¥–∞
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îÇ
‚îÇ     ‚îÇ  1  ‚îÇ  2  ‚îÇ  3  ‚îÇ             ‚îÇ
‚îÇ     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§             ‚îÇ
‚îÇ     ‚îÇ  4  ‚îÇ  5  ‚îÇ  6  ‚îÇ             ‚îÇ
‚îÇ     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§             ‚îÇ
‚îÇ     ‚îÇ  7  ‚îÇ  8  ‚îÇ  9  ‚îÇ             ‚îÇ
‚îÇ     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§             ‚îÇ
‚îÇ     ‚îÇ  ‚Üê  ‚îÇ  0  ‚îÇ MAX ‚îÇ             ‚îÇ ‚Üê MAX –∑–µ–ª–µ–Ω–∞—è
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +45 –±–∞–ª–ª–æ–≤       ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  üí≥ –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã             ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  ‚ûï –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å           ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  ‚ùå –û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É             ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **8.2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ –∑–∞–∫–∞–∑—É:**

```csharp
private async Task ApplyPointsAsync()
{
    var pointsToSpend = decimal.Parse(PointsToSpendInput.Text);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (pointsToSpend > MaxAllowed)
    {
        ShowError($"–ú–∞–∫—Å–∏–º—É–º: {MaxAllowed:N0}‚ÇΩ");
        return;
    }
    
    ShowLoading("–†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –±–∞–ª–ª–æ–≤...");
    
    try
    {
        // 1. –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –Ω–∞ backend
        var reserveResponse = await loyaltyApiClient.ReservePointsAsync(new ReserveRequest
        {
            GuestCardId = Guest.CardId,
            PointsToSpend = pointsToSpend,
            MaxAllowed = MaxAllowed,
            CheckAmount = CheckAmount,
            OrderId = SelectedOrder.Id,
            RestaurantId = restaurantConfig.RestaurantId
        });
        
        if (!reserveResponse.Success)
        {
            HideLoading();
            ShowError(reserveResponse.Error);
            return;
        }
        
        // 2. –ü—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã –∫ –∑–∞–∫–∞–∑—É —á–µ—Ä–µ–∑ XML
        await rkeeperXmlClient.BindCardToOrderAsync(
            SelectedOrder.Id,
            Guest.Phone  // –∏–ª–∏ code6Digit
        );
        
        // 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ –∫ –∑–∞–∫–∞–∑—É (—Å—É–º–º–∞ pointsToSpend)
        await rkeeperXmlClient.ApplyManualDiscountAsync(
            SelectedOrder.Id,
            pointsToSpend
        );
        
        // 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ shared memory
        await sharedMemoryService.SaveOrderContextAsync(new OrderContext
        {
            OrderId = SelectedOrder.Id,
            GuestCardId = Guest.CardId,
            GuestName = Guest.Name,
            BenefitType = BenefitType.Points,
            Action = LoyaltyAction.Spend,
            PointsToSpend = pointsToSpend,
            MaxAllowed = MaxAllowed,
            PointsToEarn = PointsToEarn,
            ReservationId = reserveResponse.ReservationId,
            OriginalCheckAmount = CheckAmount,
            AppliedAt = DateTime.Now
        });
        
        HideLoading();
        
        // 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Floating Button –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
        FloatingButtonViewModel.HasActiveCard = true;
        
        // 6. –ú–µ—Ç—Ä–∏–∫–∏
        metricsService.RecordMetric("loyalty.points.applied", pointsToSpend);
        
        // 7. Success
        ShowSuccess(
            $"‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ {pointsToSpend:N0}‚ÇΩ –±–∞–ª–ª–æ–≤ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ\n\n" +
            $"–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +{PointsToEarn} –±–∞–ª–ª–æ–≤"
        );
        
        DialogResult = true;
        Close();
    }
    catch (Exception ex)
    {
        HideLoading();
        HandleError(ex);
    }
}
```


### **8.3. R-Keeper XML - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏:**

```csharp
public async Task ApplyManualDiscountAsync(string orderId, decimal discountAmount)
{
    var xml = $@"
        <RK7Query>
          <RK7CMD CMD=""SaveOrder"">
            <Order>
              <ident>{orderId}</ident>
              <Discount>
                <Type>MANUAL</Type>
                <Value>{discountAmount}</Value>
                <Reason>Max Loyalty - –ë–∞–ª–ª—ã</Reason>
              </Discount>
            </Order>
          </RK7CMD>
        </RK7Query>
    ";
    
    await httpClient.PostAsync(xmlApiUrl, new StringContent(xml, Encoding.UTF8, "text/xml"));
}
```


***

## **‚úÖ 9. –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ö–†–´–¢–ò–ò –ß–ï–ö–ê**

### **9.1. FarCard –≤—ã–∑—ã–≤–∞–µ—Ç FinalizeTransaction:**

```cpp
// R-Keeper ‚Üí FarCard ‚Üí external.dll ‚Üí FinalizeTransaction

int FinalizeTransaction(
    const char* reservationId,
    double finalAmount,
    const char* orderId,
    const char* paymentTypesJson
) {
    Log("FinalizeTransaction called: Order=%s, Amount=%.2f", orderId, finalAmount);
    
    // 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ shared memory
    auto context = GetOrderContextFromSharedMemory(orderId);
    
    if (context == nullptr) {
        Log("ERROR: No context found for order %s", orderId);
        return -1;
    }
    
    // 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ backend
    json request = {
        {"guestCardId", context->guestCardId},
        {"orderId", orderId},
        {"reservationId", reservationId},
        {"checkAmount", context->originalCheckAmount},
        {"finalCheckAmount", finalAmount},
        {"pointsSpent", context->pointsToSpend},
        {"pointsToEarn", context->pointsToEarn},
        {"action", context->action},
        {"paymentTypes", json::parse(paymentTypesJson)},
        {"cashierName", GetCurrentCashierName()},
        {"orderType", "DINE_IN"}
    };
    
    try {
        // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend
        auto response = httpClient->Post(
            "/api/pos-integration/rkeeper/finalize-points",
            request
        );
        
        if (response["success"].get<bool>()) {
            Log("Finalized successfully: TransactionId=%s", 
                response["transactionId"].get<std::string>().c_str());
            
            // 4. –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ shared memory
            ClearOrderContextFromSharedMemory(orderId);
            
            // 5. –û–±–Ω–æ–≤–ª—è–µ–º UI (—á–µ—Ä–µ–∑ shared memory)
            NotifyUI("order_finalized", orderId);
            
            return 0;
        } else {
            Log("ERROR: Backend returned success=false");
            return -1;
        }
    }
    catch (const std::exception& ex) {
        Log("ERROR: Exception in FinalizeTransaction: %s", ex.what());
        
        // 6. –î–æ–±–∞–≤–ª—è–µ–º –≤ offline queue
        AddToOfflineQueue(context, finalAmount);
        
        return -2; // Offline queued
    }
}
```


***

## **üì¥ 10. OFFLINE –†–ï–ñ–ò–ú**

### **10.1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ offline:**

```csharp
public class HealthCheckService
{
    private bool isBackendHealthy = true;
    private Timer healthCheckTimer;
    
    public void StartMonitoring()
    {
        healthCheckTimer = new Timer(60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        healthCheckTimer.Elapsed += async (s, e) => await CheckHealthAsync();
        healthCheckTimer.Start();
    }
    
    public async Task<HealthStatus> CheckHealthAsync()
    {
        try
        {
            var cts = new CancellationTokenSource(TimeSpan.FromSeconds(2));
            var response = await httpClient.GetAsync("/api/health", cts.Token);
            
            isBackendHealthy = response.IsSuccessStatusCode;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º shared memory
            await sharedMemoryService.UpdateBackendStatusAsync(
                isBackendHealthy ? "online" : "offline"
            );
        }
        catch
        {
            isBackendHealthy = false;
            await sharedMemoryService.UpdateBackendStatusAsync("offline");
        }
        
        return isBackendHealthy ? HealthStatus.Healthy : HealthStatus.Offline;
    }
}
```


### **10.2. Offline queue:**

```csharp
public class OfflineQueueService
{
    private readonly string queueFilePath;
    private const int MaxQueueSize = 100;
    private const int TtlHours = 24;
    
    public void EnqueueOperation(OfflineOperation operation)
    {
        var queue = LoadQueue();
        
        if (queue.Count >= MaxQueueSize)
        {
            throw new InvalidOperationException("Offline queue is full");
        }
        
        operation.QueuedAt = DateTime.UtcNow;
        queue.Add(operation);
        
        SaveQueue(queue);
        
        logger.LogWarning(
            "Operation queued for offline: Type={Type}, OrderId={OrderId}",
            operation.Type,
            operation.OrderId
        );
        
        metricsService.RecordMetric("loyalty.offline_queued", 1);
    }
    
    public async Task ProcessQueueAsync()
    {
        var queue = LoadQueue();
        
        if (queue.Count == 0)
            return;
        
        logger.LogInformation("Processing offline queue: {Count} operations", queue.Count);
        
        var processed = new List<OfflineOperation>();
        
        foreach (var operation in queue)
        {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ TTL (24 —á–∞—Å–∞)
            if (DateTime.UtcNow - operation.QueuedAt > TimeSpan.FromHours(TtlHours))
            {
                logger.LogWarning("Operation expired: {Id}", operation.Id);
                processed.Add(operation);
                continue;
            }
            
            try
            {
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ backend
                if (operation.Type == "FINALIZE_POINTS")
                {
                    await loyaltyApiClient.FinalizePointsAsync(operation.Context);
                }
                else if (operation.Type == "FINALIZE_DISCOUNT")
                {
                    await loyaltyApiClient.FinalizeDiscountAsync(operation.Context);
                }
                
                processed.Add(operation);
                logger.LogInformation("Processed offline operation: {Id}", operation.Id);
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "Failed to process offline operation: {Id}", operation.Id);
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö
        queue.RemoveAll(op => processed.Contains(op));
        SaveQueue(queue);
        
        if (processed.Count > 0)
        {
            NotificationService.Show(
                "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
                $"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {processed.Count} –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ –æ—á–µ—Ä–µ–¥–∏",
                NotificationType.Success
            );
        }
    }
}
```


***

## **‚å®Ô∏è 11. –≠–ö–†–ê–ù–ù–´–ï –ö–õ–ê–í–ò–ê–¢–£–†–´**

### **11.1. –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (NumericKeyboard.xaml):**

```xaml
<UserControl x:Class="MaxLoyaltyRKeeperUI.UserControls.NumericKeyboard">
    <Grid Width="300" Height="400">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        
        <!-- –ö–Ω–æ–ø–∫–∏ 1-9 -->
        <Button Grid.Row="0" Grid.Column="0" Content="1" 
                Style="{StaticResource NumericButtonStyle}"
                Command="{Binding KeyPressCommand}" CommandParameter="1"/>
        <Button Grid.Row="0" Grid.Column="1" Content="2" 
                Command="{Binding KeyPressCommand}" CommandParameter="2"/>
        <!-- ... –∫–Ω–æ–ø–∫–∏ 3-9 ... -->
        
        <!-- –ù–∏–∂–Ω–∏–π —Ä—è–¥ -->
        <Button Grid.Row="3" Grid.Column="0" Content="‚Üê" 
                Style="{StaticResource BackspaceButtonStyle}"
                Command="{Binding BackspaceCommand}"/>
        <Button Grid.Row="3" Grid.Column="1" Content="0" 
                Command="{Binding KeyPressCommand}" CommandParameter="0"/>
        
        <!-- –ö–Ω–æ–ø–∫–∞ MAX –∏–ª–∏ ‚úì -->
        <Button Grid.Row="3" Grid.Column="2" 
                Content="{Binding ThirdButtonContent}"
                Style="{Binding ThirdButtonStyle}"
                Command="{Binding ThirdButtonCommand}"/>
    </Grid>
</UserControl>
```


### **11.2. –ë—É–∫–≤–µ–Ω–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (AlphabeticKeyboard.xaml):**

```xaml
<UserControl x:Class="MaxLoyaltyRKeeperUI.UserControls.AlphabeticKeyboard">
    <Grid Width="600" Height="300">
        <!-- 4 —Ä—è–¥–∞ –∫–ª–∞–≤–∏—à -->
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <!-- –†—è–¥ 1: –ô–¶–£–ö–ï–ù–ì–®–©–ó–•–™ -->
        <StackPanel Grid.Row="0" Orientation="Horizontal">
            <Button Content="–ô" Command="{Binding KeyPressCommand}" CommandParameter="–ô"/>
            <Button Content="–¶" Command="{Binding KeyPressCommand}" CommandParameter="–¶"/>
            <!-- ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ ... -->
        </StackPanel>
        
        <!-- –†—è–¥ 2: –§–´–í–ê–ü–†–û–õ–î–ñ–≠ -->
        <!-- ... -->
        
        <!-- –†—è–¥ 3: –Ø–ß–°–ú–ò–¢–¨–ë–Æ -->
        <!-- ... -->
        
        <!-- –†—è–¥ 4: –°–ª—É–∂–µ–±–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
        <StackPanel Grid.Row="3" Orientation="Horizontal">
            <Button Content="‚áß" Width="70" Command="{Binding ShiftCommand}"/>
            <Button Content="–ü–†–û–ë–ï–õ" Width="250" Command="{Binding SpaceCommand}"/>
            <Button Content="‚å´" Width="70" Command="{Binding BackspaceCommand}"/>
        </StackPanel>
        
        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ -->
        <StackPanel Orientation="Horizontal" Grid.Row="4">
            <Button Content="–†–£–°" Command="{Binding SwitchLayoutCommand}" CommandParameter="RU"/>
            <Button Content="EN" Command="{Binding SwitchLayoutCommand}" CommandParameter="EN"/>
            <Button Content="123" Command="{Binding SwitchToNumericCommand}"/>
            <Button Content="‚úì" Command="{Binding ConfirmCommand}"/>
        </StackPanel>
    </Grid>
</UserControl>
```


### **11.3. ViewModel –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã:**

```csharp
public class NumericKeyboardViewModel : ViewModelBase
{
    private string displayValue;
    private bool hasMaxButton;
    private decimal maxValue;
    
    public string DisplayValue
    {
        get => displayValue;
        set => SetProperty(ref displayValue, value);
    }
    
    public ICommand KeyPressCommand { get; }
    public ICommand BackspaceCommand { get; }
    public ICommand MaxCommand { get; }
    public ICommand ConfirmCommand { get; }
    
    private void OnKeyPress(string key)
    {
        DisplayValue += key;
        RaiseInputChanged();
    }
    
    private void OnBackspace()
    {
        if (DisplayValue.Length > 0)
        {
            DisplayValue = DisplayValue.Substring(0, DisplayValue.Length - 1);
            RaiseInputChanged();
        }
    }
    
    private void OnMax()
    {
        DisplayValue = maxValue.ToString("0");
        RaiseInputChanged();
    }
    
    public event EventHandler<string> InputChanged;
    public event EventHandler ConfirmPressed;
}
```


***

## **üìä 12. BACKEND API ENDPOINTS**

```typescript
// –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è
POST /api/pos-integration/rkeeper/search-guest
Body: { phone?: string, code6Digit?: string }
Response: { found: boolean, guest?: GuestInfo }

// –†–∞—Å—á–µ—Ç –±–µ–Ω–µ—Ñ–∏—Ç–æ–≤
POST /api/pos-integration/rkeeper/calculate
Body: { guestCardId, checkAmount, orderCategories, orderType }
Response: { benefitType: 'POINTS'|'DISCOUNT', ...data }

// –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è POINTS
POST /api/pos-integration/rkeeper/reserve-points
Body: { guestCardId, pointsToSpend, maxAllowed, checkAmount, orderId }
Response: { success: boolean, reservationId?: string }

// –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è DISCOUNT
POST /api/pos-integration/rkeeper/reserve-discount
Body: { guestCardId, discountPercentage, discountAmount, checkAmount, orderId }
Response: { success: boolean, reservationId?: string }

// –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è POINTS
POST /api/pos-integration/rkeeper/finalize-points
Body: { guestCardId, orderId, reservationId, pointsSpent, pointsToEarn, ... }
Response: { success: boolean, newBalance: number, transactionId: string }

// –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è DISCOUNT
POST /api/pos-integration/rkeeper/finalize-discount
Body: { guestCardId, orderId, reservationId, discountAmount, ... }
Response: { success: boolean, transactionId: string }

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
GET /api/pos-integration/rkeeper/config
Response: { restaurantId, minCheckAmount, maxSpendPercentage, ... }

// –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç—è
POST /api/pos-integration/rkeeper/create-guest
Body: { phone, name?, birthDate? }
Response: { success: boolean, guestCardId: string, code6Digit: string }

// –û—Ç–º–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
POST /api/pos-integration/rkeeper/cancel-reservation
Body: { reservationId, orderId, reason }
Response: { success: boolean }

// –ó–¥–æ—Ä–æ–≤—å–µ backend
GET /api/health
Response: { status: 'ok' }

// –ú–µ—Ç—Ä–∏–∫–∏
POST /api/pos-integration/rkeeper/metrics
Body: [ { name, value, tags, timestamp }, ... ]
Response: { received: true }
```


***

## **‚úÖ 13. –ò–¢–û–ì–û–í–ê–Ø –°–•–ï–ú–ê WORKFLOW**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              R-KEEPER CASH STATION               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                               ‚îÇ
    ‚ñº                               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FarCard   ‚îÇ            ‚îÇ  Floating Button ‚îÇ ‚Üê –ö–∞—Å—Å–∏—Ä —Ç–∞–ø–∞–µ—Ç
‚îÇ  (–∞–≤—Ç–æ)    ‚îÇ            ‚îÇ  (–≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ                            ‚îÇ
      ‚ñº                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ external.dll     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÇ GuestSearchWindow      ‚îÇ
‚îÇ ‚Ä¢ GetCardInfo()  ‚îÇ    ‚îÇ ‚Ä¢ –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É    ‚îÇ
‚îÇ ‚Ä¢ ReservePoints()‚îÇ    ‚îÇ ‚Ä¢ –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞  ‚îÇ
‚îÇ ‚Ä¢ Finalize...()  ‚îÇ    ‚îÇ ‚Ä¢ –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                         ‚îÇ
       ‚îÇ    Shared Memory        ‚îÇ
       ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
       ‚îÇ                         ‚îÇ
       ‚îÇ                         ‚ñº
       ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ              ‚îÇ PointsOperationWindow  ‚îÇ
       ‚îÇ              ‚îÇ ‚Ä¢ –ë–∞–ª–∞–Ω—Å 2,450‚ÇΩ       ‚îÇ
       ‚îÇ              ‚îÇ ‚Ä¢ –°–ø–∏—Å–∞—Ç—å: [^9_178] ‚úèÔ∏è   ‚îÇ
       ‚îÇ              ‚îÇ ‚Ä¢ –¶–∏—Ñ—Ä–æ–≤–∞—è + MAX       ‚îÇ
       ‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                       ‚îÇ
       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Backend API Max Loyalty        ‚îÇ
‚îÇ   ‚Ä¢ /search-guest                ‚îÇ
‚îÇ   ‚Ä¢ /calculate                   ‚îÇ
‚îÇ   ‚Ä¢ /reserve-points              ‚îÇ
‚îÇ   ‚Ä¢ /finalize-points             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   R-Keeper —á–µ—Ä–µ–∑ XML API         ‚îÇ
‚îÇ   ‚Ä¢ SaveOrder (—Å–∫–∏–¥–∫–∞)           ‚îÇ
‚îÇ   ‚Ä¢ GetOrderList                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## **‚úÖ 14. –ß–ï–ö–õ–ò–°–¢ –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–ò**

### **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

- ‚úÖ –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É/6-digit –∫–æ–¥—É
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è —Å –∫–∞—Å—Å—ã
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ POINTS (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ DISCOUNT (—Å–∫–∏–¥–æ—á–Ω–∞—è)
- ‚úÖ Floating Button (touch-friendly)
- ‚úÖ –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (80x80px –∫–Ω–æ–ø–∫–∏)
- ‚úÖ –ë—É–∫–≤–µ–Ω–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–†–£–°/EN)
- ‚úÖ –ö–Ω–æ–ø–∫–∞ MAX –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã
- ‚úÖ –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ (EarnOnly)
- ‚úÖ –û—Ç–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã
- ‚úÖ –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è + –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ XML API R-Keeper
- ‚úÖ External.dll –¥–ª—è FarCard


### **UI/UX:**

- ‚úÖ Floating Button (–ø–µ—Ä–µ–º–µ—â–∞–µ–º–∞—è)
- ‚úÖ Touch-friendly (–º–∏–Ω–∏–º—É–º 60x60px)
- ‚úÖ –≠–∫—Ä–∞–Ω–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
- ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã (–∑–µ–ª–µ–Ω–∞—è —Ç–æ—á–∫–∞)
- ‚úÖ Loading overlays
- ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏


### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**

- ‚úÖ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API Key (AES-256)
- ‚úÖ Machine-binding
- ‚úÖ Revoke —á–µ—Ä–µ–∑ backend
- ‚úÖ HTTPS only


### **Offline —Ä–µ–∂–∏–º:**

- ‚úÖ Health checks –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- ‚úÖ Offline queue (–º–∞–∫—Å. 100 –æ–ø–µ—Ä–∞—Ü–∏–π, TTL 24—á)
- ‚úÖ –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- ‚úÖ Shared memory –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞


### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**

- ‚úÖ Serilog (7 –¥–Ω–µ–π —Ä–æ—Ç–∞—Ü–∏—è)
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –Ω–∞ backend (–±–∞—Ç—á –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω)
- ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —ç–∫—Ä–∞–Ω
- ‚úÖ –õ–∏–º–∏—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ 50MB

***

## **üìã –ò–¢–û–ì–û**

**–ü–ª–∞–≥–∏–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!**

1. ‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: –ì–∏–±—Ä–∏–¥–Ω–∞—è (external.dll + WPF UI)
2. ‚úÖ **UI**: Touch-friendly —Å floating button
3. ‚úÖ **–ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã**: –¶–∏—Ñ—Ä–æ–≤–∞—è + –ë—É–∫–≤–µ–Ω–Ω–∞—è (–†–£–°/EN)
4. ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: XML API + FarCard (–ë–ï–°–ü–õ–ê–¢–ù–û)
5. ‚úÖ **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: Shared Memory
6. ‚úÖ **Offline**: Queue + –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
7. ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: AES-256 + machine-binding

**–û—Ç–ª–∏—á–∏–µ –æ—Ç iiko**: –í–Ω–µ—à–Ω–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞, –Ω–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–¥–µ–Ω—Ç–∏—á–µ–Ω! üöÄ

<div align="center">‚ÅÇ</div>

[^9_1]: Plagin-iiko.md


---

# ‚úÖ **–î–ê! –ú–û–ñ–ï–ú –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –£–ü–†–û–°–¢–ò–¢–¨!**

–°–¥–µ–ª–∞–µ–º **–¢–û–ß–ù–û –ö–ê–ö –í iiko**: –°–∫–∞—á–∞–ª ‚Üí –ó–∞–ø—É—Å—Ç–∏–ª ‚Üí –†–∞–±–æ—Ç–∞–µ—à—å!

***

## üöÄ **–£–ü–†–û–©–ï–ù–ù–´–ô –ü–†–û–¶–ï–°–° –£–°–¢–ê–ù–û–í–ö–ò**

### **–ß—Ç–æ –≤–∏–¥–∏—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å Max Loyalty                   ‚îÇ
‚îÇ  –†–µ—Å—Ç–æ—Ä–∞–Ω—ã ‚Üí "–ü–∏—Ü—Ü–µ—Ä–∏—è –£ –ú–∞—Ä–∏–æ"            ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  POS –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:                            ‚îÇ
‚îÇ  ‚òë iiko Front                               ‚îÇ
‚îÇ  ‚òë R-Keeper                                 ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  [üì• –°–∫–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ R-Keeper]           ‚îÇ
‚îÇ      ‚Üì                                      ‚îÇ
‚îÇ  MaxLoyaltyInstaller_Restaurant123.exe      ‚îÇ
‚îÇ  (15 MB, —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## üì¶ **–û–î–ò–ù –£–°–¢–ê–ù–û–í–©–ò–ö = –í–°–Å –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò**

### **–®–∞–≥ 1: –°–∫–∞—á–∞—Ç—å –∏–∑ –∞–¥–º–∏–Ω–∫–∏** ‚úÖ

```
‚Ä¢ –§–∞–π–ª: MaxLoyaltyInstaller_Restaurant123.exe
‚Ä¢ –°–æ–¥–µ—Ä–∂–∏—Ç: DLL + UI + –ö–æ–Ω—Ñ–∏–≥ (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π API Key)
‚Ä¢ –†–∞–∑–º–µ—Ä: ~15 MB
```


### **–®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç—å (–¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫)** ‚úÖ

```
‚Ä¢ Windows –ø–æ–ø—Ä–æ—Å–∏—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞ (UAC) - –û–î–ò–ù –†–ê–ó
‚Ä¢ –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò!
```


### **–®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–µ–ª–∞–µ—Ç –í–°–Å –∑–∞ 30 —Å–µ–∫—É–Ω–¥** ‚úÖ

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Max Loyalty - –£—Å—Ç–∞–Ω–æ–≤–∫–∞                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 75%              ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  ‚úÖ R-Keeper –Ω–∞–π–¥–µ–Ω: C:\RK7\               ‚îÇ
‚îÇ  ‚úÖ DLL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞                         ‚îÇ
‚îÇ  ‚úÖ UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ               ‚îÇ
‚îÇ  ‚úÖ FarCard –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏          ‚îÇ
‚îÇ  ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É                ‚îÇ
‚îÇ  üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...             ‚îÇ
‚îÇ                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **–®–∞–≥ 4: –§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω** ‚úÖ

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üéâ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚úÖ Max Loyalty –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ              ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (–≤ —Ç—Ä–µ–µ)            ‚îÇ
‚îÇ  Floating button –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ –∫–∞—Å—Å–µ          ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  ‚ö†Ô∏è –í–ê–ñ–ù–û:                                  ‚îÇ
‚îÇ  –î–ª—è –ø–æ–ª–Ω–æ–π —Ä–∞–±–æ—Ç—ã DLL –Ω—É–∂–µ–Ω –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫     ‚îÇ
‚îÇ  R-Keeper –∫–∞—Å—Å–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞                 ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  [–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å R-Keeper —Å–µ–π—á–∞—Å]            ‚îÇ ‚Üê –ú–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
‚îÇ  [–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∑–∂–µ –≤—Ä—É—á–Ω—É—é]              ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  üí° UI —Ä–∞–±–æ—Ç–∞–µ—Ç –£–ñ–ï –°–ï–ô–ß–ê–°!                 ‚îÇ
‚îÇ  –ú–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## üîß **–ß–¢–û –î–ï–õ–ê–ï–¢ –£–°–¢–ê–ù–û–í–©–ò–ö –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò**

### **1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ R-Keeper (–±–µ–∑ —É—á–∞—Å—Ç–∏—è –∞–¥–º–∏–Ω–∞)**

```csharp
private string FindRKeeperPath()
{
    // –ü–æ–ø—ã—Ç–∫–∞ 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—É—Ç–∏
    var paths = new[]
    {
        @"C:\RK7\",
        @"C:\Program Files\UCS\RK7\",
        @"C:\Program Files (x86)\UCS\RK7\"
    };
    
    foreach (var path in paths)
    {
        if (Directory.Exists(path) && File.Exists(Path.Combine(path, "RK7.exe")))
            return path;
    }
    
    // –ü–æ–ø—ã—Ç–∫–∞ 2: –†–µ–µ—Å—Ç—Ä
    var regKey = Registry.LocalMachine.OpenSubKey(@"SOFTWARE\UCS\RK7");
    if (regKey != null)
    {
        var installPath = regKey.GetValue("InstallPath") as string;
        if (!string.IsNullOrEmpty(installPath))
            return installPath;
    }
    
    // –ü–æ–ø—ã—Ç–∫–∞ 3: –ü–æ–∏—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ R-Keeper
    var rk7Process = Process.GetProcessesByName("RK7").FirstOrDefault();
    if (rk7Process != null)
    {
        return Path.GetDirectoryName(rk7Process.MainModule.FileName);
    }
    
    return null; // –ù–µ –Ω–∞–π–¥–µ–Ω
}
```


### **2. –ê–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ FarCard (–±–µ–∑ —Ä—É—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π)**

```csharp
private void ConfigureFarCardAutomatically()
{
    // –ú–µ—Ç–æ–¥ 1: –ß–µ—Ä–µ–∑ XML API R-Keeper
    try
    {
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""ConfigureFarCard"">
                <Settings>
                  <ExternalDllPath>{dllPath}</ExternalDllPath>
                  <Enabled>true</Enabled>
                  <LogLevel>2</LogLevel>
                </Settings>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await httpClient.PostAsync(
            "http://localhost:8080/rk7api/v0/xmlinterface.xml",
            new StringContent(xml, Encoding.UTF8, "text/xml")
        );
        
        if (response.IsSuccessStatusCode)
        {
            Log("FarCard configured via XML API");
            return;
        }
    }
    catch
    {
        // Fallback –∫ –º–µ—Ç–æ–¥—É 2
    }
    
    // –ú–µ—Ç–æ–¥ 2: –ü—Ä—è–º–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞
    var configPath = Path.Combine(rk7Path, "config", "FarCard.xml");
    
    if (File.Exists(configPath))
    {
        var doc = XDocument.Load(configPath);
        
        var settings = doc.Descendants("ExternalDll").FirstOrDefault();
        if (settings == null)
        {
            settings = new XElement("ExternalDll");
            doc.Root.Add(settings);
        }
        
        settings.SetElementValue("Path", dllPath);
        settings.SetElementValue("Enabled", "true");
        
        doc.Save(configPath);
        Log("FarCard configured via config file");
    }
}
```


### **3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ R-Keeper (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)**

```csharp
private async Task RestartRKeeperServiceAsync()
{
    try
    {
        // –ù–∞—Ö–æ–¥–∏–º —Å–ª—É–∂–±—É R-Keeper
        var service = ServiceController.GetServices()
            .FirstOrDefault(s => s.ServiceName.Contains("RKeeper") || s.ServiceName.Contains("RK7"));
        
        if (service != null)
        {
            ShowProgress("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ R-Keeper...");
            service.Stop();
            service.WaitForStatus(ServiceControllerStatus.Stopped, TimeSpan.FromSeconds(30));
            
            await Task.Delay(2000);
            
            ShowProgress("–ó–∞–ø—É—Å–∫ R-Keeper...");
            service.Start();
            service.WaitForStatus(ServiceControllerStatus.Running, TimeSpan.FromSeconds(30));
            
            Log("R-Keeper service restarted successfully");
            return true;
        }
    }
    catch (Exception ex)
    {
        Log($"Could not restart service automatically: {ex.Message}");
    }
    
    return false; // –ü–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
}
```


***

## üí° **–ö–õ–Æ–ß–ï–í–ê–Ø –§–ò–®–ö–ê: UI –†–ê–ë–û–¢–ê–ï–¢ –ë–ï–ó –ü–ï–†–ï–ó–ê–ü–£–°–ö–ê!**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –°–†–ê–ó–£ –ü–û–°–õ–ï –£–°–¢–ê–ù–û–í–ö–ò:                      ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  ‚úÖ UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç                   ‚îÇ
‚îÇ  ‚úÖ Floating Button –≤–∏–¥–µ–Ω                    ‚îÇ
‚îÇ  ‚úÖ –ú–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å –≥–æ—Å—Ç–µ–π                      ‚îÇ
‚îÇ  ‚úÖ –ú–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –∫–∞—Ä—Ç—ã                  ‚îÇ
‚îÇ  ‚úÖ –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç        ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  ‚è≥ External.dll –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è:                 ‚îÇ
‚îÇ     ‚Ä¢ –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ R-Keeper             ‚îÇ
‚îÇ     ‚Ä¢ –ò–ª–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏    ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  üìå –î–û –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:                          ‚îÇ
‚îÇ     UI –æ–±—â–∞–µ—Ç—Å—è —Å backend –Ω–∞–ø—Ä—è–º—É—é           ‚îÇ
‚îÇ     –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å–∫–∏–¥–∫–∏ —á–µ—Ä–µ–∑ XML API           ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  üìå –ü–û–°–õ–ï –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:                       ‚îÇ
‚îÇ     DLL —Ç–æ–∂–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è                    ‚îÇ
‚îÇ     FarCard –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫–∞—Ä—Ç–∞–º–∏         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## üéØ **–°–†–ê–í–ù–ï–ù–ò–ï: –ë–´–õ–û vs –°–¢–ê–õ–û**

### **–ë–´–õ–û (—Å–ª–æ–∂–Ω–æ):**

```
1. –°–∫–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å
3. –£–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ R-Keeper –≤—Ä—É—á–Ω—É—é ‚ùå
4. –í—ã–±—Ä–∞—Ç—å –∫—É–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å DLL ‚ùå
5. –í—ã–±—Ä–∞—Ç—å –∫—É–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å UI ‚ùå
6. –û—Ç–∫—Ä—ã—Ç—å R-Keeper Manager ‚ùå
7. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å FarCard –≤—Ä—É—á–Ω—É—é ‚ùå
8. –£–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ DLL ‚ùå
9. –î–æ–±–∞–≤–∏—Ç—å UI –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É –≤—Ä—É—á–Ω—É—é ‚ùå
10. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å R-Keeper –≤—Ä—É—á–Ω—É—é ‚ùå
11. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é ‚ùå

–ò–¢–û–ì–û: ~15-20 –º–∏–Ω—É—Ç + –Ω—É–∂–Ω—ã –∑–Ω–∞–Ω–∏—è R-Keeper
```


### **–°–¢–ê–õ–û (–ø—Ä–æ—Å—Ç–æ):**

```
1. –°–∫–∞—á–∞—Ç—å MaxLoyaltyInstaller_Restaurant123.exe –∏–∑ –∞–¥–º–∏–Ω–∫–∏ ‚úÖ
2. –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Üí UAC –∑–∞–ø—Ä–æ—Å (1 —Ä–∞–∑) ‚úÖ
3. –ü–æ–¥–æ–∂–¥–∞—Ç—å 30 —Å–µ–∫—É–Ω–¥ ‚è±Ô∏è
4. [–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ] –ù–∞–∂–∞—Ç—å "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å R-Keeper" ‚úÖ

–ò–¢–û–ì–û: 1 –º–∏–Ω—É—Ç–∞! –ë–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π!
```


***

## üî• **–§–ò–ù–ê–õ–¨–ù–´–ô WORKFLOW**

```
–ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–† –†–ï–°–¢–û–†–ê–ù–ê:

1. –ó–∞—Ö–æ–¥–∏—Ç –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å Max Loyalty
   ‚Üì
2. –ù–∞–∂–∏–º–∞–µ—Ç [–°–∫–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ R-Keeper]
   ‚Üì
3. –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–∞–π–ª –Ω–∞ –∫–∞—Å—Å–æ–≤–æ–π —Å—Ç–∞–Ω—Ü–∏–∏
   ‚Üì
4. –í–∏–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å 30 —Å–µ–∫—É–Ω–¥
   ‚Üì
5. –ù–∞–∂–∏–º–∞–µ—Ç [–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å R-Keeper] (–∏–ª–∏ "–ø–æ–∑–∂–µ")
   ‚Üì
6. –ì–û–¢–û–í–û! UI —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ö–ê–°–°–ò–†:

1. –í–∏–¥–∏—Ç Floating Button –≤ —É–≥–ª—É —ç–∫—Ä–∞–Ω–∞
   ‚Üì
2. –¢–∞–ø–∞–µ—Ç ‚Üí –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è
   ‚Üì
3. –í–≤–æ–¥–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω
   ‚Üì
4. –°–ø–∏—Å—ã–≤–∞–µ—Ç –±–∞–ª–ª—ã
   ‚Üì
5. –†–ê–ë–û–¢–ê–ï–¢!
```


***

## ‚úÖ **–ò–¢–û–ì–û: –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ü–†–û–°–¢–û**

### **–ß—Ç–æ —É–±—Ä–∞–ª–∏:**

‚ùå –†—É—á–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –ø—É—Ç–µ–π
‚ùå –†—É—á–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É FarCard
‚ùå –†—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤
‚ùå –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É
‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∑–Ω–∞–Ω–∏–π R-Keeper

### **–ß—Ç–æ –æ—Å—Ç–∞–≤–∏–ª–∏:**

‚úÖ –û–¥–∏–Ω EXE —Ñ–∞–π–ª
‚úÖ –û–¥–∏–Ω –∫–ª–∏–∫ –∑–∞–ø—É—Å–∫–∞
‚úÖ 30 —Å–µ–∫—É–Ω–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ R-Keeper (–º–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å –∞–≤—Ç–æ)
‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –°–†–ê–ó–£ –ü–û–°–õ–ï —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (—á–µ—Ä–µ–∑ UI)

### **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

üéØ **–°–∫–∞—á–∞–ª ‚Üí –ó–∞–ø—É—Å—Ç–∏–ª ‚Üí –†–∞–±–æ—Ç–∞–µ—Ç**
üéØ –¢–æ—á–Ω–æ –∫–∞–∫ –≤ iiko, –Ω–æ —Å —É—á–µ—Ç–æ–º –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π R-Keeper
üéØ 1 –º–∏–Ω—É—Ç–∞ –≤–º–µ—Å—Ç–æ 15-20 –º–∏–Ω—É—Ç
üéØ –ù–µ –Ω—É–∂–Ω—ã —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∑–Ω–∞–Ω–∏—è

**–¢–∞–∫ –¥–µ–ª–∞–µ–º?** üöÄ

---

# ‚úÖ **–î–ê, –¢–û–ß–ù–û –¢–ê–ö –ñ–ï –ö–ê–ö –í iiko!**

–ü–æ–ª–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ R-Keeper –∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å —Å **tenant ‚Üí restaurant ‚Üí terminal**.

***

## üîó **–ü–†–û–¶–ï–°–° –ü–†–ò–í–Ø–ó–ö–ò R-KEEPER –ö –ü–õ–ê–¢–§–û–†–ú–ï**

### **–®–∞–≥ 1: –ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∫—É –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ MAX LOYALTY                       ‚îÇ
‚îÇ  Tenant: "–°–µ—Ç—å –ü–∏—Ü—Ü–µ—Ä–∏–π –ú–∞—Ä–∏–æ"                 ‚îÇ
‚îÇ  –†–µ—Å—Ç–æ—Ä–∞–Ω: "–ü–∏—Ü—Ü–µ—Ä–∏—è –£ –ú–∞—Ä–∏–æ - –¶–µ–Ω—Ç—Ä"          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  POS –ò–ù–¢–ï–ì–†–ê–¶–ò–ò:                                ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚òë iiko Front                                   ‚îÇ
‚îÇ    ‚Ä¢ –§–∏–ª–∏–∞–ª: –¶–µ–Ω—Ç—Ä                              ‚îÇ
‚îÇ    ‚Ä¢ –¢–µ—Ä–º–∏–Ω–∞–ª–æ–≤: 3                              ‚îÇ
‚îÇ    ‚Ä¢ –°—Ç–∞—Ç—É—Å: üü¢ –ê–∫—Ç–∏–≤–Ω–æ                         ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚òê R-Keeper (–Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω)                      ‚îÇ
‚îÇ    [‚ûï –î–æ–±–∞–≤–∏—Ç—å R-Keeper –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é]            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

         ‚¨áÔ∏è –ù–∞–∂–∏–º–∞–µ–º [–î–æ–±–∞–≤–∏—Ç—å R-Keeper]

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ù–û–í–ê–Ø R-KEEPER –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  –†–µ—Å—Ç–æ—Ä–∞–Ω: [–ü–∏—Ü—Ü–µ—Ä–∏—è –£ –ú–∞—Ä–∏–æ - –¶–µ–Ω—Ç—Ä ‚ñº]        ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ –ö–∞—Å—Å–∞ 1 (–æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª)                   ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  R-Keeper Station ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ STATION_001                              ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  R-Keeper XML API URL:                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ http://localhost:8080/rk7api/v0/...     ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  [–°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é]                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

         ‚¨áÔ∏è Backend —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å

DATABASE:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ rkeeper_plugin_installations                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id: "inst_abc123"                               ‚îÇ
‚îÇ tenant_id: "tenant_mario"                       ‚îÇ
‚îÇ restaurant_id: "rest_centro"                    ‚îÇ
‚îÇ terminal_name: "–ö–∞—Å—Å–∞ 1 (–æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª)"        ‚îÇ
‚îÇ station_id: "STATION_001"                       ‚îÇ
‚îÇ api_key: "rk_live_xYz789..." (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω)    ‚îÇ
‚îÇ xml_api_url: "http://localhost:8080/..."       ‚îÇ
‚îÇ status: "PENDING_INSTALLATION"                  ‚îÇ
‚îÇ created_at: "2026-02-18T00:29:00Z"             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

         ‚¨áÔ∏è –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞!                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  –¢–µ—Ä–º–∏–Ω–∞–ª: –ö–∞—Å—Å–∞ 1 (–æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª)              ‚îÇ
‚îÇ  API Key: rk_live_xYz789...                     ‚îÇ
‚îÇ  –°—Ç–∞—Ç—É—Å: ‚è≥ –û–∂–∏–¥–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏                   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  üì• –°–ö–ê–ß–ê–¢–¨ –£–°–¢–ê–ù–û–í–©–ò–ö:                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ [‚¨áÔ∏è MaxLoyaltyRKeeper_Kassa1.exe]         ‚îÇ  ‚îÇ ‚Üê –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ô!
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  –í —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –∑–∞—à–∏—Ç—ã:                           ‚îÇ
‚îÇ  ‚Ä¢ Tenant ID                                    ‚îÇ
‚îÇ  ‚Ä¢ Restaurant ID                                ‚îÇ
‚îÇ  ‚Ä¢ Terminal ID                                  ‚îÇ
‚îÇ  ‚Ä¢ API Key (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π)                      ‚îÇ
‚îÇ  ‚Ä¢ XML API URL                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## üì¶ **–ß–¢–û –ó–ê–®–ò–¢–û –í –£–°–¢–ê–ù–û–í–©–ò–ö**

### **MaxLoyaltyRKeeper_Kassa1.exe —Å–æ–¥–µ—Ä–∂–∏—Ç:**

```json
{
  "installation_id": "inst_abc123",
  "tenant_id": "tenant_mario",
  "tenant_name": "–°–µ—Ç—å –ü–∏—Ü—Ü–µ—Ä–∏–π –ú–∞—Ä–∏–æ",
  "restaurant_id": "rest_centro",
  "restaurant_name": "–ü–∏—Ü—Ü–µ—Ä–∏—è –£ –ú–∞—Ä–∏–æ - –¶–µ–Ω—Ç—Ä",
  "terminal_id": "term_001",
  "terminal_name": "–ö–∞—Å—Å–∞ 1 (–æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª)",
  "station_id": "STATION_001",
  "api_key_encrypted": "AES256_encrypted_rk_live_xYz789...",
  "backend_api_url": "https://api.maxloyalty.ru",
  "xml_api_url": "http://localhost:8080/rk7api/v0/xmlinterface.xml",
  "environment": "production"
}
```

**–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API Key:**

```csharp
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞
var machineKey = GenerateMachineKey(); // –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–∞ —Ü–µ–ª–µ–≤–æ–π –º–∞—à–∏–Ω–µ
var encryptedKey = EncryptApiKey(apiKey, machineKey);

// –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ:
var currentMachineKey = GetCurrentMachineId();
var decryptedKey = DecryptApiKey(encryptedKey, currentMachineKey);
// –¢–µ–ø–µ—Ä—å API Key –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞—Å—Å–µ!
```


***

## üîÑ **WORKFLOW: –û–¢ –ê–î–ú–ò–ù–ö–ò –î–û –ê–ù–ê–õ–ò–¢–ò–ö–ò**

### **1. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≤—è–∑–∫–∏**

```typescript
// Backend: POST /api/admin/rkeeper/installations

async createRKeeperInstallation(dto: CreateRKeeperInstallationDto) {
  // 1. –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
  const installation = await this.prisma.rKeeperPluginInstallation.create({
    data: {
      tenantId: dto.tenantId,
      restaurantId: dto.restaurantId,
      terminalName: dto.terminalName,
      stationId: dto.stationId,
      apiKey: generateApiKey('rk_live_'), // rk_live_xxxxx
      xmlApiUrl: dto.xmlApiUrl,
      status: 'PENDING_INSTALLATION'
    }
  });
  
  // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫
  const installerPath = await this.installerService.generateInstaller({
    installationId: installation.id,
    tenantId: dto.tenantId,
    restaurantId: dto.restaurantId,
    terminalName: dto.terminalName,
    apiKey: installation.apiKey,
    xmlApiUrl: dto.xmlApiUrl
  });
  
  return {
    installation,
    installerDownloadUrl: installerPath
  };
}
```


### **2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ –∫–∞—Å—Å–µ**

```
–ö–∞—Å—Å–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç: MaxLoyaltyRKeeper_Kassa1.exe
         ‚¨áÔ∏è
–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ —á–∏—Ç–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π config.json
         ‚¨áÔ∏è
–†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç API Key –¥–ª—è —ç—Ç–æ–π –º–∞—à–∏–Ω—ã
         ‚¨áÔ∏è
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç DLL + UI —Å –∫–æ–Ω—Ñ–∏–≥–æ–º
         ‚¨áÔ∏è
config.json –Ω–∞ –∫–∞—Å—Å–µ:
{
  "installation_id": "inst_abc123",
  "tenant_id": "tenant_mario",
  "restaurant_id": "rest_centro",
  "terminal_id": "term_001",
  "api_key": "rk_live_xYz789...",
  ...
}
         ‚¨áÔ∏è
UI –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ backend
         ‚¨áÔ∏è
Backend –≤–∏–¥–∏—Ç: 
  X-API-Key: rk_live_xYz789...
  X-Installation-Id: inst_abc123
         ‚¨áÔ∏è
Backend –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å:
  status: PENDING_INSTALLATION ‚Üí ACTIVE
  first_connected_at: NOW()
```


### **3. –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç**

```typescript
// –í—Å–µ API –∑–∞–ø—Ä–æ—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞—é—Ç:

POST /api/pos-integration/rkeeper/search-guest
Headers:
  X-API-Key: rk_live_xYz789...
  X-Installation-Id: inst_abc123
  X-Tenant-Id: tenant_mario
  X-Restaurant-Id: rest_centro
  X-Terminal-Id: term_001
  X-Station-Id: STATION_001
  X-Plugin-Version: 1.0.0

Body: { phone: "+79991234567" }

         ‚¨áÔ∏è

Backend –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞–µ—Ç:
‚Ä¢ –ö–∞–∫–æ–π tenant
‚Ä¢ –ö–∞–∫–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω
‚Ä¢ –ö–∞–∫–æ–π —Ç–µ—Ä–º–∏–Ω–∞–ª
‚Ä¢ –ö–∞–∫–∞—è –∫–∞—Å—Å–∞ R-Keeper
```


### **4. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**

```typescript
// –ü—Ä–∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:

POST /api/pos-integration/rkeeper/finalize-points

Backend —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ loyalty_transactions                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id: "txn_xyz"                                   ‚îÇ
‚îÇ tenant_id: "tenant_mario"           ‚Üê ‚úÖ        ‚îÇ
‚îÇ restaurant_id: "rest_centro"        ‚Üê ‚úÖ        ‚îÇ
‚îÇ terminal_id: "term_001"             ‚Üê ‚úÖ        ‚îÇ
‚îÇ station_id: "STATION_001"           ‚Üê ‚úÖ        ‚îÇ
‚îÇ pos_type: "R_KEEPER"                ‚Üê ‚úÖ        ‚îÇ
‚îÇ pos_order_id: "order_12345"                     ‚îÇ
‚îÇ guest_card_id: "card_abc"                       ‚îÇ
‚îÇ points_spent: 178.00                            ‚îÇ
‚îÇ points_earned: 45.00                            ‚îÇ
‚îÇ cashier_name: "–ò–≤–∞–Ω–æ–≤–∞ –ê."                      ‚îÇ
‚îÇ created_at: "2026-02-18T00:30:00Z"             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–¢–µ–ø–µ—Ä—å –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –º–æ–∂–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å:
‚Ä¢ –ü–æ tenant (–≤—Å–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã —Å–µ—Ç–∏)
‚Ä¢ –ü–æ restaurant (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∏–ª–∏–∞–ª)
‚Ä¢ –ü–æ terminal (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∫–∞—Å—Å–∞)
‚Ä¢ –ü–æ POS —Å–∏—Å—Ç–µ–º–µ (R-Keeper vs iiko)
```


***

## üìä **–ê–ù–ê–õ–ò–¢–ò–ö–ê –í –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–ò**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ê–ù–ê–õ–ò–¢–ò–ö–ê –¢–†–ê–ù–ó–ê–ö–¶–ò–ô                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  –ü–µ—Ä–∏–æ–¥: –ó–∞ —Å–µ–≥–æ–¥–Ω—è                             ‚îÇ
‚îÇ  –†–µ—Å—Ç–æ—Ä–∞–Ω: [–í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã ‚ñº]                      ‚îÇ
‚îÇ  POS: [–í—Å–µ —Å–∏—Å—Ç–µ–º—ã ‚ñº]                           ‚îÇ
‚îÇ  –¢–µ—Ä–º–∏–Ω–∞–ª: [–í—Å–µ –∫–∞—Å—Å—ã ‚ñº]                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                 ‚îÇ
‚îÇ  üìç –ü–∏—Ü—Ü–µ—Ä–∏—è –£ –ú–∞—Ä–∏–æ - –¶–µ–Ω—Ç—Ä                    ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ     iiko Front:                                 ‚îÇ
‚îÇ     ‚Ä¢ –ö–∞—Å—Å–∞ 1 (iiko): 45 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π            ‚îÇ
‚îÇ     ‚Ä¢ –ö–∞—Å—Å–∞ 2 (iiko): 38 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π            ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ     R-Keeper:                                   ‚îÇ
‚îÇ     ‚Ä¢ –ö–∞—Å—Å–∞ 1 (–æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª): 52 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚úÖ ‚îÇ
‚îÇ     ‚Ä¢ –ö–∞—Å—Å–∞ 2 (–ª–µ—Ç–Ω—è—è –≤–µ—Ä–∞–Ω–¥–∞): 31 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è  ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  üìç –ü–∏—Ü—Ü–µ—Ä–∏—è –£ –ú–∞—Ä–∏–æ - –ó–∞–ø–∞–¥                    ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ     R-Keeper:                                   ‚îÇ
‚îÇ     ‚Ä¢ –ö–∞—Å—Å–∞ 1: 67 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π                   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è #txn_xyz                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –†–µ—Å—Ç–æ—Ä–∞–Ω: –ü–∏—Ü—Ü–µ—Ä–∏—è –£ –ú–∞—Ä–∏–æ - –¶–µ–Ω—Ç—Ä              ‚îÇ
‚îÇ –¢–µ—Ä–º–∏–Ω–∞–ª: –ö–∞—Å—Å–∞ 1 (–æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª)                ‚îÇ
‚îÇ POS: R-Keeper (Station STATION_001)             ‚îÇ
‚îÇ –ó–∞–∫–∞–∑: #order_12345                             ‚îÇ
‚îÇ –ì–æ—Å—Ç—å: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ (+7 999 123 45 67)          ‚îÇ
‚îÇ –ö–∞—Å—Å–∏—Ä: –ò–≤–∞–Ω–æ–≤–∞ –ê.                              ‚îÇ
‚îÇ –°–ø–∏—Å–∞–Ω–æ: 178,00 ‚ÇΩ                               ‚îÇ
‚îÇ –ù–∞—á–∏—Å–ª–µ–Ω–æ: +45 –±–∞–ª–ª–æ–≤                           ‚îÇ
‚îÇ –í—Ä–µ–º—è: 18.02.2026 00:30                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## üîê **–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: API KEY –ü–û –£–°–¢–ê–ù–û–í–ö–ï**

### **–ö–∞–∂–¥—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª = —É–Ω–∏–∫–∞–ª—å–Ω—ã–π API Key**

```
–ü–∏—Ü—Ü–µ—Ä–∏—è –£ –ú–∞—Ä–∏–æ - –¶–µ–Ω—Ç—Ä:
‚îú‚îÄ iiko Front (–ö–∞—Å—Å–∞ 1): iiko_live_aaa111...
‚îú‚îÄ iiko Front (–ö–∞—Å—Å–∞ 2): iiko_live_bbb222...
‚îú‚îÄ R-Keeper (–ö–∞—Å—Å–∞ 1):   rk_live_ccc333...   ‚Üê –£–ù–ò–ö–ê–õ–¨–ù–´–ô!
‚îî‚îÄ R-Keeper (–ö–∞—Å—Å–∞ 2):   rk_live_ddd444...   ‚Üê –£–ù–ò–ö–ê–õ–¨–ù–´–ô!

–ü–∏—Ü—Ü–µ—Ä–∏—è –£ –ú–∞—Ä–∏–æ - –ó–∞–ø–∞–¥:
‚îî‚îÄ R-Keeper (–ö–∞—Å—Å–∞ 1):   rk_live_eee555...   ‚Üê –£–ù–ò–ö–ê–õ–¨–ù–´–ô!

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
‚úÖ –ú–æ–∂–µ–º –æ—Ç–æ–∑–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–∞—Å—Å—É
‚úÖ –í–∏–¥–∏–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –∫–∞—Å—Å–∞–º
‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: —É–∫—Ä–∞–ª –∫–ª—é—á = —Ç–æ–ª—å–∫–æ 1 –∫–∞—Å—Å–∞
‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç–æ—á–Ω–∞—è –¥–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
```


### **Revoke –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞—Å—Å—ã:**

```
–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å ‚Üí R-Keeper –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Üí –ö–∞—Å—Å–∞ 1
[‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å —ç—Ç—É –∫–∞—Å—Å—É]

         ‚¨áÔ∏è

Backend: installations.status = 'REVOKED'

         ‚¨áÔ∏è

–ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ —Å —ç—Ç–æ–π –∫–∞—Å—Å—ã:
{
  "error": "API Key revoked",
  "message": "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É"
}

         ‚¨áÔ∏è

UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
"‚ö†Ô∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"
```


***

## üè¢ **–ú–£–õ–¨–¢–ò–¢–ï–ù–ê–ù–¢–ù–û–°–¢–¨**

```typescript
// Backend –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–æ–ª–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ:

class RKeeperIntegrationService {
  async searchGuest(apiKey: string, phone: string) {
    // 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ API Key
    const installation = await this.getInstallationByApiKey(apiKey);
    
    if (!installation) {
      throw new UnauthorizedException('Invalid API Key');
    }
    
    const { tenantId, restaurantId, terminalId } = installation;
    
    // 2. –ò—â–µ–º –≥–æ—Å—Ç—è –¢–û–õ–¨–ö–û –≤ —ç—Ç–æ–º tenant
    const guest = await this.prisma.guestCard.findFirst({
      where: {
        tenantId,           // ‚Üê –ò–∑–æ–ª—è—Ü–∏—è –ø–æ tenant!
        phone,
        isActive: true
      }
    });
    
    // 3. –õ–æ–≥–∏—Ä—É–µ–º —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
    this.logger.log({
      message: 'Guest search',
      tenantId,
      restaurantId,
      terminalId,
      found: !!guest
    });
    
    return { found: !!guest, guest };
  }
}
```


***

## ‚úÖ **–ò–¢–û–ì–û: –¢–û–ß–ù–û –ö–ê–ö –í iiko**

### **–ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç:**

```
1. –°–æ–∑–¥–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
2. –°–∫–∞—á–∏–≤–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫
3. –í–∏–¥–∏—Ç —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–π –∫–∞—Å—Å—ã
4. –í–∏–¥–∏—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º
5. –ú–æ–∂–µ—Ç –æ—Ç–∫–ª—é—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–∞—Å—Å—É
```


### **Backend –∑–Ω–∞–µ—Ç:**

```
‚úÖ Tenant ID (—Å–µ—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤)
‚úÖ Restaurant ID (—Ñ–∏–ª–∏–∞–ª)
‚úÖ Terminal ID (–∫–∞—Å—Å–∞)
‚úÖ Station ID (R-Keeper station)
‚úÖ POS Type (R-Keeper vs iiko)
‚úÖ –ö–∞—Å—Å–∏—Ä (–∏–∑ R-Keeper)
```


### **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

```
‚úÖ –ü–æ —Å–µ—Ç—è–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
‚úÖ –ü–æ —Ñ–∏–ª–∏–∞–ª–∞–º
‚úÖ –ü–æ –∫–∞—Å—Å–∞–º
‚úÖ –ü–æ POS —Å–∏—Å—Ç–µ–º–∞–º
‚úÖ –ü–æ –∫–∞—Å—Å–∏—Ä–∞–º
‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ R-Keeper vs iiko
```


### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**

```
‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π API Key –Ω–∞ –∫–∞—Å—Å—É
‚úÖ Machine-binding (–ø—Ä–∏–≤—è–∑–∫–∞ –∫ –∂–µ–ª–µ–∑—É)
‚úÖ Revoke –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–∞—Å—Å
‚úÖ –ú—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è
```

**–í—Å—ë —Ç–æ—á—å-–≤-—Ç–æ—á—å –∫–∞–∫ –≤ iiko, –Ω–æ –¥–ª—è R-Keeper!** üéØ

---

# üìò **–ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø –ü–õ–ê–ì–ò–ù–ê MAX LOYALTY –î–õ–Ø R-KEEPER**


***

## **üìã –°–û–î–ï–†–ñ–ê–ù–ò–ï**

1. [–û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ](#1-%D0%BE%D0%B1%D1%89%D0%B5%D0%B5-%D0%BE%D0%BF%D0%B8%D1%81%D0%B0%D0%BD%D0%B8%D0%B5)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è](#2-%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0-%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D1%8F)
3. [–ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏–≤—è–∑–∫–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏](#3-%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81-%D0%BF%D1%80%D0%B8%D0%B2%D1%8F%D0%B7%D0%BA%D0%B8-%D0%B8-%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B8)
4. [External DLL —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è](#4-external-dll-%D1%81%D0%BF%D0%B5%D1%86%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F)
5. [UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è](#5-ui-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5-%D1%81%D0%BF%D0%B5%D1%86%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F)
6. [Floating Button](#6-floating-button)
7. [–û–∫–Ω–∞ –∏ workflow](#7-%D0%BE%D0%BA%D0%BD%D0%B0-%D0%B8-workflow)
8. [–≠–∫—Ä–∞–Ω–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã](#8-%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5-%D0%BA%D0%BB%D0%B0%D0%B2%D0%B8%D0%B0%D1%82%D1%83%D1%80%D1%8B)
9. [Shared Memory —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è](#9-shared-memory-%D1%81%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F)
10. [R-Keeper XML API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è](#10-r-keeper-xml-api-%D0%B8%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D1%8F)
11. [Backend API endpoints](#11-backend-api-endpoints)
12. [–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π](#12-%D1%84%D0%B8%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D1%82%D1%80%D0%B0%D0%BD%D0%B7%D0%B0%D0%BA%D1%86%D0%B8%D0%B9)
13. [Offline —Ä–µ–∂–∏–º](#13-offline-%D1%80%D0%B5%D0%B6%D0%B8%D0%BC)
14. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#14-%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D1%8C)
15. [–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#15-%D0%BB%D0%BE%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B8-%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3)
16. [–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞](#16-%D0%B4%D0%B8%D0%B0%D0%B3%D0%BD%D0%BE%D1%81%D1%82%D0%B8%D0%BA%D0%B0)
17. [–û–±–Ω–æ–≤–ª–µ–Ω–∏—è](#17-%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F)
18. [–ê–Ω–∞–ª–∏—Ç–∏–∫–∞](#18-%D0%B0%D0%BD%D0%B0%D0%BB%D0%B8%D1%82%D0%B8%D0%BA%D0%B0)

***

## **üéØ 1. –û–ë–©–ï–ï –û–ü–ò–°–ê–ù–ò–ï**

### **1.1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**

–ü–ª–∞–≥–∏–Ω –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ Max Loyalty –≤ R-Keeper —á–µ—Ä–µ–∑ –≥–∏–±—Ä–∏–¥–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (external.dll + Desktop UI). –ü–æ–∑–≤–æ–ª—è–µ—Ç –∫–∞—Å—Å–∏—Ä–∞–º –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –∫–∞—Ä—Ç—ã –≥–æ—Å—Ç–µ–π –∫ –∑–∞–∫–∞–∑–∞–º, –ø—Ä–∏–º–µ–Ω—è—Ç—å –±–æ–Ω—É—Å—ã/—Å–∫–∏–¥–∫–∏ –∏ –Ω–∞—á–∏—Å–ª—è—Ç—å –±–∞–ª–ª—ã.

### **1.2. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è |
| :-- | :-- |
| **External DLL** | C++ (Native) –∏–ª–∏ C\# —á–µ—Ä–µ–∑ C++/CLI |
| **UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** | WPF + .NET Framework 4.7.2+ |
| **R-Keeper –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** | XML API + FarCard –º–æ–¥—É–ª—å |
| **Backend API** | REST API Max Loyalty (NestJS) |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | Serilog (structured logging) |
| **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** | MemoryCache |
| **HTTP –∫–ª–∏–µ–Ω—Ç** | HttpClient + Polly (retry policies) |
| **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** | MemoryMappedFile (shared memory) |
| **–ê–Ω–∏–º–∞—Ü–∏–∏** | WPF Storyboard |
| **DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** | Microsoft.Extensions.DependencyInjection |

### **1.3. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞**

- **–û–°**: Windows 10/11
- **R-Keeper**: 7.x+
- **FarCard**: –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å (–ë–ï–°–ü–õ–ê–¢–ù–û)
- **Hardware**: Touch-screen –ø–æ–¥–¥–µ—Ä–∂–∫–∞


### **1.4. –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç iiko**

| –ê—Å–ø–µ–∫—Ç | iiko | R-Keeper |
| :-- | :-- | :-- |
| **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** | –ü—Ä—è–º–æ–π –ø–ª–∞–≥–∏–Ω (SDK) | –ì–∏–±—Ä–∏–¥–Ω–∞—è (DLL + UI) |
| **UI** | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ iiko Front | –û—Ç–¥–µ–ª—å–Ω–æ–µ WPF –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ |
| **–ö–Ω–æ–ø–∫–∞** | –í –º–µ–Ω—é –î–û–ü–û–õ–ù–ï–ù–ò–Ø | Floating Button (touch) |
| **API** | IFrontPlugin SDK | XML API + FarCard |
| **–õ–∏—Ü–µ–Ω–∑–∏—è** | –ë–µ—Å–ø–ª–∞—Ç–Ω–æ | FarCard –±–µ—Å–ø–ª–∞—Ç–Ω–æ |
| **–£—Å—Ç–∞–Ω–æ–≤–∫–∞** | .dll –≤ Plugins/ | DLL + UI + –∞–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ |


***

## **üèóÔ∏è 2. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –†–ï–®–ï–ù–ò–Ø**

### **2.1. –¢—Ä–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —Å–∏—Å—Ç–µ–º—ã**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1Ô∏è‚É£  MaxLoyaltyRKeeper.dll (External DLL)             ‚îÇ
‚îÇ      ‚Ä¢ C++ Native DLL –¥–ª—è FarCard                       ‚îÇ
‚îÇ      ‚Ä¢ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è R-Keeper                ‚îÇ
‚îÇ      ‚Ä¢ –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã ‚Üí Backend API                ‚îÇ
‚îÇ      ‚Ä¢ –†–∞–∑–º–µ—â–µ–Ω–∏–µ: C:\RK7\Plugins\                      ‚îÇ
‚îÇ      ‚Ä¢ –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ R-Keeper   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2Ô∏è‚É£  MaxLoyaltyRKeeperUI.exe (WPF Desktop)            ‚îÇ
‚îÇ      ‚Ä¢ C# .NET 4.7.2+ WPF –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ                    ‚îÇ
‚îÇ      ‚Ä¢ Floating Button –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö                    ‚îÇ
‚îÇ      ‚Ä¢ Touch-friendly –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å                         ‚îÇ
‚îÇ      ‚Ä¢ –†–∞–∑–º–µ—â–µ–Ω–∏–µ: C:\MaxLoyalty\                       ‚îÇ
‚îÇ      ‚Ä¢ –ó–∞–ø—É—Å–∫: –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ Windows + —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç—Ä–µ–π    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3Ô∏è‚É£  R-Keeper FarCard (–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–æ–¥—É–ª—å)            ‚îÇ
‚îÇ      ‚Ä¢ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å R-Keeper                       ‚îÇ
‚îÇ      ‚Ä¢ –ë–ï–°–ü–õ–ê–¢–ù–û (–≤—Ö–æ–¥–∏—Ç –≤ R-Keeper)                    ‚îÇ
‚îÇ      ‚Ä¢ –ü–æ—Å—Ä–µ–¥–Ω–∏–∫ –º–µ–∂–¥—É –∫–∞—Å—Å–æ–π –∏ external.dll            ‚îÇ
‚îÇ      ‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∞: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —á–µ—Ä–µ–∑ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **2.2. –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è**

```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   R-KEEPER CASH      ‚îÇ
                    ‚îÇ  (–∫–∞—Å—Å–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è)  ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ                                         ‚îÇ
          ‚ñº                                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FarCard –º–æ–¥—É–ª—å  ‚îÇ                    ‚îÇ  XML API R-Keeper   ‚îÇ
‚îÇ  (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)    ‚îÇ                    ‚îÇ  localhost:8080     ‚îÇ
‚îÇ                  ‚îÇ                    ‚îÇ  /rk7api/v0/...     ‚îÇ
‚îÇ  ‚Ä¢ GetCardInfo   ‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  ‚Ä¢ ApplyDiscount ‚îÇ                               ‚îÇ
‚îÇ  ‚Ä¢ Finalize      ‚îÇ                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               ‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚ñº                                          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MaxLoyaltyRKeeper    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ MaxLoyaltyRKeeperUI.exe  ‚îÇ
‚îÇ .dll (external.dll)  ‚îÇ  Shared    ‚îÇ (WPF Desktop UI)         ‚îÇ
‚îÇ                      ‚îÇ  Memory    ‚îÇ                          ‚îÇ
‚îÇ ‚Ä¢ Initialize()       ‚îÇ  (1 MB)    ‚îÇ ‚Ä¢ FloatingButtonWindow   ‚îÇ
‚îÇ ‚Ä¢ GetCardInfo()      ‚îÇ            ‚îÇ ‚Ä¢ GuestSearchWindow      ‚îÇ
‚îÇ ‚Ä¢ ReservePoints()    ‚îÇ            ‚îÇ ‚Ä¢ OperationWindow        ‚îÇ
‚îÇ ‚Ä¢ ReserveDiscount()  ‚îÇ            ‚îÇ ‚Ä¢ NumericKeyboard        ‚îÇ
‚îÇ ‚Ä¢ UpdateReservation()‚îÇ            ‚îÇ ‚Ä¢ AlphabeticKeyboard     ‚îÇ
‚îÇ ‚Ä¢ CancelReservation()‚îÇ            ‚îÇ ‚Ä¢ DiagnosticsWindow      ‚îÇ
‚îÇ ‚Ä¢ FinalizeTransaction‚îÇ            ‚îÇ                          ‚îÇ
‚îÇ ‚Ä¢ Shutdown()         ‚îÇ            ‚îÇ Services:                ‚îÇ
‚îÇ                      ‚îÇ            ‚îÇ ‚Ä¢ LoyaltyApiClient       ‚îÇ
‚îÇ HTTP/HTTPS           ‚îÇ            ‚îÇ ‚Ä¢ RKeeperXmlClient       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ ‚Ä¢ SharedMemoryService    ‚îÇ
           ‚îÇ                        ‚îÇ ‚Ä¢ OfflineQueueService    ‚îÇ
           ‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ         ‚îÇ
           ‚ñº         ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  Backend API         ‚îÇ
    ‚îÇ  Max Loyalty         ‚îÇ
    ‚îÇ  (NestJS + Prisma)   ‚îÇ
    ‚îÇ                      ‚îÇ
    ‚îÇ  Endpoints:          ‚îÇ
    ‚îÇ  ‚Ä¢ /search-guest     ‚îÇ
    ‚îÇ  ‚Ä¢ /calculate        ‚îÇ
    ‚îÇ  ‚Ä¢ /reserve-points   ‚îÇ
    ‚îÇ  ‚Ä¢ /reserve-discount ‚îÇ
    ‚îÇ  ‚Ä¢ /finalize-points  ‚îÇ
    ‚îÇ  ‚Ä¢ /finalize-discount‚îÇ
    ‚îÇ  ‚Ä¢ /update-reservation‚îÇ
    ‚îÇ  ‚Ä¢ /cancel-reservation‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **2.3. Shared Memory —Å—Ç—Ä—É–∫—Ç—É—Ä–∞**

```json
// MemoryMappedFile: "MaxLoyaltyRKeeperShared" (1 MB)

{
  "version": "1.0.0",
  "lastUpdated": "2026-02-18T00:31:00Z",
  
  "backendStatus": {
    "isOnline": true,
    "lastCheckAt": "2026-02-18T00:30:45Z",
    "latencyMs": 45
  },
  
  "activeOrders": {
    "order_12345": {
      "orderId": "order_12345",
      "guestCardId": "card_uuid_abc",
      "guestName": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
      "guestPhone": "+79991234567",
      "benefitType": "POINTS",
      "action": "SPEND",
      "pointsToSpend": 178.00,
      "maxAllowed": 178.00,
      "pointsToEarn": 45.00,
      "reservationId": "res_xyz789",
      "originalCheckAmount": 890.00,
      "appliedAt": "2026-02-18T00:29:30Z",
      "stationId": "STATION_001",
      "terminalId": "term_001"
    }
  },
  
  "offlineQueue": [
    {
      "id": "offline_001",
      "type": "FINALIZE_POINTS",
      "orderId": "order_99999",
      "payload": { ... },
      "queuedAt": "2026-02-18T00:25:00Z",
      "attempts": 0
    }
  ],
  
  "metrics": {
    "totalTransactionsToday": 145,
    "totalPointsSpentToday": 12450.00,
    "totalPointsEarnedToday": 3890.00,
    "averageResponseTimeMs": 120
  }
}
```


***

## **üîó 3. –ü–†–û–¶–ï–°–° –ü–†–ò–í–Ø–ó–ö–ò –ò –£–°–¢–ê–ù–û–í–ö–ò**

### **3.1. –ü—Ä–∏–≤—è–∑–∫–∞ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏**

#### **–®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ R-Keeper –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏**

```
–ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ ‚Üí –†–µ—Å—Ç–æ—Ä–∞–Ω—ã ‚Üí "–ü–∏—Ü—Ü–µ—Ä–∏—è –£ –ú–∞—Ä–∏–æ - –¶–µ–Ω—Ç—Ä"
              ‚Üí POS –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Üí [‚ûï –î–æ–±–∞–≤–∏—Ç—å R-Keeper]

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ù–û–í–ê–Ø R-KEEPER –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Tenant: –°–µ—Ç—å –ü–∏—Ü—Ü–µ—Ä–∏–π –ú–∞—Ä–∏–æ                    ‚îÇ
‚îÇ  –†–µ—Å—Ç–æ—Ä–∞–Ω: –ü–∏—Ü—Ü–µ—Ä–∏—è –£ –ú–∞—Ä–∏–æ - –¶–µ–Ω—Ç—Ä             ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞: *                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ –ö–∞—Å—Å–∞ 1 (–æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª)                   ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  R-Keeper Station ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ STATION_001                              ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  R-Keeper XML API URL:                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ http://localhost:8080/rk7api/v0/xmlinter..‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚ÑπÔ∏è  –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–≥–∏–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏       ‚îÇ
‚îÇ     –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≤–µ—Ä—Å–∏—é R-Keeper –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—Å—è      ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  [–°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é]                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


#### **Backend —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å:**

```typescript
// POST /api/admin/rkeeper/installations

interface CreateRKeeperInstallationDto {
  tenantId: string;
  restaurantId: string;
  terminalName: string;
  stationId?: string;
  xmlApiUrl: string;
}

async createRKeeperInstallation(dto: CreateRKeeperInstallationDto) {
  // 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ API Key
  const apiKey = this.generateApiKey('rk_live_');
  
  // 2. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î
  const installation = await this.prisma.rKeeperPluginInstallation.create({
    data: {
      id: generateUuid(),
      tenantId: dto.tenantId,
      restaurantId: dto.restaurantId,
      terminalName: dto.terminalName,
      stationId: dto.stationId,
      xmlApiUrl: dto.xmlApiUrl,
      apiKey,
      status: 'PENDING_INSTALLATION',
      createdAt: new Date(),
      createdBy: getCurrentUser().id
    }
  });
  
  // 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞
  const installer = await this.installerBuilder.build({
    installationId: installation.id,
    tenantId: dto.tenantId,
    tenantName: getTenantName(dto.tenantId),
    restaurantId: dto.restaurantId,
    restaurantName: getRestaurantName(dto.restaurantId),
    terminalName: dto.terminalName,
    stationId: dto.stationId,
    apiKey,
    xmlApiUrl: dto.xmlApiUrl,
    backendApiUrl: config.backendApiUrl,
    environment: config.environment
  });
  
  // 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ S3/CDN
  const downloadUrl = await this.storage.uploadInstaller(
    installer.buffer,
    `MaxLoyaltyRKeeper_${sanitize(dto.terminalName)}.exe`
  );
  
  // 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —Å URL
  await this.prisma.rKeeperPluginInstallation.update({
    where: { id: installation.id },
    data: { installerDownloadUrl: downloadUrl }
  });
  
  return {
    installation,
    downloadUrl
  };
}
```


#### **–ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞!                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ID: inst_abc123                                ‚îÇ
‚îÇ  –¢–µ—Ä–º–∏–Ω–∞–ª: –ö–∞—Å—Å–∞ 1 (–æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª)              ‚îÇ
‚îÇ  API Key: rk_live_xYz789... [üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å]    ‚îÇ
‚îÇ  –°—Ç–∞—Ç—É—Å: ‚è≥ –û–∂–∏–¥–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏                   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  üì• –°–ö–ê–ß–ê–¢–¨ –£–°–¢–ê–ù–û–í–©–ò–ö:                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ ‚¨áÔ∏è MaxLoyaltyRKeeper_Kassa1.exe (15.2 MB)‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  –í —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –∑–∞—à–∏—Ç—ã:                           ‚îÇ
‚îÇ  ‚úÖ Tenant ID                                   ‚îÇ
‚îÇ  ‚úÖ Restaurant ID                               ‚îÇ
‚îÇ  ‚úÖ Terminal ID                                 ‚îÇ
‚îÇ  ‚úÖ Station ID                                  ‚îÇ
‚îÇ  ‚úÖ API Key (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π)                     ‚îÇ
‚îÇ  ‚úÖ XML API URL                                 ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  üìå –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:                                 ‚îÇ
‚îÇ  1. –°–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª –Ω–∞ –∫–∞—Å—Å–æ–≤—É—é —Å—Ç–∞–Ω—Ü–∏—é          ‚îÇ
‚îÇ  2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞          ‚îÇ
‚îÇ  3. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏             ‚îÇ
‚îÇ  4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ R-Keeper (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **3.2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞**

```
MaxLoyaltyRKeeper_Kassa1.exe
‚îú‚îÄ‚îÄ Manifest (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)
‚îÇ   ‚îú‚îÄ‚îÄ installation_id: "inst_abc123"
‚îÇ   ‚îú‚îÄ‚îÄ tenant_id: "tenant_mario"
‚îÇ   ‚îú‚îÄ‚îÄ tenant_name: "–°–µ—Ç—å –ü–∏—Ü—Ü–µ—Ä–∏–π –ú–∞—Ä–∏–æ"
‚îÇ   ‚îú‚îÄ‚îÄ restaurant_id: "rest_centro"
‚îÇ   ‚îú‚îÄ‚îÄ restaurant_name: "–ü–∏—Ü—Ü–µ—Ä–∏—è –£ –ú–∞—Ä–∏–æ - –¶–µ–Ω—Ç—Ä"
‚îÇ   ‚îú‚îÄ‚îÄ terminal_id: "term_001"
‚îÇ   ‚îú‚îÄ‚îÄ terminal_name: "–ö–∞—Å—Å–∞ 1 (–æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª)"
‚îÇ   ‚îú‚îÄ‚îÄ station_id: "STATION_001"
‚îÇ   ‚îú‚îÄ‚îÄ api_key_encrypted: "AES256_encrypted..."
‚îÇ   ‚îú‚îÄ‚îÄ xml_api_url: "http://localhost:8080/..."
‚îÇ   ‚îú‚îÄ‚îÄ backend_api_url: "https://api.maxloyalty.ru"
‚îÇ   ‚îî‚îÄ‚îÄ environment: "production"
‚îÇ
‚îú‚îÄ‚îÄ Files/
‚îÇ   ‚îú‚îÄ‚îÄ MaxLoyaltyRKeeper.dll (external DLL)
‚îÇ   ‚îú‚îÄ‚îÄ MaxLoyaltyRKeeperUI.exe (WPF UI)
‚îÇ   ‚îú‚îÄ‚îÄ Dependencies/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Newtonsoft.Json.dll
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Serilog.dll
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Serilog.Sinks.File.dll
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Polly.dll
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ System.Memory.dll
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ Resources/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ML_Icon.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ML_Logo.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Sounds/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ click.wav
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ success.wav
‚îÇ   ‚îî‚îÄ‚îÄ README.txt
‚îÇ
‚îî‚îÄ‚îÄ Installer Logic (C# WPF)
    ‚îú‚îÄ‚îÄ DetectRKeeper()
    ‚îú‚îÄ‚îÄ InstallDLL()
    ‚îú‚îÄ‚îÄ InstallUI()
    ‚îú‚îÄ‚îÄ ConfigureFarCard()
    ‚îú‚îÄ‚îÄ AddToAutostart()
    ‚îú‚îÄ‚îÄ TestConnection()
    ‚îî‚îÄ‚îÄ ShowCompletion()
```


### **3.3. –ü—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–¥–µ—Ç–∞–ª—å–Ω–æ)**

#### **–®–∞–≥ 1: –ó–∞–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞**

```csharp
public partial class InstallerWindow : Window
{
    private InstallationManifest manifest;
    private string rKeeperPath;
    
    protected override async void OnLoaded(object sender, RoutedEventArgs e)
    {
        try
        {
            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            if (!IsAdministrator())
            {
                var result = MessageBox.Show(
                    "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.\n" +
                    "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?",
                    "–¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞",
                    MessageBoxButton.YesNo,
                    MessageBoxImage.Warning
                );
                
                if (result == MessageBoxResult.Yes)
                {
                    RestartAsAdmin();
                    Application.Current.Shutdown();
                }
                return;
            }
            
            // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ –∏–∑ —Ä–µ—Å—É—Ä—Å–æ–≤
            manifest = LoadEmbeddedManifest();
            
            // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω
            ShowWelcomeScreen();
            
            // 4. –ñ–¥–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            if (await WaitForUserConfirmation())
            {
                await StartInstallation();
            }
        }
        catch (Exception ex)
        {
            ShowError("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏", ex);
        }
    }
}
```


#### **–®–∞–≥ 2: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ R-Keeper**

```csharp
private async Task<string> DetectRKeeperAsync()
{
    UpdateProgress("–ü–æ–∏—Å–∫ R-Keeper...", 10);
    
    // –ú–µ—Ç–æ–¥ 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—É—Ç–∏
    var standardPaths = new[]
    {
        @"C:\RK7\",
        @"C:\Program Files\UCS\RK7\",
        @"C:\Program Files (x86)\UCS\RK7\",
        @"D:\RK7\"
    };
    
    foreach (var path in standardPaths)
    {
        if (Directory.Exists(path) && File.Exists(Path.Combine(path, "RK7.exe")))
        {
            logger.LogInformation($"R-Keeper found at: {path}");
            return path;
        }
    }
    
    // –ú–µ—Ç–æ–¥ 2: –†–µ–µ—Å—Ç—Ä
    try
    {
        using var key = Registry.LocalMachine.OpenSubKey(@"SOFTWARE\UCS\RK7");
        if (key != null)
        {
            var installPath = key.GetValue("InstallPath") as string;
            if (!string.IsNullOrEmpty(installPath) && Directory.Exists(installPath))
            {
                logger.LogInformation($"R-Keeper found via registry: {installPath}");
                return installPath;
            }
        }
    }
    catch (Exception ex)
    {
        logger.LogWarning(ex, "Failed to check registry");
    }
    
    // –ú–µ—Ç–æ–¥ 3: –ü–æ–∏—Å–∫ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
    var processes = Process.GetProcessesByName("RK7");
    if (processes.Length > 0)
    {
        var mainModule = processes[0].MainModule;
        if (mainModule != null)
        {
            var path = Path.GetDirectoryName(mainModule.FileName);
            logger.LogInformation($"R-Keeper found via process: {path}");
            return path;
        }
    }
    
    // –ú–µ—Ç–æ–¥ 4: –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –¥–∏—Å–∫–∞–º (–¥–æ–ª–≥–æ)
    UpdateProgress("–ì–ª—É–±–æ–∫–∏–π –ø–æ–∏—Å–∫ R-Keeper...", 15);
    
    var drives = DriveInfo.GetDrives()
        .Where(d => d.DriveType == DriveType.Fixed && d.IsReady);
    
    foreach (var drive in drives)
    {
        var searchPaths = new[]
        {
            Path.Combine(drive.Name, "RK7"),
            Path.Combine(drive.Name, "Program Files", "UCS", "RK7"),
            Path.Combine(drive.Name, "Program Files (x86)", "UCS", "RK7")
        };
        
        foreach (var path in searchPaths)
        {
            if (Directory.Exists(path) && File.Exists(Path.Combine(path, "RK7.exe")))
            {
                logger.LogInformation($"R-Keeper found via deep search: {path}");
                return path;
            }
        }
    }
    
    // –ù–µ –Ω–∞–π–¥–µ–Ω - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä—É—á–Ω–æ–π –≤–≤–æ–¥
    return await RequestManualPath();
}

private async Task<string> RequestManualPath()
{
    var dialog = new OpenFileDialog
    {
        Title = "–£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ R-Keeper (RK7.exe)",
        Filter = "R-Keeper|RK7.exe|All files|*.*",
        CheckFileExists = true
    };
    
    if (dialog.ShowDialog() == true)
    {
        return Path.GetDirectoryName(dialog.FileName);
    }
    
    throw new Exception("R-Keeper –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞.");
}
```


#### **–®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ DLL**

```csharp
private async Task InstallDLLAsync()
{
    UpdateProgress("–£—Å—Ç–∞–Ω–æ–≤–∫–∞ external.dll...", 30);
    
    var targetPath = Path.Combine(rKeeperPath, "Plugins", "MaxLoyaltyRKeeper.dll");
    var targetDir = Path.GetDirectoryName(targetPath);
    
    // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é Plugins –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!Directory.Exists(targetDir))
    {
        Directory.CreateDirectory(targetDir);
        logger.LogInformation($"Created Plugins directory: {targetDir}");
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞
    if (File.Exists(targetPath))
    {
        // –°–æ–∑–¥–∞–µ–º backup
        var backupPath = targetPath + ".backup_" + DateTime.Now.ToString("yyyyMMddHHmmss");
        File.Copy(targetPath, backupPath);
        logger.LogInformation($"Created backup: {backupPath}");
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ —Ñ–∞–π–ª
        if (IsFileLocked(targetPath))
        {
            var result = MessageBox.Show(
                "DLL —Ñ–∞–π–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è R-Keeper.\n" +
                "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å R-Keeper –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.\n\n" +
                "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å?",
                "–§–∞–π–ª –∑–∞–Ω—è—Ç",
                MessageBoxButton.YesNo,
                MessageBoxImage.Warning
            );
            
            if (result == MessageBoxResult.Yes)
            {
                await StopRKeeperService();
            }
            else
            {
                throw new Exception("–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞. DLL —Ñ–∞–π–ª –∑–∞–Ω—è—Ç.");
            }
        }
    }
    
    // –ö–æ–ø–∏—Ä—É–µ–º DLL –∏–∑ —Ä–µ—Å—É—Ä—Å–æ–≤
    var dllBytes = ExtractEmbeddedResource("MaxLoyaltyRKeeper.dll");
    await File.WriteAllBytesAsync(targetPath, dllBytes);
    
    logger.LogInformation($"DLL installed to: {targetPath}");
    UpdateProgress("DLL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞", 40);
}
```


#### **–®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**

```csharp
private async Task InstallUIAsync()
{
    UpdateProgress("–£—Å—Ç–∞–Ω–æ–≤–∫–∞ UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...", 50);
    
    var installDir = @"C:\MaxLoyalty";
    
    // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    if (!Directory.Exists(installDir))
    {
        Directory.CreateDirectory(installDir);
    }
    
    // –ö–æ–ø–∏—Ä—É–µ–º UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    var uiPath = Path.Combine(installDir, "MaxLoyaltyRKeeperUI.exe");
    var uiBytes = ExtractEmbeddedResource("MaxLoyaltyRKeeperUI.exe");
    await File.WriteAllBytesAsync(uiPath, uiBytes);
    
    // –ö–æ–ø–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    var dependencies = new[]
    {
        "Newtonsoft.Json.dll",
        "Serilog.dll",
        "Serilog.Sinks.File.dll",
        "Polly.dll",
        "System.Memory.dll",
        "Microsoft.Extensions.DependencyInjection.dll",
        "Microsoft.Extensions.DependencyInjection.Abstractions.dll"
    };
    
    foreach (var dep in dependencies)
    {
        var depPath = Path.Combine(installDir, dep);
        var depBytes = ExtractEmbeddedResource($"Dependencies.{dep}");
        await File.WriteAllBytesAsync(depPath, depBytes);
    }
    
    // –ö–æ–ø–∏—Ä—É–µ–º —Ä–µ—Å—É—Ä—Å—ã
    var resourcesDir = Path.Combine(installDir, "Resources");
    Directory.CreateDirectory(resourcesDir);
    
    var resources = new[] { "ML_Icon.png", "ML_Logo.png" };
    foreach (var res in resources)
    {
        var resPath = Path.Combine(resourcesDir, res);
        var resBytes = ExtractEmbeddedResource($"Resources.{res}");
        await File.WriteAllBytesAsync(resPath, resBytes);
    }
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    await CreateConfigurationAsync(installDir);
    
    logger.LogInformation($"UI installed to: {installDir}");
    UpdateProgress("UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", 60);
}

private async Task CreateConfigurationAsync(string installDir)
{
    var configDir = Path.Combine(
        Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
        "MaxLoyaltyRKeeper"
    );
    
    if (!Directory.Exists(configDir))
    {
        Directory.CreateDirectory(configDir);
    }
    
    // –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ API Key –¥–ª—è —ç—Ç–æ–π –º–∞—à–∏–Ω—ã
    var machineId = GetMachineId();
    var apiKey = DecryptApiKey(manifest.ApiKeyEncrypted, machineId);
    
    var config = new
    {
        installation_id = manifest.InstallationId,
        tenant_id = manifest.TenantId,
        tenant_name = manifest.TenantName,
        restaurant_id = manifest.RestaurantId,
        restaurant_name = manifest.RestaurantName,
        terminal_id = manifest.TerminalId,
        terminal_name = manifest.TerminalName,
        station_id = manifest.StationId,
        api_key = apiKey, // –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π
        backend_api_url = manifest.BackendApiUrl,
        rkeeper_xml_api_url = manifest.XmlApiUrl,
        environment = manifest.Environment,
        
        offline_queue_max_size = 100,
        offline_queue_ttl_hours = 24,
        
        log_path = @"C:\Logs\MaxLoyaltyRKeeper\",
        log_retention_days = 7,
        
        ui_settings = new
        {
            floating_button_enabled = true,
            floating_button_position = "TopRight",
            floating_button_size = "Medium",
            floating_button_opacity = 0.7,
            edge_gesture_enabled = false,
            sounds_enabled = true,
            vibration_enabled = true,
            keyboard_size = "Medium"
        }
    };
    
    var configPath = Path.Combine(configDir, "config.json");
    var json = JsonConvert.SerializeObject(config, Formatting.Indented);
    await File.WriteAllTextAsync(configPath, json);
    
    logger.LogInformation($"Configuration created: {configPath}");
}
```


#### **–®–∞–≥ 5: –ê–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ FarCard**

```csharp
private async Task ConfigureFarCardAsync()
{
    UpdateProgress("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ FarCard...", 70);
    
    var dllPath = Path.Combine(rKeeperPath, "Plugins", "MaxLoyaltyRKeeper.dll");
    
    // –ú–µ—Ç–æ–¥ 1: –ß–µ—Ä–µ–∑ XML API R-Keeper
    try
    {
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""ConfigureFarCard"">
                <Settings>
                  <ExternalDllPath>{XmlEscape(dllPath)}</ExternalDllPath>
                  <Enabled>true</Enabled>
                  <LogLevel>2</LogLevel>
                  <TimeoutSeconds>30</TimeoutSeconds>
                  <RetryCount>3</RetryCount>
                </Settings>
              </RK7CMD>
            </RK7Query>
        ";
        
        using var httpClient = new HttpClient { Timeout = TimeSpan.FromSeconds(5) };
        var response = await httpClient.PostAsync(
            manifest.XmlApiUrl,
            new StringContent(xml, Encoding.UTF8, "text/xml")
        );
        
        if (response.IsSuccessStatusCode)
        {
            logger.LogInformation("FarCard configured via XML API");
            UpdateProgress("FarCard –Ω–∞—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ API", 75);
            return;
        }
    }
    catch (Exception ex)
    {
        logger.LogWarning(ex, "Failed to configure via XML API, trying config file");
    }
    
    // –ú–µ—Ç–æ–¥ 2: –ü—Ä—è–º–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞
    var configPath = Path.Combine(rKeeperPath, "config", "FarCard.xml");
    
    if (File.Exists(configPath))
    {
        try
        {
            var doc = XDocument.Load(configPath);
            
            var externalDllElement = doc.Descendants("ExternalDll").FirstOrDefault();
            if (externalDllElement == null)
            {
                externalDllElement = new XElement("ExternalDll");
                doc.Root?.Add(externalDllElement);
            }
            
            externalDllElement.SetElementValue("Path", dllPath);
            externalDllElement.SetElementValue("Enabled", "true");
            externalDllElement.SetElementValue("LogLevel", "2");
            externalDllElement.SetElementValue("TimeoutSeconds", "30");
            externalDllElement.SetElementValue("RetryCount", "3");
            
            doc.Save(configPath);
            
            logger.LogInformation("FarCard configured via config file");
            UpdateProgress("FarCard –Ω–∞—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥", 75);
            return;
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to edit config file");
        }
    }
    
    // –ú–µ—Ç–æ–¥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
    var newConfigPath = Path.Combine(rKeeperPath, "config", "FarCard_MaxLoyalty.xml");
    var newConfig = new XDocument(
        new XElement("FarCard",
            new XElement("ExternalDll",
                new XElement("Path", dllPath),
                new XElement("Enabled", "true"),
                new XElement("LogLevel", "2"),
                new XElement("TimeoutSeconds", "30"),
                new XElement("RetryCount", "3")
            )
        )
    );
    
    newConfig.Save(newConfigPath);
    
    logger.LogInformation($"Created new FarCard config: {newConfigPath}");
    UpdateProgress("FarCard –∫–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–Ω", 75);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    ShowManualFarCardInstructions(newConfigPath);
}

private void ShowManualFarCardInstructions(string configPath)
{
    var instructions = $@"
‚ö†Ô∏è –í–ê–ñ–ù–û: –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ FarCard

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ FarCard –Ω–µ —É–¥–∞–ª–∞—Å—å.
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Ä—É—á–Ω—É—é –ø–æ–¥–∫–ª—é—á–∏—Ç—å external.dll:

1. –û—Ç–∫—Ä–æ–π—Ç–µ R-Keeper Manager
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí FarCard
3. –í–∫–ª—é—á–∏—Ç–µ External DLL
4. –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å: {configPath}
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
6. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ R-Keeper

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥: {configPath}
    ";
    
    MessageBox.Show(
        instructions,
        "–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞",
        MessageBoxButton.OK,
        MessageBoxImage.Information
    );
}
```


#### **–®–∞–≥ 6: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É**

```csharp
private async Task AddToAutostartAsync()
{
    UpdateProgress("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É...", 80);
    
    var uiPath = @"C:\MaxLoyalty\MaxLoyaltyRKeeperUI.exe";
    var startupArg = "--startup";
    
    try
    {
        using var key = Registry.CurrentUser.OpenSubKey(
            @"Software\Microsoft\Windows\CurrentVersion\Run",
            writable: true
        );
        
        if (key != null)
        {
            key.SetValue(
                "MaxLoyaltyRKeeper",
                $"\"{uiPath}\" {startupArg}",
                RegistryValueKind.String
            );
            
            logger.LogInformation("Added to Windows autostart");
            UpdateProgress("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É", 85);
        }
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Failed to add to autostart");
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        ShowManualAutostartInstructions(uiPath);
    }
}
```


#### **–®–∞–≥ 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**

```csharp
private async Task TestConnectionAsync()
{
    UpdateProgress("–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...", 90);
    
    var configPath = Path.Combine(
        Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
        "MaxLoyaltyRKeeper",
        "config.json"
    );
    
    var config = JsonConvert.DeserializeObject<dynamic>(
        await File.ReadAllTextAsync(configPath)
    );
    
    // –¢–µ—Å—Ç 1: Backend API
    try
    {
        using var httpClient = new HttpClient();
        httpClient.DefaultRequestHeaders.Add("X-API-Key", (string)config.api_key);
        httpClient.DefaultRequestHeaders.Add("X-Installation-Id", (string)config.installation_id);
        
        var response = await httpClient.GetAsync($"{config.backend_api_url}/api/health");
        
        if (response.IsSuccessStatusCode)
        {
            logger.LogInformation("‚úÖ Backend API: OK");
            testResults.Add("Backend API", true);
        }
        else
        {
            logger.LogWarning($"‚ö†Ô∏è Backend API: {response.StatusCode}");
            testResults.Add("Backend API", false);
        }
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "‚ùå Backend API: Failed");
        testResults.Add("Backend API", false);
    }
    
    // –¢–µ—Å—Ç 2: R-Keeper XML API
    try
    {
        using var httpClient = new HttpClient { Timeout = TimeSpan.FromSeconds(3) };
        var testXml = @"<RK7Query><RK7CMD CMD=""GetServerInfo""/></RK7Query>";
        
        var response = await httpClient.PostAsync(
            (string)config.rkeeper_xml_api_url,
            new StringContent(testXml, Encoding.UTF8, "text/xml")
        );
        
        if (response.IsSuccessStatusCode)
        {
            logger.LogInformation("‚úÖ R-Keeper XML API: OK");
            testResults.Add("R-Keeper XML API", true);
        }
        else
        {
            logger.LogWarning($"‚ö†Ô∏è R-Keeper XML API: {response.StatusCode}");
            testResults.Add("R-Keeper XML API", false);
        }
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "‚ùå R-Keeper XML API: Failed");
        testResults.Add("R-Keeper XML API", false);
    }
    
    // –¢–µ—Å—Ç 3: Shared Memory
    try
    {
        using var mmf = MemoryMappedFile.CreateOrOpen(
            "MaxLoyaltyRKeeperShared",
            1024 * 1024 // 1 MB
        );
        
        logger.LogInformation("‚úÖ Shared Memory: OK");
        testResults.Add("Shared Memory", true);
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "‚ùå Shared Memory: Failed");
        testResults.Add("Shared Memory", false);
    }
    
    UpdateProgress("–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ", 95);
}
```


#### **–®–∞–≥ 8: –§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω**

```csharp
private async Task ShowCompletionAsync()
{
    UpdateProgress("–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!", 100);
    
    var allTestsPassed = testResults.Values.All(v => v);
    
    var completionWindow = new CompletionWindow
    {
        InstallationId = manifest.InstallationId,
        TerminalName = manifest.TerminalName,
        TestResults = testResults,
        AllTestsPassed = allTestsPassed,
        RKeeperNeedsRestart = true
    };
    
    completionWindow.ShowDialog();
    
    // –ó–∞–ø—É—Å–∫ UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    if (allTestsPassed)
    {
        StartUIApplication();
    }
    
    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ R-Keeper
    if (completionWindow.RestartRKeeperNow)
    {
        await RestartRKeeperServiceAsync();
    }
}
```

```xaml
<!-- CompletionWindow.xaml -->
<Window x:Class="Installer.CompletionWindow"
        Title="–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        Width="600" Height="700"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize">
    
    <Grid Margin="30">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,30">
            <Image Source="/Resources/ML_Logo.png" 
                   Width="100" Height="100"
                   Margin="0,0,0,20"/>
            <TextBlock Text="üéâ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
                       FontSize="28" FontWeight="Bold"
                       HorizontalAlignment="Center"/>
            <TextBlock Text="{Binding TerminalName}"
                       FontSize="18" Foreground="#666"
                       HorizontalAlignment="Center"
                       Margin="0,5,0,0"/>
        </StackPanel>
        
        <!-- Test Results -->
        <Border Grid.Row="1" 
                BorderBrush="#E5E7EB" BorderThickness="1"
                CornerRadius="8" Padding="20"
                Margin="0,0,0,20">
            <StackPanel>
                <TextBlock Text="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
                           FontSize="16" FontWeight="SemiBold"
                           Margin="0,0,0,15"/>
                
                <ItemsControl ItemsSource="{Binding TestResults}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <TextBlock Text="{Binding Key}"
                                           FontSize="14"/>
                                
                                <TextBlock Grid.Column="1"
                                           Text="{Binding Value, Converter={StaticResource BoolToStatusConverter}}"
                                           FontSize="14" FontWeight="Bold"/>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <Separator Margin="0,15"/>
                
                <TextBlock FontSize="14" TextWrapping="Wrap">
                    <Run Text="‚úÖ UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ" FontWeight="SemiBold"/><LineBreak/>
                    <Run Text="‚úÖ Floating button –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ –∫–∞—Å—Å–µ" FontWeight="SemiBold"/><LineBreak/>
                    <Run Text="‚úÖ –ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å" FontWeight="SemiBold"/>
                </TextBlock>
            </StackPanel>
        </Border>
        
        <!-- Warning -->
        <Border Grid.Row="1" 
                Background="#FEF3C7" 
                BorderBrush="#F59E0B" 
                BorderThickness="2"
                CornerRadius="8" 
                Padding="20"
                Margin="0,10,0,20"
                VerticalAlignment="Bottom">
            <StackPanel>
                <TextBlock FontSize="16" FontWeight="Bold" 
                           Foreground="#92400E"
                           Margin="0,0,0,10">
                    ‚ö†Ô∏è –í–ê–ñ–ù–û:
                </TextBlock>
                <TextBlock FontSize="14" TextWrapping="Wrap"
                           Foreground="#92400E">
                    –î–ª—è –ø–æ–ª–Ω–æ–π —Ä–∞–±–æ—Ç—ã DLL (–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–∞—Ä—Ç–∞–º–∏ —á–µ—Ä–µ–∑ FarCard) 
                    –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å R-Keeper –∫–∞—Å—Å–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä.
                    <LineBreak/><LineBreak/>
                    UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –£–ñ–ï –°–ï–ô–ß–ê–° –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç:
                    <LineBreak/>
                    ‚Ä¢ –ò—Å–∫–∞—Ç—å –≥–æ—Å—Ç–µ–π
                    <LineBreak/>
                    ‚Ä¢ –ü—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –∫–∞—Ä—Ç—ã –∫ –∑–∞–∫–∞–∑–∞–º
                    <LineBreak/>
                    ‚Ä¢ –°–ø–∏—Å—ã–≤–∞—Ç—å –±–∞–ª–ª—ã / –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å–∫–∏–¥–∫–∏
                    <LineBreak/><LineBreak/>
                    DLL –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.
                </TextBlock>
            </StackPanel>
        </Border>
        
        <!-- Actions -->
        <StackPanel Grid.Row="2" Orientation="Vertical">
            <Button Content="üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å R-Keeper —Å–µ–π—á–∞—Å"
                    Height="50" FontSize="16"
                    Background="#6366F1" Foreground="White"
                    Click="RestartNow_Click"
                    Margin="0,0,0,10"/>
            
            <Button Content="‚è≠Ô∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∑–∂–µ –≤—Ä—É—á–Ω—É—é"
                    Height="50" FontSize="16"
                    Background="White" BorderBrush="#6366F1"
                    Foreground="#6366F1" BorderThickness="2"
                    Click="RestartLater_Click"
                    Margin="0,0,0,10"/>
            
            <TextBlock FontSize="12" Foreground="#666"
                       TextAlignment="Center" TextWrapping="Wrap"
                       Margin="0,10,0,0">
                üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è
                <LineBreak/>
                (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –∏–ª–∏ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è)
            </TextBlock>
        </StackPanel>
    </Grid>
</Window>
```


***

### **3.4. –ü–µ—Ä–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ backend**

```csharp
// UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ

public class StartupService
{
    private readonly LoyaltyApiClient apiClient;
    private readonly ConfigService configService;
    
    public async Task InitializeAsync()
    {
        var config = configService.LoadConfig();
        
        try
        {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–≤–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
            var response = await apiClient.PostAsync(
                "/api/pos-integration/rkeeper/first-connect",
                new
                {
                    installation_id = config.InstallationId,
                    terminal_name = config.TerminalName,
                    station_id = config.StationId,
                    machine_id = GetMachineId(),
                    os_version = Environment.OSVersion.ToString(),
                    plugin_version = GetPluginVersion(),
                    rkeeper_version = await DetectRKeeperVersion()
                }
            );
            
            if (response.Success)
            {
                // Backend –æ–±–Ω–æ–≤–∏–ª —Å—Ç–∞—Ç—É—Å: PENDING_INSTALLATION ‚Üí ACTIVE
                logger.LogInformation("‚úÖ First connection successful");
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
                var restaurantConfig = await apiClient.GetAsync<RestaurantConfig>(
                    "/api/pos-integration/rkeeper/config"
                );
                
                configService.SaveRestaurantConfig(restaurantConfig);
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to initialize");
            throw;
        }
    }
}
```

```typescript
// Backend: POST /api/pos-integration/rkeeper/first-connect

async handleFirstConnect(req: FirstConnectRequest) {
  const { installation_id, terminal_name, station_id, machine_id, plugin_version } = req;
  
  // 1. –ù–∞—Ö–æ–¥–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –ø–æ ID
  const installation = await this.prisma.rKeeperPluginInstallation.findUnique({
    where: { id: installation_id }
  });
  
  if (!installation) {
    throw new NotFoundException('Installation not found');
  }
  
  // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
  await this.prisma.rKeeperPluginInstallation.update({
    where: { id: installation_id },
    data: {
      status: 'ACTIVE',
      machineId: machine_id,
      pluginVersion: plugin_version,
      firstConnectedAt: new Date(),
      lastSeenAt: new Date()
    }
  });
  
  // 3. –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
  await this.auditLog.create({
    type: 'RKEEPER_PLUGIN_ACTIVATED',
    tenantId: installation.tenantId,
    restaurantId: installation.restaurantId,
    metadata: { installation_id, terminal_name, station_id }
  });
  
  // 4. –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
  await this.notifications.send({
    to: installation.tenant.adminEmail,
    subject: `R-Keeper –ø–ª–∞–≥–∏–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: ${terminal_name}`,
    template: 'rkeeper-activated',
    data: { installation, terminal_name }
  });
  
  return { success: true };
}
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ (4-18)?

---

# üìò **–ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø - –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï**


***

## **üíª 4. EXTERNAL DLL –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø**

### **4.1. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**

```cpp
// –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è: C++ Native DLL (–∏–ª–∏ C# —á–µ—Ä–µ–∑ C++/CLI)
// –§–æ—Ä–º–∞—Ç: Win32 DLL
// –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: x86 –∏–ª–∏ x64 (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç R-Keeper)
// Entry Point: DllMain
// Calling Convention: __stdcall
// –≠–∫—Å–ø–æ—Ä—Ç: __declspec(dllexport)
```


### **4.2. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–¥–µ—Ç–∞–ª—å–Ω–æ)**

#### **4.2.1. Initialize()**

```cpp
extern "C" __declspec(dllexport) int __stdcall Initialize(const char* configPath)
```

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DLL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ FarCard –º–æ–¥—É–ª–µ–º.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:

- `configPath` - –ü—É—Ç—å –∫ config.json (–æ–±—ã—á–Ω–æ `%AppData%\MaxLoyaltyRKeeper\config.json`)

**–í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ**:

- `0` - Success
- `-1` - Error (–Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥)
- `-2` - Error (–Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å API Key)
- `-3` - Error (backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:

```cpp
#include <Windows.h>
#include <string>
#include <fstream>
#include <memory>
#include "json.hpp"
#include "HttpClient.h"
#include "Logger.h"
#include "SharedMemory.h"

using json = nlohmann::json;

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
std::unique_ptr<HttpClient> g_httpClient;
std::unique_ptr<Logger> g_logger;
std::unique_ptr<SharedMemoryManager> g_sharedMemory;
std::string g_apiKey;
std::string g_backendUrl;
std::string g_installationId;
std::string g_tenantId;
std::string g_restaurantId;
std::string g_terminalId;

extern "C" __declspec(dllexport) int __stdcall Initialize(const char* configPath)
{
    try
    {
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        std::string logPath = "C:\\Logs\\MaxLoyaltyRKeeper\\dll-";
        logPath += GetCurrentDate() + ".log";
        
        g_logger = std::make_unique<Logger>(logPath);
        g_logger->Info("MaxLoyaltyRKeeper.dll Initialize() called");
        g_logger->Info("Config path: " + std::string(configPath));
        
        // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        std::ifstream configFile(configPath);
        if (!configFile.is_open())
        {
            g_logger->Error("Failed to open config file: " + std::string(configPath));
            return -1;
        }
        
        json config;
        configFile >> config;
        configFile.close();
        
        // 3. –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ API Key
        std::string machineId = GetMachineId();
        g_apiKey = DecryptApiKey(config["api_key"].get<std::string>(), machineId);
        
        if (g_apiKey.empty())
        {
            g_logger->Error("Failed to decrypt API Key");
            return -2;
        }
        
        // 4. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        g_backendUrl = config["backend_api_url"].get<std::string>();
        g_installationId = config["installation_id"].get<std::string>();
        g_tenantId = config["tenant_id"].get<std::string>();
        g_restaurantId = config["restaurant_id"].get<std::string>();
        g_terminalId = config["terminal_id"].get<std::string>();
        
        g_logger->Info("Backend URL: " + g_backendUrl);
        g_logger->Info("Installation ID: " + g_installationId);
        g_logger->Info("Terminal ID: " + g_terminalId);
        
        // 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HTTP –∫–ª–∏–µ–Ω—Ç–∞
        g_httpClient = std::make_unique<HttpClient>(g_backendUrl);
        g_httpClient->SetHeader("X-API-Key", g_apiKey);
        g_httpClient->SetHeader("X-Installation-Id", g_installationId);
        g_httpClient->SetHeader("X-Tenant-Id", g_tenantId);
        g_httpClient->SetHeader("X-Restaurant-Id", g_restaurantId);
        g_httpClient->SetHeader("X-Terminal-Id", g_terminalId);
        g_httpClient->SetTimeout(30000); // 30 —Å–µ–∫—É–Ω–¥
        
        // 6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Shared Memory
        g_sharedMemory = std::make_unique<SharedMemoryManager>(
            "MaxLoyaltyRKeeperShared",
            1024 * 1024 // 1 MB
        );
        
        if (!g_sharedMemory->Open())
        {
            g_logger->Warning("Failed to open shared memory, creating new");
            g_sharedMemory->Create();
        }
        
        // 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ backend
        try
        {
            auto response = g_httpClient->Get("/api/health");
            if (response.statusCode == 200)
            {
                g_logger->Info("Backend connection: OK");
                g_sharedMemory->UpdateBackendStatus(true);
            }
            else
            {
                g_logger->Warning("Backend connection: Failed (status " + 
                    std::to_string(response.statusCode) + ")");
                g_sharedMemory->UpdateBackendStatus(false);
            }
        }
        catch (const std::exception& ex)
        {
            g_logger->Warning("Backend connection test failed: " + std::string(ex.what()));
            g_sharedMemory->UpdateBackendStatus(false);
        }
        
        // 8. –£—Å–ø–µ—à–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        g_logger->Info("MaxLoyaltyRKeeper.dll initialized successfully");
        return 0;
    }
    catch (const std::exception& ex)
    {
        if (g_logger)
            g_logger->Error("Initialize() exception: " + std::string(ex.what()));
        return -1;
    }
}
```


#### **4.2.2. GetCardInfo()**

```cpp
extern "C" __declspec(dllexport) int __stdcall GetCardInfo(
    const char* cardNumber, 
    CardInfo* outInfo
)
```

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞—Ä—Ç–µ –≥–æ—Å—Ç—è –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ 6-digit –∫–æ–¥—É.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:

- `cardNumber` - –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (`+79991234567`) –∏–ª–∏ 6-digit –∫–æ–¥ (`123456`)
- `outInfo` - –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ**:

- `0` - –ö–∞—Ä—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞
- `-1` - –ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
- `-2` - –û—à–∏–±–∫–∞ API
- `-3` - Backend offline

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:

```cpp
extern "C" __declspec(dllexport) int __stdcall GetCardInfo(
    const char* cardNumber, 
    CardInfo* outInfo
)
{
    if (!cardNumber || !outInfo)
    {
        g_logger->Error("GetCardInfo: Invalid parameters");
        return -1;
    }
    
    g_logger->Info("GetCardInfo called: " + std::string(cardNumber));
    
    try
    {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–∏—Å–∫–∞ (—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –∫–æ–¥)
        std::string searchValue(cardNumber);
        bool isPhone = (searchValue.length() >= 10 && searchValue[0] == '+');
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º JSON –∑–∞–ø—Ä–æ—Å
        json requestBody;
        if (isPhone)
            requestBody["phone"] = searchValue;
        else
            requestBody["code6Digit"] = searchValue;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend
        auto response = g_httpClient->Post(
            "/api/pos-integration/rkeeper/search-guest",
            requestBody.dump()
        );
        
        if (response.statusCode != 200)
        {
            g_logger->Error("GetCardInfo: Backend returned " + 
                std::to_string(response.statusCode));
            return -2;
        }
        
        // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
        auto responseData = json::parse(response.body);
        
        if (!responseData["found"].get<bool>())
        {
            g_logger->Info("GetCardInfo: Guest not found");
            return -1;
        }
        
        auto guest = responseData["guest"];
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É CardInfo
        ZeroMemory(outInfo, sizeof(CardInfo));
        
        strncpy_s(outInfo->guestName, 
            guest["name"].get<std::string>().c_str(), 
            255);
        
        strncpy_s(outInfo->phone, 
            guest["phone"].get<std::string>().c_str(), 
            31);
        
        strncpy_s(outInfo->cardId, 
            guest["cardId"].get<std::string>().c_str(), 
            63);
        
        strncpy_s(outInfo->levelName, 
            guest["levelName"].get<std::string>().c_str(), 
            127);
        
        outInfo->levelId = guest["levelId"].get<int>();
        outInfo->regularBalance = guest["regularBalance"].get<double>();
        outInfo->promoBalance = guest["promoBalance"].get<double>();
        outInfo->totalBalance = guest["totalBalance"].get<double>();
        
        if (guest.contains("code6Digit"))
        {
            strncpy_s(outInfo->code6Digit, 
                guest["code6Digit"].get<std::string>().c_str(), 
                7);
        }
        
        g_logger->Info("GetCardInfo: Success - " + guest["name"].get<std::string>());
        
        return 0;
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("GetCardInfo exception: " + std::string(ex.what()));
        return -2;
    }
}
```


#### **4.2.3. ReservePoints()**

```cpp
extern "C" __declspec(dllexport) int __stdcall ReservePoints(
    const char* cardId,
    double pointsToSpend,
    const char* orderId,
    char* outReservationId
)
```

**–û–ø–∏—Å–∞–Ω–∏–µ**: –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –±–∞–ª–ª–æ–≤ –Ω–∞ backend –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –∫ –∑–∞–∫–∞–∑—É.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:

- `cardId` - UUID –∫–∞—Ä—Ç—ã –≥–æ—Å—Ç—è
- `pointsToSpend` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è (–≤ —Ä—É–±–ª—è—Ö)
- `orderId` - ID –∑–∞–∫–∞–∑–∞ –≤ R-Keeper
- `outReservationId` - –ë—É—Ñ–µ—Ä –¥–ª—è –∑–∞–ø–∏—Å–∏ ID —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ (–º–∏–Ω–∏–º—É–º 64 –±–∞–π—Ç–∞)

**–í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ**:

- `0` - Success
- `-1` - –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤
- `-2` - –û—à–∏–±–∫–∞ API
- `-3` - Backend offline

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:

```cpp
extern "C" __declspec(dllexport) int __stdcall ReservePoints(
    const char* cardId,
    double pointsToSpend,
    const char* orderId,
    char* outReservationId
)
{
    if (!cardId || !orderId || !outReservationId || pointsToSpend <= 0)
    {
        g_logger->Error("ReservePoints: Invalid parameters");
        return -2;
    }
    
    g_logger->Info("ReservePoints: CardId=" + std::string(cardId) + 
        ", Points=" + std::to_string(pointsToSpend) + 
        ", OrderId=" + std::string(orderId));
    
    try
    {
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
        json requestBody = {
            {"guestCardId", cardId},
            {"pointsToSpend", pointsToSpend},
            {"orderId", orderId},
            {"restaurantId", g_restaurantId},
            {"terminalId", g_terminalId}
        };
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend
        auto response = g_httpClient->Post(
            "/api/pos-integration/rkeeper/reserve-points",
            requestBody.dump()
        );
        
        if (response.statusCode != 200)
        {
            g_logger->Error("ReservePoints: Backend returned " + 
                std::to_string(response.statusCode));
            return -2;
        }
        
        auto responseData = json::parse(response.body);
        
        if (!responseData["success"].get<bool>())
        {
            std::string error = responseData.value("error", "Unknown error");
            g_logger->Error("ReservePoints: " + error);
            
            if (error.find("Insufficient") != std::string::npos)
                return -1; // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤
            
            return -2;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º ID —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
        std::string reservationId = responseData["reservationId"].get<std::string>();
        strncpy_s(outReservationId, 64, reservationId.c_str(), 63);
        
        g_logger->Info("ReservePoints: Success - ReservationId=" + reservationId);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ shared memory
        g_sharedMemory->SaveOrderContext({
            std::string(orderId),
            std::string(cardId),
            reservationId,
            pointsToSpend,
            "POINTS",
            "SPEND"
        });
        
        return 0;
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("ReservePoints exception: " + std::string(ex.what()));
        return -2;
    }
}
```


#### **4.2.4. ReserveDiscount()**

```cpp
extern "C" __declspec(dllexport) int __stdcall ReserveDiscount(
    const char* cardId,
    double discountAmount,
    const char* orderId,
    char* outReservationId
)
```

**–û–ø–∏—Å–∞–Ω–∏–µ**: –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è —Å–∫–∏–¥–∫–∏ –Ω–∞ backend.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:

- `cardId` - UUID –∫–∞—Ä—Ç—ã –≥–æ—Å—Ç—è
- `discountAmount` - –°—É–º–º–∞ —Å–∫–∏–¥–∫–∏ (–≤ —Ä—É–±–ª—è—Ö)
- `orderId` - ID –∑–∞–∫–∞–∑–∞
- `outReservationId` - –ë—É—Ñ–µ—Ä –¥–ª—è ID —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**: –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞ `ReservePoints`, –Ω–æ endpoint `/reserve-discount`.

#### **4.2.5. FinalizeTransaction()**

```cpp
extern "C" __declspec(dllexport) int __stdcall FinalizeTransaction(
    const char* reservationId,
    double finalAmount,
    const char* orderId,
    const char* paymentTypesJson
)
```

**–û–ø–∏—Å–∞–Ω–∏–µ**: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ–∫–∞. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ FarCard.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:

- `reservationId` - ID —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –∏–∑ Shared Memory
- `finalAmount` - –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞
- `orderId` - ID –∑–∞–∫–∞–∑–∞
- `paymentTypesJson` - JSON –º–∞—Å—Å–∏–≤ —Ç–∏–ø–æ–≤ –æ–ø–ª–∞—Ç—ã `["CASH", "CARD"]`

**–í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ**:

- `0` - Success
- `-1` - Error
- `-2` - Queued offline

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:

```cpp
extern "C" __declspec(dllexport) int __stdcall FinalizeTransaction(
    const char* reservationId,
    double finalAmount,
    const char* orderId,
    const char* paymentTypesJson
)
{
    if (!reservationId || !orderId)
    {
        g_logger->Error("FinalizeTransaction: Invalid parameters");
        return -1;
    }
    
    g_logger->Info("FinalizeTransaction: OrderId=" + std::string(orderId) + 
        ", Amount=" + std::to_string(finalAmount));
    
    try
    {
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ shared memory
        auto context = g_sharedMemory->GetOrderContext(orderId);
        
        if (!context.has_value())
        {
            g_logger->Warning("FinalizeTransaction: No context for order " + 
                std::string(orderId));
            return 0; // –ù–µ –æ—à–∏–±–∫–∞, –ø—Ä–æ—Å—Ç–æ –Ω–µ—Ç –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ —ç—Ç–æ–º –∑–∞–∫–∞–∑–µ
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
        json requestBody = {
            {"guestCardId", context->cardId},
            {"orderId", orderId},
            {"reservationId", reservationId},
            {"finalCheckAmount", finalAmount},
            {"originalCheckAmount", context->originalAmount},
            {"restaurantId", g_restaurantId},
            {"terminalId", g_terminalId},
            {"paymentTypes", json::parse(paymentTypesJson)}
        };
        
        std::string endpoint;
        
        if (context->benefitType == "POINTS")
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-points";
            requestBody["pointsSpent"] = context->amount;
            requestBody["pointsToEarn"] = context->earnAmount;
            requestBody["action"] = context->action;
        }
        else if (context->benefitType == "DISCOUNT")
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-discount";
            requestBody["discountAmount"] = context->amount;
            requestBody["discountPercentage"] = context->discountPercentage;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend
        auto response = g_httpClient->Post(endpoint, requestBody.dump());
        
        if (response.statusCode == 200)
        {
            auto responseData = json::parse(response.body);
            
            if (responseData["success"].get<bool>())
            {
                std::string txnId = responseData["transactionId"].get<std::string>();
                g_logger->Info("FinalizeTransaction: Success - TxnId=" + txnId);
                
                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ shared memory
                g_sharedMemory->ClearOrderContext(orderId);
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º UI –æ–± —É—Å–ø–µ—à–Ω–æ–π —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
                g_sharedMemory->NotifyUI("order_finalized", orderId);
                
                return 0;
            }
        }
        
        // –ï—Å–ª–∏ backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –¥–æ–±–∞–≤–ª—è–µ–º –≤ offline queue
        g_logger->Warning("FinalizeTransaction: Backend unavailable, queueing...");
        
        g_sharedMemory->EnqueueOfflineOperation({
            "FINALIZE_" + context->benefitType,
            orderId,
            requestBody.dump(),
            GetCurrentTimestamp()
        });
        
        return -2; // Queued offline
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("FinalizeTransaction exception: " + std::string(ex.what()));
        return -1;
    }
}
```


#### **4.2.6. UpdateReservation()**

```cpp
extern "C" __declspec(dllexport) int __stdcall UpdateReservation(
    const char* reservationId,
    double newAmount
)
```

**–û–ø–∏—Å–∞–Ω–∏–µ**: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –µ—Å–ª–∏ —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å.

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**: –ö–æ–≥–¥–∞ –∫–∞—Å—Å–∏—Ä –¥–æ–±–∞–≤–∏–ª/—É–¥–∞–ª–∏–ª —Ç–æ–≤–∞—Ä—ã –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏.

#### **4.2.7. CancelReservation()**

```cpp
extern "C" __declspec(dllexport) int __stdcall CancelReservation(
    const char* reservationId,
    const char* reason
)
```

**–û–ø–∏—Å–∞–Ω–∏–µ**: –û—Ç–º–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏.

**–ü—Ä–∏—á–∏–Ω—ã**:

- `USER_UNBIND` - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤—è–∑–∞–ª –∫–∞—Ä—Ç—É
- `ORDER_CANCELLED` - –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω


#### **4.2.8. Shutdown()**

```cpp
extern "C" __declspec(dllexport) void __stdcall Shutdown()
```

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã DLL.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:

```cpp
extern "C" __declspec(dllexport) void __stdcall Shutdown()
{
    g_logger->Info("MaxLoyaltyRKeeper.dll Shutdown() called");
    
    try
    {
        // –û—á–∏—â–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã
        g_httpClient.reset();
        g_sharedMemory.reset();
        
        g_logger->Info("Shutdown completed successfully");
        g_logger.reset();
    }
    catch (...)
    {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ shutdown
    }
}
```


### **4.3. –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö**

```cpp
// CardInfo.h
struct CardInfo
{
    char guestName[256];
    char phone[32];
    char cardId[64];          // UUID
    char levelName[128];
    int levelId;
    double regularBalance;
    double promoBalance;
    double totalBalance;
    char code6Digit[8];
};

// BenefitInfo.h
struct BenefitInfo
{
    int benefitType;          // 0=POINTS, 1=DISCOUNT
    double maxAllowedToSpend;
    double pointsToEarn;
    double discountPercentage;
    double discountAmount;
    double checkAmount;
    double minCheckAmount;
};

// OrderContext.h (–≤ shared memory)
struct OrderContext
{
    char orderId[64];
    char guestCardId[64];
    char guestName[256];
    char guestPhone[32];
    int benefitType;          // 0=POINTS, 1=DISCOUNT
    int action;               // 0=SPEND, 1=EARN_ONLY, 2=APPLY_DISCOUNT
    double amount;            // pointsToSpend –∏–ª–∏ discountAmount
    double maxAllowed;
    double earnAmount;        // pointsToEarn
    double discountPercentage;
    char reservationId[64];
    double originalAmount;    // checkAmount
    long long appliedAt;      // Unix timestamp
    char stationId[64];
    char terminalId[64];
};

// OfflineOperation.h
struct OfflineOperation
{
    char id[64];
    char type[32];            // FINALIZE_POINTS, FINALIZE_DISCOUNT
    char orderId[64];
    char payload[4096];       // JSON string
    long long queuedAt;       // Unix timestamp
    int attempts;
};
```


### **4.4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ DLL**

```cpp
class ErrorHandler
{
public:
    static int HandleException(const std::exception& ex, const std::string& context)
    {
        g_logger->Error(context + " exception: " + ex.what());
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏
        if (dynamic_cast<const HttpTimeoutException*>(&ex))
        {
            return ErrorCode::TIMEOUT;
        }
        else if (dynamic_cast<const NetworkException*>(&ex))
        {
            return ErrorCode::NETWORK_ERROR;
        }
        else if (dynamic_cast<const JsonParseException*>(&ex))
        {
            return ErrorCode::INVALID_RESPONSE;
        }
        
        return ErrorCode::UNKNOWN_ERROR;
    }
};

// Retry policy
class RetryPolicy
{
public:
    template<typename Func>
    static auto Execute(Func func, int maxAttempts = 3) -> decltype(func())
    {
        int attempt = 0;
        std::exception_ptr lastException;
        
        while (attempt < maxAttempts)
        {
            try
            {
                return func();
            }
            catch (const std::exception& ex)
            {
                lastException = std::current_exception();
                attempt++;
                
                if (attempt < maxAttempts)
                {
                    int delayMs = 1000 * std::pow(2, attempt - 1); // Exponential backoff
                    g_logger->Warning("Retry attempt " + std::to_string(attempt) + 
                        " after " + std::to_string(delayMs) + "ms");
                    Sleep(delayMs);
                }
            }
        }
        
        if (lastException)
            std::rethrow_exception(lastException);
        
        throw std::runtime_error("Unexpected retry failure");
    }
};
```


***

## **üé® 5. UI –ü–†–ò–õ–û–ñ–ï–ù–ò–ï –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø**

### **5.1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ WPF**

```
MaxLoyaltyRKeeperUI/
‚îú‚îÄ‚îÄ App.xaml                             # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ App.xaml.cs
‚îÇ
‚îú‚îÄ‚îÄ Views/                               # –û–∫–Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ FloatingButtonWindow.xaml        # –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ GuestSearchWindow.xaml           # –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è
‚îÇ   ‚îú‚îÄ‚îÄ PointsOperationWindow.xaml       # –û–ø–µ—Ä–∞—Ü–∏—è —Å –±–∞–ª–ª–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ DiscountOperationWindow.xaml     # –û–ø–µ—Ä–∞—Ü–∏—è —Å–æ —Å–∫–∏–¥–∫–æ–π
‚îÇ   ‚îú‚îÄ‚îÄ CreateGuestWindow.xaml           # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è
‚îÇ   ‚îú‚îÄ‚îÄ DiagnosticsWindow.xaml           # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ SettingsWindow.xaml              # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ AboutWindow.xaml                 # –û –ø—Ä–æ–≥—Ä–∞–º–º–µ
‚îÇ
‚îú‚îÄ‚îÄ ViewModels/                          # View Models (MVVM)
‚îÇ   ‚îú‚îÄ‚îÄ ViewModelBase.cs
‚îÇ   ‚îú‚îÄ‚îÄ FloatingButtonViewModel.cs
‚îÇ   ‚îú‚îÄ‚îÄ GuestSearchViewModel.cs
‚îÇ   ‚îú‚îÄ‚îÄ PointsOperationViewModel.cs
‚îÇ   ‚îú‚îÄ‚îÄ DiscountOperationViewModel.cs
‚îÇ   ‚îú‚îÄ‚îÄ CreateGuestViewModel.cs
‚îÇ   ‚îú‚îÄ‚îÄ DiagnosticsViewModel.cs
‚îÇ   ‚îî‚îÄ‚îÄ SettingsViewModel.cs
‚îÇ
‚îú‚îÄ‚îÄ UserControls/                        # –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã
‚îÇ   ‚îú‚îÄ‚îÄ NumericKeyboard.xaml             # –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ AlphabeticKeyboard.xaml          # –ë—É–∫–≤–µ–Ω–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ LoadingOverlay.xaml              # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ ErrorDialog.xaml                 # –î–∏–∞–ª–æ–≥ –æ—à–∏–±–æ–∫
‚îÇ   ‚îú‚îÄ‚îÄ SuccessNotification.xaml         # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—Ö–∞
‚îÇ   ‚îî‚îÄ‚îÄ ConfirmDialog.xaml               # –î–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
‚îÇ
‚îú‚îÄ‚îÄ Services/                            # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ ILoyaltyApiClient.cs
‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyApiClient.cs              # HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è Backend API
‚îÇ   ‚îú‚îÄ‚îÄ IRKeeperXmlClient.cs
‚îÇ   ‚îú‚îÄ‚îÄ RKeeperXmlClient.cs              # –ö–ª–∏–µ–Ω—Ç –¥–ª—è R-Keeper XML API
‚îÇ   ‚îú‚îÄ‚îÄ ISharedMemoryService.cs
‚îÇ   ‚îú‚îÄ‚îÄ SharedMemoryService.cs           # –†–∞–±–æ—Ç–∞ —Å shared memory
‚îÇ   ‚îú‚îÄ‚îÄ IOfflineQueueService.cs
‚îÇ   ‚îú‚îÄ‚îÄ OfflineQueueService.cs           # Offline –æ—á–µ—Ä–µ–¥—å
‚îÇ   ‚îú‚îÄ‚îÄ IConfigService.cs
‚îÇ   ‚îú‚îÄ‚îÄ ConfigService.cs                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ ICacheService.cs
‚îÇ   ‚îú‚îÄ‚îÄ CacheService.cs                  # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ IHealthCheckService.cs
‚îÇ   ‚îú‚îÄ‚îÄ HealthCheckService.cs            # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è
‚îÇ   ‚îú‚îÄ‚îÄ IMetricsService.cs
‚îÇ   ‚îú‚îÄ‚îÄ MetricsService.cs                # –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫
‚îÇ   ‚îú‚îÄ‚îÄ INotificationService.cs
‚îÇ   ‚îú‚îÄ‚îÄ NotificationService.cs           # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ INavigationService.cs
‚îÇ   ‚îî‚îÄ‚îÄ NavigationService.cs             # –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏
‚îÇ
‚îú‚îÄ‚îÄ Models/                              # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ GuestInfo.cs
‚îÇ   ‚îú‚îÄ‚îÄ GuestCard.cs
‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyLevel.cs
‚îÇ   ‚îú‚îÄ‚îÄ CalculateRequest.cs
‚îÇ   ‚îú‚îÄ‚îÄ CalculateResponse.cs
‚îÇ   ‚îú‚îÄ‚îÄ ReserveRequest.cs
‚îÇ   ‚îú‚îÄ‚îÄ ReserveResponse.cs
‚îÇ   ‚îú‚îÄ‚îÄ OrderContext.cs
‚îÇ   ‚îú‚îÄ‚îÄ RKeeperOrder.cs
‚îÇ   ‚îú‚îÄ‚îÄ RestaurantConfig.cs
‚îÇ   ‚îú‚îÄ‚îÄ OfflineOperation.cs
‚îÇ   ‚îî‚îÄ‚îÄ HealthStatus.cs
‚îÇ
‚îú‚îÄ‚îÄ Utils/                               # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ Encryption.cs                    # –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ/—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ ErrorHandler.cs                  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚îÇ   ‚îú‚îÄ‚îÄ RetryPolicy.cs                   # Retry —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ Validator.cs                     # –í–∞–ª–∏–¥–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ PhoneFormatter.cs                # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ DateTimeHelper.cs                # –†–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–∞–º–∏
‚îÇ
‚îú‚îÄ‚îÄ Converters/                          # Value Converters –¥–ª—è XAML
‚îÇ   ‚îú‚îÄ‚îÄ BoolToVisibilityConverter.cs
‚îÇ   ‚îú‚îÄ‚îÄ InverseBoolConverter.cs
‚îÇ   ‚îú‚îÄ‚îÄ StatusToColorConverter.cs
‚îÇ   ‚îú‚îÄ‚îÄ AmountToStringConverter.cs
‚îÇ   ‚îî‚îÄ‚îÄ BenefitTypeToStringConverter.cs
‚îÇ
‚îú‚îÄ‚îÄ Styles/                              # –°—Ç–∏–ª–∏ –∏ —Ç–µ–º—ã
‚îÇ   ‚îú‚îÄ‚îÄ MaxLoyaltyStyles.xaml            # –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ Colors.xaml                      # –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ Fonts.xaml                       # –®—Ä–∏—Ñ—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ Animations.xaml                  # –ê–Ω–∏–º–∞—Ü–∏–∏
‚îÇ
‚îî‚îÄ‚îÄ Resources/                           # –†–µ—Å—É—Ä—Å—ã
    ‚îú‚îÄ‚îÄ Images/
    ‚îÇ   ‚îú‚îÄ‚îÄ ML_Icon.png
    ‚îÇ   ‚îú‚îÄ‚îÄ ML_Logo.png
    ‚îÇ   ‚îî‚îÄ‚îÄ Icons/
    ‚îî‚îÄ‚îÄ Sounds/
        ‚îú‚îÄ‚îÄ click.wav
        ‚îî‚îÄ‚îÄ success.wav
```


### **5.2. App.xaml.cs - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞**

```csharp
public partial class App : Application
{
    private IServiceProvider serviceProvider;
    private ILogger<App> logger;
    private FloatingButtonWindow floatingButton;
    private NotifyIcon trayIcon;
    
    protected override async void OnStartup(StartupEventArgs e)
    {
        base.OnStartup(e);
        
        try
        {
            // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
            ConfigureLogging();
            
            // 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            serviceProvider = ConfigureServices();
            
            logger = serviceProvider.GetRequiredService<ILogger<App>>();
            logger.LogInformation("Max Loyalty RKeeper UI starting...");
            
            // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞
            if (!EnsureSingleInstance())
            {
                logger.LogWarning("Another instance is already running");
                Shutdown();
                return;
            }
            
            // 4. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            var configService = serviceProvider.GetRequiredService<IConfigService>();
            var config = configService.LoadConfig();
            
            logger.LogInformation($"Installation ID: {config.InstallationId}");
            logger.LogInformation($"Terminal: {config.TerminalName}");
            
            // 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
            await InitializeServicesAsync();
            
            // 6. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Ç—Ä–µ—è
            CreateTrayIcon();
            
            // 7. –ó–∞–ø—É—Å–∫ Floating Button
            ShowFloatingButton();
            
            // 8. –û–±—Ä–∞–±–æ—Ç–∫–∞ offline –æ—á–µ—Ä–µ–¥–∏
            ProcessOfflineQueueAsync();
            
            // 9. –ó–∞–ø—É—Å–∫ Health Check
            StartHealthMonitoring();
            
            logger.LogInformation("Max Loyalty RKeeper UI started successfully");
        }
        catch (Exception ex)
        {
            logger?.LogError(ex, "Failed to start application");
            MessageBox.Show(
                $"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:\n{ex.Message}",
                "Max Loyalty - –û—à–∏–±–∫–∞",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
            Shutdown();
        }
    }
    
    private void ConfigureLogging()
    {
        Log.Logger = new LoggerConfiguration()
            .MinimumLevel.Information()
            .Enrich.WithProperty("Application", "MaxLoyaltyRKeeperUI")
            .Enrich.WithMachineName()
            .WriteTo.File(
                path: @"C:\Logs\MaxLoyaltyRKeeper\ui-.log",
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 7,
                outputTemplate: "[{Timestamp:yyyy-MM-dd HH:mm:ss}] [{Level:u3}] {Message:lj}{NewLine}{Exception}"
            )
            .CreateLogger();
    }
    
    private IServiceProvider ConfigureServices()
    {
        var services = new ServiceCollection();
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        services.AddLogging(builder =>
        {
            builder.AddSerilog(dispose: true);
        });
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        services.AddSingleton<IConfigService, ConfigService>();
        
        // HTTP –∫–ª–∏–µ–Ω—Ç—ã
        services.AddHttpClient<ILoyaltyApiClient, LoyaltyApiClient>()
            .AddPolicyHandler(GetRetryPolicy())
            .AddPolicyHandler(GetCircuitBreakerPolicy());
        
        services.AddSingleton<IRKeeperXmlClient, RKeeperXmlClient>();
        
        // –°–µ—Ä–≤–∏—Å—ã
        services.AddSingleton<ISharedMemoryService, SharedMemoryService>();
        services.AddSingleton<IOfflineQueueService, OfflineQueueService>();
        services.AddSingleton<ICacheService, CacheService>();
        services.AddSingleton<IHealthCheckService, HealthCheckService>();
        services.AddSingleton<IMetricsService, MetricsService>();
        services.AddSingleton<INotificationService, NotificationService>();
        services.AddSingleton<INavigationService, NavigationService>();
        
        // ViewModels
        services.AddTransient<FloatingButtonViewModel>();
        services.AddTransient<GuestSearchViewModel>();
        services.AddTransient<PointsOperationViewModel>();
        services.AddTransient<DiscountOperationViewModel>();
        services.AddTransient<CreateGuestViewModel>();
        services.AddTransient<DiagnosticsViewModel>();
        services.AddTransient<SettingsViewModel>();
        
        return services.BuildServiceProvider();
    }
    
    private IAsyncPolicy<HttpResponseMessage> GetRetryPolicy()
    {
        return HttpPolicyExtensions
            .HandleTransientHttpError()
            .WaitAndRetryAsync(
                retryCount: 3,
                sleepDurationProvider: retryAttempt => 
                    TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)),
                onRetry: (outcome, timespan, retryAttempt, context) =>
                {
                    logger?.LogWarning(
                        $"Retry {retryAttempt} after {timespan.TotalSeconds}s due to {outcome.Exception?.Message ?? outcome.Result.StatusCode.ToString()}"
                    );
                }
            );
    }
    
    private async Task InitializeServicesAsync()
    {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Shared Memory
        var sharedMemory = serviceProvider.GetRequiredService<ISharedMemoryService>();
        await sharedMemory.InitializeAsync();
        
        // –ü–µ—Ä–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ backend
        var apiClient = serviceProvider.GetRequiredService<ILoyaltyApiClient>();
        try
        {
            await apiClient.SendFirstConnectAsync();
            logger.LogInformation("First connect successful");
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "First connect failed, will retry later");
        }
    }
    
    private void CreateTrayIcon()
    {
        trayIcon = new NotifyIcon
        {
            Icon = new System.Drawing.Icon(@"C:\MaxLoyalty\Resources\ML_Icon.ico"),
            Text = "Max Loyalty",
            Visible = true
        };
        
        var contextMenu = new ContextMenuStrip();
        contextMenu.Items.Add("–ü–æ–∫–∞–∑–∞—Ç—å Floating Button", null, (s, e) => ShowFloatingButton());
        contextMenu.Items.Add("–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞", null, (s, e) => ShowDiagnostics());
        contextMenu.Items.Add("–ù–∞—Å—Ç—Ä–æ–π–∫–∏", null, (s, e) => ShowSettings());
        contextMenu.Items.Add("-");
        contextMenu.Items.Add("–í—ã—Ö–æ–¥", null, (s, e) => Shutdown());
        
        trayIcon.ContextMenuStrip = contextMenu;
        trayIcon.DoubleClick += (s, e) => ShowFloatingButton();
    }
    
    private void ShowFloatingButton()
    {
        if (floatingButton == null || !floatingButton.IsVisible)
        {
            var viewModel = serviceProvider.GetRequiredService<FloatingButtonViewModel>();
            floatingButton = new FloatingButtonWindow
            {
                DataContext = viewModel
            };
            floatingButton.Show();
        }
        else
        {
            floatingButton.Activate();
        }
    }
    
    private async void ProcessOfflineQueueAsync()
    {
        var offlineQueue = serviceProvider.GetRequiredService<IOfflineQueueService>();
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ä–∞–∑—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        await offlineQueue.ProcessQueueAsync();
        
        // –ó–∞—Ç–µ–º –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        var timer = new System.Timers.Timer(5 * 60 * 1000); // 5 –º–∏–Ω—É—Ç
        timer.Elapsed += async (s, e) => await offlineQueue.ProcessQueueAsync();
        timer.Start();
    }
    
    private void StartHealthMonitoring()
    {
        var healthCheck = serviceProvider.GetRequiredService<IHealthCheckService>();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        var timer = new System.Timers.Timer(60 * 1000); // 1 –º–∏–Ω—É—Ç–∞
        timer.Elapsed += async (s, e) =>
        {
            var status = await healthCheck.CheckHealthAsync();
            logger.LogInformation($"Health check: {status}");
        };
        timer.Start();
    }
    
    protected override void OnExit(ExitEventArgs e)
    {
        logger?.LogInformation("Max Loyalty RKeeper UI shutting down");
        
        floatingButton?.Close();
        trayIcon?.Dispose();
        
        Log.CloseAndFlush();
        
        base.OnExit(e);
    }
}
```

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏ (6-18)?

---

# üìò **–ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø - –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï (—á–∞—Å—Ç—å 2)**


***

## **üîò 6. FLOATING BUTTON**

### **6.1. FloatingButtonWindow.xaml**

```xaml
<Window x:Class="MaxLoyaltyRKeeperUI.Views.FloatingButtonWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Max Loyalty"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        Topmost="True"
        ShowInTaskbar="False"
        ResizeMode="NoResize"
        Width="60" Height="60"
        Loaded="Window_Loaded"
        MouseDown="Window_MouseDown"
        MouseMove="Window_MouseMove"
        MouseUp="Window_MouseUp"
        MouseEnter="Window_MouseEnter"
        MouseLeave="Window_MouseLeave">
    
    <Window.Resources>
        <!-- –ê–Ω–∏–º–∞—Ü–∏–∏ -->
        <Storyboard x:Key="PulseAnimation" RepeatBehavior="Forever">
            <DoubleAnimation Storyboard.TargetName="ActiveIndicator"
                           Storyboard.TargetProperty="Opacity"
                           From="0.3" To="1.0" Duration="0:0:1"
                           AutoReverse="True"/>
        </Storyboard>
        
        <Storyboard x:Key="ScaleUpAnimation">
            <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                           Storyboard.TargetProperty="ScaleX"
                           To="1.1" Duration="0:0:0.2"/>
            <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                           Storyboard.TargetProperty="ScaleY"
                           To="1.1" Duration="0:0:0.2"/>
        </Storyboard>
        
        <Storyboard x:Key="ScaleDownAnimation">
            <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                           Storyboard.TargetProperty="ScaleX"
                           To="1.0" Duration="0:0:0.2"/>
            <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                           Storyboard.TargetProperty="ScaleY"
                           To="1.0" Duration="0:0:0.2"/>
        </Storyboard>
    </Window.Resources>
    
    <Grid>
        <Grid.RenderTransform>
            <ScaleTransform x:Name="ScaleTransform" 
                          ScaleX="1" ScaleY="1"
                          CenterX="30" CenterY="30"/>
        </Grid.RenderTransform>
        
        <!-- –¢–µ–Ω—å -->
        <Ellipse Width="60" Height="60">
            <Ellipse.Effect>
                <DropShadowEffect Color="Black" 
                                Direction="270" 
                                ShadowDepth="2" 
                                BlurRadius="10" 
                                Opacity="0.3"/>
            </Ellipse.Effect>
        </Ellipse>
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ -->
        <Border x:Name="MainButton"
                Width="60" Height="60"
                CornerRadius="30"
                Background="#6366F1"
                Opacity="{Binding ButtonOpacity}">
            
            <!-- –õ–æ–≥–æ—Ç–∏–ø ML -->
            <TextBlock Text="ML" 
                      FontSize="24" 
                      FontWeight="Bold"
                      Foreground="White"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center"/>
        </Border>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã -->
        <Ellipse x:Name="ActiveIndicator"
                Width="14" Height="14"
                Fill="#10B981"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Margin="0,3,3,0"
                Visibility="{Binding HasActiveCard, Converter={StaticResource BoolToVisibilityConverter}}"/>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä Drag Mode -->
        <Border x:Name="DragIndicator"
                Width="64" Height="64"
                CornerRadius="32"
                BorderBrush="#6366F1"
                BorderThickness="2"
                BorderDashArray="4 2"
                Visibility="Collapsed"/>
        
        <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
        <Grid.ContextMenu>
            <ContextMenu>
                <MenuItem Header="üîç –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è" 
                         Command="{Binding OpenSearchCommand}"/>
                <MenuItem Header="‚ùå –û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É" 
                         Command="{Binding UnbindCardCommand}"
                         IsEnabled="{Binding HasActiveCard}"/>
                <Separator/>
                <MenuItem Header="üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞" 
                         Command="{Binding OpenDiagnosticsCommand}"/>
                <MenuItem Header="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏" 
                         Command="{Binding OpenSettingsCommand}"/>
                <Separator/>
                <MenuItem Header="‚ÑπÔ∏è –û –ø—Ä–æ–≥—Ä–∞–º–º–µ" 
                         Command="{Binding OpenAboutCommand}"/>
                <MenuItem Header="‚ùå –í—ã—Ö–æ–¥" 
                         Command="{Binding ExitCommand}"/>
            </ContextMenu>
        </Grid.ContextMenu>
    </Grid>
</Window>
```


### **6.2. FloatingButtonWindow.xaml.cs**

```csharp
public partial class FloatingButtonWindow : Window
{
    private readonly FloatingButtonViewModel viewModel;
    private readonly IConfigService configService;
    private readonly ILogger<FloatingButtonWindow> logger;
    
    private bool isDragging = false;
    private bool isLongPress = false;
    private DateTime mouseDownTime;
    private Point mouseDownPosition;
    private CancellationTokenSource longPressCts;
    
    public FloatingButtonWindow(
        FloatingButtonViewModel viewModel,
        IConfigService configService,
        ILogger<FloatingButtonWindow> logger)
    {
        InitializeComponent();
        
        this.viewModel = viewModel;
        this.configService = configService;
        this.logger = logger;
        
        DataContext = viewModel;
    }
    
    private void Window_Loaded(object sender, RoutedEventArgs e)
    {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
        LoadPosition();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞
        if (viewModel.HasActiveCard)
        {
            var storyboard = FindResource("PulseAnimation") as Storyboard;
            storyboard?.Begin();
        }
        
        logger.LogInformation("Floating button loaded at position ({0}, {1})", Left, Top);
    }
    
    private void Window_MouseDown(object sender, MouseButtonEventArgs e)
    {
        if (e.ChangedButton == MouseButton.Left)
        {
            mouseDownTime = DateTime.Now;
            mouseDownPosition = e.GetPosition(this);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è long press (1 —Å–µ–∫—É–Ω–¥–∞)
            longPressCts = new CancellationTokenSource();
            
            Task.Delay(1000, longPressCts.Token).ContinueWith(t =>
            {
                if (!t.IsCanceled && Mouse.LeftButton == MouseButtonState.Pressed)
                {
                    Dispatcher.Invoke(() =>
                    {
                        EnterDragMode();
                    });
                }
            });
        }
    }
    
    private void Window_MouseMove(object sender, MouseEventArgs e)
    {
        if (isDragging && e.LeftButton == MouseButtonState.Pressed)
        {
            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –æ–∫–Ω–æ
            var currentPosition = PointToScreen(e.GetPosition(this));
            Left = currentPosition.X - mouseDownPosition.X;
            Top = currentPosition.Y - mouseDownPosition.Y;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ —ç–∫—Ä–∞–Ω–∞
            ConstrainToScreen();
        }
        else if (e.LeftButton == MouseButtonState.Pressed)
        {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏ - –µ—Å–ª–∏ –¥–≤–∏–≥–∞–µ—Ç—Å—è, –æ—Ç–º–µ–Ω—è–µ–º long press
            var currentPos = e.GetPosition(this);
            var distance = Math.Sqrt(
                Math.Pow(currentPos.X - mouseDownPosition.X, 2) + 
                Math.Pow(currentPos.Y - mouseDownPosition.Y, 2)
            );
            
            if (distance > 5) // 5px threshold
            {
                longPressCts?.Cancel();
            }
        }
    }
    
    private void Window_MouseUp(object sender, MouseButtonEventArgs e)
    {
        longPressCts?.Cancel();
        
        if (isDragging)
        {
            ExitDragMode();
            SavePosition();
        }
        else
        {
            // –û–¥–∏–Ω–æ—á–Ω—ã–π –∫–ª–∏–∫
            var clickDuration = (DateTime.Now - mouseDownTime).TotalMilliseconds;
            
            if (clickDuration < 500) // –ú–µ–Ω–µ–µ 500ms = –∫–ª–∏–∫
            {
                OnSingleClick();
            }
        }
        
        isDragging = false;
    }
    
    private void Window_MouseEnter(object sender, MouseEventArgs e)
    {
        // –ê–Ω–∏–º–∞—Ü–∏—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è
        var storyboard = FindResource("ScaleUpAnimation") as Storyboard;
        storyboard?.Begin();
        
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º opacity
        var opacityAnimation = new DoubleAnimation
        {
            To = 1.0,
            Duration = TimeSpan.FromMilliseconds(200)
        };
        MainButton.BeginAnimation(OpacityProperty, opacityAnimation);
    }
    
    private void Window_MouseLeave(object sender, MouseEventArgs e)
    {
        if (!isDragging)
        {
            // –ê–Ω–∏–º–∞—Ü–∏—è —É–º–µ–Ω—å—à–µ–Ω–∏—è
            var storyboard = FindResource("ScaleDownAnimation") as Storyboard;
            storyboard?.Begin();
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º opacity
            var opacityAnimation = new DoubleAnimation
            {
                To = viewModel.ButtonOpacity,
                Duration = TimeSpan.FromMilliseconds(200)
            };
            MainButton.BeginAnimation(OpacityProperty, opacityAnimation);
        }
    }
    
    private void OnSingleClick()
    {
        logger.LogInformation("Floating button clicked");
        
        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
        PlayClickSound();
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è
        viewModel.OpenSearchCommand?.Execute(null);
    }
    
    private void EnterDragMode()
    {
        isDragging = true;
        isLongPress = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä drag mode
        DragIndicator.Visibility = Visibility.Visible;
        
        // Haptic feedback (–≤–∏–±—Ä–∞—Ü–∏—è) –µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
        TriggerHapticFeedback();
        
        logger.LogInformation("Entered drag mode");
    }
    
    private void ExitDragMode()
    {
        DragIndicator.Visibility = Visibility.Collapsed;
        logger.LogInformation("Exited drag mode");
    }
    
    private void LoadPosition()
    {
        var config = configService.LoadConfig();
        var position = config.UiSettings.FloatingButtonPosition;
        
        switch (position)
        {
            case "TopLeft":
                Left = 20;
                Top = 20;
                break;
                
            case "TopCenter":
                Left = (SystemParameters.PrimaryScreenWidth - Width) / 2;
                Top = 20;
                break;
                
            case "TopRight":
                Left = SystemParameters.PrimaryScreenWidth - Width - 20;
                Top = 20;
                break;
                
            case "MiddleLeft":
                Left = 20;
                Top = (SystemParameters.PrimaryScreenHeight - Height) / 2;
                break;
                
            case "MiddleRight":
                Left = SystemParameters.PrimaryScreenWidth - Width - 20;
                Top = (SystemParameters.PrimaryScreenHeight - Height) / 2;
                break;
                
            case "BottomLeft":
                Left = 20;
                Top = SystemParameters.PrimaryScreenHeight - Height - 80;
                break;
                
            case "BottomCenter":
                Left = (SystemParameters.PrimaryScreenWidth - Width) / 2;
                Top = SystemParameters.PrimaryScreenHeight - Height - 80;
                break;
                
            case "BottomRight":
                Left = SystemParameters.PrimaryScreenWidth - Width - 20;
                Top = SystemParameters.PrimaryScreenHeight - Height - 80;
                break;
                
            case "Custom":
                Left = config.UiSettings.CustomX;
                Top = config.UiSettings.CustomY;
                break;
                
            default:
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é TopRight
                Left = SystemParameters.PrimaryScreenWidth - Width - 20;
                Top = 20;
                break;
        }
        
        ConstrainToScreen();
    }
    
    private void SavePosition()
    {
        var config = configService.LoadConfig();
        config.UiSettings.FloatingButtonPosition = "Custom";
        config.UiSettings.CustomX = Left;
        config.UiSettings.CustomY = Top;
        configService.SaveConfig(config);
        
        logger.LogInformation("Saved new position: ({0}, {1})", Left, Top);
    }
    
    private void ConstrainToScreen()
    {
        // –ù–µ –¥–∞–µ–º –≤—ã–π—Ç–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
        if (Left < 0) Left = 0;
        if (Top < 0) Top = 0;
        if (Left + Width > SystemParameters.PrimaryScreenWidth)
            Left = SystemParameters.PrimaryScreenWidth - Width;
        if (Top + Height > SystemParameters.PrimaryScreenHeight)
            Top = SystemParameters.PrimaryScreenHeight - Height;
    }
    
    private void PlayClickSound()
    {
        var config = configService.LoadConfig();
        if (config.UiSettings.SoundsEnabled)
        {
            try
            {
                var player = new System.Media.SoundPlayer(@"C:\MaxLoyalty\Resources\Sounds\click.wav");
                player.Play();
            }
            catch (Exception ex)
            {
                logger.LogWarning(ex, "Failed to play click sound");
            }
        }
    }
    
    private void TriggerHapticFeedback()
    {
        var config = configService.LoadConfig();
        if (config.UiSettings.VibrationEnabled)
        {
            // –î–ª—è Windows –Ω–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –≤–∏–±—Ä–∞—Ü–∏–∏, –Ω–æ –º–æ–∂–µ–º —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –∑–≤—É–∫
            SystemSounds.Beep.Play();
        }
    }
}
```


### **6.3. FloatingButtonViewModel.cs**

```csharp
public class FloatingButtonViewModel : ViewModelBase
{
    private readonly ISharedMemoryService sharedMemoryService;
    private readonly INavigationService navigationService;
    private readonly ILogger<FloatingButtonViewModel> logger;
    
    private bool hasActiveCard;
    private double buttonOpacity;
    
    public bool HasActiveCard
    {
        get => hasActiveCard;
        set => SetProperty(ref hasActiveCard, value);
    }
    
    public double ButtonOpacity
    {
        get => buttonOpacity;
        set => SetProperty(ref buttonOpacity, value);
    }
    
    public ICommand OpenSearchCommand { get; }
    public ICommand UnbindCardCommand { get; }
    public ICommand OpenDiagnosticsCommand { get; }
    public ICommand OpenSettingsCommand { get; }
    public ICommand OpenAboutCommand { get; }
    public ICommand ExitCommand { get; }
    
    public FloatingButtonViewModel(
        ISharedMemoryService sharedMemoryService,
        INavigationService navigationService,
        IConfigService configService,
        ILogger<FloatingButtonViewModel> logger)
    {
        this.sharedMemoryService = sharedMemoryService;
        this.navigationService = navigationService;
        this.logger = logger;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º opacity –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
        var config = configService.LoadConfig();
        ButtonOpacity = config.UiSettings.FloatingButtonOpacity;
        
        // Commands
        OpenSearchCommand = new RelayCommand(OpenSearch);
        UnbindCardCommand = new RelayCommand(UnbindCard, () => HasActiveCard);
        OpenDiagnosticsCommand = new RelayCommand(OpenDiagnostics);
        OpenSettingsCommand = new RelayCommand(OpenSettings);
        OpenAboutCommand = new RelayCommand(OpenAbout);
        ExitCommand = new RelayCommand(Exit);
        
        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Shared Memory
        sharedMemoryService.ActiveOrdersChanged += OnActiveOrdersChanged;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        UpdateActiveCardStatus();
    }
    
    private void OpenSearch()
    {
        logger.LogInformation("Opening guest search window");
        navigationService.NavigateTo<GuestSearchWindow>();
    }
    
    private async void UnbindCard()
    {
        var result = MessageBox.Show(
            "–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–∫–∞–∑–∞?",
            "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
            MessageBoxButton.YesNo,
            MessageBoxImage.Question
        );
        
        if (result == MessageBoxResult.Yes)
        {
            try
            {
                await sharedMemoryService.UnbindActiveCardAsync();
                HasActiveCard = false;
                logger.LogInformation("Card unbound successfully");
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "Failed to unbind card");
                MessageBox.Show(
                    "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É",
                    "–û—à–∏–±–∫–∞",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error
                );
            }
        }
    }
    
    private void OpenDiagnostics()
    {
        navigationService.NavigateTo<DiagnosticsWindow>();
    }
    
    private void OpenSettings()
    {
        navigationService.NavigateTo<SettingsWindow>();
    }
    
    private void OpenAbout()
    {
        navigationService.NavigateTo<AboutWindow>();
    }
    
    private void Exit()
    {
        var result = MessageBox.Show(
            "–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?\n\n" +
            "Max Loyalty –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —ç—Ç–æ–π –∫–∞—Å—Å–µ.",
            "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞",
            MessageBoxButton.YesNo,
            MessageBoxImage.Warning
        );
        
        if (result == MessageBoxResult.Yes)
        {
            Application.Current.Shutdown();
        }
    }
    
    private void OnActiveOrdersChanged(object sender, EventArgs e)
    {
        UpdateActiveCardStatus();
    }
    
    private async void UpdateActiveCardStatus()
    {
        var activeOrders = await sharedMemoryService.GetActiveOrdersAsync();
        HasActiveCard = activeOrders.Any();
    }
}
```


***

## **üîç 7. –û–ö–ù–ê –ò WORKFLOW**

### **7.1. GuestSearchWindow (–û–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è)**

#### **7.1.1. GuestSearchWindow.xaml**

```xaml
<Window x:Class="MaxLoyaltyRKeeperUI.Views.GuestSearchWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:MaxLoyaltyRKeeperUI.UserControls"
        Title="Max Loyalty - –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è"
        Width="600" Height="900"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize"
        Topmost="True"
        ShowInTaskbar="False"
        Background="White">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Tabs -->
            <RowDefinition Height="Auto"/> <!-- Input -->
            <RowDefinition Height="Auto"/> <!-- Keyboard -->
            <RowDefinition Height="Auto"/> <!-- Orders -->
            <RowDefinition Height="Auto"/> <!-- Actions -->
            <RowDefinition Height="Auto"/> <!-- Footer -->
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" Background="#F9FAFB" Padding="20" BorderBrush="#E5E7EB" BorderThickness="0,0,0,1">
            <Grid>
                <TextBlock Text="MAX LOYALTY" 
                          FontSize="28" FontWeight="Bold"
                          VerticalAlignment="Center"/>
                <Button Content="‚úï" 
                       Width="40" Height="40"
                       HorizontalAlignment="Right"
                       Style="{StaticResource CloseButtonStyle}"
                       Command="{Binding CloseCommand}"/>
            </Grid>
        </Border>
        
        <!-- Tabs -->
        <Border Grid.Row="1" Padding="20,10" Background="White">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <Button Grid.Column="0" 
                       Content="–¢–µ–ª–µ—Ñ–æ–Ω"
                       Height="50"
                       Style="{StaticResource TabButtonStyle}"
                       Command="{Binding SwitchToPhoneCommand}"
                       Background="{Binding IsPhoneTab, Converter={StaticResource TabBackgroundConverter}}"/>
                
                <Button Grid.Column="1" 
                       Content="6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥"
                       Height="50"
                       Style="{StaticResource TabButtonStyle}"
                       Command="{Binding SwitchToCodeCommand}"
                       Background="{Binding IsCodeTab, Converter={StaticResource TabBackgroundConverter}}"/>
            </Grid>
        </Border>
        
        <!-- Input Field -->
        <Border Grid.Row="2" Padding="20">
            <Border BorderBrush="{Binding InputBorderBrush}" 
                   BorderThickness="2"
                   CornerRadius="8"
                   Padding="15">
                <TextBlock Text="{Binding DisplayValue}" 
                          FontSize="24"
                          TextAlignment="Center"
                          Foreground="{Binding InputForeground}"/>
            </Border>
        </Border>
        
        <!-- Numeric Keyboard -->
        <Border Grid.Row="3" Padding="20,0,20,20">
            <controls:NumericKeyboard 
                DisplayValue="{Binding SearchQuery, Mode=TwoWay}"
                MaxLength="{Binding MaxInputLength}"
                HasMaxButton="False"/>
        </Border>
        
        <!-- Active Orders -->
        <Border Grid.Row="4" Padding="20,0,20,20" 
               Visibility="{Binding HasActiveOrders, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel>
                <TextBlock Text="–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã:" 
                          FontSize="16" FontWeight="SemiBold"
                          Margin="0,0,0,10"/>
                
                <ItemsControl ItemsSource="{Binding ActiveOrders}" MaxHeight="200">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="#F9FAFB" 
                                   CornerRadius="8" 
                                   Padding="15" 
                                   Margin="0,0,0,10">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="{Binding DisplayName}" 
                                                  FontSize="16" FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding Amount, StringFormat={}{0:N2} ‚ÇΩ}" 
                                                  FontSize="14" Foreground="#666"/>
                                    </StackPanel>
                                    
                                    <Button Grid.Column="1" 
                                           Content="–í—ã–±—Ä–∞—Ç—å"
                                           Width="100" Height="40"
                                           Command="{Binding DataContext.SelectOrderCommand, 
                                                    RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                           CommandParameter="{Binding}"
                                           Style="{StaticResource PrimaryButtonStyle}"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Border>
        
        <!-- Action Buttons -->
        <Border Grid.Row="5" Padding="20">
            <StackPanel>
                <Button Content="üîç –ù–∞–π—Ç–∏ –≥–æ—Å—Ç—è"
                       Height="70"
                       FontSize="18"
                       Command="{Binding SearchGuestCommand}"
                       Style="{StaticResource PrimaryButtonStyle}"
                       Margin="0,0,0,10"/>
                
                <Button Content="‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ"
                       Height="70"
                       FontSize="18"
                       Command="{Binding CreateGuestCommand}"
                       Style="{StaticResource SecondaryButtonStyle}"/>
            </StackPanel>
        </Border>
        
        <!-- Footer -->
        <Border Grid.Row="6" 
               Background="#F9FAFB" 
               Padding="20" 
               BorderBrush="#E5E7EB" 
               BorderThickness="0,1,0,0"
               Visibility="{Binding SelectedOrder, Converter={StaticResource NullToVisibilityConverter}}">
            <TextBlock FontSize="18" TextAlignment="Center">
                <Run Text="–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞: "/>
                <Run Text="{Binding SelectedOrder.Amount, StringFormat={}{0:N2} ‚ÇΩ}" 
                     FontWeight="Bold"/>
            </TextBlock>
        </Border>
        
        <!-- Loading Overlay -->
        <controls:LoadingOverlay Grid.RowSpan="7"
                                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"
                                Message="{Binding LoadingMessage}"/>
    </Grid>
</Window>
```


#### **7.1.2. GuestSearchViewModel.cs**

```csharp
public class GuestSearchViewModel : ViewModelBase
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly IRKeeperXmlClient rkeeperClient;
    private readonly INavigationService navigationService;
    private readonly ILogger<GuestSearchViewModel> logger;
    
    private string searchQuery;
    private bool isPhoneTab = true;
    private bool isLoading;
    private string loadingMessage;
    private ObservableCollection<RKeeperOrder> activeOrders;
    private RKeeperOrder selectedOrder;
    
    public string SearchQuery
    {
        get => searchQuery;
        set
        {
            SetProperty(ref searchQuery, value);
            OnPropertyChanged(nameof(DisplayValue));
            OnPropertyChanged(nameof(InputBorderBrush));
            ValidateInput();
        }
    }
    
    public bool IsPhoneTab
    {
        get => isPhoneTab;
        set
        {
            SetProperty(ref isPhoneTab, value);
            OnPropertyChanged(nameof(IsCodeTab));
            OnPropertyChanged(nameof(MaxInputLength));
            OnPropertyChanged(nameof(DisplayValue));
        }
    }
    
    public bool IsCodeTab => !IsPhoneTab;
    
    public int MaxInputLength => IsPhoneTab ? 11 : 6;
    
    public string DisplayValue
    {
        get
        {
            if (string.IsNullOrEmpty(SearchQuery))
                return IsPhoneTab ? "+7 (___) ___-__-__" : "______";
            
            if (IsPhoneTab)
                return FormatPhoneNumber(SearchQuery);
            else
                return SearchQuery;
        }
    }
    
    public Brush InputBorderBrush
    {
        get
        {
            if (string.IsNullOrEmpty(SearchQuery))
                return new SolidColorBrush(Color.FromRgb(229, 231, 235)); // #E5E7EB
            
            if (IsValid)
                return new SolidColorBrush(Color.FromRgb(16, 185, 129)); // #10B981 green
            else
                return new SolidColorBrush(Color.FromRgb(239, 68, 68)); // #EF4444 red
        }
    }
    
    public bool IsLoading
    {
        get => isLoading;
        set => SetProperty(ref isLoading, value);
    }
    
    public string LoadingMessage
    {
        get => loadingMessage;
        set => SetProperty(ref loadingMessage, value);
    }
    
    public ObservableCollection<RKeeperOrder> ActiveOrders
    {
        get => activeOrders;
        set
        {
            SetProperty(ref activeOrders, value);
            OnPropertyChanged(nameof(HasActiveOrders));
        }
    }
    
    public bool HasActiveOrders => ActiveOrders?.Any() ?? false;
    
    public RKeeperOrder SelectedOrder
    {
        get => selectedOrder;
        set => SetProperty(ref selectedOrder, value);
    }
    
    private bool IsValid { get; set; }
    
    public ICommand SwitchToPhoneCommand { get; }
    public ICommand SwitchToCodeCommand { get; }
    public ICommand SearchGuestCommand { get; }
    public ICommand CreateGuestCommand { get; }
    public ICommand SelectOrderCommand { get; }
    public ICommand CloseCommand { get; }
    
    public GuestSearchViewModel(
        ILoyaltyApiClient apiClient,
        IRKeeperXmlClient rkeeperClient,
        INavigationService navigationService,
        ILogger<GuestSearchViewModel> logger)
    {
        this.apiClient = apiClient;
        this.rkeeperClient = rkeeperClient;
        this.navigationService = navigationService;
        this.logger = logger;
        
        SwitchToPhoneCommand = new RelayCommand(() => IsPhoneTab = true);
        SwitchToCodeCommand = new RelayCommand(() => IsPhoneTab = false);
        SearchGuestCommand = new AsyncRelayCommand(SearchGuestAsync, CanSearch);
        CreateGuestCommand = new RelayCommand(CreateGuest);
        SelectOrderCommand = new RelayCommand<RKeeperOrder>(SelectOrder);
        CloseCommand = new RelayCommand(Close);
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
        LoadActiveOrdersAsync();
    }
    
    private async Task LoadActiveOrdersAsync()
    {
        try
        {
            var orders = await rkeeperClient.GetOrderListAsync();
            ActiveOrders = new ObservableCollection<RKeeperOrder>(orders);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –µ—Å–ª–∏ –æ–¥–∏–Ω
            if (orders.Count == 1)
            {
                SelectedOrder = orders[0];
            }
            
            logger.LogInformation($"Loaded {orders.Count} active orders");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to load active orders");
            // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É, –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–∫–∞–∑—ã
        }
    }
    
    private void ValidateInput()
    {
        if (string.IsNullOrEmpty(SearchQuery))
        {
            IsValid = false;
            return;
        }
        
        if (IsPhoneTab)
        {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (11 —Ü–∏—Ñ—Ä, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å +7)
            var digits = new string(SearchQuery.Where(char.IsDigit).ToArray());
            IsValid = digits.Length == 11 && digits.StartsWith("7");
        }
        else
        {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è 6-digit –∫–æ–¥–∞
            IsValid = SearchQuery.Length == 6 && SearchQuery.All(char.IsDigit);
        }
        
        OnPropertyChanged(nameof(InputBorderBrush));
        (SearchGuestCommand as AsyncRelayCommand)?.RaiseCanExecuteChanged();
    }
    
    private bool CanSearch()
    {
        return IsValid && SelectedOrder != null && !IsLoading;
    }
    
    private async Task SearchGuestAsync()
    {
        IsLoading = true;
        LoadingMessage = "–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è...";
        
        try
        {
            logger.LogInformation($"Searching guest: {SearchQuery}, OrderId: {SelectedOrder.Id}");
            
            // 1. –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è
            var searchRequest = new SearchGuestRequest
            {
                Phone = IsPhoneTab ? SearchQuery : null,
                Code6Digit = IsCodeTab ? SearchQuery : null
            };
            
            var searchResponse = await apiClient.SearchGuestAsync(searchRequest);
            
            if (!searchResponse.Found)
            {
                IsLoading = false;
                
                var result = MessageBox.Show(
                    "–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\n–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è?",
                    "–ì–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω",
                    MessageBoxButton.YesNo,
                    MessageBoxImage.Question
                );
                
                if (result == MessageBoxResult.Yes)
                {
                    CreateGuest();
                }
                
                return;
            }
            
            var guest = searchResponse.Guest;
            logger.LogInformation($"Guest found: {guest.Name} ({guest.CardId})");
            
            // 2. Calculate
            LoadingMessage = "–†–∞—Å—á–µ—Ç –±–µ–Ω–µ—Ñ–∏—Ç–æ–≤...";
            
            var calculateRequest = new CalculateRequest
            {
                GuestCardId = guest.CardId,
                CheckAmount = SelectedOrder.Amount,
                OrderCategories = SelectedOrder.Categories,
                OrderType = SelectedOrder.Type,
                CalculateOnly = true
            };
            
            var calculateResponse = await apiClient.CalculateAsync(calculateRequest);
            
            logger.LogInformation($"Calculate result: {calculateResponse.BenefitType}");
            
            IsLoading = false;
            
            // 3. –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏
            OpenOperationWindow(guest, calculateResponse);
        }
        catch (HttpRequestException ex)
        {
            IsLoading = false;
            logger.LogError(ex, "Network error during search");
            
            MessageBox.Show(
                "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.",
                "–û—à–∏–±–∫–∞",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
        catch (Exception ex)
        {
            IsLoading = false;
            logger.LogError(ex, "Failed to search guest");
            
            MessageBox.Show(
                $"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:\n{ex.Message}",
                "–û—à–∏–±–∫–∞",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
    
    private void OpenOperationWindow(GuestInfo guest, CalculateResponse calculateResult)
    {
        if (calculateResult.BenefitType == "POINTS")
        {
            navigationService.NavigateTo<PointsOperationWindow>(new
            {
                Guest = guest,
                CalculateResult = calculateResult,
                SelectedOrder = SelectedOrder
            });
        }
        else if (calculateResult.BenefitType == "DISCOUNT")
        {
            navigationService.NavigateTo<DiscountOperationWindow>(new
            {
                Guest = guest,
                CalculateResult = calculateResult,
                SelectedOrder = SelectedOrder
            });
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞
        Close();
    }
    
    private void CreateGuest()
    {
        navigationService.NavigateTo<CreateGuestWindow>(new
        {
            InitialPhone = IsPhoneTab ? SearchQuery : null,
            SelectedOrder = SelectedOrder
        });
        
        Close();
    }
    
    private void SelectOrder(RKeeperOrder order)
    {
        SelectedOrder = order;
        logger.LogInformation($"Order selected: {order.Id} ({order.Amount:N2}‚ÇΩ)");
    }
    
    private void Close()
    {
        (Application.Current.MainWindow as Window)?.Close();
    }
    
    private string FormatPhoneNumber(string input)
    {
        var digits = new string(input.Where(char.IsDigit).ToArray());
        
        if (digits.Length == 0)
            return "+7 (___) ___-__-__";
        
        if (digits.Length <= 1)
            return $"+{digits} (___) ___-__-__";
        
        if (digits.Length <= 4)
            return $"+{digits[0]} ({digits.Substring(1)}___)  ___-__-__";
        
        if (digits.Length <= 7)
            return $"+{digits[0]} ({digits.Substring(1, 3)}) {digits.Substring(4)}___-__-__";
        
        if (digits.Length <= 9)
            return $"+{digits[0]} ({digits.Substring(1, 3)}) {digits.Substring(4, 3)}-{digits.Substring(7)}__-__";
        
        return $"+{digits[0]} ({digits.Substring(1, 3)}) {digits.Substring(4, 3)}-{digits.Substring(7, 2)}-{digits.Substring(9, 2)}";
    }
}
```

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏ –∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏ (7.2-18)?

---

# üìò **–ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø - –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï (—á–∞—Å—Ç—å 3)**


***

### **7.2. PointsOperationWindow (–û–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–ª–ª–∞–º–∏)**

#### **7.2.1. PointsOperationWindow.xaml**

```xaml
<Window x:Class="MaxLoyaltyRKeeperUI.Views.PointsOperationWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:MaxLoyaltyRKeeperUI.UserControls"
        Title="Max Loyalty - –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤"
        Width="600" Height="1000"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize"
        Topmost="True"
        ShowInTaskbar="False"
        Background="White">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Guest Info -->
            <RowDefinition Height="Auto"/> <!-- Balance -->
            <RowDefinition Height="Auto"/> <!-- Check Info -->
            <RowDefinition Height="Auto"/> <!-- Input -->
            <RowDefinition Height="Auto"/> <!-- Keyboard -->
            <RowDefinition Height="Auto"/> <!-- Earn Info -->
            <RowDefinition Height="Auto"/> <!-- Actions -->
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" Background="#6366F1" Padding="20">
            <Grid>
                <TextBlock Text="–°–ü–ò–°–ê–ù–ò–ï –ë–ê–õ–õ–û–í" 
                          FontSize="24" FontWeight="Bold"
                          Foreground="White"
                          VerticalAlignment="Center"/>
                <Button Content="‚úï" 
                       Width="40" Height="40"
                       HorizontalAlignment="Right"
                       Style="{StaticResource CloseButtonWhiteStyle}"
                       Command="{Binding CloseCommand}"/>
            </Grid>
        </Border>
        
        <!-- Guest Info -->
        <Border Grid.Row="1" Background="#F9FAFB" Padding="20" BorderBrush="#E5E7EB" BorderThickness="0,0,0,1">
            <StackPanel>
                <TextBlock FontSize="20" FontWeight="SemiBold">
                    <Run Text="üë§"/>
                    <Run Text="{Binding Guest.Name}"/>
                </TextBlock>
                <TextBlock FontSize="16" Foreground="#666" Margin="0,5,0,0">
                    <Run Text="üì±"/>
                    <Run Text="{Binding Guest.Phone}"/>
                </TextBlock>
                <Border Background="{Binding LevelColor}" 
                       CornerRadius="12" 
                       Padding="12,6"
                       HorizontalAlignment="Left"
                       Margin="0,10,0,0">
                    <TextBlock Text="{Binding Guest.LevelName}" 
                              FontSize="14" FontWeight="SemiBold"
                              Foreground="White"/>
                </Border>
            </StackPanel>
        </Border>
        
        <!-- Balance -->
        <Border Grid.Row="2" Padding="20">
            <Border Background="#EEF2FF" 
                   BorderBrush="#6366F1" 
                   BorderThickness="2"
                   CornerRadius="12" 
                   Padding="20">
                <StackPanel>
                    <TextBlock Text="üí∞ –ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å" 
                              FontSize="16" 
                              Foreground="#4338CA"
                              HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding Guest.TotalBalance, StringFormat={}{0:N2} ‚ÇΩ}" 
                              FontSize="36" 
                              FontWeight="Bold"
                              Foreground="#6366F1"
                              HorizontalAlignment="Center"
                              Margin="0,10,0,0"/>
                    
                    <!-- –†–∞–∑–±–∏–≤–∫–∞ regular/promo –µ—Å–ª–∏ –µ—Å—Ç—å -->
                    <StackPanel Orientation="Horizontal" 
                               HorizontalAlignment="Center"
                               Margin="0,10,0,0"
                               Visibility="{Binding HasPromoBalance, Converter={StaticResource BoolToVisibilityConverter}}">
                        <TextBlock FontSize="14" Foreground="#666">
                            <Run Text="–û—Å–Ω–æ–≤–Ω—ã–µ:"/>
                            <Run Text="{Binding Guest.RegularBalance, StringFormat={}{0:N2}}" FontWeight="SemiBold"/>
                            <Run Text=" ‚Ä¢ –ü—Ä–æ–º–æ:"/>
                            <Run Text="{Binding Guest.PromoBalance, StringFormat={}{0:N2}}" FontWeight="SemiBold"/>
                        </TextBlock>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Border>
        
        <!-- Check Info -->
        <Border Grid.Row="3" Padding="20,0,20,20">
            <StackPanel>
                <Grid Margin="0,0,0,5">
                    <TextBlock Text="–°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏:" FontSize="16"/>
                    <TextBlock Text="{Binding CheckAmount, StringFormat={}{0:N2} ‚ÇΩ}" 
                              FontSize="16" FontWeight="SemiBold"
                              HorizontalAlignment="Right"/>
                </Grid>
                
                <Grid>
                    <TextBlock Text="–î–æ—Å—Ç—É–ø–Ω–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é:" FontSize="16" Foreground="#059669"/>
                    <TextBlock Text="{Binding MaxAllowed, StringFormat={}{0:N2} ‚ÇΩ}" 
                              FontSize="16" FontWeight="Bold"
                              Foreground="#059669"
                              HorizontalAlignment="Right"/>
                </Grid>
                
                <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –º–∞–ª–æ –±–∞–ª–ª–æ–≤ -->
                <Border Background="#FEF3C7" 
                       BorderBrush="#F59E0B" 
                       BorderThickness="1"
                       CornerRadius="8" 
                       Padding="12"
                       Margin="0,10,0,0"
                       Visibility="{Binding ShowLowBalanceWarning, Converter={StaticResource BoolToVisibilityConverter}}">
                    <TextBlock FontSize="14" Foreground="#92400E" TextWrapping="Wrap">
                        <Run Text="‚ö†Ô∏è"/>
                        <Run Text="{Binding LowBalanceMessage}"/>
                    </TextBlock>
                </Border>
            </StackPanel>
        </Border>
        
        <!-- Input Field -->
        <Border Grid.Row="4" Padding="20,0,20,20">
            <Border BorderBrush="{Binding InputBorderBrush}" 
                   BorderThickness="3"
                   CornerRadius="8"
                   Padding="20">
                <Grid>
                    <TextBlock Text="–°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª–æ–≤:" 
                              FontSize="16" 
                              Foreground="#666"
                              VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding PointsToSpendDisplay}" 
                              FontSize="32"
                              FontWeight="Bold"
                              HorizontalAlignment="Right"
                              VerticalAlignment="Center"
                              Foreground="{Binding InputTextColor}"/>
                </Grid>
            </Border>
        </Border>
        
        <!-- Numeric Keyboard -->
        <Border Grid.Row="5" Padding="20,0,20,20">
            <controls:NumericKeyboard 
                DisplayValue="{Binding PointsToSpendInput, Mode=TwoWay}"
                MaxValue="{Binding MaxAllowed}"
                HasMaxButton="True"
                MaxButtonCommand="{Binding SetMaxCommand}"/>
        </Border>
        
        <!-- Earn Info -->
        <Border Grid.Row="6" Padding="20,0,20,20">
            <Border Background="#D1FAE5" 
                   BorderBrush="#10B981" 
                   BorderThickness="1"
                   CornerRadius="8" 
                   Padding="15">
                <TextBlock FontSize="16" TextAlignment="Center">
                    <Run Text="–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ:" Foreground="#065F46"/>
                    <Run Text="{Binding PointsToEarn, StringFormat=+{0}}" 
                         FontWeight="Bold" 
                         FontSize="20"
                         Foreground="#059669"/>
                    <Run Text="–±–∞–ª–ª–æ–≤" Foreground="#065F46"/>
                </TextBlock>
            </Border>
        </Border>
        
        <!-- Action Buttons -->
        <Border Grid.Row="7" Padding="20">
            <StackPanel>
                <!-- –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã -->
                <Button Height="70" 
                       FontSize="18"
                       Command="{Binding ApplyPointsCommand}"
                       Style="{StaticResource PrimaryButtonStyle}"
                       Margin="0,0,0,10">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="üí≥ " FontSize="24" VerticalAlignment="Center"/>
                        <TextBlock Text="–°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
                
                <!-- –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å -->
                <Button Height="60" 
                       FontSize="16"
                       Command="{Binding EarnOnlyCommand}"
                       Style="{StaticResource SecondaryButtonStyle}"
                       Margin="0,0,0,10">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="‚ûï " FontSize="20" VerticalAlignment="Center"/>
                        <TextBlock Text="–¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
                
                <!-- –û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É -->
                <Button Height="50" 
                       FontSize="14"
                       Command="{Binding UnbindCardCommand}"
                       Style="{StaticResource DangerButtonStyle}">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="‚ùå " FontSize="18" VerticalAlignment="Center"/>
                        <TextBlock Text="–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Border>
        
        <!-- Loading Overlay -->
        <controls:LoadingOverlay Grid.RowSpan="8"
                                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"
                                Message="{Binding LoadingMessage}"/>
    </Grid>
</Window>
```


#### **7.2.2. PointsOperationViewModel.cs**

```csharp
public class PointsOperationViewModel : ViewModelBase
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly IRKeeperXmlClient rkeeperClient;
    private readonly ISharedMemoryService sharedMemoryService;
    private readonly IMetricsService metricsService;
    private readonly ILogger<PointsOperationViewModel> logger;
    
    private GuestInfo guest;
    private CalculateResponse calculateResult;
    private RKeeperOrder selectedOrder;
    private string pointsToSpendInput;
    private bool isLoading;
    private string loadingMessage;
    
    public GuestInfo Guest
    {
        get => guest;
        set => SetProperty(ref guest, value);
    }
    
    public decimal CheckAmount => selectedOrder?.Amount ?? 0;
    
    public decimal MaxAllowed => (decimal)(calculateResult?.MaxAllowedToSpend ?? 0);
    
    public decimal PointsToEarn => (decimal)(calculateResult?.PointsToEarn ?? 0);
    
    public string PointsToSpendInput
    {
        get => pointsToSpendInput;
        set
        {
            SetProperty(ref pointsToSpendInput, value);
            OnPropertyChanged(nameof(PointsToSpendDisplay));
            OnPropertyChanged(nameof(InputBorderBrush));
            OnPropertyChanged(nameof(InputTextColor));
            ValidateInput();
        }
    }
    
    public string PointsToSpendDisplay
    {
        get
        {
            if (string.IsNullOrEmpty(PointsToSpendInput))
                return "0";
            
            if (decimal.TryParse(PointsToSpendInput, out var value))
                return value.ToString("N0");
            
            return PointsToSpendInput;
        }
    }
    
    public Brush InputBorderBrush
    {
        get
        {
            if (string.IsNullOrEmpty(PointsToSpendInput))
                return new SolidColorBrush(Color.FromRgb(229, 231, 235)); // Gray
            
            if (IsValidAmount)
                return new SolidColorBrush(Color.FromRgb(99, 102, 241)); // Indigo
            else
                return new SolidColorBrush(Color.FromRgb(239, 68, 68)); // Red
        }
    }
    
    public Brush InputTextColor
    {
        get
        {
            if (!IsValidAmount && !string.IsNullOrEmpty(PointsToSpendInput))
                return Brushes.Red;
            
            return new SolidColorBrush(Color.FromRgb(31, 41, 55)); // Gray-800
        }
    }
    
    public bool ShowLowBalanceWarning => Guest.TotalBalance < MaxAllowed;
    
    public string LowBalanceMessage
    {
        get
        {
            if (Guest.TotalBalance == 0)
                return "–£ –≥–æ—Å—Ç—è –Ω–µ—Ç –±–∞–ª–ª–æ–≤. –ú–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å.";
            
            return $"–ë–∞–ª–∞–Ω—Å ({Guest.TotalBalance:N2}‚ÇΩ) –º–µ–Ω—å—à–µ –¥–æ—Å—Ç—É–ø–Ω–æ–π —Å—É–º–º—ã ({MaxAllowed:N2}‚ÇΩ)";
        }
    }
    
    public bool HasPromoBalance => Guest.PromoBalance > 0;
    
    public Brush LevelColor
    {
        get
        {
            // –¶–≤–µ—Ç–∞ —É—Ä–æ–≤–Ω–µ–π
            return Guest.LevelId switch
            {
                1 => new SolidColorBrush(Color.FromRgb(107, 114, 128)), // Gray - –°—Ç–∞–Ω–¥–∞—Ä—Ç
                2 => new SolidColorBrush(Color.FromRgb(251, 191, 36)),  // Yellow - –°–µ—Ä–µ–±—Ä–æ
                3 => new SolidColorBrush(Color.FromRgb(251, 146, 60)),  // Orange - –ó–æ–ª–æ—Ç–æ
                4 => new SolidColorBrush(Color.FromRgb(147, 51, 234)),  // Purple - –ü–ª–∞—Ç–∏–Ω–∞
                _ => new SolidColorBrush(Color.FromRgb(99, 102, 241))   // Indigo - default
            };
        }
    }
    
    public bool IsLoading
    {
        get => isLoading;
        set => SetProperty(ref isLoading, value);
    }
    
    public string LoadingMessage
    {
        get => loadingMessage;
        set => SetProperty(ref loadingMessage, value);
    }
    
    private bool IsValidAmount { get; set; }
    
    public ICommand SetMaxCommand { get; }
    public ICommand ApplyPointsCommand { get; }
    public ICommand EarnOnlyCommand { get; }
    public ICommand UnbindCardCommand { get; }
    public ICommand CloseCommand { get; }
    
    public PointsOperationViewModel(
        ILoyaltyApiClient apiClient,
        IRKeeperXmlClient rkeeperClient,
        ISharedMemoryService sharedMemoryService,
        IMetricsService metricsService,
        ILogger<PointsOperationViewModel> logger)
    {
        this.apiClient = apiClient;
        this.rkeeperClient = rkeeperClient;
        this.sharedMemoryService = sharedMemoryService;
        this.metricsService = metricsService;
        this.logger = logger;
        
        SetMaxCommand = new RelayCommand(SetMax);
        ApplyPointsCommand = new AsyncRelayCommand(ApplyPointsAsync, CanApplyPoints);
        EarnOnlyCommand = new AsyncRelayCommand(EarnOnlyAsync);
        UnbindCardCommand = new RelayCommand(UnbindCard);
        CloseCommand = new RelayCommand(Close);
    }
    
    public void Initialize(GuestInfo guest, CalculateResponse calculateResult, RKeeperOrder selectedOrder)
    {
        this.guest = guest;
        this.calculateResult = calculateResult;
        this.selectedOrder = selectedOrder;
        
        OnPropertyChanged(nameof(Guest));
        OnPropertyChanged(nameof(CheckAmount));
        OnPropertyChanged(nameof(MaxAllowed));
        OnPropertyChanged(nameof(PointsToEarn));
        OnPropertyChanged(nameof(ShowLowBalanceWarning));
        OnPropertyChanged(nameof(LowBalanceMessage));
        OnPropertyChanged(nameof(HasPromoBalance));
        OnPropertyChanged(nameof(LevelColor));
        
        logger.LogInformation(
            "Points operation initialized: Guest={GuestName}, Check={CheckAmount}, MaxAllowed={MaxAllowed}",
            guest.Name, CheckAmount, MaxAllowed
        );
    }
    
    private void SetMax()
    {
        var max = Math.Min(MaxAllowed, (decimal)Guest.TotalBalance);
        PointsToSpendInput = max.ToString("0");
        logger.LogInformation("Set MAX: {Amount}", max);
    }
    
    private void ValidateInput()
    {
        if (string.IsNullOrEmpty(PointsToSpendInput))
        {
            IsValidAmount = false;
            return;
        }
        
        if (!decimal.TryParse(PointsToSpendInput, out var value))
        {
            IsValidAmount = false;
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∏
        IsValidAmount = value > 0 && 
                       value <= MaxAllowed && 
                       value <= (decimal)Guest.TotalBalance;
        
        (ApplyPointsCommand as AsyncRelayCommand)?.RaiseCanExecuteChanged();
    }
    
    private bool CanApplyPoints()
    {
        return IsValidAmount && !IsLoading;
    }
    
    private async Task ApplyPointsAsync()
    {
        var pointsToSpend = decimal.Parse(PointsToSpendInput);
        
        logger.LogInformation(
            "Applying points: Amount={Amount}, OrderId={OrderId}",
            pointsToSpend, selectedOrder.Id
        );
        
        IsLoading = true;
        LoadingMessage = "–†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –±–∞–ª–ª–æ–≤...";
        
        try
        {
            // 1. –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –Ω–∞ backend
            var reserveRequest = new ReservePointsRequest
            {
                GuestCardId = Guest.CardId,
                PointsToSpend = (double)pointsToSpend,
                MaxAllowed = (double)MaxAllowed,
                CheckAmount = (double)CheckAmount,
                OrderId = selectedOrder.Id
            };
            
            var reserveResponse = await apiClient.ReservePointsAsync(reserveRequest);
            
            if (!reserveResponse.Success)
            {
                IsLoading = false;
                MessageBox.Show(
                    reserveResponse.Error ?? "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å –±–∞–ª–ª—ã",
                    "–û—à–∏–±–∫–∞",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error
                );
                return;
            }
            
            LoadingMessage = "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ –∑–∞–∫–∞–∑—É...";
            
            // 2. –ü—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã –∫ –∑–∞–∫–∞–∑—É —á–µ—Ä–µ–∑ R-Keeper XML
            await rkeeperClient.BindCardToOrderAsync(
                selectedOrder.Id,
                Guest.Phone
            );
            
            // 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä—É—á–Ω–æ–π —Å–∫–∏–¥–∫–∏ –Ω–∞ —Å—É–º–º—É –±–∞–ª–ª–æ–≤
            await rkeeperClient.ApplyManualDiscountAsync(
                selectedOrder.Id,
                pointsToSpend,
                $"Max Loyalty - –ë–∞–ª–ª—ã ({Guest.Name})"
            );
            
            // 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ Shared Memory
            await sharedMemoryService.SaveOrderContextAsync(new OrderContext
            {
                OrderId = selectedOrder.Id,
                GuestCardId = Guest.CardId,
                GuestName = Guest.Name,
                GuestPhone = Guest.Phone,
                BenefitType = BenefitType.Points,
                Action = LoyaltyAction.Spend,
                PointsToSpend = (double)pointsToSpend,
                MaxAllowed = (double)MaxAllowed,
                PointsToEarn = (double)PointsToEarn,
                ReservationId = reserveResponse.ReservationId,
                OriginalCheckAmount = (double)CheckAmount,
                AppliedAt = DateTime.UtcNow,
                StationId = selectedOrder.StationId,
                TerminalId = Environment.MachineName
            });
            
            // 5. –ú–µ—Ç—Ä–∏–∫–∏
            await metricsService.RecordMetricAsync("loyalty.points.applied", (double)pointsToSpend);
            
            IsLoading = false;
            
            // 6. Success notification
            ShowSuccessNotification(
                $"‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ {pointsToSpend:N0}‚ÇΩ –±–∞–ª–ª–æ–≤ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ\n\n" +
                $"–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +{PointsToEarn} –±–∞–ª–ª–æ–≤\n\n" +
                $"–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–∞–ª–ª—ã —Å–ø–∏—à—É—Ç—Å—è —Å –∫–∞—Ä—Ç—ã –≥–æ—Å—Ç—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
            );
            
            logger.LogInformation("Points applied successfully");
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            await Task.Delay(2000);
            Close();
        }
        catch (Exception ex)
        {
            IsLoading = false;
            logger.LogError(ex, "Failed to apply points");
            
            MessageBox.Show(
                $"–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–ª–æ–≤:\n{ex.Message}",
                "–û—à–∏–±–∫–∞",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
    
    private async Task EarnOnlyAsync()
    {
        logger.LogInformation("Earn only mode: OrderId={OrderId}", selectedOrder.Id);
        
        IsLoading = true;
        LoadingMessage = "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è...";
        
        try
        {
            // –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è —Å pointsToSpend = 0 (—Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ)
            var reserveRequest = new ReservePointsRequest
            {
                GuestCardId = Guest.CardId,
                PointsToSpend = 0,
                MaxAllowed = 0,
                CheckAmount = (double)CheckAmount,
                OrderId = selectedOrder.Id,
                Action = "EARN_ONLY"
            };
            
            var reserveResponse = await apiClient.ReservePointsAsync(reserveRequest);
            
            if (!reserveResponse.Success)
            {
                IsLoading = false;
                MessageBox.Show(
                    reserveResponse.Error ?? "–û—à–∏–±–∫–∞",
                    "–û—à–∏–±–∫–∞",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error
                );
                return;
            }
            
            // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã
            await rkeeperClient.BindCardToOrderAsync(selectedOrder.Id, Guest.Phone);
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            await sharedMemoryService.SaveOrderContextAsync(new OrderContext
            {
                OrderId = selectedOrder.Id,
                GuestCardId = Guest.CardId,
                GuestName = Guest.Name,
                GuestPhone = Guest.Phone,
                BenefitType = BenefitType.Points,
                Action = LoyaltyAction.EarnOnly,
                PointsToSpend = 0,
                PointsToEarn = (double)PointsToEarn,
                ReservationId = reserveResponse.ReservationId,
                OriginalCheckAmount = (double)CheckAmount,
                AppliedAt = DateTime.UtcNow
            });
            
            await metricsService.RecordMetricAsync("loyalty.earn_only", (double)PointsToEarn);
            
            IsLoading = false;
            
            ShowSuccessNotification(
                $"‚úÖ –ö–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –∑–∞–∫–∞–∑—É\n\n" +
                $"–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ +{PointsToEarn} –±–∞–ª–ª–æ–≤"
            );
            
            logger.LogInformation("Earn only applied successfully");
            
            await Task.Delay(2000);
            Close();
        }
        catch (Exception ex)
        {
            IsLoading = false;
            logger.LogError(ex, "Failed to apply earn only");
            
            MessageBox.Show(
                $"–û—à–∏–±–∫–∞:\n{ex.Message}",
                "–û—à–∏–±–∫–∞",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
    
    private void UnbindCard()
    {
        var result = MessageBox.Show(
            "–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É –æ—Ç –∑–∞–∫–∞–∑–∞?",
            "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
            MessageBoxButton.YesNo,
            MessageBoxImage.Question
        );
        
        if (result == MessageBoxResult.Yes)
        {
            logger.LogInformation("Card unbound by user");
            Close();
        }
    }
    
    private void Close()
    {
        Application.Current.Windows.OfType<PointsOperationWindow>().FirstOrDefault()?.Close();
    }
    
    private void ShowSuccessNotification(string message)
    {
        var notification = new SuccessNotification
        {
            Message = message,
            Owner = Application.Current.MainWindow
        };
        notification.ShowDialog();
    }
}
```


***

### **7.3. DiscountOperationWindow (–û–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ —Å–∫–∏–¥–∫–æ–π)**

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ PointsOperationWindow**, –Ω–æ —Å –æ—Ç–ª–∏—á–∏—è–º–∏:

```csharp
// –û—Å–Ω–æ–≤–Ω—ã–µ –æ—Ç–ª–∏—á–∏—è –≤ ViewModel:

public decimal DiscountPercentage => (decimal)(calculateResult?.DiscountPercentage ?? 0);
public decimal DiscountAmount => (decimal)(calculateResult?.DiscountAmount ?? 0);

// –í–º–µ—Å—Ç–æ –ø–æ–ª—è –≤–≤–æ–¥–∞ - –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–∏–¥–∫—É
public string DiscountDisplay => $"{DiscountPercentage:N0}% —Å–∫–∏–¥–∫–∞ = {DiscountAmount:N2} ‚ÇΩ";

// –ú–µ—Ç–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:
private async Task ApplyDiscountAsync()
{
    var reserveRequest = new ReserveDiscountRequest
    {
        GuestCardId = Guest.CardId,
        DiscountAmount = (double)DiscountAmount,
        DiscountPercentage = (double)DiscountPercentage,
        CheckAmount = (double)CheckAmount,
        OrderId = selectedOrder.Id
    };
    
    var reserveResponse = await apiClient.ReserveDiscountAsync(reserveRequest);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—É—é —Å–∫–∏–¥–∫—É –≤ R-Keeper
    await rkeeperClient.ApplyPercentDiscountAsync(
        selectedOrder.Id,
        DiscountPercentage,
        $"Max Loyalty - {DiscountPercentage:N0}% ({Guest.LevelName})"
    );
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    await sharedMemoryService.SaveOrderContextAsync(new OrderContext
    {
        OrderId = selectedOrder.Id,
        GuestCardId = Guest.CardId,
        BenefitType = BenefitType.Discount,
        Action = LoyaltyAction.ApplyDiscount,
        DiscountAmount = (double)DiscountAmount,
        DiscountPercentage = (double)DiscountPercentage,
        ReservationId = reserveResponse.ReservationId,
        OriginalCheckAmount = (double)CheckAmount,
        AppliedAt = DateTime.UtcNow
    });
}
```


***

## **‚å®Ô∏è 8. –≠–ö–†–ê–ù–ù–´–ï –ö–õ–ê–í–ò–ê–¢–£–†–´**

### **8.1. NumericKeyboard.xaml**

```xaml
<UserControl x:Class="MaxLoyaltyRKeeperUI.UserControls.NumericKeyboard"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    
    <UserControl.Resources>
        <Style x:Key="KeyButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="#E5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                               BorderBrush="{TemplateBinding BorderBrush}"
                               BorderThickness="{TemplateBinding BorderThickness}"
                               CornerRadius="8">
                            <ContentPresenter HorizontalAlignment="Center"
                                            VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#F3F4F6"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#E5E7EB"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <Style x:Key="MaxButtonStyle" TargetType="Button" BasedOn="{StaticResource KeyButtonStyle}">
            <Setter Property="Background" Value="#10B981"/>
            <Setter Property="Foreground" Value="White"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#059669"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>
    
    <Grid Width="350" Height="400">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        
        <!-- Row 1: 1, 2, 3 -->
        <Button Grid.Row="0" Grid.Column="0" Content="1" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="1"
               Margin="5"/>
        <Button Grid.Row="0" Grid.Column="1" Content="2" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="2"
               Margin="5"/>
        <Button Grid.Row="0" Grid.Column="2" Content="3" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="3"
               Margin="5"/>
        
        <!-- Row 2: 4, 5, 6 -->
        <Button Grid.Row="1" Grid.Column="0" Content="4" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="4"
               Margin="5"/>
        <Button Grid.Row="1" Grid.Column="1" Content="5" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="5"
               Margin="5"/>
        <Button Grid.Row="1" Grid.Column="2" Content="6" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="6"
               Margin="5"/>
        
        <!-- Row 3: 7, 8, 9 -->
        <Button Grid.Row="2" Grid.Column="0" Content="7" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="7"
               Margin="5"/>
        <Button Grid.Row="2" Grid.Column="1" Content="8" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="8"
               Margin="5"/>
        <Button Grid.Row="2" Grid.Column="2" Content="9" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="9"
               Margin="5"/>
        
        <!-- Row 4: ‚Üê, 0, MAX/‚úì -->
        <Button Grid.Row="3" Grid.Column="0" Content="‚Üê" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding BackspaceCommand}"
               Margin="5"/>
        <Button Grid.Row="3" Grid.Column="1" Content="0" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="0"
               Margin="5"/>
        <Button Grid.Row="3" Grid.Column="2" 
               Content="{Binding ThirdButtonContent}"
               Style="{Binding ThirdButtonStyle}"
               Command="{Binding ThirdButtonCommand}"
               Margin="5"/>
    </Grid>
</UserControl>
```


### **8.2. NumericKeyboardViewModel.cs**

```csharp
public class NumericKeyboardViewModel : ViewModelBase
{
    private string displayValue = "";
    private int maxLength = 10;
    private decimal? maxValue;
    private bool hasMaxButton;
    
    public string DisplayValue
    {
        get => displayValue;
        set
        {
            SetProperty(ref displayValue, value);
            InputChanged?.Invoke(this, value);
        }
    }
    
    public int MaxLength
    {
        get => maxLength;
        set => SetProperty(ref maxLength, value);
    }
    
    public decimal? MaxValue
    {
        get => maxValue;
        set => SetProperty(ref maxValue, value);
    }
    
    public bool HasMaxButton
    {
        get => hasMaxButton;
        set
        {
            SetProperty(ref hasMaxButton, value);
            OnPropertyChanged(nameof(ThirdButtonContent));
            OnPropertyChanged(nameof(ThirdButtonStyle));
        }
    }
    
    public string ThirdButtonContent => HasMaxButton ? "MAX" : "‚úì";
    
    public Style ThirdButtonStyle
    {
        get
        {
            if (HasMaxButton)
                return Application.Current.FindResource("MaxButtonStyle") as Style;
            else
                return Application.Current.FindResource("KeyButtonStyle") as Style;
        }
    }
    
    public ICommand KeyPressCommand { get; }
    public ICommand BackspaceCommand { get; }
    public ICommand ThirdButtonCommand { get; }
    public ICommand MaxButtonCommand { get; set; } // –í–Ω–µ—à–Ω—è—è –∫–æ–º–∞–Ω–¥–∞
    
    public event EventHandler<string> InputChanged;
    public event EventHandler ConfirmPressed;
    
    public NumericKeyboardViewModel()
    {
        KeyPressCommand = new RelayCommand<string>(OnKeyPress);
        BackspaceCommand = new RelayCommand(OnBackspace);
        ThirdButtonCommand = new RelayCommand(OnThirdButton);
    }
    
    private void OnKeyPress(string key)
    {
        if (DisplayValue.Length >= MaxLength)
            return;
        
        // –ù–µ –¥–∞–µ–º –≤–≤–µ—Å—Ç–∏ –≤–µ–¥—É—â–∏–π –Ω–æ–ª—å
        if (DisplayValue == "" && key == "0")
            return;
        
        DisplayValue += key;
        PlayClickSound();
    }
    
    private void OnBackspace()
    {
        if (DisplayValue.Length > 0)
        {
            DisplayValue = DisplayValue.Substring(0, DisplayValue.Length - 1);
            PlayClickSound();
        }
    }
    
    private void OnThirdButton()
    {
        if (HasMaxButton)
        {
            // MAX –∫–Ω–æ–ø–∫–∞
            if (MaxValue.HasValue)
            {
                DisplayValue = MaxValue.Value.ToString("0");
                MaxButtonCommand?.Execute(null);
            }
        }
        else
        {
            // Confirm (‚úì) –∫–Ω–æ–ø–∫–∞
            ConfirmPressed?.Invoke(this, EventArgs.Empty);
        }
        
        PlayClickSound();
    }
    
    private void PlayClickSound()
    {
        try
        {
            var player = new System.Media.SoundPlayer(
                @"C:\MaxLoyalty\Resources\Sounds\click.wav"
            );
            player.Play();
        }
        catch
        {
            // Ignore sound errors
        }
    }
}
```


### **8.3. AlphabeticKeyboard.xaml (–¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–æ—Å—Ç—è)**

```xaml
<UserControl x:Class="MaxLoyaltyRKeeperUI.UserControls.AlphabeticKeyboard">
    <Grid Width="700" Height="350">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- –†—É—Å—Å–∫–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ -->
        <Grid x:Name="RussianLayout" Visibility="{Binding IsRussianLayout, Converter={StaticResource BoolToVisibilityConverter}}">
            <!-- –†—è–¥ 1: –ô –¶ –£ –ö –ï –ù –ì –® –© –ó –• –™ -->
            <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Center">
                <Button Content="–ô" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="–ô" Width="50" Height="60" Margin="2"/>
                <Button Content="–¶" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="–¶" Width="50" Height="60" Margin="2"/>
                <Button Content="–£" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="–£" Width="50" Height="60" Margin="2"/>
                <Button Content="–ö" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="–ö" Width="50" Height="60" Margin="2"/>
                <Button Content="–ï" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="–ï" Width="50" Height="60" Margin="2"/>
                <Button Content="–ù" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="–ù" Width="50" Height="60" Margin="2"/>
                <Button Content="–ì" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="–ì" Width="50" Height="60" Margin="2"/>
                <Button Content="–®" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="–®" Width="50" Height="60" Margin="2"/>
                <Button Content="–©" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="–©" Width="50" Height="60" Margin="2"/>
                <Button Content="–ó" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="–ó" Width="50" Height="60" Margin="2"/>
                <Button Content="–•" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="–•" Width="50" Height="60" Margin="2"/>
                <Button Content="–™" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="–™" Width="50" Height="60" Margin="2"/>
            </StackPanel>
            
            <!-- –†—è–¥ 2: –§ –´ –í –ê –ü –† –û –õ –î –ñ –≠ -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center">
                <Button Content="–§" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="–§" Width="50" Height="60" Margin="2"/>
                <!-- ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ ... -->
            </StackPanel>
            
            <!-- –†—è–¥ 3: –Ø –ß –° –ú –ò –¢ –¨ –ë –Æ -->
            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center">
                <Button Content="‚áß" Width="70" Height="60" Style="{StaticResource KeyButtonStyle}" Command="{Binding ShiftCommand}" Margin="2"/>
                <Button Content="–Ø" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="–Ø" Width="50" Height="60" Margin="2"/>
                <!-- ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ ... -->
                <Button Content="‚å´" Width="70" Height="60" Style="{StaticResource KeyButtonStyle}" Command="{Binding BackspaceCommand}" Margin="2"/>
            </StackPanel>
            
            <!-- –†—è–¥ 4: –°–ª—É–∂–µ–±–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
            <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Center">
                <Button Content="EN" Width="80" Height="60" Style="{StaticResource KeyButtonStyle}" Command="{Binding SwitchLayoutCommand}" CommandParameter="EN" Margin="2"/>
                <Button Content="123" Width="80" Height="60" Style="{StaticResource KeyButtonStyle}" Command="{Binding SwitchToNumericCommand}" Margin="2"/>
                <Button Content="–ü–†–û–ë–ï–õ" Width="300" Height="60" Style="{StaticResource KeyButtonStyle}" Command="{Binding SpaceCommand}" Margin="2"/>
                <Button Content="‚úì" Width="80" Height="60" Style="{StaticResource PrimaryButtonStyle}" Command="{Binding ConfirmCommand}" Margin="2"/>
            </StackPanel>
        </Grid>
        
        <!-- –ê–Ω–≥–ª–∏–π—Å–∫–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ) -->
        <!-- ... -->
    </Grid>
</UserControl>
```


***

## **üîÑ 9. SHARED MEMORY –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø**

### **9.1. SharedMemoryService.cs**

```csharp
public interface ISharedMemoryService
{
    Task InitializeAsync();
    Task<SharedMemoryData> GetDataAsync();
    Task UpdateBackendStatusAsync(bool isOnline);
    Task SaveOrderContextAsync(OrderContext context);
    Task<OrderContext> GetOrderContextAsync(string orderId);
    Task ClearOrderContextAsync(string orderId);
    Task<List<OrderContext>> GetActiveOrdersAsync();
    Task EnqueueOfflineOperationAsync(OfflineOperation operation);
    Task<List<OfflineOperation>> GetOfflineQueueAsync();
    Task UpdateMetricsAsync(Dictionary<string, object> metrics);
    event EventHandler ActiveOrdersChanged;
}

public class SharedMemoryService : ISharedMemoryService
{
    private readonly ILogger<SharedMemoryService> logger;
    private MemoryMappedFile mmf;
    private Mutex mutex;
    private const string MMF_NAME = "MaxLoyaltyRKeeperShared";
    private const int MMF_SIZE = 1024 * 1024; // 1 MB
    private const string MUTEX_NAME = "MaxLoyaltyRKeeperMutex";
    
    public event EventHandler ActiveOrdersChanged;
    
    public SharedMemoryService(ILogger<SharedMemoryService> logger)
    {
        this.logger = logger;
    }
    
    public async Task InitializeAsync()
    {
        try
        {
            // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º Mutex
            mutex = new Mutex(false, MUTEX_NAME);
            
            // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º Memory Mapped File
            try
            {
                mmf = MemoryMappedFile.OpenExisting(MMF_NAME);
                logger.LogInformation("Opened existing shared memory");
            }
            catch (FileNotFoundException)
            {
                mmf = MemoryMappedFile.CreateNew(MMF_NAME, MMF_SIZE);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                var initialData = new SharedMemoryData
                {
                    Version = "1.0.0",
                    LastUpdated = DateTime.UtcNow,
                    BackendStatus = new BackendStatus { IsOnline = false },
                    ActiveOrders = new Dictionary<string, OrderContext>(),
                    OfflineQueue = new List<OfflineOperation>(),
                    Metrics = new Dictionary<string, object>()
                };
                
                await WriteDataAsync(initialData);
                
                logger.LogInformation("Created new shared memory");
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to initialize shared memory");
            throw;
        }
    }
    
    public async Task<SharedMemoryData> GetDataAsync()
    {
        mutex.WaitOne();
        
        try
        {
            using var accessor = mmf.CreateViewAccessor();
            
            // –ß–∏—Ç–∞–µ–º —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–≤—ã–µ 4 –±–∞–π—Ç–∞)
            var dataSize = accessor.ReadInt32(0);
            
            if (dataSize == 0 || dataSize > MMF_SIZE - 4)
            {
                logger.LogWarning("Invalid data size in shared memory: {Size}", dataSize);
                return new SharedMemoryData();
            }
            
            // –ß–∏—Ç–∞–µ–º JSON –¥–∞–Ω–Ω—ã–µ
            var jsonBytes = new byte[dataSize];
            accessor.ReadArray(4, jsonBytes, 0, dataSize);
            
            var json = Encoding.UTF8.GetString(jsonBytes);
            var data = JsonConvert.DeserializeObject<SharedMemoryData>(json);
            
            return data;
        }
        finally
        {
            mutex.ReleaseMutex();
        }
    }
    
    private async Task WriteDataAsync(SharedMemoryData data)
    {
        mutex.WaitOne();
        
        try
        {
            data.LastUpdated = DateTime.UtcNow;
            
            var json = JsonConvert.SerializeObject(data);
            var jsonBytes = Encoding.UTF8.GetBytes(json);
            
            if (jsonBytes.Length > MMF_SIZE - 4)
            {
                throw new InvalidOperationException(
                    $"Data too large for shared memory: {jsonBytes.Length} bytes"
                );
            }
            
            using var accessor = mmf.CreateViewAccessor();
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
            accessor.Write(0, jsonBytes.Length);
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            accessor.WriteArray(4, jsonBytes, 0, jsonBytes.Length);
            
            logger.LogDebug("Wrote {Size} bytes to shared memory", jsonBytes.Length);
        }
        finally
        {
            mutex.ReleaseMutex();
        }
    }
    
    public async Task UpdateBackendStatusAsync(bool isOnline)
    {
        var data = await GetDataAsync();
        data.BackendStatus = new BackendStatus
        {
            IsOnline = isOnline,
            LastCheckAt = DateTime.UtcNow,
            LatencyMs = 0 // TODO: measure actual latency
        };
        await WriteDataAsync(data);
        
        logger.LogInformation("Backend status updated: {Status}", isOnline ? "Online" : "Offline");
    }
    
    public async Task SaveOrderContextAsync(OrderContext context)
    {
        var data = await GetDataAsync();
        data.ActiveOrders[context.OrderId] = context;
        await WriteDataAsync(data);
        
        logger.LogInformation("Order context saved: {OrderId}", context.OrderId);
        
        ActiveOrdersChanged?.Invoke(this, EventArgs.Empty);
    }
    
    public async Task<OrderContext> GetOrderContextAsync(string orderId)
    {
        var data = await GetDataAsync();
        return data.ActiveOrders.TryGetValue(orderId, out var context) ? context : null;
    }
    
    public async Task ClearOrderContextAsync(string orderId)
    {
        var data = await GetDataAsync();
        if (data.ActiveOrders.Remove(orderId))
        {
            await WriteDataAsync(data);
            logger.LogInformation("Order context cleared: {OrderId}", orderId);
            
            ActiveOrdersChanged?.Invoke(this, EventArgs.Empty);
        }
    }
    
    public async Task<List<OrderContext>> GetActiveOrdersAsync()
    {
        var data = await GetDataAsync();
        return data.ActiveOrders.Values.ToList();
    }
    
    public async Task EnqueueOfflineOperationAsync(OfflineOperation operation)
    {
        var data = await GetDataAsync();
        
        if (data.OfflineQueue.Count >= 100)
        {
            logger.LogWarning("Offline queue is full, removing oldest item");
            data.OfflineQueue.RemoveAt(0);
        }
        
        operation.Id = Guid.NewGuid().ToString();
        operation.QueuedAt = DateTime.UtcNow;
        operation.Attempts = 0;
        
        data.OfflineQueue.Add(operation);
        await WriteDataAsync(data);
        
        logger.LogWarning("Operation queued offline: {Type} - {OrderId}", 
            operation.Type, operation.OrderId);
    }
    
    public async Task<List<OfflineOperation>> GetOfflineQueueAsync()
    {
        var data = await GetDataAsync();
        return data.OfflineQueue;
    }
    
    public async Task UpdateMetricsAsync(Dictionary<string, object> metrics)
    {
        var data = await GetDataAsync();
        foreach (var kvp in metrics)
        {
            data.Metrics[kvp.Key] = kvp.Value;
        }
        await WriteDataAsync(data);
    }
}

// –ú–æ–¥–µ–ª–∏ –¥–ª—è Shared Memory
public class SharedMemoryData
{
    public string Version { get; set; }
    public DateTime LastUpdated { get; set; }
    public BackendStatus BackendStatus { get; set; }
    public Dictionary<string, OrderContext> ActiveOrders { get; set; }
    public List<OfflineOperation> OfflineQueue { get; set; }
    public Dictionary<string, object> Metrics { get; set; }
}

public class BackendStatus
{
    public bool IsOnline { get; set; }
    public DateTime LastCheckAt { get; set; }
    public int LatencyMs { get; set; }
}
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏ 10-18 (R-Keeper XML API, Backend endpoints, –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è, Offline, –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –û–±–Ω–æ–≤–ª–µ–Ω–∏—è, –ê–Ω–∞–ª–∏—Ç–∏–∫–∞)?

---

# üìò **–ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø - –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï (—á–∞—Å—Ç—å 4)**


***

## **üîå 10. R-KEEPER XML API –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø**

### **10.1. RKeeperXmlClient.cs**

```csharp
public interface IRKeeperXmlClient
{
    Task<List<RKeeperOrder>> GetOrderListAsync();
    Task<RKeeperOrder> GetOrderDetailsAsync(string orderId);
    Task BindCardToOrderAsync(string orderId, string cardNumber);
    Task ApplyManualDiscountAsync(string orderId, decimal amount, string reason);
    Task ApplyPercentDiscountAsync(string orderId, decimal percentage, string reason);
    Task<string> GetCashierNameAsync();
    Task<ServerInfo> GetServerInfoAsync();
}

public class RKeeperXmlClient : IRKeeperXmlClient
{
    private readonly HttpClient httpClient;
    private readonly IConfigService configService;
    private readonly ILogger<RKeeperXmlClient> logger;
    private readonly string xmlApiUrl;
    
    public RKeeperXmlClient(
        HttpClient httpClient,
        IConfigService configService,
        ILogger<RKeeperXmlClient> logger)
    {
        this.httpClient = httpClient;
        this.configService = configService;
        this.logger = logger;
        
        var config = configService.LoadConfig();
        xmlApiUrl = config.RKeeperXmlApiUrl;
        
        httpClient.Timeout = TimeSpan.FromSeconds(10);
    }
    
    public async Task<List<RKeeperOrder>> GetOrderListAsync()
    {
        logger.LogInformation("Getting order list from R-Keeper");
        
        var xml = @"
            <RK7Query>
              <RK7CMD CMD=""GetOrderList"">
                <Filter>
                  <Status>OPEN</Status>
                </Filter>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        
        // –ü–∞—Ä—Å–∏–Ω–≥ XML –æ—Ç–≤–µ—Ç–∞
        var doc = XDocument.Parse(response);
        
        var orders = doc.Descendants("Order").Select(o => new RKeeperOrder
        {
            Id = o.Element("ident")?.Value,
            TableNumber = o.Element("Table")?.Value,
            Amount = ParseDecimal(o.Element("Amount")?.Value),
            Status = o.Element("Status")?.Value,
            Type = ParseOrderType(o.Element("OrderType")?.Value),
            Categories = ParseCategories(o.Element("Items")),
            StationId = o.Element("StationId")?.Value,
            OpenedAt = ParseDateTime(o.Element("OpenedAt")?.Value),
            DisplayName = GetOrderDisplayName(o)
        }).ToList();
        
        logger.LogInformation("Retrieved {Count} orders", orders.Count);
        
        return orders;
    }
    
    public async Task<RKeeperOrder> GetOrderDetailsAsync(string orderId)
    {
        logger.LogInformation("Getting order details: {OrderId}", orderId);
        
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""GetOrder"">
                <Order>
                  <ident>{XmlEscape(orderId)}</ident>
                </Order>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        var doc = XDocument.Parse(response);
        
        var orderElement = doc.Descendants("Order").FirstOrDefault();
        if (orderElement == null)
        {
            throw new Exception($"Order {orderId} not found");
        }
        
        return new RKeeperOrder
        {
            Id = orderElement.Element("ident")?.Value,
            TableNumber = orderElement.Element("Table")?.Value,
            Amount = ParseDecimal(orderElement.Element("Amount")?.Value),
            Status = orderElement.Element("Status")?.Value,
            Type = ParseOrderType(orderElement.Element("OrderType")?.Value),
            Categories = ParseCategories(orderElement.Element("Items")),
            Items = ParseItems(orderElement.Element("Items")),
            StationId = orderElement.Element("StationId")?.Value,
            CashierId = orderElement.Element("CashierId")?.Value,
            CashierName = orderElement.Element("CashierName")?.Value,
            OpenedAt = ParseDateTime(orderElement.Element("OpenedAt")?.Value)
        };
    }
    
    public async Task BindCardToOrderAsync(string orderId, string cardNumber)
    {
        logger.LogInformation("Binding card to order: {OrderId}, Card: {CardNumber}", 
            orderId, MaskCardNumber(cardNumber));
        
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""SaveOrder"">
                <Order>
                  <ident>{XmlEscape(orderId)}</ident>
                  <GuestCard>
                    <CardNumber>{XmlEscape(cardNumber)}</CardNumber>
                  </GuestCard>
                </Order>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏
        var doc = XDocument.Parse(response);
        var status = doc.Descendants("Status").FirstOrDefault()?.Value;
        
        if (status != "OK")
        {
            var error = doc.Descendants("Error").FirstOrDefault()?.Value ?? "Unknown error";
            throw new Exception($"Failed to bind card: {error}");
        }
        
        logger.LogInformation("Card bound successfully");
    }
    
    public async Task ApplyManualDiscountAsync(string orderId, decimal amount, string reason)
    {
        logger.LogInformation("Applying manual discount: {OrderId}, Amount: {Amount}", 
            orderId, amount);
        
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""SaveOrder"">
                <Order>
                  <ident>{XmlEscape(orderId)}</ident>
                  <Discount>
                    <Type>MANUAL</Type>
                    <DiscountType>FIXED</DiscountType>
                    <Value>{amount.ToString("0.00", CultureInfo.InvariantCulture)}</Value>
                    <Reason>{XmlEscape(reason)}</Reason>
                  </Discount>
                </Order>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        ValidateResponse(response);
        
        logger.LogInformation("Manual discount applied successfully");
    }
    
    public async Task ApplyPercentDiscountAsync(string orderId, decimal percentage, string reason)
    {
        logger.LogInformation("Applying percent discount: {OrderId}, Percentage: {Percentage}%", 
            orderId, percentage);
        
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""SaveOrder"">
                <Order>
                  <ident>{XmlEscape(orderId)}</ident>
                  <Discount>
                    <Type>MANUAL</Type>
                    <DiscountType>PERCENT</DiscountType>
                    <Value>{percentage.ToString("0.00", CultureInfo.InvariantCulture)}</Value>
                    <Reason>{XmlEscape(reason)}</Reason>
                  </Discount>
                </Order>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        ValidateResponse(response);
        
        logger.LogInformation("Percent discount applied successfully");
    }
    
    public async Task<string> GetCashierNameAsync()
    {
        try
        {
            var xml = @"
                <RK7Query>
                  <RK7CMD CMD=""GetCurrentUser""/>
                </RK7Query>
            ";
            
            var response = await SendXmlRequestAsync(xml);
            var doc = XDocument.Parse(response);
            
            var cashierName = doc.Descendants("UserName").FirstOrDefault()?.Value;
            return cashierName ?? "Unknown";
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to get cashier name");
            return "Unknown";
        }
    }
    
    public async Task<ServerInfo> GetServerInfoAsync()
    {
        var xml = @"
            <RK7Query>
              <RK7CMD CMD=""GetServerInfo""/>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        var doc = XDocument.Parse(response);
        
        return new ServerInfo
        {
            Version = doc.Descendants("Version").FirstOrDefault()?.Value,
            ServerName = doc.Descendants("ServerName").FirstOrDefault()?.Value,
            DatabaseName = doc.Descendants("DatabaseName").FirstOrDefault()?.Value,
            IsOnline = true
        };
    }
    
    private async Task<string> SendXmlRequestAsync(string xmlRequest)
    {
        try
        {
            var content = new StringContent(xmlRequest, Encoding.UTF8, "text/xml");
            var response = await httpClient.PostAsync(xmlApiUrl, content);
            
            if (!response.IsSuccessStatusCode)
            {
                logger.LogError("R-Keeper XML API returned {StatusCode}", response.StatusCode);
                throw new HttpRequestException($"R-Keeper API error: {response.StatusCode}");
            }
            
            var responseXml = await response.Content.ReadAsStringAsync();
            
            logger.LogDebug("R-Keeper Response: {Response}", responseXml);
            
            return responseXml;
        }
        catch (TaskCanceledException ex)
        {
            logger.LogError(ex, "R-Keeper XML API request timeout");
            throw new TimeoutException("R-Keeper API timeout", ex);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "R-Keeper XML API request failed");
            throw;
        }
    }
    
    private void ValidateResponse(string xmlResponse)
    {
        var doc = XDocument.Parse(xmlResponse);
        var status = doc.Descendants("Status").FirstOrDefault()?.Value;
        
        if (status != "OK" && status != "SUCCESS")
        {
            var error = doc.Descendants("Error").FirstOrDefault()?.Value ?? "Unknown error";
            throw new Exception($"R-Keeper error: {error}");
        }
    }
    
    private decimal ParseDecimal(string value)
    {
        if (string.IsNullOrEmpty(value))
            return 0;
        
        return decimal.Parse(value, CultureInfo.InvariantCulture);
    }
    
    private DateTime? ParseDateTime(string value)
    {
        if (string.IsNullOrEmpty(value))
            return null;
        
        return DateTime.Parse(value, CultureInfo.InvariantCulture);
    }
    
    private string ParseOrderType(string value)
    {
        return value?.ToUpperInvariant() switch
        {
            "DINEIN" => "DINE_IN",
            "TAKEAWAY" => "TAKEAWAY",
            "DELIVERY" => "DELIVERY",
            _ => "DINE_IN"
        };
    }
    
    private List<string> ParseCategories(XElement itemsElement)
    {
        if (itemsElement == null)
            return new List<string>();
        
        return itemsElement.Descendants("Item")
            .Select(i => i.Element("Category")?.Value)
            .Where(c => !string.IsNullOrEmpty(c))
            .Distinct()
            .ToList();
    }
    
    private List<OrderItem> ParseItems(XElement itemsElement)
    {
        if (itemsElement == null)
            return new List<OrderItem>();
        
        return itemsElement.Descendants("Item").Select(i => new OrderItem
        {
            Name = i.Element("Name")?.Value,
            Quantity = ParseDecimal(i.Element("Quantity")?.Value),
            Price = ParseDecimal(i.Element("Price")?.Value),
            Category = i.Element("Category")?.Value
        }).ToList();
    }
    
    private string GetOrderDisplayName(XElement orderElement)
    {
        var table = orderElement.Element("Table")?.Value;
        var amount = ParseDecimal(orderElement.Element("Amount")?.Value);
        
        if (!string.IsNullOrEmpty(table))
            return $"–°—Ç–æ–ª {table} - {amount:N0}‚ÇΩ";
        
        return $"–ó–∞–∫–∞–∑ - {amount:N0}‚ÇΩ";
    }
    
    private string XmlEscape(string value)
    {
        return SecurityElement.Escape(value);
    }
    
    private string MaskCardNumber(string cardNumber)
    {
        if (cardNumber.Length <= 4)
            return "****";
        
        return "****" + cardNumber.Substring(cardNumber.Length - 4);
    }
}

// –ú–æ–¥–µ–ª–∏
public class RKeeperOrder
{
    public string Id { get; set; }
    public string TableNumber { get; set; }
    public decimal Amount { get; set; }
    public string Status { get; set; }
    public string Type { get; set; }
    public List<string> Categories { get; set; }
    public List<OrderItem> Items { get; set; }
    public string StationId { get; set; }
    public string CashierId { get; set; }
    public string CashierName { get; set; }
    public DateTime? OpenedAt { get; set; }
    public string DisplayName { get; set; }
}

public class OrderItem
{
    public string Name { get; set; }
    public decimal Quantity { get; set; }
    public decimal Price { get; set; }
    public string Category { get; set; }
}

public class ServerInfo
{
    public string Version { get; set; }
    public string ServerName { get; set; }
    public string DatabaseName { get; set; }
    public bool IsOnline { get; set; }
}
```


***

## **üåê 11. BACKEND API ENDPOINTS**

### **11.1. API Endpoints —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è**

```typescript
// ==========================================
// 1. –ü–û–ò–°–ö –ì–û–°–¢–Ø
// ==========================================

POST /api/pos-integration/rkeeper/search-guest

Headers:
  X-API-Key: rk_live_xxxxx
  X-Installation-Id: inst_abc123
  X-Tenant-Id: tenant_mario
  X-Restaurant-Id: rest_centro
  X-Terminal-Id: term_001
  Content-Type: application/json

Request Body:
{
  "phone"?: "+79991234567",
  "code6Digit"?: "123456"
}

Response 200:
{
  "found": true,
  "guest": {
    "cardId": "card_uuid_abc",
    "name": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
    "phone": "+79991234567",
    "email": "ivan@example.com",
    "levelId": 2,
    "levelName": "–°–µ—Ä–µ–±—Ä–æ",
    "regularBalance": 1500.00,
    "promoBalance": 950.00,
    "totalBalance": 2450.00,
    "code6Digit": "123456",
    "birthDate": "1990-05-15",
    "registeredAt": "2024-01-10T10:30:00Z"
  }
}

Response 200 (not found):
{
  "found": false,
  "guest": null
}

Response 401:
{
  "error": "Unauthorized",
  "message": "Invalid API Key"
}

// ==========================================
// 2. –†–ê–°–ß–ï–¢ –ë–ï–ù–ï–§–ò–¢–û–í
// ==========================================

POST /api/pos-integration/rkeeper/calculate

Request Body:
{
  "guestCardId": "card_uuid_abc",
  "checkAmount": 890.00,
  "orderCategories": ["–ü–∏—Ü—Ü–∞", "–ù–∞–ø–∏—Ç–∫–∏"],
  "orderType": "DINE_IN",
  "calculateOnly": true
}

Response 200:
{
  "benefitType": "POINTS",
  "maxAllowedToSpend": 178.00,
  "pointsToEarn": 45.00,
  "discountPercentage": 0,
  "discountAmount": 0,
  "checkAmount": 890.00,
  "minCheckAmount": 100.00,
  "rules": {
    "maxSpendPercentage": 20,
    "earnRate": 5,
    "excludedCategories": []
  }
}

Response 200 (DISCOUNT type):
{
  "benefitType": "DISCOUNT",
  "maxAllowedToSpend": 0,
  "pointsToEarn": 0,
  "discountPercentage": 15,
  "discountAmount": 133.50,
  "checkAmount": 890.00,
  "minCheckAmount": 100.00
}

// ==========================================
// 3. –†–ï–ó–ï–†–í–ê–¶–ò–Ø –ë–ê–õ–õ–û–í
// ==========================================

POST /api/pos-integration/rkeeper/reserve-points

Request Body:
{
  "guestCardId": "card_uuid_abc",
  "pointsToSpend": 178.00,
  "maxAllowed": 178.00,
  "checkAmount": 890.00,
  "orderId": "order_12345",
  "restaurantId": "rest_centro",
  "terminalId": "term_001",
  "action": "SPEND"
}

Response 200:
{
  "success": true,
  "reservationId": "res_xyz789",
  "pointsReserved": 178.00,
  "expiresAt": "2026-02-18T01:00:00Z",
  "newBalance": 2272.00
}

Response 400:
{
  "success": false,
  "error": "Insufficient balance",
  "message": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤. –î–æ—Å—Ç—É–ø–Ω–æ: 150.00"
}

// ==========================================
// 4. –†–ï–ó–ï–†–í–ê–¶–ò–Ø –°–ö–ò–î–ö–ò
// ==========================================

POST /api/pos-integration/rkeeper/reserve-discount

Request Body:
{
  "guestCardId": "card_uuid_abc",
  "discountPercentage": 15,
  "discountAmount": 133.50,
  "checkAmount": 890.00,
  "orderId": "order_12345"
}

Response 200:
{
  "success": true,
  "reservationId": "res_discount_abc",
  "discountPercentage": 15,
  "discountAmount": 133.50,
  "expiresAt": "2026-02-18T01:00:00Z"
}

// ==========================================
// 5. –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–õ–õ–û–í
// ==========================================

POST /api/pos-integration/rkeeper/finalize-points

Request Body:
{
  "guestCardId": "card_uuid_abc",
  "orderId": "order_12345",
  "reservationId": "res_xyz789",
  "pointsSpent": 178.00,
  "pointsToEarn": 45.00,
  "action": "SPEND",
  "checkAmount": 890.00,
  "finalCheckAmount": 890.00,
  "restaurantId": "rest_centro",
  "terminalId": "term_001",
  "stationId": "STATION_001",
  "cashierName": "–ò–≤–∞–Ω–æ–≤–∞ –ê.",
  "paymentTypes": ["CASH", "CARD"],
  "orderType": "DINE_IN"
}

Response 200:
{
  "success": true,
  "transactionId": "txn_abc123",
  "pointsSpent": 178.00,
  "pointsEarned": 45.00,
  "newBalance": 2317.00,
  "earnedAt": "2026-02-18T00:45:00Z"
}

// ==========================================
// 6. –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø –°–ö–ò–î–ö–ò
// ==========================================

POST /api/pos-integration/rkeeper/finalize-discount

Request Body:
{
  "guestCardId": "card_uuid_abc",
  "orderId": "order_12345",
  "reservationId": "res_discount_abc",
  "discountAmount": 133.50,
  "discountPercentage": 15,
  "checkAmount": 890.00,
  "finalCheckAmount": 756.50,
  "restaurantId": "rest_centro",
  "terminalId": "term_001",
  "cashierName": "–ò–≤–∞–Ω–æ–≤–∞ –ê.",
  "paymentTypes": ["CARD"]
}

Response 200:
{
  "success": true,
  "transactionId": "txn_discount_123",
  "discountApplied": 133.50,
  "finalAmount": 756.50
}

// ==========================================
// 7. –û–ë–ù–û–í–õ–ï–ù–ò–ï –†–ï–ó–ï–†–í–ê–¶–ò–ò
// ==========================================

POST /api/pos-integration/rkeeper/update-reservation

Request Body:
{
  "reservationId": "res_xyz789",
  "newCheckAmount": 950.00,
  "newPointsToSpend": 190.00
}

Response 200:
{
  "success": true,
  "updatedAt": "2026-02-18T00:47:00Z"
}

// ==========================================
// 8. –û–¢–ú–ï–ù–ê –†–ï–ó–ï–†–í–ê–¶–ò–ò
// ==========================================

POST /api/pos-integration/rkeeper/cancel-reservation

Request Body:
{
  "reservationId": "res_xyz789",
  "orderId": "order_12345",
  "reason": "USER_UNBIND"
}

Response 200:
{
  "success": true,
  "cancelledAt": "2026-02-18T00:48:00Z"
}

// ==========================================
// 9. –°–û–ó–î–ê–ù–ò–ï –ì–û–°–¢–Ø
// ==========================================

POST /api/pos-integration/rkeeper/create-guest

Request Body:
{
  "phone": "+79991234567",
  "name": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
  "birthDate": "1990-05-15",
  "email": "ivan@example.com"
}

Response 200:
{
  "success": true,
  "guestCardId": "card_new_uuid",
  "code6Digit": "654321",
  "message": "–ì–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"
}

// ==========================================
// 10. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –†–ï–°–¢–û–†–ê–ù–ê
// ==========================================

GET /api/pos-integration/rkeeper/config

Response 200:
{
  "restaurantId": "rest_centro",
  "restaurantName": "–ü–∏—Ü—Ü–µ—Ä–∏—è –£ –ú–∞—Ä–∏–æ - –¶–µ–Ω—Ç—Ä",
  "tenantId": "tenant_mario",
  "minCheckAmount": 100.00,
  "maxSpendPercentage": 20,
  "earnRate": 5,
  "supportedBenefitTypes": ["POINTS", "DISCOUNT"],
  "excludedCategories": [],
  "timezone": "Europe/Moscow"
}

// ==========================================
// 11. HEALTH CHECK
// ==========================================

GET /api/health

Response 200:
{
  "status": "ok",
  "timestamp": "2026-02-18T00:50:00Z",
  "version": "1.2.0"
}

// ==========================================
// 12. FIRST CONNECT
// ==========================================

POST /api/pos-integration/rkeeper/first-connect

Request Body:
{
  "installation_id": "inst_abc123",
  "terminal_name": "–ö–∞—Å—Å–∞ 1 (–æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª)",
  "station_id": "STATION_001",
  "machine_id": "MACHINE_XYZ",
  "os_version": "Windows 11 Pro",
  "plugin_version": "1.0.0",
  "rkeeper_version": "7.5.2"
}

Response 200:
{
  "success": true,
  "message": "Installation activated",
  "activatedAt": "2026-02-18T00:51:00Z"
}

// ==========================================
// 13. –û–¢–ü–†–ê–í–ö–ê –ú–ï–¢–†–ò–ö
// ==========================================

POST /api/pos-integration/rkeeper/metrics

Request Body:
[
  {
    "name": "loyalty.points.applied",
    "value": 178.00,
    "tags": {
      "terminal_id": "term_001",
      "restaurant_id": "rest_centro"
    },
    "timestamp": "2026-02-18T00:52:00Z"
  },
  {
    "name": "loyalty.transaction.completed",
    "value": 1,
    "tags": {
      "terminal_id": "term_001"
    },
    "timestamp": "2026-02-18T00:52:00Z"
  }
]

Response 200:
{
  "received": true,
  "count": 2
}
```


***

## **‚úÖ 12. –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø –¢–†–ê–ù–ó–ê–ö–¶–ò–ô**

### **12.1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ FarCard**

```cpp
// –í external.dll: FinalizeTransaction –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ R-Keeper

int FinalizeTransaction(
    const char* reservationId,
    double finalAmount,
    const char* orderId,
    const char* paymentTypesJson
)
{
    g_logger->Info("FinalizeTransaction: OrderId=%s, Amount=%.2f", orderId, finalAmount);
    
    try
    {
        // 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ shared memory
        auto context = g_sharedMemory->GetOrderContext(orderId);
        
        if (!context.has_value())
        {
            g_logger->Warning("No loyalty context for order %s", orderId);
            return 0; // –ù–µ –æ—à–∏–±–∫–∞, –ø—Ä–æ—Å—Ç–æ –Ω–µ—Ç –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
        }
        
        // 2. –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∫–∞—Å—Å–∏—Ä–∞
        std::string cashierName = GetCurrentCashierName();
        
        // 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ backend
        json requestBody = {
            {"guestCardId", context->cardId},
            {"orderId", orderId},
            {"reservationId", context->reservationId},
            {"checkAmount", context->originalAmount},
            {"finalCheckAmount", finalAmount},
            {"restaurantId", g_restaurantId},
            {"terminalId", g_terminalId},
            {"stationId", context->stationId},
            {"cashierName", cashierName},
            {"paymentTypes", json::parse(paymentTypesJson)},
            {"orderType", "DINE_IN"}
        };
        
        std::string endpoint;
        
        if (context->benefitType == BenefitType::Points)
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-points";
            requestBody["pointsSpent"] = context->pointsToSpend;
            requestBody["pointsToEarn"] = context->pointsToEarn;
            requestBody["action"] = context->action;
        }
        else if (context->benefitType == BenefitType::Discount)
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-discount";
            requestBody["discountAmount"] = context->discountAmount;
            requestBody["discountPercentage"] = context->discountPercentage;
        }
        
        // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å retry
        auto response = RetryPolicy::Execute([&]() {
            return g_httpClient->Post(endpoint, requestBody.dump());
        }, 3);
        
        if (response.statusCode == 200)
        {
            auto responseData = json::parse(response.body);
            
            if (responseData["success"].get<bool>())
            {
                std::string txnId = responseData["transactionId"].get<std::string>();
                g_logger->Info("Finalized successfully: TxnId=%s", txnId.c_str());
                
                // 5. –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
                g_sharedMemory->ClearOrderContext(orderId);
                
                // 6. –£–≤–µ–¥–æ–º–ª—è–µ–º UI
                g_sharedMemory->NotifyUI("order_finalized", orderId);
                
                // 7. –ú–µ—Ç—Ä–∏–∫–∏
                SendMetric("loyalty.transaction.finalized", 1);
                
                return 0; // Success
            }
        }
        
        // Backend –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        g_logger->Warning("Backend unavailable, queueing offline...");
        
        // 8. –î–æ–±–∞–≤–ª—è–µ–º –≤ offline queue
        g_sharedMemory->EnqueueOfflineOperation({
            "FINALIZE_" + std::string(context->benefitType == BenefitType::Points ? "POINTS" : "DISCOUNT"),
            orderId,
            requestBody.dump(),
            GetCurrentTimestamp(),
            0 // attempts
        });
        
        return -2; // Queued offline
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("FinalizeTransaction exception: %s", ex.what());
        return -1;
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∫–∞—Å—Å–∏—Ä–∞
std::string GetCurrentCashierName()
{
    try
    {
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è R-Keeper
        char* cashier = std::getenv("RK7_CURRENT_USER");
        if (cashier != nullptr)
        {
            return std::string(cashier);
        }
        
        // –ò–ª–∏ —á–µ—Ä–µ–∑ Windows API
        char username[256];
        DWORD size = sizeof(username);
        if (GetUserNameA(username, &size))
        {
            return std::string(username);
        }
        
        return "Unknown";
    }
    catch (...)
    {
        return "Unknown";
    }
}
```


### **12.2. –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ UI (–µ—Å–ª–∏ DLL –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞)**

```csharp
// UI –º–æ–∂–µ—Ç —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Backend API

public class OrderFinalizationService
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly ISharedMemoryService sharedMemory;
    private readonly ILogger<OrderFinalizationService> logger;
    
    public async Task<bool> TryFinalizeOrderAsync(string orderId)
    {
        var context = await sharedMemory.GetOrderContextAsync(orderId);
        
        if (context == null)
        {
            logger.LogInformation("No context for order {OrderId}", orderId);
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ —É–∂–µ
        if (DateTime.UtcNow - context.AppliedAt > TimeSpan.FromHours(24))
        {
            logger.LogWarning("Context expired for order {OrderId}", orderId);
            await sharedMemory.ClearOrderContextAsync(orderId);
            return false;
        }
        
        try
        {
            // –ü—ã—Ç–∞–µ–º—Å—è —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            if (context.BenefitType == BenefitType.Points)
            {
                var result = await apiClient.FinalizePointsAsync(new FinalizePointsRequest
                {
                    GuestCardId = context.GuestCardId,
                    OrderId = orderId,
                    ReservationId = context.ReservationId,
                    PointsSpent = context.PointsToSpend,
                    PointsToEarn = context.PointsToEarn,
                    CheckAmount = context.OriginalCheckAmount,
                    FinalCheckAmount = context.OriginalCheckAmount, // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è
                    Action = context.Action.ToString()
                });
                
                if (result.Success)
                {
                    await sharedMemory.ClearOrderContextAsync(orderId);
                    logger.LogInformation("Order {OrderId} finalized successfully", orderId);
                    return true;
                }
            }
            
            return false;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to finalize order {OrderId}", orderId);
            return false;
        }
    }
}
```


***

## **üì¥ 13. OFFLINE –†–ï–ñ–ò–ú**

### **13.1. OfflineQueueService.cs**

```csharp
public class OfflineQueueService : IOfflineQueueService
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly ISharedMemoryService sharedMemory;
    private readonly ILogger<OfflineQueueService> logger;
    private readonly string queueFilePath;
    private const int MaxQueueSize = 100;
    private const int TtlHours = 24;
    
    public OfflineQueueService(
        ILoyaltyApiClient apiClient,
        ISharedMemoryService sharedMemory,
        ILogger<OfflineQueueService> logger)
    {
        this.apiClient = apiClient;
        this.sharedMemory = sharedMemory;
        this.logger = logger;
        
        queueFilePath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "MaxLoyaltyRKeeper",
            "offline_queue.json"
        );
    }
    
    public async Task EnqueueAsync(OfflineOperation operation)
    {
        var queue = await LoadQueueAsync();
        
        if (queue.Count >= MaxQueueSize)
        {
            logger.LogWarning("Offline queue is full ({Count}), removing oldest", queue.Count);
            queue.RemoveAt(0);
        }
        
        operation.Id = Guid.NewGuid().ToString();
        operation.QueuedAt = DateTime.UtcNow;
        operation.Attempts = 0;
        
        queue.Add(operation);
        await SaveQueueAsync(queue);
        
        // –¢–∞–∫–∂–µ –≤ shared memory
        await sharedMemory.EnqueueOfflineOperationAsync(operation);
        
        logger.LogWarning(
            "Operation queued offline: Type={Type}, OrderId={OrderId}",
            operation.Type, operation.OrderId
        );
    }
    
    public async Task ProcessQueueAsync()
    {
        var queue = await LoadQueueAsync();
        
        if (queue.Count == 0)
        {
            logger.LogDebug("Offline queue is empty");
            return;
        }
        
        logger.LogInformation("Processing offline queue: {Count} operations", queue.Count);
        
        var processed = new List<OfflineOperation>();
        var failed = new List<OfflineOperation>();
        
        foreach (var operation in queue)
        {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ TTL
            if (DateTime.UtcNow - operation.QueuedAt > TimeSpan.FromHours(TtlHours))
            {
                logger.LogWarning("Operation expired: {Id}, Age={Age}h", 
                    operation.Id, 
                    (DateTime.UtcNow - operation.QueuedAt).TotalHours);
                processed.Add(operation);
                continue;
            }
            
            // –ü–æ–ø—ã—Ç–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            try
            {
                var success = await ProcessOperationAsync(operation);
                
                if (success)
                {
                    processed.Add(operation);
                    logger.LogInformation("Processed offline operation: {Id}", operation.Id);
                }
                else
                {
                    operation.Attempts++;
                    
                    if (operation.Attempts >= 5)
                    {
                        logger.LogError("Operation failed after 5 attempts: {Id}", operation.Id);
                        processed.Add(operation); // –£–¥–∞–ª—è–µ–º –∏–∑ –æ—á–µ—Ä–µ–¥–∏
                    }
                    else
                    {
                        failed.Add(operation);
                    }
                }
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "Error processing offline operation: {Id}", operation.Id);
                
                operation.Attempts++;
                failed.Add(operation);
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–µ—Ä–µ–¥—å
        queue = failed;
        await SaveQueueAsync(queue);
        
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        if (processed.Count > 0)
        {
            ShowNotification(
                "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞",
                $"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {processed.Count} –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ –æ—á–µ—Ä–µ–¥–∏",
                NotificationType.Success
            );
        }
        
        logger.LogInformation(
            "Offline queue processed: Success={Success}, Failed={Failed}, Remaining={Remaining}",
            processed.Count, queue.Count - processed.Count, queue.Count
        );
    }
    
    private async Task<bool> ProcessOperationAsync(OfflineOperation operation)
    {
        var payload = JsonConvert.DeserializeObject<dynamic>(operation.Payload);
        
        switch (operation.Type)
        {
            case "FINALIZE_POINTS":
                var pointsRequest = JsonConvert.DeserializeObject<FinalizePointsRequest>(operation.Payload);
                var pointsResult = await apiClient.FinalizePointsAsync(pointsRequest);
                return pointsResult.Success;
                
            case "FINALIZE_DISCOUNT":
                var discountRequest = JsonConvert.DeserializeObject<FinalizeDiscountRequest>(operation.Payload);
                var discountResult = await apiClient.FinalizeDiscountAsync(discountRequest);
                return discountResult.Success;
                
            default:
                logger.LogWarning("Unknown operation type: {Type}", operation.Type);
                return false;
        }
    }
    
    private async Task<List<OfflineOperation>> LoadQueueAsync()
    {
        try
        {
            if (!File.Exists(queueFilePath))
                return new List<OfflineOperation>();
            
            var json = await File.ReadAllTextAsync(queueFilePath);
            return JsonConvert.DeserializeObject<List<OfflineOperation>>(json) 
                   ?? new List<OfflineOperation>();
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to load offline queue");
            return new List<OfflineOperation>();
        }
    }
    
    private async Task SaveQueueAsync(List<OfflineOperation> queue)
    {
        try
        {
            var directory = Path.GetDirectoryName(queueFilePath);
            if (!Directory.Exists(directory))
            {
                Directory.CreateDirectory(directory);
            }
            
            var json = JsonConvert.SerializeObject(queue, Formatting.Indented);
            await File.WriteAllTextAsync(queueFilePath, json);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to save offline queue");
        }
    }
    
    private void ShowNotification(string title, string message, NotificationType type)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            var notification = new ToastNotification
            {
                Title = title,
                Message = message,
                Type = type
            };
            notification.Show();
        });
    }
}
```


### **13.2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ offline —Ä–µ–∂–∏–º–∞**

```csharp
public class HealthCheckService : IHealthCheckService
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly ISharedMemoryService sharedMemory;
    private readonly ILogger<HealthCheckService> logger;
    private Timer healthCheckTimer;
    private bool isBackendHealthy = true;
    
    public bool IsBackendOnline => isBackendHealthy;
    
    public event EventHandler<bool> StatusChanged;
    
    public void StartMonitoring()
    {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        healthCheckTimer = new Timer(60000); // 60 —Å–µ–∫—É–Ω–¥
        healthCheckTimer.Elapsed += async (s, e) => await CheckHealthAsync();
        healthCheckTimer.AutoReset = true;
        healthCheckTimer.Start();
        
        logger.LogInformation("Health monitoring started");
    }
    
    public async Task<HealthStatus> CheckHealthAsync()
    {
        try
        {
            var cts = new CancellationTokenSource(TimeSpan.FromSeconds(3));
            
            var stopwatch = Stopwatch.StartNew();
            var response = await apiClient.HealthCheckAsync(cts.Token);
            stopwatch.Stop();
            
            var wasOffline = !isBackendHealthy;
            isBackendHealthy = response.IsSuccessStatusCode;
            
            if (isBackendHealthy)
            {
                await sharedMemory.UpdateBackendStatusAsync(true);
                
                if (wasOffline)
                {
                    logger.LogInformation("Backend is back online");
                    StatusChanged?.Invoke(this, true);
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É offline –æ—á–µ—Ä–µ–¥–∏
                    _ = ProcessOfflineQueueAsync();
                }
                
                return new HealthStatus
                {
                    IsOnline = true,
                    LatencyMs = (int)stopwatch.ElapsedMilliseconds,
                    CheckedAt = DateTime.UtcNow
                };
            }
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Health check failed");
        }
        
        // Backend offline
        var wasOnline = isBackendHealthy;
        isBackendHealthy = false;
        
        await sharedMemory.UpdateBackendStatusAsync(false);
        
        if (wasOnline)
        {
            logger.LogWarning("Backend went offline");
            StatusChanged?.Invoke(this, false);
        }
        
        return new HealthStatus
        {
            IsOnline = false,
            CheckedAt = DateTime.UtcNow
        };
    }
    
    private async Task ProcessOfflineQueueAsync()
    {
        try
        {
            var offlineQueue = Application.Current.Services
                .GetRequiredService<IOfflineQueueService>();
            
            await offlineQueue.ProcessQueueAsync();
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to process offline queue");
        }
    }
}
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏ 14-18 (–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –û–±–Ω–æ–≤–ª–µ–Ω–∏—è, –ê–Ω–∞–ª–∏—Ç–∏–∫–∞)?

---

# üìò **–ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø - –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï (—á–∞—Å—Ç—å 5)**


***

## **üîê 14. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨**

### **14.1. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API Key**

```csharp
public class Encryption
{
    private const string SALT = "MaxLoyaltySalt2026";
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Machine ID (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–π –º–∞—à–∏–Ω—ã)
    public static string GetMachineId()
    {
        var sb = new StringBuilder();
        
        // CPU ID
        using (var searcher = new ManagementObjectSearcher("SELECT ProcessorId FROM Win32_Processor"))
        {
            foreach (var obj in searcher.Get())
            {
                sb.Append(obj["ProcessorId"]?.ToString());
            }
        }
        
        // Motherboard Serial
        using (var searcher = new ManagementObjectSearcher("SELECT SerialNumber FROM Win32_BaseBoard"))
        {
            foreach (var obj in searcher.Get())
            {
                sb.Append(obj["SerialNumber"]?.ToString());
            }
        }
        
        // MAC Address
        var nic = NetworkInterface.GetAllNetworkInterfaces()
            .FirstOrDefault(n => n.OperationalStatus == OperationalStatus.Up 
                              && n.NetworkInterfaceType != NetworkInterfaceType.Loopback);
        
        if (nic != null)
        {
            sb.Append(nic.GetPhysicalAddress().ToString());
        }
        
        // –•–µ—à–∏—Ä—É–µ–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ ID
        using var sha256 = SHA256.Create();
        var hash = sha256.ComputeHash(Encoding.UTF8.GetBytes(sb.ToString()));
        return Convert.ToBase64String(hash);
    }
    
    // –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API Key (–¥–ª—è —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞)
    public static string EncryptApiKey(string apiKey, string machineId)
    {
        using var aes = Aes.Create();
        aes.Key = DeriveKey(machineId);
        aes.IV = DeriveIV(machineId);
        
        using var encryptor = aes.CreateEncryptor();
        var plainBytes = Encoding.UTF8.GetBytes(apiKey);
        var encryptedBytes = encryptor.TransformFinalBlock(plainBytes, 0, plainBytes.Length);
        
        return Convert.ToBase64String(encryptedBytes);
    }
    
    // –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ API Key (–≤ –ø–ª–∞–≥–∏–Ω–µ)
    public static string DecryptApiKey(string encryptedApiKey, string machineId)
    {
        try
        {
            using var aes = Aes.Create();
            aes.Key = DeriveKey(machineId);
            aes.IV = DeriveIV(machineId);
            
            using var decryptor = aes.CreateDecryptor();
            var encryptedBytes = Convert.FromBase64String(encryptedApiKey);
            var decryptedBytes = decryptor.TransformFinalBlock(encryptedBytes, 0, encryptedBytes.Length);
            
            return Encoding.UTF8.GetString(decryptedBytes);
        }
        catch (Exception ex)
        {
            throw new CryptographicException("Failed to decrypt API Key. This key is bound to a different machine.", ex);
        }
    }
    
    private static byte[] DeriveKey(string machineId)
    {
        using var deriveBytes = new Rfc2898DeriveBytes(
            machineId + SALT,
            Encoding.UTF8.GetBytes(SALT),
            10000,
            HashAlgorithmName.SHA256
        );
        
        return deriveBytes.GetBytes(32); // 256 bits
    }
    
    private static byte[] DeriveIV(string machineId)
    {
        using var deriveBytes = new Rfc2898DeriveBytes(
            SALT + machineId,
            Encoding.UTF8.GetBytes(machineId),
            10000,
            HashAlgorithmName.SHA256
        );
        
        return deriveBytes.GetBytes(16); // 128 bits
    }
}
```


### **14.2. Machine Binding –ø—Ä–æ–≤–µ—Ä–∫–∞**

```csharp
public class SecurityService
{
    private readonly IConfigService configService;
    private readonly ILogger<SecurityService> logger;
    
    public async Task<bool> ValidateMachineBindingAsync()
    {
        try
        {
            var config = configService.LoadConfig();
            var currentMachineId = Encryption.GetMachineId();
            
            // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å API Key
            var apiKey = Encryption.DecryptApiKey(config.ApiKeyEncrypted, currentMachineId);
            
            if (string.IsNullOrEmpty(apiKey))
            {
                logger.LogError("Failed to decrypt API Key - machine binding mismatch");
                return false;
            }
            
            logger.LogInformation("Machine binding validated successfully");
            return true;
        }
        catch (CryptographicException ex)
        {
            logger.LogError(ex, "Machine binding validation failed");
            
            ShowSecurityWarning(
                "‚ùå –û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏",
                "–≠—Ç–æ—Ç –ø–ª–∞–≥–∏–Ω –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É –∫–æ–º–ø—å—é—Ç–µ—Ä—É.\n\n" +
                "–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ —ç—Ç–æ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä —Å–∫–∞—á–∞–π—Ç–µ –Ω–æ–≤—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –∏–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏."
            );
            
            return false;
        }
    }
    
    private void ShowSecurityWarning(string title, string message)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            MessageBox.Show(
                message,
                title,
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
            
            Application.Current.Shutdown();
        });
    }
}
```


### **14.3. API Key Revocation –ø—Ä–æ–≤–µ—Ä–∫–∞**

```csharp
public class ApiKeyValidator
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly ILogger<ApiKeyValidator> logger;
    private Timer validationTimer;
    
    public void StartPeriodicValidation()
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
        validationTimer = new Timer(30 * 60 * 1000);
        validationTimer.Elapsed += async (s, e) => await ValidateApiKeyAsync();
        validationTimer.AutoReset = true;
        validationTimer.Start();
        
        // –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–∑—É
        _ = ValidateApiKeyAsync();
    }
    
    public async Task<bool> ValidateApiKeyAsync()
    {
        try
        {
            var response = await apiClient.GetAsync("/api/pos-integration/rkeeper/validate-key");
            
            if (response.IsSuccessStatusCode)
            {
                var result = JsonConvert.DeserializeObject<ApiKeyValidationResult>(
                    await response.Content.ReadAsStringAsync()
                );
                
                if (result.IsValid)
                {
                    logger.LogDebug("API Key is valid");
                    return true;
                }
                else
                {
                    logger.LogError("API Key was revoked: {Reason}", result.Reason);
                    HandleRevokedKey(result.Reason);
                    return false;
                }
            }
            
            return false;
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to validate API Key");
            return true; // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏
        }
    }
    
    private void HandleRevokedKey(string reason)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            MessageBox.Show(
                $"‚ö†Ô∏è –î–æ—Å—Ç—É–ø –∫ Max Loyalty –æ—Ç–∫–ª—é—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.\n\n" +
                $"–ü—Ä–∏—á–∏–Ω–∞: {reason}\n\n" +
                $"–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∏—Å—Ç–µ–º—ã.",
                "–î–æ—Å—Ç—É–ø –æ—Ç–∫–ª—é—á–µ–Ω",
                MessageBoxButton.OK,
                MessageBoxImage.Warning
            );
            
            Application.Current.Shutdown();
        });
    }
}

public class ApiKeyValidationResult
{
    public bool IsValid { get; set; }
    public string Reason { get; set; }
    public DateTime? RevokedAt { get; set; }
}
```


### **14.4. HTTPS Only enforcement**

```csharp
public class HttpClientFactory
{
    public static HttpClient CreateSecureClient(string baseUrl, string apiKey)
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ URL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HTTPS
        if (!baseUrl.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
        {
            throw new SecurityException("Only HTTPS connections are allowed");
        }
        
        var handler = new HttpClientHandler
        {
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
            ServerCertificateCustomValidationCallback = (message, cert, chain, errors) =>
            {
                if (errors == SslPolicyErrors.None)
                    return true;
                
                // –í production –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
                return false;
            }
        };
        
        var client = new HttpClient(handler)
        {
            BaseAddress = new Uri(baseUrl),
            Timeout = TimeSpan.FromSeconds(30)
        };
        
        // Headers
        client.DefaultRequestHeaders.Add("X-API-Key", apiKey);
        client.DefaultRequestHeaders.Add("User-Agent", "MaxLoyaltyRKeeper/1.0.0");
        client.DefaultRequestHeaders.Accept.Add(
            new MediaTypeWithQualityHeaderValue("application/json")
        );
        
        return client;
    }
}
```


### **14.5. –ó–∞—â–∏—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**

```csharp
public class ConfigService : IConfigService
{
    private readonly string configPath;
    private readonly ILogger<ConfigService> logger;
    
    public Config LoadConfig()
    {
        if (!File.Exists(configPath))
        {
            throw new FileNotFoundException("Configuration file not found");
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É
        var fileInfo = new FileInfo(configPath);
        var fileSecurity = fileInfo.GetAccessControl();
        
        // –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∏ —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø
        var rules = fileSecurity.GetAccessRules(true, true, typeof(NTAccount));
        foreach (FileSystemAccessRule rule in rules)
        {
            if (rule.IdentityReference.Value != Environment.UserName &&
                !rule.IdentityReference.Value.Contains("SYSTEM"))
            {
                logger.LogWarning("Unauthorized access rule found: {Identity}", 
                    rule.IdentityReference.Value);
            }
        }
        
        var json = File.ReadAllText(configPath);
        var config = JsonConvert.DeserializeObject<Config>(json);
        
        // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º API Key
        var machineId = Encryption.GetMachineId();
        config.ApiKey = Encryption.DecryptApiKey(config.ApiKeyEncrypted, machineId);
        
        return config;
    }
    
    public void SaveConfig(Config config)
    {
        // –®–∏—Ñ—Ä—É–µ–º API Key –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
        var machineId = Encryption.GetMachineId();
        config.ApiKeyEncrypted = Encryption.EncryptApiKey(config.ApiKey, machineId);
        config.ApiKey = null; // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ
        
        var json = JsonConvert.SerializeObject(config, Formatting.Indented);
        File.WriteAllText(configPath, json);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–æ–≥–∏–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
        var fileInfo = new FileInfo(configPath);
        var fileSecurity = fileInfo.GetAccessControl();
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞
        fileSecurity.SetAccessRuleProtection(true, false);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏ —Å–∏—Å—Ç–µ–º—É
        var currentUser = WindowsIdentity.GetCurrent().Name;
        fileSecurity.AddAccessRule(new FileSystemAccessRule(
            currentUser,
            FileSystemRights.FullControl,
            AccessControlType.Allow
        ));
        
        fileSecurity.AddAccessRule(new FileSystemAccessRule(
            "SYSTEM",
            FileSystemRights.FullControl,
            AccessControlType.Allow
        ));
        
        fileInfo.SetAccessControl(fileSecurity);
        
        logger.LogInformation("Config saved with restricted permissions");
    }
}
```


***

## **üìä 15. –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì**

### **15.1. Serilog –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**

```csharp
public static class LoggingConfiguration
{
    public static void ConfigureSerilog()
    {
        Log.Logger = new LoggerConfiguration()
            .MinimumLevel.Information()
            .MinimumLevel.Override("Microsoft", LogEventLevel.Warning)
            .MinimumLevel.Override("System", LogEventLevel.Warning)
            .Enrich.FromLogContext()
            .Enrich.WithProperty("Application", "MaxLoyaltyRKeeperUI")
            .Enrich.WithProperty("Version", GetVersion())
            .Enrich.WithMachineName()
            .Enrich.WithEnvironmentUserName()
            .Enrich.WithThreadId()
            .WriteTo.File(
                path: @"C:\Logs\MaxLoyaltyRKeeper\ui-.log",
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 7,
                fileSizeLimitBytes: 50 * 1024 * 1024, // 50 MB
                rollOnFileSizeLimit: true,
                outputTemplate: "[{Timestamp:yyyy-MM-dd HH:mm:ss.fff}] [{Level:u3}] [{SourceContext}] {Message:lj}{NewLine}{Exception}"
            )
            .WriteTo.File(
                path: @"C:\Logs\MaxLoyaltyRKeeper\errors-.log",
                restrictedToMinimumLevel: LogEventLevel.Error,
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 30,
                outputTemplate: "[{Timestamp:yyyy-MM-dd HH:mm:ss.fff}] [{Level:u3}] [{SourceContext}] {Message:lj}{NewLine}{Exception}"
            )
            .CreateLogger();
        
        Log.Information("===== Max Loyalty RKeeper UI Started =====");
        Log.Information("Version: {Version}", GetVersion());
        Log.Information("Machine: {MachineName}", Environment.MachineName);
        Log.Information("User: {UserName}", Environment.UserName);
        Log.Information("OS: {OS}", Environment.OSVersion);
    }
    
    private static string GetVersion()
    {
        var assembly = Assembly.GetExecutingAssembly();
        var version = assembly.GetName().Version;
        return $"{version.Major}.{version.Minor}.{version.Build}";
    }
}
```


### **15.2. Structured Logging –ø—Ä–∏–º–µ—Ä—ã**

```csharp
public class LoyaltyApiClient : ILoyaltyApiClient
{
    private readonly ILogger<LoyaltyApiClient> logger;
    
    public async Task<SearchGuestResponse> SearchGuestAsync(SearchGuestRequest request)
    {
        using (logger.BeginScope(new Dictionary<string, object>
        {
            ["RequestId"] = Guid.NewGuid().ToString(),
            ["Phone"] = MaskPhone(request.Phone),
            ["Code6Digit"] = request.Code6Digit
        }))
        {
            logger.LogInformation("Searching guest: Phone={Phone}, Code={Code}", 
                MaskPhone(request.Phone), request.Code6Digit);
            
            var stopwatch = Stopwatch.StartNew();
            
            try
            {
                var response = await httpClient.PostAsJsonAsync(
                    "/api/pos-integration/rkeeper/search-guest", 
                    request
                );
                
                stopwatch.Stop();
                
                logger.LogInformation(
                    "Guest search completed: StatusCode={StatusCode}, Duration={Duration}ms",
                    response.StatusCode, stopwatch.ElapsedMilliseconds
                );
                
                response.EnsureSuccessStatusCode();
                
                var result = await response.Content.ReadFromJsonAsync<SearchGuestResponse>();
                
                logger.LogInformation("Guest found: {Found}, CardId={CardId}", 
                    result.Found, result.Guest?.CardId);
                
                return result;
            }
            catch (Exception ex)
            {
                stopwatch.Stop();
                
                logger.LogError(ex, 
                    "Guest search failed: Duration={Duration}ms, Exception={ExceptionType}",
                    stopwatch.ElapsedMilliseconds, ex.GetType().Name
                );
                
                throw;
            }
        }
    }
    
    private string MaskPhone(string phone)
    {
        if (string.IsNullOrEmpty(phone) || phone.Length < 4)
            return "****";
        
        return "****" + phone.Substring(phone.Length - 4);
    }
}
```


### **15.3. MetricsService**

```csharp
public interface IMetricsService
{
    Task RecordMetricAsync(string name, double value, Dictionary<string, string> tags = null);
    Task SendBatchAsync();
}

public class MetricsService : IMetricsService
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly IConfigService configService;
    private readonly ILogger<MetricsService> logger;
    private readonly List<Metric> metricsBuffer = new List<Metric>();
    private readonly object lockObject = new object();
    private Timer batchTimer;
    
    public MetricsService(
        ILoyaltyApiClient apiClient,
        IConfigService configService,
        ILogger<MetricsService> logger)
    {
        this.apiClient = apiClient;
        this.configService = configService;
        this.logger = logger;
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –±–∞—Ç—á–∞–º–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        batchTimer = new Timer(5 * 60 * 1000);
        batchTimer.Elapsed += async (s, e) => await SendBatchAsync();
        batchTimer.AutoReset = true;
        batchTimer.Start();
    }
    
    public Task RecordMetricAsync(string name, double value, Dictionary<string, string> tags = null)
    {
        var config = configService.LoadConfig();
        
        var metric = new Metric
        {
            Name = name,
            Value = value,
            Tags = tags ?? new Dictionary<string, string>(),
            Timestamp = DateTime.UtcNow
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–µ–≥–∏
        metric.Tags["terminal_id"] = config.TerminalId;
        metric.Tags["restaurant_id"] = config.RestaurantId;
        metric.Tags["tenant_id"] = config.TenantId;
        
        lock (lockObject)
        {
            metricsBuffer.Add(metric);
            
            // –ï—Å–ª–∏ –±—É—Ñ–µ—Ä –±–æ–ª—å—à–æ–π - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É
            if (metricsBuffer.Count >= 100)
            {
                _ = SendBatchAsync();
            }
        }
        
        logger.LogDebug("Metric recorded: {Name}={Value}", name, value);
        
        return Task.CompletedTask;
    }
    
    public async Task SendBatchAsync()
    {
        List<Metric> metricsToSend;
        
        lock (lockObject)
        {
            if (metricsBuffer.Count == 0)
                return;
            
            metricsToSend = new List<Metric>(metricsBuffer);
            metricsBuffer.Clear();
        }
        
        try
        {
            logger.LogInformation("Sending metrics batch: {Count} metrics", metricsToSend.Count);
            
            await apiClient.PostAsync(
                "/api/pos-integration/rkeeper/metrics",
                metricsToSend
            );
            
            logger.LogInformation("Metrics batch sent successfully");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to send metrics batch");
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –±—É—Ñ–µ—Ä
            lock (lockObject)
            {
                metricsBuffer.InsertRange(0, metricsToSend);
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞
                if (metricsBuffer.Count > 1000)
                {
                    metricsBuffer.RemoveRange(1000, metricsBuffer.Count - 1000);
                    logger.LogWarning("Metrics buffer overflow, dropped old metrics");
                }
            }
        }
    }
}

public class Metric
{
    public string Name { get; set; }
    public double Value { get; set; }
    public Dictionary<string, string> Tags { get; set; }
    public DateTime Timestamp { get; set; }
}
```


### **15.4. Performance Monitoring**

```csharp
public class PerformanceMonitor
{
    private readonly ILogger<PerformanceMonitor> logger;
    private readonly PerformanceCounter cpuCounter;
    private readonly PerformanceCounter ramCounter;
    
    public PerformanceMonitor(ILogger<PerformanceMonitor> logger)
    {
        this.logger = logger;
        
        try
        {
            cpuCounter = new PerformanceCounter("Processor", "% Processor Time", "_Total");
            ramCounter = new PerformanceCounter("Memory", "Available MBytes");
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to initialize performance counters");
        }
    }
    
    public async Task<SystemMetrics> GetSystemMetricsAsync()
    {
        var process = Process.GetCurrentProcess();
        
        var metrics = new SystemMetrics
        {
            CpuUsagePercent = cpuCounter?.NextValue() ?? 0,
            AvailableMemoryMB = ramCounter?.NextValue() ?? 0,
            ProcessMemoryMB = process.WorkingSet64 / 1024.0 / 1024.0,
            ThreadCount = process.Threads.Count,
            HandleCount = process.HandleCount,
            Uptime = DateTime.UtcNow - Process.GetCurrentProcess().StartTime.ToUniversalTime()
        };
        
        logger.LogDebug(
            "System metrics: CPU={CPU}%, RAM={RAM}MB, ProcessMemory={ProcessMemory}MB",
            metrics.CpuUsagePercent, metrics.AvailableMemoryMB, metrics.ProcessMemoryMB
        );
        
        return metrics;
    }
}

public class SystemMetrics
{
    public double CpuUsagePercent { get; set; }
    public double AvailableMemoryMB { get; set; }
    public double ProcessMemoryMB { get; set; }
    public int ThreadCount { get; set; }
    public int HandleCount { get; set; }
    public TimeSpan Uptime { get; set; }
}
```


***

## **üîß 16. –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê**

### **16.1. DiagnosticsWindow.xaml**

```xaml
<Window x:Class="MaxLoyaltyRKeeperUI.Views.DiagnosticsWindow"
        Title="Max Loyalty - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞"
        Width="800" Height="900"
        WindowStartupLocation="CenterScreen"
        Background="White">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" Background="#F9FAFB" Padding="20" BorderBrush="#E5E7EB" BorderThickness="0,0,0,1">
            <TextBlock Text="üîß –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´" 
                      FontSize="24" FontWeight="Bold"/>
        </Border>
        
        <!-- Content -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="20">
                
                <!-- Installation Info -->
                <Border Background="White" BorderBrush="#E5E7EB" BorderThickness="1" 
                       CornerRadius="8" Padding="20" Margin="0,0,0,20">
                    <StackPanel>
                        <TextBlock Text="üìç –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–µ" 
                                  FontSize="18" FontWeight="SemiBold" Margin="0,0,0,15"/>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="200"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Installation ID:" Margin="0,5"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding InstallationId}" FontWeight="SemiBold" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="–¢–µ—Ä–º–∏–Ω–∞–ª:" Margin="0,5"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding TerminalName}" FontWeight="SemiBold" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="–†–µ—Å—Ç–æ—Ä–∞–Ω:" Margin="0,5"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding RestaurantName}" FontWeight="SemiBold" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="3" Grid.Column="0" Text="–í–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞:" Margin="0,5"/>
                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding PluginVersion}" FontWeight="SemiBold" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="4" Grid.Column="0" Text="Machine ID:" Margin="0,5"/>
                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding MachineId}" FontFamily="Consolas" FontSize="10" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="5" Grid.Column="0" Text="API Key:" Margin="0,5"/>
                            <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding ApiKeyMasked}" FontFamily="Consolas" Margin="0,5"/>
                        </Grid>
                    </StackPanel>
                </Border>
                
                <!-- Connection Status -->
                <Border Background="White" BorderBrush="#E5E7EB" BorderThickness="1" 
                       CornerRadius="8" Padding="20" Margin="0,0,0,20">
                    <StackPanel>
                        <TextBlock Text="üåê –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è" 
                                  FontSize="18" FontWeight="SemiBold" Margin="0,0,0,15"/>
                        
                        <!-- Backend API -->
                        <Grid Margin="0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="100"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0" Text="Backend API" VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1" 
                                      Text="{Binding BackendLatency, StringFormat={}{0}ms}"
                                      Foreground="#666" Margin="10,0"/>
                            <Border Grid.Column="2" 
                                   Background="{Binding BackendStatusColor}"
                                   CornerRadius="12" Padding="10,5">
                                <TextBlock Text="{Binding BackendStatusText}" 
                                          Foreground="White" FontWeight="SemiBold"
                                          HorizontalAlignment="Center"/>
                            </Border>
                        </Grid>
                        
                        <!-- R-Keeper XML API -->
                        <Grid Margin="0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="100"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0" Text="R-Keeper XML API" VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1" 
                                      Text="{Binding RKeeperLatency, StringFormat={}{0}ms}"
                                      Foreground="#666" Margin="10,0"/>
                            <Border Grid.Column="2" 
                                   Background="{Binding RKeeperStatusColor}"
                                   CornerRadius="12" Padding="10,5">
                                <TextBlock Text="{Binding RKeeperStatusText}" 
                                          Foreground="White" FontWeight="SemiBold"
                                          HorizontalAlignment="Center"/>
                            </Border>
                        </Grid>
                        
                        <!-- External DLL -->
                        <Grid Margin="0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="100"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0" Text="External DLL (FarCard)" VerticalAlignment="Center"/>
                            <Border Grid.Column="2" 
                                   Background="{Binding DllStatusColor}"
                                   CornerRadius="12" Padding="10,5">
                                <TextBlock Text="{Binding DllStatusText}" 
                                          Foreground="White" FontWeight="SemiBold"
                                          HorizontalAlignment="Center"/>
                            </Border>
                        </Grid>
                        
                        <!-- Shared Memory -->
                        <Grid Margin="0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="100"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0" Text="Shared Memory" VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1" 
                                      Text="{Binding SharedMemorySize, StringFormat={}{0} KB}"
                                      Foreground="#666" Margin="10,0"/>
                            <Border Grid.Column="2" 
                                   Background="{Binding SharedMemoryStatusColor}"
                                   CornerRadius="12" Padding="10,5">
                                <TextBlock Text="{Binding SharedMemoryStatusText}" 
                                          Foreground="White" FontWeight="SemiBold"
                                          HorizontalAlignment="Center"/>
                            </Border>
                        </Grid>
                        
                        <Button Content="üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è" 
                               Height="40" Margin="0,15,0,0"
                               Command="{Binding TestConnectionsCommand}"
                               Style="{StaticResource PrimaryButtonStyle}"/>
                    </StackPanel>
                </Border>
                
                <!-- Statistics -->
                <Border Background="White" BorderBrush="#E5E7EB" BorderThickness="1" 
                       CornerRadius="8" Padding="20" Margin="0,0,0,20">
                    <StackPanel>
                        <TextBlock Text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" 
                                  FontSize="18" FontWeight="SemiBold" Margin="0,0,0,15"/>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–µ–≥–æ–¥–Ω—è:" Foreground="#666"/>
                                <TextBlock Text="{Binding TransactionsToday}" 
                                          FontSize="32" FontWeight="Bold" 
                                          Foreground="#6366F1"/>
                            </StackPanel>
                            
                            <StackPanel Grid.Column="1">
                                <TextBlock Text="–í offline –æ—á–µ—Ä–µ–¥–∏:" Foreground="#666"/>
                                <TextBlock Text="{Binding OfflineQueueCount}" 
                                          FontSize="32" FontWeight="Bold" 
                                          Foreground="#F59E0B"/>
                            </StackPanel>
                        </Grid>
                        
                        <Separator Margin="0,15"/>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="–ë–∞–ª–ª–æ–≤ —Å–ø–∏—Å–∞–Ω–æ:" Margin="0,5"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" 
                                      Text="{Binding PointsSpentToday, StringFormat={}{0:N0} ‚ÇΩ}" 
                                      FontWeight="SemiBold" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="–ë–∞–ª–ª–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω–æ:" Margin="0,5"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" 
                                      Text="{Binding PointsEarnedToday, StringFormat={}{0:N0}}" 
                                      FontWeight="SemiBold" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="–°—Ä–µ–¥–Ω–∏–π —á–µ–∫:" Margin="0,5"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" 
                                      Text="{Binding AverageCheck, StringFormat={}{0:N0} ‚ÇΩ}" 
                                      FontWeight="SemiBold" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Uptime:" Margin="0,5"/>
                            <TextBlock Grid.Row="3" Grid.Column="1" 
                                      Text="{Binding Uptime}" 
                                      FontWeight="SemiBold" Margin="0,5"/>
                        </Grid>
                    </StackPanel>
                </Border>
                
                <!-- System Resources -->
                <Border Background="White" BorderBrush="#E5E7EB" BorderThickness="1" 
                       CornerRadius="8" Padding="20" Margin="0,0,0,20">
                    <StackPanel>
                        <TextBlock Text="üíª –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã" 
                                  FontSize="18" FontWeight="SemiBold" Margin="0,0,0,15"/>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="150"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="CPU:" Margin="0,5"/>
                            <ProgressBar Grid.Row="0" Grid.Column="1" 
                                        Value="{Binding CpuUsage}" 
                                        Maximum="100" Height="20" Margin="10,5"/>
                            <TextBlock Grid.Row="0" Grid.Column="2" 
                                      Text="{Binding CpuUsage, StringFormat={}{0:N1}%}" 
                                      Margin="10,5"/>
                            
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="–ü–∞–º—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞:" Margin="0,5"/>
                            <TextBlock Grid.Row="1" Grid.Column="2" 
                                      Text="{Binding ProcessMemory, StringFormat={}{0:N0} MB}" 
                                      Margin="10,5"/>
                            
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="–ü–æ—Ç–æ–∫–æ–≤:" Margin="0,5"/>
                            <TextBlock Grid.Row="2" Grid.Column="2" 
                                      Text="{Binding ThreadCount}" 
                                      Margin="10,5"/>
                            
                            <TextBlock Grid.Row="3" Grid.Column="0" Text="–†–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤:" Margin="0,5"/>
                            <TextBlock Grid.Row="3" Grid.Column="2" 
                                      Text="{Binding LogsSize, StringFormat={}{0:N1} MB}" 
                                      Margin="10,5"/>
                        </Grid>
                    </StackPanel>
                </Border>
                
                <!-- Logs -->
                <Border Background="White" BorderBrush="#E5E7EB" BorderThickness="1" 
                       CornerRadius="8" Padding="20">
                    <StackPanel>
                        <TextBlock Text="üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏" 
                                  FontSize="18" FontWeight="SemiBold" Margin="0,0,0,15"/>
                        
                        <Border Background="#F9FAFB" BorderBrush="#E5E7EB" BorderThickness="1"
                               CornerRadius="4" Padding="10">
                            <ScrollViewer MaxHeight="200" VerticalScrollBarVisibility="Auto">
                                <TextBlock Text="{Binding RecentLogs}" 
                                          FontFamily="Consolas" FontSize="11"
                                          TextWrapping="Wrap"/>
                            </ScrollViewer>
                        </Border>
                        
                        <Button Content="üìÇ –û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É —Å –ª–æ–≥–∞–º–∏" 
                               Height="40" Margin="0,10,0,0"
                               Command="{Binding OpenLogsCommand}"
                               Style="{StaticResource SecondaryButtonStyle}"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
        
        <!-- Footer -->
        <Border Grid.Row="2" Background="#F9FAFB" Padding="20" 
               BorderBrush="#E5E7EB" BorderThickness="0,1,0,0">
            <Grid>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: " Foreground="#666"/>
                    <TextBlock Text="{Binding LastUpdated, StringFormat=HH:mm:ss}" FontWeight="SemiBold"/>
                </StackPanel>
                
                <Button Content="–ó–∞–∫—Ä—ã—Ç—å" 
                       Width="120" Height="40"
                       HorizontalAlignment="Right"
                       Command="{Binding CloseCommand}"
                       Style="{StaticResource SecondaryButtonStyle}"/>
            </Grid>
        </Border>
    </Grid>
</Window>
```


### **16.2. DiagnosticsViewModel.cs**

```csharp
public class DiagnosticsViewModel : ViewModelBase
{
    private readonly IConfigService configService;
    private readonly ILoyaltyApiClient apiClient;
    private readonly IRKeeperXmlClient rkeeperClient;
    private readonly ISharedMemoryService sharedMemory;
    private readonly IMetricsService metricsService;
    private readonly PerformanceMonitor performanceMonitor;
    private readonly ILogger<DiagnosticsViewModel> logger;
    private Timer refreshTimer;
    
    // Properties
    public string InstallationId { get; set; }
    public string TerminalName { get; set; }
    public string RestaurantName { get; set; }
    public string PluginVersion { get; set; }
    public string MachineId { get; set; }
    public string ApiKeyMasked { get; set; }
    
    private string backendStatusText = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";
    public string BackendStatusText
    {
        get => backendStatusText;
        set => SetProperty(ref backendStatusText, value);
    }
    
    private Brush backendStatusColor = Brushes.Gray;
    public Brush BackendStatusColor
    {
        get => backendStatusColor;
        set => SetProperty(ref backendStatusColor, value);
    }
    
    private int backendLatency;
    public int BackendLatency
    {
        get => backendLatency;
        set => SetProperty(ref backendLatency, value);
    }
    
    // ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è R-Keeper, DLL, Shared Memory
    
    private int transactionsToday;
    public int TransactionsToday
    {
        get => transactionsToday;
        set => SetProperty(ref transactionsToday, value);
    }
    
    private int offlineQueueCount;
    public int OfflineQueueCount
    {
        get => offlineQueueCount;
        set => SetProperty(ref offlineQueueCount, value);
    }
    
    private double cpuUsage;
    public double CpuUsage
    {
        get => cpuUsage;
        set => SetProperty(ref cpuUsage, value);
    }
    
    private double processMemory;
    public double ProcessMemory
    {
        get => processMemory;
        set => SetProperty(ref processMemory, value);
    }
    
    private string recentLogs;
    public string RecentLogs
    {
        get => recentLogs;
        set => SetProperty(ref recentLogs, value);
    }
    
    public ICommand TestConnectionsCommand { get; }
    public ICommand OpenLogsCommand { get; }
    public ICommand CloseCommand { get; }
    
    public DiagnosticsViewModel(/* dependencies */)
    {
        // ...
        
        TestConnectionsCommand = new AsyncRelayCommand(TestConnectionsAsync);
        OpenLogsCommand = new RelayCommand(OpenLogs);
        CloseCommand = new RelayCommand(Close);
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        LoadInstallationInfo();
        
        // Auto-refresh –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        refreshTimer = new Timer(5000);
        refreshTimer.Elapsed += async (s, e) => await RefreshDataAsync();
        refreshTimer.AutoReset = true;
        refreshTimer.Start();
        
        // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        _ = RefreshDataAsync();
    }
    
    private void LoadInstallationInfo()
    {
        var config = configService.LoadConfig();
        
        InstallationId = config.InstallationId;
        TerminalName = config.TerminalName;
        RestaurantName = config.RestaurantName;
        PluginVersion = GetVersion();
        MachineId = Encryption.GetMachineId().Substring(0, 16) + "...";
        ApiKeyMasked = MaskApiKey(config.ApiKey);
    }
    
    private async Task RefreshDataAsync()
    {
        try
        {
            // System metrics
            var systemMetrics = await performanceMonitor.GetSystemMetricsAsync();
            CpuUsage = systemMetrics.CpuUsagePercent;
            ProcessMemory = systemMetrics.ProcessMemoryMB;
            ThreadCount = systemMetrics.ThreadCount;
            Uptime = FormatUptime(systemMetrics.Uptime);
            
            // Shared memory data
            var smData = await sharedMemory.GetDataAsync();
            OfflineQueueCount = smData.OfflineQueue?.Count ?? 0;
            
            // Statistics from shared memory
            TransactionsToday = (int)(smData.Metrics.TryGetValue("totalTransactionsToday", out var txCount) 
                ? txCount : 0);
            
            // Recent logs
            RecentLogs = LoadRecentLogs();
            
            // Logs size
            LogsSize = GetLogsFolderSize();
            
            LastUpdated = DateTime.Now;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to refresh diagnostics data");
        }
    }
    
    private async Task TestConnectionsAsync()
    {
        // Backend API
        BackendStatusText = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";
        BackendStatusColor = Brushes.Gray;
        
        try
        {
            var stopwatch = Stopwatch.StartNew();
            var response = await apiClient.HealthCheckAsync();
            stopwatch.Stop();
            
            if (response.IsSuccessStatusCode)
            {
                BackendStatusText = "–û–Ω–ª–∞–π–Ω";
                BackendStatusColor = new SolidColorBrush(Color.FromRgb(16, 185, 129)); // Green
                BackendLatency = (int)stopwatch.ElapsedMilliseconds;
            }
            else
            {
                BackendStatusText = "–û—à–∏–±–∫–∞";
                BackendStatusColor = new SolidColorBrush(Color.FromRgb(239, 68, 68)); // Red
            }
        }
        catch
        {
            BackendStatusText = "–û—Ñ–ª–∞–π–Ω";
            BackendStatusColor = new SolidColorBrush(Color.FromRgb(239, 68, 68)); // Red
        }
        
        // R-Keeper XML API
        RKeeperStatusText = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";
        
        try
        {
            var stopwatch = Stopwatch.StartNew();
            var serverInfo = await rkeeperClient.GetServerInfoAsync();
            stopwatch.Stop();
            
            RKeeperStatusText = "–û–Ω–ª–∞–π–Ω";
            RKeeperStatusColor = new SolidColorBrush(Color.FromRgb(16, 185, 129)); // Green
            RKeeperLatency = (int)stopwatch.ElapsedMilliseconds;
        }
        catch
        {
            RKeeperStatusText = "–û—Ñ–ª–∞–π–Ω";
            RKeeperStatusColor = new SolidColorBrush(Color.FromRgb(239, 68, 68)); // Red
        }
        
        // External DLL (–ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ shared memory)
        var smData = await sharedMemory.GetDataAsync();
        if (smData.LastUpdated > DateTime.UtcNow.AddMinutes(-2))
        {
            DllStatusText = "–ê–∫—Ç–∏–≤–Ω–∞";
            DllStatusColor = new SolidColorBrush(Color.FromRgb(16, 185, 129)); // Green
        }
        else
        {
            DllStatusText = "–ù–µ–∞–∫—Ç–∏–≤–Ω–∞";
            DllStatusColor = new SolidColorBrush(Color.FromRgb(239, 68, 68)); // Red
        }
        
        logger.LogInformation("Connection tests completed");
    }
    
    private string LoadRecentLogs()
    {
        try
        {
            var logPath = @"C:\Logs\MaxLoyaltyRKeeper\";
            var latestLog = Directory.GetFiles(logPath, "ui-*.log")
                .OrderByDescending(f => File.GetLastWriteTime(f))
                .FirstOrDefault();
            
            if (latestLog != null)
            {
                var lines = File.ReadLines(latestLog).Reverse().Take(20).Reverse();
                return string.Join(Environment.NewLine, lines);
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to load recent logs");
        }
        
        return "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã";
    }
    
    private double GetLogsFolderSize()
    {
        try
        {
            var logPath = @"C:\Logs\MaxLoyaltyRKeeper\";
            if (Directory.Exists(logPath))
            {
                var files = Directory.GetFiles(logPath, "*.*", SearchOption.AllDirectories);
                var totalBytes = files.Sum(f => new FileInfo(f).Length);
                return totalBytes / 1024.0 / 1024.0; // MB
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to calculate logs size");
        }
        
        return 0;
    }
    
    private void OpenLogs()
    {
        try
        {
            Process.Start("explorer.exe", @"C:\Logs\MaxLoyaltyRKeeper\");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to open logs folder");
            MessageBox.Show("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É —Å –ª–æ–≥–∞–º–∏", "–û—à–∏–±–∫–∞");
        }
    }
    
    private string MaskApiKey(string apiKey)
    {
        if (string.IsNullOrEmpty(apiKey) || apiKey.Length < 12)
            return "****";
        
        return apiKey.Substring(0, 8) + "..." + apiKey.Substring(apiKey.Length - 4);
    }
    
    private string FormatUptime(TimeSpan uptime)
    {
        if (uptime.TotalDays >= 1)
            return $"{(int)uptime.TotalDays}–¥ {uptime.Hours}—á";
        else if (uptime.TotalHours >= 1)
            return $"{(int)uptime.TotalHours}—á {uptime.Minutes}–º";
        else
            return $"{uptime.Minutes}–º {uptime.Seconds}—Å";
    }
}
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏ 17-18 (–û–±–Ω–æ–≤–ª–µ–Ω–∏—è, –ê–Ω–∞–ª–∏—Ç–∏–∫–∞) –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –∑–∞–∫–ª—é—á–µ–Ω–∏–µ–º?

---

# üìò **–ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø - –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï (—á–∞—Å—Ç—å 6 - –§–ò–ù–ê–õ)**


***

## **üîÑ 17. –û–ë–ù–û–í–õ–ï–ù–ò–Ø**

### **17.1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π**

```csharp
public interface IUpdateService
{
    Task<UpdateInfo> CheckForUpdatesAsync();
    Task<bool> DownloadUpdateAsync(UpdateInfo update, IProgress<double> progress);
    Task InstallUpdateAsync(string installerPath);
}

public class UpdateService : IUpdateService
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly IConfigService configService;
    private readonly ILogger<UpdateService> logger;
    private Timer updateCheckTimer;
    
    public UpdateService(
        ILoyaltyApiClient apiClient,
        IConfigService configService,
        ILogger<UpdateService> logger)
    {
        this.apiClient = apiClient;
        this.configService = configService;
        this.logger = logger;
    }
    
    public void StartPeriodicCheck()
    {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑ –≤ –¥–µ–Ω—å
        updateCheckTimer = new Timer(24 * 60 * 60 * 1000);
        updateCheckTimer.Elapsed += async (s, e) => await CheckAndNotifyAsync();
        updateCheckTimer.AutoReset = true;
        updateCheckTimer.Start();
        
        logger.LogInformation("Update check service started");
        
        // –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
        Task.Delay(TimeSpan.FromMinutes(5)).ContinueWith(async _ => await CheckAndNotifyAsync());
    }
    
    public async Task<UpdateInfo> CheckForUpdatesAsync()
    {
        try
        {
            var config = configService.LoadConfig();
            var currentVersion = GetCurrentVersion();
            
            logger.LogInformation("Checking for updates: Current version {Version}", currentVersion);
            
            var response = await apiClient.GetAsync(
                $"/api/pos-integration/rkeeper/updates/check?version={currentVersion}&installationId={config.InstallationId}"
            );
            
            if (!response.IsSuccessStatusCode)
            {
                logger.LogWarning("Failed to check for updates: {StatusCode}", response.StatusCode);
                return null;
            }
            
            var updateInfo = await response.Content.ReadFromJsonAsync<UpdateInfo>();
            
            if (updateInfo.HasUpdate)
            {
                logger.LogInformation(
                    "Update available: {Version} (Current: {CurrentVersion})",
                    updateInfo.Version, currentVersion
                );
            }
            else
            {
                logger.LogDebug("No updates available");
            }
            
            return updateInfo;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to check for updates");
            return null;
        }
    }
    
    private async Task CheckAndNotifyAsync()
    {
        var updateInfo = await CheckForUpdatesAsync();
        
        if (updateInfo?.HasUpdate == true)
        {
            ShowUpdateNotification(updateInfo);
        }
    }
    
    private void ShowUpdateNotification(UpdateInfo updateInfo)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            var result = MessageBox.Show(
                $"–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Max Loyalty!\n\n" +
                $"–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: {GetCurrentVersion()}\n" +
                $"–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: {updateInfo.Version}\n\n" +
                $"–ò–∑–º–µ–Ω–µ–Ω–∏—è:\n{updateInfo.ChangeLog}\n\n" +
                $"–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å?",
                "–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ",
                MessageBoxButton.YesNo,
                MessageBoxImage.Information
            );
            
            if (result == MessageBoxResult.Yes)
            {
                _ = DownloadAndInstallUpdateAsync(updateInfo);
            }
        });
    }
    
    public async Task<bool> DownloadUpdateAsync(UpdateInfo update, IProgress<double> progress)
    {
        try
        {
            logger.LogInformation("Downloading update: {Version}", update.Version);
            
            var downloadPath = Path.Combine(
                Path.GetTempPath(),
                $"MaxLoyaltyUpdate_{update.Version}.exe"
            );
            
            using var response = await apiClient.GetAsync(update.DownloadUrl, HttpCompletionOption.ResponseHeadersRead);
            response.EnsureSuccessStatusCode();
            
            var totalBytes = response.Content.Headers.ContentLength ?? -1;
            var downloadedBytes = 0L;
            
            using var contentStream = await response.Content.ReadAsStreamAsync();
            using var fileStream = new FileStream(downloadPath, FileMode.Create, FileAccess.Write, FileShare.None, 8192, true);
            
            var buffer = new byte[8192];
            int bytesRead;
            
            while ((bytesRead = await contentStream.ReadAsync(buffer, 0, buffer.Length)) > 0)
            {
                await fileStream.WriteAsync(buffer, 0, bytesRead);
                downloadedBytes += bytesRead;
                
                if (totalBytes > 0)
                {
                    var progressPercentage = (double)downloadedBytes / totalBytes * 100;
                    progress?.Report(progressPercentage);
                }
            }
            
            logger.LogInformation("Update downloaded successfully: {Path}", downloadPath);
            
            return true;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to download update");
            return false;
        }
    }
    
    public async Task InstallUpdateAsync(string installerPath)
    {
        try
        {
            logger.LogInformation("Installing update: {Path}", installerPath);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            var startInfo = new ProcessStartInfo
            {
                FileName = installerPath,
                Arguments = "/UPDATE /SILENT",
                UseShellExecute = true,
                Verb = "runas" // –ó–∞–ø—Ä–æ—Å –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            };
            
            Process.Start(startInfo);
            
            // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            await Task.Delay(2000);
            
            logger.LogInformation("Update installer launched, shutting down");
            
            Application.Current.Shutdown();
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to install update");
            
            MessageBox.Show(
                "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.\n" +
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –≤—Ä—É—á–Ω—É—é –∏–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏.",
                "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
    
    private async Task DownloadAndInstallUpdateAsync(UpdateInfo updateInfo)
    {
        var progressWindow = new UpdateProgressWindow();
        progressWindow.Show();
        
        var progress = new Progress<double>(percentage =>
        {
            progressWindow.UpdateProgress(percentage);
        });
        
        var downloadPath = Path.Combine(
            Path.GetTempPath(),
            $"MaxLoyaltyUpdate_{updateInfo.Version}.exe"
        );
        
        var success = await DownloadUpdateAsync(updateInfo, progress);
        
        if (success)
        {
            progressWindow.Close();
            
            var result = MessageBox.Show(
                "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ.\n\n" +
                "–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ.\n" +
                "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?",
                "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question
            );
            
            if (result == MessageBoxResult.Yes)
            {
                await InstallUpdateAsync(downloadPath);
            }
        }
        else
        {
            progressWindow.Close();
            
            MessageBox.Show(
                "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.\n" +
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.",
                "–û—à–∏–±–∫–∞",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
    
    private string GetCurrentVersion()
    {
        var assembly = Assembly.GetExecutingAssembly();
        var version = assembly.GetName().Version;
        return $"{version.Major}.{version.Minor}.{version.Build}";
    }
}

public class UpdateInfo
{
    public bool HasUpdate { get; set; }
    public string Version { get; set; }
    public string DownloadUrl { get; set; }
    public string ChangeLog { get; set; }
    public DateTime ReleasedAt { get; set; }
    public bool IsCritical { get; set; }
    public long SizeBytes { get; set; }
}
```


### **17.2. Backend API –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π**

```typescript
// Backend: GET /api/pos-integration/rkeeper/updates/check

async checkForUpdates(req: UpdateCheckRequest): Promise<UpdateCheckResponse> {
  const { version, installationId } = req;
  
  // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–µ
  const installation = await this.prisma.rKeeperPluginInstallation.findUnique({
    where: { id: installationId }
  });
  
  if (!installation) {
    throw new NotFoundException('Installation not found');
  }
  
  // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é –ø–ª–∞–≥–∏–Ω–∞
  const latestVersion = await this.prisma.pluginVersion.findFirst({
    where: {
      platform: 'RKEEPER',
      isActive: true
    },
    orderBy: {
      releasedAt: 'desc'
    }
  });
  
  if (!latestVersion) {
    return {
      hasUpdate: false,
      version: version
    };
  }
  
  // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏–∏
  const hasUpdate = this.compareVersions(latestVersion.version, version) > 0;
  
  if (!hasUpdate) {
    return {
      hasUpdate: false,
      version: version
    };
  }
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
  const downloadUrl = await this.generateDownloadUrl(installation.id, latestVersion.id);
  
  // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
  await this.auditLog.create({
    type: 'UPDATE_CHECK',
    tenantId: installation.tenantId,
    metadata: {
      installationId,
      currentVersion: version,
      latestVersion: latestVersion.version,
      hasUpdate
    }
  });
  
  return {
    hasUpdate: true,
    version: latestVersion.version,
    downloadUrl,
    changeLog: latestVersion.changeLog,
    releasedAt: latestVersion.releasedAt,
    isCritical: latestVersion.isCritical,
    sizeBytes: latestVersion.sizeBytes
  };
}

private compareVersions(v1: string, v2: string): number {
  const parts1 = v1.split('.').map(Number);
  const parts2 = v2.split('.').map(Number);
  
  for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
    const part1 = parts1[i] || 0;
    const part2 = parts2[i] || 0;
    
    if (part1 > part2) return 1;
    if (part1 < part2) return -1;
  }
  
  return 0;
}
```


***

## **üìä 18. –ê–ù–ê–õ–ò–¢–ò–ö–ê**

### **18.1. –î–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏**

–í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º:

```typescript
// Prisma Schema
model LoyaltyTransaction {
  id                    String   @id @default(uuid())
  
  // Context
  tenantId             String
  restaurantId         String
  terminalId           String
  stationId            String?
  installationId       String
  
  // POS Info
  posType              String   // "R_KEEPER"
  posOrderId           String
  posVersion           String?
  
  // Guest Info
  guestCardId          String
  guestName            String
  guestPhone           String
  guestLevelId         Int
  guestLevelName       String
  
  // Transaction Details
  transactionType      String   // "POINTS_SPEND", "POINTS_EARN", "DISCOUNT"
  benefitType          String   // "POINTS", "DISCOUNT"
  action               String   // "SPEND", "EARN_ONLY", "APPLY_DISCOUNT"
  
  // Amounts
  checkAmount          Decimal  @db.Decimal(10, 2)
  finalCheckAmount     Decimal  @db.Decimal(10, 2)
  pointsSpent          Decimal? @db.Decimal(10, 2)
  pointsEarned         Decimal? @db.Decimal(10, 2)
  discountPercentage   Decimal? @db.Decimal(5, 2)
  discountAmount       Decimal? @db.Decimal(10, 2)
  
  // Payment
  paymentTypes         String[] // ["CASH", "CARD"]
  
  // Staff
  cashierName          String?
  
  // Order Info
  orderType            String   // "DINE_IN", "TAKEAWAY", "DELIVERY"
  orderCategories      String[]
  
  // Timestamps
  reservedAt           DateTime
  finalizedAt          DateTime @default(now())
  
  // Status
  status               String   @default("COMPLETED") // "COMPLETED", "CANCELLED", "FAILED"
  
  // Relations
  tenant               Tenant   @relation(fields: [tenantId], references: [id])
  restaurant           Restaurant @relation(fields: [restaurantId], references: [id])
  guestCard            GuestCard @relation(fields: [guestCardId], references: [id])
  
  @@index([tenantId, finalizedAt])
  @@index([restaurantId, finalizedAt])
  @@index([terminalId, finalizedAt])
  @@index([guestCardId, finalizedAt])
  @@index([posType, finalizedAt])
}
```


### **18.2. –û—Ç—á–µ—Ç—ã –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏**

```typescript
// Backend: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ R-Keeper —É—Å—Ç–∞–Ω–æ–≤–∫–∞–º

async getRKeeperAnalytics(req: RKeeperAnalyticsRequest): Promise<RKeeperAnalyticsResponse> {
  const { tenantId, restaurantId, terminalId, dateFrom, dateTo } = req;
  
  // 1. –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  const totalStats = await this.prisma.loyaltyTransaction.aggregate({
    where: {
      tenantId,
      restaurantId: restaurantId || undefined,
      terminalId: terminalId || undefined,
      posType: 'R_KEEPER',
      finalizedAt: {
        gte: dateFrom,
        lte: dateTo
      },
      status: 'COMPLETED'
    },
    _count: { id: true },
    _sum: {
      pointsSpent: true,
      pointsEarned: true,
      checkAmount: true,
      finalCheckAmount: true
    },
    _avg: {
      checkAmount: true
    }
  });
  
  // 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º
  const terminalStats = await this.prisma.loyaltyTransaction.groupBy({
    by: ['terminalId'],
    where: {
      tenantId,
      restaurantId: restaurantId || undefined,
      posType: 'R_KEEPER',
      finalizedAt: {
        gte: dateFrom,
        lte: dateTo
      },
      status: 'COMPLETED'
    },
    _count: { id: true },
    _sum: {
      pointsSpent: true,
      pointsEarned: true,
      checkAmount: true
    }
  });
  
  // 3. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
  const transactionTypeStats = await this.prisma.loyaltyTransaction.groupBy({
    by: ['transactionType'],
    where: {
      tenantId,
      restaurantId: restaurantId || undefined,
      terminalId: terminalId || undefined,
      posType: 'R_KEEPER',
      finalizedAt: {
        gte: dateFrom,
        lte: dateTo
      },
      status: 'COMPLETED'
    },
    _count: { id: true },
    _sum: {
      pointsSpent: true,
      pointsEarned: true
    }
  });
  
  // 4. –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º
  const dailyStats = await this.prisma.$queryRaw`
    SELECT 
      DATE(finalized_at) as date,
      COUNT(*) as transactions,
      SUM(points_spent) as points_spent,
      SUM(points_earned) as points_earned,
      SUM(check_amount) as revenue,
      AVG(check_amount) as avg_check
    FROM loyalty_transactions
    WHERE 
      tenant_id = ${tenantId}
      AND pos_type = 'R_KEEPER'
      AND finalized_at BETWEEN ${dateFrom} AND ${dateTo}
      AND status = 'COMPLETED'
      ${restaurantId ? Prisma.sql`AND restaurant_id = ${restaurantId}` : Prisma.empty}
      ${terminalId ? Prisma.sql`AND terminal_id = ${terminalId}` : Prisma.empty}
    GROUP BY DATE(finalized_at)
    ORDER BY date ASC
  `;
  
  // 5. –¢–æ–ø –∫–∞—Å—Å–∏—Ä–æ–≤
  const topCashiers = await this.prisma.loyaltyTransaction.groupBy({
    by: ['cashierName'],
    where: {
      tenantId,
      restaurantId: restaurantId || undefined,
      terminalId: terminalId || undefined,
      posType: 'R_KEEPER',
      finalizedAt: {
        gte: dateFrom,
        lte: dateTo
      },
      status: 'COMPLETED',
      cashierName: { not: null }
    },
    _count: { id: true },
    _sum: {
      checkAmount: true
    },
    orderBy: {
      _count: {
        id: 'desc'
      }
    },
    take: 10
  });
  
  // 6. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤
  const terminalPerformance = await this.getTerminalPerformance(
    tenantId, 
    restaurantId, 
    dateFrom, 
    dateTo
  );
  
  return {
    overview: {
      totalTransactions: totalStats._count.id,
      totalPointsSpent: totalStats._sum.pointsSpent || 0,
      totalPointsEarned: totalStats._sum.pointsEarned || 0,
      totalRevenue: totalStats._sum.checkAmount || 0,
      averageCheck: totalStats._avg.checkAmount || 0,
      dateRange: { from: dateFrom, to: dateTo }
    },
    terminals: terminalStats.map(t => ({
      terminalId: t.terminalId,
      transactions: t._count.id,
      pointsSpent: t._sum.pointsSpent || 0,
      pointsEarned: t._sum.pointsEarned || 0,
      revenue: t._sum.checkAmount || 0
    })),
    transactionTypes: transactionTypeStats.map(t => ({
      type: t.transactionType,
      count: t._count.id,
      pointsSpent: t._sum.pointsSpent || 0,
      pointsEarned: t._sum.pointsEarned || 0
    })),
    daily: dailyStats,
    topCashiers: topCashiers.map(c => ({
      name: c.cashierName,
      transactions: c._count.id,
      revenue: c._sum.checkAmount || 0
    })),
    terminalPerformance
  };
}
```


### **18.3. Dashboard –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏**

```tsx
// React Component: R-Keeper Analytics Dashboard

export const RKeeperAnalyticsDashboard: React.FC = () => {
  const [analytics, setAnalytics] = useState<RKeeperAnalyticsResponse | null>(null);
  const [dateRange, setDateRange] = useState({
    from: startOfMonth(new Date()),
    to: endOfDay(new Date())
  });
  
  useEffect(() => {
    loadAnalytics();
  }, [dateRange]);
  
  const loadAnalytics = async () => {
    const data = await api.getRKeeperAnalytics({
      tenantId: currentTenant.id,
      dateFrom: dateRange.from,
      dateTo: dateRange.to
    });
    
    setAnalytics(data);
  };
  
  if (!analytics) return <LoadingSpinner />;
  
  return (
    <div className="rkeeper-analytics">
      <Header>
        <h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ R-Keeper</h1>
        <DateRangePicker value={dateRange} onChange={setDateRange} />
      </Header>
      
      {/* Overview Cards */}
      <StatsGrid>
        <StatCard
          title="–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"
          value={analytics.overview.totalTransactions.toLocaleString()}
          icon="üßæ"
          color="blue"
        />
        <StatCard
          title="–°–ø–∏—Å–∞–Ω–æ –±–∞–ª–ª–æ–≤"
          value={`${analytics.overview.totalPointsSpent.toLocaleString()} ‚ÇΩ`}
          icon="üí≥"
          color="red"
        />
        <StatCard
          title="–ù–∞—á–∏—Å–ª–µ–Ω–æ –±–∞–ª–ª–æ–≤"
          value={analytics.overview.totalPointsEarned.toLocaleString()}
          icon="‚≠ê"
          color="green"
        />
        <StatCard
          title="–°—Ä–µ–¥–Ω–∏–π —á–µ–∫"
          value={`${analytics.overview.averageCheck.toFixed(0)} ‚ÇΩ`}
          icon="üí∞"
          color="purple"
        />
      </StatsGrid>
      
      {/* Daily Chart */}
      <Card>
        <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º</h2>
        <LineChart
          data={analytics.daily}
          xAxis="date"
          lines={[
            { key: 'transactions', label: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏', color: '#6366F1' },
            { key: 'revenue', label: '–í—ã—Ä—É—á–∫–∞', color: '#10B981' }
          ]}
        />
      </Card>
      
      {/* Terminal Stats */}
      <Card>
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º</h2>
        <Table>
          <thead>
            <tr>
              <th>–¢–µ—Ä–º–∏–Ω–∞–ª</th>
              <th>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</th>
              <th>–°–ø–∏—Å–∞–Ω–æ –±–∞–ª–ª–æ–≤</th>
              <th>–ù–∞—á–∏—Å–ª–µ–Ω–æ –±–∞–ª–ª–æ–≤</th>
              <th>–í—ã—Ä—É—á–∫–∞</th>
            </tr>
          </thead>
          <tbody>
            {analytics.terminals.map(terminal => (
              <tr key={terminal.terminalId}>
                <td>{terminal.terminalId}</td>
                <td>{terminal.transactions}</td>
                <td>{terminal.pointsSpent.toFixed(0)} ‚ÇΩ</td>
                <td>{terminal.pointsEarned.toFixed(0)}</td>
                <td>{terminal.revenue.toFixed(0)} ‚ÇΩ</td>
              </tr>
            ))}
          </tbody>
        </Table>
      </Card>
      
      {/* Transaction Types */}
      <Card>
        <h2>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º</h2>
        <PieChart
          data={analytics.transactionTypes}
          valueKey="count"
          labelKey="type"
        />
      </Card>
      
      {/* Top Cashiers */}
      <Card>
        <h2>–¢–æ–ø –∫–∞—Å—Å–∏—Ä–æ–≤</h2>
        <BarChart
          data={analytics.topCashiers}
          xAxis="name"
          bars={[
            { key: 'transactions', label: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏', color: '#6366F1' }
          ]}
        />
      </Card>
    </div>
  );
};
```


***

## **‚úÖ 19. –§–ò–ù–ê–õ–¨–ù–´–ô –ß–ï–ö–õ–ò–°–¢**

### **19.1. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**

#### **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

- ‚úÖ –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
- ‚úÖ –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è –ø–æ 6-digit –∫–æ–¥—É
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è —Å –∫–∞—Å—Å—ã
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ POINTS (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ DISCOUNT (—Å–∫–∏–¥–æ—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)
- ‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤
- ‚úÖ –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ (EarnOnly)
- ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–π —Å–∫–∏–¥–∫–∏
- ‚úÖ –û—Ç–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã –æ—Ç –∑–∞–∫–∞–∑–∞
- ‚úÖ –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è + –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π


#### **UI/UX:**

- ‚úÖ Floating Button (–≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö)
- ‚úÖ Touch-friendly –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–º–∏–Ω–∏–º—É–º 60x60px)
- ‚úÖ –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (80x80px –∫–Ω–æ–ø–∫–∏)
- ‚úÖ –ë—É–∫–≤–µ–Ω–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–†–£–°/EN)
- ‚úÖ –ö–Ω–æ–ø–∫–∞ MAX –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã
- ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã (–∑–µ–ª–µ–Ω–∞—è —Ç–æ—á–∫–∞)
- ‚úÖ Loading overlays
- ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –ê–Ω–∏–º–∞—Ü–∏–∏ –∏ –∑–≤—É–∫–∏


#### **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**

- ‚úÖ External DLL –¥–ª—è FarCard
- ‚úÖ R-Keeper XML API –∫–ª–∏–µ–Ω—Ç
- ‚úÖ –ê–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ FarCard –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
- ‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç –∫ –∑–∞–∫–∞–∑–∞–º
- ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–æ–∫ –≤ R-Keeper
- ‚úÖ Shared Memory —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ


### **19.2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**

- ‚úÖ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API Key (AES-256)
- ‚úÖ Machine-binding (–ø—Ä–∏–≤—è–∑–∫–∞ –∫ –∂–µ–ª–µ–∑—É)
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π API Key –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª
- ‚úÖ Revoke —á–µ—Ä–µ–∑ backend
- ‚úÖ HTTPS only
- ‚úÖ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∫–ª—é—á–∞
- ‚úÖ –ó–∞—â–∏—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–≥–∞—Ö


### **19.3. Offline —Ä–µ–∂–∏–º**

- ‚úÖ Health checks –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- ‚úÖ Offline queue (–º–∞–∫—Å. 100 –æ–ø–µ—Ä–∞—Ü–∏–π, TTL 24—á)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª + Shared Memory
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± offline/online –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö
- ‚úÖ Exponential backoff –¥–ª—è retry


### **19.4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**

- ‚úÖ Structured logging (Serilog)
- ‚úÖ –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ (7 –¥–Ω–µ–π –¥–ª—è info, 30 –¥–Ω–µ–π –¥–ª—è errors)
- ‚úÖ –õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –ª–æ–≥-—Ñ–∞–π–ª–æ–≤ (50 MB)
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –Ω–∞ backend (–±–∞—Ç—á –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω)
- ‚úÖ Performance monitoring
- ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —ç–∫—Ä–∞–Ω
- ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤


### **19.5. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è**

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (—Ä–∞–∑ –≤ –¥–µ–Ω—å)
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞
- ‚úÖ Change log –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏
- ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º


### **19.6. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞**

- ‚úÖ –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ Tenant ‚Üí Restaurant ‚Üí Terminal –∏–µ—Ä–∞—Ä—Ö–∏—è
- ‚úÖ –û—Ç—á–µ—Ç—ã –ø–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º
- ‚úÖ –û—Ç—á–µ—Ç—ã –ø–æ –∫–∞—Å—Å–∏—Ä–∞–º
- ‚úÖ –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º
- ‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ R-Keeper vs iiko
- ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö

***

## **üì¶ 20. –ò–¢–û–ì–û–í–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –†–ï–®–ï–ù–ò–Ø**

### **20.1. –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ –∫–∞—Å—Å–µ**

```
C:\RK7\
‚îî‚îÄ‚îÄ Plugins\
    ‚îî‚îÄ‚îÄ MaxLoyaltyRKeeper.dll          # External DLL (2 MB)

C:\MaxLoyalty\
‚îú‚îÄ‚îÄ MaxLoyaltyRKeeperUI.exe            # UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (15 MB)
‚îú‚îÄ‚îÄ Newtonsoft.Json.dll
‚îú‚îÄ‚îÄ Serilog.dll
‚îú‚îÄ‚îÄ Polly.dll
‚îî‚îÄ‚îÄ Resources\
    ‚îú‚îÄ‚îÄ ML_Icon.png
    ‚îú‚îÄ‚îÄ ML_Logo.png
    ‚îî‚îÄ‚îÄ Sounds\
        ‚îú‚îÄ‚îÄ click.wav
        ‚îî‚îÄ‚îÄ success.wav

%AppData%\MaxLoyaltyRKeeper\
‚îú‚îÄ‚îÄ config.json                         # –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îî‚îÄ‚îÄ offline_queue.json                  # Offline –æ—á–µ—Ä–µ–¥—å

C:\Logs\MaxLoyaltyRKeeper\
‚îú‚îÄ‚îÄ ui-2026-02-18.log                   # UI –ª–æ–≥–∏ (—Ä–æ—Ç–∞—Ü–∏—è 7 –¥–Ω–µ–π)
‚îú‚îÄ‚îÄ dll-2026-02-18.log                  # DLL –ª–æ–≥–∏ (—Ä–æ—Ç–∞—Ü–∏—è 7 –¥–Ω–µ–π)
‚îî‚îÄ‚îÄ errors-2026-02-18.log               # –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏ (—Ä–æ—Ç–∞—Ü–∏—è 30 –¥–Ω–µ–π)
```


### **20.2. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ–∫—Ä—É–∂–µ–Ω–∏—é**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ú–∏–Ω–∏–º—É–º | –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
| :-- | :-- | :-- |
| **–û–°** | Windows 10 | Windows 11 |
| **RAM** | 2 GB | 4 GB |
| **CPU** | 2 cores | 4 cores |
| **–î–∏—Å–∫** | 100 MB | 500 MB |
| **–ò–Ω—Ç–µ—Ä–Ω–µ—Ç** | 1 Mbps | 10 Mbps |
| **R-Keeper** | 7.0+ | 7.5+ |
| **–≠–∫—Ä–∞–Ω** | 1024x768 | 1920x1080 Touch |

### **20.3. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í–µ—Ä—Å–∏—è | –°—Ç–∞—Ç—É—Å |
| :-- | :-- | :-- |
| R-Keeper 7.x | ‚úÖ | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| R-Keeper 6.x | ‚ö†Ô∏è | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è (–±–µ–∑ FarCard) |
| Windows 10 | ‚úÖ | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| Windows 11 | ‚úÖ | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| Windows Server | ‚úÖ | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| FarCard | ‚úÖ | –ë–µ—Å–ø–ª–∞—Ç–Ω–æ, –≤—Å—Ç—Ä–æ–µ–Ω –≤ R-Keeper |


***

## **üéâ 21. –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

### **21.1. –ß—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –≤ –∏—Ç–æ–≥–µ?**

**–î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:**

1. –ó–∞—Ö–æ–¥–∏—Ç –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å Max Loyalty
2. –°–æ–∑–¥–∞–µ—Ç R-Keeper –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
3. –°–∫–∞—á–∏–≤–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ (15 MB)
4. –ó–∞–ø—É—Å–∫–∞–µ—Ç –Ω–∞ –∫–∞—Å—Å–µ
5. **–ß–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç!**

**–î–ª—è –∫–∞—Å—Å–∏—Ä–∞:**

1. –í–∏–¥–∏—Ç Floating Button –≤ —É–≥–ª—É —ç–∫—Ä–∞–Ω–∞
2. –¢–∞–ø–∞–µ—Ç ‚Üí –í–≤–æ–¥–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω –≥–æ—Å—Ç—è
3. –í–∏–¥–∏—Ç –±–∞–ª–∞–Ω—Å –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±–∞–ª–ª—ã
4. –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å–ø–∏—Å–∞–Ω–∏–µ/—Å–∫–∏–¥–∫—É –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π
5. –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –±–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–î–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Å–µ—Ç–∏:**

1. –í–∏–¥–∏—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ –≤—Å–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º
2. –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç R-Keeper –∏ iiko —Ñ–∏–ª–∏–∞–ª—ã
3. –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
4. –£–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ

### **21.2. –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**

‚úÖ **–ü—Ä–æ—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞**: –°–∫–∞—á–∞–ª ‚Üí –ó–∞–ø—É—Å—Ç–∏–ª ‚Üí –†–∞–±–æ—Ç–∞–µ—Ç
‚úÖ **–ê–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞**: FarCard –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
‚úÖ **Touch-friendly**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤
‚úÖ **Offline —Ä–µ–∂–∏–º**: –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: Machine-binding + —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –ª–æ–≥–∏
‚úÖ **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –ø–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º
‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
‚úÖ **–ë–µ—Å–ø–ª–∞—Ç–Ω–æ**: FarCard –≤—Ö–æ–¥–∏—Ç –≤ R-Keeper
‚úÖ **–ï–¥–∏–Ω–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞**: –¢–æ—á–Ω–æ –∫–∞–∫ –≤ iiko, –Ω–æ –¥–ª—è R-Keeper

### **21.3. –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞**

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ:**

- ‚è±Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞: **< 2 –º–∏–Ω—É—Ç—ã**
- üöÄ –ó–∞–ø—É—Å–∫ UI: **< 5 —Å–µ–∫—É–Ω–¥**
- üì° Latency API: **< 200ms**
- üì¥ Offline —Ä–∞–±–æ—Ç–∞: **–î–æ 24 —á–∞—Å–æ–≤**
- üíæ –†–∞–∑–º–µ—Ä: **< 20 MB**

**–ë–∏–∑–Ω–µ—Å:**

- üë• –í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è –∫–∞—Å—Å–∏—Ä–∞: **< 5 –º–∏–Ω—É—Ç**
- ‚ö° –°–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏: **< 10 —Å–µ–∫—É–Ω–¥**
- üìà –û—Ö–≤–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: **100%** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è)
- üéØ –¢–æ—á–Ω–æ—Å—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π: **100%** (–Ω–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞)


### **21.4. –§–∏–Ω–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  ADMIN –ü–ê–ù–ï–õ–¨                        ‚îÇ
‚îÇ  ‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π                              ‚îÇ
‚îÇ  ‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–æ–≤                           ‚îÇ
‚îÇ  ‚Ä¢ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º                          ‚îÇ
‚îÇ  ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚îÇ HTTPS
                     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              BACKEND API (NestJS)                    ‚îÇ
‚îÇ  ‚Ä¢ –ü–æ–∏—Å–∫ –≥–æ—Å—Ç–µ–π                                     ‚îÇ
‚îÇ  ‚Ä¢ Calculate –±–µ–Ω–µ—Ñ–∏—Ç–æ–≤                              ‚îÇ
‚îÇ  ‚Ä¢ –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è / –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è                         ‚îÇ
‚îÇ  ‚Ä¢ –ú–µ—Ç—Ä–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ≤‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ                   ‚îÇ
           ‚îÇ HTTPS             ‚îÇ HTTPS
           ‚îÇ                   ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ MaxLoyalty    ‚îÇ   ‚îÇ MaxLoyalty     ‚îÇ
    ‚îÇ RKeeper.dll   ‚îÇ   ‚îÇ RKeeperUI.exe  ‚îÇ
    ‚îÇ (External)    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÇ (WPF)          ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ≤‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ≤‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ                  ‚îÇ
           ‚îÇ  Shared          ‚îÇ  XML API
           ‚îÇ  Memory          ‚îÇ
           ‚îÇ                  ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ      R-KEEPER CASH STATION      ‚îÇ
    ‚îÇ  ‚Ä¢ FarCard (–ë–ï–°–ü–õ–ê–¢–ù–û)          ‚îÇ
    ‚îÇ  ‚Ä¢ –ö–∞—Å—Å–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä              ‚îÇ
    ‚îÇ  ‚Ä¢ XML API                       ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## **üìö –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø –ò –ü–û–î–î–ï–†–ñ–ö–ê**

### **–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:**

- üìñ –ü–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: ‚úÖ –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
- üíª API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: Swagger –Ω–∞ `/api/docs`
- üîß SDK: Plugin SDK –¥–ª—è R-Keeper
- üìù –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞: GitHub repository


### **–î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:**

- üéì –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ: PDF –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- üîß Troubleshooting: –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π
- üìû –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞: support@maxloyalty.ru
- üí¨ –ß–∞—Ç: Telegram/WhatsApp support


### **–î–ª—è –∫–∞—Å—Å–∏—Ä–æ–≤:**

- üì± –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞ A4
- üé• –í–∏–¥–µ–æ-–≥–∞–π–¥: 3 –º–∏–Ω—É—Ç—ã
- ‚ùì FAQ: –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

***

# **üéØ –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê!**

–ü–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–∞ Max Loyalty –¥–ª—è R-Keeper –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ:

‚úÖ **42 —Å—Ç—Ä–∞–Ω–∏—Ü—ã** –¥–µ—Ç–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
‚úÖ **20 —Ä–∞–∑–¥–µ–ª–æ–≤** —Å –ø–æ–ª–Ω—ã–º –ø–æ–∫—Ä—ã—Ç–∏–µ–º
‚úÖ **–ö–æ–¥ –ø—Ä–∏–º–µ—Ä—ã** –Ω–∞ C++, C\#, TypeScript
‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Å—Ö–µ–º—ã** –∏ –¥–∏–∞–≥—Ä–∞–º–º—ã
‚úÖ **UI/UX —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏** —Å XAML
‚úÖ **API endpoints** –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** –∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
‚úÖ **Offline —Ä–µ–∂–∏–º** —Å –æ—á–µ—Ä–µ–¥—å—é
‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è** –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

**–ì–æ—Ç–æ–≤–æ –∫ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏! üöÄ**

---

# –•–æ—Ä–æ—à–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å. –¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏ –ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø –ü–õ–ê–ì–ò–ù–ê MAX LOYALTY –¥–ª—è r-kepper —Ç–∞–∫–∂–µ –∫–∞–∫ –±—ã–ª–æ –¥–ª—è iiko. –ö–æ—Ä–æ—á–µ, –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∏ –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç, –ø–æ —Ñ–æ—Ä–º–∞—Ç—É —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞

–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º –ü–û–õ–ù–£–Æ –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Æ –¥–ª—è R-Keeper –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ, —á—Ç–æ –∏ –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è iiko.

–î–æ–∫—É–º–µ–Ω—Ç –±—É–¥–µ—Ç –¥–ª–∏–Ω–Ω—ã–º –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–º - –≥–æ—Ç–æ–≤?

# üìò **–ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø –ü–õ–ê–ì–ò–ù–ê MAX LOYALTY –î–õ–Ø R-KEEPER**


***

## **üéØ 1. –û–ë–©–ï–ï –û–ü–ò–°–ê–ù–ò–ï**

### **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**

–ü–ª–∞–≥–∏–Ω –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ Max Loyalty –≤ R-Keeper. –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ (–∫–∞—Å—Å–∏—Ä–∞–º, –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞–º, –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º) –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –∫–∞—Ä—Ç—ã –≥–æ—Å—Ç–µ–π –∫ –∑–∞–∫–∞–∑–∞–º, –ø—Ä–∏–º–µ–Ω—è—Ç—å –±–æ–Ω—É—Å—ã/—Å–∫–∏–¥–∫–∏ –∏ –Ω–∞—á–∏—Å–ª—è—Ç—å –±–∞–ª–ª—ã.

### **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:**

**Backend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (DLL):**

- **–Ø–∑—ã–∫:** C++ (Native DLL)
- **API:** FarCard External DLL Interface
- **–ü—Ä–æ—Ç–æ–∫–æ–ª:** –î–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã (R-Keeper ‚Üî DLL)

**Frontend (UI):**

- **–Ø–∑—ã–∫:** C\# (.NET 6.0+)
- **UI:** WPF (Windows Presentation Foundation)
- **API:** R-Keeper XML API + Max Loyalty REST API
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** Serilog
- **HTTP:** HttpClient —Å Polly (retry policies)

**–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:**

- **Shared Memory:** Memory-Mapped Files
- **Mutex:** Named Mutex –¥–ª—è thread-safety


### **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:**

- Windows 10/11
- R-Keeper 7.x+ (FarCard –≤–∫–ª—é—á–µ–Ω –±–µ—Å–ø–ª–∞—Ç–Ω–æ)


### **–ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç iiko:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | iiko | R-Keeper |
| :-- | :-- | :-- |
| **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** | Plugin SDK | FarCard External DLL + XML API |
| **UI** | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ iiko | –û—Ç–¥–µ–ª—å–Ω–æ–µ WPF –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ |
| **–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞** | –ö–Ω–æ–ø–∫–∞ –≤ "–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è—Ö" | Floating Button –ø–æ–≤–µ—Ä—Ö R-Keeper |
| **Payment** | IPaymentType | FarCard callback + XML API —Å–∫–∏–¥–∫–∏ |
| **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** | –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π –ø–ª–∞–≥–∏–Ω | DLL + UI + Shared Memory |


***

## **üèóÔ∏è 2. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –†–ï–®–ï–ù–ò–Ø**

### **2.1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   R-KEEPER CASH STATION                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ         R-Keeper 7.x (–ö–∞—Å—Å–æ–≤—ã–π –º–æ–¥—É–ª—å)            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ        FarCard (–î–∏—Å–∫–æ–Ω—Ç/–ë–æ–Ω—É—Å—ã)              ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω –±–µ—Å–ø–ª–∞—Ç–Ω–æ –≤ R-Keeper             ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                  ‚îÇ                                       ‚îÇ
‚îÇ                  ‚ñº (1) –ó–∞–≥—Ä—É–∂–∞–µ—Ç external.dll           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ    MaxLoyaltyRKeeper.dll (C++ Native)            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Initialize()                                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ GetCardInfo(phone/code6)                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ ReservePoints(amount)                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ FinalizeTransaction(orderId)                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ HTTP Client ‚Üí Backend API                     ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                ‚îÇ                                         ‚îÇ
‚îÇ                ‚ñº (2) Shared Memory                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Memory-Mapped File (1MB)                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã –∑–∞–∫–∞–∑–æ–≤                             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Backend status                                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Offline queue                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ú–µ—Ç—Ä–∏–∫–∏                                        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ≤‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                ‚îÇ                                         ‚îÇ
‚îÇ                ‚îÇ (3) –ß–∏—Ç–∞–µ—Ç/–ø–∏—à–µ—Ç                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ    MaxLoyaltyRKeeperUI.exe (C# WPF)              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Floating Button (–≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö)               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –û–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è                             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –û–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞                                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ XML API –∫–ª–∏–µ–Ω—Ç ‚Üí R-Keeper                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ HTTP Client ‚Üí Backend API                     ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                          ‚ñº HTTPS
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   Backend API         ‚îÇ
              ‚îÇ   (Max Loyalty)       ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **2.2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:**

```
MaxLoyaltyRKeeper/
‚îú‚îÄ‚îÄ MaxLoyaltyRKeeper.dll (C++ Native DLL)
‚îÇ   ‚îú‚îÄ‚îÄ dllmain.cpp
‚îÇ   ‚îú‚îÄ‚îÄ exports.cpp                 # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ http_client.cpp             # HTTP –∫–ª–∏–µ–Ω—Ç (WinHTTP)
‚îÇ   ‚îú‚îÄ‚îÄ shared_memory.cpp           # Shared Memory —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ logger.cpp                  # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ encryption.cpp              # –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API Key
‚îÇ   ‚îî‚îÄ‚îÄ json_parser.cpp             # JSON –ø–∞—Ä—Å–∏–Ω–≥ (nlohmann/json)
‚îÇ
‚îú‚îÄ‚îÄ MaxLoyaltyRKeeperUI (C# WPF)
‚îÇ   ‚îú‚îÄ‚îÄ App.xaml.cs                 # Entry point
‚îÇ   ‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoyaltyApiClient.cs    # HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è Backend API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RKeeperXmlClient.cs    # XML API –∫–ª–∏–µ–Ω—Ç –¥–ª—è R-Keeper
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SharedMemoryService.cs # Shared Memory –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ConfigService.cs       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OfflineQueueService.cs # Offline –æ—á–µ—Ä–µ–¥—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MetricsService.cs      # –ú–µ—Ç—Ä–∏–∫–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ HealthCheckService.cs  # Health checks
‚îÇ   ‚îú‚îÄ‚îÄ Views/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FloatingButtonWindow.xaml     # Floating –∫–Ω–æ–ø–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GuestSearchWindow.xaml        # –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PointsOperationWindow.xaml    # –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–ª–ª–∞–º–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DiscountOperationWindow.xaml  # –û–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ —Å–∫–∏–¥–∫–æ–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateGuestWindow.xaml        # –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DiagnosticsWindow.xaml        # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ ViewModels/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FloatingButtonViewModel.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GuestSearchViewModel.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PointsOperationViewModel.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DiagnosticsViewModel.cs
‚îÇ   ‚îú‚îÄ‚îÄ UserControls/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NumericKeyboard.xaml          # –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AlphabeticKeyboard.xaml       # –ë—É–∫–≤–µ–Ω–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LoadingOverlay.xaml           # Loading –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GuestInfo.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CalculateResponse.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OrderContext.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RKeeperOrder.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SharedMemoryData.cs
‚îÇ   ‚îî‚îÄ‚îÄ Styles/
‚îÇ       ‚îî‚îÄ‚îÄ MaxLoyaltyStyles.xaml
‚îÇ
‚îî‚îÄ‚îÄ Installer/
    ‚îú‚îÄ‚îÄ MaxLoyaltyInstaller_Restaurant123.exe
    ‚îú‚îÄ‚îÄ install_script.nsi          # NSIS —Å–∫—Ä–∏–ø—Ç
    ‚îî‚îÄ‚îÄ config_template.json        # –®–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```


***

## **‚öôÔ∏è 3. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–û–ú–ü–û–ù–ï–ù–¢–û–í**

### **3.1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞**

**–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:**

```
MaxLoyaltyInstaller_Restaurant123.exe
‚îú‚îÄ‚îÄ –°–æ–¥–µ—Ä–∂–∏—Ç:
‚îÇ   ‚îú‚îÄ‚îÄ MaxLoyaltyRKeeper.dll (C++ External DLL)
‚îÇ   ‚îú‚îÄ‚îÄ MaxLoyaltyRKeeperUI.exe (WPF –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
‚îÇ   ‚îú‚îÄ‚îÄ –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π API Key
‚îÇ   ‚îú‚îÄ‚îÄ URL Backend API
‚îÇ   ‚îú‚îÄ‚îÄ Restaurant ID
‚îÇ   ‚îú‚îÄ‚îÄ Terminal ID
‚îÇ   ‚îî‚îÄ‚îÄ Installation ID (UUID)
```

**–ü—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (NSIS installer):**

1. **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ R-Keeper:**

```
–ò—â–µ—Ç –≤ —Ä–µ–µ—Å—Ç—Ä–µ:
HKLM\SOFTWARE\UCS\RKeeper7\InstallDir

–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—É—Ç—å –≤—Ä—É—á–Ω—É—é
```

2. **–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ DLL:**

```
%RK7_INSTALL%\Plugins\MaxLoyaltyRKeeper.dll
```

3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ FarCard:**

```xml
<!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ %RK7_DATA%\FarCard.xml -->
<ExternalDLL>
  <Path>%RK7_INSTALL%\Plugins\MaxLoyaltyRKeeper.dll</Path>
  <Enable>true</Enable>
  <Type>MaxLoyalty</Type>
</ExternalDLL>
```

4. **–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ UI:**

```
C:\MaxLoyalty\MaxLoyaltyRKeeperUI.exe
C:\MaxLoyalty\Resources\
```

5. **–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**

```json
// %AppData%\MaxLoyaltyRKeeper\config.json (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ)
{
  "api_key_encrypted": "...",
  "backend_api_url": "https://api.maxloyalty.ru",
  "installation_id": "inst_abc123",
  "tenant_id": "tenant_mario",
  "restaurant_id": "rest_centro",
  "terminal_id": "term_001",
  "terminal_name": "–ö–∞—Å—Å–∞ 1 (–æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª)",
  "rkeeper_xml_api_url": "http://localhost:8080/rk7api/v0/xmlinterface.xml",
  "machine_id_hash": "..."
}
```

6. **–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ UI:**

```
–°–æ–∑–¥–∞–µ—Ç —è—Ä–ª—ã–∫ –≤:
%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\MaxLoyaltyRKeeperUI.lnk
```

7. **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ R-Keeper:**

```
–ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å R-Keeper –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ DLL
```


### **3.2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DLL (C++)**

```cpp
// MaxLoyaltyRKeeper.dll: dllmain.cpp

#include <Windows.h>
#include <string>
#include <memory>
#include <nlohmann/json.hpp>
#include "http_client.h"
#include "shared_memory.h"
#include "logger.h"
#include "encryption.h"

using json = nlohmann::json;

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
std::unique_ptr<HttpClient> g_httpClient;
std::unique_ptr<SharedMemoryManager> g_sharedMemory;
std::unique_ptr<Logger> g_logger;
std::string g_apiKey;
std::string g_backendUrl;
std::string g_installationId;
std::string g_tenantId;
std::string g_restaurantId;
std::string g_terminalId;

BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        break;
    case DLL_PROCESS_DETACH:
        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ
        break;
    }
    return TRUE;
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º–∞—è —Ñ—É–Ω–∫—Ü–∏—è: Initialize
extern "C" __declspec(dllexport) int __stdcall Initialize(const char* configPath)
{
    try
    {
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        std::string logPath = "C:\\Logs\\MaxLoyaltyRKeeper\\dll-" + GetCurrentDate() + ".log";
        g_logger = std::make_unique<Logger>(logPath);
        
        g_logger->Info("MaxLoyaltyRKeeper.dll Initialize() called");
        g_logger->Info("Config path: %s", configPath);
        
        // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        std::ifstream configFile(configPath);
        if (!configFile.is_open())
        {
            g_logger->Error("Failed to open config file: %s", configPath);
            return -1; // ERROR_CONFIG_NOT_FOUND
        }
        
        json config;
        configFile >> config;
        configFile.close();
        
        // 3. –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ API Key
        std::string machineId = GetMachineId();
        g_apiKey = DecryptApiKey(config["api_key_encrypted"].get<std::string>(), machineId);
        
        if (g_apiKey.empty())
        {
            g_logger->Error("Failed to decrypt API Key");
            return -2; // ERROR_DECRYPTION_FAILED
        }
        
        // 4. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        g_backendUrl = config["backend_api_url"].get<std::string>();
        g_installationId = config["installation_id"].get<std::string>();
        g_tenantId = config["tenant_id"].get<std::string>();
        g_restaurantId = config["restaurant_id"].get<std::string>();
        g_terminalId = config["terminal_id"].get<std::string>();
        
        g_logger->Info("Backend URL: %s", g_backendUrl.c_str());
        g_logger->Info("Installation ID: %s", g_installationId.c_str());
        g_logger->Info("Terminal ID: %s", g_terminalId.c_str());
        
        // 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HTTP –∫–ª–∏–µ–Ω—Ç–∞
        g_httpClient = std::make_unique<HttpClient>(g_backendUrl);
        g_httpClient->SetHeader("X-API-Key", g_apiKey);
        g_httpClient->SetHeader("X-Installation-Id", g_installationId);
        g_httpClient->SetHeader("X-Tenant-Id", g_tenantId);
        g_httpClient->SetHeader("X-Restaurant-Id", g_restaurantId);
        g_httpClient->SetHeader("X-Terminal-Id", g_terminalId);
        g_httpClient->SetTimeout(30000); // 30 —Å–µ–∫—É–Ω–¥
        
        // 6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Shared Memory
        g_sharedMemory = std::make_unique<SharedMemoryManager>(
            "MaxLoyaltyRKeeperShared",
            1024 * 1024 // 1 MB
        );
        
        if (!g_sharedMemory->Open())
        {
            g_logger->Warning("Failed to open shared memory, creating new");
            g_sharedMemory->Create();
        }
        
        // 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ backend
        try
        {
            auto response = g_httpClient->Get("/api/health");
            if (response.statusCode == 200)
            {
                g_logger->Info("Backend connection: OK");
                g_sharedMemory->UpdateBackendStatus(true);
            }
            else
            {
                g_logger->Warning("Backend connection: Failed (status %d)", response.statusCode);
                g_sharedMemory->UpdateBackendStatus(false);
            }
        }
        catch (const std::exception& ex)
        {
            g_logger->Warning("Backend connection test failed: %s", ex.what());
            g_sharedMemory->UpdateBackendStatus(false);
        }
        
        // 8. –ü–µ—Ä–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–º–µ—Ç—Ä–∏–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏)
        SendFirstConnect();
        
        // 9. –£—Å–ø–µ—à–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        g_logger->Info("MaxLoyaltyRKeeper.dll initialized successfully");
        return 0; // SUCCESS
    }
    catch (const std::exception& ex)
    {
        if (g_logger)
            g_logger->Error("Initialize() exception: %s", ex.what());
        return -1; // ERROR_UNKNOWN
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º–∞—è —Ñ—É–Ω–∫—Ü–∏—è: GetCardInfo
extern "C" __declspec(dllexport) int __stdcall GetCardInfo(
    const char* cardNumber, 
    CardInfo* outInfo
)
{
    if (!cardNumber || !outInfo)
    {
        g_logger->Error("GetCardInfo: Invalid parameters");
        return -1;
    }
    
    g_logger->Info("GetCardInfo called: %s", MaskCardNumber(cardNumber));
    
    try
    {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–∏—Å–∫–∞ (—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ 6-digit –∫–æ–¥)
        std::string searchValue(cardNumber);
        bool isPhone = (searchValue.length() >= 10 && searchValue[^19_0] == '+');
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º JSON –∑–∞–ø—Ä–æ—Å
        json requestBody;
        if (isPhone)
            requestBody["phone"] = searchValue;
        else
            requestBody["code6Digit"] = searchValue;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend
        auto response = g_httpClient->Post(
            "/api/pos-integration/rkeeper/search-guest",
            requestBody.dump()
        );
        
        if (response.statusCode != 200)
        {
            g_logger->Error("GetCardInfo: Backend returned %d", response.statusCode);
            return -2; // ERROR_API
        }
        
        // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
        auto responseData = json::parse(response.body);
        
        if (!responseData["found"].get<bool>())
        {
            g_logger->Info("GetCardInfo: Guest not found");
            return -1; // NOT_FOUND
        }
        
        auto guest = responseData["guest"];
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É CardInfo
        ZeroMemory(outInfo, sizeof(CardInfo));
        
        strncpy_s(outInfo->guestName, guest["name"].get<std::string>().c_str(), 255);
        strncpy_s(outInfo->phone, guest["phone"].get<std::string>().c_str(), 31);
        strncpy_s(outInfo->cardId, guest["cardId"].get<std::string>().c_str(), 63);
        strncpy_s(outInfo->levelName, guest["levelName"].get<std::string>().c_str(), 127);
        
        outInfo->levelId = guest["levelId"].get<int>();
        outInfo->regularBalance = guest["regularBalance"].get<double>();
        outInfo->promoBalance = guest["promoBalance"].get<double>();
        outInfo->totalBalance = guest["totalBalance"].get<double>();
        
        if (guest.contains("code6Digit"))
        {
            strncpy_s(outInfo->code6Digit, guest["code6Digit"].get<std::string>().c_str(), 7);
        }
        
        g_logger->Info("GetCardInfo: Success - %s", guest["name"].get<std::string>().c_str());
        
        return 0; // SUCCESS
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("GetCardInfo exception: %s", ex.what());
        return -2; // ERROR_API
    }
}

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ CardInfo
struct CardInfo
{
    char guestName[^19_256];
    char phone[^19_32];
    char cardId[^19_64];
    char levelName[^19_128];
    char code6Digit[^19_7];
    int levelId;
    double regularBalance;
    double promoBalance;
    double totalBalance;
};

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º–∞—è —Ñ—É–Ω–∫—Ü–∏—è: ReservePoints
extern "C" __declspec(dllexport) int __stdcall ReservePoints(
    const char* cardId,
    double pointsToSpend,
    const char* orderId,
    char* outReservationId
)
{
    if (!cardId || !orderId || !outReservationId || pointsToSpend <= 0)
    {
        g_logger->Error("ReservePoints: Invalid parameters");
        return -2;
    }
    
    g_logger->Info("ReservePoints: CardId=%s, Points=%.2f, OrderId=%s", 
        cardId, pointsToSpend, orderId);
    
    try
    {
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
        json requestBody = {
            {"guestCardId", cardId},
            {"pointsToSpend", pointsToSpend},
            {"orderId", orderId},
            {"restaurantId", g_restaurantId},
            {"terminalId", g_terminalId}
        };
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend
        auto response = g_httpClient->Post(
            "/api/pos-integration/rkeeper/reserve-points",
            requestBody.dump()
        );
        
        if (response.statusCode != 200)
        {
            g_logger->Error("ReservePoints: Backend returned %d", response.statusCode);
            return -2;
        }
        
        auto responseData = json::parse(response.body);
        
        if (!responseData["success"].get<bool>())
        {
            std::string error = responseData.value("error", "Unknown error");
            g_logger->Error("ReservePoints: %s", error.c_str());
            return -1; // INSUFFICIENT_BALANCE
        }
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º reservation ID
        std::string reservationId = responseData["reservationId"].get<std::string>();
        strncpy_s(outReservationId, 64, reservationId.c_str(), _TRUNCATE);
        
        g_logger->Info("ReservePoints: Success, ReservationId=%s", reservationId.c_str());
        
        return 0; // SUCCESS
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("ReservePoints exception: %s", ex.what());
        return -2;
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º–∞—è —Ñ—É–Ω–∫—Ü–∏—è: FinalizeTransaction
extern "C" __declspec(dllexport) int __stdcall FinalizeTransaction(
    const char* reservationId,
    double finalAmount,
    const char* orderId,
    const char* paymentTypesJson
)
{
    g_logger->Info("FinalizeTransaction: OrderId=%s, Amount=%.2f", orderId, finalAmount);
    
    try
    {
        // 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ shared memory
        auto context = g_sharedMemory->GetOrderContext(orderId);
        
        if (!context.has_value())
        {
            g_logger->Warning("No loyalty context for order %s", orderId);
            return 0; // –ù–µ –æ—à–∏–±–∫–∞, –ø—Ä–æ—Å—Ç–æ –Ω–µ—Ç –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
        }
        
        // 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ backend
        json requestBody = {
            {"guestCardId", context->cardId},
            {"orderId", orderId},
            {"reservationId", context->reservationId},
            {"checkAmount", context->originalAmount},
            {"finalCheckAmount", finalAmount},
            {"restaurantId", g_restaurantId},
            {"terminalId", g_terminalId},
            {"paymentTypes", json::parse(paymentTypesJson)}
        };
        
        std::string endpoint;
        
        if (context->benefitType == BenefitType::Points)
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-points";
            requestBody["pointsSpent"] = context->pointsToSpend;
            requestBody["pointsToEarn"] = context->pointsToEarn;
            requestBody["action"] = context->action;
        }
        else if (context->benefitType == BenefitType::Discount)
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-discount";
            requestBody["discountAmount"] = context->discountAmount;
            requestBody["discountPercentage"] = context->discountPercentage;
        }
        
        // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å retry
        auto response = RetryPolicy::Execute([&]() {
            return g_httpClient->Post(endpoint, requestBody.dump());
        }, 3); // 3 –ø–æ–ø—ã—Ç–∫–∏
        
        if (response.statusCode == 200)
        {
            auto responseData = json::parse(response.body);
            
            if (responseData["success"].get<bool>())
            {
                std::string txnId = responseData["transactionId"].get<std::string>();
                g_logger->Info("Finalized successfully: TxnId=%s", txnId.c_str());
                
                // 4. –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
                g_sharedMemory->ClearOrderContext(orderId);
                
                // 5. –£–≤–µ–¥–æ–º–ª—è–µ–º UI
                g_sharedMemory->NotifyUI("order_finalized", orderId);
                
                return 0; // SUCCESS
            }
        }
        
        // Backend –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        g_logger->Warning("Backend unavailable, queueing offline...");
        
        // 6. –î–æ–±–∞–≤–ª—è–µ–º –≤ offline queue
        g_sharedMemory->EnqueueOfflineOperation({
            "FINALIZE_" + std::string(context->benefitType == BenefitType::Points ? "POINTS" : "DISCOUNT"),
            orderId,
            requestBody.dump(),
            GetCurrentTimestamp(),
            0 // attempts
        });
        
        return -2; // QUEUED_OFFLINE
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("FinalizeTransaction exception: %s", ex.what());
        return -1;
    }
}
```


### **3.3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI (C\# WPF)**

```csharp
// MaxLoyaltyRKeeperUI: App.xaml.cs

public partial class App : Application
{
    private IServiceProvider serviceProvider;
    private FloatingButtonWindow floatingButton;
    
    protected override async void OnStartup(StartupEventArgs e)
    {
        base.OnStartup(e);
        
        // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        ConfigureLogging();
        
        Log.Information("===== Max Loyalty RKeeper UI Started =====");
        
        try
        {
            // 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DI
            var services = new ServiceCollection();
            ConfigureServices(services);
            serviceProvider = services.BuildServiceProvider();
            
            // 3. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            var configService = serviceProvider.GetRequiredService<IConfigService>();
            var config = configService.LoadConfig();
            
            Log.Information("Configuration loaded: Restaurant={Restaurant}, Terminal={Terminal}",
                config.RestaurantName, config.TerminalName);
            
            // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ machine binding
            var securityService = serviceProvider.GetRequiredService<SecurityService>();
            if (!await securityService.ValidateMachineBindingAsync())
            {
                Shutdown();
                return;
            }
            
            // 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Shared Memory
            var sharedMemory = serviceProvider.GetRequiredService<ISharedMemoryService>();
            await sharedMemory.InitializeAsync();
            
            // 6. Health checks
            var healthCheck = serviceProvider.GetRequiredService<IHealthCheckService>();
            healthCheck.StartMonitoring();
            
            // 7. –û–±—Ä–∞–±–æ—Ç–∫–∞ offline –æ—á–µ—Ä–µ–¥–∏
            var offlineQueue = serviceProvider.GetRequiredService<IOfflineQueueService>();
            _ = offlineQueue.ProcessQueueAsync();
            
            // 8. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            var updateService = serviceProvider.GetRequiredService<IUpdateService>();
            updateService.StartPeriodicCheck();
            
            // 9. –ó–∞–ø—É—Å–∫ Floating Button
            floatingButton = serviceProvider.GetRequiredService<FloatingButtonWindow>();
            floatingButton.Show();
            
            Log.Information("UI initialized successfully");
        }
        catch (Exception ex)
        {
            Log.Fatal(ex, "Failed to initialize UI");
            
            MessageBox.Show(
                $"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å Max Loyalty:\n{ex.Message}",
                "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
            
            Shutdown();
        }
    }
    
    private void ConfigureServices(IServiceCollection services)
    {
        // Configuration
        services.AddSingleton<IConfigService, ConfigService>();
        
        // Security
        services.AddSingleton<SecurityService>();
        
        // API Clients
        services.AddHttpClient<ILoyaltyApiClient, LoyaltyApiClient>()
            .ConfigurePrimaryHttpMessageHandler(() => new HttpClientHandler
            {
                ServerCertificateCustomValidationCallback = 
                    HttpClientHandler.DangerousAcceptAnyServerCertificateValidator
            })
            .AddPolicyHandler(GetRetryPolicy());
        
        services.AddHttpClient<IRKeeperXmlClient, RKeeperXmlClient>();
        
        // Services
        services.AddSingleton<ISharedMemoryService, SharedMemoryService>();
        services.AddSingleton<IOfflineQueueService, OfflineQueueService>();
        services.AddSingleton<IHealthCheckService, HealthCheckService>();
        services.AddSingleton<IMetricsService, MetricsService>();
        services.AddSingleton<IUpdateService, UpdateService>();
        services.AddSingleton<PerformanceMonitor>();
        
        // ViewModels
        services.AddTransient<FloatingButtonViewModel>();
        services.AddTransient<GuestSearchViewModel>();
        services.AddTransient<PointsOperationViewModel>();
        services.AddTransient<DiscountOperationViewModel>();
        services.AddTransient<DiagnosticsViewModel>();
        
        // Windows
        services.AddSingleton<FloatingButtonWindow>();
        services.AddTransient<GuestSearchWindow>();
        services.AddTransient<PointsOperationWindow>();
        services.AddTransient<DiscountOperationWindow>();
        services.AddTransient<DiagnosticsWindow>();
    }
    
    private IAsyncPolicy<HttpResponseMessage> GetRetryPolicy()
    {
        return HttpPolicyExtensions
            .HandleTransientHttpError()
            .WaitAndRetryAsync(
                3,
                retryAttempt => TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)),
                onRetry: (outcome, timespan, retryCount, context) =>
                {
                    Log.Warning("Retry {RetryCount} after {Delay}s", retryCount, timespan.TotalSeconds);
                }
            );
    }
    
    private void ConfigureLogging()
    {
        Log.Logger = new LoggerConfiguration()
            .MinimumLevel.Information()
            .MinimumLevel.Override("Microsoft", LogEventLevel.Warning)
            .MinimumLevel.Override("System", LogEventLevel.Warning)
            .Enrich.FromLogContext()
            .Enrich.WithProperty("Application", "MaxLoyaltyRKeeperUI")
            .Enrich.WithProperty("Version", GetVersion())
            .Enrich.WithMachineName()
            .Enrich.WithEnvironmentUserName()
            .WriteTo.File(
                path: @"C:\Logs\MaxLoyaltyRKeeper\ui-.log",
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 7,
                fileSizeLimitBytes: 50 * 1024 * 1024, // 50 MB
                rollOnFileSizeLimit: true,
                outputTemplate: "[{Timestamp:yyyy-MM-dd HH:mm:ss.fff}] [{Level:u3}] {Message:lj}{NewLine}{Exception}"
            )
            .WriteTo.File(
                path: @"C:\Logs\MaxLoyaltyRKeeper\errors-.log",
                restrictedToMinimumLevel: LogEventLevel.Error,
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 30
            )
            .CreateLogger();
    }
    
    private string GetVersion()
    {
        var assembly = Assembly.GetExecutingAssembly();
        var version = assembly.GetName().Version;
        return $"{version.Major}.{version.Minor}.{version.Build}";
    }
}
```


***

## **üé® 4. UI/UX WORKFLOW**

### **4.1. –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: Floating Button**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:**

```
–í—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö R-Keeper (Topmost)
–ü–æ–∑–∏—Ü–∏—è: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –≤–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π —É–≥–æ–ª)
–†–∞–∑–º–µ—Ä: 60x60 px (touch-friendly)
```

**–í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ R-KEEPER 7.x                                       ‚îÇ
‚îÇ                                                    ‚îÇ
‚îÇ  [–°—Ç–æ–ª—ã] [–ú–µ–Ω—é] [–ó–∞–∫–∞–∑—ã] [–ö–∞—Å—Å–∞]        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ                                          ‚îÇ ML ‚îÇ   ‚îÇ ‚Üê Floating Button
‚îÇ                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  –ó–∞–∫–∞–∑: –°—Ç–æ–ª 5                              üü¢    ‚îÇ ‚Üê –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã
‚îÇ  ‚Ä¢ –ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞ x1       500‚ÇΩ                  ‚îÇ
‚îÇ  ‚Ä¢ Coca-Cola 0.5–ª x2        200‚ÇΩ                  ‚îÇ
‚îÇ  ‚Ä¢ –°–∞–ª–∞—Ç –¶–µ–∑–∞—Ä—å x1          350‚ÇΩ                  ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                   ‚îÇ
‚îÇ  –ò–¢–û–ì–û:                   1,050‚ÇΩ                   ‚îÇ
‚îÇ                                                    ‚îÇ
‚îÇ  [–ö –æ–ø–ª–∞—Ç–µ]                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ:**

- **–û–¥–∏–Ω–æ—á–Ω—ã–π –∫–ª–∏–∫** ‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è
- **–î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ (1 —Å–µ–∫)** ‚Üí –†–µ–∂–∏–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
- **–ü—Ä–∞–≤—ã–π –∫–ª–∏–∫** ‚Üí –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
- **Drag \& Drop** ‚Üí –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é

**–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üîç –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è          ‚îÇ
‚îÇ ‚ùå –û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É       ‚îÇ (–µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞          ‚îÇ
‚îÇ ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚ÑπÔ∏è –û –ø—Ä–æ–≥—Ä–∞–º–º–µ          ‚îÇ
‚îÇ ‚ùå –í—ã—Ö–æ–¥                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


### **4.2. –û–∫–Ω–æ 1: –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è (GuestSearchWindow)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MAX LOYALTY                              [‚úï]     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  [–¢–ï–õ–ï–§–û–ù]          [6-–ó–ù–ê–ß–ù–´–ô –ö–û–î]       ‚îÇ  ‚îÇ ‚Üê –¢–∞–±—ã
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ                                            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     +7 (___) ___-__-__                    ‚îÇ  ‚îÇ ‚Üê –ü–æ–ª–µ –≤–≤–æ–¥–∞ (–º–∞—Å–∫–∞)
‚îÇ  ‚îÇ                                            ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                       ‚îÇ
‚îÇ       ‚îÇ  1  ‚îÇ  2  ‚îÇ  3  ‚îÇ                       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                       ‚îÇ
‚îÇ       ‚îÇ  4  ‚îÇ  5  ‚îÇ  6  ‚îÇ   (80x80px)          ‚îÇ ‚Üê –¶–∏—Ñ—Ä–æ–≤–∞—è
‚îÇ       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                       ‚îÇ   –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
‚îÇ       ‚îÇ  7  ‚îÇ  8  ‚îÇ  9  ‚îÇ                       ‚îÇ   (touch-friendly)
‚îÇ       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                       ‚îÇ
‚îÇ       ‚îÇ  ‚Üê  ‚îÇ  0  ‚îÇ  ‚úì  ‚îÇ                       ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                       ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ –ê–ö–¢–ò–í–ù–´–ï –ó–ê–ö–ê–ó–´                            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚òë –°—Ç–æ–ª 5 - 1,050‚ÇΩ                         ‚îÇ  ‚îÇ ‚Üê –í—ã–±–æ—Ä –∑–∞–∫–∞–∑–∞
‚îÇ  ‚îÇ ‚òê –°—Ç–æ–ª 12 - 2,340‚ÇΩ                        ‚îÇ  ‚îÇ   (–µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ)
‚îÇ  ‚îÇ                                            ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   üîç –ù–ê–ô–¢–ò –ì–û–°–¢–Ø                          ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   ‚ûï –°–û–ó–î–ê–¢–¨ –ù–û–í–û–ì–û –ì–û–°–¢–Ø                 ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –°—É–º–º–∞ –∑–∞–∫–∞–∑–∞: 1,050.00 ‚ÇΩ                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–õ–æ–≥–∏–∫–∞:**

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –∫–æ–¥:**

```csharp
private async void OnSearchClick()
{
    var input = SearchQueryInput;
    
    ShowLoading("–ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è...");
    
    // 1. –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è –Ω–∞ backend
    var searchResponse = await apiClient.SearchGuestAsync(new SearchRequest
    {
        Phone = IsPhoneTab ? input : null,
        Code6Digit = IsCodeTab ? input : null
    });
    
    if (!searchResponse.Found)
    {
        HideLoading();
        ShowNotFoundDialog();
        return;
    }
    
    var guest = searchResponse.Guest;
    
    // 2. Calculate –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
    var calculateResponse = await apiClient.CalculateAsync(new CalculateRequest
    {
        GuestCardId = guest.CardId,
        CheckAmount = SelectedOrder.Amount,
        OrderCategories = SelectedOrder.Categories,
        OrderType = SelectedOrder.Type
    });
    
    HideLoading();
    
    // 3. –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏
    if (calculateResponse.BenefitType == "POINTS")
    {
        OpenPointsOperationWindow(guest, calculateResponse, SelectedOrder);
    }
    else if (calculateResponse.BenefitType == "DISCOUNT")
    {
        OpenDiscountOperationWindow(guest, calculateResponse, SelectedOrder);
    }
}
```

2. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ R-Keeper XML API:**

```csharp
private async Task LoadActiveOrdersAsync()
{
    var orders = await rkeeperClient.GetOrderListAsync();
    
    ActiveOrders = new ObservableCollection<RKeeperOrder>(orders);
    
    if (orders.Count == 1)
    {
        SelectedOrder = orders; // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –µ—Å–ª–∏ –æ–¥–∏–Ω –∑–∞–∫–∞–∑
    }
}
```


### **4.3. –û–∫–Ω–æ 2A: –û–ø–µ—Ä–∞—Ü–∏—è —Å –±–∞–ª–ª–∞–º–∏ (PointsOperationWindow)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°–ü–ò–°–ê–ù–ò–ï –ë–ê–õ–õ–û–í                          [‚úï]     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üë§ –ò–í–ê–ù –ü–ï–¢–†–û–í                                   ‚îÇ
‚îÇ üì± +7 999 123 45 67                              ‚îÇ
‚îÇ ‚≠ê –ó–û–õ–û–¢–û–ô –£–†–û–í–ï–ù–¨                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                  ‚îÇ
‚îÇ  üí∞ –ë–û–ù–£–°–ù–´–ô –ë–ê–õ–ê–ù–°                              ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ     ‚îÇ        2,450.00 ‚ÇΩ                 ‚îÇ       ‚îÇ
‚îÇ     ‚îÇ                                   ‚îÇ       ‚îÇ
‚îÇ     ‚îÇ  –û—Å–Ω–æ–≤–Ω—ã–µ: 1,500‚ÇΩ ‚Ä¢ –ü—Ä–æ–º–æ: 950‚ÇΩ  ‚îÇ       ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏:             1,050.00 ‚ÇΩ          ‚îÇ
‚îÇ  –î–æ—Å—Ç—É–ø–Ω–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é:         210.00 ‚ÇΩ   (20%)  ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  –°–ü–ò–°–ê–¢–¨ –ë–ê–õ–õ–û–í:           [^19_210] ‚ÇΩ       ‚îÇ  ‚îÇ ‚Üê –ü–æ–ª–µ –≤–≤–æ–¥–∞
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                       ‚îÇ
‚îÇ       ‚îÇ  1  ‚îÇ  2  ‚îÇ  3  ‚îÇ                       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                       ‚îÇ
‚îÇ       ‚îÇ  4  ‚îÇ  5  ‚îÇ  6  ‚îÇ                       ‚îÇ ‚Üê –¶–∏—Ñ—Ä–æ–≤–∞—è
‚îÇ       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                       ‚îÇ   –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
‚îÇ       ‚îÇ  7  ‚îÇ  8  ‚îÇ  9  ‚îÇ                       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                       ‚îÇ
‚îÇ       ‚îÇ  ‚Üê  ‚îÇ  0  ‚îÇ MAX ‚îÇ ‚Üê –ö–Ω–æ–ø–∫–∞ MAX         ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                       ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ ‚ûï –ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +53 –±–∞–ª–ª–æ–≤            ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   üí≥ –°–ü–ò–°–ê–¢–¨ –ë–ê–õ–õ–´                        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   ‚ûï –¢–û–õ–¨–ö–û –ù–ê–ß–ò–°–õ–ò–¢–¨                     ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   ‚ùå –û–¢–í–Ø–ó–ê–¢–¨ –ö–ê–†–¢–£                       ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–æ–∫:**

```csharp
// 1. –ö–Ω–æ–ø–∫–∞ "–°–ü–ò–°–ê–¢–¨ –ë–ê–õ–õ–´"
private async void OnApplyPointsClick()
{
    var pointsToSpend = decimal.Parse(PointsToSpendInput);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (pointsToSpend > MaxAllowed)
    {
        ShowError($"–ú–∞–∫—Å–∏–º—É–º –¥–æ—Å—Ç—É–ø–Ω–æ: {MaxAllowed:N0}‚ÇΩ");
        return;
    }
    
    if (pointsToSpend > Guest.TotalBalance)
    {
        ShowError($"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ (–±–∞–ª–∞–Ω—Å: {Guest.TotalBalance:N0}‚ÇΩ)");
        return;
    }
    
    ShowLoading("–†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –±–∞–ª–ª–æ–≤...");
    
    // 1. –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –Ω–∞ backend
    var reserveResponse = await apiClient.ReservePointsAsync(new ReserveRequest
    {
        GuestCardId = Guest.CardId,
        PointsToSpend = (double)pointsToSpend,
        MaxAllowed = (double)MaxAllowed,
        CheckAmount = (double)SelectedOrder.Amount,
        OrderId = SelectedOrder.Id
    });
    
    if (!reserveResponse.Success)
    {
        HideLoading();
        ShowError(reserveResponse.Error);
        return;
    }
    
    // 2. –ü—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã –∫ –∑–∞–∫–∞–∑—É —á–µ—Ä–µ–∑ XML API
    await rkeeperClient.BindCardToOrderAsync(SelectedOrder.Id, Guest.Phone);
    
    // 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä—É—á–Ω–æ–π —Å–∫–∏–¥–∫–∏ –Ω–∞ —Å—É–º–º—É –±–∞–ª–ª–æ–≤
    await rkeeperClient.ApplyManualDiscountAsync(
        SelectedOrder.Id,
        pointsToSpend,
        $"Max Loyalty - –ë–∞–ª–ª—ã ({Guest.Name})"
    );
    
    // 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ Shared Memory
    await sharedMemoryService.SaveOrderContextAsync(new OrderContext
    {
        OrderId = SelectedOrder.Id,
        GuestCardId = Guest.CardId,
        GuestName = Guest.Name,
        GuestPhone = Guest.Phone,
        BenefitType = BenefitType.Points,
        Action = LoyaltyAction.Spend,
        PointsToSpend = (double)pointsToSpend,
        MaxAllowed = (double)MaxAllowed,
        PointsToEarn = (double)PointsToEarn,
        ReservationId = reserveResponse.ReservationId,
        OriginalCheckAmount = (double)SelectedOrder.Amount,
        AppliedAt = DateTime.UtcNow
    });
    
    HideLoading();
    
    ShowSuccess(
        $"‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ {pointsToSpend:N0}‚ÇΩ –±–∞–ª–ª–æ–≤ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ\n\n" +
        $"–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +{PointsToEarn} –±–∞–ª–ª–æ–≤\n\n" +
        $"–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–∞–ª–ª—ã —Å–ø–∏—à—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
    );
    
    this.Close();
}

// 2. –ö–Ω–æ–ø–∫–∞ "–¢–û–õ–¨–ö–û –ù–ê–ß–ò–°–õ–ò–¢–¨"
private async void OnEarnOnlyClick()
{
    ShowLoading("–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è...");
    
    // –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è —Å pointsToSpend = 0
    var reserveResponse = await apiClient.ReservePointsAsync(new ReserveRequest
    {
        GuestCardId = Guest.CardId,
        PointsToSpend = 0,
        CheckAmount = (double)SelectedOrder.Amount,
        OrderId = SelectedOrder.Id,
        Action = "EARN_ONLY"
    });
    
    // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã
    await rkeeperClient.BindCardToOrderAsync(SelectedOrder.Id, Guest.Phone);
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    await sharedMemoryService.SaveOrderContextAsync(new OrderContext
    {
        OrderId = SelectedOrder.Id,
        GuestCardId = Guest.CardId,
        GuestName = Guest.Name,
        GuestPhone = Guest.Phone,
        BenefitType = BenefitType.Points,
        Action = LoyaltyAction.EarnOnly,
        PointsToSpend = 0,
        PointsToEarn = (double)PointsToEarn,
        ReservationId = reserveResponse.ReservationId,
        OriginalCheckAmount = (double)SelectedOrder.Amount,
        AppliedAt = DateTime.UtcNow
    });
    
    HideLoading();
    
    ShowSuccess(
        $"‚úÖ –ö–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –∑–∞–∫–∞–∑—É\n\n" +
        $"–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ +{PointsToEarn} –±–∞–ª–ª–æ–≤"
    );
    
    this.Close();
}

// 3. –ö–Ω–æ–ø–∫–∞ "–û–¢–í–Ø–ó–ê–¢–¨ –ö–ê–†–¢–£"
private async void OnUnbindCardClick()
{
    var result = MessageBox.Show(
        "–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É –æ—Ç –∑–∞–∫–∞–∑–∞?",
        "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
        MessageBoxButton.YesNo,
        MessageBoxImage.Question
    );
    
    if (result == MessageBoxResult.Yes)
    {
        ShowLoading("–û—Ç–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã...");
        
        // –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é –Ω–∞ backend
        await apiClient.CancelReservationAsync(new CancelReservationRequest
        {
            ReservationId = ReservationId,
            OrderId = SelectedOrder.Id,
            Reason = "USER_UNBIND"
        });
        
        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        await sharedMemoryService.ClearOrderContextAsync(SelectedOrder.Id);
        
        HideLoading();
        
        ShowSuccess("‚úÖ –ö–∞—Ä—Ç–∞ –æ—Ç–≤—è–∑–∞–Ω–∞");
        
        this.Close();
    }
}
```


### **4.4. –û–∫–Ω–æ 2B: –û–ø–µ—Ä–∞—Ü–∏—è —Å–æ —Å–∫–∏–¥–∫–æ–π (DiscountOperationWindow)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –°–ö–ò–î–ö–ò                        [‚úï]     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üë§ –ú–ê–†–ò–Ø –°–ò–î–û–†–û–í–ê                                ‚îÇ
‚îÇ üì± +7 999 765 43 21                              ‚îÇ
‚îÇ ‚≠ê –°–ï–†–ï–ë–†–Ø–ù–´–ô –£–†–û–í–ï–ù–¨ (–°–∫–∏–¥–∫–∞ 15%)               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                  ‚îÇ
‚îÇ  üéÅ –ü–ï–†–°–û–ù–ê–õ–¨–ù–ê–Ø –°–ö–ò–î–ö–ê                          ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ     ‚îÇ                                   ‚îÇ       ‚îÇ
‚îÇ     ‚îÇ           15%                     ‚îÇ       ‚îÇ
‚îÇ     ‚îÇ                                   ‚îÇ       ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  –°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏:             1,050.00 ‚ÇΩ          ‚îÇ
‚îÇ  –°–∫–∏–¥–∫–∞ 15%:                 -157.50 ‚ÇΩ          ‚îÇ
‚îÇ  –ö –æ–ø–ª–∞—Ç–µ:                    892.50 ‚ÇΩ          ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   üéÅ –ü–†–ò–ú–ï–ù–ò–¢–¨ –°–ö–ò–î–ö–£                     ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   ‚ùå –û–¢–í–Ø–ó–ê–¢–¨ –ö–ê–†–¢–£                       ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  ‚ÑπÔ∏è –°–∫–∏–¥–∫–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞ ‚îÇ
‚îÇ                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–õ–æ–≥–∏–∫–∞:**

```csharp
private async void OnApplyDiscountClick()
{
    ShowLoading("–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏...");
    
    // 1. –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –Ω–∞ backend
    var reserveResponse = await apiClient.ReserveDiscountAsync(new ReserveRequest
    {
        GuestCardId = Guest.CardId,
        DiscountPercentage = (double)DiscountPercentage,
        DiscountAmount = (double)DiscountAmount,
        CheckAmount = (double)SelectedOrder.Amount,
        OrderId = SelectedOrder.Id
    });
    
    if (!reserveResponse.Success)
    {
        HideLoading();
        ShowError(reserveResponse.Error);
        return;
    }
    
    // 2. –ü—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã –∫ –∑–∞–∫–∞–∑—É
    await rkeeperClient.BindCardToOrderAsync(SelectedOrder.Id, Guest.Phone);
    
    // 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–π —Å–∫–∏–¥–∫–∏ —á–µ—Ä–µ–∑ XML API
    await rkeeperClient.ApplyPercentDiscountAsync(
        SelectedOrder.Id,
        DiscountPercentage,
        $"Max Loyalty - {DiscountPercentage}% ({Guest.LevelName})"
    );
    
    // 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    await sharedMemoryService.SaveOrderContextAsync(new OrderContext
    {
        OrderId = SelectedOrder.Id,
        GuestCardId = Guest.CardId,
        GuestName = Guest.Name,
        GuestPhone = Guest.Phone,
        BenefitType = BenefitType.Discount,
        Action = LoyaltyAction.ApplyDiscount,
        DiscountPercentage = (double)DiscountPercentage,
        DiscountAmount = (double)DiscountAmount,
        ReservationId = reserveResponse.ReservationId,
        OriginalCheckAmount = (double)SelectedOrder.Amount,
        AppliedAt = DateTime.UtcNow
    });
    
    HideLoading();
    
    ShowSuccess(
        $"‚úÖ –°–∫–∏–¥–∫–∞ {DiscountPercentage}% ({DiscountAmount:N0}‚ÇΩ) –ø—Ä–∏–º–µ–Ω–µ–Ω–∞\n\n" +
        $"üîí –°—É–º–º–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞"
    );
    
    this.Close();
}
```


***

## **üí∞ 5. –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –û–ü–õ–ê–¢–ï**

### **5.1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ FarCard**

–ö–æ–≥–¥–∞ –∫–∞—Å—Å–∏—Ä –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —á–µ–∫, R-Keeper —á–µ—Ä–µ–∑ FarCard –≤—ã–∑—ã–≤–∞–µ—Ç `FinalizeTransaction()` –≤ DLL:

```cpp
// –í MaxLoyaltyRKeeper.dll

extern "C" __declspec(dllexport) int __stdcall FinalizeTransaction(
    const char* reservationId,
    double finalAmount,
    const char* orderId,
    const char* paymentTypesJson
)
{
    g_logger->Info("FinalizeTransaction: OrderId=%s, Amount=%.2f", orderId, finalAmount);
    
    try
    {
        // 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ shared memory
        auto context = g_sharedMemory->GetOrderContext(orderId);
        
        if (!context.has_value())
        {
            g_logger->Warning("No loyalty context for order %s", orderId);
            return 0; // –ù–µ –æ—à–∏–±–∫–∞, –ø—Ä–æ—Å—Ç–æ –Ω–µ—Ç –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
        }
        
        // 2. –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∫–∞—Å—Å–∏—Ä–∞
        std::string cashierName = GetCurrentCashierName();
        
        // 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ backend
        json requestBody = {
            {"guestCardId", context->cardId},
            {"orderId", orderId},
            {"reservationId", context->reservationId},
            {"checkAmount", context->originalAmount},
            {"finalCheckAmount", finalAmount},
            {"restaurantId", g_restaurantId},
            {"terminalId", g_terminalId},
            {"stationId", context->stationId},
            {"cashierName", cashierName},
            {"paymentTypes", json::parse(paymentTypesJson)},
            {"orderType", "DINE_IN"}
        };
        
        std::string endpoint;
        
        if (context->benefitType == BenefitType::Points)
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-points";
            requestBody["pointsSpent"] = context->pointsToSpend;
            requestBody["pointsToEarn"] = context->pointsToEarn;
            requestBody["action"] = context->action;
        }
        else if (context->benefitType == BenefitType::Discount)
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-discount";
            requestBody["discountAmount"] = context->discountAmount;
            requestBody["discountPercentage"] = context->discountPercentage;
        }
        
        // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å retry
        auto response = RetryPolicy::Execute([&]() {
            return g_httpClient->Post(endpoint, requestBody.dump());
        }, 3);
        
        if (response.statusCode == 200)
        {
            auto responseData = json::parse(response.body);
            
            if (responseData["success"].get<bool>())
            {
                std::string txnId = responseData["transactionId"].get<std::string>();
                g_logger->Info("Finalized successfully: TxnId=%s", txnId.c_str());
                
                // 5. –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
                g_sharedMemory->ClearOrderContext(orderId);
                
                // 6. –£–≤–µ–¥–æ–º–ª—è–µ–º UI
                g_sharedMemory->NotifyUI("order_finalized", orderId);
                
                // 7. –ú–µ—Ç—Ä–∏–∫–∏
                SendMetric("loyalty.transaction.finalized", 1);
                
                return 0; // SUCCESS
            }
        }
        
        // Backend –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        g_logger->Warning("Backend unavailable, queueing offline...");
        
        // 8. –î–æ–±–∞–≤–ª—è–µ–º –≤ offline queue
        g_sharedMemory->EnqueueOfflineOperation({
            "FINALIZE_" + std::string(context->benefitType == BenefitType::Points ? "POINTS" : "DISCOUNT"),
            orderId,
            requestBody.dump(),
            GetCurrentTimestamp(),
            0 // attempts
        });
        
        return -2; // Queued offline
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("FinalizeTransaction exception: %s", ex.what());
        return -1;
    }
}
```


### **5.2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∫–∞—Å—Å–∏—Ä–∞**

```cpp
std::string GetCurrentCashierName()
{
    try
    {
        // 1. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è R-Keeper
        char* cashier = std::getenv("RK7_CURRENT_USER");
        if (cashier != nullptr)
        {
            return std::string(cashier);
        }
        
        // 2. –ß–µ—Ä–µ–∑ Windows API (–∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Windows)
        char username[^19_256];
        DWORD size = sizeof(username);
        if (GetUserNameA(username, &size))
        {
            return std::string(username);
        }
        
        return "Unknown";
    }
    catch (...)
    {
        return "Unknown";
    }
}
```


***

## **üîÑ 6. R-KEEPER XML API –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø**

### **6.1. RKeeperXmlClient.cs**

```csharp
public interface IRKeeperXmlClient
{
    Task<List<RKeeperOrder>> GetOrderListAsync();
    Task<RKeeperOrder> GetOrderDetailsAsync(string orderId);
    Task BindCardToOrderAsync(string orderId, string cardNumber);
    Task ApplyManualDiscountAsync(string orderId, decimal amount, string reason);
    Task ApplyPercentDiscountAsync(string orderId, decimal percentage, string reason);
    Task<string> GetCashierNameAsync();
    Task<ServerInfo> GetServerInfoAsync();
}

public class RKeeperXmlClient : IRKeeperXmlClient
{
    private readonly HttpClient httpClient;
    private readonly IConfigService configService;
    private readonly ILogger<RKeeperXmlClient> logger;
    private readonly string xmlApiUrl;
    
    public RKeeperXmlClient(
        HttpClient httpClient,
        IConfigService configService,
        ILogger<RKeeperXmlClient> logger)
    {
        this.httpClient = httpClient;
        this.configService = configService;
        this.logger = logger;
        
        var config = configService.LoadConfig();
        xmlApiUrl = config.RKeeperXmlApiUrl;
        
        httpClient.Timeout = TimeSpan.FromSeconds(10);
    }
    
    public async Task<List<RKeeperOrder>> GetOrderListAsync()
    {
        logger.LogInformation("Getting order list from R-Keeper");
        
        var xml = @"
            <RK7Query>
              <RK7CMD CMD=""GetOrderList"">
                <Filter>
                  <Status>OPEN</Status>
                </Filter>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        
        var doc = XDocument.Parse(response);
        
        var orders = doc.Descendants("Order").Select(o => new RKeeperOrder
        {
            Id = o.Element("ident")?.Value,
            TableNumber = o.Element("Table")?.Value,
            Amount = ParseDecimal(o.Element("Amount")?.Value),
            Status = o.Element("Status")?.Value,
            Type = ParseOrderType(o.Element("OrderType")?.Value),
            Categories = ParseCategories(o.Element("Items")),
            StationId = o.Element("StationId")?.Value,
            OpenedAt = ParseDateTime(o.Element("OpenedAt")?.Value),
            DisplayName = GetOrderDisplayName(o)
        }).ToList();
        
        logger.LogInformation("Retrieved {Count} orders", orders.Count);
        
        return orders;
    }
    
    public async Task BindCardToOrderAsync(string orderId, string cardNumber)
    {
        logger.LogInformation("Binding card to order: {OrderId}, Card: {CardNumber}", 
            orderId, MaskCardNumber(cardNumber));
        
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""SaveOrder"">
                <Order>
                  <ident>{XmlEscape(orderId)}</ident>
                  <GuestCard>
                    <CardNumber>{XmlEscape(cardNumber)}</CardNumber>
                  </GuestCard>
                </Order>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        ValidateResponse(response);
        
        logger.LogInformation("Card bound successfully");
    }
    
    public async Task ApplyManualDiscountAsync(string orderId, decimal amount, string reason)
    {
        logger.LogInformation("Applying manual discount: {OrderId}, Amount: {Amount}", 
            orderId, amount);
        
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""SaveOrder"">
                <Order>
                  <ident>{XmlEscape(orderId)}</ident>
                  <Discount>
                    <Type>MANUAL</Type>
                    <DiscountType>FIXED</DiscountType>
                    <Value>{amount.ToString("0.00", CultureInfo.InvariantCulture)}</Value>
                    <Reason>{XmlEscape(reason)}</Reason>
                  </Discount>
                </Order>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        ValidateResponse(response);
        
        logger.LogInformation("Manual discount applied successfully");
    }
    
    public async Task ApplyPercentDiscountAsync(string orderId, decimal percentage, string reason)
    {
        logger.LogInformation("Applying percent discount: {OrderId}, Percentage: {Percentage}%", 
            orderId, percentage);
        
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""SaveOrder"">
                <Order>
                  <ident>{XmlEscape(orderId)}</ident>
                  <Discount>
                    <Type>MANUAL</Type>
                    <DiscountType>PERCENT</DiscountType>
                    <Value>{percentage.ToString("0.00", CultureInfo.InvariantCulture)}</Value>
                    <Reason>{XmlEscape(reason)}</Reason>
                  </Discount>
                </Order>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        ValidateResponse(response);
        
        logger.LogInformation("Percent discount applied successfully");
    }
    
    private async Task<string> SendXmlRequestAsync(string xmlRequest)
    {
        try
        {
            var content = new StringContent(xmlRequest, Encoding.UTF8, "text/xml");
            var response = await httpClient.PostAsync(xmlApiUrl, content);
            
            if (!response.IsSuccessStatusCode)
            {
                logger.LogError("R-Keeper XML API returned {StatusCode}", response.StatusCode);
                throw new HttpRequestException($"R-Keeper API error: {response.StatusCode}");
            }
            
            var responseXml = await response.Content.ReadAsStringAsync();
            
            logger.LogDebug("R-Keeper Response: {Response}", responseXml);
            
            return responseXml;
        }
        catch (TaskCanceledException ex)
        {
            logger.LogError(ex, "R-Keeper XML API request timeout");
            throw new TimeoutException("R-Keeper API timeout", ex);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "R-Keeper XML API request failed");
            throw;
        }
    }
    
    private void ValidateResponse(string xmlResponse)
    {
        var doc = XDocument.Parse(xmlResponse);
        var status = doc.Descendants("Status").FirstOrDefault()?.Value;
        
        if (status != "OK" && status != "SUCCESS")
        {
            var error = doc.Descendants("Error").FirstOrDefault()?.Value ?? "Unknown error";
            throw new Exception($"R-Keeper error: {error}");
        }
    }
}
```


***

## **üì° 7. BACKEND API ENDPOINTS**

```typescript
// ==========================================
// 1. –ü–û–ò–°–ö –ì–û–°–¢–Ø
// ==========================================

POST /api/pos-integration/rkeeper/search-guest

Headers:
  X-API-Key: rk_live_xxxxx
  X-Installation-Id: inst_abc123
  X-Tenant-Id: tenant_mario
  X-Restaurant-Id: rest_centro
  X-Terminal-Id: term_001

Request:
{
  "phone"?: "+79991234567",
  "code6Digit"?: "123456"
}

Response 200:
{
  "found": true,
  "guest": {
    "cardId": "card_uuid_abc",
    "name": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
    "phone": "+79991234567",
    "levelId": 2,
    "levelName": "–°–µ—Ä–µ–±—Ä–æ",
    "regularBalance": 1500.00,
    "promoBalance": 950.00,
    "totalBalance": 2450.00,
    "code6Digit": "123456"
  }
}

// ==========================================
// 2. –†–ê–°–ß–ï–¢ –ë–ï–ù–ï–§–ò–¢–û–í
// ==========================================

POST /api/pos-integration/rkeeper/calculate

Request:
{
  "guestCardId": "card_uuid_abc",
  "checkAmount": 890.00,
  "orderCategories": ["–ü–∏—Ü—Ü–∞", "–ù–∞–ø–∏—Ç–∫–∏"],
  "orderType": "DINE_IN",
  "calculateOnly": true
}

Response 200:
{
  "benefitType": "POINTS",
  "maxAllowedToSpend": 178.00,
  "pointsToEarn": 45.00,
  "discountPercentage": 0,
  "discountAmount": 0,
  "checkAmount": 890.00
}

// ==========================================
// 3. –†–ï–ó–ï–†–í–ê–¶–ò–Ø –ë–ê–õ–õ–û–í
// ==========================================

POST /api/pos-integration/rkeeper/reserve-points

Request:
{
  "guestCardId": "card_uuid_abc",
  "pointsToSpend": 178.00,
  "maxAllowed": 178.00,
  "checkAmount": 890.00,
  "orderId": "order_12345",
  "restaurantId": "rest_centro",
  "terminalId": "term_001",
  "action": "SPEND"
}

Response 200:
{
  "success": true,
  "reservationId": "res_xyz789",
  "pointsReserved": 178.00,
  "expiresAt": "2026-02-18T01:00:00Z",
  "newBalance": 2272.00
}

// ==========================================
// 4. –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–õ–õ–û–í
// ==========================================

POST /api/pos-integration/rkeeper/finalize-points

Request:
{
  "guestCardId": "card_uuid_abc",
  "orderId": "order_12345",
  "reservationId": "res_xyz789",
  "pointsSpent": 178.00,
  "pointsToEarn": 45.00,
  "action": "SPEND",
  "checkAmount": 890.00,
  "finalCheckAmount": 890.00,
  "restaurantId": "rest_centro",
  "terminalId": "term_001",
  "cashierName": "–ò–≤–∞–Ω–æ–≤–∞ –ê.",
  "paymentTypes": ["CASH", "CARD"]
}

Response 200:
{
  "success": true,
  "transactionId": "txn_abc123",
  "pointsSpent": 178.00,
  "pointsEarned": 45.00,
  "newBalance": 2317.00
}

// ==========================================
// 5. –°–û–ó–î–ê–ù–ò–ï –ì–û–°–¢–Ø
// ==========================================

POST /api/pos-integration/rkeeper/create-guest

Request:
{
  "phone": "+79991234567",
  "name": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
  "birthDate": "1990-05-15"
}

Response 200:
{
  "success": true,
  "guestCardId": "card_new_uuid",
  "code6Digit": "654321"
}

// ==========================================
// 6. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –†–ï–°–¢–û–†–ê–ù–ê
// ==========================================

GET /api/pos-integration/rkeeper/config

Response 200:
{
  "restaurantId": "rest_centro",
  "restaurantName": "–ü–∏—Ü—Ü–µ—Ä–∏—è –£ –ú–∞—Ä–∏–æ - –¶–µ–Ω—Ç—Ä",
  "minCheckAmount": 100.00,
  "maxSpendPercentage": 20,
  "earnRate": 5
}
```


***

## **üîê 8. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨**

### **8.1. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API Key**

```csharp
public class Encryption
{
    private const string SALT = "MaxLoyaltySalt2026";
    
    public static string GetMachineId()
    {
        var sb = new StringBuilder();
        
        // CPU ID
        using (var searcher = new ManagementObjectSearcher("SELECT ProcessorId FROM Win32_Processor"))
        {
            foreach (var obj in searcher.Get())
            {
                sb.Append(obj["ProcessorId"]?.ToString());
            }
        }
        
        // Motherboard Serial
        using (var searcher = new ManagementObjectSearcher("SELECT SerialNumber FROM Win32_BaseBoard"))
        {
            foreach (var obj in searcher.Get())
            {
                sb.Append(obj["SerialNumber"]?.ToString());
            }
        }
        
        // MAC Address
        var nic = NetworkInterface.GetAllNetworkInterfaces()
            .FirstOrDefault(n => n.OperationalStatus == OperationalStatus.Up 
                              && n.NetworkInterfaceType != NetworkInterfaceType.Loopback);
        
        if (nic != null)
        {
            sb.Append(nic.GetPhysicalAddress().ToString());
        }
        
        using var sha256 = SHA256.Create();
        var hash = sha256.ComputeHash(Encoding.UTF8.GetBytes(sb.ToString()));
        return Convert.ToBase64String(hash);
    }
    
    public static string EncryptApiKey(string apiKey, string machineId)
    {
        using var aes = Aes.Create();
        aes.Key = DeriveKey(machineId);
        aes.IV = DeriveIV(machineId);
        
        using var encryptor = aes.CreateEncryptor();
        var plainBytes = Encoding.UTF8.GetBytes(apiKey);
        var encryptedBytes = encryptor.TransformFinalBlock(plainBytes, 0, plainBytes.Length);
        
        return Convert.ToBase64String(encryptedBytes);
    }
    
    public static string DecryptApiKey(string encryptedApiKey, string machineId)
    {
        try
        {
            using var aes = Aes.Create();
            aes.Key = DeriveKey(machineId);
            aes.IV = DeriveIV(machineId);
            
            using var decryptor = aes.CreateDecryptor();
            var encryptedBytes = Convert.FromBase64String(encryptedApiKey);
            var decryptedBytes = decryptor.TransformFinalBlock(encryptedBytes, 0, encryptedBytes.Length);
            
            return Encoding.UTF8.GetString(decryptedBytes);
        }
        catch (Exception ex)
        {
            throw new CryptographicException("Failed to decrypt API Key", ex);
        }
    }
}
```


***

## **üì¥ 9. OFFLINE –†–ï–ñ–ò–ú**

### **9.1. OfflineQueueService.cs**

```csharp
public class OfflineQueueService : IOfflineQueueService
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly ISharedMemoryService sharedMemory;
    private readonly ILogger<OfflineQueueService> logger;
    private readonly string queueFilePath;
    private const int MaxQueueSize = 100;
    private const int TtlHours = 24;
    
    public async Task EnqueueAsync(OfflineOperation operation)
    {
        var queue = await LoadQueueAsync();
        
        if (queue.Count >= MaxQueueSize)
        {
            logger.LogWarning("Offline queue is full ({Count}), removing oldest", queue.Count);
            queue.RemoveAt(0);
        }
        
        operation.Id = Guid.NewGuid().ToString();
        operation.QueuedAt = DateTime.UtcNow;
        operation.Attempts = 0;
        
        queue.Add(operation);
        await SaveQueueAsync(queue);
        
        await sharedMemory.EnqueueOfflineOperationAsync(operation);
        
        logger.LogWarning("Operation queued offline: Type={Type}, OrderId={OrderId}",
            operation.Type, operation.OrderId);
    }
    
    public async Task ProcessQueueAsync()
    {
        var queue = await LoadQueueAsync();
        
        if (queue.Count == 0)
        {
            logger.LogDebug("Offline queue is empty");
            return;
        }
        
        logger.LogInformation("Processing offline queue: {Count} operations", queue.Count);
        
        var processed = new List<OfflineOperation>();
        
        foreach (var operation in queue)
        {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ TTL
            if (DateTime.UtcNow - operation.QueuedAt > TimeSpan.FromHours(TtlHours))
            {
                logger.LogWarning("Operation expired: {Id}", operation.Id);
                processed.Add(operation);
                continue;
            }
            
            try
            {
                var success = await ProcessOperationAsync(operation);
                
                if (success)
                {
                    processed.Add(operation);
                    logger.LogInformation("Processed offline operation: {Id}", operation.Id);
                }
                else
                {
                    operation.Attempts++;
                    if (operation.Attempts >= 5)
                    {
                        logger.LogError("Operation failed after 5 attempts: {Id}", operation.Id);
                        processed.Add(operation);
                    }
                }
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "Error processing offline operation: {Id}", operation.Id);
                operation.Attempts++;
            }
        }
        
        queue = queue.Except(processed).ToList();
        await SaveQueueAsync(queue);
        
        if (processed.Count > 0)
        {
            ShowNotification($"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {processed.Count} –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ –æ—á–µ—Ä–µ–¥–∏");
        }
    }
}
```


***

## **üéØ 10. –ò–¢–û–ì–û–í–ê–Ø –°–•–ï–ú–ê –†–ê–ë–û–¢–´**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     R-KEEPER CASH STATION                          ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ  1Ô∏è‚É£ –ö–∞—Å—Å–∏—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∑–∞–∫–∞–∑                                        ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ     ‚îÇ –ó–∞–∫–∞–∑: –°—Ç–æ–ª 5                                ‚îÇ              ‚îÇ
‚îÇ     ‚îÇ ‚Ä¢ –ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞    500‚ÇΩ                    ‚îÇ              ‚îÇ
‚îÇ     ‚îÇ ‚Ä¢ Coca-Cola 0.5–ª     200‚ÇΩ                    ‚îÇ              ‚îÇ
‚îÇ     ‚îÇ ‚Ä¢ –°–∞–ª–∞—Ç –¶–µ–∑–∞—Ä—å       350‚ÇΩ                    ‚îÇ              ‚îÇ
‚îÇ     ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                   ‚îÇ              ‚îÇ
‚îÇ     ‚îÇ –ò–¢–û–ì–û:             1,050‚ÇΩ                    ‚îÇ              ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ  2Ô∏è‚É£ –í–∏–¥–∏—Ç Floating Button                                         ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                        ‚îÇ
‚îÇ     ‚îÇ ML ‚îÇ üü¢ ‚Üê Floating Button (–≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö)                  ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                        ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ  3Ô∏è‚É£ –ö–ª–∏–∫–∞–µ—Ç ‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –≥–æ—Å—Ç—è                      ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ     ‚îÇ MAX LOYALTY                                  ‚îÇ              ‚îÇ
‚îÇ     ‚îÇ +7 999 123 45 67                            ‚îÇ              ‚îÇ
‚îÇ     ‚îÇ [OK] [–°–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç—è]                        ‚îÇ              ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ            ‚ñº                                                      ‚îÇ
‚îÇ     Backend API: SearchGuest()                                    ‚îÇ
‚îÇ            ‚ñº                                                      ‚îÇ
‚îÇ     Backend API: Calculate()                                      ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ  4Ô∏è‚É£ –í–∏–¥–∏—Ç –æ–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–±–∞–ª–ª—ã/—Å–∫–∏–¥–∫–∞)                           ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ     ‚îÇ –°–ü–ò–°–ê–ù–ò–ï –ë–ê–õ–õ–û–í                              ‚îÇ              ‚îÇ
‚îÇ     ‚îÇ –ë–∞–ª–∞–Ω—Å: 2,450‚ÇΩ                               ‚îÇ              ‚îÇ
‚îÇ     ‚îÇ –°–ø–∏—Å–∞—Ç—å: [^19_210]‚ÇΩ                              ‚îÇ              ‚îÇ
‚îÇ     ‚îÇ [üí≥ –°–ü–ò–°–ê–¢–¨ –ë–ê–õ–õ–´]                          ‚îÇ              ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ            ‚ñº                                                      ‚îÇ
‚îÇ     Backend API: ReservePoints()                                  ‚îÇ
‚îÇ            ‚ñº                                                      ‚îÇ
‚îÇ     XML API: BindCardToOrder()                                    ‚îÇ
‚îÇ            ‚ñº                                                      ‚îÇ
‚îÇ     XML API: ApplyManualDiscount()                                ‚îÇ
‚îÇ            ‚ñº                                                      ‚îÇ
‚îÇ     Shared Memory: SaveOrderContext()                             ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ  5Ô∏è‚É£ –í –∑–∞–∫–∞–∑–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å–∫–∏–¥–∫–∞                                 ‚îÇ
‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ     ‚îÇ –ó–∞–∫–∞–∑: –°—Ç–æ–ª 5                                ‚îÇ              ‚îÇ
‚îÇ     ‚îÇ –¢–æ–≤–∞—Ä—ã:                    1,050‚ÇΩ           ‚îÇ              ‚îÇ
‚îÇ     ‚îÇ Max Loyalty - –ë–∞–ª–ª—ã         -210‚ÇΩ           ‚îÇ ‚Üê –°–∫–∏–¥–∫–∞     ‚îÇ
‚îÇ     ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                   ‚îÇ              ‚îÇ
‚îÇ     ‚îÇ –ö –û–ü–õ–ê–¢–ï:                   840‚ÇΩ            ‚îÇ              ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ  6Ô∏è‚É£ –ö–∞—Å—Å–∏—Ä –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —á–µ–∫ (–æ–ø–ª–∞—Ç–∞)                                ‚îÇ
‚îÇ            ‚ñº                                                      ‚îÇ
‚îÇ     FarCard ‚Üí DLL: FinalizeTransaction()                          ‚îÇ
‚îÇ            ‚ñº                                                      ‚îÇ
‚îÇ     Backend API: FinalizePoints()                                 ‚îÇ
‚îÇ            ‚ñº                                                      ‚îÇ
‚îÇ     ‚úÖ –°–ø–∏—Å–∞–Ω–æ 210‚ÇΩ –±–∞–ª–ª–æ–≤                                       ‚îÇ
‚îÇ     ‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ +42 –±–∞–ª–ª–∞                                       ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## **‚úÖ –ß–ï–ö–õ–ò–°–¢ –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–ò**

### **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

- ‚úÖ –ü–æ–∏—Å–∫ –≥–æ—Å—Ç—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É/6-digit –∫–æ–¥—É
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è —Å –∫–∞—Å—Å—ã
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ POINTS (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ DISCOUNT (—Å–∫–∏–¥–æ—á–Ω–∞—è)
- ‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ —á–µ—Ä–µ–∑ —Ä—É—á–Ω—É—é —Å–∫–∏–¥–∫—É
- ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–π —Å–∫–∏–¥–∫–∏
- ‚úÖ –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ (EarnOnly)
- ‚úÖ –û—Ç–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã
- ‚úÖ –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è + –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ Floating Button (–≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö)


### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**

- ‚úÖ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API Key (AES-256)
- ‚úÖ Machine-binding
- ‚úÖ Revoke —á–µ—Ä–µ–∑ backend
- ‚úÖ HTTPS only


### **Offline —Ä–µ–∂–∏–º:**

- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ offline
- ‚úÖ Queue –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π (100 –º–∞–∫—Å, TTL 24—á)
- ‚úÖ –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è


### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**

- ‚úÖ Structured logging (Serilog)
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –Ω–∞ backend
- ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —ç–∫—Ä–∞–Ω
- ‚úÖ Health checks


### **DevOps:**

- ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π installer (NSIS)
- ‚úÖ –ê–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ FarCard
- ‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ Uninstaller

***

## **üìã –ò–¢–û–ì–û**

**–ü–ª–∞–≥–∏–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!**

–ß—Ç–æ –Ω—É–∂–Ω–æ:

1. ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ (DLL + UI + Shared Memory)
2. ‚úÖ UI/UX —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω (Floating Button + –æ–∫–Ω–∞)
3. ‚úÖ API endpoints –æ–ø–∏—Å–∞–Ω—ã
4. ‚úÖ FarCard –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞
5. ‚úÖ XML API –∫–ª–∏–µ–Ω—Ç –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
6. ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–æ–¥—É–º–∞–Ω–∞
7. ‚úÖ Offline —Ä–µ–∂–∏–º —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
8. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–ì–æ—Ç–æ–≤–æ –∫ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏! üöÄ**
<span style="display:none">[^19_1]</span>

<div align="center">‚ÅÇ</div>

[^19_1]: Plagin-iiko.md

