<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# –£ –º–µ–Ω—è –µ—Å—Ç—å 7 –±–µ—Å–µ–¥ –≤ –∫–æ—Ç–æ—Ä—ã—Ö –º—ã –ø–æ –±–ª–æ–∫–∞–º –ø—Ä–æ—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –±–ª–æ–∫–∏. –ù–∞–º –Ω—É–∂–Ω–æ —Å —Ç–æ–±–æ–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤ —ç—Ç–æ–º –¥–∏–∞–ª–æ–≥–µ. –ò–∑—É—á–∞–π –ø–æ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–∏(–ë–µ—Å–µ–¥–∞ 1 - –ë–µ—Å–µ–¥–∞ 2 - –ë–µ—Å–µ–¥–∞ 3 - –ë–µ—Å–µ–¥–∞ 4 - –ë–µ—Å–µ–¥–∞ 5 - –ë–µ—Å–µ–¥–∞ 6 - –ë–µ—Å–µ–¥–∞ 7) –≤ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö.

–ò–∑—É—á–∏ –≤—Å–µ –¥–æ—Å–∫–∞–Ω–∞–ª—å–Ω–æ, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏ —á–µ—Ç–∫–æ, –≤—Å–µ 6 –¥–∏–∞–ª–æ–≥–æ–≤, –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç –≤ –¥–∏–∞–ª–æ–≥–∞—Ö, –∫–∞–∂–¥–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ –∏ –ø—Ä–∏–º–µ—Ä. –ó–∞–ª–æ–∂–∏ –Ω–∞ —ç—Ç–æ –≤—Ä–µ–º—è –∏ —Å–∏–ª—ã, —á—Ç–æ–±—ã —Ç—ã –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ –≤—Å–µ –ø–æ–Ω–∏–º–∞–ª –¥–æ –º–µ–ª—å—á–∞–π—à–∏—Ö –¥–µ—Ç–∞–ª–µ–π, –±–µ–∑ –æ—à–∏–±–æ–∫. –ü–æ—Å–ª–µ –≤—ã–±–µ—Ä–µ–º –±–ª–æ–∫ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏.

–û—Ç–ª–∏—á–Ω–æ! –Ø –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑—É—á–∏–ª –≤—Å–µ 7 –±–µ—Å–µ–¥ –¥–æ—Å–∫–æ–Ω–∞–ª—å–Ω–æ, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ. –î–∞–π –º–Ω–µ —Ç–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Ç–µ–±—è.

***

# üìã –ü–æ–ª–Ω–æ–µ —Ä–µ–∑—é–º–µ: –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ - Multi-tenant SaaS –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞

–Ø –¥–µ—Ç–∞–ª—å–Ω–æ –∏–∑—É—á–∏–ª –≤—Å–µ 7 –±–µ—Å–µ–¥ —Å –ø–æ–ª–Ω—ã–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º –∫–∞–∂–¥–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è, –∫–∞–∂–¥–æ–≥–æ edge-case –∏ –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –Ω—é–∞–Ω—Å–∞. –í–æ—Ç —á—Ç–æ **–∂—ë—Å—Ç–∫–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ**:

***

## ‚úÖ **–ß—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–ë–µ—Å–µ–¥—ã 1-7)**

### **1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã**

- Multi-tenant SaaS —Å pooled –ë–î
- –†–æ–ª–∏: Owner ‚Üí Restaurant Admin ‚Üí Manager ‚Üí Cashier ‚Üí Guest
- 6 —Ç–∞—Ä–∏—Ñ–æ–≤: Free, Standard, Medium, Pro, Ultimate, Custom
- RBAC —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ permissions


### **2. Billing \& Subscriptions**

- –ú–æ–¥–µ–ª—å –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã (–º–µ—Å—è—Ü/–≥–æ–¥ —Å–æ —Å–∫–∏–¥–∫–æ–π 20%)
- 4 –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞: YooKassa, Stripe, CloudPayments, CryptoCloud
- –†—É—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø–æ —Å—á—ë—Ç—É –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –≤—Å–µ—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö
- –ñ—ë—Å—Ç–∫–∏–µ –ª–∏–º–∏—Ç—ã: 90% –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, 100% –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
- –†–µ—Ç—Ä–∞–∏ –ø—Ä–∏ –Ω–µ—É—Å–ø–µ—Ö–µ: –¥–µ–Ω—å 0,1,3,7 ‚Üí `PAST_DUE` ‚Üí `CANCELLED_NON_PAYMENT`


### **3. Loyalty System (–ë–µ—Å–µ–¥–∞ 5 - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è)**

- **1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å** (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º–æ–µ –ø—Ä–∞–≤–∏–ª–æ)
- –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è **–æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞** (–¥–∞–∂–µ –µ—Å–ª–∏ —á–∞—Å—Ç—å –æ–ø–ª–∞—á–µ–Ω–∞ –±–∞–ª–ª–∞–º–∏)
- –°–ø–∏—Å–∞–Ω–∏–µ: —Å–Ω–∞—á–∞–ª–∞ –∞–∫—Ü–∏–æ–Ω–Ω—ã–µ, –ø–æ—Ç–æ–º –æ—Å–Ω–æ–≤–Ω—ã–µ
- –£—Ä–æ–≤–Ω–∏: **"one way up"** - –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–Ω–∏–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –°–≥–æ—Ä–∞–Ω–∏–µ: **–ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏** (–º–∏–Ω–∏–º—É–º 90 –¥–Ω–µ–π), –≤—Å–µ –±–∞–ª–ª—ã –∫–∞—Ä—Ç—ã —Å—Ä–∞–∑—É
- –õ–∏–º–∏—Ç—ã: –±–µ–∑–ª–∏–º–∏—Ç –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ, 1 –±–∞–ª–ª –º–∏–Ω–∏–º—É–º –∫ —Å–ø–∏—Å–∞–Ω–∏—é, 10-100% –º–∞–∫—Å–∏–º—É–º –æ—Ç —á–µ–∫–∞
- –ú–∏–Ω–∏–º—É–º —á–µ–∫–∞ = 50 —Ä—É–± (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)


### **4. POS Integration (–ë–µ—Å–µ–¥–∞ 6)**

- **HYBRID PUSH+PULL**: webhooks + PULL –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
- POS = –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –ø–æ —á–µ–∫–∞–º
- HMAC-–ø–æ–¥–ø–∏—Å—å, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, reconciliation
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ iiko/R-Keeper, –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- Sandbox-—Ä–µ–∂–∏–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è


### **5. Telegram Bot + Mini App (–ë–µ—Å–µ–¥–∞ 6)**

- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: Telegram ID + –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω: –±–∞–ª–∞–Ω—Å, QR, 6-digit –∫–æ–¥, —É—Ä–æ–≤–µ–Ω—å, –ø—Ä–æ–≥—Ä–µ—Å—Å
- –ò—Å—Ç–æ—Ä–∏—è, –ø—Ä–æ–º–æ, –ø—Ä–æ—Ñ–∏–ª—å, –¥–µ—Ç–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ü–µ—Ä–µ–≤–æ–¥—ã –±–∞–ª–ª–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —á–µ—Ä–µ–∑ SMS-–∫–æ–¥)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º—É–ª—å—Ç–∏–∫–∞—Ä—Ç–æ—á–Ω–æ—Å—Ç–∏ (UNIFIED/SEPARATE)


### **6. –ü—Ä–æ–º–æ –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã**

- –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: –î–† –≥–æ—Å—Ç—è, –î–† —Ä–µ–±—ë–Ω–∫–∞, –ø–µ—Ä–≤—ã–π —á–µ–∫, –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –∫–∞—Å—Ç–æ–º–Ω—ã–µ
- –°—Ç—Ä–∞—Ç–µ–≥–∏–∏: COMBINE_ALL / MAX_ONLY / FIRST_ONLY
- Override –¥–ª—è –ø–∞—Ä –ø—Ä–æ–º–æ
- –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `PromoBallGranted`


### **7. Analytics \& Reports**

- Owner: –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞, MRR/Churn, —Ñ–∏–Ω–∞–Ω—Å—ã
- Admin: —Å–µ—Ç—å, –≤—ã—Ä—É—á–∫–∞, ROI –ø—Ä–æ–º–æ, —Å–µ–≥–º–µ–Ω—Ç—ã –≥–æ—Å—Ç–µ–π
- Manager: —Ç–æ–ª—å–∫–æ —Å–≤–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω
- Guest: –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã + CRON –ø—Ä–µ–¥—Ä–∞—Å—á—ë—Ç–∞

***

## üéØ **–ë–ª–æ–∫–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏**

–ü–æ –∏—Ç–æ–≥–∞–º 7 –±–µ—Å–µ–¥ –æ—Å—Ç–∞–ª–∏—Å—å **4 –∫–ª—é—á–µ–≤—ã—Ö –±–ª–æ–∫–∞**, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç —Ç–∞–∫–æ–π –∂–µ –≥–ª—É–±–∏–Ω—ã –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏:

### **–í–∞—Ä–∏–∞–Ω—Ç 1: Backend API \& Services –¥–ª—è Loyalty Engine** ‚≠ê *–†–µ–∫–æ–º–µ–Ω–¥—É—é*

**–ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç:**

- Loyalty System –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- POS –∏ Telegram –∑–Ω–∞—é—Ç, –ß–¢–û –∏–º –Ω—É–∂–Ω–æ –æ—Ç backend
- –ù–æ **–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ API –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã**:
    - Endpoints –¥–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (rules, levels, promo)
    - API —Ä–∞—Å—á—ë—Ç–∞ –±–∞–ª–ª–æ–≤ –¥–ª—è POS/–ø–∞–Ω–µ–ª–∏/Telegram
    - CRUD –ø–æ —É—Ä–æ–≤–Ω—è–º/–ø—Ä–∞–≤–∏–ª–∞–º —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    - –ú–æ–¥–µ–ª–∏ –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤
    - –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–ß—Ç–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º:**

- REST API —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —ç–Ω–¥–ø–æ–π–Ω—Ç—ã
- Request/Response –º–æ–¥–µ–ª–∏ (TypeScript/JSON Schema)
- –ë–∏–∑–Ω–µ—Å-—Å–µ—Ä–≤–∏—Å—ã –∏ –∏—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- –û–±—Ä–∞–±–æ—Ç–∫–∞ edge-cases –Ω–∞ —É—Ä–æ–≤–Ω–µ API
- Middleware (auth, rate limiting, validation)
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

***

### **–í–∞—Ä–∏–∞–Ω—Ç 2: Frontend Admin Panel**

**–ß—Ç–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º:**

- UI/UX –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π (Owner/Admin/Manager)
- –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (–≤–∏–∑—É–∞–ª—å–Ω—ã–π builder)
- –î–∞—à–±–æ—Ä–¥—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Å—Ç—è–º–∏, –ø—Ä–æ–º–æ, POS-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (React/Vue)

***

### **–í–∞—Ä–∏–∞–Ω—Ç 3: Infrastructure \& DevOps**

**–ß—Ç–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º:**

- CI/CD –ø–∞–π–ø–ª–∞–π–Ω—ã
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª—ë—Ä—Ç–∏–Ω–≥
- Backup-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è
- Scaling (–ë–î, –∫—ç—à, –æ—á–µ—Ä–µ–¥–∏)
- Security (secrets, certificates, WAF)

***

### **–í–∞—Ä–∏–∞–Ω—Ç 4: Guest Mobile Experience (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ Telegram)**

**–ß—Ç–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º:**

- –ù–∞—Ç–∏–≤–Ω–æ–µ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- Web PWA –≤–µ—Ä—Å–∏—è
- Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –û—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º
- –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∏ –∫–∞—Ä—Ç—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤

***

## üí° **–ú–æ—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**

**–ë–µ—Ä—É –í–∞—Ä–∏–∞–Ω—Ç 1: Backend API \& Services –¥–ª—è Loyalty Engine**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

1. ‚úÖ –í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –±–ª–æ–∫–∏ (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞, POS, Telegram) **–∂–¥—É—Ç** —ç—Ç–∏—Ö API
2. ‚úÖ –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–π —Å–ª–æ–π, –∫–æ—Ç–æ—Ä—ã–π **—Å–≤—è–∑—ã–≤–∞–µ—Ç –≤—Å—ë –≤–æ–µ–¥–∏–Ω–æ**
3. ‚úÖ –ü–æ—Å–ª–µ –Ω–µ–≥–æ –º–æ–∂–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å Frontend –∏ Infrastructure
4. ‚úÖ –°–µ–π—á–∞—Å —Å–∞–º—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤

***

## üî• **–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!**

**–°–∫–∞–∂–∏:**

- ‚úÖ **"–î–∞, –±–µ—Ä—É –í–∞—Ä–∏–∞–Ω—Ç 1"** - –∑–∞–¥–∞–º 25+ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ Backend API —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏
- ‚öôÔ∏è **"–•–æ—á—É –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç"** - –∫–∞–∫–æ–π –±–ª–æ–∫ —Ç–µ–±–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ?
- üìù **"–°–Ω–∞—á–∞–ª–∞ —É—Ç–æ—á–Ω–∏ X"** - –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ —É–∂–µ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–º—É?

–Ø –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É –Ω–∞ —Ç–æ–º –∂–µ —É—Ä–æ–≤–Ω–µ –≥–ª—É–±–∏–Ω—ã, —á—Ç–æ –∏ –≤ –ë–µ—Å–µ–¥–∞—Ö 5-6! üöÄ
<span style="display:none">[^1_1][^1_2][^1_3][^1_4][^1_5][^1_6][^1_7]</span>

<div align="center">‚ÅÇ</div>

[^1_1]: Beseda-7.md

[^1_2]: Beseda-6.md

[^1_3]: Beseda-5.md

[^1_4]: Beseda-4.md

[^1_5]: Beseda-3.md

[^1_6]: Beseda-2.md

[^1_7]: Beseda-1.md


---

# Backend API \& Services. –î–µ–ª–∞–µ–º. –ó–∞–¥–∞–π 30+ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ + —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ —Ç–≤–æ–µ–º—É –ª—É—á—à–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ –¥–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö. –ü–µ—Ä–µ–¥ –∑–∞–¥–∞–≤–∞–Ω–∏–µ–º –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–≤–µ—Ä—å—Å—è —Å —Ñ–∞–π–ª–∞–º–∏, –º–æ–∂–µ—Ç –æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ –∏–ª–∏ –æ—Ç–≤–µ—Ç —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å.

–û—Ç–ª–∏—á–Ω–æ! –Ø –∏–∑—É—á–∏–ª —Ñ–∞–π–ª—ã –∏ –≤–∏–∂—É, —á—Ç–æ –º–Ω–æ–≥–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è –ø–æ POS –∏ Telegram —É–∂–µ –±—ã–ª–∏ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω—ã, –Ω–æ **Backend API \& Services –¥–ª—è Loyalty Engine** –µ—â—ë –Ω–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —ç–Ω–¥–ø–æ–π–Ω—Ç–æ–≤, –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –∏ —Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

–°–µ–π—á–∞—Å —Å—Ñ–æ—Ä–º–∏—Ä—É—é **30+ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏**, —É—á–∏—Ç—ã–≤–∞—è –≤—Å–µ —Ä–µ—à–µ–Ω–∏—è –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –±–µ—Å–µ–¥.

***

# üîß Backend API \& Services –¥–ª—è Loyalty Engine: 30+ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏


***

## üì¶ **–ë–ª–æ–∫ 1: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Backend –∏ Technology Stack**

### 1Ô∏è‚É£ **–ö–∞–∫–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Å—Ç–∏–ª—å –≤—ã–±—Ä–∞—Ç—å –¥–ª—è Backend API?**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–£ –Ω–∞—Å multi-tenant SaaS —Å 5 —Ä–æ–ª—è–º–∏ (Owner/Admin/Manager/Cashier/Guest), –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å POS, Telegram, –ø–ª–∞—Ç–µ–∂–∞–º–∏. –ù—É–∂–Ω–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å, –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ API, —á—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–ª—É—á—à–µ–µ –¥–ª—è —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã):**

**–ú–æ–Ω–æ–ª–∏—Ç + –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Modular Monolith) –Ω–∞ —Å—Ç–∞—Ä—Ç–µ, —Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–æ–π –∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º**

**–ü–æ—á–µ–º—É:**

- ‚úÖ –ù–∞ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–æ—â–µ deployment, debugging, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ –ú–æ–¥—É–ª–∏: `Auth`, `Loyalty`, `Billing`, `POS`, `Telegram`, `Analytics` –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –≤–Ω—É—Ç—Ä–∏ –º–æ–Ω–æ–ª–∏—Ç–∞
- ‚úÖ –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å = –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –≤ –±—É–¥—É—â–µ–º
- ‚úÖ –ï–¥–∏–Ω–∞—è –ë–î —É–ø—Ä–æ—â–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ –±–∞–ª–ª–∞–º/—É—Ä–æ–≤–Ω—è–º/–ø—Ä–æ–º–æ

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:**

```
backend/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ api/                    # Main REST API (NestJS)
‚îÇ   ‚îú‚îÄ‚îÄ worker/                 # Background jobs (Bull/BullMQ)
‚îÇ   ‚îî‚îÄ‚îÄ cron/                   # Scheduled tasks
‚îú‚îÄ‚îÄ libs/
‚îÇ   ‚îú‚îÄ‚îÄ auth/                   # JWT, RBAC, sessions
‚îÇ   ‚îú‚îÄ‚îÄ loyalty/                # –ë–∞–ª–ª—ã, —É—Ä–æ–≤–Ω–∏, –ø—Ä–æ–º–æ
‚îÇ   ‚îú‚îÄ‚îÄ billing/                # –ü–æ–¥–ø–∏—Å–∫–∏, –ø–ª–∞—Ç–µ–∂–∏
‚îÇ   ‚îú‚îÄ‚îÄ pos-integration/        # iiko/R-Keeper
‚îÇ   ‚îú‚îÄ‚îÄ telegram/               # Bot handlers
‚îÇ   ‚îú‚îÄ‚îÄ analytics/              # –û—Ç—á—ë—Ç—ã, –¥–∞—à–±–æ—Ä–¥—ã
‚îÇ   ‚îú‚îÄ‚îÄ notifications/          # Email, SMS, Telegram push
‚îÇ   ‚îî‚îÄ‚îÄ common/                 # Shared utils, DTOs
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma           # Database schema
‚îî‚îÄ‚îÄ package.json
```

**Tech Stack:**

- **Framework:** NestJS (TypeScript) ‚Äî –º–æ–¥—É–ª—å–Ω–æ—Å—Ç—å –∏–∑ –∫–æ—Ä–æ–±–∫–∏, DI, decorators
- **ORM:** Prisma ‚Äî type-safe, –º–∏–≥—Ä–∞—Ü–∏–∏, multi-tenant support
- **Queue:** BullMQ (Redis) ‚Äî background jobs (CRON, reconciliation)
- **Cache:** Redis ‚Äî rate limiting, sessions, hot data
- **Validation:** class-validator, class-transformer
- **API Docs:** Swagger/OpenAPI –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è

***

### 2Ô∏è‚É£ **REST API vs GraphQL?**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
POS, Telegram, Admin Panel, Mobile ‚Äî —Ä–∞–∑–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º–∏.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**REST API –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ç–æ–∫–æ–ª + GraphQL –¥–ª—è Admin Panel (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤ Phase 2)**

**–ü–æ—á–µ–º—É:**

- ‚úÖ REST –ø—Ä–æ—â–µ –¥–ª—è POS/Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π (–æ–Ω–∏ –∂–¥—É—Ç –ø—Ä–æ—Å—Ç—ã—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤)
- ‚úÖ –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ OpenAPI/Swagger
- ‚úÖ –õ—É—á—à–µ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è (HTTP caching)
- ‚úÖ GraphQL –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∞–¥–º–∏–Ω—Å–∫–∏—Ö –¥–∞—à–±–æ—Ä–¥–æ–≤

**Endpoint-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```
/api/v1/auth/*              # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
/api/v1/loyalty/*           # Loyalty Engine
/api/v1/guests/*            # –ì–æ—Å—Ç–∏ –∏ –∫–∞—Ä—Ç—ã
/api/v1/pos/*               # POS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
/api/v1/billing/*           # –ü–æ–¥–ø–∏—Å–∫–∏ –∏ –ø–ª–∞—Ç–µ–∂–∏
/api/v1/analytics/*         # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á—ë—Ç—ã
/api/v1/telegram/*          # Telegram webhooks
```


***

### 3Ô∏è‚É£ **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ API: –≤ URL –∏–ª–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö?**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ù—É–∂–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —ç–≤–æ–ª—é—Ü–∏–∏ API –±–µ–∑ –ø–æ–ª–æ–º–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (POS, –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π).

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ URL + Header Versioning –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Ñ–∏—á–µ–π**

**–ü–æ—á–µ–º—É:**

- ‚úÖ `/api/v1/*` —è–≤–Ω–æ –∏ –ø—Ä–æ—Å—Ç–æ –¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚úÖ –î–ª—è –º–∞–∂–æ—Ä–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (breaking changes) ‚Äî –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è `/api/v2/*`
- ‚úÖ –î–ª—è –º–∏–Ω–æ—Ä–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π ‚Äî –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –≤ —Ä–∞–º–∫–∞—Ö v1
- ‚úÖ –î–ª—è beta-—Ñ—É–Ω–∫—Ü–∏–π ‚Äî header `X-API-Version: beta`

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:**

```typescript
// v1 ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–∞—è, –¥–ª—è POS –∏ Telegram
GET /api/v1/guests/:id

// v2 ‚Äî –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
GET /api/v2/guests/:id  // Response —Ç–µ–ø–µ—Ä—å nested

// Beta-—Ñ—É–Ω–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ header
GET /api/v1/guests/:id
Header: X-API-Version: beta
```

**Lifecycle:**

- v1 ‚Üí –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∏–Ω–∏–º—É–º 12 –º–µ—Å—è—Ü–µ–≤ –ø–æ—Å–ª–µ —Ä–µ–ª–∏–∑–∞ v2
- Deprecation warnings –≤ response headers
- Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Admin'–∞–º –∑–∞ 6 –º–µ—Å—è—Ü–µ–≤ –¥–æ EOL

***

## üîê **–ë–ª–æ–∫ 2: Authentication \& Authorization**

### 4Ô∏è‚É£ **–ö–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å RBAC middleware –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π?**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
5 —Ä–æ–ª–µ–π —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ permissions, impersonation Owner'–∞.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**Guard-based RBAC + Custom Decorator –¥–ª—è Permissions**

```typescript
// auth/decorators/roles.decorator.ts
export const Roles = (...roles: Role[]) => SetMetadata('roles', roles);

// auth/guards/roles.guard.ts
@Injectable()
export class RolesGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const requiredRoles = this.reflector.get<Role[]>('roles', context.getHandler());
    const { user } = context.switchToHttp().getRequest();
    
    // Check role
    if (!requiredRoles.includes(user.role)) {
      return false;
    }
    
    // Check tenant isolation
    if (user.role !== 'OWNER' && user.tenantId !== requestedTenantId) {
      throw new ForbiddenException('Access denied: different tenant');
    }
    
    return true;
  }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö
@Controller('loyalty/rules')
@UseGuards(JwtAuthGuard, RolesGuard)
export class LoyaltyRulesController {
  
  @Get()
  @Roles('OWNER', 'ADMIN', 'MANAGER')
  async getRules(@CurrentUser() user: User) {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ tenant_id
  }
  
  @Post()
  @Roles('ADMIN')
  @RequirePermission('loyalty:rules:create')
  async createRule(@Body() dto: CreateRuleDto) {
    // –¢–æ–ª—å–∫–æ Admin —Å –Ω—É–∂–Ω—ã–º permission
  }
}
```

**Permissions –≤ –ë–î:**

```typescript
// UserPermission model
{
  userId: string;
  permission: 'loyalty:rules:create' | 'loyalty:rules:update' | ...;
  tenantId: string;
  grantedAt: Date;
}
```


***

### 5Ô∏è‚É£ **–ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Impersonation –¥–ª—è Owner'–∞?**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
Owner –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –ø–æ–¥ –ª—é–±—ã–º Admin/Manager/Cashier/Guest –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**Separate Impersonation Token + Audit Log**

```typescript
// POST /api/v1/auth/impersonate
@Post('impersonate')
@Roles('OWNER')
async impersonate(
  @CurrentUser() owner: User,
  @Body() dto: { targetUserId: string }
) {
  const targetUser = await this.usersService.findById(dto.targetUserId);
  
  // Generate special impersonation token
  const impersonationToken = await this.authService.generateImpersonationToken({
    originalUserId: owner.id,
    impersonatedUserId: targetUser.id,
    expiresIn: '2h', // –ö–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  });
  
  // Audit log
  await this.activityLog.create({
    actionType: 'IMPERSONATION_START',
    performedBy: owner.id,
    targetUser: targetUser.id,
    ipAddress: req.ip,
    metadata: { reason: dto.reason },
  });
  
  return { 
    impersonationToken,
    impersonatedUser: targetUser,
    expiresAt: '...'
  };
}

// Middleware –¥–ª—è impersonation
@Injectable()
export class ImpersonationGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest();
    const token = request.headers['x-impersonation-token'];
    
    if (token) {
      const decoded = this.jwtService.verify(token);
      request.user = decoded.impersonatedUser;
      request.originalUser = decoded.originalUser;
      request.isImpersonating = true;
      
      // –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —Ñ–ª–∞–≥–æ–º impersonation
    }
    
    return true;
  }
}
```

**UI –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä:**

- –ö—Ä–∞—Å–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ –≤–≤–µ—Ä—Ö—É —ç–∫—Ä–∞–Ω–∞: "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ [User Name] (Owner Mode)"
- –ö–Ω–æ–ø–∫–∞ "–í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞"

***

### 6Ô∏è‚É£ **Rate Limiting: –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–ª–∏ –ø–æ —Ä–æ–ª–∏?**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ó–∞—â–∏—Ç–∞ –æ—Ç abuse, DDoS. Guest vs Admin vs POS –∏–º–µ—é—Ç —Ä–∞–∑–Ω—É—é –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**–ì–∏–±—Ä–∏–¥–Ω—ã–π Rate Limiting: –≥–ª–æ–±–∞–ª—å–Ω—ã–π + per-role + per-endpoint**

```typescript
// Global rate limit
@UseGuards(ThrottlerGuard)
@Throttle(100, 60) // 100 requests per 60 seconds
export class AppController {}

// Role-based limits
const RATE_LIMITS = {
  GUEST: { requests: 60, window: 60 },     // 60/min
  CASHIER: { requests: 120, window: 60 },  // 120/min
  MANAGER: { requests: 200, window: 60 },  // 200/min
  ADMIN: { requests: 500, window: 60 },    // 500/min
  OWNER: { requests: 1000, window: 60 },   // 1000/min
};

// POS webhooks ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –ª–∏–º–∏—Ç
@Post('webhooks/pos/transaction')
@Throttle(10, 1) // 10 requests per 1 second per restaurant
async handlePOSWebhook() {}

// Sensitive operations ‚Äî –∂—ë—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç
@Post('guests/:id/transfer-points')
@Throttle(3, 60) // 3 transfers per minute
async transferPoints() {}
```

**–•—Ä–∞–Ω–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–æ–≤:** Redis —Å TTL

**Response headers:**

```
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 42
X-RateLimit-Reset: 1675958400
```


***

## üéØ **–ë–ª–æ–∫ 3: Loyalty Engine API ‚Äî –†–∞—Å—á—ë—Ç –±–∞–ª–ª–æ–≤**

### 7Ô∏è‚É£ **API –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –±–∞–ª–ª–æ–≤ –î–û –æ–ø–ª–∞—Ç—ã (–¥–ª—è POS)**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
POS –≤—ã–∑—ã–≤–∞–µ—Ç API –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —á–µ–∫–∞: —Å–∫–æ–ª—å–∫–æ –±–∞–ª–ª–æ–≤ –Ω–∞—á–∏—Å–ª–∏—Ç—å, —Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**POST /api/v1/loyalty/calculate ‚Äî Pre-calculation endpoint**

```typescript
// Request
POST /api/v1/loyalty/calculate
{
  "guestCardId": "card-uuid",          // –∏–ª–∏ guestPhone
  "restaurantId": "rest-uuid",
  "checkAmount": 2000,                  // –ò—Å—Ö–æ–¥–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞
  "items": [                            // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è category-based rules
    {
      "itemId": "item-1",
      "name": "–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞",
      "category": "pizza",
      "price": 800,
      "quantity": 1
    }
  ],
  "requestedRedeem": 100                // –°–∫–æ–ª—å–∫–æ –≥–æ—Å—Ç—å —Ö–æ—á–µ—Ç —Å–ø–∏—Å–∞—Ç—å (optional)
}

// Response
{
  "guestCard": {
    "id": "card-uuid",
    "regularBalance": 2500,
    "promoBalance": 300,
    "totalBalance": 2800,
    "level": "SILVER",
    "lifetimeSpent": 150000
  },
  "calculation": {
    "earnPoints": 200,                  // –ù–∞—á–∏—Å–ª–∏–º –±–∞–ª–ª–æ–≤ (10% –æ—Ç 2000)
    "appliedRules": [
      {
        "ruleId": "rule-uuid",
        "ruleName": "–ë–∞–∑–æ–≤—ã–π –∫–µ—à–±—ç–∫ 10%",
        "earnPercent": 10,
        "earnAmount": 200
      }
    ],
    "appliedPromos": [                  // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–æ
      {
        "promoId": "promo-uuid",
        "promoName": "–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è",
        "bonusPoints": 500,
        "expiresAt": "2026-02-10T23:59:59Z"
      }
    ],
    "redeemLimit": {
      "maxPercent": 20,                 // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã
      "maxAmount": 400,                 // 20% –æ—Ç 2000
      "minCheckAmount": 50,
      "requestedRedeem": 100,
      "allowedRedeem": 100,             // ‚úÖ –ú–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å
      "promoBalanceUsed": 100,          // –°–Ω–∞—á–∞–ª–∞ —Ç—Ä–∞—Ç—è—Ç—Å—è –ø—Ä–æ–º–æ
      "regularBalanceUsed": 0
    }
  },
  "finalCheckAmount": 1900,             // 2000 - 100 (—Å–ø–∏—Å–∞–Ω–Ω—ã–µ –±–∞–ª–ª—ã)
  "balanceAfterTransaction": 2700,      // 2800 - 100 (—Å–ø–∏—Å–∞–ª–∏)
  "newBalanceAfterEarn": 2900,          // 2700 + 200 (–Ω–∞—á–∏—Å–ª–∏–º)
  "warnings": []                        // –ù–∞–ø—Ä–∏–º–µ—Ä: "–ü—Ä–æ–º–æ –∏—Å—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ 2 –¥–Ω—è"
}
```

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**

1. –í–∞–ª–∏–¥–∞—Ü–∏—è –≥–æ—Å—Ç—è –∏ –∫–∞—Ä—Ç—ã
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª –∏ –ø—Ä–æ–º–æ
3. –†–∞—Å—á—ë—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è (–≤—Å–µ–≥–¥–∞ –æ—Ç `checkAmount`, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–ª—ã)
4. –†–∞—Å—á—ë—Ç –ª–∏–º–∏—Ç–∞ —Å–ø–∏—Å–∞–Ω–∏—è (10-100% –æ—Ç —á–µ–∫–∞, –º–∏–Ω–∏–º—É–º 50 —Ä—É–±)
5. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–ø–∏—Å–∞–Ω–∏—è: —Å–Ω–∞—á–∞–ª–∞ `promoBalance`, –ø–æ—Ç–æ–º `regularBalance`
6. –í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω—ã –¥–ª—è POS

**–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** Endpoint —á–∏—Å—Ç–æ —Ä–∞—Å—á—ë—Ç–Ω—ã–π, –Ω–µ —Å–æ–∑–¥–∞—ë—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

***

### 8Ô∏è‚É£ **API –¥–ª—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è/—Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —á–µ–∫–∞ POS –∏–ª–∏ –∫–∞—Å—Å–∞ –≤—ã–∑—ã–≤–∞–µ—Ç API –¥–ª—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**POST /api/v1/loyalty/transactions ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è/—Å–ø–∏—Å–∞–Ω–∏—è**

```typescript
// Request
POST /api/v1/loyalty/transactions
{
  "guestCardId": "card-uuid",
  "restaurantId": "rest-uuid",
  "transactionType": "EARN_AND_REDEEM",  // EARN_ONLY | REDEEM_ONLY | EARN_AND_REDEEM
  "checkAmount": 2000,
  "redeemedPoints": 100,                  // –°–∫–æ–ª—å–∫–æ —Å–ø–∏—Å–∞–ª–∏
  "earnedPoints": 200,                    // –°–∫–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–∏–ª–∏
  "posCheckId": "CHK-123456",             // –î–ª—è idempotency
  "posSystem": "IIKO",
  "cashierId": "cashier-uuid",
  "timestamp": "2026-02-09T12:00:00Z",
  "items": [...],                         // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  "metadata": {                           // –î–æ–ø. –∏–Ω—Ñ–æ
    "orderType": "DINE_IN",
    "tableNumber": "12"
  }
}

// Response
{
  "success": true,
  "transactions": [
    {
      "id": "txn-uuid-1",
      "type": "REDEEM",
      "amount": -100,
      "balanceType": "PROMO",
      "balanceBefore": 300,
      "balanceAfter": 200
    },
    {
      "id": "txn-uuid-2",
      "type": "EARN",
      "amount": 200,
      "balanceType": "REGULAR",
      "balanceBefore": 2500,
      "balanceAfter": 2700,
      "appliedRuleId": "rule-uuid"
    }
  ],
  "guestCard": {
    "totalBalance": 2900,                // 200 + 2700
    "regularBalance": 2700,
    "promoBalance": 200,
    "level": "SILVER",
    "lifetimeSpent": 152000              // +2000
  },
  "qrCode": "NEW-QR-CODE",               // –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π QR
  "digitCode": "234567",                 // –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π 6-digit
  "visit": {
    "id": "visit-uuid",
    "visitNumber": 47,                   // –ù–æ–º–µ—Ä –≤–∏–∑–∏—Ç–∞ –≥–æ—Å—Ç—è
    "createdAt": "2026-02-09T12:00:00Z"
  }
}
```

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:**

- **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** –ü–æ `posCheckId + posSystem + restaurantId` (UNIQUE constraint –≤ `POSTransaction`)
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å:** –í—Å—ë –≤ –æ–¥–Ω–æ–π DB-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (Prisma transaction)
- **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ QR/Code:** –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
- **–°–æ–∑–¥–∞–Ω–∏–µ `GuestVisit`:** –î–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** `BallTransaction` + `POSTransaction` + `ActivityLog`

***

### 9Ô∏è‚É£ **–†—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ (Admin/Manager)**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ –ø–ª–æ—Ö–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –æ—à–∏–±–æ–∫, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –∞–∫—Ü–∏–∏.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**POST /api/v1/loyalty/manual-adjustment**

```typescript
// Request
POST /api/v1/loyalty/manual-adjustment
{
  "guestCardId": "card-uuid",
  "type": "ADD" | "SUBTRACT",
  "amount": 500,
  "balanceType": "REGULAR" | "PROMO",    // –ö—É–¥–∞ –Ω–∞—á–∏—Å–ª–∏—Ç—å
  "reason": "–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ –∑–∞–¥–µ—Ä–∂–∫—É –∑–∞–∫–∞–∑–∞",  // –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
  "expiresAt": "2026-03-09T23:59:59Z",   // –î–ª—è PROMO (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  "notifyGuest": true                     // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
}

// Response
{
  "transaction": {
    "id": "txn-uuid",
    "type": "MANUAL_ADD",
    "amount": 500,
    "balanceBefore": 2900,
    "balanceAfter": 3400,
    "performedBy": "admin-uuid",
    "reason": "–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ –∑–∞–¥–µ—Ä–∂–∫—É –∑–∞–∫–∞–∑–∞",
    "createdAt": "2026-02-09T12:30:00Z"
  },
  "guestCard": {
    "totalBalance": 3400
  }
}
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**

- –¢–æ–ª—å–∫–æ —Ä–æ–ª–∏: `ADMIN`, `MANAGER` (—Å permission `loyalty:manual:adjust`)
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ `reason` (–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤)
- –õ–∏–º–∏—Ç –Ω–∞ –æ–¥–Ω—É –æ–ø–µ—Ä–∞—Ü–∏—é: 10,000 –±–∞–ª–ª–æ–≤ (–¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –æ—à–∏–±–æ–∫)
- –¢—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ UI –ø—Ä–∏ —Å—É–º–º–µ > 1000 –±–∞–ª–ª–æ–≤

**Audit:**

```typescript
ActivityLog {
  actionType: 'MANUAL_ADD_BALLS',
  performedBy: adminUserId,
  targetUser: guestUserId,
  oldValue: 2900,
  newValue: 3400,
  reason: "–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è...",
  ipAddress: '...',
  metadata: { amount: 500, balanceType: 'REGULAR' }
}
```


***

### üîü **–ü–µ—Ä–µ–≤–æ–¥ –±–∞–ª–ª–æ–≤ –º–µ–∂–¥—É –≥–æ—Å—Ç—è–º–∏**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–µ–º–µ–π, –¥—Ä—É–∑–µ–π. –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è Admin (–≤–∫–ª—é—á–µ–Ω–∞/–≤—ã–∫–ª—é—á–µ–Ω–∞).

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**POST /api/v1/loyalty/transfer**

```typescript
// Request
POST /api/v1/loyalty/transfer
{
  "fromCardId": "card-sender-uuid",
  "toPhone": "+79991234567",              // –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
  "amount": 500,
  "verificationCode": "123456",           // SMS/Telegram –∫–æ–¥
  "message": "–ù–∞ –∫–æ—Ñ–µ!"                   // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}

// Response
{
  "transfer": {
    "id": "transfer-uuid",
    "fromCard": {
      "id": "card-sender-uuid",
      "guestName": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
      "balanceAfter": 2400                // –ë—ã–ª–æ 2900, –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ 500
    },
    "toCard": {
      "id": "card-receiver-uuid",
      "guestName": "–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞",
      "balanceAfter": 1700                // –ë—ã–ª–æ 1200, –ø–æ–ª—É—á–∏–ª–∏ 500
    },
    "amount": 500,
    "status": "COMPLETED",
    "createdAt": "2026-02-09T13:00:00Z"
  }
}
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ `LoyaltySystem`):**

- `allowTransfers: boolean` ‚Äî –≤–∫–ª—é—á–µ–Ω–∞ –ª–∏ —Ñ—É–Ω–∫—Ü–∏—è
- `transferMinAmount: 1`
- `transferMaxPerOperation: 5000`
- `transferMaxPerDay: 10000`
- `transferCooldown: 300` (5 –º–∏–Ω—É—Ç –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏)

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
2. –ü–æ–∏—Å–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É (–≤ —Ä–∞–º–∫–∞—Ö —Ç–æ–≥–æ –∂–µ tenant –∏–ª–∏ cross-tenant?)
3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SMS/Telegram –∫–æ–¥–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞ (—Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è 5 –º–∏–Ω—É—Ç)
5. –ê—Ç–æ–º–∞—Ä–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:
    - –°–ø–∏—Å–∞–Ω–∏–µ —É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (`BallTransaction` type `TRANSFER_OUT`)
    - –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—é (`BallTransaction` type `TRANSFER_IN`)
    - –°–æ–∑–¥–∞–Ω–∏–µ `BallTransfer` –∑–∞–ø–∏—Å–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `COMPLETED`
6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–±–æ–∏–º –≥–æ—Å—Ç—è–º (Telegram/SMS)

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**

- Rate limiting: 3 –ø–æ–ø—ã—Ç–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞ –∑–∞ 60 —Å–µ–∫—É–Ω–¥
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∞–º–æ–ø–µ—Ä–µ–≤–æ–¥ (–Ω–µ–ª—å–∑—è —Å–µ–±–µ)
- –õ–æ–≥ –≤—Å–µ—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –≤ `ActivityLog`

***

## üìä **–ë–ª–æ–∫ 4: Loyalty Builder API ‚Äî –ü—Ä–∞–≤–∏–ª–∞, –£—Ä–æ–≤–Ω–∏, –ü—Ä–æ–º–æ**

### 1Ô∏è‚É£1Ô∏è‚É£ **CRUD API –¥–ª—è Loyalty Rules**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
Admin –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ (–ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —á–µ–∫–∞, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏).

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**RESTful CRUD + Versioning**

```typescript
// GET /api/v1/loyalty/rules ‚Äî –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª
GET /api/v1/loyalty/rules?tenantId=xxx&status=ACTIVE

Response:
{
  "rules": [
    {
      "id": "rule-uuid",
      "name": "–ë–∞–∑–æ–≤—ã–π –∫–µ—à–±—ç–∫",
      "earnPercent": 10,
      "status": "ACTIVE",
      "priority": 1,
      "version": 1,
      "conditions": {
        "minCheckAmount": 500,
        "daysOfWeek": [1, 2, 3, 4, 5],  // –ü–Ω-–ü—Ç
        "timeRange": { from: "10:00", to: "22:00" },
        "categories": ["pizza", "pasta"]
      },
      "createdAt": "2026-01-01T00:00:00Z",
      "updatedAt": "2026-01-15T12:00:00Z"
    }
  ]
}

// POST /api/v1/loyalty/rules ‚Äî –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
POST /api/v1/loyalty/rules
{
  "name": "–í–µ—á–µ—Ä–Ω–∏–π –∫–µ—à–±—ç–∫",
  "earnPercent": 15,
  "conditions": {
    "minCheckAmount": 1000,
    "timeRange": { from: "18:00", to: "23:00" }
  },
  "priority": 2
}

// PUT /api/v1/loyalty/rules/:id ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ (—Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é)
PUT /api/v1/loyalty/rules/rule-uuid
{
  "earnPercent": 12  // –ò–∑–º–µ–Ω–∏–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç
}

// Response:
{
  "rule": {
    "id": "rule-uuid",
    "version": 2,  // üî• –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
    "earnPercent": 12,
    "effectiveFrom": "2026-02-10T00:00:00Z"  // –í—Å—Ç—É–ø–∏—Ç –≤ —Å–∏–ª—É –∑–∞–≤—Ç—Ä–∞
  },
  "previousVersion": {
    "version": 1,
    "earnPercent": 10,
    "effectiveUntil": "2026-02-09T23:59:59Z"
  }
}

// DELETE /api/v1/loyalty/rules/:id ‚Äî –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (ARCHIVED)
DELETE /api/v1/loyalty/rules/rule-uuid
```

**–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**

- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª–∞ ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è **–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è**, —Å—Ç–∞—Ä–∞—è `effectiveUntil = NOW`
- –í `BallTransaction.ruleSnapshot` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è JSON-snapshot –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
- –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ **–Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è**

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–∞–≤–∏–ª:**

- –ü—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –±–∞–ª–ª–æ–≤ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –í–°–ï –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ (–µ—Å–ª–∏ `conflictStrategy = COMBINE_ALL`)
- –ï—Å–ª–∏ `conflictStrategy = MAX_ONLY` ‚Üí –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª–æ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º

***

### 1Ô∏è‚É£2Ô∏è‚É£ **CRUD API –¥–ª—è Loyalty Levels**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
Admin —Å–æ–∑–¥–∞—ë—Ç —É—Ä–æ–≤–Ω–∏ (Bronze/Silver/Gold), –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–æ—Ä–æ–≥–∏ –∏ –±–æ–Ω—É—Å—ã.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**RESTful CRUD + One Way Up Logic**

```typescript
// GET /api/v1/loyalty/levels
Response:
{
  "levels": [
    { "id": "level-1", "name": "Bronze", "threshold": 0, "earnBonus": 0 },
    { "id": "level-2", "name": "Silver", "threshold": 150000, "earnBonus": 5 },
    { "id": "level-3", "name": "Gold", "threshold": 400000, "earnBonus": 10 }
  ]
}

// POST /api/v1/loyalty/levels
POST /api/v1/loyalty/levels
{
  "name": "Platinum",
  "threshold": 1000000,
  "earnBonus": 15,  // +15% –∫ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é
  "description": "–î–ª—è —Å–∞–º—ã—Ö –ª–æ—è–ª—å–Ω—ã—Ö –≥–æ—Å—Ç–µ–π"
}

// PUT /api/v1/loyalty/levels/:id ‚Äî –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞
PUT /api/v1/loyalty/levels/level-2
{
  "threshold": 200000  // –ü–æ–≤—ã—Å–∏–ª–∏ –ø–æ—Ä–æ–≥ Silver —Å 150k –¥–æ 200k
}

// ‚ö†Ô∏è –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –≥–æ—Å—Ç—è–º–∏?
// –ì–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –Ω–∞ Silver ‚Äî –æ—Å—Ç–∞—é—Ç—Å—è (one way up)
// –ù–æ–≤—ã–µ –≥–æ—Å—Ç–∏ –ø–æ–ø–∞–¥—É—Ç –Ω–∞ Silver —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ 200k

// DELETE /api/v1/loyalty/levels/:id ‚Äî –£–¥–∞–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è
DELETE /api/v1/loyalty/levels/level-2

// ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –≤—ã–±–æ—Ä–∞: –∫—É–¥–∞ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≥–æ—Å—Ç–µ–π?
Response (–µ—Å–ª–∏ –µ—Å—Ç—å –≥–æ—Å—Ç–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ):
{
  "error": "LEVEL_HAS_GUESTS",
  "guestsCount": 1523,
  "message": "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞",
  "availableLevels": [
    { "id": "level-1", "name": "Bronze" },
    { "id": "level-3", "name": "Gold" }
  ]
}

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º:
DELETE /api/v1/loyalty/levels/:id?moveToLevel=level-3
```

**–ü–µ—Ä–µ—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π:**

- **CRON –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00** (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- –¢–æ–ª—å–∫–æ **–ø–æ–≤—ã—à–µ–Ω–∏–µ** —É—Ä–æ–≤–Ω–µ–π (downgrade –æ—Ç–∫–ª—é—á—ë–Ω)
- Endpoint –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞:

```
POST /api/v1/loyalty/levels/recalculate
{ "tenantId": "xxx" }  // Owner –º–æ–∂–µ—Ç –¥–ª—è –ª—é–±–æ–≥–æ tenant
```


***

### 1Ô∏è‚É£3Ô∏è‚É£ **CRUD API –¥–ª—è Promo Campaigns**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
Admin —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–æ–º–æ (–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è, –ø–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç, –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∞–∫—Ü–∏–∏).

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**RESTful CRUD + Promo Builder**

```typescript
// POST /api/v1/loyalty/promos ‚Äî –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ
POST /api/v1/loyalty/promos
{
  "name": "–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è",
  "type": "BIRTHDAY",
  "bonusPoints": 500,
  "expiresInDays": 7,  // –ë–∞–ª–ª—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã 7 –¥–Ω–µ–π –ø–æ—Å–ª–µ –î–†
  "status": "ACTIVE",
  "conditions": {
    "minCheckAmount": 500,
    "validRestaurants": ["rest-1", "rest-2"]  // null = –≤—Å–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã
  },
  "conflictStrategy": "COMBINE_WITH_BASE",  // –°—É–º–º–∏—Ä—É–µ—Ç—Å—è —Å –±–∞–∑–æ–≤—ã–º –∫–µ—à–±—ç–∫–æ–º
  "notificationSettings": {
    "sendOnBirthday": true,
    "sendDaysBefore": 3,
    "channels": ["TELEGRAM", "EMAIL"]
  }
}

// GET /api/v1/loyalty/promos ‚Äî –°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ
Response:
{
  "promos": [
    {
      "id": "promo-uuid",
      "name": "–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è",
      "type": "BIRTHDAY",
      "bonusPoints": 500,
      "status": "ACTIVE",
      "stats": {
        "totalActivations": 1523,
        "totalBonusIssued": 761500,
        "conversionRate": 68.5
      }
    }
  ]
}

// GET /api/v1/loyalty/promos/eligible ‚Äî –ö–∞–∫–∏–µ –ø—Ä–æ–º–æ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –≥–æ—Å—Ç—è?
GET /api/v1/loyalty/promos/eligible?guestCardId=xxx

Response:
{
  "eligiblePromos": [
    {
      "id": "promo-uuid",
      "name": "–ü–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç",
      "bonusPoints": 300,
      "expiresAt": null,  // –ë–µ—Å—Å—Ä–æ—á–Ω–æ–µ
      "conditions": "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —á–µ–∫ 500‚ÇΩ"
    }
  ]
}
```

**–¢–∏–ø—ã –ø—Ä–æ–º–æ:**

- `BIRTHDAY` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –≥–æ—Å—Ç—è –≤ –¥–µ–Ω—å –î–†
- `CHILD_BIRTHDAY` ‚Äî –¥–ª—è –¥–µ—Ç–µ–π –≥–æ—Å—Ç—è
- `FIRST_VISIT` ‚Äî –ø–µ—Ä–≤—ã–π —á–µ–∫
- `INACTIVITY` ‚Äî –µ—Å–ª–∏ –Ω–µ –±—ã–ª N –¥–Ω–µ–π
- `CUSTOM` ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–µ —É—Å–ª–æ–≤–∏—è (Admin —Å–æ–∑–¥–∞—ë—Ç –≤—Ä—É—á–Ω—É—é)

**–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–æ–º–æ:**

```typescript
// LoyaltySystem config
{
  "promoConflictStrategy": "COMBINE_ALL",  // –∏–ª–∏ MAX_ONLY, FIRST_ONLY
  "promoOverrides": [
    {
      "promo1": "birthday-promo",
      "promo2": "first-visit-promo",
      "strategy": "MAX_ONLY"  // –î–ª—è —ç—Ç–æ–π –ø–∞—Ä—ã ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ
    }
  ]
}
```


***

## ‚è∞ **–ë–ª–æ–∫ 5: Background Jobs \& CRON**

### 1Ô∏è‚É£4Ô∏è‚É£ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Background Jobs**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
CRON-–∑–∞–¥–∞—á–∏: –ø–µ—Ä–µ—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π, —Å–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤, reconciliation —Å POS, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**BullMQ + –û—Ç–¥–µ–ª—å–Ω—ã–π Worker –ø—Ä–æ—Ü–µ—Å—Å**

```typescript
// apps/worker/src/main.ts
import { NestFactory } from '@nestjs/core';
import { WorkerModule } from './worker.module';

async function bootstrap() {
  const app = await NestFactory.create(WorkerModule);
  await app.listen(3001);  // Health check endpoint
}

// libs/jobs/src/queues/
export enum QueueName {
  LOYALTY_RECALC = 'loyalty-recalc',
  BALL_EXPIRATION = 'ball-expiration',
  POS_RECONCILIATION = 'pos-reconciliation',
  NOTIFICATIONS = 'notifications',
  ANALYTICS = 'analytics',
}

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è jobs
@Module({
  imports: [
    BullModule.registerQueue(
      { name: QueueName.LOYALTY_RECALC },
      { name: QueueName.BALL_EXPIRATION },
      { name: QueueName.POS_RECONCILIATION },
      { name: QueueName.NOTIFICATIONS },
      { name: QueueName.ANALYTICS },
    ),
  ],
})
export class WorkerModule {}
```

**CRON Schedule (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è per-tenant):**

```typescript
// –ü–µ—Ä–µ—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00
@Cron('0 3 * * *')
async recalculateLevels() {
  const tenants = await this.tenantsService.findAll({ isActive: true });
  
  for (const tenant of tenants) {
    await this.loyaltyRecalcQueue.add('recalc-levels', {
      tenantId: tenant.id,
    });
  }
}

// –°–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 10:00
@Cron('0 10 * * *')
async expireBalls() {
  await this.ballExpirationQueue.add('check-expiration', {});
}

// POS Reconciliation ‚Äî –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
@Cron('*/30 * * * *')
async posReconciliation() {
  await this.posReconciliationQueue.add('reconcile', {});
}

// –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî –∫–∞–∂–¥—É—é –Ω–æ—á—å –≤ 02:00
@Cron('0 2 * * *')
async updateAnalytics() {
  await this.analyticsQueue.add('daily-snapshot', {
    date: new Date(),
  });
}
```

**Health Check:**

```typescript
GET /health/workers
Response:
{
  "status": "ok",
  "queues": {
    "loyalty-recalc": { active: 2, waiting: 15, completed: 1234, failed: 3 },
    "ball-expiration": { active: 1, waiting: 0, completed: 456, failed: 0 },
    "pos-reconciliation": { active: 5, waiting: 20, completed: 8901, failed: 12 }
  }
}
```


***

### 1Ô∏è‚É£5Ô∏è‚É£ **Job: –°–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ (Ball Expiration)**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ë–∞–ª–ª—ã —Å–≥–æ—Ä–∞—é—Ç –ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–º–∏–Ω–∏–º—É–º 90 –¥–Ω–µ–π) + –ø—Ä–æ–º–æ-–±–∞–ª–ª—ã –ø–æ `expiresAt`.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**–ì–∏–±—Ä–∏–¥: Inactivity + Promo Expiration**

```typescript
@Processor(QueueName.BALL_EXPIRATION)
export class BallExpirationProcessor {
  
  @Process('check-expiration')
  async processExpiration(job: Job) {
    // 1Ô∏è‚É£ –°–≥–æ—Ä–∞–Ω–∏–µ –ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–≤—Å–µ –±–∞–ª–ª—ã –∫–∞—Ä—Ç—ã —Ä–∞–∑–æ–º)
    const inactiveCards = await this.prisma.guestCard.findMany({
      where: {
        status: 'ACTIVE',
        lastActivityAt: {
          lt: new Date(Date.now() - tenant.inactivityExpireDays * 24 * 60 * 60 * 1000)
        },
        totalBalance: { gt: 0 }
      }
    });
    
    for (const card of inactiveCards) {
      await this.prisma.$transaction(async (tx) => {
        // –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å–≥–æ—Ä–∞–Ω–∏—è
        await tx.ballTransaction.create({
          data: {
            guestCardId: card.id,
            type: 'EXPIRE',
            amount: -card.totalBalance,  // –í—Å—ë —Å–≥–æ—Ä–∞–µ—Ç
            balanceType: 'REGULAR',      // –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è REGULAR –∏ PROMO
            reason: `–ù–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ${tenant.inactivityExpireDays} –¥–Ω–µ–π`,
          }
        });
        
        // –û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å
        await tx.guestCard.update({
          where: { id: card.id },
          data: {
            regularBalance: 0,
            promoBalance: 0,
            totalBalance: 0
          }
        });
        
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
        if (tenant.notifyBeforeExpiration) {
          await this.notificationService.send({
            guestCardId: card.id,
            type: 'BALLS_EXPIRED',
            amount: card.totalBalance
          });
        }
      });
    }
    
    // 2Ô∏è‚É£ –°–≥–æ—Ä–∞–Ω–∏–µ –ø—Ä–æ–º–æ-–±–∞–ª–ª–æ–≤ –ø–æ expiresAt
    const expiredPromos = await this.prisma.promoBallGranted.findMany({
      where: {
        expiresAt: { lt: new Date() },
        amountRemaining: { gt: 0 }
      }
    });
    
    for (const promo of expiredPromos) {
      await this.prisma.$transaction(async (tx) => {
        // –°–ø–∏—Å–∞—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ–º–æ-–±–∞–ª–ª—ã
        await tx.ballTransaction.create({
          data: {
            guestCardId: promo.guestCardId,
            type: 'EXPIRE',
            amount: -promo.amountRemaining,
            balanceType: 'PROMO',
            promoId: promo.promoId,
            reason: '–ò—Å—Ç—ë–∫ —Å—Ä–æ–∫ –ø—Ä–æ–º–æ'
          }
        });
        
        // –û–±–Ω–æ–≤–∏—Ç—å promo
        await tx.promoBallGranted.update({
          where: { id: promo.id },
          data: { amountRemaining: 0 }
        });
        
        // –£–º–µ–Ω—å—à–∏—Ç—å promoBalance –∫–∞—Ä—Ç—ã
        await tx.guestCard.update({
          where: { id: promo.guestCardId },
          data: {
            promoBalance: { decrement: promo.amountRemaining },
            totalBalance: { decrement: promo.amountRemaining }
          }
        });
      });
    }
  }
}
```

**–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–≥–æ—Ä–∞–Ω–∏–∏ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ `LoyaltySystem`):**

```typescript
{
  "expirationNotifications": {
    "enabled": true,
    "channels": ["TELEGRAM", "EMAIL"],
    "daysBeforeExpiration": [3, 7, 14],  // –£–≤–µ–¥–æ–º–ª—è—Ç—å –∑–∞ 3, 7, 14 –¥–Ω–µ–π
    "notifyForRegular": true,
    "notifyForPromo": true
  }
}
```


***

### 1Ô∏è‚É£6Ô∏è‚É£ **Job: POS Reconciliation**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–≤–µ—Ä–∫–∞: POS vs –Ω–∞—à Backend. –ò—â–µ–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –±–∞–ª–∞–Ω—Å–∞—Ö.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**–ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç + –ù–æ—á–Ω–æ–π –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç**

```typescript
@Process('reconcile')
async processReconciliation(job: Job) {
  const integrations = await this.prisma.posIntegration.findMany({
    where: { isActive: true }
  });
  
  for (const integration of integrations) {
    // 1Ô∏è‚É£ PULL –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —á–µ–∫–æ–≤ –∏–∑ POS (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö webhooks)
    const posChecks = await this.posAdapter.fetchChecks({
      posSystem: integration.posSystem,
      restaurantId: integration.restaurantId,
      fromDate: integration.lastSuccessfulPullAt || new Date(Date.now() - 2 * 60 * 60 * 1000)
    });
    
    for (const posCheck of posChecks) {
      const existingTransaction = await this.prisma.posTransaction.findUnique({
        where: {
          tenantId_posSystem_posCheckId: {
            tenantId: integration.tenantId,
            posSystem: integration.posSystem,
            posCheckId: posCheck.id
          }
        }
      });
      
      if (!existingTransaction) {
        // Webhook –Ω–µ –ø—Ä–∏—à—ë–ª ‚Äî —Å–æ–∑–¥–∞—ë–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —á–µ—Ä–µ–∑ PULL
        await this.loyaltyService.processTransaction({
          source: 'POS_PULL',
          ...posCheck
        });
        
        await this.activityLog.create({
          actionType: 'POS_RECONCILIATION_MISSING_WEBHOOK',
          metadata: { posCheckId: posCheck.id }
        });
      }
    }
    
    // 2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –ø–æ –±–∞–ª–∞–Ω—Å–∞–º
    const guests = await this.prisma.guestCard.findMany({
      where: { restaurantId: integration.restaurantId }
    });
    
    for (const guest of guests) {
      const ourBalance = guest.totalBalance;
      const posBalance = await this.posAdapter.getGuestBalance({
        posSystem: integration.posSystem,
        posGuestId: guest.posGuestId
      });
      
      const diff = Math.abs(ourBalance - posBalance);
      
      if (diff > 10) {  // –ü–æ—Ä–æ–≥ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è
        await this.prisma.ballReconciliation.create({
          data: {
            guestCardId: guest.id,
            expectedBalance: ourBalance,
            actualBalance: posBalance,
            difference: diff,
            status: 'PENDING_REVIEW'
          }
        });
        
        // –ê–ª–µ—Ä—Ç Admin'—É
        await this.notificationService.sendToAdmin({
          type: 'POS_BALANCE_MISMATCH',
          guestCardId: guest.id,
          difference: diff
        });
      }
    }
    
    // –û–±–Ω–æ–≤–∏—Ç—å last_successful_pull_at
    await this.prisma.posIntegration.update({
      where: { id: integration.id },
      data: { lastSuccessfulPullAt: new Date() }
    });
  }
}
```


***

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –±–ª–æ–∫–∞–º–∏? (–£ –º–µ–Ω—è –µ—â—ë 15+ –≤–æ–ø—Ä–æ—Å–æ–≤ –≥–æ—Ç–æ–≤–æ –ø–æ Analytics API, Notifications, Error Handling, Testing Strategy –∏ —Ç.–¥.)

–°–∫–∞–∂–∏:

- ‚úÖ **"–ü—Ä–æ–¥–æ–ª–∂–∞–π"** ‚Äî –¥–∞–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è 15+ –≤–æ–ø—Ä–æ—Å–æ–≤
- üõë **"–°—Ç–æ–ø, –æ–±—Å—É–¥–∏–º —Ç–µ–∫—É—â–∏–µ"** ‚Äî —Ä–∞–∑–±–µ—Ä—ë–º –¥–µ—Ç–∞–ª–∏ –ø–æ –ø–µ—Ä–≤—ã–º 16
<span style="display:none">[^2_1][^2_2]</span>

<div align="center">‚ÅÇ</div>

[^2_1]: Beseda-6.md

[^2_2]: Beseda-7.md


---

# –ü—Ä–æ–¥–æ–ª–∂–∞–π. –ï—Å–ª–∏ –µ—Å—Ç—å –±–æ–ª—å—à–µ —á–µ–º 15+ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —ç—Ç–æ–º—É –±–ª–æ–∫—É, –∑–∞–¥–∞–π –∏—Ö –≤—Å–µ —Ç–æ–∂–µ. –í —Ç–æ–º –∂–µ —Å—Ç–∏–ª–µ

–û—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ–¥–æ–ª–∂–∞—é –≤ —Ç–æ–º –∂–µ —Å—Ç–∏–ª–µ. –£ –º–µ–Ω—è –µ—â—ë **18 –≤–æ–ø—Ä–æ—Å–æ–≤** –ø–æ —ç—Ç–æ–º—É –±–ª–æ–∫—É ‚Äî –≤—ã–¥–∞–º –≤—Å–µ —Å—Ä–∞–∑—É.

***

## üìä **–ë–ª–æ–∫ 6: Analytics \& Reporting API**

### 1Ô∏è‚É£7Ô∏è‚É£ **Analytics API –¥–ª—è Owner ‚Äî Platform Metrics**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
Owner –≤–∏–¥–∏—Ç –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ: MRR, Churn, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ tenant'–æ–≤, revenue.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**GET /api/v1/analytics/platform ‚Äî –ü–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞**

```typescript
// Request
GET /api/v1/analytics/platform?period=LAST_30_DAYS

// Response
{
  "period": {
    "from": "2026-01-11T00:00:00Z",
    "to": "2026-02-10T23:59:59Z"
  },
  "tenants": {
    "total": 156,
    "active": 142,           // –° –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π
    "pastDue": 8,            // PAST_DUE
    "cancelled": 6,          // CANCELLED_NON_PAYMENT
    "newThisMonth": 14
  },
  "revenue": {
    "mrr": 2840000,          // Monthly Recurring Revenue (RUB)
    "arr": 34080000,         // Annual Recurring Revenue
    "totalRevenue": 3125000, // –§–∞–∫—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥ (—Å —É—á—ë—Ç–æ–º –≥–æ–¥–æ–≤—ã—Ö)
    "averageRevenuePerTenant": 18205  // MRR / active tenants
  },
  "subscriptions": {
    "byPlan": {
      "STANDARD": { count: 45, mrr: 337500 },
      "MEDIUM": { count: 58, mrr: 1160000 },
      "PRO": { count: 32, mrr: 960000 },
      "ULTIMATE": { count: 7, mrr: 385000 },
      "CUSTOM": { count: 2, mrr: 150000 }
    },
    "byPeriod": {
      "MONTHLY": 98,
      "YEARLY": 44
    }
  },
  "churn": {
    "rate": 3.8,             // % –∑–∞ –º–µ—Å—è—Ü
    "cancelledThisMonth": 6,
    "reasons": {
      "NON_PAYMENT": 4,
      "VOLUNTARY": 2
    }
  },
  "payments": {
    "totalTransactions": 156,
    "successful": 148,
    "failed": 8,
    "refunded": 2,
    "chargeback": 1,
    "totalAmount": 3125000
  },
  "guests": {
    "totalAcrossAllTenants": 45670,
    "activeLastMonth": 31245,  // –ê–∫—Ç–∏–≤–Ω—ã–µ –≥–æ—Å—Ç–∏ (–±—ã–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
    "newThisMonth": 3456
  },
  "loyalty": {
    "totalBallsIssued": 125670000,    // –í—Å–µ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–æ
    "totalBallsRedeemed": 78450000,   // –í—Å–µ–≥–æ —Å–ø–∏—Å–∞–Ω–æ
    "totalBallsExpired": 4230000,
    "redemptionRate": 62.4            // %
  }
}
```

**–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:**

- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `AnalyticsMonthlySnapshot` (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è CRON'–æ–º)
- Real-time –¥–∞–Ω–Ω—ã–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∏–∑ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Redis (TTL 5 –º–∏–Ω—É—Ç)

***

### 1Ô∏è‚É£8Ô∏è‚É£ **Analytics API –¥–ª—è Restaurant Admin ‚Äî Restaurant Performance**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
Admin –≤–∏–¥–∏—Ç –º–µ—Ç—Ä–∏–∫–∏ —Å–≤–æ–µ–≥–æ tenant'–∞: –≤—ã—Ä—É—á–∫–∞, –≥–æ—Å—Ç–∏, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–æ–º–æ, ROI –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**GET /api/v1/analytics/restaurant ‚Äî –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞/—Å–µ—Ç–∏**

```typescript
// Request
GET /api/v1/analytics/restaurant?tenantId=xxx&period=LAST_30_DAYS&restaurantId=rest-1

// Response
{
  "period": { "from": "...", "to": "..." },
  "overview": {
    "totalRevenue": 2850000,         // –ó–∞ –ø–µ—Ä–∏–æ–¥
    "totalChecks": 1456,
    "averageCheck": 1957,
    "totalGuests": 1245,
    "activeGuests": 876,             // –ë—ã–ª–∏ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ
    "newGuests": 123,
    "returningGuests": 753,
    "retentionRate": 70.3            // %
  },
  "loyalty": {
    "ballsIssued": 285000,
    "ballsRedeemed": 142500,
    "ballsExpired": 8500,
    "redemptionRate": 50.0,
    "averageBallsPerGuest": 229,
    "discountGivenViaPoints": 142500,    // RUB
    "roiLoyalty": 18.5                    // –í—ã—Ä—É—á–∫–∞ –æ—Ç –≥–æ—Å—Ç–µ–π —Å –±–∞–ª–ª–∞–º–∏ vs –±–µ–∑
  },
  "levels": {
    "distribution": {
      "BRONZE": { count: 456, percent: 36.6, avgCheck: 1500 },
      "SILVER": { count: 589, percent: 47.3, avgCheck: 2100 },
      "GOLD": { count: 200, percent: 16.1, avgCheck: 2800 }
    }
  },
  "promos": {
    "active": 4,
    "totalActivations": 567,
    "totalBonusIssued": 283500,
    "conversionRate": 68.5,              // % –≥–æ—Å—Ç–µ–π, –ø–æ–ª—É—á–∏–≤—à–∏—Ö –ø—Ä–æ–º–æ –∏ —Å–¥–µ–ª–∞–≤—à–∏—Ö –ø–æ–∫—É–ø–∫—É
    "topPromos": [
      {
        "id": "promo-1",
        "name": "–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è",
        "activations": 234,
        "bonusIssued": 117000,
        "avgCheckAfterPromo": 2300,
        "roi": 12.5                       // –í—ã—Ä—É—á–∫–∞ –æ—Ç –≥–æ—Å—Ç–µ–π —Å –ø—Ä–æ–º–æ / —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–º–æ
      }
    ]
  },
  "guestSegments": {
    "vip": { count: 45, avgCheck: 5200, totalRevenue: 234000 },
    "regular": { count: 589, avgCheck: 2100, totalRevenue: 1236900 },
    "atrisk": { count: 123, avgCheck: 1200, totalRevenue: 147600, daysInactive: 45 },
    "lost": { count: 67, avgCheck: 0, daysInactive: 120 }
  },
  "trends": {
    "revenueByDay": [
      { "date": "2026-02-01", "revenue": 95000, "checks": 48 },
      { "date": "2026-02-02", "revenue": 102000, "checks": 52 }
      // ... 30 days
    ],
    "guestsByWeek": [
      { "week": "W1", "newGuests": 28, "returningGuests": 156 }
      // ... 4 weeks
    ]
  },
  "posIntegration": {
    "status": "ACTIVE",
    "lastSync": "2026-02-10T14:15:00Z",
    "missedWebhooks": 2,
    "reconciliationIssues": 0
  }
}
```

**Drill-down endpoints:**

```typescript
// –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ø—Ä–æ–º–æ
GET /api/v1/analytics/restaurant/promos/:promoId?period=LAST_30_DAYS

// –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º –≥–æ—Å—Ç–µ–π
GET /api/v1/analytics/restaurant/segments/:segment?period=LAST_30_DAYS

// –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
GET /api/v1/analytics/restaurant/export?format=xlsx&period=LAST_30_DAYS
```


***

### 1Ô∏è‚É£9Ô∏è‚É£ **Analytics API –¥–ª—è Manager ‚Äî Single Restaurant**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
Manager –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω (–µ—Å–ª–∏ Admin –Ω–µ —Ä–∞—Å—à–∏—Ä–∏–ª –¥–æ—Å—Ç—É–ø).

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**GET /api/v1/analytics/my-restaurant ‚Äî –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –º–æ–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞**

```typescript
// Request (restaurantId –±–µ—Ä—ë—Ç—Å—è –∏–∑ JWT user.assignedRestaurants)
GET /api/v1/analytics/my-restaurant?period=LAST_7_DAYS

// Response ‚Äî —Ç–∞ –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —á—Ç–æ —É Admin, –Ω–æ:
{
  "overview": {
    "totalRevenue": 650000,
    "totalChecks": 342,
    "averageCheck": 1901,
    "totalGuests": 287,
    "activeGuests": 198,
    "newGuests": 23
  },
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ /analytics/restaurant
  
  // ‚ö†Ô∏è –ù–û: Manager –ù–ï –≤–∏–¥–∏—Ç:
  // - Billing information
  // - POS integration settings (—Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å)
  // - Cross-restaurant comparison (–µ—Å–ª–∏ —Å–µ—Ç—å)
}
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ä–æ–ª–∏:**

- Manager: —Ç–æ–ª—å–∫–æ —Å–≤–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω
- Admin: –≤—Å—è —Å–µ—Ç—å + —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
- Owner: –ª—é–±–æ–π tenant

***

### 2Ô∏è‚É£0Ô∏è‚É£ **Analytics API –¥–ª—è Guest ‚Äî Personal Stats**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ì–æ—Å—Ç—å –≤ Telegram Mini App –≤–∏–¥–∏—Ç —Å–≤–æ—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: —Å–∫–æ–ª—å–∫–æ —Å—ç–∫–æ–Ω–æ–º–∏–ª, –ª—é–±–∏–º—ã–µ –±–ª—é–¥–∞.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**GET /api/v1/analytics/guest/me ‚Äî –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**

```typescript
// Request (guestId –∏–∑ JWT)
GET /api/v1/analytics/guest/me?period=LAST_90_DAYS

// Response
{
  "period": { "from": "...", "to": "..." },
  "overview": {
    "totalVisits": 47,
    "totalSpent": 110450,
    "averageCheck": 2350,
    "savedViaPoints": 8500,              // –°–∫–æ–ª—å–∫–æ —Å—ç–∫–æ–Ω–æ–º–∏–ª –±–∞–ª–ª–∞–º–∏
    "earnedPoints": 12340,
    "currentBalance": 2900,
    "level": "SILVER",
    "lifetimeSpent": 152000,
    "progressToNextLevel": {
      "currentLevel": "SILVER",
      "nextLevel": "GOLD",
      "amountNeeded": 248000,             // –î–æ Gold
      "percent": 38.1
    }
  },
  "visitPatterns": {
    "favoriteDay": "Friday",               // –ß–∞—â–µ –≤—Å–µ–≥–æ –ø–æ –ø—è—Ç–Ω–∏—Ü–∞–º
    "favoriteTime": "18:00-20:00",
    "mostVisitedRestaurant": {
      "id": "rest-1",
      "name": "–§–∏–ª–∏–∞–ª –Ω–∞ –ù–µ–≤—Å–∫–æ–º",
      "visits": 32
    }
  },
  "topDishes": [
    { "name": "–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞", "orders": 15, "totalSpent": 12000 },
    { "name": "–ü–∞—Å—Ç–∞ –ö–∞—Ä–±–æ–Ω–∞—Ä–∞", "orders": 12, "totalSpent": 8400 }
  ],
  "recentVisits": [
    {
      "date": "2026-02-09T18:30:00Z",
      "restaurant": "–§–∏–ª–∏–∞–ª –Ω–∞ –ù–µ–≤—Å–∫–æ–º",
      "checkAmount": 2850,
      "earnedPoints": 285,
      "redeemedPoints": 100
    }
    // ... last 10
  ],
  "promos": {
    "used": 8,
    "totalBonusReceived": 4200
  },
  "achievements": [                        // Gamification (Phase 2)
    { "name": "–ß–∞—Å—Ç—ã–π –≥–æ—Å—Ç—å", "icon": "üèÜ", "unlockedAt": "2026-01-15" },
    { "name": "–õ—é–±–∏—Ç–µ–ª—å –ø–∏—Ü—Ü—ã", "icon": "üçï", "unlockedAt": "2026-02-01" }
  ]
}
```

**–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (Phase 2):**

```typescript
{
  "recommendations": [
    {
      "type": "DISH",
      "title": "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ü–∞—Å—Ç—É –ê—Ä—Ä–∞–±—å—è—Ç–∞",
      "reason": "–ü–æ—Ö–æ–∂–∞ –Ω–∞ –≤–∞—à–∏ –ª—é–±–∏–º—ã–µ –±–ª—é–¥–∞",
      "discount": 10  // % —Å–∫–∏–¥–∫–∞
    },
    {
      "type": "PROMO",
      "title": "–ü—Ä–∏–≤–µ–¥–∏ –¥—Ä—É–≥–∞ ‚Äî –ø–æ–ª—É—á–∏ 500 –±–∞–ª–ª–æ–≤",
      "expiresAt": "2026-02-20T23:59:59Z"
    }
  ]
}
```


***

### 2Ô∏è‚É£1Ô∏è‚É£ **–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–æ–≤ (Excel/CSV/PDF)**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
Admin/Manager —Ö–æ—Ç—è—Ç –≤—ã–≥—Ä—É–∂–∞—Ç—å –æ—Ç—á—ë—Ç—ã –¥–ª—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏, –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**POST /api/v1/analytics/export ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞**

```typescript
// Request
POST /api/v1/analytics/export
{
  "reportType": "RESTAURANT_PERFORMANCE",   // –∏–ª–∏ GUEST_LIST, PROMO_ROI, TRANSACTIONS
  "format": "XLSX",                         // –∏–ª–∏ CSV, PDF
  "period": {
    "from": "2026-01-01",
    "to": "2026-01-31"
  },
  "filters": {
    "restaurantId": "rest-1",
    "level": "SILVER",
    "minCheckAmount": 1000
  },
  "columns": [                              // –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –∫–æ–ª–æ–Ω–æ–∫
    "guestName", "phone", "level", "balance", "lifetimeSpent", "lastVisit"
  ]
}

// Response
{
  "exportId": "export-uuid",
  "status": "PROCESSING",
  "estimatedTime": 15  // seconds
}

// –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (webhook –∏–ª–∏ polling):
GET /api/v1/analytics/export/:exportId

Response:
{
  "exportId": "export-uuid",
  "status": "COMPLETED",
  "downloadUrl": "https://cdn.max-loyalty.com/exports/export-uuid.xlsx",
  "expiresAt": "2026-02-11T14:29:00Z",      // TTL 24 —á–∞—Å–∞
  "fileSize": 245678,
  "rowCount": 1234
}
```

**Background processing:**

- –û—á–µ—Ä–µ–¥—å `ANALYTICS` (BullMQ)
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –≤ Worker
- –ó–∞–≥—Ä—É–∑–∫–∞ –≤ S3/CDN
- Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ Admin'—É —Å —Å—Å—ã–ª–∫–æ–π

**–§–æ—Ä–º–∞—Ç—ã:**

- **XLSX:** Full-featured (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –≥—Ä–∞—Ñ–∏–∫–∏)
- **CSV:** –ü—Ä–æ—Å—Ç–æ–π —ç–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ –¥—Ä—É–≥–∏–µ —Å–∏—Å—Ç–µ–º—ã
- **PDF:** –ö—Ä–∞—Å–∏–≤—ã–π –æ—Ç—á—ë—Ç –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π

***

## üìß **–ë–ª–æ–∫ 7: Notifications API**

### 2Ô∏è‚É£2Ô∏è‚É£ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π Notification Service**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Telegram, Email, SMS. –ù—É–∂–Ω–∞ –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**POST /api/v1/notifications/send ‚Äî –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**

```typescript
// Internal API (–Ω–µ –ø—É–±–ª–∏—á–Ω—ã–π endpoint, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ—Ä–≤–∏—Å–∞–º–∏)
interface SendNotificationDto {
  recipientId: string;                    // userId –∏–ª–∏ guestCardId
  recipientType: 'USER' | 'GUEST';
  type: NotificationType;
  channels: NotificationChannel[];       // ['TELEGRAM', 'EMAIL', 'SMS']
  priority: 'LOW' | 'NORMAL' | 'HIGH';
  data: Record<string, any>;             // –î–∞–Ω–Ω—ã–µ –¥–ª—è —à–∞–±–ª–æ–Ω–∞
  scheduledFor?: Date;                   // –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
}

enum NotificationType {
  // Loyalty
  BALLS_EARNED = 'balls_earned',
  BALLS_REDEEMED = 'balls_redeemed',
  BALLS_EXPIRED = 'balls_expired',
  BALLS_EXPIRING_SOON = 'balls_expiring_soon',
  LEVEL_UPGRADED = 'level_upgraded',
  
  // Promos
  PROMO_ACTIVATED = 'promo_activated',
  PROMO_AVAILABLE = 'promo_available',
  BIRTHDAY_PROMO = 'birthday_promo',
  
  // Billing
  SUBSCRIPTION_EXPIRING = 'subscription_expiring',
  PAYMENT_FAILED = 'payment_failed',
  PAYMENT_SUCCESS = 'payment_success',
  
  // System
  WELCOME = 'welcome',
  PASSWORD_RESET = 'password_reset',
  VERIFICATION_CODE = 'verification_code'
}

enum NotificationChannel {
  TELEGRAM = 'TELEGRAM',
  EMAIL = 'EMAIL',
  SMS = 'SMS',
  PUSH = 'PUSH'  // Phase 2
}
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```typescript
// –í LoyaltyService –ø–æ—Å–ª–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤
await this.notificationService.send({
  recipientId: guestCard.userId,
  recipientType: 'GUEST',
  type: NotificationType.BALLS_EARNED,
  channels: ['TELEGRAM', 'EMAIL'],  // –ò–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥–æ—Å—Ç—è
  priority: 'NORMAL',
  data: {
    amount: 285,
    checkAmount: 2850,
    balance: 3185,
    restaurant: '–§–∏–ª–∏–∞–ª –Ω–∞ –ù–µ–≤—Å–∫–æ–º'
  }
});
```

**–®–∞–±–ª–æ–Ω—ã (–≤ –ë–î –∏–ª–∏ —Ñ–∞–π–ª–∞—Ö):**

```typescript
// NotificationTemplate model
{
  type: 'BALLS_EARNED',
  channel: 'TELEGRAM',
  locale: 'ru',
  template: `
üéâ –ù–∞—á–∏—Å–ª–µ–Ω–æ {{amount}} –±–∞–ª–ª–æ–≤!

–ß–µ–∫: {{checkAmount}}‚ÇΩ
–ë–∞–ª–∞–Ω—Å: {{balance}} –±–∞–ª–ª–æ–≤
–†–µ—Å—Ç–æ—Ä–∞–Ω: {{restaurant}}
  `,
  variables: ['amount', 'checkAmount', 'balance', 'restaurant']
}

// Email template (HTML)
{
  type: 'BALLS_EARNED',
  channel: 'EMAIL',
  locale: 'ru',
  subject: '–ù–∞—á–∏—Å–ª–µ–Ω–æ {{amount}} –±–∞–ª–ª–æ–≤!',
  template: `<html>...</html>`
}
```


***

### 2Ô∏è‚É£3Ô∏è‚É£ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≥–æ—Å—Ç—è**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ì–æ—Å—Ç—å –≤—ã–±–∏—Ä–∞–µ—Ç, –∫–∞–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —á–µ—Ä–µ–∑ –∫–∞–∫–∏–µ –∫–∞–Ω–∞–ª—ã –ø–æ–ª—É—á–∞—Ç—å.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**GET/PUT /api/v1/guests/me/notification-settings**

```typescript
// GET Response
{
  "settings": {
    "balls": {
      "earned": { "telegram": true, "email": false, "sms": false },
      "redeemed": { "telegram": true, "email": false, "sms": false },
      "expired": { "telegram": true, "email": true, "sms": false },
      "expiringSoon": { "telegram": true, "email": true, "sms": false }
    },
    "promos": {
      "available": { "telegram": true, "email": false, "sms": false },
      "birthday": { "telegram": true, "email": true, "sms": true }
    },
    "level": {
      "upgraded": { "telegram": true, "email": true, "sms": false }
    },
    "marketing": {
      "enabled": false,  // –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏
      "telegram": false,
      "email": false,
      "sms": false
    }
  },
  "globalMute": false  // –û—Ç–∫–ª—é—á–∏—Ç—å –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
}

// PUT Request ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
PUT /api/v1/guests/me/notification-settings
{
  "balls.earned.telegram": false,  // –û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –≤ Telegram
  "marketing.enabled": true        // –í–∫–ª—é—á–∏—Ç—å –º–∞—Ä–∫–µ—Ç–∏–Ω–≥
}
```

**–•—Ä–∞–Ω–µ–Ω–∏–µ:**

```typescript
// GuestNotificationSettings model
{
  userId: string;
  settings: JSON;  // –í–µ—Å—å –æ–±—ä–µ–∫—Ç –≤—ã—à–µ
  updatedAt: Date;
}
```

**–£–≤–∞–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –∫–æ–¥–µ:**

```typescript
async send(dto: SendNotificationDto) {
  const settings = await this.getGuestSettings(dto.recipientId);
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞–Ω–∞–ª—ã –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º
  const allowedChannels = dto.channels.filter(channel => {
    return settings[dto.type][channel] === true;
  });
  
  if (settings.globalMute || allowedChannels.length === 0) {
    return; // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
  }
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–º –∫–∞–Ω–∞–ª–∞–º
  for (const channel of allowedChannels) {
    await this.sendViaChannel(channel, dto);
  }
}
```


***

### 2Ô∏è‚É£4Ô∏è‚É£ **Notification History –¥–ª—è –≥–æ—Å—Ç—è**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ì–æ—Å—Ç—å –º–æ–∂–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Mini App.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**GET /api/v1/guests/me/notifications ‚Äî –ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**

```typescript
// Request
GET /api/v1/guests/me/notifications?limit=20&offset=0&status=UNREAD

// Response
{
  "notifications": [
    {
      "id": "notif-uuid",
      "type": "BALLS_EARNED",
      "title": "–ù–∞—á–∏—Å–ª–µ–Ω–æ 285 –±–∞–ª–ª–æ–≤!",
      "message": "–ß–µ–∫: 2850‚ÇΩ. –ë–∞–ª–∞–Ω—Å: 3185 –±–∞–ª–ª–æ–≤",
      "status": "UNREAD",
      "channels": ["TELEGRAM"],
      "createdAt": "2026-02-09T18:30:00Z",
      "readAt": null,
      "metadata": {
        "transactionId": "txn-uuid",
        "checkAmount": 2850
      }
    }
  ],
  "unreadCount": 5,
  "total": 123
}

// –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
PUT /api/v1/guests/me/notifications/:id/read
```

**–•—Ä–∞–Ω–µ–Ω–∏–µ:**

```typescript
// Notification model
{
  id: string;
  recipientId: string;
  type: NotificationType;
  title: string;
  message: string;
  channels: NotificationChannel[];
  status: 'UNREAD' | 'READ' | 'DELIVERED' | 'FAILED';
  sentAt: Date;
  readAt?: Date;
  metadata: JSON;
}
```


***

## üõ°Ô∏è **–ë–ª–æ–∫ 8: Error Handling \& Validation**

### 2Ô∏è‚É£5Ô∏è‚É£ **–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ù—É–∂–Ω—ã –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ error responses –¥–ª—è –≤—Å–µ—Ö endpoint'–æ–≤.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**Global Exception Filter + Custom Error Codes**

```typescript
// common/filters/http-exception.filter.ts
@Catch()
export class AllExceptionsFilter implements ExceptionFilter {
  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();
    const request = ctx.getRequest();

    let status = 500;
    let errorCode = 'INTERNAL_SERVER_ERROR';
    let message = 'An unexpected error occurred';
    let details = null;

    if (exception instanceof HttpException) {
      status = exception.getStatus();
      const exceptionResponse = exception.getResponse();
      
      if (typeof exceptionResponse === 'object') {
        errorCode = exceptionResponse['errorCode'] || this.mapStatusToCode(status);
        message = exceptionResponse['message'] || exception.message;
        details = exceptionResponse['details'];
      }
    }

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    this.logger.error({
      path: request.url,
      method: request.method,
      status,
      errorCode,
      message,
      userId: request.user?.id,
      tenantId: request.user?.tenantId,
      stack: exception instanceof Error ? exception.stack : null
    });

    // Response
    response.status(status).json({
      success: false,
      error: {
        code: errorCode,
        message: message,
        details: details,
        timestamp: new Date().toISOString(),
        path: request.url,
        requestId: request.id  // –ò–∑ middleware
      }
    });
  }
}
```

**Custom Error Codes:**

```typescript
// common/errors/error-codes.ts
export enum ErrorCode {
  // Auth
  UNAUTHORIZED = 'UNAUTHORIZED',
  INVALID_TOKEN = 'INVALID_TOKEN',
  TOKEN_EXPIRED = 'TOKEN_EXPIRED',
  FORBIDDEN = 'FORBIDDEN',
  IMPERSONATION_NOT_ALLOWED = 'IMPERSONATION_NOT_ALLOWED',
  
  // Loyalty
  INSUFFICIENT_BALANCE = 'INSUFFICIENT_BALANCE',
  GUEST_CARD_NOT_FOUND = 'GUEST_CARD_NOT_FOUND',
  RULE_NOT_FOUND = 'RULE_NOT_FOUND',
  LEVEL_NOT_FOUND = 'LEVEL_NOT_FOUND',
  PROMO_NOT_FOUND = 'PROMO_NOT_FOUND',
  PROMO_ALREADY_USED = 'PROMO_ALREADY_USED',
  PROMO_EXPIRED = 'PROMO_EXPIRED',
  CHECK_AMOUNT_TOO_LOW = 'CHECK_AMOUNT_TOO_LOW',
  REDEEM_LIMIT_EXCEEDED = 'REDEEM_LIMIT_EXCEEDED',
  TRANSFER_COOLDOWN_ACTIVE = 'TRANSFER_COOLDOWN_ACTIVE',
  TRANSFER_TO_SELF = 'TRANSFER_TO_SELF',
  
  // Billing
  SUBSCRIPTION_NOT_FOUND = 'SUBSCRIPTION_NOT_FOUND',
  PAYMENT_FAILED = 'PAYMENT_FAILED',
  LIMIT_EXCEEDED = 'LIMIT_EXCEEDED',
  TENANT_RESTRICTED = 'TENANT_RESTRICTED',
  
  // POS
  POS_INTEGRATION_NOT_FOUND = 'POS_INTEGRATION_NOT_FOUND',
  POS_WEBHOOK_INVALID_SIGNATURE = 'POS_WEBHOOK_INVALID_SIGNATURE',
  POS_CHECK_ALREADY_PROCESSED = 'POS_CHECK_ALREADY_PROCESSED',
  
  // Validation
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  INVALID_INPUT = 'INVALID_INPUT',
  
  // System
  INTERNAL_SERVER_ERROR = 'INTERNAL_SERVER_ERROR',
  SERVICE_UNAVAILABLE = 'SERVICE_UNAVAILABLE',
  RATE_LIMIT_EXCEEDED = 'RATE_LIMIT_EXCEEDED'
}
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```typescript
// –í —Å–µ—Ä–≤–∏—Å–µ
if (guestCard.totalBalance < requestedRedeem) {
  throw new BadRequestException({
    errorCode: ErrorCode.INSUFFICIENT_BALANCE,
    message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è',
    details: {
      requested: requestedRedeem,
      available: guestCard.totalBalance
    }
  });
}
```

**Response –ø—Ä–∏–º–µ—Ä—ã:**

```typescript
// 400 Bad Request
{
  "success": false,
  "error": {
    "code": "INSUFFICIENT_BALANCE",
    "message": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è",
    "details": {
      "requested": 500,
      "available": 285
    },
    "timestamp": "2026-02-10T14:29:00Z",
    "path": "/api/v1/loyalty/transactions",
    "requestId": "req-abc123"
  }
}

// 401 Unauthorized
{
  "success": false,
  "error": {
    "code": "TOKEN_EXPIRED",
    "message": "JWT token has expired",
    "details": {
      "expiredAt": "2026-02-10T12:00:00Z"
    },
    "timestamp": "2026-02-10T14:29:00Z",
    "path": "/api/v1/loyalty/rules",
    "requestId": "req-xyz789"
  }
}

// 403 Forbidden
{
  "success": false,
  "error": {
    "code": "FORBIDDEN",
    "message": "You don't have permission to access this resource",
    "details": {
      "requiredRole": "ADMIN",
      "userRole": "MANAGER"
    },
    "timestamp": "2026-02-10T14:29:00Z",
    "path": "/api/v1/loyalty/rules",
    "requestId": "req-def456"
  }
}
```


***

### 2Ô∏è‚É£6Ô∏è‚É£ **Input Validation —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ö–ª–∏–µ–Ω—Ç—ã (POS, Telegram, Admin Panel) –¥–æ–ª–∂–Ω—ã –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ–≤–µ—Ä–Ω–æ –≤ –∑–∞–ø—Ä–æ—Å–µ.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**class-validator + Custom Validation Pipe**

```typescript
// DTOs —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
import { IsString, IsNumber, Min, Max, IsOptional, IsEnum, ValidateNested } from 'class-validator';
import { Type } from 'class-transformer';

export class CreateLoyaltyRuleDto {
  @IsString()
  @MinLength(3, { message: '–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞' })
  @MaxLength(100)
  name: string;

  @IsNumber()
  @Min(1, { message: '–ü—Ä–æ—Ü–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 1%' })
  @Max(100, { message: '–ü—Ä–æ—Ü–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 100%' })
  earnPercent: number;

  @IsEnum(['ACTIVE', 'DRAFT', 'ARCHIVED'])
  status: string;

  @IsOptional()
  @ValidateNested()
  @Type(() => RuleConditionsDto)
  conditions?: RuleConditionsDto;
}

export class RuleConditionsDto {
  @IsNumber()
  @Min(50, { message: '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞ 50‚ÇΩ' })
  @IsOptional()
  minCheckAmount?: number;

  @IsArray()
  @IsNumber({}, { each: true })
  @Min(1, { each: true })
  @Max(7, { each: true })
  @IsOptional()
  daysOfWeek?: number[];  // 1-7 (–ü–Ω-–í—Å)
}
```

**Validation Pipe:**

```typescript
// main.ts
app.useGlobalPipes(
  new ValidationPipe({
    whitelist: true,           // –£–¥–∞–ª–∏—Ç—å –ª–∏—à–Ω–∏–µ –ø–æ–ª—è
    forbidNonWhitelisted: true, // –û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–∏—à–Ω–∏—Ö –ø–æ–ª—è—Ö
    transform: true,           // –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è —Ç–∏–ø–æ–≤
    transformOptions: {
      enableImplicitConversion: true
    },
    exceptionFactory: (errors) => {
      // –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
      const details = errors.map(error => ({
        field: error.property,
        value: error.value,
        constraints: Object.values(error.constraints || {})
      }));

      return new BadRequestException({
        errorCode: ErrorCode.VALIDATION_ERROR,
        message: 'Validation failed',
        details: details
      });
    }
  })
);
```

**Error Response –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**

```typescript
// POST /api/v1/loyalty/rules
{
  "name": "AB",          // –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ
  "earnPercent": 150,    // > 100
  "status": "INVALID"    // –ù–µ –≤ enum
}

// Response 400
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Validation failed",
    "details": [
      {
        "field": "name",
        "value": "AB",
        "constraints": ["–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞"]
      },
      {
        "field": "earnPercent",
        "value": 150,
        "constraints": ["–ü—Ä–æ—Ü–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 100%"]
      },
      {
        "field": "status",
        "value": "INVALID",
        "constraints": ["status must be one of: ACTIVE, DRAFT, ARCHIVED"]
      }
    ],
    "timestamp": "2026-02-10T14:29:00Z",
    "path": "/api/v1/loyalty/rules",
    "requestId": "req-123"
  }
}
```


***

### 2Ô∏è‚É£7Ô∏è‚É£ **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
POS –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å webhook –ø—Ä–∏ network retry. –ù–µ–ª—å–∑—è –¥–≤–∞–∂–¥—ã –Ω–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**Idempotency Key –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö + DB Constraints**

```typescript
// Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ idempotency key
@Injectable()
export class IdempotencyMiddleware implements NestMiddleware {
  constructor(
    private readonly redis: RedisService,
    private readonly prisma: PrismaService
  ) {}

  async use(req: Request, res: Response, next: NextFunction) {
    const idempotencyKey = req.headers['idempotency-key'] as string;

    if (!idempotencyKey) {
      // –î–ª—è POST/PUT/DELETE ‚Äî –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
      if (['POST', 'PUT', 'DELETE'].includes(req.method)) {
        return res.status(400).json({
          success: false,
          error: {
            code: 'IDEMPOTENCY_KEY_REQUIRED',
            message: 'Header "Idempotency-Key" is required for this operation'
          }
        });
      }
      return next();
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ Redis (–∫—ç—à –Ω–∞ 24 —á–∞—Å–∞)
    const cachedResponse = await this.redis.get(`idempotency:${idempotencyKey}`);

    if (cachedResponse) {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π response
      return res.status(200).json(JSON.parse(cachedResponse));
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π res.json
    const originalJson = res.json.bind(res);
    res.json = (data: any) => {
      // –ö—ç—à–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π response
      if (res.statusCode >= 200 && res.statusCode < 300) {
        this.redis.setex(`idempotency:${idempotencyKey}`, 86400, JSON.stringify(data));
      }
      return originalJson(data);
    };

    next();
  }
}
```

**DB Constraints –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏:**

```typescript
// POSTransaction ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π constraint
model POSTransaction {
  @@unique([tenantId, posSystem, posCheckId], name: "unique_pos_check")
}

// BallTransaction ‚Äî –Ω–µ–ª—å–∑—è –¥–≤–∞–∂–¥—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –æ–¥–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –∫ –æ–¥–Ω–æ–º—É —á–µ–∫—É
model BallTransaction {
  @@unique([posTransactionId, loyaltyRuleId], name: "unique_rule_per_check")
}

// BallTransfer ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
model BallTransfer {
  verificationCode String
  @@unique([fromCardId, verificationCode], name: "unique_transfer")
}
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```typescript
// POS webhook
POST /api/v1/pos/webhooks/transaction
Headers:
  Idempotency-Key: CHK-123456-IIKO-REST01
  X-POS-Signature: ...

// –ï—Å–ª–∏ webhook –ø—Ä–∏—à—ë–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ ‚Äî –≤–µ—Ä–Ω—ë–º —Ç–æ—Ç –∂–µ response –∏–∑ –∫—ç—à–∞
```


***

## üß™ **–ë–ª–æ–∫ 9: Testing Strategy**

### 2Ô∏è‚É£8Ô∏è‚É£ **Unit Tests –¥–ª—è Loyalty Engine**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ö—Ä–∏—Ç–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –±–∞–ª–ª–æ–≤, —É—Ä–æ–≤–Ω–µ–π, –ø—Ä–æ–º–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∫—Ä—ã—Ç–∞ —Ç–µ—Å—Ç–∞–º–∏.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**Jest + Test Coverage –º–∏–Ω–∏–º—É–º 80% –¥–ª—è core logic**

```typescript
// loyalty/services/__tests__/loyalty-calculation.service.spec.ts
describe('LoyaltyCalculationService', () => {
  let service: LoyaltyCalculationService;
  let prisma: PrismaService;

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      providers: [
        LoyaltyCalculationService,
        {
          provide: PrismaService,
          useValue: createMockPrismaService()
        }
      ]
    }).compile();

    service = module.get<LoyaltyCalculationService>(LoyaltyCalculationService);
    prisma = module.get<PrismaService>(PrismaService);
  });

  describe('calculateEarnPoints', () => {
    it('–¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏—Å–ª–∏—Ç—å 10% –æ—Ç —Å—É–º–º—ã —á–µ–∫–∞ –ø—Ä–∏ –±–∞–∑–æ–≤–æ–º –ø—Ä–∞–≤–∏–ª–µ', async () => {
      // Arrange
      const checkAmount = 2000;
      const rule = { earnPercent: 10, conditions: {} };

      // Act
      const result = await service.calculateEarnPoints(checkAmount, [rule]);

      // Assert
      expect(result.earnPoints).toBe(200);  // 2000 * 10% = 200
      expect(result.appliedRules).toHaveLength(1);
    });

    it('–¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–ø–∏—Å–∞–ª–∏ –±–∞–ª–ª–∞–º–∏', async () => {
      // Arrange
      const checkAmount = 2000;
      const redeemedPoints = 100;
      const rule = { earnPercent: 10, conditions: {} };

      // Act
      const result = await service.calculateEarnPoints(checkAmount, [rule]);

      // Assert
      expect(result.earnPoints).toBe(200);  // –û—Ç 2000, –Ω–µ –æ—Ç 1900
    });

    it('–¥–æ–ª–∂–µ–Ω –ø—Ä–∏–º–µ–Ω–∏—Ç—å –±–æ–Ω—É—Å —É—Ä–æ–≤–Ω—è Silver (+5%)', async () => {
      // Arrange
      const checkAmount = 2000;
      const rule = { earnPercent: 10, conditions: {} };
      const guestLevel = { name: 'SILVER', earnBonus: 5 };

      // Act
      const result = await service.calculateEarnPoints(checkAmount, [rule], guestLevel);

      // Assert
      expect(result.earnPoints).toBe(210);  // 200 + 5% = 210
    });

    it('–¥–æ–ª–∂–µ–Ω —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª –ø—Ä–∏ COMBINE_ALL', async () => {
      // Arrange
      const checkAmount = 2000;
      const rules = [
        { earnPercent: 10, conditions: {} },
        { earnPercent: 5, conditions: { timeRange: { from: '18:00', to: '23:00' } } }
      ];
      const currentTime = '19:00';

      // Act
      const result = await service.calculateEarnPoints(checkAmount, rules, null, currentTime);

      // Assert
      expect(result.earnPoints).toBe(300);  // 200 + 100 = 300
    });

    it('–¥–æ–ª–∂–µ–Ω –≤—ã–±—Ä–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–∏ MAX_ONLY', async () => {
      // Arrange
      const checkAmount = 2000;
      const rules = [
        { earnPercent: 10, conditions: {} },
        { earnPercent: 15, conditions: {} }
      ];
      const strategy = 'MAX_ONLY';

      // Act
      const result = await service.calculateEarnPoints(checkAmount, rules, null, null, strategy);

      // Assert
      expect(result.earnPoints).toBe(300);  // –¢–æ–ª—å–∫–æ 15%
      expect(result.appliedRules).toHaveLength(1);
    });
  });

  describe('calculateRedeemLimit', () => {
    it('–¥–æ–ª–∂–µ–Ω –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ 20% –æ—Ç —á–µ–∫–∞', async () => {
      // Arrange
      const checkAmount = 2000;
      const guestBalance = 1000;
      const maxRedeemPercent = 20;

      // Act
      const result = service.calculateRedeemLimit(checkAmount, guestBalance, maxRedeemPercent);

      // Assert
      expect(result.maxAmount).toBe(400);  // 20% –æ—Ç 2000
      expect(result.allowedRedeem).toBe(400);  // –ë–∞–ª–∞–Ω—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π
    });

    it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –±–∞–ª–∞–Ω—Å, –µ—Å–ª–∏ –æ–Ω –º–µ–Ω—å—à–µ –ª–∏–º–∏—Ç–∞', async () => {
      // Arrange
      const checkAmount = 2000;
      const guestBalance = 300;
      const maxRedeemPercent = 20;

      // Act
      const result = service.calculateRedeemLimit(checkAmount, guestBalance, maxRedeemPercent);

      // Assert
      expect(result.maxAmount).toBe(400);
      expect(result.allowedRedeem).toBe(300);  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω –±–∞–ª–∞–Ω—Å–æ–º
    });

    it('–¥–æ–ª–∂–µ–Ω –∑–∞–ø—Ä–µ—Ç–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ, –µ—Å–ª–∏ —á–µ–∫ < 50‚ÇΩ', async () => {
      // Arrange
      const checkAmount = 30;
      const guestBalance = 500;

      // Act
      const result = service.calculateRedeemLimit(checkAmount, guestBalance, 20);

      // Assert
      expect(result.allowedRedeem).toBe(0);
      expect(result.reason).toBe('CHECK_AMOUNT_TOO_LOW');
    });
  });

  describe('applyPromo', () => {
    it('–¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏—Å–ª–∏—Ç—å –ø—Ä–æ–º–æ-–±–∞–ª–ª—ã –∫ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º', async () => {
      // Arrange
      const baseEarn = 200;
      const promo = { bonusPoints: 500, type: 'BIRTHDAY', expiresInDays: 7 };

      // Act
      const result = service.applyPromo(baseEarn, promo);

      // Assert
      expect(result.totalEarn).toBe(700);  // 200 + 500
      expect(result.promoBonus).toBe(500);
    });

    it('–¥–æ–ª–∂–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å expiration –¥–ª—è –ø—Ä–æ–º–æ-–±–∞–ª–ª–æ–≤', async () => {
      // Arrange
      const promo = { bonusPoints: 500, type: 'BIRTHDAY', expiresInDays: 7 };

      // Act
      const result = service.applyPromo(0, promo);

      // Assert
      const expectedExpiry = new Date();
      expectedExpiry.setDate(expectedExpiry.getDate() + 7);
      
      expect(result.expiresAt).toBeDefined();
      expect(result.expiresAt.getDate()).toBe(expectedExpiry.getDate());
    });
  });
});
```

**Coverage targets:**

- **Core Loyalty Logic:** 90%+
- **Services:** 80%+
- **Controllers:** 70%+
- **Utils/Helpers:** 85%+

**CI/CD:**

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run test:cov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
```


***

### 2Ô∏è‚É£9Ô∏è‚É£ **Integration Tests –¥–ª—è API endpoints**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ–≥–æ flow: –æ—Ç HTTP request –¥–æ DB –∏ –æ–±—Ä–∞—Ç–Ω–æ.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**Supertest + Test Database**

```typescript
// loyalty/__tests__/loyalty.e2e-spec.ts
describe('Loyalty API (e2e)', () => {
  let app: INestApplication;
  let prisma: PrismaService;
  let authToken: string;

  beforeAll(async () => {
    const moduleFixture = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();

    prisma = app.get<PrismaService>(PrismaService);

    // Seed test data
    await seedTestData(prisma);

    // Get auth token
    const loginResponse = await request(app.getHttpServer())
      .post('/api/v1/auth/login')
      .send({ email: 'admin@test.com', password: 'password' });
    
    authToken = loginResponse.body.accessToken;
  });

  afterAll(async () => {
    await cleanupTestData(prisma);
    await app.close();
  });

  describe('POST /api/v1/loyalty/calculate', () => {
    it('–¥–æ–ª–∂–µ–Ω —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–ª—ã –¥–ª—è –≤–∞–ª–∏–¥–Ω–æ–≥–æ —á–µ–∫–∞', async () => {
      // Arrange
      const guestCard = await prisma.guestCard.findFirst();

      // Act
      const response = await request(app.getHttpServer())
        .post('/api/v1/loyalty/calculate')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          guestCardId: guestCard.id,
          restaurantId: guestCard.restaurantId,
          checkAmount: 2000
        })
        .expect(200);

      // Assert
      expect(response.body.calculation.earnPoints).toBeGreaterThan(0);
      expect(response.body.guestCard.id).toBe(guestCard.id);
    });

    it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 400 –ø—Ä–∏ —á–µ–∫–µ < 50‚ÇΩ', async () => {
      // Arrange
      const guestCard = await prisma.guestCard.findFirst();

      // Act
      const response = await request(app.getHttpServer())
        .post('/api/v1/loyalty/calculate')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          guestCardId: guestCard.id,
          restaurantId: guestCard.restaurantId,
          checkAmount: 30
        })
        .expect(400);

      // Assert
      expect(response.body.error.code).toBe('CHECK_AMOUNT_TOO_LOW');
    });

    it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 401 –±–µ–∑ auth token', async () => {
      await request(app.getHttpServer())
        .post('/api/v1/loyalty/calculate')
        .send({ guestCardId: 'any', restaurantId: 'any', checkAmount: 2000 })
        .expect(401);
    });
  });

  describe('POST /api/v1/loyalty/transactions', () => {
    it('–¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è/—Å–ø–∏—Å–∞–Ω–∏—è', async () => {
      // Arrange
      const guestCard = await prisma.guestCard.findFirst();
      const initialBalance = guestCard.totalBalance;

      // Act
      const response = await request(app.getHttpServer())
        .post('/api/v1/loyalty/transactions')
        .set('Authorization', `Bearer ${authToken}`)
        .set('Idempotency-Key', `test-${Date.now()}`)
        .send({
          guestCardId: guestCard.id,
          restaurantId: guestCard.restaurantId,
          transactionType: 'EARN_AND_REDEEM',
          checkAmount: 2000,
          redeemedPoints: 100,
          earnedPoints: 200,
          posCheckId: `CHK-${Date.now()}`,
          posSystem: 'IIKO'
        })
        .expect(201);

      // Assert
      expect(response.body.transactions).toHaveLength(2);  // REDEEM + EARN
      expect(response.body.guestCard.totalBalance).toBe(initialBalance - 100 + 200);

      // Verify in DB
      const updatedCard = await prisma.guestCard.findUnique({
        where: { id: guestCard.id }
      });
      expect(updatedCard.totalBalance).toBe(initialBalance - 100 + 200);
    });

    it('–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ', async () => {
      // Arrange
      const guestCard = await prisma.guestCard.findFirst();
      const idempotencyKey = `test-idempotent-${Date.now()}`;
      const requestPayload = {
        guestCardId: guestCard.id,
        restaurantId: guestCard.restaurantId,
        transactionType: 'EARN_ONLY',
        checkAmount: 1000,
        earnedPoints: 100,
        posCheckId: `CHK-IDEMPOTENT-${Date.now()}`,
        posSystem: 'IIKO'
      };

      // Act ‚Äî –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
      const response1 = await request(app.getHttpServer())
        .post('/api/v1/loyalty/transactions')
        .set('Authorization', `Bearer ${authToken}`)
        .set('Idempotency-Key', idempotencyKey)
        .send(requestPayload)
        .expect(201);

      // Act ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º
      const response2 = await request(app.getHttpServer())
        .post('/api/v1/loyalty/transactions')
        .set('Authorization', `Bearer ${authToken}`)
        .set('Idempotency-Key', idempotencyKey)
        .send(requestPayload)
        .expect(200);  // Cached response

      // Assert
      expect(response1.body.transactions[0].id).toBe(response2.body.transactions[0].id);

      // Verify —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ –ë–î
      const transactionsCount = await prisma.ballTransaction.count({
        where: {
          guestCardId: guestCard.id,
          amount: 100
        }
      });
      expect(transactionsCount).toBe(1);  // –ù–µ –∑–∞–¥—É–±–ª–∏—Ä–æ–≤–∞–ª–æ—Å—å
    });
  });

  describe('GET /api/v1/loyalty/rules', () => {
    it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª –¥–ª—è Admin', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/loyalty/rules')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body.rules).toBeInstanceOf(Array);
      expect(response.body.rules.length).toBeGreaterThan(0);
    });

    it('–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 403 –¥–ª—è Guest', async () => {
      // Arrange ‚Äî –ª–æ–≥–∏–Ω –∫–∞–∫ Guest
      const guestLoginResponse = await request(app.getHttpServer())
        .post('/api/v1/auth/guest/login')
        .send({ phone: '+79991234567', code: '123456' });
      
      const guestToken = guestLoginResponse.body.accessToken;

      // Act
      await request(app.getHttpServer())
        .get('/api/v1/loyalty/rules')
        .set('Authorization', `Bearer ${guestToken}`)
        .expect(403);
    });
  });
});
```

**Test Database:**

```typescript
// test/test-db.ts
export async function setupTestDatabase() {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é test DB
  process.env.DATABASE_URL = 'postgresql://test:test@localhost:5433/loyalty_test';
  
  // –ú–∏–≥—Ä–∞—Ü–∏–∏
  execSync('npx prisma migrate deploy', { stdio: 'inherit' });
}

export async function cleanupTestData(prisma: PrismaService) {
  await prisma.ballTransaction.deleteMany();
  await prisma.guestCard.deleteMany();
  await prisma.user.deleteMany();
  await prisma.tenant.deleteMany();
}

export async function seedTestData(prisma: PrismaService) {
  // –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, –ø—Ä–∞–≤–∏–ª–∞
  const tenant = await prisma.tenant.create({
    data: { name: 'Test Restaurant', status: 'ACTIVE' }
  });

  const user = await prisma.user.create({
    data: {
      email: 'admin@test.com',
      role: 'ADMIN',
      tenantId: tenant.id
    }
  });

  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
}
```


***

### 3Ô∏è‚É£0Ô∏è‚É£ **Load Testing –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö endpoints**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
POS –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç–Ω–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —á–∞—Å. –ù—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ API –≤—ã–¥–µ—Ä–∂–∏—Ç –Ω–∞–≥—Ä—É–∑–∫—É.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**k6 –¥–ª—è Load Testing**

```javascript
// tests/load/loyalty-calculate.js
import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate } from 'k6/metrics';

const errorRate = new Rate('errors');

export const options = {
  stages: [
    { duration: '2m', target: 100 },   // –†–∞–∑–≥–æ–Ω –¥–æ 100 VU
    { duration: '5m', target: 100 },   // –î–µ—Ä–∂–∏–º 100 VU
    { duration: '2m', target: 200 },   // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–æ 200 VU
    { duration: '5m', target: 200 },   // –î–µ—Ä–∂–∏–º 200 VU
    { duration: '2m', target: 0 },     // –ü–ª–∞–≤–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ
  ],
  thresholds: {
    'http_req_duration': ['p(95)<500', 'p(99)<1000'],  // 95% < 500ms, 99% < 1s
    'errors': ['rate<0.05'],  // –û—à–∏–±–æ–∫ < 5%
  },
};

const BASE_URL = __ENV.API_URL || 'http://localhost:3000';
const AUTH_TOKEN = __ENV.AUTH_TOKEN;

export default function () {
  const payload = JSON.stringify({
    guestCardId: 'guest-card-uuid-1',
    restaurantId: 'rest-uuid-1',
    checkAmount: 2000,
    requestedRedeem: 100
  });

  const params = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${AUTH_TOKEN}`,
    },
  };

  const res = http.post(`${BASE_URL}/api/v1/loyalty/calculate`, payload, params);

  const success = check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
    'has earnPoints': (r) => JSON.parse(r.body).calculation.earnPoints > 0,
  });

  errorRate.add(!success);

  sleep(1);
}
```

**–ó–∞–ø—É—Å–∫:**

```bash
k6 run --vus 100 --duration 10m tests/load/loyalty-calculate.js
```

**Targets:**

- **Throughput:** 500+ requests/sec
- **Latency:** p95 < 500ms, p99 < 1s
- **Error Rate:** < 1%
- **CPU:** < 70%
- **Memory:** Stable (no leaks)

***

## üîß **–ë–ª–æ–∫ 10: Database Optimization \& Caching**

### 3Ô∏è‚É£1Ô∏è‚É£ **Database Indexes –¥–ª—è production**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ß–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ `tenantId`, `guestCardId`, `restaurantId`. –ù—É–∂–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**Composite Indexes + Partial Indexes**

```prisma
// prisma/schema.prisma

model GuestCard {
  id              String   @id @default(uuid())
  userId          String
  tenantId        String
  restaurantId    String?
  totalBalance    Int      @default(0)
  regularBalance  Int      @default(0)
  promoBalance    Int      @default(0)
  level           String   @default("BRONZE")
  lifetimeSpent   Int      @default(0)
  lastActivityAt  DateTime @default(now())
  status          String   @default("ACTIVE")
  qrCode          String   @unique
  digitCode       String
  
  // –ò–Ω–¥–µ–∫—Å—ã
  @@index([tenantId, restaurantId, status])      // –°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
  @@index([tenantId, userId])                     // –ö–∞—Ä—Ç—ã –≥–æ—Å—Ç—è
  @@index([qrCode])                               // QR lookup
  @@index([digitCode, tenantId])                  // 6-digit lookup
  @@index([lastActivityAt, status])               // Ball expiration CRON
  @@index([lifetimeSpent, tenantId])              // Level recalculation
}

model BallTransaction {
  id                String   @id @default(uuid())
  guestCardId       String
  tenantId          String
  restaurantId      String?
  type              String
  amount            Int
  balanceType       String
  balanceBefore     Int
  balanceAfter      Int
  loyaltyRuleId     String?
  promoId           String?
  posTransactionId  String?
  createdAt         DateTime @default(now())
  
  // –ò–Ω–¥–µ–∫—Å—ã
  @@index([guestCardId, createdAt(sort: Desc)])   // –ò—Å—Ç–æ—Ä–∏—è –≥–æ—Å—Ç—è
  @@index([tenantId, restaurantId, createdAt])    // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
  @@index([posTransactionId])                     // POS reconciliation
  @@index([type, createdAt])                      // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º
  @@unique([posTransactionId, loyaltyRuleId])     // Idempotency
}

model POSTransaction {
  id            String   @id @default(uuid())
  tenantId      String
  restaurantId  String
  posSystem     String
  posCheckId    String
  checkAmount   Decimal
  createdAt     DateTime @default(now())
  
  @@unique([tenantId, posSystem, posCheckId])     // Idempotency
  @@index([tenantId, restaurantId, createdAt])    // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
}

model LoyaltyRule {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  earnPercent Int
  status      String
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  
  @@index([tenantId, status])                     // –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
}

model PromoBallGranted {
  id              String   @id @default(uuid())
  guestCardId     String
  promoId         String
  amountInitial   Int
  amountRemaining Int
  expiresAt       DateTime?
  
  @@index([guestCardId, amountRemaining])         // –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–æ –≥–æ—Å—Ç—è
  @@index([expiresAt])                            // Expiration CRON
}

model AnalyticsDailySnapshot {
  id           String   @id @default(uuid())
  tenantId     String
  restaurantId String?
  date         DateTime
  totalRevenue Decimal
  totalChecks  Int
  // ... –¥—Ä—É–≥–∏–µ –º–µ—Ç—Ä–∏–∫–∏
  
  @@unique([tenantId, restaurantId, date])        // –û–¥–Ω–∞ –∑–∞–ø–∏—Å—å –Ω–∞ –¥–µ–Ω—å
  @@index([tenantId, date(sort: Desc)])           // Trends
}
```

**Partial Indexes (PostgreSQL-specific):**

```sql
-- –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞—Ä—Ç—ã
CREATE INDEX idx_active_guest_cards 
ON "GuestCard" (tenant_id, status) 
WHERE status = 'ACTIVE';

-- –¢–æ–ª—å–∫–æ –∫–∞—Ä—Ç—ã —Å –±–∞–ª–∞–Ω—Å–æ–º > 0 –¥–ª—è expiration
CREATE INDEX idx_cards_with_balance 
ON "GuestCard" (last_activity_at) 
WHERE total_balance > 0 AND status = 'ACTIVE';
```


***

### 3Ô∏è‚É£2Ô∏è‚É£ **Redis Caching Strategy**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ß–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã: –±–∞–ª–∞–Ω—Å –≥–æ—Å—Ç—è, –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞. –ù—É–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**Multi-Level Caching: Redis + In-Memory (Node cache)**

```typescript
// common/cache/cache.service.ts
@Injectable()
export class CacheService {
  constructor(
    private readonly redis: Redis,
    private readonly nodeCache: NodeCache  // In-memory –¥–ª—è hot data
  ) {}

  async get<T>(key: string): Promise<T | null> {
    // 1Ô∏è‚É£ Check in-memory cache first (fastest)
    const memoryValue = this.nodeCache.get<T>(key);
    if (memoryValue) {
      return memoryValue;
    }

    // 2Ô∏è‚É£ Check Redis
    const redisValue = await this.redis.get(key);
    if (redisValue) {
      const parsed = JSON.parse(redisValue) as T;
      // Warm up memory cache
      this.nodeCache.set(key, parsed, 60);  // 1 min in memory
      return parsed;
    }

    return null;
  }

  async set<T>(key: string, value: T, ttl: number): Promise<void> {
    // Set in both layers
    this.nodeCache.set(key, value, Math.min(ttl, 300));  // Max 5 min in memory
    await this.redis.setex(key, ttl, JSON.stringify(value));
  }

  async del(key: string): Promise<void> {
    this.nodeCache.del(key);
    await this.redis.del(key);
  }

  async invalidatePattern(pattern: string): Promise<void> {
    // Invalidate all keys matching pattern
    const keys = await this.redis.keys(pattern);
    if (keys.length > 0) {
      await this.redis.del(...keys);
    }
    // Clear entire memory cache (simple approach)
    this.nodeCache.flushAll();
  }
}
```

**Cache Keys Convention:**

```typescript
// –ü—Ä–∏–º–µ—Ä—ã cache keys
const CACHE_KEYS = {
  // Guest Card
  guestCard: (cardId: string) => `guest:card:${cardId}`,
  guestCardByQR: (qrCode: string) => `guest:card:qr:${qrCode}`,
  guestCardByPhone: (phone: string) => `guest:card:phone:${phone}`,
  
  // Loyalty Rules
  activeLoyaltyRules: (tenantId: string) => `loyalty:rules:active:${tenantId}`,
  loyaltyRule: (ruleId: string) => `loyalty:rule:${ruleId}`,
  
  // Promos
  activePromos: (tenantId: string) => `promos:active:${tenantId}`,
  eligiblePromos: (guestCardId: string) => `promos:eligible:${guestCardId}`,
  
  // Analytics
  restaurantDailyStats: (tenantId: string, restaurantId: string, date: string) => 
    `analytics:daily:${tenantId}:${restaurantId}:${date}`,
  platformMetrics: (period: string) => `analytics:platform:${period}`,
  
  // Session
  userSession: (userId: string, sessionId: string) => `session:${userId}:${sessionId}`,
};
```

**Usage –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö:**

```typescript
// loyalty/services/loyalty.service.ts
@Injectable()
export class LoyaltyService {
  constructor(
    private readonly prisma: PrismaService,
    private readonly cache: CacheService
  ) {}

  async getGuestCard(cardId: string): Promise<GuestCard> {
    // 1Ô∏è‚É£ Try cache
    const cached = await this.cache.get<GuestCard>(CACHE_KEYS.guestCard(cardId));
    if (cached) {
      return cached;
    }

    // 2Ô∏è‚É£ Fetch from DB
    const card = await this.prisma.guestCard.findUnique({
      where: { id: cardId }
    });

    // 3Ô∏è‚É£ Store in cache (TTL 5 min)
    await this.cache.set(CACHE_KEYS.guestCard(cardId), card, 300);

    return card;
  }

  async updateGuestCard(cardId: string, data: Partial<GuestCard>): Promise<GuestCard> {
    const updated = await this.prisma.guestCard.update({
      where: { id: cardId },
      data
    });

    // Invalidate cache
    await this.cache.del(CACHE_KEYS.guestCard(cardId));
    
    // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–∏–ª—Å—è QR ‚Äî –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ QR-cache
    if (data.qrCode) {
      await this.cache.del(CACHE_KEYS.guestCardByQR(updated.qrCode));
    }

    return updated;
  }

  async getActiveLoyaltyRules(tenantId: string): Promise<LoyaltyRule[]> {
    const cacheKey = CACHE_KEYS.activeLoyaltyRules(tenantId);
    
    // Cache –Ω–∞ 10 –º–∏–Ω—É—Ç (–ø—Ä–∞–≤–∏–ª–∞ –º–µ–Ω—è—é—Ç—Å—è —Ä–µ–¥–∫–æ)
    const cached = await this.cache.get<LoyaltyRule[]>(cacheKey);
    if (cached) {
      return cached;
    }

    const rules = await this.prisma.loyaltyRule.findMany({
      where: { tenantId, status: 'ACTIVE' },
      orderBy: { priority: 'asc' }
    });

    await this.cache.set(cacheKey, rules, 600);  // 10 min

    return rules;
  }
}
```

**Cache Invalidation Strategy:**

```typescript
// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª–∞ ‚Äî –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏
async updateLoyaltyRule(ruleId: string, data: UpdateRuleDto): Promise<LoyaltyRule> {
  const rule = await this.prisma.loyaltyRule.update({
    where: { id: ruleId },
    data
  });

  // Invalidate pattern
  await this.cache.invalidatePattern(`loyalty:rules:active:${rule.tenantId}*`);
  await this.cache.del(CACHE_KEYS.loyaltyRule(ruleId));

  return rule;
}
```

**TTL Guidelines:**

- **Hot data (–±–∞–ª–∞–Ω—Å, –∫–∞—Ä—Ç—ã):** 5 –º–∏–Ω—É—Ç
- **Warm data (–ø—Ä–∞–≤–∏–ª–∞, –ø—Ä–æ–º–æ):** 10 –º–∏–Ω—É—Ç
- **Cold data (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞):** 1 —á–∞—Å
- **Session data:** 24 —á–∞—Å–∞
- **Idempotency keys:** 24 —á–∞—Å–∞

***

### 3Ô∏è‚É£3Ô∏è‚É£ **Connection Pooling \& Query Optimization**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
Prisma –¥–æ–ª–∂–µ–Ω —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å PostgreSQL –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**PgBouncer + Prisma Connection Pool**

```typescript
// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Connection pooling —á–µ—Ä–µ–∑ Prisma
  relationMode = "prisma"
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "metrics"]
}
```

**Connection Pool Config:**

```typescript
// database/prisma.service.ts
@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit {
  constructor() {
    super({
      datasources: {
        db: {
          url: process.env.DATABASE_URL,
        },
      },
      log: process.env.NODE_ENV === 'production' 
        ? ['error'] 
        : ['query', 'error', 'warn'],
    });

    // Prisma connection pool settings
    this.$connect({
      connectionLimit: 100,        // Max connections
      connectionTimeout: 5000,     // 5 sec timeout
      poolTimeout: 10000,          // 10 sec pool wait
    });
  }

  async onModuleInit() {
    await this.$connect();
    
    // Enable query logging in dev
    if (process.env.NODE_ENV !== 'production') {
      this.$on('query', (e) => {
        console.log('Query: ' + e.query);
        console.log('Duration: ' + e.duration + 'ms');
      });
    }
  }

  async enableShutdownHooks(app: INestApplication) {
    this.$on('beforeExit', async () => {
      await app.close();
    });
  }
}
```

**PgBouncer (external pool):**

```ini
# pgbouncer.ini
[databases]
loyalty_db = host=postgres port=5432 dbname=loyalty

[pgbouncer]
listen_port = 6432
listen_addr = *
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

# Pool settings
pool_mode = transaction              # Best for web apps
max_client_conn = 1000               # Max client connections
default_pool_size = 25               # Connections per DB
reserve_pool_size = 10               # Emergency pool
reserve_pool_timeout = 5

# Timeouts
server_idle_timeout = 600
server_lifetime = 3600
server_connect_timeout = 15
query_timeout = 30
```

**Query Optimization Tips:**

```typescript
// ‚ùå BAD ‚Äî N+1 query problem
async getGuestCardsWithUsers() {
  const cards = await this.prisma.guestCard.findMany();
  for (const card of cards) {
    card.user = await this.prisma.user.findUnique({ where: { id: card.userId } });
  }
  return cards;
}

// ‚úÖ GOOD ‚Äî Use include/select
async getGuestCardsWithUsers() {
  return this.prisma.guestCard.findMany({
    include: {
      user: {
        select: { id: true, firstName: true, phone: true }  // Only needed fields
      }
    }
  });
}

// ‚úÖ GOOD ‚Äî Batch queries
async getGuestCardsByIds(ids: string[]) {
  return this.prisma.guestCard.findMany({
    where: { id: { in: ids } }
  });
}

// ‚úÖ GOOD ‚Äî Use pagination
async getGuestCards(page: number, limit: number) {
  const skip = (page - 1) * limit;
  
  const [cards, total] = await Promise.all([
    this.prisma.guestCard.findMany({
      skip,
      take: limit,
      orderBy: { createdAt: 'desc' }
    }),
    this.prisma.guestCard.count()
  ]);
  
  return { cards, total, pages: Math.ceil(total / limit) };
}
```


***

### 3Ô∏è‚É£4Ô∏è‚É£ **Database Transactions –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤, –ø–µ—Ä–µ–≤–æ–¥—ã, –º–∏–≥—Ä–∞—Ü–∏–∏ UNIFIED‚ÜîSEPARATE ‚Äî –≤—Å—ë –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–º.

**–ú–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**

**Prisma Interactive Transactions + Retry Logic**

```typescript
// loyalty/services/loyalty-transaction.service.ts
@Injectable()
export class LoyaltyTransactionService {
  constructor(private readonly prisma: PrismaService) {}

  async processTransaction(dto: ProcessTransactionDto): Promise<TransactionResult> {
    return this.prisma.$transaction(
      async (tx) => {
        // 1Ô∏è‚É£ Lock guest card (SELECT FOR UPDATE)
        const guestCard = await tx.guestCard.findUnique({
          where: { id: dto.guestCardId },
          // Pessimistic lock
        });

        if (!guestCard) {
          throw new NotFoundException('Guest card not found');
        }

        // 2Ô∏è‚É£ Check balance if redeeming
        if (dto.redeemedPoints > 0 && guestCard.totalBalance < dto.redeemedPoints) {
          throw new BadRequestException('Insufficient balance');
        }

        // 3Ô∏è‚É£ Create POSTransaction (idempotency check)
        let posTransaction;
        try {
          posTransaction = await tx.posTransaction.create({
            data: {
              tenantId: dto.tenantId,
              restaurantId: dto.restaurantId,
              posSystem: dto.posSystem,
              posCheckId: dto.posCheckId,
              checkAmount: dto.checkAmount,
            }
          });
        } catch (e) {
          if (e.code === 'P2002') {  // Unique constraint violation
            // Already processed
            throw new ConflictException('Transaction already processed');
          }
          throw e;
        }

        const transactions: BallTransaction[] = [];

        // 4Ô∏è‚É£ Process REDEEM
        if (dto.redeemedPoints > 0) {
          const { promoUsed, regularUsed } = this.calculateRedemption(
            dto.redeemedPoints,
            guestCard.promoBalance,
            guestCard.regularBalance
          );

          if (promoUsed > 0) {
            const redeemPromoTx = await tx.ballTransaction.create({
              data: {
                guestCardId: guestCard.id,
                tenantId: dto.tenantId,
                restaurantId: dto.restaurantId,
                type: 'REDEEM',
                amount: -promoUsed,
                balanceType: 'PROMO',
                balanceBefore: guestCard.promoBalance,
                balanceAfter: guestCard.promoBalance - promoUsed,
                posTransactionId: posTransaction.id,
              }
            });
            transactions.push(redeemPromoTx);
          }

          if (regularUsed > 0) {
            const redeemRegularTx = await tx.ballTransaction.create({
              data: {
                guestCardId: guestCard.id,
                tenantId: dto.tenantId,
                restaurantId: dto.restaurantId,
                type: 'REDEEM',
                amount: -regularUsed,
                balanceType: 'REGULAR',
                balanceBefore: guestCard.regularBalance - promoUsed,
                balanceAfter: guestCard.regularBalance - promoUsed - regularUsed,
                posTransactionId: posTransaction.id,
              }
            });
            transactions.push(redeemRegularTx);
          }

          // Update balances
          guestCard.promoBalance -= promoUsed;
          guestCard.regularBalance -= regularUsed;
          guestCard.totalBalance -= dto.redeemedPoints;
        }

        // 5Ô∏è‚É£ Process EARN
        if (dto.earnedPoints > 0) {
          const earnTx = await tx.ballTransaction.create({
            data: {
              guestCardId: guestCard.id,
              tenantId: dto.tenantId,
              restaurantId: dto.restaurantId,
              type: 'EARN',
              amount: dto.earnedPoints,
              balanceType: 'REGULAR',
              balanceBefore: guestCard.regularBalance,
              balanceAfter: guestCard.regularBalance + dto.earnedPoints,
              posTransactionId: posTransaction.id,
              loyaltyRuleId: dto.appliedRuleId,
            }
          });
          transactions.push(earnTx);

          guestCard.regularBalance += dto.earnedPoints;
          guestCard.totalBalance += dto.earnedPoints;
        }

        // 6Ô∏è‚É£ Update lifetimeSpent
        guestCard.lifetimeSpent += dto.checkAmount;
        guestCard.lastActivityAt = new Date();

        // 7Ô∏è‚É£ Generate new QR + digit code
        const newQrCode = generateQRCode();
        const newDigitCode = generateDigitCode();

        // 8Ô∏è‚É£ Update guest card
        const updatedCard = await tx.guestCard.update({
          where: { id: guestCard.id },
          data: {
            regularBalance: guestCard.regularBalance,
            promoBalance: guestCard.promoBalance,
            totalBalance: guestCard.totalBalance,
            lifetimeSpent: guestCard.lifetimeSpent,
            lastActivityAt: guestCard.lastActivityAt,
            qrCode: newQrCode,
            digitCode: newDigitCode,
          }
        });

        // 9Ô∏è‚É£ Create GuestVisit
        const visit = await tx.guestVisit.create({
          data: {
            guestCardId: guestCard.id,
            tenantId: dto.tenantId,
            restaurantId: dto.restaurantId,
            checkAmount: dto.checkAmount,
            earnedPoints: dto.earnedPoints,
            redeemedPoints: dto.redeemedPoints,
            visitDate: new Date(),
          }
        });

        return {
          transactions,
          guestCard: updatedCard,
          visit,
        };
      },
      {
        maxWait: 5000,      // Max 5 sec wait for transaction to start
        timeout: 10000,     // Max 10 sec execution time
        isolationLevel: 'Serializable',  // Highest isolation
      }
    );
  }

  private calculateRedemption(
    requestedRedeem: number,
    promoBalance: number,
    regularBalance: number
  ) {
    // –°–Ω–∞—á–∞–ª–∞ —Å–ø–∏—Å—ã–≤–∞–µ–º —Å –ø—Ä–æ–º–æ
    const promoUsed = Math.min(requestedRedeem, promoBalance);
    const remainingToRedeem = requestedRedeem - promoUsed;
    const regularUsed = Math.min(remainingToRedeem, regularBalance);

    return { promoUsed, regularUsed };
  }
}
```

**Retry on Deadlock:**

```typescript
async executeWithRetry<T>(
  operation: () => Promise<T>,
  maxRetries = 3
): Promise<T> {
  let attempt = 0;

  while (attempt < maxRetries) {
    try {
      return await operation();
    } catch (error) {
      if (error.code === 'P2034') {  // Transaction conflict (deadlock)
        attempt++;
        if (attempt >= maxRetries) {
          throw error;
        }
        // Exponential backoff
        await new Promise(resolve => setTimeout(resolve, 100 * Math.pow(2, attempt)));
      } else {
        throw error;
      }
    }
  }
}
```


***

–í—Å—ë! –≠—Ç–æ –±—ã–ª–∏ –≤—Å–µ **34 –≤–æ–ø—Ä–æ—Å–∞** –ø–æ Backend API \& Services.

## üìù –†–µ–∑—é–º–µ –±–ª–æ–∫–æ–≤:

1. ‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** (3 –≤–æ–ø—Ä–æ—Å–∞) ‚Äî Modular Monolith, NestJS, REST API, –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
2. ‚úÖ **Auth \& Authorization** (3 –≤–æ–ø—Ä–æ—Å–∞) ‚Äî RBAC Guards, Impersonation, Rate Limiting
3. ‚úÖ **Loyalty Engine API** (4 –≤–æ–ø—Ä–æ—Å–∞) ‚Äî Calculate, Transactions, Manual Adjustments, Transfers
4. ‚úÖ **Loyalty Builder API** (3 –≤–æ–ø—Ä–æ—Å–∞) ‚Äî CRUD –¥–ª—è Rules/Levels/Promos
5. ‚úÖ **Background Jobs** (3 –≤–æ–ø—Ä–æ—Å–∞) ‚Äî BullMQ, CRON, Expiration, Reconciliation
6. ‚úÖ **Analytics API** (5 –≤–æ–ø—Ä–æ—Å–æ–≤) ‚Äî Owner/Admin/Manager/Guest analytics, Export
7. ‚úÖ **Notifications API** (3 –≤–æ–ø—Ä–æ—Å–∞) ‚Äî Centralized service, Guest settings, History
8. ‚úÖ **Error Handling** (3 –≤–æ–ø—Ä–æ—Å–∞) ‚Äî Global filter, Custom codes, Validation, Idempotency
9. ‚úÖ **Testing** (3 –≤–æ–ø—Ä–æ—Å–∞) ‚Äî Unit, Integration, Load testing
10. ‚úÖ **Database \& Caching** (4 –≤–æ–ø—Ä–æ—Å–∞) ‚Äî Indexes, Redis, Connection Pooling, Transactions

***

**–ß—Ç–æ –¥–∞–ª—å—à–µ?**

1. ‚úÖ **"–í—Å—ë —è—Å–Ω–æ, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –±–ª–æ–∫—É"** ‚Äî –∫–∞–∫–æ–π –±–ª–æ–∫ —Ö–æ—á–µ—à—å? (Frontend Admin Panel, Infrastructure \& DevOps, –∏–ª–∏ —á—Ç–æ-—Ç–æ –µ—â—ë?)
2. üîç **"–î–∞–≤–∞–π —É–≥–ª—É–±–∏–º—Å—è –≤ X"** ‚Äî —Ö–æ—á–µ—à—å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫–æ–π-—Ç–æ –∏–∑ 34 –≤–æ–ø—Ä–æ—Å–æ–≤?
3. üìÑ **"–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é"** ‚Äî OpenAPI/Swagger spec –¥–ª—è –≤—Å–µ—Ö endpoints?
4. üíª **"–ü–æ–∫–∞–∂–∏ –∫–æ–¥"** ‚Äî –ø—Ä–∏–º–µ—Ä—ã –ø–æ–ª–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤/—Å–µ—Ä–≤–∏—Å–æ–≤?

–ñ–¥—É —Ç–≤–æ–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è! üöÄ

---

# –û—Ç–≤–µ—á–∞—é –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã :

1. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
2. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
3. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
4. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
5.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
6.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
7.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
8.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
9.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
10.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
11.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
12.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
13.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
14.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
15.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
16.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
17.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
18.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
19.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
20.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
21.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
22.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
23.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
24.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
25.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
26.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
27.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
28.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
29.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
30.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
31.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
32.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
33.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
34.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ

–£—á–∏—Ç—ã–≤–∞—è –æ—Ç–≤–µ—Ç—ã, –≤—ã–≤–µ–¥–∏ —Å—é–¥–∞ –≤ —á–∞—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ—Å–ª–µ –ø—Ä–∏—Å—Ç—É–ø–∏–º –∫ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–ª–æ–∫–∞

–û—Ç–ª–∏—á–Ω–æ! –í—Å–µ 34 —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏–Ω—è—Ç—ã. –°–µ–π—á–∞—Å —Å—Ñ–æ—Ä–º–∏—Ä—É—é **–ø–æ–¥—Ä–æ–±–Ω—ã–π –∏—Ç–æ–≥–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç** –ø–æ Backend API \& Services.

***

# üéØ Backend API \& Services ‚Äî –§–∏–Ω–∞–ª—å–Ω–∞—è –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è

## –î–∞—Ç–∞ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: 10 —Ñ–µ–≤—Ä–∞–ª—è 2026


***

## üì¶ **1. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ò TECHNOLOGY STACK**

### 1.1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Å—Ç–∏–ª—å

**‚úÖ –†–ï–®–ï–ù–ò–ï: Modular Monolith —Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–æ–π –∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º**

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:**

```
loyalty-platform/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ api/                    # Main REST API (NestJS)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.module.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ loyalty/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ guests/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ billing/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pos/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ telegram/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ analytics/
‚îÇ   ‚îú‚îÄ‚îÄ worker/                 # Background jobs (BullMQ)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ processors/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ loyalty-recalc.processor.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ball-expiration.processor.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ pos-reconciliation.processor.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ analytics.processor.ts
‚îÇ   ‚îî‚îÄ‚îÄ cron/                   # Scheduled tasks
‚îÇ       ‚îî‚îÄ‚îÄ src/
‚îÇ           ‚îî‚îÄ‚îÄ jobs/
‚îú‚îÄ‚îÄ libs/                       # Shared libraries
‚îÇ   ‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ decorators/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ filters/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ interceptors/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prisma/
‚îÇ   ‚îî‚îÄ‚îÄ config/
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma
‚îÇ   ‚îî‚îÄ‚îÄ migrations/
‚îî‚îÄ‚îÄ package.json
```

**Tech Stack:**

- **Framework:** NestJS v10+ (TypeScript)
- **Runtime:** Node.js v20 LTS
- **ORM:** Prisma v5+
- **Database:** PostgreSQL 15+
- **Queue:** BullMQ (Redis 7+)
- **Cache:** Redis 7+
- **Validation:** class-validator, class-transformer
- **API Docs:** Swagger/OpenAPI 3.0
- **Testing:** Jest, Supertest, k6
- **Logging:** Winston + ELK Stack (Elasticsearch, Logstash, Kibana)

***

### 1.2. API Protocol

**‚úÖ –†–ï–®–ï–ù–ò–ï: REST API (–æ—Å–Ω–æ–≤–Ω–æ–π) + GraphQL (Phase 2 –¥–ª—è Admin Panel)**

**Base URL:**

```
https://api.max-loyalty.com/api/v1
```

**Endpoint Structure:**

```
/api/v1/auth/*              # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
/api/v1/loyalty/*           # Loyalty Engine (–ø—Ä–∞–≤–∏–ª–∞, —É—Ä–æ–≤–Ω–∏, –ø—Ä–æ–º–æ)
/api/v1/guests/*            # –ì–æ—Å—Ç–∏ –∏ –∫–∞—Ä—Ç—ã
/api/v1/pos/*               # POS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
/api/v1/billing/*           # –ü–æ–¥–ø–∏—Å–∫–∏ –∏ –ø–ª–∞—Ç–µ–∂–∏
/api/v1/analytics/*         # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á—ë—Ç—ã
/api/v1/telegram/*          # Telegram webhooks
/api/v1/notifications/*     # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```


***

### 1.3. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ API

**‚úÖ –†–ï–®–ï–ù–ò–ï: URL Versioning + Header Versioning –¥–ª—è Beta**

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:**

- **v1** ‚Äî —Ç–µ–∫—É—â–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è (GA)
- **v2** ‚Äî –º–∞–∂–æ—Ä–Ω—ã–µ breaking changes (–∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è)
- **Beta** ‚Äî —á–µ—Ä–µ–∑ header `X-API-Version: beta`

**Lifecycle:**

- v1 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º **12 –º–µ—Å—è—Ü–µ–≤** –ø–æ—Å–ª–µ —Ä–µ–ª–∏–∑–∞ v2
- Deprecation warnings –≤ response headers: `X-API-Deprecation-Date`, `X-API-Sunset-Date`
- Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Admin'–∞–º –∑–∞ **6 –º–µ—Å—è—Ü–µ–≤** –¥–æ EOL

**–ü—Ä–∏–º–µ—Ä—ã:**

```bash
# v1 (—Å—Ç–∞–±–∏–ª—å–Ω–∞—è)
GET /api/v1/guests/:id

# v2 (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏)
GET /api/v2/guests/:id

# Beta —Ñ—É–Ω–∫—Ü–∏–∏
GET /api/v1/guests/:id
Header: X-API-Version: beta
```


***

## üîê **2. AUTHENTICATION \& AUTHORIZATION**

### 2.1. RBAC Middleware

**‚úÖ –†–ï–®–ï–ù–ò–ï: Guard-based RBAC + Custom Decorator –¥–ª—è Permissions**

**–†–æ–ª–∏:**

- `OWNER` ‚Äî –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
- `ADMIN` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏–º tenant'–æ–º
- `MANAGER` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–º
- `CASHIER` ‚Äî –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –≥–æ—Å—Ç—è–º–∏ –∏ —á–µ–∫–∞–º–∏
- `GUEST` ‚Äî –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```typescript
// Decorator –¥–ª—è —Ä–æ–ª–µ–π
@Roles('ADMIN', 'MANAGER')
@Get('rules')
async getRules() { ... }

// Decorator –¥–ª—è —Ç–æ—á–Ω—ã—Ö permissions
@RequirePermission('loyalty:rules:create')
@Post('rules')
async createRule() { ... }

// Tenant Isolation (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
// user.role !== 'OWNER' => —Ñ–∏–ª—å—Ç—Ä WHERE tenant_id = user.tenantId
```

**Permissions –≤ –ë–î:**

```typescript
model UserPermission {
  userId     String
  permission String  // 'loyalty:rules:create', 'loyalty:rules:update', etc.
  tenantId   String
  grantedAt  DateTime
}
```


***

### 2.2. Impersonation –¥–ª—è Owner

**‚úÖ –†–ï–®–ï–ù–ò–ï: Separate Impersonation Token + Audit Log**

**Flow:**

1. Owner –≤—ã–∑—ã–≤–∞–µ—Ç `POST /api/v1/auth/impersonate` —Å `targetUserId`
2. Backend –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π JWT —Å TTL 2 —á–∞—Å–∞
3. –í —Ç–æ–∫–µ–Ω–µ: `originalUserId` + `impersonatedUserId` + `isImpersonating: true`
4. –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —Ñ–ª–∞–≥–æ–º `performedViaImpersonation: true`
5. UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—Ä–∞—Å–Ω—É—é –ø–æ–ª–æ—Å–∫—É: **"–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ [User Name] (Owner Mode)"**

**Audit Log:**

```typescript
ActivityLog {
  actionType: 'IMPERSONATION_START',
  performedBy: ownerId,
  targetUser: targetUserId,
  ipAddress: '...',
  metadata: { reason: 'Debug guest issue #123' }
}
```


***

### 2.3. Rate Limiting

**‚úÖ –†–ï–®–ï–ù–ò–ï: –ì–∏–±—Ä–∏–¥–Ω—ã–π (–≥–ª–æ–±–∞–ª—å–Ω—ã–π + per-role + per-endpoint)**

**–õ–∏–º–∏—Ç—ã:**


| –†–æ–ª—å | Requests/min | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| GUEST | 60 | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ |
| CASHIER | 120 | –ß–∞—Å—Ç—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —á–µ–∫–∞–º–∏ |
| MANAGER | 200 | –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ + —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ |
| ADMIN | 500 | –ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ |
| OWNER | 1000 | –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ + impersonation |

**–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã:**

- **POS webhooks:** 10/sec –Ω–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω
- **–ü–µ—Ä–µ–≤–æ–¥—ã –±–∞–ª–ª–æ–≤:** 3/min –Ω–∞ –≥–æ—Å—Ç—è
- **SMS –∫–æ–¥—ã:** 5/hour –Ω–∞ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞

**–•—Ä–∞–Ω–µ–Ω–∏–µ:** Redis —Å TTL

**Response Headers:**

```
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 42
X-RateLimit-Reset: 1675958400
```


***

## üéØ **3. LOYALTY ENGINE API**

### 3.1. –†–∞—Å—á—ë—Ç –±–∞–ª–ª–æ–≤ (Pre-calculation)

**‚úÖ –†–ï–®–ï–ù–ò–ï: POST /api/v1/loyalty/calculate**

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** POS/–ö–∞—Å—Å–∞ –≤—ã–∑—ã–≤–∞–µ—Ç –î–û –∑–∞–∫—Ä—ã—Ç–∏—è —á–µ–∫–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∏ –ª–∏–º–∏—Ç–∞ —Å–ø–∏—Å–∞–Ω–∏—è.

**Request:**

```json
POST /api/v1/loyalty/calculate
{
  "guestCardId": "card-uuid",
  "restaurantId": "rest-uuid",
  "checkAmount": 2000,
  "items": [
    {
      "itemId": "item-1",
      "name": "–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞",
      "category": "pizza",
      "price": 800,
      "quantity": 1
    }
  ],
  "requestedRedeem": 100
}
```

**Response:**

```json
{
  "guestCard": {
    "id": "card-uuid",
    "regularBalance": 2500,
    "promoBalance": 300,
    "totalBalance": 2800,
    "level": "SILVER",
    "lifetimeSpent": 150000
  },
  "calculation": {
    "earnPoints": 200,
    "appliedRules": [
      {
        "ruleId": "rule-uuid",
        "ruleName": "–ë–∞–∑–æ–≤—ã–π –∫–µ—à–±—ç–∫ 10%",
        "earnPercent": 10,
        "earnAmount": 200
      }
    ],
    "appliedPromos": [
      {
        "promoId": "promo-uuid",
        "promoName": "–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è",
        "bonusPoints": 500,
        "expiresAt": "2026-02-10T23:59:59Z"
      }
    ],
    "redeemLimit": {
      "maxPercent": 20,
      "maxAmount": 400,
      "minCheckAmount": 50,
      "requestedRedeem": 100,
      "allowedRedeem": 100,
      "promoBalanceUsed": 100,
      "regularBalanceUsed": 0
    }
  },
  "finalCheckAmount": 1900,
  "balanceAfterTransaction": 2700,
  "newBalanceAfterEarn": 2900,
  "warnings": []
}
```

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**

- ‚úÖ **1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å** (–≥–ª–æ–±–∞–ª—å–Ω–æ)
- ‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ **–≤—Å–µ–≥–¥–∞ –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞** (–¥–∞–∂–µ –µ—Å–ª–∏ —Å–ø–∏—Å–∞–ª–∏ –±–∞–ª–ª–∞–º–∏)
- ‚úÖ –õ–∏–º–∏—Ç —Å–ø–∏—Å–∞–Ω–∏—è: **10-100%** –æ—Ç —á–µ–∫–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è Admin'–æ–º, –¥–µ—Ñ–æ–ª—Ç 20%)
- ‚úÖ –ú–∏–Ω–∏–º—É–º —á–µ–∫–∞: **50 —Ä—É–±–ª–µ–π** (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–ø–∏—Å–∞–Ω–∏—è: **—Å–Ω–∞—á–∞–ª–∞ promoBalance, –ø–æ—Ç–æ–º regularBalance**
- ‚úÖ Endpoint **read-only** (–Ω–µ —Å–æ–∑–¥–∞—ë—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, —Ç–æ–ª—å–∫–æ —Ä–∞—Å—á—ë—Ç)

***

### 3.2. –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**‚úÖ –†–ï–®–ï–ù–ò–ï: POST /api/v1/loyalty/transactions**

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —á–µ–∫–∞ ‚Äî —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤.

**Request:**

```json
POST /api/v1/loyalty/transactions
Headers:
  Idempotency-Key: CHK-123456-IIKO-REST01
  
{
  "guestCardId": "card-uuid",
  "restaurantId": "rest-uuid",
  "transactionType": "EARN_AND_REDEEM",
  "checkAmount": 2000,
  "redeemedPoints": 100,
  "earnedPoints": 200,
  "posCheckId": "CHK-123456",
  "posSystem": "IIKO",
  "cashierId": "cashier-uuid",
  "timestamp": "2026-02-10T12:00:00Z",
  "items": [...],
  "metadata": {
    "orderType": "DINE_IN",
    "tableNumber": "12"
  }
}
```

**Response:**

```json
{
  "success": true,
  "transactions": [
    {
      "id": "txn-uuid-1",
      "type": "REDEEM",
      "amount": -100,
      "balanceType": "PROMO",
      "balanceBefore": 300,
      "balanceAfter": 200
    },
    {
      "id": "txn-uuid-2",
      "type": "EARN",
      "amount": 200,
      "balanceType": "REGULAR",
      "balanceBefore": 2500,
      "balanceAfter": 2700,
      "appliedRuleId": "rule-uuid"
    }
  ],
  "guestCard": {
    "totalBalance": 2900,
    "regularBalance": 2700,
    "promoBalance": 200,
    "level": "SILVER",
    "lifetimeSpent": 152000
  },
  "qrCode": "NEW-QR-CODE",
  "digitCode": "234567",
  "visit": {
    "id": "visit-uuid",
    "visitNumber": 47,
    "createdAt": "2026-02-10T12:00:00Z"
  }
}
```

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:**

- ‚úÖ **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** –ü–æ `posCheckId + posSystem + restaurantId` (UNIQUE constraint)
- ‚úÖ **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å:** –í—Å—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤ –æ–¥–Ω–æ–π DB-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (Prisma `$transaction`)
- ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ QR/Code:** –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–æ–≤—ã–µ
- ‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ GuestVisit:** –î–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** `BallTransaction` + `POSTransaction` + `ActivityLog`

***

### 3.3. –†—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ (Admin/Manager)

**‚úÖ –†–ï–®–ï–ù–ò–ï: POST /api/v1/loyalty/manual-adjustment**

**Request:**

```json
POST /api/v1/loyalty/manual-adjustment
{
  "guestCardId": "card-uuid",
  "type": "ADD",
  "amount": 500,
  "balanceType": "REGULAR",
  "reason": "–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ –∑–∞–¥–µ—Ä–∂–∫—É –∑–∞–∫–∞–∑–∞",
  "expiresAt": null,
  "notifyGuest": true
}
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**

- ‚úÖ –¢–æ–ª—å–∫–æ —Ä–æ–ª–∏: `ADMIN`, `MANAGER` (—Å permission `loyalty:manual:adjust`)
- ‚úÖ **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ `reason`** (–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ –õ–∏–º–∏—Ç: **10,000 –±–∞–ª–ª–æ–≤** –Ω–∞ –æ–¥–Ω—É –æ–ø–µ—Ä–∞—Ü–∏—é
- ‚úÖ UI-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —Å—É–º–º–µ **> 1,000 –±–∞–ª–ª–æ–≤**

**Audit Log:**

```typescript
ActivityLog {
  actionType: 'MANUAL_ADD_BALLS',
  performedBy: adminUserId,
  targetUser: guestUserId,
  oldValue: 2900,
  newValue: 3400,
  reason: "–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ –∑–∞–¥–µ—Ä–∂–∫—É –∑–∞–∫–∞–∑–∞",
  metadata: { amount: 500, balanceType: 'REGULAR' }
}
```


***

### 3.4. –ü–µ—Ä–µ–≤–æ–¥ –±–∞–ª–ª–æ–≤ –º–µ–∂–¥—É –≥–æ—Å—Ç—è–º–∏

**‚úÖ –†–ï–®–ï–ù–ò–ï: POST /api/v1/loyalty/transfer**

**Request:**

```json
POST /api/v1/loyalty/transfer
{
  "fromCardId": "card-sender-uuid",
  "toPhone": "+79991234567",
  "amount": 500,
  "verificationCode": "123456",
  "message": "–ù–∞ –∫–æ—Ñ–µ!"
}
```

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
2. –ü–æ–∏—Å–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É (–≤ —Ä–∞–º–∫–∞—Ö tenant)
3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SMS/Telegram –∫–æ–¥–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞ (TTL 5 –º–∏–Ω—É—Ç)
5. –ê—Ç–æ–º–∞—Ä–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:
    - –°–ø–∏—Å–∞–Ω–∏–µ —É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (`BallTransaction` type `TRANSFER_OUT`)
    - –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—é (`BallTransaction` type `TRANSFER_IN`)
    - –°–æ–∑–¥–∞–Ω–∏–µ `BallTransfer` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `COMPLETED`
6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–±–æ–∏–º –≥–æ—Å—Ç—è–º

**–õ–∏–º–∏—Ç—ã (–∏–∑ LoyaltySystem config):**

- `transferMinAmount: 1`
- `transferMaxPerOperation: 5000`
- `transferMaxPerDay: 10000`
- `transferCooldown: 300` (5 –º–∏–Ω—É—Ç –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏)

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**

- ‚úÖ Rate limiting: **3 –ø–æ–ø—ã—Ç–∫–∏/60 —Å–µ–∫**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ self-transfer (–∑–∞–ø—Ä–µ—â–µ–Ω–æ)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `ActivityLog`

***

## üìä **4. LOYALTY BUILDER API**

### 4.1. CRUD –¥–ª—è Loyalty Rules

**‚úÖ –†–ï–®–ï–ù–ò–ï: RESTful CRUD + Versioning**

**Endpoints:**

```bash
GET    /api/v1/loyalty/rules          # –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª
POST   /api/v1/loyalty/rules          # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
GET    /api/v1/loyalty/rules/:id      # –î–µ—Ç–∞–ª–∏ –ø—Ä–∞–≤–∏–ª–∞
PUT    /api/v1/loyalty/rules/:id      # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é)
DELETE /api/v1/loyalty/rules/:id      # –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (ARCHIVED)
```

**–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**

- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª–∞ ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è **–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è** (v2, v3, ...)
- –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –ø–æ–ª—É—á–∞–µ—Ç `effectiveUntil = NOW`
- –í `BallTransaction.ruleSnapshot` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è JSON-snapshot –≤–µ—Ä—Å–∏–∏
- **–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ù–ï –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è**

**–ü—Ä–∏–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**

```json
PUT /api/v1/loyalty/rules/rule-uuid
{
  "earnPercent": 12
}

Response:
{
  "rule": {
    "id": "rule-uuid",
    "version": 2,
    "earnPercent": 12,
    "effectiveFrom": "2026-02-11T00:00:00Z"
  },
  "previousVersion": {
    "version": 1,
    "earnPercent": 10,
    "effectiveUntil": "2026-02-10T23:59:59Z"
  }
}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–∞–≤–∏–ª:**

- –ü—Ä–∏ `conflictStrategy = COMBINE_ALL` ‚Üí –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è **–í–°–ï** –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞
- –ü—Ä–∏ `conflictStrategy = MAX_ONLY` ‚Üí –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª–æ —Å **–Ω–∞–∏–±–æ–ª—å—à–∏–º** –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º

***

### 4.2. CRUD –¥–ª—è Loyalty Levels

**‚úÖ –†–ï–®–ï–ù–ò–ï: RESTful CRUD + One Way Up Logic**

**Endpoints:**

```bash
GET    /api/v1/loyalty/levels
POST   /api/v1/loyalty/levels
PUT    /api/v1/loyalty/levels/:id
DELETE /api/v1/loyalty/levels/:id?moveToLevel=xxx
POST   /api/v1/loyalty/levels/recalculate  # –†—É—á–Ω–æ–π –ø–µ—Ä–µ—Å—á—ë—Ç
```

**One Way Up:**

- ‚úÖ –ì–æ—Å—Ç–∏ **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–Ω–∏–∂–∞—é—Ç—Å—è** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ Downgrade —Ç–æ–ª—å–∫–æ –ø—Ä–∏ **—è–≤–Ω–æ–º –¥–µ–π—Å—Ç–≤–∏–∏ Admin'–∞** (—É–¥–∞–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Å –≤—ã–±–æ—Ä–æ–º —Ü–µ–ª–µ–≤–æ–≥–æ)
- ‚úÖ –ü–µ—Ä–µ—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π: —Ç–æ–ª—å–∫–æ **–ø–æ–≤—ã—à–µ–Ω–∏–µ**

**–ü–µ—Ä–µ—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π:**

- **CRON –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00** (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- –õ–æ–≥–∏–∫–∞: `IF lifetimeSpent >= nextLevel.threshold => upgrade`

**–£–¥–∞–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è:**

```bash
DELETE /api/v1/loyalty/levels/level-2

Response (–µ—Å–ª–∏ –µ—Å—Ç—å –≥–æ—Å—Ç–∏):
{
  "error": "LEVEL_HAS_GUESTS",
  "guestsCount": 1523,
  "message": "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞",
  "availableLevels": [
    { "id": "level-1", "name": "Bronze" },
    { "id": "level-3", "name": "Gold" }
  ]
}

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º –Ω–∞ Gold:
DELETE /api/v1/loyalty/levels/level-2?moveToLevel=level-3
```


***

### 4.3. CRUD –¥–ª—è Promo Campaigns

**‚úÖ –†–ï–®–ï–ù–ò–ï: RESTful CRUD + Promo Builder**

**Endpoints:**

```bash
GET  /api/v1/loyalty/promos
POST /api/v1/loyalty/promos
GET  /api/v1/loyalty/promos/:id
PUT  /api/v1/loyalty/promos/:id
DELETE /api/v1/loyalty/promos/:id
GET  /api/v1/loyalty/promos/eligible?guestCardId=xxx  # –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –≥–æ—Å—Ç—è
```

**–¢–∏–ø—ã –ø—Ä–æ–º–æ:**

- `BIRTHDAY` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –¥–µ–Ω—å –î–† –≥–æ—Å—Ç—è
- `CHILD_BIRTHDAY` ‚Äî –¥–ª—è –¥–µ—Ç–µ–π –≥–æ—Å—Ç—è
- `FIRST_VISIT` ‚Äî –ø–µ—Ä–≤—ã–π —á–µ–∫
- `INACTIVITY` ‚Äî –µ—Å–ª–∏ –Ω–µ –±—ã–ª N –¥–Ω–µ–π
- `CUSTOM` ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–µ —É—Å–ª–æ–≤–∏—è

**–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–æ–º–æ:**

```typescript
LoyaltySystem {
  promoConflictStrategy: 'COMBINE_ALL',  // –∏–ª–∏ MAX_ONLY, FIRST_ONLY
  promoOverrides: [
    {
      promo1: 'birthday-promo',
      promo2: 'first-visit-promo',
      strategy: 'MAX_ONLY'  // –î–ª—è —ç—Ç–æ–π –ø–∞—Ä—ã ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ
    }
  ]
}
```

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**

- –ö–∞–∂–¥–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ ‚Üí –∑–∞–ø–∏—Å—å –≤ `PromoBallGranted`
- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è: `promoId`, `amountInitial`, `amountRemaining`, `expiresAt`

***

## ‚è∞ **5. BACKGROUND JOBS \& CRON**

### 5.1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**‚úÖ –†–ï–®–ï–ù–ò–ï: BullMQ + –û—Ç–¥–µ–ª—å–Ω—ã–π Worker –ø—Ä–æ—Ü–µ—Å—Å**

**–û—á–µ—Ä–µ–¥–∏:**

- `LOYALTY_RECALC` ‚Äî –ø–µ—Ä–µ—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π
- `BALL_EXPIRATION` ‚Äî —Å–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤
- `POS_RECONCILIATION` ‚Äî —Å–≤–µ—Ä–∫–∞ —Å POS
- `NOTIFICATIONS` ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `ANALYTICS` ‚Äî –ø—Ä–µ–¥—Ä–∞—Å—á—ë—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

**CRON Schedule:**


| Job | –ß–∞—Å—Ç–æ—Ç–∞ | –í—Ä–µ–º—è | –û–ø–∏—Å–∞–Ω–∏–µ |
| :-- | :-- | :-- | :-- |
| –ü–µ—Ä–µ—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π | –ï–∂–µ–¥–Ω–µ–≤–Ω–æ | 03:00 | –ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –≥–æ—Å—Ç–µ–π |
| –°–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ | –ï–∂–µ–¥–Ω–µ–≤–Ω–æ | 10:00 | Expiration –ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ + –ø—Ä–æ–º–æ |
| POS Reconciliation | –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω | */30 * * * * | PULL + —Å–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–æ–≤ |
| –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | –ï–∂–µ–¥–Ω–µ–≤–Ω–æ | 02:00 | Daily/Monthly snapshots |
| –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–≥–æ—Ä–∞–Ω–∏–∏ | –ï–∂–µ–¥–Ω–µ–≤–Ω–æ | 10:00 | –ó–∞ 3/7/14 –¥–Ω–µ–π –¥–æ expiration |


***

### 5.2. Job: –°–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤

**‚úÖ –†–ï–®–ï–ù–ò–ï: –ì–∏–±—Ä–∏–¥ (Inactivity + Promo Expiration)**

**–õ–æ–≥–∏–∫–∞:**

**1Ô∏è‚É£ –°–≥–æ—Ä–∞–Ω–∏–µ –ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:**

- –ü–∞—Ä–∞–º–µ—Ç—Ä: `LoyaltySystem.inactivityExpireDays` (–º–∏–Ω–∏–º—É–º 90 –¥–Ω–µ–π)
- –£—Å–ª–æ–≤–∏–µ: `lastActivityAt < NOW - inactivityExpireDays`
- **–í—Å–µ –±–∞–ª–ª—ã –∫–∞—Ä—Ç—ã —Å–≥–æ—Ä–∞—é—Ç —Ä–∞–∑–æ–º** (regularBalance + promoBalance ‚Üí 0)
- –°–æ–∑–¥–∞—ë—Ç—Å—è `BallTransaction` type `EXPIRE` —Å `amount = -totalBalance`

**2Ô∏è‚É£ –°–≥–æ—Ä–∞–Ω–∏–µ –ø—Ä–æ–º–æ-–±–∞–ª–ª–æ–≤ –ø–æ expiresAt:**

- –£—Å–ª–æ–≤–∏–µ: `PromoBallGranted.expiresAt < NOW AND amountRemaining > 0`
- –°–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ—Å—Ç–∞—Ç–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ–º–æ
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `promoBalance` –∫–∞—Ä—Ç—ã

**–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**

```typescript
LoyaltySystem {
  expirationNotifications: {
    enabled: true,
    channels: ['TELEGRAM', 'EMAIL'],
    daysBeforeExpiration: [3, 7, 14],
    notifyForRegular: true,
    notifyForPromo: true
  }
}
```


***

### 5.3. Job: POS Reconciliation

**‚úÖ –†–ï–®–ï–ù–ò–ï: –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç + –ù–æ—á–Ω–æ–π –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç**

**–ó–∞–¥–∞—á–∏:**

**1Ô∏è‚É£ PULL –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —á–µ–∫–æ–≤ –∏–∑ POS:**

- –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö webhooks
- –ó–∞ –ø–µ—Ä–∏–æ–¥: `lastSuccessfulPullAt` –¥–æ `NOW`
- –ï—Å–ª–∏ —á–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ `POSTransaction` ‚Üí —Å–æ–∑–¥–∞—ë–º —á–µ—Ä–µ–∑ `loyaltyService.processTransaction`
- –õ–æ–≥–∏—Ä—É–µ–º: `POS_RECONCILIATION_MISSING_WEBHOOK`

**2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –ø–æ –±–∞–ª–∞–Ω—Å–∞–º:**

- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Å—Ç—è: —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º `ourBalance` vs `posBalance`
- –ï—Å–ª–∏ `diff > 10` ‚Üí —Å–æ–∑–¥–∞—ë–º `BallReconciliation` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `PENDING_REVIEW`
- –ê–ª–µ—Ä—Ç Admin'—É: `POS_BALANCE_MISMATCH`

**3Ô∏è‚É£ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞:**

- `POSIntegration.lastSuccessfulPullAt = NOW`
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: `POS Sync Status = SUCCESS/FAILED/DEGRADED`

***

## üìä **6. ANALYTICS \& REPORTING API**

### 6.1. Analytics –¥–ª—è Owner

**‚úÖ –†–ï–®–ï–ù–ò–ï: GET /api/v1/analytics/platform**

**–ú–µ—Ç—Ä–∏–∫–∏:**

- Tenant'—ã: total, active, past_due, cancelled, new_this_month
- Revenue: MRR, ARR, total_revenue, ARPU
- Subscriptions: –ø–æ –ø–ª–∞–Ω–∞–º (Standard/Medium/Pro/Ultimate/Custom), –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º (monthly/yearly)
- Churn: rate, cancelled_this_month, reasons
- Payments: transactions, successful, failed, refunded, chargeback
- Guests: total, active_last_month, new_this_month
- Loyalty: balls_issued, balls_redeemed, balls_expired, redemption_rate

**–ò—Å—Ç–æ—á–Ω–∏–∫:** `AnalyticsMonthlySnapshot` + real-time –¥–∞–Ω–Ω—ã–µ

**–ö—ç—à:** Redis (TTL 5 –º–∏–Ω—É—Ç)

***

### 6.2. Analytics –¥–ª—è Restaurant Admin

**‚úÖ –†–ï–®–ï–ù–ò–ï: GET /api/v1/analytics/restaurant**

**–ú–µ—Ç—Ä–∏–∫–∏:**

- Overview: revenue, checks, avg_check, guests, retention_rate
- Loyalty: balls_issued, redeemed, expired, redemption_rate, ROI
- Levels: distribution (Bronze/Silver/Gold), avg_check per level
- Promos: activations, bonus_issued, conversion_rate, top_promos, ROI
- Segments: VIP, Regular, At-Risk, Lost
- Trends: revenue_by_day (30 –¥–Ω–µ–π), guests_by_week
- POS: integration status, last_sync, missed_webhooks, reconciliation_issues

**Drill-down:**

```bash
GET /api/v1/analytics/restaurant/promos/:promoId
GET /api/v1/analytics/restaurant/segments/:segment
```


***

### 6.3. Analytics –¥–ª—è Manager

**‚úÖ –†–ï–®–ï–ù–ò–ï: GET /api/v1/analytics/my-restaurant**

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- –¢–∞ –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —á—Ç–æ —É Admin
- ‚ùå –ù–ï –≤–∏–¥–∏—Ç: Billing, POS integration settings (—Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å), Cross-restaurant comparison

***

### 6.4. Analytics –¥–ª—è Guest

**‚úÖ –†–ï–®–ï–ù–ò–ï: GET /api/v1/analytics/guest/me**

**–ú–µ—Ç—Ä–∏–∫–∏:**

- Overview: visits, spent, avg_check, saved_via_points, earned_points, current_balance
- Progress: current_level, next_level, amount_needed, percent
- Patterns: favorite_day, favorite_time, most_visited_restaurant
- Top dishes
- Recent visits (last 10)
- Promos used
- Achievements (gamification, Phase 2)

***

### 6.5. –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–æ–≤

**‚úÖ –†–ï–®–ï–ù–ò–ï: POST /api/v1/analytics/export**

**–§–æ—Ä–º–∞—Ç—ã:** XLSX, CSV, PDF

**Request:**

```json
POST /api/v1/analytics/export
{
  "reportType": "RESTAURANT_PERFORMANCE",
  "format": "XLSX",
  "period": { "from": "2026-01-01", "to": "2026-01-31" },
  "filters": { "restaurantId": "rest-1", "level": "SILVER" },
  "columns": ["guestName", "phone", "level", "balance", "lifetimeSpent"]
}
```

**Process:**

1. –ó–∞–ø—Ä–æ—Å —É—Ö–æ–¥–∏—Ç –≤ –æ—á–µ—Ä–µ–¥—å `ANALYTICS`
2. Worker –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–∞–π–ª
3. –ó–∞–≥—Ä—É–∑–∫–∞ –≤ S3/CDN
4. Email —Å —Å—Å—ã–ª–∫–æ–π (TTL 24 —á–∞—Å–∞)

***

## üìß **7. NOTIFICATIONS API**

### 7.1. Centralized Service

**‚úÖ –†–ï–®–ï–ù–ò–ï: POST /api/v1/notifications/send (internal)**

**–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**

- **Loyalty:** balls_earned, balls_redeemed, balls_expired, balls_expiring_soon, level_upgraded
- **Promos:** promo_activated, promo_available, birthday_promo
- **Billing:** subscription_expiring, payment_failed, payment_success
- **System:** welcome, password_reset, verification_code

**–ö–∞–Ω–∞–ª—ã:**

- `TELEGRAM`
- `EMAIL`
- `SMS`
- `PUSH` (Phase 2)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**

- `LOW` ‚Äî –º–∞—Ä–∫–µ—Ç–∏–Ω–≥
- `NORMAL` ‚Äî –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ
- `HIGH` ‚Äî –∫—Ä–∏—Ç–∏—á–Ω—ã–µ (payment_failed, subscription_expiring)

***

### 7.2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≥–æ—Å—Ç—è

**‚úÖ –†–ï–®–ï–ù–ò–ï: GET/PUT /api/v1/guests/me/notification-settings**

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```json
{
  "balls": {
    "earned": { "telegram": true, "email": false, "sms": false },
    "redeemed": { "telegram": true, "email": false, "sms": false },
    "expired": { "telegram": true, "email": true, "sms": false },
    "expiringSoon": { "telegram": true, "email": true, "sms": false }
  },
  "promos": {
    "available": { "telegram": true, "email": false, "sms": false },
    "birthday": { "telegram": true, "email": true, "sms": true }
  },
  "level": {
    "upgraded": { "telegram": true, "email": true, "sms": false }
  },
  "marketing": {
    "enabled": false,
    "telegram": false,
    "email": false,
    "sms": false
  },
  "globalMute": false
}
```


***

### 7.3. Notification History

**‚úÖ –†–ï–®–ï–ù–ò–ï: GET /api/v1/guests/me/notifications**

**–§—É–Ω–∫—Ü–∏–∏:**

- –°–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)
- –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É: `UNREAD`, `READ`
- –ü–æ–º–µ—Ç–∫–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ: `PUT /api/v1/guests/me/notifications/:id/read`
- –°—á—ë—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö

***

## üõ°Ô∏è **8. ERROR HANDLING \& VALIDATION**

### 8.1. –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**‚úÖ –†–ï–®–ï–ù–ò–ï: Global Exception Filter + Custom Error Codes**

**Error Response Format:**

```json
{
  "success": false,
  "error": {
    "code": "INSUFFICIENT_BALANCE",
    "message": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è",
    "details": {
      "requested": 500,
      "available": 285
    },
    "timestamp": "2026-02-10T18:00:00Z",
    "path": "/api/v1/loyalty/transactions",
    "requestId": "req-abc123"
  }
}
```

**Error Codes (–æ—Å–Ω–æ–≤–Ω—ã–µ):**

- Auth: `UNAUTHORIZED`, `INVALID_TOKEN`, `TOKEN_EXPIRED`, `FORBIDDEN`
- Loyalty: `INSUFFICIENT_BALANCE`, `GUEST_CARD_NOT_FOUND`, `PROMO_EXPIRED`, `REDEEM_LIMIT_EXCEEDED`
- Billing: `SUBSCRIPTION_NOT_FOUND`, `PAYMENT_FAILED`, `LIMIT_EXCEEDED`
- POS: `POS_WEBHOOK_INVALID_SIGNATURE`, `POS_CHECK_ALREADY_PROCESSED`
- System: `VALIDATION_ERROR`, `RATE_LIMIT_EXCEEDED`, `INTERNAL_SERVER_ERROR`

***

### 8.2. Input Validation

**‚úÖ –†–ï–®–ï–ù–ò–ï: class-validator + Custom Validation Pipe**

**–ü—Ä–∏–º–µ—Ä DTO:**

```typescript
export class CreateLoyaltyRuleDto {
  @IsString()
  @MinLength(3, { message: '–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞' })
  @MaxLength(100)
  name: string;

  @IsNumber()
  @Min(1, { message: '–ü—Ä–æ—Ü–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 1%' })
  @Max(100, { message: '–ü—Ä–æ—Ü–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 100%' })
  earnPercent: number;
}
```

**Validation Error Response:**

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Validation failed",
    "details": [
      {
        "field": "earnPercent",
        "value": 150,
        "constraints": ["–ü—Ä–æ—Ü–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 100%"]
      }
    ]
  }
}
```


***

### 8.3. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

**‚úÖ –†–ï–®–ï–ù–ò–ï: Idempotency Key –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö + DB Constraints**

**Middleware:**

- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π header `Idempotency-Key` –¥–ª—è POST/PUT/DELETE
- –ö—ç—à —É—Å–ø–µ—à–Ω—ã—Ö responses –≤ Redis (TTL 24 —á–∞—Å–∞)
- –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ response

**DB Constraints:**

```typescript
// POSTransaction
@@unique([tenantId, posSystem, posCheckId])

// BallTransaction
@@unique([posTransactionId, loyaltyRuleId])

// BallTransfer
@@unique([fromCardId, verificationCode])
```


***

## üß™ **9. TESTING STRATEGY**

### 9.1. Unit Tests

**‚úÖ –†–ï–®–ï–ù–ò–ï: Jest + Coverage 80%+**

**Targets:**

- **Core Loyalty Logic:** 90%+
- **Services:** 80%+
- **Controllers:** 70%+
- **Utils/Helpers:** 85%+

**–ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤:**

- –†–∞—Å—á—ë—Ç –±–∞–ª–ª–æ–≤ (–±–∞–∑–æ–≤—ã–π –∫–µ—à–±—ç–∫, –±–æ–Ω—É—Å —É—Ä–æ–≤–Ω—è, –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª, MAX_ONLY)
- –õ–∏–º–∏—Ç—ã —Å–ø–∏—Å–∞–Ω–∏—è (20% –æ—Ç —á–µ–∫–∞, –±–∞–ª–∞–Ω—Å –º–µ–Ω—å—à–µ –ª–∏–º–∏—Ç–∞, —á–µ–∫ < 50‚ÇΩ)
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ (–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ, expiration)

***

### 9.2. Integration Tests

**‚úÖ –†–ï–®–ï–ù–ò–ï: Supertest + Test Database**

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**

- –ü–æ–ª–Ω—ã–π flow: –æ—Ç HTTP request –¥–æ DB –∏ –æ–±—Ä–∞—Ç–Ω–æ
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (RBAC)
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- Tenant isolation

**Test Database:**

- –û—Ç–¥–µ–ª—å–Ω–∞—è PostgreSQL –ë–î –¥–ª—è —Ç–µ—Å—Ç–æ–≤
- –ú–∏–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `prisma migrate deploy`
- Cleanup –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞

***

### 9.3. Load Testing

**‚úÖ –†–ï–®–ï–ù–ò–ï: k6**

**Targets:**

- **Throughput:** 500+ requests/sec
- **Latency:** p95 < 500ms, p99 < 1s
- **Error Rate:** < 1%
- **Resources:** CPU < 70%, Memory stable (no leaks)

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**

- `/api/v1/loyalty/calculate` ‚Äî —Ä–∞—Å—á—ë—Ç –±–∞–ª–ª–æ–≤ (–∫—Ä–∏—Ç–∏—á–Ω—ã–π –¥–ª—è POS)
- `/api/v1/loyalty/transactions` ‚Äî —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- `/api/v1/guests/me` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Å—Ç—è

***

## üîß **10. DATABASE OPTIMIZATION \& CACHING**

### 10.1. Database Indexes

**‚úÖ –†–ï–®–ï–ù–ò–ï: Composite Indexes + Partial Indexes**

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã:**

- `GuestCard`: `[tenantId, restaurantId, status]`, `[qrCode]`, `[digitCode, tenantId]`, `[lastActivityAt, status]`
- `BallTransaction`: `[guestCardId, createdAt DESC]`, `[tenantId, restaurantId, createdAt]`, `[posTransactionId]`
- `POSTransaction`: `[tenantId, posSystem, posCheckId]` (UNIQUE), `[tenantId, restaurantId, createdAt]`
- `LoyaltyRule`: `[tenantId, status]`
- `PromoBallGranted`: `[guestCardId, amountRemaining]`, `[expiresAt]`

**Partial Indexes (PostgreSQL):**

```sql
CREATE INDEX idx_active_guest_cards 
ON "GuestCard" (tenant_id, status) 
WHERE status = 'ACTIVE';

CREATE INDEX idx_cards_with_balance 
ON "GuestCard" (last_activity_at) 
WHERE total_balance > 0 AND status = 'ACTIVE';
```


***

### 10.2. Redis Caching

**‚úÖ –†–ï–®–ï–ù–ò–ï: Multi-Level Caching (Redis + In-Memory)**

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:**

1. Check in-memory cache (Node cache) ‚Äî fastest
2. Check Redis
3. Fetch from DB
4. Warm up both caches

**Cache Keys:**

```typescript
guest:card:{cardId}
guest:card:qr:{qrCode}
loyalty:rules:active:{tenantId}
promos:eligible:{guestCardId}
analytics:daily:{tenantId}:{restaurantId}:{date}
```

**TTL Guidelines:**

- **Hot data** (–±–∞–ª–∞–Ω—Å, –∫–∞—Ä—Ç—ã): 5 –º–∏–Ω—É—Ç
- **Warm data** (–ø—Ä–∞–≤–∏–ª–∞, –ø—Ä–æ–º–æ): 10 –º–∏–Ω—É—Ç
- **Cold data** (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞): 1 —á–∞—Å
- **Session data**: 24 —á–∞—Å–∞

***

### 10.3. Connection Pooling

**‚úÖ –†–ï–®–ï–ù–ò–ï: PgBouncer + Prisma Connection Pool**

**Prisma Config:**

```typescript
connectionLimit: 100
connectionTimeout: 5000
poolTimeout: 10000
```

**PgBouncer:**

```ini
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
reserve_pool_size = 10
```


***

### 10.4. Database Transactions

**‚úÖ –†–ï–®–ï–ù–ò–ï: Prisma Interactive Transactions + Retry Logic**

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∞—Ç–æ–º–∞—Ä–Ω—ã–µ):**

- –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤
- –ü–µ—Ä–µ–≤–æ–¥—ã –º–µ–∂–¥—É –≥–æ—Å—Ç—è–º–∏
- –ú–∏–≥—Ä–∞—Ü–∏–∏ UNIFIED ‚Üî SEPARATE
- POS reconciliation

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**

```typescript
prisma.$transaction(
  async (tx) => { ... },
  {
    maxWait: 5000,
    timeout: 10000,
    isolationLevel: 'Serializable'
  }
)
```

**Retry –Ω–∞ Deadlock:**

- Max retries: 3
- Exponential backoff: 100ms, 200ms, 400ms

***

# ‚úÖ **–ò–¢–û–ì–û–í–´–ô CHECKLIST**

## Backend API \& Services ‚Äî –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–ø–µ—Ü–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ:

‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** Modular Monolith (NestJS, Prisma, PostgreSQL, Redis, BullMQ)
‚úÖ **API Protocol:** REST API v1 + URL Versioning
‚úÖ **Auth:** JWT + RBAC Guards + Impersonation + Rate Limiting
‚úÖ **Loyalty Engine API:**

- `/api/v1/loyalty/calculate` ‚Äî Pre-calculation
- `/api/v1/loyalty/transactions` ‚Äî –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
- `/api/v1/loyalty/manual-adjustment` ‚Äî –†—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
- `/api/v1/loyalty/transfer` ‚Äî –ü–µ—Ä–µ–≤–æ–¥—ã
‚úÖ **Loyalty Builder API:**
- CRUD Rules (—Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
- CRUD Levels (One Way Up)
- CRUD Promos (Builder + Conflict Resolution)
‚úÖ **Background Jobs:**
- Ball Expiration (Inactivity + Promo)
- POS Reconciliation (PULL + Balance Check)
- Level Recalculation
- Analytics Pre-calculation
‚úÖ **Analytics API:**
- Owner (Platform Metrics)
- Admin (Restaurant Performance)
- Manager (Single Restaurant)
- Guest (Personal Stats)
- Export (XLSX/CSV/PDF)
‚úÖ **Notifications API:**
- Centralized Service
- Guest Settings
- History
‚úÖ **Error Handling:**
- Global Exception Filter
- Custom Error Codes
- Input Validation
- Idempotency
‚úÖ **Testing:**
- Unit (Jest, 80%+ coverage)
- Integration (Supertest)
- Load (k6, 500+ RPS)
‚úÖ **Database Optimization:**
- Indexes (Composite + Partial)
- Redis Caching (Multi-Level)
- Connection Pooling (PgBouncer)
- Transactions (Prisma + Retry)

***

# üöÄ **–ì–û–¢–û–í–û –ö –°–õ–ï–î–£–Æ–©–ï–ú–£ –ë–õ–û–ö–£!**

**Backend API \& Services** –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –Ω–∞ **34 –≤–æ–ø—Ä–æ—Å–∞**. –í—Å–µ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏–Ω—è—Ç—ã –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã.

***

## üìã **–í–∞—Ä–∏–∞–Ω—Ç—ã —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–ª–æ–∫–∞ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏:**

### **1Ô∏è‚É£ Frontend Admin Panel (Owner/Admin/Manager UI)** ‚≠ê *–†–µ–∫–æ–º–µ–Ω–¥—É—é*

**–ß—Ç–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º:**

- UI/UX –¥–∏–∑–∞–π–Ω –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (React/Vue)
- –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (visual builder)
- –î–∞—à–±–æ—Ä–¥—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (charts, tables)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Å—Ç—è–º–∏, –ø—Ä–æ–º–æ, POS-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏
- Responsive design + Mobile-first
- State management (Redux/Zustand)
- API integration layer


### **2Ô∏è‚É£ Infrastructure \& DevOps**

**–ß—Ç–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º:**

- CI/CD –ø–∞–π–ø–ª–∞–π–Ω—ã (GitHub Actions/GitLab CI)
- Docker containerization
- Kubernetes orchestration
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Prometheus, Grafana, Sentry)
- Logging (ELK Stack)
- Backup \& Recovery
- Security (secrets, certificates, WAF)
- Scaling strategy


### **3Ô∏è‚É£ Database Schema \& Migrations (–¥–µ—Ç–∞–ª—å–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è)**

**–ß—Ç–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º:**

- –ü–æ–ª–Ω–∞—è Prisma schema —Å –≤—Å–µ–º–∏ –º–æ–¥–µ–ª—è–º–∏
- Relationships –∏ constraints
- Indexes strategy (–¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω)
- Migration strategy (zero-downtime)
- Data seeding
- Backup \& Restore procedures


### **4Ô∏è‚É£ Security \& Compliance**

**–ß—Ç–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º:**

- OWASP Top 10 protection
- GDPR compliance (–ø–æ–ª–Ω—ã–π flow)
- PCI DSS (–¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π)
- Penetration testing strategy
- Vulnerability scanning
- Incident response plan

***

**–ö–∞–∫–æ–π –±–ª–æ–∫ –±–µ—Ä—ë–º —Å–ª–µ–¥—É—é—â–∏–º?** üéØ

–ù–∞–ø–∏—à–∏ –Ω–æ–º–µ—Ä (1, 2, 3 –∏–ª–∏ 4), –ª–∏–±–æ –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç!

---

# Frontend Admin Panel (Owner/Admin/Manager UI) —Å–ª–µ–¥—É—é—â–∏–π. –ó–∞–¥–∞–π 30+ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ + —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ —Ç–≤–æ–µ–º—É –ª—É—á—à–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ –¥–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –ø–æ—á–µ–º—É. –ü–µ—Ä–µ–¥ –∑–∞–¥–∞–≤–∞–Ω–∏–µ–º –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–≤–µ—Ä—å—Å—è —Å —Ñ–∞–π–ª–∞–º–∏, –º–æ–∂–µ—Ç –æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ –∏–ª–∏ —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç.

–û—Ç–ª–∏—á–Ω–æ! –Ø –∏–∑—É—á–∏–ª —Ñ–∞–π–ª—ã. –í–∏–∂—É, —á—Ç–æ –¥–µ—Ç–∞–ª—å–Ω–æ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω—ã:

- Telegram Bot \& Mini App (–ø–æ–ª–Ω–æ—Å—Ç—å—é)
- Backend API \& Services (—Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏)
- Balls Transactions (–ø–æ–ª–Ω–æ—Å—Ç—å—é)
- Billing \& Subscriptions (–ø–æ–ª–Ω–æ—Å—Ç—å—é)
- POS Integration (–ø–æ–ª–Ω–æ—Å—Ç—å—é)

**–ù–û Frontend Admin Panel (Owner/Admin/Manager UI) –ø–æ–∫–∞ –ù–ï –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!**

–ü—Ä–∏—Å—Ç—É–ø–∞—é –∫ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—é 30+ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ **Frontend Admin Panel**.

***

# üé® Frontend Admin Panel (Owner/Admin/Manager UI)

## 30+ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏


***

### **üìö –ë–õ–û–ö 1: TECHNOLOGY STACK \& ARCHITECTURE**

#### **1. Framework –≤—ã–±–æ—Ä: React vs Vue vs Next.js?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Next.js 14+ (App Router)**

**–ü–æ—á–µ–º—É:**

- ‚úÖ **SSR/SSG** ‚Äî –±—ã—Å—Ç—Ä–∞—è –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, SEO –¥–ª—è landing pages
- ‚úÖ **Server Components** ‚Äî –º–µ–Ω—å—à–µ JS –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ, –±—ã—Å—Ç—Ä–µ–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- ‚úÖ **API Routes** ‚Äî BFF (Backend for Frontend) –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **TypeScript** ‚Äî type safety –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- ‚úÖ **React 18+** ‚Äî concurrent rendering, Suspense, transitions
- ‚úÖ **Vercel Ecosystem** ‚Äî –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–µ–ø–ª–æ–π, CDN, Edge Functions
- ‚úÖ **–ë–æ–ª—å—à–æ–µ –∫–æ–º—å—é–Ω–∏—Ç–∏** ‚Äî –º–Ω–æ–≥–æ –≥–æ—Ç–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è dashboards

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**

- **React (CRA/Vite)** ‚Äî –ø—Ä–æ—â–µ, –Ω–æ –±–µ–∑ SSR (—Ö—É–∂–µ –¥–ª—è SEO, –º–µ–¥–ª–µ–Ω–Ω–µ–µ FCP)
- **Vue 3 + Nuxt 3** ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –Ω–æ –º–µ–Ω—å—à–µ enterprise-—Ä–µ—à–µ–Ω–∏–π –¥–ª—è admin panels
- **Remix** ‚Äî —Ö–æ—Ä–æ—à, –Ω–æ –º–µ–Ω—å—à–µ adoption –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **2. UI Component Library: –∫–∞–∫–æ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: shadcn/ui + Radix UI + Tailwind CSS**

**–ü–æ—á–µ–º—É:**

- ‚úÖ **shadcn/ui** ‚Äî –Ω–µ library, –∞ –Ω–∞–±–æ—Ä –ö–û–ü–ò–†–£–ï–ú–´–• –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å)
- ‚úÖ **Radix UI primitives** ‚Äî –¥–æ—Å—Ç—É–ø–Ω—ã–µ, headless –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (keyboard nav, ARIA)
- ‚úÖ **Tailwind CSS** ‚Äî utility-first, –±—ã—Å—Ç—Ä–∞—è –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è, –Ω–µ —Ä–∞–∑–¥—É–≤–∞–µ—Ç bundle
- ‚úÖ **Recharts** ‚Äî –≥—Ä–∞—Ñ–∏–∫–∏ –∏ charts (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
- ‚úÖ **Tanstack Table** ‚Äî –º–æ—â–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π/—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π/–ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- ‚úÖ **date-fns + React Day Picker** ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–∞–º–∏
- ‚úÖ **Lucide Icons** ‚Äî 1000+ –∏–∫–æ–Ω–æ–∫, tree-shakeable

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**

- **Material UI (MUI)** ‚Äî –≥–æ—Ç–æ–≤—ã–π –¥–∏–∑–∞–π–Ω, –Ω–æ —Ç—è–∂—ë–ª—ã–π (300kb+), —Å–ª–æ–∂–Ω–æ –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å
- **Ant Design** ‚Äî –æ—Ç–ª–∏—á–µ–Ω –¥–ª—è –∫–∏—Ç–∞–π—Å–∫–∏—Ö –∞–¥–º–∏–Ω–æ–∫, –Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –¥–∏–∑–∞–π–Ω
- **Chakra UI** ‚Äî —Ö–æ—Ä–æ—à, –Ω–æ –º–µ–Ω–µ–µ –ø–æ–ø—É–ª—è—Ä–µ–Ω –¥–ª—è enterprise
- **Headless UI (Tailwind)** ‚Äî —Ö–æ—Ä–æ—à, –Ω–æ –º–µ–Ω—å—à–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —á–µ–º Radix

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **3. State Management: Redux vs Zustand vs React Query?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Zustand + TanStack Query (React Query)**

**–ü–æ—á–µ–º—É:**

- ‚úÖ **TanStack Query** ‚Äî –¥–ª—è server state (API calls, caching, refetch, optimistic updates)
- ‚úÖ **Zustand** ‚Äî –¥–ª—è client state (UI state, –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞, sidebar –æ—Ç–∫—Ä—ã—Ç/–∑–∞–∫—Ä—ã—Ç)
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π boilerplate (vs Redux)
- ‚úÖ **Performance** ‚Äî re-renders —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- ‚úÖ **TypeScript** ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è

**–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:**

```typescript
// Server state (TanStack Query)
const { data: guests } = useQuery(['guests', filters], fetchGuests);

// Client state (Zustand)
const { isSidebarOpen, toggleSidebar } = useUIStore();
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**

- **Redux Toolkit** ‚Äî overkill –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤, –º–Ω–æ–≥–æ boilerplate
- **Jotai/Recoil** ‚Äî –∞—Ç–æ–º–∞—Ä–Ω—ã–µ, –Ω–æ –º–µ–Ω–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã
- **Context API** ‚Äî –ø—Ä–æ—Å—Ç–æ–π, –Ω–æ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –ø—Ä–∏ –±–æ–ª—å—à–æ–º state

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **4. Forms: React Hook Form vs Formik?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: React Hook Form + Zod**

**–ü–æ—á–µ–º—É:**

- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî uncontrolled forms, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ re-renders
- ‚úÖ **Zod** ‚Äî schema validation + TypeScript —Ç–∏–ø—ã –∏–∑ —Å—Ö–µ–º—ã
- ‚úÖ **–ú–∞–ª—ã–π bundle** ‚Äî 8kb vs Formik 15kb
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å shadcn/ui** ‚Äî –≥–æ—Ç–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã

**–ü—Ä–∏–º–µ—Ä:**

```typescript
const formSchema = z.object({
  name: z.string().min(3).max(100),
  earnPercent: z.number().min(1).max(100),
});

const form = useForm<z.infer<typeof formSchema>>({
  resolver: zodResolver(formSchema),
});
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**

- **Formik** ‚Äî –±–æ–ª–µ–µ verbose, —Ö—É–∂–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **Final Form** ‚Äî —Ö–æ—Ä–æ—à, –Ω–æ –º–µ–Ω–µ–µ –ø–æ–ø—É–ª—è—Ä–µ–Ω

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **5. Tables: –∫–∞–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Ç–∞–±–ª–∏—Ü –≥–æ—Å—Ç–µ–π/—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π/–ø—Ä–∞–≤–∏–ª?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: TanStack Table v8 + –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è**

**–ü–æ—á–µ–º—É:**

- ‚úÖ **Headless** ‚Äî –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ UI
- ‚úÖ **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, –ø–∞–≥–∏–Ω–∞—Ü–∏—è** ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ
- ‚úÖ **Column resizing, pinning** ‚Äî –¥–ª—è —à–∏—Ä–æ–∫–∏—Ö —Ç–∞–±–ª–∏—Ü
- ‚úÖ **–í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è** ‚Äî –¥–ª—è 10,000+ —Å—Ç—Ä–æ–∫ (—á–µ—Ä–µ–∑ @tanstack/react-virtual)
- ‚úÖ **TypeScript** ‚Äî —Å—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- ‚úÖ **SSR-friendly** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Next.js

**–§—É–Ω–∫—Ü–∏–∏:**

- –ú—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç —Å—Ç—Ä–æ–∫ (–¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
- –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV/XLSX
- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ + —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ URL (–¥–ª—è —à–∞—Ä–∏–Ω–≥–∞)

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**

- **AG Grid** ‚Äî enterprise-—Ä–µ—à–µ–Ω–∏–µ, –Ω–æ –ø–ª–∞—Ç–Ω–æ–µ –¥–ª—è advanced features
- **MUI DataGrid** ‚Äî —Ö–æ—Ä–æ—à, –Ω–æ —Ç—è–∂—ë–ª—ã–π –∏ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ MUI

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **6. Charts \& Analytics: Recharts vs Chart.js vs D3?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Recharts + Victory –¥–ª—è edge cases**

**–ü–æ—á–µ–º—É:**

- ‚úÖ **Recharts** ‚Äî React-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–π API, responsive
- ‚úÖ **–¢–∏–ø—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤:** Line, Bar, Area, Pie, Radar, Treemap, Scatter
- ‚úÖ **–õ–µ–≥–∫–æ –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å** ‚Äî —á–µ—Ä–µ–∑ props (vs D3 –∏–º–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π)
- ‚úÖ **Tooltip, Legend, Brush** ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ
- ‚úÖ **Victory** ‚Äî –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

- **Owner Dashboard:** MRR/ARR line chart, Churn pie chart, Revenue by plan bar chart
- **Restaurant Analytics:** Revenue trend (30 days), Guests by level (pie), Top promos (bar)

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**

- **Chart.js** ‚Äî —Ö–æ—Ä–æ—à, –Ω–æ –Ω–µ React-way (–Ω—É–∂–µ–Ω wrapper)
- **D3.js** ‚Äî powerful, –Ω–æ –∏–º–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –∏ steep learning curve
- **Nivo** ‚Äî –∫—Ä–∞—Å–∏–≤—ã–π, –Ω–æ –º–µ–Ω–µ–µ flexible —á–µ–º Recharts

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **7. Date Range Picker: –∫–∞–∫–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: React Day Picker v8 + date-fns**

**–ü–æ—á–µ–º—É:**

- ‚úÖ **Lightweight** ‚Äî 15kb
- ‚úÖ **Accessible** ‚Äî keyboard navigation, ARIA
- ‚úÖ **–ü—Ä–µ—Å–µ—Ç—ã** ‚Äî "Today", "Last 7 days", "This month", "Custom"
- ‚úÖ **Timezone support** ‚Äî —á–µ—Ä–µ–∑ date-fns-tz
- ‚úÖ **Single date, Range, Multiple dates** ‚Äî –≤—Å–µ —Ä–µ–∂–∏–º—ã

**UI:**

```
[üìÖ Feb 1, 2026 - Feb 10, 2026  ‚ñº]

–ü—Ä–µ—Å–µ—Ç—ã:
‚óã Today
‚óã Last 7 days
‚óè Custom range
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**

- **react-datepicker** ‚Äî –ø–æ–ø—É–ª—è—Ä–µ–Ω, –Ω–æ —Ç—è–∂–µ–ª–æ–≤–∞—Ç
- **MUI Date Pickers** ‚Äî —Ö–æ—Ä–æ—à–∏, –Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ MUI

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **8. File Upload: –∫–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –∞–≤–∞—Ç–∞—Ä–æ–≤/–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: react-dropzone + Uppy**

**–ü–æ—á–µ–º—É:**

- ‚úÖ **react-dropzone** ‚Äî drag \& drop area, file validation
- ‚úÖ **Uppy** ‚Äî chunked uploads, retry, progress bars, image preview/crop
- ‚úÖ **Direct upload** ‚Äî –∫–ª–∏–µ–Ω—Ç ‚Üí S3/CDN (–º–∏–Ω—É—è backend –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤)
- ‚úÖ **Image optimization** ‚Äî resize/compress –ø–µ—Ä–µ–¥ upload

**Flow:**

1. Client –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç presigned URL —É backend (`POST /api/upload/init`)
2. Uppy –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é –≤ S3
3. –ü–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞ ‚Äî callback –≤ backend –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è URL

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**

- **FilePond** ‚Äî –∫—Ä–∞—Å–∏–≤—ã–π, –Ω–æ –º–µ–Ω–µ–µ flexible
- **react-file-upload** ‚Äî —É—Å—Ç–∞—Ä–µ–ª

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **9. Notifications (Toast): –∫–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: sonner (by shadcn)**

**–ü–æ—á–µ–º—É:**

- ‚úÖ **Lightweight** ‚Äî 3kb
- ‚úÖ **–¢–∏–ø—ã:** success, error, warning, info, loading, promise
- ‚úÖ **Accessible** ‚Äî ARIA live regions
- ‚úÖ **Swipe to dismiss** ‚Äî touch-friendly
- ‚úÖ **Auto-stack** ‚Äî –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞

**–ü—Ä–∏–º–µ—Ä:**

```typescript
toast.success('–ü—Ä–∞–≤–∏–ª–æ —Å–æ–∑–¥–∞–Ω–æ!');
toast.error('–û—à–∏–±–∫–∞: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤');
toast.promise(
  createRule(data),
  {
    loading: '–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞...',
    success: '–ü—Ä–∞–≤–∏–ª–æ —Å–æ–∑–¥–∞–Ω–æ!',
    error: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è',
  }
);
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**

- **react-hot-toast** ‚Äî –ø–æ—Ö–æ–∂, –Ω–æ —á—É—Ç—å –±–æ–ª—å—à–µ boilerplate
- **react-toastify** ‚Äî —É—Å—Ç–∞—Ä–µ–ª, —Ç—è–∂—ë–ª—ã–π

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **10. Real-time updates: WebSocket vs Server-Sent Events vs Polling?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Server-Sent Events (SSE) + TanStack Query auto-refetch**

**–ü–æ—á–µ–º—É:**

- ‚úÖ **SSE** ‚Äî –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π push (—Å–µ—Ä–≤–µ—Ä ‚Üí –∫–ª–∏–µ–Ω—Ç), HTTP/2, auto-reconnect
- ‚úÖ **TanStack Query** ‚Äî auto-refetch –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **No WebSocket overhead** ‚Äî –ø—Ä–æ—â–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ **Firewall-friendly** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ

**Use Cases:**

- **Real-time:** POS webhook arrived (SSE event ‚Üí trigger refetch)
- **Periodic:** Balance updates (auto-refetch every 30s)
- **Manual:** User clicks "Refresh"

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**

- **WebSocket** ‚Äî overkill –¥–ª—è admin panel, –Ω—É–∂–µ–Ω socket.io, —Å–ª–æ–∂–Ω–µ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å
- **Long Polling** ‚Äî —É—Å—Ç–∞—Ä–µ–ª, –≤—ã—Å–æ–∫–∞—è latency

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

### **üìê –ë–õ–û–ö 2: LAYOUT \& NAVIGATION**

#### **11. Sidebar: fixed vs collapsible vs mini?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Collapsible Sidebar —Å mini-—Ä–µ–∂–∏–º–æ–º**

**–ü–æ—á–µ–º—É:**

- ‚úÖ **Expanded (250px)** ‚Äî –¥–µ—Ñ–æ–ª—Ç –¥–ª—è desktop
- ‚úÖ **Mini (60px)** ‚Äî —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫–∏ (–±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
- ‚úÖ **Hidden** ‚Äî –Ω–∞ –º–æ–±–∏–ª–∫–µ (overlay menu)
- ‚úÖ **–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** ‚Äî –≤ localStorage

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```
[Logo]

Dashboard
üè† Overview

Guests
üë• All Guests
üí≥ Guest Cards
üìä Segments

Loyalty
üéØ Rules
üèÜ Levels
üéÅ Promos

Analytics
üìà Reports
üí∞ Revenue
```

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **12. Top Navbar: —á—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:**

```
[‚ò∞ Menu]  [Breadcrumbs: Dashboard > Loyalty > Rules]       [üîç Search] [üîî Notifications] [Restaurant: –†–µ—Å—Ç–æ—Ä–∞–Ω 1 ‚ñº] [üë§ Ivan P. ‚ñº]
```

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

- **Breadcrumbs** ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è (Dashboard > Loyalty > Rules)
- **Global Search** ‚Äî CMD+K ‚Üí –ø–æ–∏—Å–∫ –≥–æ—Å—Ç–µ–π/–ø—Ä–∞–≤–∏–ª/–ø—Ä–æ–º–æ
- **Notifications** ‚Äî –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ —Å badge (3 –Ω–æ–≤—ã—Ö)
- **Restaurant Selector** ‚Äî dropdown (–¥–ª—è Admin —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º–∏)
- **User Menu** ‚Äî Settings, Billing, Logout, Impersonate (–¥–ª—è Owner)

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **13. Global Search (CMD+K): —á—Ç–æ –∏—Å–∫–∞—Ç—å?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Algolia/MeiliSearch + fuzzy search**

**–ß—Ç–æ –∏—Å–∫–∞—Ç—å:**

- **–ì–æ—Å—Ç–∏** ‚Äî –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É, email (–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≥–æ—Å—Ç—è)
- **–ü—Ä–∞–≤–∏–ª–∞** ‚Äî –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- **–ü—Ä–æ–º–æ** ‚Äî –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- **–ù–∞–≤–∏–≥–∞—Ü–∏—è** ‚Äî "Create guest", "View analytics" (–±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è)

**UI:**

```
üîç Search...                                    CMD+K

Recent:
üë§ Ivan Petrov (+7 999 123-45-67)
üéØ Birthday Promo

Suggestions:
üë• All Guests
üéÅ Create Promo
üìä Analytics
```

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**

- **MeiliSearch** ‚Äî self-hosted, fast, typo-tolerant
- **Algolia** ‚Äî SaaS, –¥–æ—Ä–æ–≥–æ, –Ω–æ instant
- **PostgreSQL Full-Text Search** ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **14. Breadcrumbs: —Å—Ç–∞—Ç–∏—á–Ω—ã–µ vs –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å –∏–º–µ–Ω–∞–º–∏ —Å—É—â–Ω–æ—Å—Ç–µ–π**

**–ü—Ä–∏–º–µ—Ä—ã:**

```
Dashboard > Guests > Ivan Petrov
Dashboard > Loyalty > Rules > Edit "Birthday Cashback"
Dashboard > Analytics > Restaurant "–°—É—à–∏–ª–∫–∞ –Ω–∞ –ê—Ä–±–∞—Ç–µ"
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- ‚úÖ –ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ (–º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥)
- ‚úÖ Truncate –¥–ª–∏–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è (max 30 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–Ω–µ –∫–ª–∏–∫–∞–±–µ–ª–µ–Ω)

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **15. Mobile Navigation: –∫–∞–∫ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Bottom Tab Bar (iOS-style) –¥–ª—è Manager/Cashier**

**–ü–æ—á–µ–º—É:**

- ‚úÖ **Cashier —á–∞—Å—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø–ª–∞–Ω—à–µ—Ç–∞/—Ç–µ–ª–µ—Ñ–æ–Ω–∞** –Ω–∞ –∫–∞—Å—Å–µ
- ‚úÖ **Bottom tabs** ‚Äî —É–¥–æ–±–Ω–µ–µ –æ–¥–Ω–æ–π —Ä—É–∫–æ–π

**Tabs:**

```
[üè† Home] [üë• Guests] [üéØ Loyalty] [üìä Stats] [‚öôÔ∏è More]
```

**Desktop:**

- Sidebar (–∫–∞–∫ –æ–±—ã—á–Ω–æ)

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

### **üé® –ë–õ–û–ö 3: –í–ò–ó–£–ê–õ–¨–ù–´–ô LOYALTY BUILDER**

#### **16. Loyalty Rules Builder: –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏–ª–∏ —Ñ–æ—Ä–º—ã?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Hybrid ‚Äî Form + Visual Preview**

**–ü–æ—á–µ–º—É:**

- ‚úÖ **Form (–ª–µ–≤–∞—è —á–∞—Å—Ç—å)** ‚Äî –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (earnPercent, conditions, filters)
- ‚úÖ **Live Preview (–ø—Ä–∞–≤–∞—è —á–∞—Å—Ç—å)** ‚Äî –∫–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –¥–ª—è –≥–æ—Å—Ç—è + –ø—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á—ë—Ç–∞

**UI:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ RULE SETTINGS               ‚îÇ PREVIEW                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Name: Birthday Cashback     ‚îÇ üí≥ Example Check: 2,000‚ÇΩ    ‚îÇ
‚îÇ Earn: 15%                   ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ    ‚îÇ
‚îÇ Level: Silver+              ‚îÇ Regular earn (10%): 200 pts ‚îÇ
‚îÇ Conditions:                 ‚îÇ Birthday bonus (15%): 300   ‚îÇ
‚îÇ   ‚òë Birthday week           ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ    ‚îÇ
‚îÇ   ‚òê First visit             ‚îÇ Total earned: 500 pts       ‚îÇ
‚îÇ   ‚òê Specific items          ‚îÇ                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**

- **–ü–æ–ª–Ω–æ—Å—Ç—å—é –≤–∏–∑—É–∞–ª—å–Ω—ã–π (drag-drop)** ‚Äî –∫—Ä–∞—Å–∏–≤–æ, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∫–µ–π—Å–æ–≤
- **–¢–æ–ª—å–∫–æ —Ñ–æ—Ä–º—ã** ‚Äî —Å–∫—É—á–Ω–æ, –Ω–µ –≤–∏–¥–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **17. Conditions Builder: –∫–∞–∫ –∑–∞–¥–∞–≤–∞—Ç—å —É—Å–ª–æ–≤–∏—è (–¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏, –≤—Ä–µ–º—è, —Ç–æ–≤–∞—Ä—ã)?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Tag-based —É—Å–ª–æ–≤–∏—è + AND/OR –ª–æ–≥–∏–∫–∞**

**UI:**

```
Apply rule when:

[+ Add condition ‚ñº]

Conditions:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Guest level: [Silver ‚ñº] [Gold ‚ñº]      ‚îÇ ‚úï
‚îÇ AND                                     ‚îÇ
‚îÇ Day of week: [Mon] [Tue] [Wed] ...    ‚îÇ ‚úï
‚îÇ OR                                      ‚îÇ
‚îÇ Item category: [Pizza ‚ñº] [Desserts ‚ñº] ‚îÇ ‚úï
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–¢–∏–ø—ã —É—Å–ª–æ–≤–∏–π:**

- **Guest:** level, registration date, birthday
- **Time:** day of week, time range, specific dates
- **Order:** item category, specific items, min amount
- **Location:** specific restaurant (–¥–ª—è multi-location tenants)

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **18. Priority –ø—Ä–∞–≤–∏–ª: –∫–∞–∫ –ø–æ–∫–∞–∑–∞—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Drag \& Drop —Å–ø–∏—Å–æ–∫ + Visual Priority**

**UI:**

```
LOYALTY RULES                                  [+ Create Rule]

Priority  Rule Name              Earn%  Status
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
1   ‚ãÆ‚ãÆ   Birthday Cashback        15%   üü¢ Active
2   ‚ãÆ‚ãÆ   Weekend Bonus            12%   üü¢ Active
3   ‚ãÆ‚ãÆ   Base Cashback            10%   üü¢ Active
4   ‚ãÆ‚ãÆ   First Visit              20%   üî¥ Inactive

Drag to reorder priority
```

**–§—É–Ω–∫—Ü–∏–∏:**

- ‚úÖ **Drag \& Drop** ‚Äî –º–µ–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫
- ‚úÖ **Badge "Priority 1"** ‚Äî –≤–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª—è–µ–º
- ‚úÖ **Warning** ‚Äî –µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **19. Levels Builder: –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–≤–Ω–∏?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Visual Timeline + Form**

**UI:**

```
LOYALTY LEVELS                                 [+ Add Level]

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  0‚ÇΩ        150,000‚ÇΩ       400,000‚ÇΩ                      ‚îÇ
‚îÇ  ‚óè‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚óè‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚óè‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí             ‚îÇ
‚îÇ  Bronze      Silver       Gold          [Next Level?]   ‚îÇ
‚îÇ  10%         12%          15%                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Selected: Silver
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Name: Silver                                            ‚îÇ
‚îÇ Threshold: 150,000‚ÇΩ                                     ‚îÇ
‚îÇ Earn Bonus: +2% (on top of base 10%)                   ‚îÇ
‚îÇ Color: #C0C0C0                                          ‚îÇ
‚îÇ Icon: [ü•à]                                              ‚îÇ
‚îÇ Benefits:                                               ‚îÇ
‚îÇ   ‚Ä¢ +2% cashback                                        ‚îÇ
‚îÇ   ‚Ä¢ Birthday bonus 500 pts                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **20. Promo Campaigns Builder: –∫–∞–∫–∏–µ —Ç–∏–ø—ã –ø—Ä–æ–º–æ –∏ –∫–∞–∫ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Wizard-style (—à–∞–≥–∏) + Templates**

**–®–∞–≥–∏:**

```
Step 1: Type         Step 2: Trigger      Step 3: Reward       Step 4: Review
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

‚óã Birthday           When:                Give:                Summary:
‚óã First Visit        ‚óè On birthday        ‚óè 500 bonus pts      ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚óè Inactivity         ‚óã 7 days before      ‚óã 10% discount       Type: Inactivity
‚óã Custom             ‚óã 14 days before     ‚óã Free item          Trigger: 30 days
                                                               Reward: 300 pts
                     Days inactive:       Expires:             Channels: Telegram
                     [^5_30] days            [^5_14] days            
```

**Templates:**

- üéÇ Birthday (500 pts, expires in 7 days)
- üëã Win-back (300 pts after 30 days inactive)
- üéâ First visit (20% cashback)
- üéÅ Custom

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

### **üìä –ë–õ–û–ö 4: ANALYTICS \& DASHBOARDS**

#### **21. Owner Dashboard: –∫–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:**

**Top Cards (KPIs):**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MRR        ‚îÇ Active     ‚îÇ Churn      ‚îÇ Total      ‚îÇ
‚îÇ $12,450    ‚îÇ Tenants    ‚îÇ Rate       ‚îÇ Guests     ‚îÇ
‚îÇ +8% ‚Üë      ‚îÇ 47         ‚îÇ 3.2%       ‚îÇ 15,234     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Charts:**

- **Revenue Trend** (line chart, 12 months)
- **Subscriptions by Plan** (pie chart)
- **Churn Analysis** (bar chart by reason)
- **Top Tenants by Revenue** (table)

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **22. Restaurant Admin Dashboard: –∫–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:**

**Top Cards:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Revenue    ‚îÇ Guests     ‚îÇ Avg Check  ‚îÇ Balls      ‚îÇ
‚îÇ 1,250,000‚ÇΩ ‚îÇ 3,456      ‚îÇ 2,150‚ÇΩ     ‚îÇ Redeemed   ‚îÇ
‚îÇ +12% ‚Üë     ‚îÇ +234 new   ‚îÇ +5% ‚Üë      ‚îÇ 45,600     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Charts:**

- **Revenue Trend** (30 days)
- **Guests by Level** (pie chart)
- **Top Promos** (bar chart by conversions)
- **Loyalty ROI** (cost vs saved revenue)

**Filters:**

```
[üìÖ Last 30 days ‚ñº]  [Restaurant: All ‚ñº]  [üîÑ Auto-refresh: ON]
```

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **23. Drill-down –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è: –∫–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Click on chart ‚Üí Modal —Å —Ç–∞–±–ª–∏—Ü–µ–π**

**–ü—Ä–∏–º–µ—Ä:**

1. Click –Ω–∞ "Silver" –≤ pie chart "Guests by Level"
2. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è modal:
```
SILVER GUESTS (1,234)                          [‚úï]

Filters: [Status: Active ‚ñº] [Registration: All time ‚ñº]

Name            Phone              Balance    Lifetime Spent
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Ivan Petrov     +7 999 123-45-67   2,850      152,000‚ÇΩ
Anna Ivanova    +7 888 777-66-55   1,200      98,500‚ÇΩ
...

[Export CSV]  [Export XLSX]
```

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **24. Export Reports: –∫–∞–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã –∏ —á—Ç–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: XLSX + CSV + PDF**

**–ß—Ç–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å:**

- **Guests list** (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏) ‚Üí XLSX/CSV
- **Transactions history** ‚Üí XLSX/CSV
- **Analytics report** (—Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏) ‚Üí PDF
- **Promo performance** ‚Üí XLSX

**Flow:**

1. User clicks "Export"
2. –í—ã–±–∏—Ä–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç + –∫–æ–ª–æ–Ω–∫–∏
3. Job –≤ –æ—á–µ—Ä–µ–¥—å (BullMQ)
4. Email —Å —Å—Å—ã–ª–∫–æ–π (expires in 24h)

**UI:**

```
EXPORT GUESTS

Format:  ‚óã XLSX  ‚óè CSV  ‚óã PDF

Columns: ‚òë Name  ‚òë Phone  ‚òë Balance  ‚òë Level
         ‚òê Email  ‚òê Birthday  ‚òê Registration Date

[Export]  [Cancel]
```

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **25. Real-time dashboard updates: –∫–∞–∫ —á–∞—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è—Ç—å?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥**

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:**

- **Critical metrics** (balance, active guests) ‚Üí auto-refetch every 30 sec
- **Historical data** (charts) ‚Üí cache 5 min, manual refresh
- **POS events** ‚Üí SSE push ‚Üí trigger refetch

**UI Toggle:**

```
[üîÑ Auto-refresh: ON]  Every 30s  [‚öôÔ∏è]
```

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

### **üë• –ë–õ–û–ö 5: GUESTS MANAGEMENT**

#### **26. Guests Table: –∫–∞–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:**

**Default Columns:**

```
‚òë Name          ‚òë Phone              ‚òë Balance    ‚òë Level    ‚òë Visits    ‚òë Lifetime Spent    ‚òë Last Visit
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Ivan Petrov     +7 999 123-45-67     2,850        Silver     47          152,000‚ÇΩ            2 days ago
Anna Ivanova    +7 888 777-66-55     1,200        Bronze     12          98,500‚ÇΩ             1 week ago
```

**Optional Columns (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ):**

- Email
- Birthday
- Registration Date
- Registration Source (POS, Telegram, Web)
- Status (Active, Blocked, Deleted)
- Tags

**–§—É–Ω–∫—Ü–∏–∏:**

- ‚úÖ **Resizable columns**
- ‚úÖ **Column reorder** (drag \& drop)
- ‚úÖ **Save layout** (per user)

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **27. Guest Profile Page: –∫–∞–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Tabs + Cards**

**Structure:**

```
Ivan Petrov  (+7 999 123-45-67)                      [Edit] [Block] [...]

Tabs: [Overview] [Transactions] [Visits] [Activity Log]

OVERVIEW Tab:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PERSONAL INFO              ‚îÇ LOYALTY STATUS             ‚îÇ
‚îÇ ‚Ä¢ Email: ivan@example.com  ‚îÇ ‚Ä¢ Level: Silver            ‚îÇ
‚îÇ ‚Ä¢ Birthday: May 15, 1990   ‚îÇ ‚Ä¢ Balance: 2,850 pts       ‚îÇ
‚îÇ ‚Ä¢ Phone: +7 999 123-45-67  ‚îÇ ‚Ä¢ Lifetime: 152,000‚ÇΩ       ‚îÇ
‚îÇ ‚Ä¢ Registered: Jan 1, 2025  ‚îÇ ‚Ä¢ Visits: 47               ‚îÇ
‚îÇ ‚Ä¢ Source: Telegram         ‚îÇ ‚Ä¢ Avg Check: 3,234‚ÇΩ        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ QUICK ACTIONS              ‚îÇ STATISTICS                 ‚îÇ
‚îÇ [+ Add Balls] [- Remove]   ‚îÇ ‚Ä¢ Favorite time: 18:00     ‚îÇ
‚îÇ [Transfer] [Reset QR]      ‚îÇ ‚Ä¢ Favorite day: Friday     ‚îÇ
‚îÇ [Send Message]             ‚îÇ ‚Ä¢ Top restaurant: Sushilka ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

TRANSACTIONS Tab:
(–¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏)

VISITS Tab:
(–°–ø–∏—Å–æ–∫ –≤–∏–∑–∏—Ç–æ–≤ —Å —á–µ–∫–∞–º–∏ –∏ items)

ACTIVITY LOG Tab:
(–ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π: manual add, level change, impersonation, ...)
```

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **28. Bulk Actions: –∫–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –≥–æ—Å—Ç—è–º–∏?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:**

**Actions:**

- ‚úÖ **Export** (selected guests ‚Üí CSV/XLSX)
- ‚úÖ **Add Balls** (–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –≥–æ—Å—Ç—è–º, —Å reason)
- ‚úÖ **Send Notification** (Telegram/Email)
- ‚úÖ **Apply Tag** (–¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏)
- ‚úÖ **Change Level** (manual upgrade/downgrade)
- ‚úÖ **Block/Unblock**

**UI:**

```
‚òë Ivan Petrov
‚òë Anna Ivanova          [3 selected ‚ñº]
‚òê Sergey Volkov         
                        ‚Ä¢ Export
                        ‚Ä¢ Add Balls
                        ‚Ä¢ Send Message
                        ‚Ä¢ Apply Tag
                        ‚Ä¢ Block
```

**Confirmation:**

```
ADD BALLS TO 3 GUESTS

Amount: [^5_500] pts
Reason: [Birthday bonus]

[Confirm]  [Cancel]
```

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **29. Guest Segmentation: –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–µ–≥–º–µ–Ω—Ç—ã?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Saved Filters + Auto Segments**

**Auto Segments:**

- üî• **VIP** (top 10% by lifetime spent)
- ‚ö†Ô∏è **At-Risk** (no visit 30+ days, but was active)
- üò¥ **Lost** (no visit 90+ days)
- üÜï **New** (registered last 30 days)
- üéÇ **Birthday This Month**

**Custom Segments:**

```
CREATE SEGMENT

Name: [High-Value Silver]

Filters:
‚Ä¢ Level: Silver
‚Ä¢ Lifetime Spent: > 100,000‚ÇΩ
‚Ä¢ Visits: > 20
‚Ä¢ Last Visit: < 30 days ago

Matching Guests: 342

[Save]  [Cancel]
```

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **30. Manual Ball Adjustment Modal: –∫–∞–∫–∞—è UX?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Simple Modal + Confirmation**

**UI:**

```
ADJUST BALLS FOR IVAN PETROV                   [‚úï]

Current Balance: 2,850 pts (Regular: 2,500 | Promo: 350)

Action:  ‚óè Add  ‚óã Remove

Amount: [^5_500] pts

Type:    ‚óè Regular  ‚óã Promo

Reason (required):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Compensation for delayed order            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚òë Notify guest via Telegram

[Confirm]  [Cancel]
```

**Confirmation (–¥–ª—è –±–æ–ª—å—à–∏—Ö —Å—É–º–º > 1,000):**

```
‚ö†Ô∏è CONFIRM LARGE ADJUSTMENT

You are about to add 5,000 pts to Ivan Petrov.
This action will be logged in Activity Log.

[Yes, Add 5,000 pts]  [Cancel]
```

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

### **‚öôÔ∏è –ë–õ–û–ö 6: SETTINGS \& CONFIGURATION**

#### **31. Restaurant Settings: –∫–∞–∫–∏–µ —Å–µ–∫—Ü–∏–∏?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Tabs –≤ Settings**

**Tabs:**

```
[General] [Loyalty System] [POS Integration] [Notifications] [Team] [Billing]
```

**GENERAL:**

- Name, Logo, Address, Phone, Email
- Working Hours
- Timezone

**LOYALTY SYSTEM:**

- Ball conversion (1 ball = 1‚ÇΩ)
- Redeem limit (10-100%)
- Min check amount (50‚ÇΩ)
- Inactivity expiration (90 days)
- Transfer settings

**POS INTEGRATION:**

- Select POS (iiko, R-Keeper, Poster, ...)
- Credentials (encrypted)
- Webhook URL
- Last sync status
- Test connection

**NOTIFICATIONS:**

- Channels (Telegram, Email, SMS)
- Templates
- Rate limits

**TEAM:**

- User list
- Roles \& Permissions
- Invite new user

**BILLING (–¥–ª—è Owner):**

- Current Plan
- Payment Method
- Invoices
- Usage Limits

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **32. Team Management: –∫–∞–∫ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Table + Invite Modal**

**UI:**

```
TEAM MEMBERS                                   [+ Invite User]

Name             Role        Status      Last Login      Actions
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Ivan Petrov      Admin       Active      2 hours ago     [Edit] [Remove]
Anna Manager     Manager     Active      1 day ago       [Edit] [Remove]
Sergey Cashier   Cashier     Invited     (pending)       [Resend] [Cancel]
```

**Invite Modal:**

```
INVITE USER

Email: [anna@example.com]
Role:  [Manager ‚ñº]
Restaurant: [Sushilka ‚ñº]  (–¥–ª—è Manager/Cashier)

Permissions (–¥–ª—è Manager):
‚òë Manage Guests
‚òë View Analytics
‚òê Manage Loyalty Rules
‚òë Manual Ball Adjustment

[Send Invite]  [Cancel]
```

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **33. Activity Log: –∫–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–µ–π—Å—Ç–≤–∏–π?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Filterable Table + Timeline**

**UI:**

```
ACTIVITY LOG

Filters: [User: All ‚ñº] [Action: All ‚ñº] [Date: Last 7 days ‚ñº]

Time             User          Action                  Details
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
2 hours ago      Ivan Petrov   Manual Add Balls        +500 pts to Anna Ivanova
                                                        Reason: Compensation
5 hours ago      Anna Manager  Updated Loyalty Rule    Birthday Cashback: 10% ‚Üí 15%
1 day ago        Owner         Impersonation Start     As Ivan Petrov
1 day ago        Owner         Impersonation End       Duration: 15 min
```

**Drill-down:**

```
Click on row ‚Üí  ACTIVITY DETAILS

Action: Manual Add Balls
User: Ivan Petrov (Admin)
Target: Anna Ivanova (+7 888 777-66-55)
Timestamp: Feb 10, 2026 16:45:23 MSK
IP Address: 95.123.45.67

Changes:
‚Ä¢ Balance: 2,350 ‚Üí 2,850 (+500)
‚Ä¢ Regular Balance: 2,000 ‚Üí 2,500 (+500)

Reason: Compensation for delayed order
```

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

#### **34. Impersonation UI (–¥–ª—è Owner): –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç?**

**üí° –ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï: Red Banner + Clear Exit**

**UI (–∫–æ–≥–¥–∞ Owner impersonates Admin):**

```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë üî¥ IMPERSONATION MODE: You are viewing as Ivan Petrov     ‚ïë
‚ïë All actions will be logged. [Exit Impersonation]          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

[Normal Admin UI below]
```

**Start Impersonation:**

```
IMPERSONATE USER

Select User: [Ivan Petrov (Admin) ‚ñº]
Reason: [Debug guest issue #123]

‚ö†Ô∏è All actions will be logged and visible in Activity Log.

[Start Impersonation]  [Cancel]
```

**–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ?**

***

***

## üéØ **–ò–¢–û–ì–û: 34 –≤–æ–ø—Ä–æ—Å–∞**

1. ‚úÖ Framework: Next.js vs React vs Vue?
2. ‚úÖ UI Library: shadcn/ui vs MUI vs Ant Design?
3. ‚úÖ State: Zustand + React Query vs Redux?
4. ‚úÖ Forms: React Hook Form + Zod?
5. ‚úÖ Tables: TanStack Table?
6. ‚úÖ Charts: Recharts vs Chart.js?
7. ‚úÖ Date Picker: React Day Picker?
8. ‚úÖ File Upload: react-dropzone + Uppy?
9. ‚úÖ Notifications: sonner?
10. ‚úÖ Real-time: SSE vs WebSocket?
11. ‚úÖ Sidebar: collapsible vs fixed?
12. ‚úÖ Top Navbar: –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã?
13. ‚úÖ Global Search: CMD+K?
14. ‚úÖ Breadcrumbs: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ?
15. ‚úÖ Mobile: Bottom tabs?
16. ‚úÖ Rules Builder: —Ñ–æ—Ä–º–∞ + preview?
17. ‚úÖ Conditions Builder: tag-based?
18. ‚úÖ Priority: drag \& drop?
19. ‚úÖ Levels Builder: visual timeline?
20. ‚úÖ Promo Builder: wizard vs —Ñ–æ—Ä–º–∞?
21. ‚úÖ Owner Dashboard: –º–µ—Ç—Ä–∏–∫–∏?
22. ‚úÖ Admin Dashboard: –º–µ—Ç—Ä–∏–∫–∏?
23. ‚úÖ Drill-down: modal vs –Ω–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞?
24. ‚úÖ Export: —Ñ–æ—Ä–º–∞—Ç—ã –∏ flow?
25. ‚úÖ Auto-refresh: —á–∞—Å—Ç–æ—Ç–∞?
26. ‚úÖ Guests Table: –∫–æ–ª–æ–Ω–∫–∏?
27. ‚úÖ Guest Profile: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞?
28. ‚úÖ Bulk Actions: –∫–∞–∫–∏–µ?
29. ‚úÖ Segmentation: saved filters?
30. ‚úÖ Manual Adjustment: UX?
31. ‚úÖ Restaurant Settings: —Å–µ–∫—Ü–∏–∏?
32. ‚úÖ Team Management: UI?
33. ‚úÖ Activity Log: —Ñ–æ—Ä–º–∞—Ç?
34. ‚úÖ Impersonation: UI/UX?

***

**–ñ–¥—É –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤! –ü–æ—Ç–æ–º —Å–æ–∑–¥–∞–º –∏—Ç–æ–≥–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ Frontend Admin Panel.**
<span style="display:none">[^5_1][^5_2]</span>

<div align="center">‚ÅÇ</div>

[^5_1]: Beseda-7.md

[^5_2]: Beseda-6.md


---

# –û—Ç–≤–µ—á–∞—é –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã :

    1. –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
    2.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 
    3.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 
    4.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    5.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    6.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    7.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    8.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    9.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    10.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    11.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    12.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    13.PostgreSQL Full-Text Search. 
    14.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 
    15.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 
    16.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    17.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    18.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    19.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    20.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –Ω–æ –≤—Å–µ –≤–∏–¥—ã –ø—Ä–æ–º–æ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏ –ø–æ —Å–≤–æ–µ–º—É (–ü–µ—Ä–∏–æ–¥—ã, –ù–∞–∑–≤–∞–Ω–∏—è, —Ç–∏–ø—ã, –±–æ–Ω—É—Å—ã, —Å–∫–∏–¥–∫–∏ –∏ —Ç–¥). 
    21.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    22.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    23.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    24.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    25.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    26.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    27.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    28.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏ "–Ω–∞—á–∏—Å–ª–∏—Ç—å" –∏ "—Å–ø–∏—Å–∞—Ç—å" –±–∞–ª–ª—ã. 
    29.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    30.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    31.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    32.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    33.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    34.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. 
    –í—Å–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (–∫–Ω–æ–ø–∫–∏, —Ñ–∏–ª—å—Ç—Ä—ã, –Ω–∞–∑–≤–∞–Ω–∏—è –∏ —Ç–¥)

–£—á–∏—Ç—ã–≤–∞—è –æ—Ç–≤–µ—Ç—ã, –≤—ã–≤–µ–¥–∏ —Å—é–¥–∞ –≤ —á–∞—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ—Å–ª–µ –ø—Ä–∏—Å—Ç—É–ø–∏–º –∫ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–ª–æ–∫–∞

–û—Ç–ª–∏—á–Ω–æ! –í—Å–µ 34 —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏–Ω—è—Ç—ã. –°–µ–π—á–∞—Å —Å—Ñ–æ—Ä–º–∏—Ä—É—é **–ø–æ–¥—Ä–æ–±–Ω—ã–π –∏—Ç–æ–≥–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç** –ø–æ Frontend Admin Panel.

***

# üé® Frontend Admin Panel (Owner/Admin/Manager UI)

## –§–∏–Ω–∞–ª—å–Ω–∞—è –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è

## –î–∞—Ç–∞ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: 10 —Ñ–µ–≤—Ä–∞–ª—è 2026


***

## üìö **1. TECHNOLOGY STACK \& ARCHITECTURE**

### 1.1. Core Framework

**‚úÖ –†–ï–®–ï–ù–ò–ï: Next.js 14+ (App Router)**

**Tech Stack:**

```json
{
  "framework": "Next.js 14.1+",
  "runtime": "Node.js 20 LTS",
  "language": "TypeScript 5.3+",
  "react": "React 18.2+",
  "package-manager": "pnpm 8+"
}
```

**Project Structure:**

```
frontend-admin/
‚îú‚îÄ‚îÄ app/                           # Next.js App Router
‚îÇ   ‚îú‚îÄ‚îÄ (auth)/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ reset-password/
‚îÇ   ‚îú‚îÄ‚îÄ (dashboard)/              # Authenticated routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx            # Main layout with sidebar
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx              # Dashboard home
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guests/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx          # Guests list
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx      # Guest profile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ loyalty/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rules/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ levels/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ promos/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analytics/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings/
‚îÇ   ‚îú‚îÄ‚îÄ api/                      # BFF (Backend for Frontend)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guests/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ analytics/
‚îÇ   ‚îî‚îÄ‚îÄ layout.tsx                # Root layout
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/                       # shadcn/ui components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ button.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ table.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ layout/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sidebar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ navbar.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ breadcrumbs.tsx
‚îÇ   ‚îú‚îÄ‚îÄ guests/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guests-table.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ guest-profile-card.tsx
‚îÇ   ‚îú‚îÄ‚îÄ loyalty/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rule-builder.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ level-timeline.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ promo-wizard.tsx
‚îÇ   ‚îî‚îÄ‚îÄ analytics/
‚îÇ       ‚îú‚îÄ‚îÄ revenue-chart.tsx
‚îÇ       ‚îî‚îÄ‚îÄ kpi-card.tsx
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ api.ts                    # API client
‚îÇ   ‚îú‚îÄ‚îÄ utils.ts                  # Utility functions
‚îÇ   ‚îî‚îÄ‚îÄ validations.ts            # Zod schemas
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ use-guests.ts
‚îÇ   ‚îú‚îÄ‚îÄ use-analytics.ts
‚îÇ   ‚îî‚îÄ‚îÄ use-loyalty.ts
‚îú‚îÄ‚îÄ stores/
‚îÇ   ‚îú‚îÄ‚îÄ ui-store.ts               # Zustand for UI state
‚îÇ   ‚îî‚îÄ‚îÄ auth-store.ts
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îú‚îÄ‚îÄ guest.ts
‚îÇ   ‚îú‚îÄ‚îÄ loyalty.ts
‚îÇ   ‚îî‚îÄ‚îÄ analytics.ts
‚îî‚îÄ‚îÄ public/
    ‚îî‚îÄ‚îÄ locales/                  # i18n (–±—É–¥—É—â–µ–µ)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ **SSR** ‚Äî –±—ã—Å—Ç—Ä–∞—è –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
- ‚úÖ **Server Components** ‚Äî –º–µ–Ω—å—à–µ JS –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- ‚úÖ **API Routes** ‚Äî BFF –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **File-based routing** ‚Äî –ø—Ä–æ—Å—Ç–æ—Ç–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- ‚úÖ **Image Optimization** ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- ‚úÖ **TypeScript** ‚Äî —Å—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è

***

### 1.2. UI Component Library

**‚úÖ –†–ï–®–ï–ù–ò–ï: shadcn/ui + Radix UI + Tailwind CSS**

**Dependencies:**

```json
{
  "dependencies": {
    "@radix-ui/react-dialog": "^1.0.5",
    "@radix-ui/react-dropdown-menu": "^2.0.6",
    "@radix-ui/react-select": "^2.0.0",
    "@radix-ui/react-tabs": "^1.0.4",
    "@radix-ui/react-tooltip": "^1.0.7",
    "tailwindcss": "^3.4.0",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.0",
    "tailwind-merge": "^2.2.0",
    "lucide-react": "^0.315.0"
  }
}
```

**shadcn/ui Components (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ):**

- `button`, `input`, `label`, `textarea`
- `dialog`, `sheet`, `popover`, `tooltip`
- `dropdown-menu`, `select`, `checkbox`, `radio-group`
- `table`, `card`, `tabs`, `badge`, `avatar`
- `alert`, `toast`, `skeleton`, `separator`

**–ö–∞—Å—Ç–æ–º–Ω–∞—è —Ç–µ–º–∞ (Tailwind):**

```typescript
// tailwind.config.ts
export default {
  theme: {
    extend: {
      colors: {
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        // Loyalty levels
        bronze: "#CD7F32",
        silver: "#C0C0C0",
        gold: "#FFD700",
      },
    },
  },
};
```


***

### 1.3. State Management

**‚úÖ –†–ï–®–ï–ù–ò–ï: Zustand + TanStack Query (React Query)**

**TanStack Query (Server State):**

```typescript
// hooks/use-guests.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';

export function useGuests(filters: GuestFilters) {
  return useQuery({
    queryKey: ['guests', filters],
    queryFn: () => api.guests.list(filters),
    staleTime: 30_000, // 30 —Å–µ–∫—É–Ω–¥
  });
}

export function useGuest(id: string) {
  return useQuery({
    queryKey: ['guest', id],
    queryFn: () => api.guests.get(id),
  });
}

export function useManualAdjustment() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: (data: ManualAdjustmentDto) => 
      api.loyalty.manualAdjustment(data),
    onSuccess: (_, variables) => {
      // Invalidate queries
      queryClient.invalidateQueries(['guest', variables.guestCardId]);
      queryClient.invalidateQueries(['guests']);
      toast.success('–ë–∞–ª–ª—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞—á–∏—Å–ª–µ–Ω—ã!');
    },
    onError: (error) => {
      toast.error(`–û—à–∏–±–∫–∞: ${error.message}`);
    },
  });
}
```

**Zustand (Client State):**

```typescript
// stores/ui-store.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface UIStore {
  isSidebarOpen: boolean;
  isSidebarMini: boolean;
  toggleSidebar: () => void;
  setMiniSidebar: (mini: boolean) => void;
  
  // Global search
  isSearchOpen: boolean;
  openSearch: () => void;
  closeSearch: () => void;
  
  // Selected restaurant (–¥–ª—è multi-restaurant tenants)
  selectedRestaurantId: string | null;
  setSelectedRestaurant: (id: string) => void;
}

export const useUIStore = create<UIStore>()(
  persist(
    (set) => ({
      isSidebarOpen: true,
      isSidebarMini: false,
      toggleSidebar: () => set((state) => ({ 
        isSidebarOpen: !state.isSidebarOpen 
      })),
      setMiniSidebar: (mini) => set({ isSidebarMini: mini }),
      
      isSearchOpen: false,
      openSearch: () => set({ isSearchOpen: true }),
      closeSearch: () => set({ isSearchOpen: false }),
      
      selectedRestaurantId: null,
      setSelectedRestaurant: (id) => set({ selectedRestaurantId: id }),
    }),
    {
      name: 'ui-storage',
      partialize: (state) => ({ 
        isSidebarMini: state.isSidebarMini,
        selectedRestaurantId: state.selectedRestaurantId,
      }),
    }
  )
);
```

**Query Configuration:**

```typescript
// app/providers.tsx
'use client';

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 30_000, // 30 —Å–µ–∫—É–Ω–¥
      cacheTime: 5 * 60_000, // 5 –º–∏–Ω—É—Ç
      refetchOnWindowFocus: false,
      retry: 1,
    },
  },
});

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <QueryClientProvider client={queryClient}>
      {children}
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}
```


***

### 1.4. Forms \& Validation

**‚úÖ –†–ï–®–ï–ù–ò–ï: React Hook Form + Zod**

**Dependencies:**

```json
{
  "dependencies": {
    "react-hook-form": "^7.49.3",
    "zod": "^3.22.4",
    "@hookform/resolvers": "^3.3.4"
  }
}
```

**–ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º—ã (Loyalty Rule):**

```typescript
// app/(dashboard)/loyalty/rules/create/page.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

const ruleSchema = z.object({
  name: z.string()
    .min(3, '–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞')
    .max(100, '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 100 —Å–∏–º–≤–æ–ª–æ–≤'),
  
  earnPercent: z.number()
    .min(1, '–ü—Ä–æ—Ü–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 1%')
    .max(100, '–ü—Ä–æ—Ü–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 100%'),
  
  levelIds: z.array(z.string()).optional(),
  
  conditions: z.object({
    daysOfWeek: z.array(z.number()).optional(),
    timeRange: z.object({
      from: z.string(),
      to: z.string(),
    }).optional(),
    itemCategories: z.array(z.string()).optional(),
  }).optional(),
  
  effectiveFrom: z.string().datetime(),
  effectiveUntil: z.string().datetime().nullable(),
  
  isActive: z.boolean().default(true),
});

type RuleFormData = z.infer<typeof ruleSchema>;

export default function CreateRulePage() {
  const form = useForm<RuleFormData>({
    resolver: zodResolver(ruleSchema),
    defaultValues: {
      name: '',
      earnPercent: 10,
      isActive: true,
    },
  });
  
  const createRule = useCreateRule();
  
  const onSubmit = (data: RuleFormData) => {
    createRule.mutate(data);
  };
  
  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)}>
        <FormField
          control={form.control}
          name="name"
          render={({ field }) => (
            <FormItem>
              <FormLabel>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞</FormLabel>
              <FormControl>
                <Input placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–∑–æ–≤—ã–π –∫–µ—à–±—ç–∫" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        
        <FormField
          control={form.control}
          name="earnPercent"
          render={({ field }) => (
            <FormItem>
              <FormLabel>–ü—Ä–æ—Ü–µ–Ω—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</FormLabel>
              <FormControl>
                <Input 
                  type="number" 
                  min={1} 
                  max={100} 
                  {...field} 
                  onChange={(e) => field.onChange(Number(e.target.value))}
                />
              </FormControl>
              <FormDescription>
                –û—Ç 1% –¥–æ 100%. –ì–æ—Å—Ç—å –ø–æ–ª—É—á–∏—Ç –±–∞–ª–ª–æ–≤ –Ω–∞ —Å—É–º–º—É —ç—Ç–æ–≥–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –æ—Ç —á–µ–∫–∞.
              </FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />
        
        <Button type="submit" disabled={createRule.isLoading}>
          {createRule.isLoading ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : '–°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ'}
        </Button>
      </form>
    </Form>
  );
}
```


***

### 1.5. Tables

**‚úÖ –†–ï–®–ï–ù–ò–ï: TanStack Table v8 + Virtualization**

**Dependencies:**

```json
{
  "dependencies": {
    "@tanstack/react-table": "^8.11.6",
    "@tanstack/react-virtual": "^3.0.1"
  }
}
```

**–ü—Ä–∏–º–µ—Ä: Guests Table:**

```typescript
// components/guests/guests-table.tsx
'use client';

import {
  useReactTable,
  getCoreRowModel,
  getSortedRowModel,
  getFilteredRowModel,
  getPaginationRowModel,
  ColumnDef,
  flexRender,
} from '@tanstack/react-table';

interface Guest {
  id: string;
  name: string;
  phone: string;
  balance: number;
  level: string;
  visits: number;
  lifetimeSpent: number;
  lastVisit: string;
}

const columns: ColumnDef<Guest>[] = [
  {
    accessorKey: 'name',
    header: '–ò–º—è',
    cell: ({ row }) => (
      <div className="flex items-center gap-2">
        <Avatar>
          <AvatarFallback>
            {row.original.name.split(' ').map(n => n[0]).join('')}
          </AvatarFallback>
        </Avatar>
        <span className="font-medium">{row.getValue('name')}</span>
      </div>
    ),
  },
  {
    accessorKey: 'phone',
    header: '–¢–µ–ª–µ—Ñ–æ–Ω',
  },
  {
    accessorKey: 'balance',
    header: '–ë–∞–ª–∞–Ω—Å',
    cell: ({ row }) => (
      <span className="font-mono">
        {row.getValue('balance')} –±–∞–ª–ª–æ–≤
      </span>
    ),
  },
  {
    accessorKey: 'level',
    header: '–£—Ä–æ–≤–µ–Ω—å',
    cell: ({ row }) => {
      const level = row.getValue('level') as string;
      return (
        <Badge variant={getLevelVariant(level)}>
          {level}
        </Badge>
      );
    },
  },
  {
    accessorKey: 'visits',
    header: '–í–∏–∑–∏—Ç—ã',
  },
  {
    accessorKey: 'lifetimeSpent',
    header: '–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ',
    cell: ({ row }) => (
      <span className="font-mono">
        {formatCurrency(row.getValue('lifetimeSpent'))}
      </span>
    ),
  },
  {
    accessorKey: 'lastVisit',
    header: '–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç',
    cell: ({ row }) => formatRelativeTime(row.getValue('lastVisit')),
  },
  {
    id: 'actions',
    cell: ({ row }) => (
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="ghost" size="sm">
            <MoreHorizontal className="h-4 w-4" />
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="end">
          <DropdownMenuItem asChild>
            <Link href={`/guests/${row.original.id}`}>
              –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
            </Link>
          </DropdownMenuItem>
          <DropdownMenuItem onClick={() => openAdjustmentModal(row.original)}>
            –ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã
          </DropdownMenuItem>
          <DropdownMenuItem onClick={() => openAdjustmentModal(row.original, 'remove')}>
            –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã
          </DropdownMenuItem>
          <DropdownMenuSeparator />
          <DropdownMenuItem className="text-destructive">
            –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>
    ),
  },
];

export function GuestsTable({ data }: { data: Guest[] }) {
  const [sorting, setSorting] = React.useState([]);
  const [columnFilters, setColumnFilters] = React.useState([]);
  const [rowSelection, setRowSelection] = React.useState({});
  
  const table = useReactTable({
    data,
    columns,
    state: {
      sorting,
      columnFilters,
      rowSelection,
    },
    onSortingChange: setSorting,
    onColumnFiltersChange: setColumnFilters,
    onRowSelectionChange: setRowSelection,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
  });
  
  return (
    <div>
      {/* Toolbar */}
      <div className="flex items-center justify-between mb-4">
        <Input
          placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É..."
          value={(table.getColumn('name')?.getFilterValue() as string) ?? ''}
          onChange={(e) =>
            table.getColumn('name')?.setFilterValue(e.target.value)
          }
          className="max-w-sm"
        />
        
        <div className="flex items-center gap-2">
          {Object.keys(rowSelection).length > 0 && (
            <BulkActionsMenu selectedCount={Object.keys(rowSelection).length} />
          )}
          
          <Button variant="outline" size="sm">
            <Filter className="h-4 w-4 mr-2" />
            –§–∏–ª—å—Ç—Ä—ã
          </Button>
          
          <Button variant="outline" size="sm">
            <Download className="h-4 w-4 mr-2" />
            –≠–∫—Å–ø–æ—Ä—Ç
          </Button>
        </div>
      </div>
      
      {/* Table */}
      <div className="rounded-md border">
        <Table>
          <TableHeader>
            {table.getHeaderGroups().map((headerGroup) => (
              <TableRow key={headerGroup.id}>
                {headerGroup.headers.map((header) => (
                  <TableHead key={header.id}>
                    {flexRender(
                      header.column.columnDef.header,
                      header.getContext()
                    )}
                  </TableHead>
                ))}
              </TableRow>
            ))}
          </TableHeader>
          <TableBody>
            {table.getRowModel().rows?.length ? (
              table.getRowModel().rows.map((row) => (
                <TableRow key={row.id}>
                  {row.getVisibleCells().map((cell) => (
                    <TableCell key={cell.id}>
                      {flexRender(
                        cell.column.columnDef.cell,
                        cell.getContext()
                      )}
                    </TableCell>
                  ))}
                </TableRow>
              ))
            ) : (
              <TableRow>
                <TableCell colSpan={columns.length} className="h-24 text-center">
                  –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
                </TableCell>
              </TableRow>
            )}
          </TableBody>
        </Table>
      </div>
      
      {/* Pagination */}
      <div className="flex items-center justify-between mt-4">
        <div className="text-sm text-muted-foreground">
          {table.getFilteredSelectedRowModel().rows.length} –∏–∑{' '}
          {table.getFilteredRowModel().rows.length} —Å—Ç—Ä–æ–∫ –≤—ã–±—Ä–∞–Ω–æ
        </div>
        
        <div className="flex items-center gap-2">
          <Button
            variant="outline"
            size="sm"
            onClick={() => table.previousPage()}
            disabled={!table.getCanPreviousPage()}
          >
            –ù–∞–∑–∞–¥
          </Button>
          
          <span className="text-sm">
            –°—Ç—Ä–∞–Ω–∏—Ü–∞ {table.getState().pagination.pageIndex + 1} –∏–∑{' '}
            {table.getPageCount()}
          </span>
          
          <Button
            variant="outline"
            size="sm"
            onClick={() => table.nextPage()}
            disabled={!table.getCanNextPage()}
          >
            –î–∞–ª–µ–µ
          </Button>
        </div>
      </div>
    </div>
  );
}
```

**Features:**

- ‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Å–µ–º –∫–æ–ª–æ–Ω–∫–∞–º
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ + –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º)
- ‚úÖ –ü–∞–≥–∏–Ω–∞—Ü–∏—è
- ‚úÖ –ú—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç —Å—Ç—Ä–æ–∫ (–¥–ª—è bulk actions)
- ‚úÖ Responsive
- ‚úÖ Column visibility toggle
- ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV/XLSX

***

### 1.6. Charts \& Analytics

**‚úÖ –†–ï–®–ï–ù–ò–ï: Recharts**

**Dependencies:**

```json
{
  "dependencies": {
    "recharts": "^2.10.3"
  }
}
```

**–ü—Ä–∏–º–µ—Ä: Revenue Trend Chart:**

```typescript
// components/analytics/revenue-chart.tsx
'use client';

import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from 'recharts';

interface RevenueData {
  date: string;
  revenue: number;
  checks: number;
}

export function RevenueChart({ data }: { data: RevenueData[] }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>–í—ã—Ä—É—á–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</CardTitle>
      </CardHeader>
      <CardContent>
        <ResponsiveContainer width="100%" height={350}>
          <LineChart data={data}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis 
              dataKey="date" 
              tickFormatter={(value) => formatDate(value, 'dd MMM')}
            />
            <YAxis 
              tickFormatter={(value) => formatCurrency(value)}
            />
            <Tooltip 
              labelFormatter={(value) => formatDate(value, 'dd MMMM yyyy')}
              formatter={(value: number) => [formatCurrency(value), '–í—ã—Ä—É—á–∫–∞']}
            />
            <Legend />
            <Line 
              type="monotone" 
              dataKey="revenue" 
              stroke="hsl(var(--primary))" 
              strokeWidth={2}
              dot={{ r: 4 }}
              activeDot={{ r: 6 }}
            />
          </LineChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}
```

**–¢–∏–ø—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤:**

- **Line Chart** ‚Äî Revenue trend, Guests growth
- **Bar Chart** ‚Äî Top promos, Revenue by day of week
- **Pie Chart** ‚Äî Guests by level, Subscriptions by plan
- **Area Chart** ‚Äî Cumulative revenue
- **Radar Chart** ‚Äî Guest activity patterns (–ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏)

***

### 1.7. Date Range Picker

**‚úÖ –†–ï–®–ï–ù–ò–ï: React Day Picker v8 + date-fns**

**Dependencies:**

```json
{
  "dependencies": {
    "react-day-picker": "^8.10.0",
    "date-fns": "^3.2.0"
  }
}
```

**Component:**

```typescript
// components/ui/date-range-picker.tsx
'use client';

import { format } from 'date-fns';
import { ru } from 'date-fns/locale';
import { Calendar as CalendarIcon } from 'lucide-react';
import { DateRange, DayPicker } from 'react-day-picker';

interface DateRangePickerProps {
  value?: DateRange;
  onChange: (range: DateRange | undefined) => void;
}

export function DateRangePicker({ value, onChange }: DateRangePickerProps) {
  const [isOpen, setIsOpen] = React.useState(false);
  
  const presets = [
    {
      label: '–°–µ–≥–æ–¥–Ω—è',
      range: {
        from: new Date(),
        to: new Date(),
      },
    },
    {
      label: '–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π',
      range: {
        from: subDays(new Date(), 7),
        to: new Date(),
      },
    },
    {
      label: '–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π',
      range: {
        from: subDays(new Date(), 30),
        to: new Date(),
      },
    },
    {
      label: '–≠—Ç–æ—Ç –º–µ—Å—è—Ü',
      range: {
        from: startOfMonth(new Date()),
        to: endOfMonth(new Date()),
      },
    },
    {
      label: '–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü',
      range: {
        from: startOfMonth(subMonths(new Date(), 1)),
        to: endOfMonth(subMonths(new Date(), 1)),
      },
    },
  ];
  
  return (
    <Popover open={isOpen} onOpenChange={setIsOpen}>
      <PopoverTrigger asChild>
        <Button variant="outline" className="w-[300px] justify-start">
          <CalendarIcon className="mr-2 h-4 w-4" />
          {value?.from ? (
            value.to ? (
              <>
                {format(value.from, 'dd MMM yyyy', { locale: ru })} -{' '}
                {format(value.to, 'dd MMM yyyy', { locale: ru })}
              </>
            ) : (
              format(value.from, 'dd MMM yyyy', { locale: ru })
            )
          ) : (
            <span>–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥</span>
          )}
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-auto p-0" align="start">
        <div className="flex">
          {/* Presets */}
          <div className="border-r p-3 space-y-1">
            {presets.map((preset) => (
              <Button
                key={preset.label}
                variant="ghost"
                size="sm"
                className="w-full justify-start"
                onClick={() => {
                  onChange(preset.range);
                  setIsOpen(false);
                }}
              >
                {preset.label}
              </Button>
            ))}
          </div>
          
          {/* Calendar */}
          <DayPicker
            mode="range"
            selected={value}
            onSelect={onChange}
            numberOfMonths={2}
            locale={ru}
          />
        </div>
      </PopoverContent>
    </Popover>
  );
}
```


***

### 1.8. File Upload

**‚úÖ –†–ï–®–ï–ù–ò–ï: react-dropzone + Direct S3 Upload**

**Dependencies:**

```json
{
  "dependencies": {
    "react-dropzone": "^14.2.3"
  }
}
```

**Component:**

```typescript
// components/ui/file-upload.tsx
'use client';

import { useDropzone } from 'react-dropzone';
import { Upload, X } from 'lucide-react';

interface FileUploadProps {
  onUpload: (file: File) => Promise<string>;
  accept?: Record<string, string[]>;
  maxSize?: number;
  preview?: string;
}

export function FileUpload({ 
  onUpload, 
  accept = { 'image/*': ['.png', '.jpg', '.jpeg'] },
  maxSize = 5 * 1024 * 1024, // 5MB
  preview,
}: FileUploadProps) {
  const [uploading, setUploading] = React.useState(false);
  const [uploadedUrl, setUploadedUrl] = React.useState(preview);
  
  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    accept,
    maxSize,
    multiple: false,
    onDrop: async (acceptedFiles) => {
      const file = acceptedFiles[0];
      if (!file) return;
      
      setUploading(true);
      try {
        const url = await onUpload(file);
        setUploadedUrl(url);
        toast.success('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!');
      } catch (error) {
        toast.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
      } finally {
        setUploading(false);
      }
    },
  });
  
  if (uploadedUrl) {
    return (
      <div className="relative w-32 h-32">
        <img
          src={uploadedUrl}
          alt="Preview"
          className="w-full h-full object-cover rounded-lg"
        />
        <Button
          variant="destructive"
          size="icon"
          className="absolute -top-2 -right-2 h-6 w-6"
          onClick={() => setUploadedUrl(undefined)}
        >
          <X className="h-4 w-4" />
        </Button>
      </div>
    );
  }
  
  return (
    <div
      {...getRootProps()}
      className={cn(
        'border-2 border-dashed rounded-lg p-6 cursor-pointer transition-colors',
        isDragActive ? 'border-primary bg-primary/5' : 'border-muted-foreground/25',
        uploading && 'opacity-50 pointer-events-none'
      )}
    >
      <input {...getInputProps()} />
      <div className="flex flex-col items-center gap-2 text-center">
        <Upload className="h-8 w-8 text-muted-foreground" />
        <div className="text-sm">
          {uploading ? (
            <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
          ) : isDragActive ? (
            <span>–û—Ç–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª –∑–¥–µ—Å—å</span>
          ) : (
            <>
              <span className="font-medium text-primary">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</span>
              {' –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª'}
            </>
          )}
        </div>
        <p className="text-xs text-muted-foreground">
          PNG, JPG –¥–æ 5MB
        </p>
      </div>
    </div>
  );
}
```

**Upload Flow:**

```typescript
// lib/upload.ts
export async function uploadFile(file: File): Promise<string> {
  // 1. Request presigned URL
  const { url, fields } = await api.upload.getPresignedUrl({
    filename: file.name,
    contentType: file.type,
  });
  
  // 2. Upload to S3
  const formData = new FormData();
  Object.entries(fields).forEach(([key, value]) => {
    formData.append(key, value as string);
  });
  formData.append('file', file);
  
  await fetch(url, {
    method: 'POST',
    body: formData,
  });
  
  // 3. Return public URL
  return `${url}/${fields.key}`;
}
```


***

### 1.9. Notifications (Toast)

**‚úÖ –†–ï–®–ï–ù–ò–ï: sonner**

**Dependencies:**

```json
{
  "dependencies": {
    "sonner": "^1.3.1"
  }
}
```

**Setup:**

```typescript
// app/layout.tsx
import { Toaster } from 'sonner';

export default function RootLayout({ children }) {
  return (
    <html lang="ru">
      <body>
        {children}
        <Toaster position="top-right" />
      </body>
    </html>
  );
}
```

**Usage:**

```typescript
import { toast } from 'sonner';

// Success
toast.success('–ü—Ä–∞–≤–∏–ª–æ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!');

// Error
toast.error('–û—à–∏–±–∫–∞: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤');

// Warning
toast.warning('–ë–∞–ª–ª—ã —Å–∫–æ—Ä–æ —Å–≥–æ—Ä—è—Ç!');

// Info
toast.info('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å POS –∑–∞–≤–µ—Ä—à–µ–Ω–∞');

// Loading
toast.loading('–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞...');

// Promise (auto success/error)
toast.promise(
  createRule(data),
  {
    loading: '–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞...',
    success: '–ü—Ä–∞–≤–∏–ª–æ —Å–æ–∑–¥–∞–Ω–æ!',
    error: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è',
  }
);

// With action
toast('–ì–æ—Å—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', {
  action: {
    label: '–û—Ç–º–µ–Ω–∏—Ç—å',
    onClick: () => unblockGuest(id),
  },
});
```


***

### 1.10. Real-time Updates

**‚úÖ –†–ï–®–ï–ù–ò–ï: Server-Sent Events (SSE) + TanStack Query auto-refetch**

**Backend (NestJS):**

```typescript
// src/sse/sse.controller.ts
@Controller('sse')
export class SSEController {
  @Sse('events')
  events(@Request() req): Observable<MessageEvent> {
    const userId = req.user.id;
    
    return new Observable((observer) => {
      const handler = (event: any) => {
        if (event.userId === userId) {
          observer.next({
            data: JSON.stringify(event),
          });
        }
      };
      
      this.eventEmitter.on('notification', handler);
      this.eventEmitter.on('pos.webhook', handler);
      this.eventEmitter.on('balance.updated', handler);
      
      return () => {
        this.eventEmitter.off('notification', handler);
        this.eventEmitter.off('pos.webhook', handler);
        this.eventEmitter.off('balance.updated', handler);
      };
    });
  }
}
```

**Frontend:**

```typescript
// hooks/use-sse.ts
export function useSSE() {
  const queryClient = useQueryClient();
  
  React.useEffect(() => {
    const eventSource = new EventSource('/api/sse/events', {
      withCredentials: true,
    });
    
    eventSource.addEventListener('notification', (event) => {
      const data = JSON.parse(event.data);
      toast.info(data.message);
    });
    
    eventSource.addEventListener('pos.webhook', (event) => {
      // Invalidate guests queries
      queryClient.invalidateQueries(['guests']);
      queryClient.invalidateQueries(['analytics']);
    });
    
    eventSource.addEventListener('balance.updated', (event) => {
      const { guestCardId } = JSON.parse(event.data);
      queryClient.invalidateQueries(['guest', guestCardId]);
    });
    
    return () => {
      eventSource.close();
    };
  }, [queryClient]);
}
```

**Auto-refetch (TanStack Query):**

```typescript
// hooks/use-analytics.ts
export function useAnalytics(restaurantId: string, period: DateRange) {
  return useQuery({
    queryKey: ['analytics', restaurantId, period],
    queryFn: () => api.analytics.get(restaurantId, period),
    refetchInterval: 30_000, // Auto-refetch –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    refetchOnWindowFocus: true,
  });
}
```


***

## üìê **2. LAYOUT \& NAVIGATION**

### 2.1. Sidebar

**‚úÖ –†–ï–®–ï–ù–ò–ï: Collapsible Sidebar —Å Mini-—Ä–µ–∂–∏–º–æ–º**

**Component:**

```typescript
// components/layout/sidebar.tsx
'use client';

import { useUIStore } from '@/stores/ui-store';
import { cn } from '@/lib/utils';
import {
  Home,
  Users,
  CreditCard,
  Target,
  Trophy,
  Gift,
  BarChart3,
  Settings,
  ChevronLeft,
} from 'lucide-react';

const menuItems = [
  {
    section: 'Dashboard',
    items: [
      { icon: Home, label: '–û–±–∑–æ—Ä', href: '/dashboard' },
    ],
  },
  {
    section: '–ì–æ—Å—Ç–∏',
    items: [
      { icon: Users, label: '–í—Å–µ –≥–æ—Å—Ç–∏', href: '/guests' },
      { icon: CreditCard, label: '–ö–∞—Ä—Ç—ã', href: '/cards' },
    ],
  },
  {
    section: '–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏',
    items: [
      { icon: Target, label: '–ü—Ä–∞–≤–∏–ª–∞', href: '/loyalty/rules' },
      { icon: Trophy, label: '–£—Ä–æ–≤–Ω–∏', href: '/loyalty/levels' },
      { icon: Gift, label: '–ü—Ä–æ–º–æ', href: '/loyalty/promos' },
    ],
  },
  {
    section: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
    items: [
      { icon: BarChart3, label: '–û—Ç—á—ë—Ç—ã', href: '/analytics' },
    ],
  },
  {
    section: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
    items: [
      { icon: Settings, label: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', href: '/settings' },
    ],
  },
];

export function Sidebar() {
  const { isSidebarMini, setMiniSidebar } = useUIStore();
  
  return (
    <aside
      className={cn(
        'fixed left-0 top-0 z-40 h-screen border-r bg-background transition-all',
        isSidebarMini ? 'w-[60px]' : 'w-[250px]'
      )}
    >
      {/* Logo */}
      <div className="flex h-16 items-center justify-between px-4 border-b">
        {!isSidebarMini && (
          <span className="text-xl font-bold">MaxLoyalty</span>
        )}
        <Button
          variant="ghost"
          size="icon"
          onClick={() => setMiniSidebar(!isSidebarMini)}
        >
          <ChevronLeft
            className={cn(
              'h-4 w-4 transition-transform',
              isSidebarMini && 'rotate-180'
            )}
          />
        </Button>
      </div>
      
      {/* Menu */}
      <nav className="p-2 space-y-6">
        {menuItems.map((group) => (
          <div key={group.section}>
            {!isSidebarMini && (
              <h3 className="px-3 mb-2 text-xs font-semibold text-muted-foreground uppercase">
                {group.section}
              </h3>
            )}
            <div className="space-y-1">
              {group.items.map((item) => {
                const Icon = item.icon;
                return (
                  <Link
                    key={item.href}
                    href={item.href}
                    className={cn(
                      'flex items-center gap-3 rounded-lg px-3 py-2 text-sm transition-colors',
                      'hover:bg-accent hover:text-accent-foreground',
                      pathname === item.href && 'bg-accent'
                    )}
                  >
                    <Icon className="h-4 w-4 flex-shrink-0" />
                    {!isSidebarMini && <span>{item.label}</span>}
                  </Link>
                );
              })}
            </div>
          </div>
        ))}
      </nav>
    </aside>
  );
}
```

**States:**

- **Expanded (250px)** ‚Äî –¥–µ—Ñ–æ–ª—Ç –Ω–∞ desktop
- **Mini (60px)** ‚Äî —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫–∏, hover ‚Üí tooltip
- **Hidden** ‚Äî –Ω–∞ –º–æ–±–∏–ª–∫–µ (< 768px)

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**

```typescript
// stores/ui-store.ts (Zustand persist)
persist(
  (set) => ({ ... }),
  {
    name: 'ui-storage',
    partialize: (state) => ({ 
      isSidebarMini: state.isSidebarMini,
    }),
  }
)
```


***

### 2.2. Top Navbar

**‚úÖ –†–ï–®–ï–ù–ò–ï:**

```
[‚ò∞]  [Dashboard > –ì–æ—Å—Ç–∏ > –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤]       [üîç CMD+K] [üîî 3] [–†–µ—Å—Ç–æ—Ä–∞–Ω 1 ‚ñº] [Ivan P. ‚ñº]
```

**Component:**

```typescript
// components/layout/navbar.tsx
'use client';

export function Navbar() {
  const { user } = useAuth();
  const { selectedRestaurantId, setSelectedRestaurant } = useUIStore();
  const { data: restaurants } = useRestaurants();
  const { data: notifications } = useNotifications();
  
  const unreadCount = notifications?.filter(n => !n.isRead).length ?? 0;
  
  return (
    <header className="sticky top-0 z-30 flex h-16 items-center gap-4 border-b bg-background px-4">
      {/* Mobile Menu Toggle */}
      <Button
        variant="ghost"
        size="icon"
        className="md:hidden"
        onClick={() => toggleMobileMenu()}
      >
        <Menu className="h-5 w-5" />
      </Button>
      
      {/* Breadcrumbs */}
      <Breadcrumbs />
      
      <div className="flex-1" />
      
      {/* Global Search */}
      <Button
        variant="outline"
        className="w-[300px] justify-start text-muted-foreground"
        onClick={() => openSearch()}
      >
        <Search className="mr-2 h-4 w-4" />
        –ü–æ–∏—Å–∫...
        <kbd className="ml-auto pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground">
          <span className="text-xs">‚åò</span>K
        </kbd>
      </Button>
      
      {/* Notifications */}
      <Button variant="ghost" size="icon" className="relative">
        <Bell className="h-5 w-5" />
        {unreadCount > 0 && (
          <span className="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-destructive text-[10px] text-destructive-foreground">
            {unreadCount}
          </span>
        )}
      </Button>
      
      {/* Restaurant Selector (–¥–ª—è multi-restaurant) */}
      {restaurants && restaurants.length > 1 && (
        <Select
          value={selectedRestaurantId ?? undefined}
          onValueChange={setSelectedRestaurant}
        >
          <SelectTrigger className="w-[200px]">
            <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω" />
          </SelectTrigger>
          <SelectContent>
            {restaurants.map((restaurant) => (
              <SelectItem key={restaurant.id} value={restaurant.id}>
                {restaurant.name}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      )}
      
      {/* User Menu */}
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="ghost" className="gap-2">
            <Avatar className="h-8 w-8">
              <AvatarImage src={user.photoUrl} />
              <AvatarFallback>
                {user.name.split(' ').map(n => n[0]).join('')}
              </AvatarFallback>
            </Avatar>
            <span className="hidden md:inline">{user.name}</span>
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="end">
          <DropdownMenuLabel>–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç</DropdownMenuLabel>
          <DropdownMenuSeparator />
          <DropdownMenuItem asChild>
            <Link href="/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</Link>
          </DropdownMenuItem>
          {user.role === 'OWNER' && (
            <>
              <DropdownMenuItem asChild>
                <Link href="/billing">–ë–∏–ª–ª–∏–Ω–≥</Link>
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => openImpersonationModal()}>
                –†–µ–∂–∏–º –∏–º–ø–µ—Ä—Å–æ–Ω–∞—Ü–∏–∏
              </DropdownMenuItem>
            </>
          )}
          <DropdownMenuSeparator />
          <DropdownMenuItem onClick={() => logout()}>
            –í—ã–π—Ç–∏
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>
    </header>
  );
}
```


***

### 2.3. Global Search (CMD+K)

**‚úÖ –†–ï–®–ï–ù–ò–ï: PostgreSQL Full-Text Search**

**Backend (API):**

```typescript
// src/search/search.service.ts
@Injectable()
export class SearchService {
  async globalSearch(query: string, userId: string) {
    const user = await this.prisma.user.findUnique({ where: { id: userId } });
    
    // Search guests
    const guests = await this.prisma.guestProfile.findMany({
      where: {
        tenantId: user.tenantId,
        OR: [
          { firstname: { contains: query, mode: 'insensitive' } },
          { lastname: { contains: query, mode: 'insensitive' } },
          { phone: { contains: query } },
          { email: { contains: query, mode: 'insensitive' } },
        ],
      },
      take: 5,
    });
    
    // Search loyalty rules
    const rules = await this.prisma.loyaltyRule.findMany({
      where: {
        tenantId: user.tenantId,
        name: { contains: query, mode: 'insensitive' },
      },
      take: 3,
    });
    
    // Search promos
    const promos = await this.prisma.loyaltyPromo.findMany({
      where: {
        tenantId: user.tenantId,
        name: { contains: query, mode: 'insensitive' },
      },
      take: 3,
    });
    
    return {
      guests: guests.map(g => ({
        type: 'guest',
        id: g.userId,
        title: `${g.firstname} ${g.lastname}`,
        subtitle: g.phone,
        href: `/guests/${g.userId}`,
      })),
      rules: rules.map(r => ({
        type: 'rule',
        id: r.id,
        title: r.name,
        subtitle: `${r.earnPercent}% –∫–µ—à–±—ç–∫`,
        href: `/loyalty/rules/${r.id}`,
      })),
      promos: promos.map(p => ({
        type: 'promo',
        id: p.id,
        title: p.name,
        subtitle: p.type,
        href: `/loyalty/promos/${p.id}`,
      })),
    };
  }
}
```

**Frontend Component:**

```typescript
// components/search/global-search.tsx
'use client';

import { Command } from 'cmdk';

export function GlobalSearch() {
  const { isSearchOpen, closeSearch } = useUIStore();
  const [query, setQuery] = React.useState('');
  const { data, isLoading } = useQuery({
    queryKey: ['search', query],
    queryFn: () => api.search.global(query),
    enabled: query.length > 0,
  });
  
  React.useEffect(() => {
    const down = (e: KeyboardEvent) => {
      if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        openSearch();
      }
    };
    
    document.addEventListener('keydown', down);
    return () => document.removeEventListener('keydown', down);
  }, []);
  
  return (
    <Dialog open={isSearchOpen} onOpenChange={closeSearch}>
      <DialogContent className="p-0">
        <Command>
          <CommandInput
            placeholder="–ü–æ–∏—Å–∫ –≥–æ—Å—Ç–µ–π, –ø—Ä–∞–≤–∏–ª, –ø—Ä–æ–º–æ..."
            value={query}
            onValueChange={setQuery}
          />
          <CommandList>
            {isLoading && (
              <CommandEmpty>–ó–∞–≥—Ä—É–∑–∫–∞...</CommandEmpty>
            )}
            
            {data?.guests && data.guests.length > 0 && (
              <CommandGroup heading="–ì–æ—Å—Ç–∏">
                {data.guests.map((guest) => (
                  <CommandItem
                    key={guest.id}
                    onSelect={() => {
                      router.push(guest.href);
                      closeSearch();
                    }}
                  >
                    <Users className="mr-2 h-4 w-4" />
                    <div className="flex-1">
                      <div className="font-medium">{guest.title}</div>
                      <div className="text-sm text-muted-foreground">
                        {guest.subtitle}
                      </div>
                    </div>
                  </CommandItem>
                ))}
              </CommandGroup>
            )}
            
            {data?.rules && data.rules.length > 0 && (
              <CommandGroup heading="–ü—Ä–∞–≤–∏–ª–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏">
                {data.rules.map((rule) => (
                  <CommandItem
                    key={rule.id}
                    onSelect={() => {
                      router.push(rule.href);
                      closeSearch();
                    }}
                  >
                    <Target className="mr-2 h-4 w-4" />
                    <div className="flex-1">
                      <div className="font-medium">{rule.title}</div>
                      <div className="text-sm text-muted-foreground">
                        {rule.subtitle}
                      </div>
                    </div>
                  </CommandItem>
                ))}
              </CommandGroup>
            )}
            
            {data?.promos && data.promos.length > 0 && (
              <CommandGroup heading="–ü—Ä–æ–º–æ-–∫–∞–º–ø–∞–Ω–∏–∏">
                {data.promos.map((promo) => (
                  <CommandItem
                    key={promo.id}
                    onSelect={() => {
                      router.push(promo.href);
                      closeSearch();
                    }}
                  >
                    <Gift className="mr-2 h-4 w-4" />
                    <div className="flex-1">
                      <div className="font-medium">{promo.title}</div>
                      <div className="text-sm text-muted-foreground">
                        {promo.subtitle}
                      </div>
                    </div>
                  </CommandItem>
                ))}
              </CommandGroup>
            )}
          </CommandList>
        </Command>
      </DialogContent>
    </Dialog>
  );
}
```


***

### 2.4. Breadcrumbs

**‚úÖ –†–ï–®–ï–ù–ò–ï: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å –∏–º–µ–Ω–∞–º–∏ —Å—É—â–Ω–æ—Å—Ç–µ–π**

**Component:**

```typescript
// components/layout/breadcrumbs.tsx
'use client';

export function Breadcrumbs() {
  const pathname = usePathname();
  const segments = pathname.split('/').filter(Boolean);
  
  const breadcrumbs = useMemo(() => {
    const items = [{ label: 'Dashboard', href: '/dashboard' }];
    
    let currentPath = '';
    for (let i = 0; i < segments.length; i++) {
      const segment = segments[i];
      currentPath += `/${segment}`;
      
      // If UUID, fetch entity name
      if (isUUID(segment)) {
        const entityType = segments[i - 1]; // guests, rules, promos
        const name = useEntityName(entityType, segment);
        items.push({ label: name ?? '–ó–∞–≥—Ä—É–∑–∫–∞...', href: currentPath });
      } else {
        const label = getSegmentLabel(segment);
        items.push({ label, href: currentPath });
      }
    }
    
    return items;
  }, [segments]);
  
  return (
    <nav className="flex items-center gap-2 text-sm">
      {breadcrumbs.map((item, index) => (
        <React.Fragment key={item.href}>
          {index > 0 && (
            <ChevronRight className="h-4 w-4 text-muted-foreground" />
          )}
          {index === breadcrumbs.length - 1 ? (
            <span className="font-medium text-foreground">
              {truncate(item.label, 30)}
            </span>
          ) : (
            <Link
              href={item.href}
              className="text-muted-foreground hover:text-foreground"
            >
              {item.label}
            </Link>
          )}
        </React.Fragment>
      ))}
    </nav>
  );
}

function getSegmentLabel(segment: string): string {
  const labels: Record<string, string> = {
    'dashboard': 'Dashboard',
    'guests': '–ì–æ—Å—Ç–∏',
    'cards': '–ö–∞—Ä—Ç—ã',
    'loyalty': '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å',
    'rules': '–ü—Ä–∞–≤–∏–ª–∞',
    'levels': '–£—Ä–æ–≤–Ω–∏',
    'promos': '–ü—Ä–æ–º–æ',
    'analytics': '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
    'settings': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
  };
  
  return labels[segment] ?? segment;
}
```


***

### 2.5. Mobile Navigation

**‚úÖ –†–ï–®–ï–ù–ò–ï: Bottom Tab Bar –¥–ª—è Manager/Cashier**

**Component:**

```typescript
// components/layout/mobile-nav.tsx
'use client';

const tabs = [
  { icon: Home, label: '–ì–ª–∞–≤–Ω–∞—è', href: '/dashboard' },
  { icon: Users, label: '–ì–æ—Å—Ç–∏', href: '/guests' },
  { icon: Target, label: '–õ–æ—è–ª—å–Ω–æ—Å—Ç—å', href: '/loyalty' },
  { icon: BarChart3, label: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', href: '/analytics' },
  { icon: Settings, label: '–ï—â—ë', href: '/settings' },
];

export function MobileNav() {
  const pathname = usePathname();
  
  return (
    <nav className="fixed bottom-0 left-0 right-0 z-50 border-t bg-background md:hidden">
      <div className="flex items-center justify-around">
        {tabs.map((tab) => {
          const Icon = tab.icon;
          const isActive = pathname.startsWith(tab.href);
          
          return (
            <Link
              key={tab.href}
              href={tab.href}
              className={cn(
                'flex flex-col items-center gap-1 p-3 text-xs transition-colors',
                isActive
                  ? 'text-primary'
                  : 'text-muted-foreground hover:text-foreground'
              )}
            >
              <Icon className="h-5 w-5" />
              <span>{tab.label}</span>
            </Link>
          );
        })}
      </div>
    </nav>
  );
}
```

**Layout Integration:**

```typescript
// app/(dashboard)/layout.tsx
export default function DashboardLayout({ children }) {
  return (
    <>
      {/* Desktop */}
      <div className="hidden md:block">
        <Sidebar />
      </div>
      
      <div className="md:ml-[250px]">
        <Navbar />
        <main className="p-6 pb-20 md:pb-6">
          {children}
        </main>
      </div>
      
      {/* Mobile */}
      <MobileNav />
    </>
  );
}
```


***

## üé® **3. –í–ò–ó–£–ê–õ–¨–ù–´–ô LOYALTY BUILDER**

### 3.1. Loyalty Rules Builder

**‚úÖ –†–ï–®–ï–ù–ò–ï: Hybrid ‚Äî Form + Live Preview**

**Page:**

```typescript
// app/(dashboard)/loyalty/rules/create/page.tsx
'use client';

export default function CreateRulePage() {
  const form = useForm<RuleFormData>({
    resolver: zodResolver(ruleSchema),
    defaultValues: {
      name: '',
      earnPercent: 10,
      conditions: {},
    },
  });
  
  const formValues = form.watch();
  
  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* LEFT: Form */}
      <Card>
        <CardHeader>
          <CardTitle>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∞–≤–∏–ª–∞</CardTitle>
          <CardDescription>
            –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤
          </CardDescription>
        </CardHeader>
        <CardContent>
          <Form {...form}>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
              {/* Basic Info */}
              <FormField
                control={form.control}
                name="name"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞</FormLabel>
                    <FormControl>
                      <Input placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–∑–æ–≤—ã–π –∫–µ—à–±—ç–∫" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              
              <FormField
                control={form.control}
                name="earnPercent"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>–ü—Ä–æ—Ü–µ–Ω—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</FormLabel>
                    <FormControl>
                      <div className="flex items-center gap-4">
                        <Slider
                          value={[field.value]}
                          onValueChange={([value]) => field.onChange(value)}
                          min={1}
                          max={100}
                          step={1}
                          className="flex-1"
                        />
                        <Input
                          type="number"
                          value={field.value}
                          onChange={(e) => field.onChange(Number(e.target.value))}
                          className="w-20"
                        />
                        <span>%</span>
                      </div>
                    </FormControl>
                    <FormDescription>
                      –û—Ç 1% –¥–æ 100%
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />
              
              {/* Level Filter */}
              <FormField
                control={form.control}
                name="levelIds"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>–£—Ä–æ–≤–Ω–∏ –≥–æ—Å—Ç–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</FormLabel>
                    <FormControl>
                      <MultiSelect
                        options={levels.map(l => ({ 
                          value: l.id, 
                          label: l.name 
                        }))}
                        value={field.value}
                        onChange={field.onChange}
                        placeholder="–í—Å–µ —É—Ä–æ–≤–Ω–∏"
                      />
                    </FormControl>
                    <FormDescription>
                      –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–æ –≤—Å–µ–º —É—Ä–æ–≤–Ω—è–º
                    </FormDescription>
                  </FormItem>
                )}
              />
              
              {/* Conditions */}
              <div className="space-y-4">
                <h3 className="font-medium">–£—Å–ª–æ–≤–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è</h3>
                
                <ConditionsBuilder
                  value={form.watch('conditions')}
                  onChange={(conditions) => form.setValue('conditions', conditions)}
                />
              </div>
              
              {/* Submit */}
              <div className="flex gap-2">
                <Button type="submit" disabled={createRule.isLoading}>
                  {createRule.isLoading ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : '–°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ'}
                </Button>
                <Button type="button" variant="outline" asChild>
                  <Link href="/loyalty/rules">–û—Ç–º–µ–Ω–∞</Link>
                </Button>
              </div>
            </form>
          </Form>
        </CardContent>
      </Card>
      
      {/* RIGHT: Live Preview */}
      <div className="sticky top-6 space-y-6">
        <RuleLivePreview rule={formValues} />
      </div>
    </div>
  );
}
```

**Live Preview Component:**

```typescript
// components/loyalty/rule-live-preview.tsx
export function RuleLivePreview({ rule }: { rule: RuleFormData }) {
  const exampleCheck = 2000; // 2,000‚ÇΩ
  
  const calculateEarned = () => {
    return Math.floor(exampleCheck * (rule.earnPercent / 100));
  };
  
  return (
    <Card>
      <CardHeader>
        <CardTitle>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</CardTitle>
        <CardDescription>
          –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≥–æ—Å—Ç—è
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Example Check */}
        <div>
          <h4 className="text-sm font-medium mb-2">–ü—Ä–∏–º–µ—Ä —á–µ–∫–∞</h4>
          <div className="rounded-lg border p-4 bg-muted/50">
            <div className="flex justify-between text-lg font-semibold">
              <span>–°—É–º–º–∞ —á–µ–∫–∞:</span>
              <span>{formatCurrency(exampleCheck)}</span>
            </div>
          </div>
        </div>
        
        {/* Calculation */}
        <div>
          <h4 className="text-sm font-medium mb-2">–†–∞—Å—á—ë—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</h4>
          <div className="space-y-2 text-sm">
            <div className="flex justify-between">
              <span className="text-muted-foreground">
                –ü—Ä–æ—Ü–µ–Ω—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è:
              </span>
              <span className="font-mono">{rule.earnPercent}%</span>
            </div>
            <Separator />
            <div className="flex justify-between font-semibold">
              <span>–ë—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ:</span>
              <span className="text-primary">
                {calculateEarned()} –±–∞–ª–ª–æ–≤
              </span>
            </div>
          </div>
        </div>
        
        {/* Conditions Summary */}
        {rule.conditions && Object.keys(rule.conditions).length > 0 && (
          <div>
            <h4 className="text-sm font-medium mb-2">–£—Å–ª–æ–≤–∏—è</h4>
            <div className="space-y-2">
              {rule.conditions.daysOfWeek && (
                <div className="flex items-start gap-2 text-sm">
                  <Calendar className="h-4 w-4 mt-0.5 text-muted-foreground" />
                  <span>
                    –î–Ω–∏ –Ω–µ–¥–µ–ª–∏: {formatDaysOfWeek(rule.conditions.daysOfWeek)}
                  </span>
                </div>
              )}
              
              {rule.conditions.timeRange && (
                <div className="flex items-start gap-2 text-sm">
                  <Clock className="h-4 w-4 mt-0.5 text-muted-foreground" />
                  <span>
                    –í—Ä–µ–º—è: {rule.conditions.timeRange.from} - {rule.conditions.timeRange.to}
                  </span>
                </div>
              )}
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```


***

### 3.2. Conditions Builder

**‚úÖ –†–ï–®–ï–ù–ò–ï: Tag-based —É—Å–ª–æ–≤–∏—è + AND/OR –ª–æ–≥–∏–∫–∞**

**Component:**

```typescript
// components/loyalty/conditions-builder.tsx
export function ConditionsBuilder({ value, onChange }: ConditionsBuilderProps) {
  const [conditions, setConditions] = React.useState<Condition[]>(value ?? []);
  
  const addCondition = (type: ConditionType) => {
    const newCondition = createDefaultCondition(type);
    setConditions([...conditions, newCondition]);
    onChange([...conditions, newCondition]);
  };
  
  const removeCondition = (index: number) => {
    const updated = conditions.filter((_, i) => i !== index);
    setConditions(updated);
    onChange(updated);
  };
  
  const updateCondition = (index: number, data: Partial<Condition>) => {
    const updated = conditions.map((c, i) =>
      i === index ? { ...c, ...data } : c
    );
    setConditions(updated);
    onChange(updated);
  };
  
  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <span className="text-sm font-medium">–ü—Ä–∏–º–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª–æ –∫–æ–≥–¥–∞:</span>
        
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="outline" size="sm">
              <Plus className="h-4 w-4 mr-2" />
              –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–∏–µ
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent>
            <DropdownMenuItem onClick={() => addCondition('guest_level')}>
              –£—Ä–æ–≤–µ–Ω—å –≥–æ—Å—Ç—è
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => addCondition('day_of_week')}>
              –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => addCondition('time_range')}>
              –í—Ä–µ–º—è –¥–Ω—è
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => addCondition('item_category')}>
              –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => addCondition('min_amount')}>
              –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </div>
      
      {conditions.length > 0 && (
        <div className="space-y-3 rounded-lg border p-4">
          {conditions.map((condition, index) => (
            <React.Fragment key={index}>
              <ConditionItem
                condition={condition}
                onChange={(data) => updateCondition(index, data)}
                onRemove={() => removeCondition(index)}
              />
              
              {index < conditions.length - 1 && (
                <div className="flex items-center justify-center">
                  <Select
                    value={condition.operator ?? 'AND'}
                    onValueChange={(value) =>
                      updateCondition(index, { operator: value as 'AND' | 'OR' })
                    }
                  >
                    <SelectTrigger className="w-24">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="AND">–ò</SelectItem>
                      <SelectItem value="OR">–ò–õ–ò</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              )}
            </React.Fragment>
          ))}
        </div>
      )}
      
      {conditions.length === 0 && (
        <div className="text-sm text-muted-foreground text-center py-4">
          –£—Å–ª–æ–≤–∏—è –Ω–µ –∑–∞–¥–∞–Ω—ã. –ü—Ä–∞–≤–∏–ª–æ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –∫–æ –≤—Å–µ–º —á–µ–∫–∞–º.
        </div>
      )}
    </div>
  );
}

function ConditionItem({ condition, onChange, onRemove }) {
  switch (condition.type) {
    case 'guest_level':
      return (
        <div className="flex items-center gap-2">
          <span className="text-sm">–£—Ä–æ–≤–µ–Ω—å –≥–æ—Å—Ç—è:</span>
          <MultiSelect
            options={levels}
            value={condition.value}
            onChange={(value) => onChange({ value })}
          />
          <Button variant="ghost" size="icon" onClick={onRemove}>
            <X className="h-4 w-4" />
          </Button>
        </div>
      );
    
    case 'day_of_week':
      return (
        <div className="flex items-center gap-2">
          <span className="text-sm">–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏:</span>
          <div className="flex gap-1">
            {['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].map((day, index) => (
              <Toggle
                key={index}
                pressed={condition.value?.includes(index)}
                onPressedChange={(pressed) => {
                  const updated = pressed
                    ? [...(condition.value ?? []), index]
                    : condition.value.filter(d => d !== index);
                  onChange({ value: updated });
                }}
              >
                {day}
              </Toggle>
            ))}
          </div>
          <Button variant="ghost" size="icon" onClick={onRemove}>
            <X className="h-4 w-4" />
          </Button>
        </div>
      );
    
    case 'time_range':
      return (
        <div className="flex items-center gap-2">
          <span className="text-sm">–í—Ä–µ–º—è:</span>
          <Input
            type="time"
            value={condition.value?.from ?? '00:00'}
            onChange={(e) => onChange({ 
              value: { ...condition.value, from: e.target.value }
            })}
            className="w-32"
          />
          <span>-</span>
          <Input
            type="time"
            value={condition.value?.to ?? '23:59'}
            onChange={(e) => onChange({ 
              value: { ...condition.value, to: e.target.value }
            })}
            className="w-32"
          />
          <Button variant="ghost" size="icon" onClick={onRemove}>
            <X className="h-4 w-4" />
          </Button>
        </div>
      );
    
    // ... –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã —É—Å–ª–æ–≤–∏–π
  }
}
```


***

### 3.3. Priority Rules (Drag \& Drop)

**‚úÖ –†–ï–®–ï–ù–ò–ï: @dnd-kit/sortable**

**Dependencies:**

```json
{
  "dependencies": {
    "@dnd-kit/core": "^6.1.0",
    "@dnd-kit/sortable": "^8.0.0"
  }
}
```

**Component:**

```typescript
// app/(dashboard)/loyalty/rules/page.tsx
'use client';

import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
} from '@dnd-kit/core';
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  useSortable,
  verticalListSortingStrategy,
} from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

function SortableRuleItem({ rule }) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
  } = useSortable({ id: rule.id });
  
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };
  
  return (
    <div
      ref={setNodeRef}
      style={style}
      className="flex items-center gap-4 rounded-lg border p-4 bg-background"
    >
      {/* Drag Handle */}
      <button
        {...attributes}
        {...listeners}
        className="cursor-grab active:cursor-grabbing"
      >
        <GripVertical className="h-5 w-5 text-muted-foreground" />
      </button>
      
      {/* Priority Badge */}
      <Badge variant="secondary">#{rule.priority}</Badge>
      
      {/* Rule Info */}
      <div className="flex-1">
        <div className="font-medium">{rule.name}</div>
        <div className="text-sm text-muted-foreground">
          {rule.earnPercent}% –∫–µ—à–±—ç–∫
        </div>
      </div>
      
      {/* Status */}
      <Badge variant={rule.isActive ? 'success' : 'secondary'}>
        {rule.isActive ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–æ'}
      </Badge>
      
      {/* Actions */}
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="ghost" size="icon">
            <MoreHorizontal className="h-4 w-4" />
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent>
          <DropdownMenuItem asChild>
            <Link href={`/loyalty/rules/${rule.id}/edit`}>
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </Link>
          </DropdownMenuItem>
          <DropdownMenuItem onClick={() => toggleRuleStatus(rule.id)}>
            {rule.isActive ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
          </DropdownMenuItem>
          <DropdownMenuSeparator />
          <DropdownMenuItem className="text-destructive">
            –£–¥–∞–ª–∏—Ç—å
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>
    </div>
  );
}

export default function RulesPage() {
  const { data: rules, refetch } = useRules();
  const updatePriority = useUpdateRulePriority();
  
  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );
  
  const handleDragEnd = (event) => {
    const { active, over } = event;
    
    if (active.id !== over.id) {
      const oldIndex = rules.findIndex((r) => r.id === active.id);
      const newIndex = rules.findIndex((r) => r.id === over.id);
      
      const reordered = arrayMove(rules, oldIndex, newIndex);
      
      // Update priority in backend
      updatePriority.mutate({
        ruleId: active.id,
        newPriority: newIndex + 1,
      }, {
        onSuccess: () => refetch(),
      });
    }
  };
  
  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">–ü—Ä–∞–≤–∏–ª–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</h1>
          <p className="text-muted-foreground">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤
          </p>
        </div>
        <Button asChild>
          <Link href="/loyalty/rules/create">
            <Plus className="h-4 w-4 mr-2" />
            –°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ
          </Link>
        </Button>
      </div>
      
      <Alert>
        <Info className="h-4 w-4" />
        <AlertDescription>
          –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞. –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞.
        </AlertDescription>
      </Alert>
      
      <DndContext
        sensors={sensors}
        collisionDetection={closestCenter}
        onDragEnd={handleDragEnd}
      >
        <SortableContext
          items={rules?.map(r => r.id) ?? []}
          strategy={verticalListSortingStrategy}
        >
          <div className="space-y-2">
            {rules?.map((rule) => (
              <SortableRuleItem key={rule.id} rule={rule} />
            ))}
          </div>
        </SortableContext>
      </DndContext>
    </div>
  );
}
```


***

### 3.4. Levels Builder (Visual Timeline)

**‚úÖ –†–ï–®–ï–ù–ò–ï: Visual Timeline + Form**

**Component:**

```typescript
// components/loyalty/level-timeline.tsx
export function LevelTimeline({ levels }: { levels: LoyaltyLevel[] }) {
  const sortedLevels = [...levels].sort((a, b) => a.threshold - b.threshold);
  const maxThreshold = Math.max(...sortedLevels.map(l => l.threshold)) * 1.2;
  
  return (
    <div className="relative">
      {/* Timeline Line */}
      <div className="absolute top-8 left-0 right-0 h-1 bg-muted" />
      
      {/* Level Markers */}
      <div className="relative flex justify-between">
        {sortedLevels.map((level, index) => {
          const position = (level.threshold / maxThreshold) * 100;
          
          return (
            <div
              key={level.id}
              className="flex flex-col items-center"
              style={{ 
                position: 'absolute',
                left: `${position}%`,
                transform: 'translateX(-50%)',
              }}
            >
              {/* Marker */}
              <div
                className="w-4 h-4 rounded-full border-4 bg-background z-10"
                style={{ borderColor: level.color }}
              />
              
              {/* Level Info */}
              <div className="mt-4 text-center">
                <div 
                  className="text-2xl mb-1"
                  style={{ color: level.color }}
                >
                  {level.icon}
                </div>
                <div className="font-semibold">{level.name}</div>
                <div className="text-sm text-muted-foreground">
                  {level.earnPercent}% –∫–µ—à–±—ç–∫
                </div>
                <div className="text-xs text-muted-foreground mt-1">
                  –æ—Ç {formatCurrency(level.threshold)}
                </div>
              </div>
              
              {/* Actions */}
              <div className="mt-2 flex gap-1">
                <Button 
                  variant="outline" 
                  size="sm"
                  onClick={() => openEditModal(level)}
                >
                  <Edit className="h-3 w-3" />
                </Button>
                {index > 0 && (
                  <Button 
                    variant="outline" 
                    size="sm"
                    onClick={() => openDeleteModal(level)}
                  >
                    <Trash className="h-3 w-3" />
                  </Button>
                )}
              </div>
            </div>
          );
        })}
        
        {/* Add Next Level */}
        <div
          className="flex flex-col items-center"
          style={{ 
            position: 'absolute',
            left: '100%',
            transform: 'translateX(-50%)',
          }}
        >
          <Button
            variant="dashed"
            className="w-12 h-12 rounded-full"
            onClick={() => openCreateModal()}
          >
            <Plus className="h-6 w-6" />
          </Button>
          <div className="mt-4 text-sm text-muted-foreground">
            –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å?
          </div>
        </div>
      </div>
    </div>
  );
}
```

**Edit Level Modal:**

```typescript
// components/loyalty/level-edit-modal.tsx
export function LevelEditModal({ level, open, onClose }: LevelEditModalProps) {
  const form = useForm<LevelFormData>({
    resolver: zodResolver(levelSchema),
    defaultValues: level ?? {
      name: '',
      threshold: 0,
      earnPercent: 10,
      color: '#C0C0C0',
      icon: 'ü•à',
      benefits: [],
    },
  });
  
  const updateLevel = useUpdateLevel();
  
  const onSubmit = (data: LevelFormData) => {
    updateLevel.mutate({ id: level.id, ...data }, {
      onSuccess: () => {
        toast.success('–£—Ä–æ–≤–µ–Ω—å –æ–±–Ω–æ–≤–ª—ë–Ω!');
        onClose();
      },
    });
  };
  
  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>
            {level ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å' : '–°–æ–∑–¥–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å'}
          </DialogTitle>
        </DialogHeader>
        
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="name"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>–ù–∞–∑–≤–∞–Ω–∏–µ</FormLabel>
                    <FormControl>
                      <Input placeholder="Silver" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              
              <FormField
                control={form.control}
                name="threshold"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>–ü–æ—Ä–æ–≥ (‚ÇΩ)</FormLabel>
                    <FormControl>
                      <Input 
                        type="number" 
                        placeholder="150000" 
                        {...field}
                        onChange={(e) => field.onChange(Number(e.target.value))}
                      />
                    </FormControl>
                    <FormDescription>
                      Lifetime Spent –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
            
            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="earnPercent"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>–ë–æ–Ω—É—Å –∫ –∫–µ—à–±—ç–∫—É</FormLabel>
                    <FormControl>
                      <div className="flex items-center gap-2">
                        <Input 
                          type="number" 
                          {...field}
                          onChange={(e) => field.onChange(Number(e.target.value))}
                        />
                        <span>%</span>
                      </div>
                    </FormControl>
                    <FormDescription>
                      –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∫ –±–∞–∑–æ–≤–æ–º—É –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />
              
              <FormField
                control={form.control}
                name="color"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>–¶–≤–µ—Ç</FormLabel>
                    <FormControl>
                      <div className="flex gap-2">
                        <Input type="color" {...field} className="w-16" />
                        <Input {...field} placeholder="#C0C0C0" />
                      </div>
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
            
            <FormField
              control={form.control}
              name="icon"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>–ò–∫–æ–Ω–∫–∞ (emoji)</FormLabel>
                  <FormControl>
                    <Input placeholder="ü•à" {...field} maxLength={2} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            
            <FormField
              control={form.control}
              name="benefits"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="‚Ä¢ +2% –∫–µ—à–±—ç–∫&#10;‚Ä¢ –ë–æ–Ω—É—Å –Ω–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è 500 –±–∞–ª–ª–æ–≤"
                      {...field}
                      value={field.value?.join('\n')}
                      onChange={(e) => field.onChange(e.target.value.split('\n'))}
                      rows={4}
                    />
                  </FormControl>
                  <FormDescription>
                    –ö–∞–∂–¥–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />
            
            <DialogFooter>
              <Button type="button" variant="outline" onClick={onClose}>
                –û—Ç–º–µ–Ω–∞
              </Button>
              <Button type="submit" disabled={updateLevel.isLoading}>
                {updateLevel.isLoading ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```


***

### 3.5. Promo Campaigns Builder (Wizard)

**‚úÖ –†–ï–®–ï–ù–ò–ï: Wizard-style (—à–∞–≥–∏) + –ü–æ–ª–Ω–∞—è –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è**

**Component:**

```typescript
// app/(dashboard)/loyalty/promos/create/page.tsx
'use client';

export default function CreatePromoPage() {
  const [step, setStep] = React.useState(1);
  const [formData, setFormData] = React.useState<PromoFormData>({});
  
  const steps = [
    { number: 1, title: '–¢–∏–ø –ø—Ä–æ–º–æ', component: StepType },
    { number: 2, title: '–¢—Ä–∏–≥–≥–µ—Ä', component: StepTrigger },
    { number: 3, title: '–ù–∞–≥—Ä–∞–¥–∞', component: StepReward },
    { number: 4, title: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', component: StepSettings },
    { number: 5, title: '–ü—Ä–æ–≤–µ—Ä–∫–∞', component: StepReview },
  ];
  
  const currentStepComponent = steps[step - 1].component;
  
  return (
    <div className="max-w-4xl mx-auto space-y-8">
      {/* Stepper */}
      <div className="flex items-center justify-between">
        {steps.map((s, index) => (
          <React.Fragment key={s.number}>
            <div
              className={cn(
                'flex flex-col items-center gap-2',
                step >= s.number ? 'text-primary' : 'text-muted-foreground'
              )}
            >
              <div
                className={cn(
                  'flex h-10 w-10 items-center justify-center rounded-full border-2',
                  step >= s.number
                    ? 'border-primary bg-primary text-primary-foreground'
                    : 'border-muted'
                )}
              >
                {step > s.number ? (
                  <Check className="h-5 w-5" />
                ) : (
                  s.number
                )}
              </div>
              <span className="text-xs font-medium">{s.title}</span>
            </div>
            
            {index < steps.length - 1 && (
              <div
                className={cn(
                  'flex-1 h-0.5',
                  step > s.number ? 'bg-primary' : 'bg-muted'
                )}
              />
            )}
          </React.Fragment>
        ))}
      </div>
      
      {/* Step Content */}
      <Card>
        <CardHeader>
          <CardTitle>{steps[step - 1].title}</CardTitle>
        </CardHeader>
        <CardContent>
          {React.createElement(currentStepComponent, {
            data: formData,
            onChange: setFormData,
          })}
        </CardContent>
        <CardFooter className="flex justify-between">
          <Button
            variant="outline"
            onClick={() => setStep(step - 1)}
            disabled={step === 1}
          >
            <ChevronLeft className="h-4 w-4 mr-2" />
            –ù–∞–∑–∞–¥
          </Button>
          
          {step < steps.length ? (
            <Button onClick={() => setStep(step + 1)}>
              –î–∞–ª–µ–µ
              <ChevronRight className="h-4 w-4 ml-2" />
            </Button>
          ) : (
            <Button onClick={() => createPromo(formData)}>
              –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ
            </Button>
          )}
        </CardFooter>
      </Card>
    </div>
  );
}
```

**Step 1: Type (—Å templates):**

```typescript
// components/loyalty/promo-wizard/step-type.tsx
function StepType({ data, onChange }: StepProps) {
  const templates = [
    {
      type: 'BIRTHDAY',
      icon: 'üéÇ',
      title: '–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è',
      description: '–ë–æ–Ω—É—Å –≤ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –≥–æ—Å—Ç—è',
      defaults: {
        triggerType: 'BIRTHDAY',
        rewardType: 'BONUS_POINTS',
        rewardValue: 500,
        expirationDays: 7,
      },
    },
    {
      type: 'FIRST_VISIT',
      icon: 'üéâ',
      title: '–ü–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç',
      description: '–ë–æ–Ω—É—Å –∑–∞ –ø–µ—Ä–≤—ã–π —á–µ–∫',
      defaults: {
        triggerType: 'FIRST_VISIT',
        rewardType: 'CASHBACK_BONUS',
        rewardValue: 20,
        oneTimePerGuest: true,
      },
    },
    {
      type: 'INACTIVITY',
      icon: 'üëã',
      title: 'Win-back',
      description: '–í–µ—Ä–Ω—É—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –≥–æ—Å—Ç–µ–π',
      defaults: {
        triggerType: 'INACTIVITY',
        triggerValue: 30,
        rewardType: 'BONUS_POINTS',
        rewardValue: 300,
        expirationDays: 14,
      },
    },
    {
      type: 'CHILD_BIRTHDAY',
      icon: 'üéà',
      title: '–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Ä–µ–±—ë–Ω–∫–∞',
      description: '–ë–æ–Ω—É—Å –Ω–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –¥–µ—Ç–µ–π –≥–æ—Å—Ç—è',
      defaults: {
        triggerType: 'CHILD_BIRTHDAY',
        rewardType: 'BONUS_POINTS',
        rewardValue: 300,
        expirationDays: 7,
      },
    },
    {
      type: 'CUSTOM',
      icon: '‚öôÔ∏è',
      title: '–ö–∞—Å—Ç–æ–º–Ω–æ–µ –ø—Ä–æ–º–æ',
      description: '–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Å—ë –≤—Ä—É—á–Ω—É—é',
      defaults: {},
    },
  ];
  
  return (
    <div className="grid grid-cols-2 gap-4">
      {templates.map((template) => (
        <Card
          key={template.type}
          className={cn(
            'cursor-pointer transition-all hover:border-primary',
            data.type === template.type && 'border-primary ring-2 ring-primary'
          )}
          onClick={() => onChange({ ...data, ...template.defaults, type: template.type })}
        >
          <CardHeader>
            <div className="text-4xl mb-2">{template.icon}</div>
            <CardTitle className="text-lg">{template.title}</CardTitle>
            <CardDescription>{template.description}</CardDescription>
          </CardHeader>
        </Card>
      ))}
    </div>
  );
}
```

**Step 2: Trigger (–ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä—É–µ–º—ã–π):**

```typescript
// components/loyalty/promo-wizard/step-trigger.tsx
function StepTrigger({ data, onChange }: StepProps) {
  return (
    <div className="space-y-6">
      <div>
        <Label>–ö–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ?</Label>
        <Select
          value={data.triggerType}
          onValueChange={(value) => onChange({ ...data, triggerType: value })}
        >
          <SelectTrigger>
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="BIRTHDAY">–í –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –≥–æ—Å—Ç—è</SelectItem>
            <SelectItem value="BIRTHDAY_WEEK">–í –Ω–µ–¥–µ–ª—é –¥–Ω—è —Ä–æ–∂–¥–µ–Ω–∏—è</SelectItem>
            <SelectItem value="DAYS_BEFORE_BIRTHDAY">–ó–∞ N –¥–Ω–µ–π –¥–æ –¥–Ω—è —Ä–æ–∂–¥–µ–Ω–∏—è</SelectItem>
            <SelectItem value="CHILD_BIRTHDAY">–í –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Ä–µ–±—ë–Ω–∫–∞</SelectItem>
            <SelectItem value="FIRST_VISIT">–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∏–∑–∏—Ç–µ</SelectItem>
            <SelectItem value="NTH_VISIT">–ü—Ä–∏ N-–æ–º –≤–∏–∑–∏—Ç–µ</SelectItem>
            <SelectItem value="INACTIVITY">–ü–æ—Å–ª–µ N –¥–Ω–µ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</SelectItem>
            <SelectItem value="SPECIFIC_DATES">–í –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã</SelectItem>
            <SelectItem value="DAY_OF_WEEK">–í –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏</SelectItem>
          </SelectContent>
        </Select>
      </div>
      
      {/* Dynamic fields based on triggerType */}
      {data.triggerType === 'DAYS_BEFORE_BIRTHDAY' && (
        <div>
          <Label>–ó–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–æ –¥–Ω—è —Ä–æ–∂–¥–µ–Ω–∏—è?</Label>
          <Input
            type="number"
            value={data.triggerValue ?? 7}
            onChange={(e) => onChange({ ...data, triggerValue: Number(e.target.value) })}
          />
        </div>
      )}
      
      {data.triggerType === 'INACTIVITY' && (
        <div>
          <Label>–î–Ω–µ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</Label>
          <Input
            type="number"
            value={data.triggerValue ?? 30}
            onChange={(e) => onChange({ ...data, triggerValue: Number(e.target.value) })}
          />
          <p className="text-sm text-muted-foreground mt-1">
            –ü—Ä–æ–º–æ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑–∏—Ç–æ–≤
          </p>
        </div>
      )}
      
      {data.triggerType === 'SPECIFIC_DATES' && (
        <div>
          <Label>–ü–µ—Ä–∏–æ–¥ –¥–µ–π—Å—Ç–≤–∏—è</Label>
          <DateRangePicker
            value={data.dateRange}
            onChange={(range) => onChange({ ...data, dateRange: range })}
          />
        </div>
      )}
      
      {data.triggerType === 'DAY_OF_WEEK' && (
        <div>
          <Label>–î–Ω–∏ –Ω–µ–¥–µ–ª–∏</Label>
          <div className="flex gap-2 mt-2">
            {['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].map((day, index) => (
              <Toggle
                key={index}
                pressed={data.daysOfWeek?.includes(index)}
                onPressedChange={(pressed) => {
                  const updated = pressed
                    ? [...(data.daysOfWeek ?? []), index]
                    : data.daysOfWeek?.filter(d => d !== index);
                  onChange({ ...data, daysOfWeek: updated });
                }}
              >
                {day}
              </Toggle>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}
```

**Step 3: Reward (–ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä—É–µ–º—ã–π):**

```typescript
// components/loyalty/promo-wizard/step-reward.tsx
function StepReward({ data, onChange }: StepProps) {
  return (
    <div className="space-y-6">
      <div>
        <Label>–¢–∏–ø –Ω–∞–≥—Ä–∞–¥—ã</Label>
        <Select
          value={data.rewardType}
          onValueChange={(value) => onChange({ ...data, rewardType: value })}
        >
          <SelectTrigger>
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="BONUS_POINTS">–ë–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã</SelectItem>
            <SelectItem value="CASHBACK_BONUS">–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –∫–µ—à–±—ç–∫ (%)</SelectItem>
            <SelectItem value="DISCOUNT">–°–∫–∏–¥–∫–∞ (%)</SelectItem>
            <SelectItem value="FREE_ITEM">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä</SelectItem>
            <SelectItem value="MULTIPLIER">–ú–Ω–æ–∂–∏—Ç–µ–ª—å –±–∞–ª–ª–æ–≤ (x2, x3)</SelectItem>
          </SelectContent>
        </Select>
      </div>
      
      {data.rewardType === 'BONUS_POINTS' && (
        <div>
          <Label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤</Label>
          <Input
            type="number"
            value={data.rewardValue ?? 500}
            onChange={(e) => onChange({ ...data, rewardValue: Number(e.target.value) })}
          />
        </div>
      )}
      
      {data.rewardType === 'CASHBACK_BONUS' && (
        <div>
          <Label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –∫–µ—à–±—ç–∫–∞</Label>
          <div className="flex items-center gap-2">
            <Input
              type="number"
              value={data.rewardValue ?? 10}
              onChange={(e) => onChange({ ...data, rewardValue: Number(e.target.value) })}
            />
            <span>%</span>
          </div>
          <p className="text-sm text-muted-foreground mt-1">
            –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ –±–∞–∑–æ–≤–æ–º—É –∫–µ—à–±—ç–∫—É
          </p>
        </div>
      )}
      
      {data.rewardType === 'DISCOUNT' && (
        <div>
          <Label>–†–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏</Label>
          <div className="flex items-center gap-2">
            <Input
              type="number"
              value={data.rewardValue ?? 15}
              onChange={(e) => onChange({ ...data, rewardValue: Number(e.target.value) })}
            />
            <span>%</span>
          </div>
        </div>
      )}
      
      {data.rewardType === 'MULTIPLIER' && (
        <div>
          <Label>–ú–Ω–æ–∂–∏—Ç–µ–ª—å</Label>
          <Select
            value={String(data.rewardValue ?? 2)}
            onValueChange={(value) => onChange({ ...data, rewardValue: Number(value) })}
          >
            <SelectTrigger>
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="2">x2 (–¥–≤–æ–π–Ω—ã–µ –±–∞–ª–ª—ã)</SelectItem>
              <SelectItem value="3">x3 (—Ç—Ä–æ–π–Ω—ã–µ –±–∞–ª–ª—ã)</SelectItem>
              <SelectItem value="5">x5 (–ø—è—Ç–∏–∫—Ä–∞—Ç–Ω—ã–µ –±–∞–ª–ª—ã)</SelectItem>
            </SelectContent>
          </Select>
        </div>
      )}
      
      <Separator />
      
      <div>
        <Label>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞–≥—Ä–∞–¥—ã</Label>
        <div className="flex items-center gap-2">
          <Input
            type="number"
            value={data.expirationDays ?? 14}
            onChange={(e) => onChange({ ...data, expirationDays: Number(e.target.value) })}
          />
          <span>–¥–Ω–µ–π</span>
        </div>
        <p className="text-sm text-muted-foreground mt-1">
          –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —Å–≥–æ—Ä–∏—Ç –Ω–∞–≥—Ä–∞–¥–∞ (0 = –Ω–∏–∫–æ–≥–¥–∞)
        </p>
      </div>
    </div>
  );
}
```

**Step 4: Settings:**

```typescript
// components/loyalty/promo-wizard/step-settings.tsx
function StepSettings({ data, onChange }: StepProps) {
  return (
    <div className="space-y-6">
      <div>
        <Label htmlFor="name">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ</Label>
        <Input
          id="name"
          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–æ–Ω—É—Å –Ω–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è"
          value={data.name ?? ''}
          onChange={(e) => onChange({ ...data, name: e.target.value })}
        />
      </div>
      
      <div>
        <Label htmlFor="description">–û–ø–∏—Å–∞–Ω–∏–µ</Label>
        <Textarea
          id="description"
          placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥–æ—Å—Ç–µ–π..."
          value={data.description ?? ''}
          onChange={(e) => onChange({ ...data, description: e.target.value })}
          rows={3}
        />
      </div>
      
      <Separator />
      
      <div className="space-y-4">
        <div className="flex items-center justify-between">
          <div className="space-y-0.5">
            <Label>–û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</Label>
            <p className="text-sm text-muted-foreground">
              –û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ –ø—Ä–æ–º–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Å—Ç—è
            </p>
          </div>
          <Switch
            checked={data.oneTimePerGuest ?? false}
            onCheckedChange={(checked) => onChange({ ...data, oneTimePerGuest: checked })}
          />
        </div>
        
        <div className="flex items-center justify-between">
          <div className="space-y-0.5">
            <Label>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è</Label>
            <p className="text-sm text-muted-foreground">
              –ü—Ä–∏–º–µ–Ω—è—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–±–ª—é–¥–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏–π
            </p>
          </div>
          <Switch
            checked={data.autoApply ?? true}
            onCheckedChange={(checked) => onChange({ ...data, autoApply: checked })}
          />
        </div>
        
        <div className="flex items-center justify-between">
          <div className="space-y-0.5">
            <Label>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</Label>
            <p className="text-sm text-muted-foreground">
              –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
            </p>
          </div>
          <Switch
            checked={data.notifyGuest ?? true}
            onCheckedChange={(checked) => onChange({ ...data, notifyGuest: checked })}
          />
        </div>
      </div>
      
      <Separator />
      
      <div>
        <Label>–ö–∞–Ω–∞–ª—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</Label>
        <div className="flex gap-4 mt-2">
          <div className="flex items-center gap-2">
            <Checkbox
              id="telegram"
              checked={data.channels?.includes('TELEGRAM')}
              onCheckedChange={(checked) => {
                const updated = checked
                  ? [...(data.channels ?? []), 'TELEGRAM']
                  : data.channels?.filter(c => c !== 'TELEGRAM');
                onChange({ ...data, channels: updated });
              }}
            />
            <Label htmlFor="telegram">Telegram</Label>
          </div>
          
          <div className="flex items-center gap-2">
            <Checkbox
              id="email"
              checked={data.channels?.includes('EMAIL')}
              onCheckedChange={(checked) => {
                const updated = checked
                  ? [...(data.channels ?? []), 'EMAIL']
                  : data.channels?.filter(c => c !== 'EMAIL');
                onChange({ ...data, channels: updated });
              }}
            />
            <Label htmlFor="email">Email</Label>
          </div>
          
          <div className="flex items-center gap-2">
            <Checkbox
              id="sms"
              checked={data.channels?.includes('SMS')}
              onCheckedChange={(checked) => {
                const updated = checked
                  ? [...(data.channels ?? []), 'SMS']
                  : data.channels?.filter(c => c !== 'SMS');
                onChange({ ...data, channels: updated });
              }}
            />
            <Label htmlFor="sms">SMS</Label>
          </div>
        </div>
      </div>
    </div>
  );
}
```

**Step 5: Review:**

```typescript
// components/loyalty/promo-wizard/step-review.tsx
function StepReview({ data }: StepProps) {
  return (
    <div className="space-y-6">
      <Alert>
        <Info className="h-4 w-4" />
        <AlertDescription>
          –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–º–æ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º
        </AlertDescription>
      </Alert>
      
      <div className="rounded-lg border p-6 space-y-4">
        <div>
          <h3 className="font-semibold mb-1">{data.name}</h3>
          <p className="text-sm text-muted-foreground">{data.description}</p>
        </div>
        
        <Separator />
        
        <div className="grid grid-cols-2 gap-4 text-sm">
          <div>
            <span className="text-muted-foreground">–¢–∏–ø:</span>
            <p className="font-medium">{getTypeLabel(data.type)}</p>
          </div>
          
          <div>
            <span className="text-muted-foreground">–¢—Ä–∏–≥–≥–µ—Ä:</span>
            <p className="font-medium">{getTriggerLabel(data.triggerType, data.triggerValue)}</p>
          </div>
          
          <div>
            <span className="text-muted-foreground">–ù–∞–≥—Ä–∞–¥–∞:</span>
            <p className="font-medium">{getRewardLabel(data.rewardType, data.rewardValue)}</p>
          </div>
          
          <div>
            <span className="text-muted-foreground">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</span>
            <p className="font-medium">
              {data.expirationDays > 0 ? `${data.expirationDays} –¥–Ω–µ–π` : '–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π'}
            </p>
          </div>
          
          <div>
            <span className="text-muted-foreground">–û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ:</span>
            <p className="font-medium">{data.oneTimePerGuest ? '–î–∞' : '–ù–µ—Ç'}</p>
          </div>
          
          <div>
            <span className="text-muted-foreground">–ö–∞–Ω–∞–ª—ã:</span>
            <p className="font-medium">{data.channels?.join(', ') ?? '–ù–µ –≤—ã–±—Ä–∞–Ω—ã'}</p>
          </div>
        </div>
      </div>
    </div>
  );
}
```


***

## üìä **4. ANALYTICS \& DASHBOARDS**

### 4.1. Owner Dashboard

**‚úÖ –†–ï–®–ï–ù–ò–ï:**

**Page:**

```typescript
// app/(dashboard)/page.tsx (Owner view)
'use client';

export default function OwnerDashboardPage() {
  const { data: platformStats } = usePlatformStats();
  
  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ MaxLoyalty</h1>
        <p className="text-muted-foreground">
          –û–±–∑–æ—Ä –≤—Å–µ—Ö tenant'–æ–≤ –∏ –º–µ—Ç—Ä–∏–∫
        </p>
      </div>
      
      {/* KPI Cards */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">MRR</CardTitle>
            <DollarSign className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {formatCurrency(platformStats?.mrr ?? 0)}
            </div>
            <p className="text-xs text-muted-foreground">
              <span className="text-green-600">+{platformStats?.mrrGrowth}%</span> –æ—Ç –ø—Ä–æ—à–ª–æ–≥–æ –º–µ—Å—è—Ü–∞
            </p>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">–ê–∫—Ç–∏–≤–Ω—ã–µ Tenant'—ã</CardTitle>
            <Building2 className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {platformStats?.activeTenants ?? 0}
            </div>
            <p className="text-xs text-muted-foreground">
              +{platformStats?.newTenantsThisMonth} –Ω–æ–≤—ã—Ö –∑–∞ –º–µ—Å—è—Ü
            </p>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">Churn Rate</CardTitle>
            <TrendingDown className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {platformStats?.churnRate}%
            </div>
            <p className="text-xs text-muted-foreground">
              {platformStats?.cancelledThisMonth} –æ—Ç–º–µ–Ω–µ–Ω–æ –∑–∞ –º–µ—Å—è—Ü
            </p>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">–í—Å–µ–≥–æ –ì–æ—Å—Ç–µ–π</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {formatNumber(platformStats?.totalGuests ?? 0)}
            </div>
            <p className="text-xs text-muted-foreground">
              Across all tenants
            </p>
          </CardContent>
        </Card>
      </div>
      
      {/* Charts */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-7">
        <Card className="col-span-4">
          <CardHeader>
            <CardTitle>Revenue Trend</CardTitle>
          </CardHeader>
          <CardContent>
            <RevenueChart data={platformStats?.revenueByMonth ?? []} />
          </CardContent>
        </Card>
        
        <Card className="col-span-3">
          <CardHeader>
            <CardTitle>Subscriptions by Plan</CardTitle>
          </CardHeader>
          <CardContent>
            <SubscriptionsPieChart data={platformStats?.subscriptionsByPlan ?? []} />
          </CardContent>
        </Card>
      </div>
      
      <div className="grid gap-4 md:grid-cols-2">
        <Card>
          <CardHeader>
            <CardTitle>Top Tenants by Revenue</CardTitle>
          </CardHeader>
          <CardContent>
            <TopTenantsTable data={platformStats?.topTenants ?? []} />
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader>
            <CardTitle>Churn Reasons</CardTitle>
          </CardHeader>
          <CardContent>
            <ChurnReasonsChart data={platformStats?.churnReasons ?? []} />
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
```


***

### 4.2. Restaurant Admin Dashboard

**‚úÖ –†–ï–®–ï–ù–ò–ï:**

**Page:**

```typescript
// app/(dashboard)/page.tsx (Admin view)
'use client';

export default function AdminDashboardPage() {
  const [period, setPeriod] = React.useState<DateRange>({
    from: subDays(new Date(), 30),
    to: new Date(),
  });
  
  const { data: analytics } = useRestaurantAnalytics(period);
  
  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">–î–∞—à–±–æ—Ä–¥</h1>
          <p className="text-muted-foreground">
            –û–±–∑–æ—Ä –≤–∞—à–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
          </p>
        </div>
        
        <div className="flex items-center gap-2">
          <DateRangePicker value={period} onChange={setPeriod} />
          <Button variant="outline" size="icon">
            <RefreshCw className="h-4 w-4" />
          </Button>
        </div>
      </div>
      
      {/* KPI Cards */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">–í—ã—Ä—É—á–∫–∞</CardTitle>
            <TrendingUp className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {formatCurrency(analytics?.revenue ?? 0)}
            </div>
            <p className="text-xs text-muted-foreground">
              <span className="text-green-600">+{analytics?.revenueGrowth}%</span> –æ—Ç –ø—Ä–æ—à–ª–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
            </p>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">–ì–æ—Å—Ç–∏</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {formatNumber(analytics?.totalGuests ?? 0)}
            </div>
            <p className="text-xs text-muted-foreground">
              +{analytics?.newGuests} –Ω–æ–≤—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥
            </p>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</CardTitle>
            <Receipt className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {formatCurrency(analytics?.avgCheck ?? 0)}
            </div>
            <p className="text-xs text-muted-foreground">
              <span className="text-green-600">+{analytics?.avgCheckGrowth}%</span>
            </p>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">–°–ø–∏—Å–∞–Ω–æ –±–∞–ª–ª–æ–≤</CardTitle>
            <Award className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {formatNumber(analytics?.ballsRedeemed ?? 0)}
            </div>
            <p className="text-xs text-muted-foreground">
              ROI {analytics?.loyaltyROI}x
            </p>
          </CardContent>
        </Card>
      </div>
      
      {/* Charts */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-7">
        <Card className="col-span-4">
          <CardHeader>
            <CardTitle>–í—ã—Ä—É—á–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥</CardTitle>
          </CardHeader>
          <CardContent>
            <RevenueChart data={analytics?.revenueByDay ?? []} />
          </CardContent>
        </Card>
        
        <Card className="col-span-3">
          <CardHeader>
            <CardTitle>–ì–æ—Å—Ç–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º</CardTitle>
          </CardHeader>
          <CardContent>
            <GuestsByLevelChart data={analytics?.guestsByLevel ?? []} />
          </CardContent>
        </Card>
      </div>
      
      <div className="grid gap-4 md:grid-cols-2">
        <Card>
          <CardHeader>
            <CardTitle>–¢–æ–ø –ø—Ä–æ–º–æ</CardTitle>
            <CardDescription>–ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∞–∫—Ç–∏–≤–∞—Ü–∏–π</CardDescription>
          </CardHeader>
          <CardContent>
            <TopPromosChart data={analytics?.topPromos ?? []} />
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader>
            <CardTitle>Loyalty ROI</CardTitle>
            <CardDescription>–ó–∞—Ç—Ä–∞—Ç—ã vs. —É–¥–µ—Ä–∂–∞–Ω–Ω–∞—è –≤—ã—Ä—É—á–∫–∞</CardDescription>
          </CardHeader>
          <CardContent>
            <LoyaltyROIChart data={analytics?.loyaltyROI ?? {}} />
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
```


***

### 4.3. Drill-down Details

**‚úÖ –†–ï–®–ï–ù–ò–ï: Click on chart ‚Üí Modal —Å —Ç–∞–±–ª–∏—Ü–µ–π**

**Example: Guests by Level Drill-down:**

```typescript
// components/analytics/guests-by-level-chart.tsx
'use client';

export function GuestsByLevelChart({ data }: { data: GuestsByLevel[] }) {
  const [selectedLevel, setSelectedLevel] = React.useState<string | null>(null);
  
  return (
    <>
      <ResponsiveContainer width="100%" height={300}>
        <PieChart>
          <Pie
            data={data}
            cx="50%"
            cy="50%"
            labelLine={false}
            label={renderCustomLabel}
            outerRadius={80}
            fill="#8884d8"
            dataKey="count"
            onClick={(entry) => setSelectedLevel(entry.name)}
            style={{ cursor: 'pointer' }}
          >
            {data.map((entry, index) => (
              <Cell key={`cell-${index}`} fill={entry.color} />
            ))}
          </Pie>
          <Tooltip />
          <Legend />
        </PieChart>
      </ResponsiveContainer>
      
      {/* Drill-down Modal */}
      <LevelGuestsModal
        level={selectedLevel}
        open={!!selectedLevel}
        onClose={() => setSelectedLevel(null)}
      />
    </>
  );
}

function LevelGuestsModal({ level, open, onClose }: LevelGuestsModalProps) {
  const { data: guests, isLoading } = useGuestsByLevel(level, { enabled: open });
  
  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl">
        <DialogHeader>
          <DialogTitle>–ì–æ—Å—Ç–∏ —É—Ä–æ–≤–Ω—è {level}</DialogTitle>
          <DialogDescription>
            {guests?.total ?? 0} –≥–æ—Å—Ç–µ–π
          </DialogDescription>
        </DialogHeader>
        
        <div className="space-y-4">
          {/* Filters */}
          <div className="flex gap-2">
            <Select defaultValue="active">
              <SelectTrigger className="w-[180px]">
                <SelectValue placeholder="–°—Ç–∞—Ç—É—Å" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">–í—Å–µ</SelectItem>
                <SelectItem value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</SelectItem>
                <SelectItem value="at-risk">At-Risk</SelectItem>
              </SelectContent>
            </Select>
            
            <Input placeholder="–ü–æ–∏—Å–∫..." className="flex-1" />
          </div>
          
          {/* Table */}
          {isLoading ? (
            <div className="flex items-center justify-center py-8">
              <Loader2 className="h-8 w-8 animate-spin" />
            </div>
          ) : (
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>–ò–º—è</TableHead>
                  <TableHead>–¢–µ–ª–µ—Ñ–æ–Ω</TableHead>
                  <TableHead>–ë–∞–ª–∞–Ω—Å</TableHead>
                  <TableHead>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</TableHead>
                  <TableHead>–í–∏–∑–∏—Ç—ã</TableHead>
                  <TableHead>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {guests?.items.map((guest) => (
                  <TableRow key={guest.id}>
                    <TableCell className="font-medium">
                      <Link
                        href={`/guests/${guest.id}`}
                        className="hover:underline"
                      >
                        {guest.name}
                      </Link>
                    </TableCell>
                    <TableCell>{guest.phone}</TableCell>
                    <TableCell>{guest.balance} –±–∞–ª–ª–æ–≤</TableCell>
                    <TableCell>{formatCurrency(guest.lifetimeSpent)}</TableCell>
                    <TableCell>{guest.visits}</TableCell>
                    <TableCell>{formatRelativeTime(guest.lastVisit)}</TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}
        </div>
        
        <DialogFooter>
          <Button variant="outline" asChild>
            <Link href={`/guests?level=${level}`}>
              –û—Ç–∫—Ä—ã—Ç—å –≤ –ø–æ–ª–Ω–æ–º —Å–ø–∏—Å–∫–µ
            </Link>
          </Button>
          <Button onClick={() => exportGuests(level)}>
            <Download className="h-4 w-4 mr-2" />
            –≠–∫—Å–ø–æ—Ä—Ç CSV
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```


***

### 4.4. Export Reports

**‚úÖ –†–ï–®–ï–ù–ò–ï: XLSX + CSV + PDF**

**Component:**

```typescript
// components/analytics/export-dialog.tsx
'use client';

export function ExportDialog({ open, onClose }: ExportDialogProps) {
  const [format, setFormat] = React.useState<'XLSX' | 'CSV' | 'PDF'>('XLSX');
  const [columns, setColumns] = React.useState<string[]>([
    'name',
    'phone',
    'balance',
    'level',
    'lifetimeSpent',
  ]);
  
  const exportMutation = useExportGuests();
  
  const handleExport = () => {
    exportMutation.mutate(
      { format, columns },
      {
        onSuccess: (data) => {
          toast.success('–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—á–∞—Ç! –°—Å—ã–ª–∫–∞ –ø—Ä–∏–¥—ë—Ç –Ω–∞ email —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.');
          onClose();
        },
      }
    );
  };
  
  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Å—Ç–µ–π</DialogTitle>
          <DialogDescription>
            –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
          </DialogDescription>
        </DialogHeader>
        
        <div className="space-y-4">
          {/* Format */}
          <div>
            <Label>–§–æ—Ä–º–∞—Ç</Label>
            <RadioGroup value={format} onValueChange={setFormat as any}>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="XLSX" id="xlsx" />
                <Label htmlFor="xlsx">Excel (XLSX)</Label>
              </div>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="CSV" id="csv" />
                <Label htmlFor="csv">CSV</Label>
              </div>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="PDF" id="pdf" />
                <Label htmlFor="pdf">PDF (—Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏)</Label>
              </div>
            </RadioGroup>
          </div>
          
          {/* Columns */}
          {format !== 'PDF' && (
            <div>
              <Label>–ö–æ–ª–æ–Ω–∫–∏</Label>
              <div className="grid grid-cols-2 gap-2 mt-2">
                {availableColumns.map((col) => (
                  <div key={col.value} className="flex items-center space-x-2">
                    <Checkbox
                      id={col.value}
                      checked={columns.includes(col.value)}
                      onCheckedChange={(checked) => {
                        setColumns(
                          checked
                            ? [...columns, col.value]
                            : columns.filter((c) => c !== col.value)
                        );
                      }}
                    />
                    <Label htmlFor={col.value} className="text-sm font-normal">
                      {col.label}
                    </Label>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
        
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>
            –û—Ç–º–µ–Ω–∞
          </Button>
          <Button onClick={handleExport} disabled={exportMutation.isLoading}>
            {exportMutation.isLoading ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                –≠–∫—Å–ø–æ—Ä—Ç...
              </>
            ) : (
              <>
                <Download className="h-4 w-4 mr-2" />
                –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
              </>
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

const availableColumns = [
  { value: 'name', label: '–ò–º—è' },
  { value: 'phone', label: '–¢–µ–ª–µ—Ñ–æ–Ω' },
  { value: 'email', label: 'Email' },
  { value: 'balance', label: '–ë–∞–ª–∞–Ω—Å' },
  { value: 'level', label: '–£—Ä–æ–≤–µ–Ω—å' },
  { value: 'visits', label: '–í–∏–∑–∏—Ç—ã' },
  { value: 'lifetimeSpent', label: '–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ' },
  { value: 'lastVisit', label: '–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç' },
  { value: 'registrationDate', label: '–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏' },
  { value: 'birthday', label: '–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è' },
];
```

**Backend Flow:**

```typescript
// src/export/export.service.ts
@Injectable()
export class ExportService {
  async exportGuests(dto: ExportGuestsDto, userId: string) {
    // 1. Create job
    const job = await this.queue.add('export-guests', {
      userId,
      format: dto.format,
      columns: dto.columns,
      filters: dto.filters,
    });
    
    // 2. Return job ID
    return { jobId: job.id };
  }
  
  @Process('export-guests')
  async processExport(job: Job) {
    const { userId, format, columns, filters } = job.data;
    
    // 1. Fetch data
    const guests = await this.prisma.guestProfile.findMany({
      where: filters,
      include: { guestCards: true },
    });
    
    // 2. Generate file
    let fileUrl: string;
    
    if (format === 'XLSX') {
      fileUrl = await this.generateXLSX(guests, columns);
    } else if (format === 'CSV') {
      fileUrl = await this.generateCSV(guests, columns);
    } else {
      fileUrl = await this.generatePDF(guests);
    }
    
    // 3. Send email with link
    await this.emailService.send({
      to: (await this.prisma.user.findUnique({ where: { id: userId } })).email,
      subject: '–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Å—Ç–µ–π –≥–æ—Ç–æ–≤',
      template: 'export-ready',
      data: {
        fileUrl,
        expiresAt: addDays(new Date(), 1),
      },
    });
  }
}
```


***

### 4.5. Auto-refresh

**‚úÖ –†–ï–®–ï–ù–ò–ï: TanStack Query refetchInterval + Toggle**

**Component:**

```typescript
// components/analytics/auto-refresh-toggle.tsx
'use client';

export function AutoRefreshToggle() {
  const { autoRefreshEnabled, setAutoRefreshEnabled } = useUIStore();
  const queryClient = useQueryClient();
  
  React.useEffect(() => {
    if (!autoRefreshEnabled) return;
    
    const interval = setInterval(() => {
      queryClient.invalidateQueries(['analytics']);
      queryClient.invalidateQueries(['guests']);
    }, 30_000); // 30 —Å–µ–∫—É–Ω–¥
    
    return () => clearInterval(interval);
  }, [autoRefreshEnabled, queryClient]);
  
  return (
    <div className="flex items-center gap-2">
      <Switch
        checked={autoRefreshEnabled}
        onCheckedChange={setAutoRefreshEnabled}
      />
      <Label>
        –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        {autoRefreshEnabled && (
          <span className="text-muted-foreground ml-1">(–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫)</span>
        )}
      </Label>
    </div>
  );
}
```

**Usage in Dashboard:**

```typescript
// app/(dashboard)/analytics/page.tsx
export default function AnalyticsPage() {
  const { data: analytics } = useRestaurantAnalytics({
    refetchInterval: 30_000, // Auto-refetch every 30s
    refetchOnWindowFocus: true,
  });
  
  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
        <AutoRefreshToggle />
      </div>
      
      {/* Charts... */}
    </div>
  );
}
```


***

## üë• **5. GUESTS MANAGEMENT**

### 5.1. Guests Table

**‚úÖ –†–ï–®–ï–ù–ò–ï: –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ)**

*(–£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª–µ 1.5 Tables –≤—ã—à–µ)*

**Default Columns:**

- ‚òë –ò–º—è
- ‚òë –¢–µ–ª–µ—Ñ–æ–Ω
- ‚òë –ë–∞–ª–∞–Ω—Å
- ‚òë –£—Ä–æ–≤–µ–Ω—å
- ‚òë –í–∏–∑–∏—Ç—ã
- ‚òë –ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ
- ‚òë –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç

**Optional Columns (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ DropdownMenu):**

- Email
- –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è
- –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –ò—Å—Ç–æ—á–Ω–∏–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –°—Ç–∞—Ç—É—Å
- –¢–µ–≥–∏

***

### 5.2. Guest Profile Page

**‚úÖ –†–ï–®–ï–ù–ò–ï: Tabs + Cards**

**Page:**

```typescript
// app/(dashboard)/guests/[id]/page.tsx
'use client';

export default function GuestProfilePage({ params }: { params: { id: string } }) {
  const { data: guest, isLoading } = useGuest(params.id);
  
  if (isLoading) {
    return <GuestProfileSkeleton />;
  }
  
  if (!guest) {
    return <GuestNotFound />;
  }
  
  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-start justify-between">
        <div className="flex items-start gap-4">
          <Avatar className="h-16 w-16">
            <AvatarImage src={guest.photoUrl} />
            <AvatarFallback>
              {guest.name.split(' ').map(n => n[0]).join('')}
            </AvatarFallback>
          </Avatar>
          
          <div>
            <h1 className="text-3xl font-bold">{guest.name}</h1>
            <p className="text-muted-foreground">{guest.phone}</p>
            {guest.email && (
              <p className="text-sm text-muted-foreground">{guest.email}</p>
            )}
          </div>
        </div>
        
        <div className="flex gap-2">
          <Button variant="outline" onClick={() => openEditModal(guest)}>
            <Edit className="h-4 w-4 mr-2" />
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="outline" size="icon">
                <MoreHorizontal className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem onClick={() => openAdjustmentModal(guest, 'add')}>
                –ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => openAdjustmentModal(guest, 'remove')}>
                –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => openTransferModal(guest)}>
                –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –±–∞–ª–ª—ã
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => resetQRCodes(guest.id)}>
                –°–±—Ä–æ—Å–∏—Ç—å QR/–ö–æ–¥
              </DropdownMenuItem>
              <DropdownMenuSeparator />
              <DropdownMenuItem onClick={() => sendMessage(guest)}>
                –û—Ç

---

# –ù–µ –∑–∞–∫–æ–Ω—á–∏–ª –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–æ–¥–æ–ª–∂–∏ —Å –º–µ—Å—Ç–∞ –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è

–ü—Ä–æ–¥–æ–ª–∂–∞—é —Å –º–µ—Å—Ç–∞ –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è:

***

```typescript
              <DropdownMenuItem onClick={() => sendMessage(guest)}>
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
              </DropdownMenuItem>
              <DropdownMenuSeparator />
              <DropdownMenuItem 
                className="text-destructive"
                onClick={() => blockGuest(guest.id)}
              >
                –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>
      
      {/* Tabs */}
      <Tabs defaultValue="overview">
        <TabsList>
          <TabsTrigger value="overview">–û–±–∑–æ—Ä</TabsTrigger>
          <TabsTrigger value="transactions">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</TabsTrigger>
          <TabsTrigger value="visits">–í–∏–∑–∏—Ç—ã</TabsTrigger>
          <TabsTrigger value="activity">–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</TabsTrigger>
        </TabsList>
        
        {/* OVERVIEW TAB */}
        <TabsContent value="overview" className="space-y-6">
          <div className="grid gap-6 md:grid-cols-2">
            {/* Personal Info Card */}
            <Card>
              <CardHeader>
                <CardTitle>–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="flex justify-between">
                  ```
                  <span className="text-muted-foreground">Email:</span>
                  ```
                  <span>{guest.email ?? '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                </div>
                <div className="flex justify-between">
                  ```
                  <span className="text-muted-foreground">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è:</span>
                  ```
                  <span>
                    {guest.birthdate 
                      ? format(new Date(guest.birthdate), 'dd MMMM yyyy', { locale: ru })
                      : '–ù–µ —É–∫–∞–∑–∞–Ω'}
                  </span>
                </div>
                <div className="flex justify-between">
                  ```
                  <span className="text-muted-foreground">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                  ```
                  <span>{guest.phone}</span>
                </div>
                <div className="flex justify-between">
                  ```
                  <span className="text-muted-foreground">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</span>
                  ```
                  ```
                  <span>{format(new Date(guest.createdAt), 'dd MMM yyyy', { locale: ru })}</span>
                  ```
                </div>
                <div className="flex justify-between">
                  ```
                  <span className="text-muted-foreground">–ò—Å—Ç–æ—á–Ω–∏–∫:</span>
                  ```
                  <Badge variant="secondary">
                    {getRegistrationSourceLabel(guest.registrationSource)}
                  </Badge>
                </div>
              </CardContent>
            </Card>
            
            {/* Loyalty Status Card */}
            <Card>
              <CardHeader>
                <CardTitle>–°—Ç–∞—Ç—É—Å –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex justify-between items-center">
                  ```
                  <span className="text-muted-foreground">–£—Ä–æ–≤–µ–Ω—å:</span>
                  ```
                  <Badge 
                    variant="secondary"
                    style={{ 
                      backgroundColor: guest.level.color + '20',
                      color: guest.level.color 
                    }}
                  >
                    {guest.level.icon} {guest.level.name}
                  </Badge>
                </div>
                
                <div className="space-y-2">
                  <div className="flex justify-between text-sm">
                    ```
                    <span className="text-muted-foreground">–ë–∞–ª–∞–Ω—Å:</span>
                    ```
                    <span className="font-bold text-lg">
                      {guest.balance} –±–∞–ª–ª–æ–≤
                    </span>
                  </div>
                  <div className="text-xs text-muted-foreground">
                    –û–±—ã—á–Ω—ã–µ: {guest.regularBalance} | –ü—Ä–æ–º–æ: {guest.promoBalance}
                  </div>
                </div>
                
                <Separator />
                
                <div className="flex justify-between">
                  ```
                  <span className="text-muted-foreground">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ:</span>
                  ```
                  <span className="font-semibold">
                    {formatCurrency(guest.lifetimeSpent)}
                  </span>
                </div>
                
                <div className="flex justify-between">
                  ```
                  <span className="text-muted-foreground">–í–∏–∑–∏—Ç–æ–≤:</span>
                  ```
                  ```
                  <span className="font-semibold">{guest.visits}</span>
                  ```
                </div>
                
                <div className="flex justify-between">
                  ```
                  <span className="text-muted-foreground">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫:</span>
                  ```
                  <span className="font-semibold">
                    {formatCurrency(guest.avgCheck)}
                  </span>
                </div>
                
                {/* Progress to Next Level */}
                {guest.nextLevel && (
                  <>
                    <Separator />
                    <div className="space-y-2">
                      <div className="flex justify-between text-sm">
                        <span className="text-muted-foreground">
                          –î–æ {guest.nextLevel.name}:
                        </span>
                        <span className="font-medium">
                          {formatCurrency(guest.nextLevel.threshold - guest.lifetimeSpent)}
                        </span>
                      </div>
                      <Progress 
                        value={
                          (guest.lifetimeSpent / guest.nextLevel.threshold) * 100
                        } 
                      />
                    </div>
                  </>
                )}
              </CardContent>
            </Card>
          </div>
          
          {/* Quick Actions + Statistics */}
          <div className="grid gap-6 md:grid-cols-2">
            {/* Quick Actions */}
            <Card>
              <CardHeader>
                <CardTitle>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</CardTitle>
              </CardHeader>
              <CardContent className="space-y-2">
                <Button 
                  className="w-full justify-start" 
                  variant="outline"
                  onClick={() => openAdjustmentModal(guest, 'add')}
                >
                  <Plus className="h-4 w-4 mr-2" />
                  –ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã
                </Button>
                
                <Button 
                  className="w-full justify-start" 
                  variant="outline"
                  onClick={() => openAdjustmentModal(guest, 'remove')}
                >
                  <Minus className="h-4 w-4 mr-2" />
                  –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã
                </Button>
                
                <Button 
                  className="w-full justify-start" 
                  variant="outline"
                  onClick={() => openTransferModal(guest)}
                >
                  <ArrowRightLeft className="h-4 w-4 mr-2" />
                  –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –±–∞–ª–ª—ã
                </Button>
                
                <Button 
                  className="w-full justify-start" 
                  variant="outline"
                  onClick={() => resetQRCodes(guest.id)}
                >
                  <RefreshCw className="h-4 w-4 mr-2" />
                  –°–±—Ä–æ—Å–∏—Ç—å QR/–ö–æ–¥
                </Button>
                
                <Button 
                  className="w-full justify-start" 
                  variant="outline"
                  onClick={() => sendMessage(guest)}
                >
                  <MessageSquare className="h-4 w-4 mr-2" />
                  –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                </Button>
              </CardContent>
            </Card>
            
            {/* Statistics */}
            <Card>
              <CardHeader>
                <CardTitle>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="flex justify-between">
                  ```
                  <span className="text-muted-foreground">–õ—é–±–∏–º–æ–µ –≤—Ä–µ–º—è:</span>
                  ```
                  <span className="font-medium">
                    {guest.favoriteTime ?? '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö'}
                  </span>
                </div>
                
                <div className="flex justify-between">
                  ```
                  <span className="text-muted-foreground">–õ—é–±–∏–º—ã–π –¥–µ–Ω—å:</span>
                  ```
                  <span className="font-medium">
                    {guest.favoriteDay ?? '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö'}
                  </span>
                </div>
                
                <div className="flex justify-between">
                  ```
                  <span className="text-muted-foreground">–õ—é–±–∏–º—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω:</span>
                  ```
                  <span className="font-medium">
                    {guest.favoriteRestaurant ?? '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö'}
                  </span>
                </div>
                
                <Separator />
                
                <div>
                  <span className="text-sm text-muted-foreground">
                    –¢–æ–ø –±–ª—é–¥:
                  </span>
                  <div className="mt-2 space-y-1">
                    {guest.topDishes?.slice(0, 5).map((dish, index) => (
                      <div key={index} className="flex justify-between text-sm">
                        <span>{dish.name}</span>
                        <Badge variant="secondary" className="text-xs">
                          {dish.count}x
                        </Badge>
                      </div>
                    )) ?? (
                      <span className="text-sm text-muted-foreground">
                        –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö
                      </span>
                    )}
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>
        
        {/* TRANSACTIONS TAB */}
        <TabsContent value="transactions">
          <Card>
            <CardHeader>
              <CardTitle>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</CardTitle>
              <CardDescription>
                –í—Å–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∏ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤
              </CardDescription>
            </CardHeader>
            <CardContent>
              <GuestTransactionsTable guestId={guest.id} />
            </CardContent>
          </Card>
        </TabsContent>
        
        {/* VISITS TAB */}
        <TabsContent value="visits">
          <Card>
            <CardHeader>
              <CardTitle>–ò—Å—Ç–æ—Ä–∏—è –≤–∏–∑–∏—Ç–æ–≤</CardTitle>
              <CardDescription>
                –í—Å–µ –ø–æ—Å–µ—â–µ–Ω–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
              </CardDescription>
            </CardHeader>
            <CardContent>
              <GuestVisitsTable guestId={guest.id} />
            </CardContent>
          </Card>
        </TabsContent>
        
        {/* ACTIVITY LOG TAB */}
        <TabsContent value="activity">
          <Card>
            <CardHeader>
              <CardTitle>–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</CardTitle>
              <CardDescription>
                –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º –≥–æ—Å—Ç—è
              </CardDescription>
            </CardHeader>
            <CardContent>
              <GuestActivityLog guestId={guest.id} />
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}
```


***

### 5.3. Bulk Actions

**‚úÖ –†–ï–®–ï–ù–ò–ï: Add/Remove –±–∞–ª–ª—ã + Export + Notifications + Tags**

**Component:**

```typescript
// components/guests/bulk-actions-menu.tsx
'use client';

export function BulkActionsMenu({ 
  selectedGuests, 
  onActionComplete 
}: BulkActionsMenuProps) {
  const [action, setAction] = React.useState<BulkAction | null>(null);
  
  return (
    <>
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="outline">
            {selectedGuests.length} –≤—ã–±—Ä–∞–Ω–æ
            <ChevronDown className="ml-2 h-4 w-4" />
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="end">
          <DropdownMenuItem onClick={() => setAction('add-balls')}>
            <Plus className="h-4 w-4 mr-2" />
            –ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã
          </DropdownMenuItem>
          
          <DropdownMenuItem onClick={() => setAction('remove-balls')}>
            <Minus className="h-4 w-4 mr-2" />
            –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã
          </DropdownMenuItem>
          
          <DropdownMenuSeparator />
          
          <DropdownMenuItem onClick={() => setAction('export')}>
            <Download className="h-4 w-4 mr-2" />
            –≠–∫—Å–ø–æ—Ä—Ç
          </DropdownMenuItem>
          
          <DropdownMenuItem onClick={() => setAction('send-notification')}>
            <Bell className="h-4 w-4 mr-2" />
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          </DropdownMenuItem>
          
          <DropdownMenuItem onClick={() => setAction('apply-tag')}>
            <Tag className="h-4 w-4 mr-2" />
            –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥
          </DropdownMenuItem>
          
          <DropdownMenuItem onClick={() => setAction('change-level')}>
            <Trophy className="h-4 w-4 mr-2" />
            –ò–∑–º–µ–Ω–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å
          </DropdownMenuItem>
          
          <DropdownMenuSeparator />
          
          <DropdownMenuItem 
            className="text-destructive"
            onClick={() => setAction('block')}
          >
            <Ban className="h-4 w-4 mr-2" />
            –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>
      
      {/* Modals */}
      <BulkAddBallsModal
        guests={selectedGuests}
        open={action === 'add-balls'}
        onClose={() => setAction(null)}
        onSuccess={onActionComplete}
      />
      
      <BulkRemoveBallsModal
        guests={selectedGuests}
        open={action === 'remove-balls'}
        onClose={() => setAction(null)}
        onSuccess={onActionComplete}
      />
      
      <BulkExportDialog
        guests={selectedGuests}
        open={action === 'export'}
        onClose={() => setAction(null)}
      />
      
      <BulkNotificationModal
        guests={selectedGuests}
        open={action === 'send-notification'}
        onClose={() => setAction(null)}
        onSuccess={onActionComplete}
      />
      
      <BulkTagModal
        guests={selectedGuests}
        open={action === 'apply-tag'}
        onClose={() => setAction(null)}
        onSuccess={onActionComplete}
      />
    </>
  );
}
```

**Bulk Add Balls Modal:**

```typescript
// components/guests/bulk-add-balls-modal.tsx
export function BulkAddBallsModal({ 
  guests, 
  open, 
  onClose, 
  onSuccess 
}: BulkAddBallsModalProps) {
  const form = useForm<BulkAdjustmentFormData>({
    resolver: zodResolver(bulkAdjustmentSchema),
    defaultValues: {
      amount: 0,
      balanceType: 'REGULAR',
      reason: '',
      notifyGuests: true,
    },
  });
  
  const bulkAdjust = useBulkAdjustment();
  
  const onSubmit = (data: BulkAdjustmentFormData) => {
    bulkAdjust.mutate(
      {
        guestIds: guests.map(g => g.id),
        type: 'ADD',
        ...data,
      },
      {
        onSuccess: () => {
          toast.success(`–ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã ${guests.length} –≥–æ—Å—Ç—è–º!`);
          onSuccess();
          onClose();
        },
      }
    );
  };
  
  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>–ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã –≥—Ä—É–ø–ø–µ –≥–æ—Å—Ç–µ–π</DialogTitle>
          <DialogDescription>
            –í—ã–±—Ä–∞–Ω–æ –≥–æ—Å—Ç–µ–π: {guests.length}
          </DialogDescription>
        </DialogHeader>
        
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="amount"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤</FormLabel>
                  <FormControl>
                    <Input 
                      type="number" 
                      placeholder="500" 
                      {...field}
                      onChange={(e) => field.onChange(Number(e.target.value))}
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            
            <FormField
              control={form.control}
              name="balanceType"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>–¢–∏–ø –±–∞–ª–∞–Ω—Å–∞</FormLabel>
                  <Select 
                    value={field.value} 
                    onValueChange={field.onChange}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="REGULAR">–û–±—ã—á–Ω—ã–µ –±–∞–ª–ª—ã</SelectItem>
                      ```
                      <SelectItem value="PROMO">–ü—Ä–æ–º–æ-–±–∞–ª–ª—ã</SelectItem>
                      ```
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />
            
            <FormField
              control={form.control}
              name="reason"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>–ü—Ä–∏—á–∏–Ω–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</FormLabel>
                  <FormControl>
                    <Textarea 
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ –∑–∞–¥–µ—Ä–∂–∫—É –∑–∞–∫–∞–∑–∞"
                      {...field}
                      rows={3}
                    />
                  </FormControl>
                  <FormDescription>
                    –ú–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />
            
            <FormField
              control={form.control}
              name="notifyGuests"
              render={({ field }) => (
                <FormItem className="flex items-center justify-between rounded-lg border p-3">
                  <div className="space-y-0.5">
                    <FormLabel>–£–≤–µ–¥–æ–º–∏—Ç—å –≥–æ—Å—Ç–µ–π</FormLabel>
                    <FormDescription>
                      –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
                    </FormDescription>
                  </div>
                  <FormControl>
                    <Switch
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                </FormItem>
              )}
            />
            
            <Alert>
              <AlertCircle className="h-4 w-4" />
              <AlertDescription>
                –ë–∞–ª–ª—ã –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã –≤—Å–µ–º {guests.length} –≤—ã–±—Ä–∞–Ω–Ω—ã–º –≥–æ—Å—Ç—è–º.
                –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –±—É–¥–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–æ –≤ –∂—É—Ä–Ω–∞–ª –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
              </AlertDescription>
            </Alert>
            
            <DialogFooter>
              <Button type="button" variant="outline" onClick={onClose}>
                –û—Ç–º–µ–Ω–∞
              </Button>
              <Button type="submit" disabled={bulkAdjust.isLoading}>
                {bulkAdjust.isLoading ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ...
                  </>
                ) : (
                  `–ù–∞—á–∏—Å–ª–∏—Ç—å ${guests.length} –≥–æ—Å—Ç—è–º`
                )}
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```


***

### 5.4. Guest Segmentation

**‚úÖ –†–ï–®–ï–ù–ò–ï: Saved Filters + Auto Segments**

**Page:**

```typescript
// app/(dashboard)/guests/segments/page.tsx
'use client';

const autoSegments = [
  {
    id: 'vip',
    name: 'VIP',
    icon: 'üî•',
    description: '–¢–æ–ø 10% –ø–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω–æ–π —Å—É–º–º–µ',
    color: 'text-orange-600',
    filter: { sortBy: 'lifetimeSpent', order: 'desc', limit: '10%' },
  },
  {
    id: 'at-risk',
    name: 'At-Risk',
    icon: '‚ö†Ô∏è',
    description: '–ù–µ –±—ã–ª–æ –≤–∏–∑–∏—Ç–æ–≤ 30+ –¥–Ω–µ–π, –Ω–æ —Ä–∞–Ω—å—à–µ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω',
    color: 'text-yellow-600',
    filter: { lastVisit: { gte: 30, lte: 90 }, minVisits: 3 },
  },
  {
    id: 'lost',
    name: '–ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ',
    icon: 'üò¥',
    description: '–ù–µ—Ç –≤–∏–∑–∏—Ç–æ–≤ 90+ –¥–Ω–µ–π',
    color: 'text-gray-600',
    filter: { lastVisit: { gte: 90 } },
  },
  {
    id: 'new',
    name: '–ù–æ–≤—ã–µ',
    icon: 'üÜï',
    description: '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π',
    color: 'text-green-600',
    filter: { createdAt: { gte: 30 } },
  },
  {
    id: 'birthday-month',
    name: '–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ',
    icon: 'üéÇ',
    description: '–£ –∫–æ–≥–æ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ç–µ–∫—É—â–µ–º –º–µ—Å—è—Ü–µ',
    color: 'text-pink-600',
    filter: { birthdayMonth: new Date().getMonth() + 1 },
  },
];

export default function SegmentsPage() {
  const { data: customSegments } = useCustomSegments();
  const [createModalOpen, setCreateModalOpen] = React.useState(false);
  
  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          ```
          <h1 className="text-3xl font-bold">–°–µ–≥–º–µ–Ω—Ç—ã –≥–æ—Å—Ç–µ–π</h1>
          ```
          <p className="text-muted-foreground">
            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã
          </p>
        </div>
        
        <Button onClick={() => setCreateModalOpen(true)}>
          <Plus className="h-4 w-4 mr-2" />
          –°–æ–∑–¥–∞—Ç—å —Å–µ–≥–º–µ–Ω—Ç
        </Button>
      </div>
      
      {/* Auto Segments */}
      <div>
        ```
        <h2 className="text-lg font-semibold mb-4">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã</h2>
        ```
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {autoSegments.map((segment) => (
            <SegmentCard key={segment.id} segment={segment} />
          ))}
        </div>
      </div>
      
      {/* Custom Segments */}
      {customSegments && customSegments.length > 0 && (
        <div>
          ```
          <h2 className="text-lg font-semibold mb-4">–ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã</h2>
          ```
          <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
            {customSegments.map((segment) => (
              <CustomSegmentCard 
                key={segment.id} 
                segment={segment}
                onEdit={() => openEditModal(segment)}
                onDelete={() => deleteSegment(segment.id)}
              />
            ))}
          </div>
        </div>
      )}
      
      <CreateSegmentModal
        open={createModalOpen}
        onClose={() => setCreateModalOpen(false)}
      />
    </div>
  );
}

function SegmentCard({ segment }: { segment: AutoSegment }) {
  const { data: count } = useSegmentCount(segment.filter);
  
  return (
    <Card className="hover:border-primary transition-colors cursor-pointer">
      <Link href={`/guests?segment=${segment.id}`}>
        <CardHeader>
          <div className="flex items-start justify-between">
            <div className={`text-4xl ${segment.color}`}>
              {segment.icon}
            </div>
            {count !== undefined && (
              <Badge variant="secondary" className="text-lg">
                {formatNumber(count)}
              </Badge>
            )}
          </div>
          ```
          <CardTitle className="mt-2">{segment.name}</CardTitle>
          ```
          <CardDescription>{segment.description}</CardDescription>
        </CardHeader>
      </Link>
    </Card>
  );
}
```

**Create Segment Modal:**

```typescript
// components/guests/create-segment-modal.tsx
export function CreateSegmentModal({ open, onClose }: CreateSegmentModalProps) {
  const [filters, setFilters] = React.useState<SegmentFilters>({});
  const { data: matchingCount } = useSegmentCount(filters);
  
  const form = useForm<SegmentFormData>({
    resolver: zodResolver(segmentSchema),
    defaultValues: {
      name: '',
      filters: {},
    },
  });
  
  const createSegment = useCreateSegment();
  
  const onSubmit = (data: SegmentFormData) => {
    createSegment.mutate(
      { ...data, filters },
      {
        onSuccess: () => {
          toast.success('–°–µ–≥–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω!');
          onClose();
        },
      }
    );
  };
  
  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>–°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç</DialogTitle>
        </DialogHeader>
        
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            <FormField
              control={form.control}
              name="name"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞</FormLabel>
                  <FormControl>
                    <Input 
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í—ã—Å–æ–∫–æ—á–µ–∫–æ–≤—ã–µ Silver" 
                      {...field} 
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            
            <Separator />
            
            <div className="space-y-4">
              ```
              <h3 className="font-medium">–§–∏–ª—å—Ç—Ä—ã</h3>
              ```
              
              {/* Level Filter */}
              <div className="space-y-2">
                <Label>–£—Ä–æ–≤–µ–Ω—å</Label>
                <MultiSelect
                  options={levels.map(l => ({ value: l.id, label: l.name }))}
                  value={filters.levelIds ?? []}
                  onChange={(value) => setFilters({ ...filters, levelIds: value })}
                  placeholder="–õ—é–±–æ–π —É—Ä–æ–≤–µ–Ω—å"
                />
              </div>
              
              {/* Lifetime Spent Filter */}
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ (–æ—Ç)</Label>
                  <Input
                    type="number"
                    placeholder="0"
                    value={filters.lifetimeSpentMin ?? ''}
                    onChange={(e) => setFilters({ 
                      ...filters, 
                      lifetimeSpentMin: Number(e.target.value) 
                    })}
                  />
                </div>
                
                <div className="space-y-2">
                  <Label>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ (–¥–æ)</Label>
                  <Input
                    type="number"
                    placeholder="–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π"
                    value={filters.lifetimeSpentMax ?? ''}
                    onChange={(e) => setFilters({ 
                      ...filters, 
                      lifetimeSpentMax: Number(e.target.value) 
                    })}
                  />
                </div>
              </div>
              
              {/* Visits Filter */}
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>–í–∏–∑–∏—Ç–æ–≤ (–æ—Ç)</Label>
                  <Input
                    type="number"
                    placeholder="0"
                    value={filters.visitsMin ?? ''}
                    onChange={(e) => setFilters({ 
                      ...filters, 
                      visitsMin: Number(e.target.value) 
                    })}
                  />
                </div>
                
                <div className="space-y-2">
                  <Label>–í–∏–∑–∏—Ç–æ–≤ (–¥–æ)</Label>
                  <Input
                    type="number"
                    placeholder="–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π"
                    value={filters.visitsMax ?? ''}
                    onChange={(e) => setFilters({ 
                      ...filters, 
                      visitsMax: Number(e.target.value) 
                    })}
                  />
                </div>
              </div>
              
              {/* Last Visit Filter */}
              <div className="space-y-2">
                <Label>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç</Label>
                <Select
                  value={filters.lastVisitFilter ?? 'all'}
                  onValueChange={(value) => setFilters({ 
                    ...filters, 
                    lastVisitFilter: value 
                  })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">–õ—é–±–æ–µ –≤—Ä–µ–º—è</SelectItem>
                    ```
                    <SelectItem value="last-7">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</SelectItem>
                    ```
                    ```
                    <SelectItem value="last-30">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</SelectItem>
                    ```
                    ```
                    <SelectItem value="30-90">30-90 –¥–Ω–µ–π –Ω–∞–∑–∞–¥</SelectItem>
                    ```
                    <SelectItem value="90+">–ë–æ–ª–µ–µ 90 –¥–Ω–µ–π –Ω–∞–∑–∞–¥</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
            
            <Alert>
              <Users className="h-4 w-4" />
              <AlertDescription>
                –ù–∞–π–¥–µ–Ω–æ –≥–æ—Å—Ç–µ–π: {matchingCount !== undefined ? (
                  <strong>{formatNumber(matchingCount)}</strong>
                ) : (
                  <Loader2 className="inline h-4 w-4 animate-spin" />
                )}
              </AlertDescription>
            </Alert>
            
            <DialogFooter>
              <Button type="button" variant="outline" onClick={onClose}>
                –û—Ç–º–µ–Ω–∞
              </Button>
              <Button type="submit" disabled={createSegment.isLoading}>
                {createSegment.isLoading ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : '–°–æ–∑–¥–∞—Ç—å —Å–µ–≥–º–µ–Ω—Ç'}
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```


***

### 5.5. Manual Ball Adjustment Modal

**‚úÖ –†–ï–®–ï–ù–ò–ï: Simple Modal + Confirmation –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å—É–º–º**

*(–£–∂–µ –æ–ø–∏—Å–∞–Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å 30, –ø–æ–ª–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤—ã—à–µ)*

**–î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: Large Amount Confirmation:**

```typescript
// components/guests/adjustment-confirmation-dialog.tsx
export function AdjustmentConfirmationDialog({
  guest,
  amount,
  type,
  reason,
  open,
  onConfirm,
  onCancel,
}: AdjustmentConfirmationProps) {
  return (
    <AlertDialog open={open}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle className="flex items-center gap-2">
            <AlertCircle className="h-5 w-5 text-destructive" />
            –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±–æ–ª—å—à–æ–π —Å—É–º–º—ã
          </AlertDialogTitle>
          <AlertDialogDescription>
            –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å {type === 'ADD' ? '–Ω–∞—á–∏—Å–ª–∏—Ç—å' : '—Å–ø–∏—Å–∞—Ç—å'}{' '}
            <strong>{amount} –±–∞–ª–ª–æ–≤</strong> –≥–æ—Å—Ç—é{' '}
            <strong>{guest.name}</strong>.
            <br />
            <br />
            –ü—Ä–∏—á–∏–Ω–∞: <em>{reason}</em>
            <br />
            <br />
            –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –±—É–¥–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–æ –≤ –∂—É—Ä–Ω–∞–ª –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–º–µ–Ω–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel onClick={onCancel}>
            –û—Ç–º–µ–Ω–∞
          </AlertDialogCancel>
          <AlertDialogAction onClick={onConfirm}>
            –î–∞, {type === 'ADD' ? '–Ω–∞—á–∏—Å–ª–∏—Ç—å' : '—Å–ø–∏—Å–∞—Ç—å'} {amount} –±–∞–ª–ª–æ–≤
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```


***

## ‚öôÔ∏è **6. SETTINGS \& CONFIGURATION**

### 6.1. Restaurant Settings

**‚úÖ –†–ï–®–ï–ù–ò–ï: Tabs –≤ Settings**

**Page:**

```typescript
// app/(dashboard)/settings/page.tsx
'use client';

export default function SettingsPage() {
  return (
    <div className="space-y-6">
      <div>
        ```
        <h1 className="text-3xl font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
        ```
        <p className="text-muted-foreground">
          –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
        </p>
      </div>
      
      <Tabs defaultValue="general">
        <TabsList>
          <TabsTrigger value="general">–û–±—â–∏–µ</TabsTrigger>
          <TabsTrigger value="loyalty">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</TabsTrigger>
          <TabsTrigger value="pos">POS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</TabsTrigger>
          <TabsTrigger value="notifications">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</TabsTrigger>
          <TabsTrigger value="team">–ö–æ–º–∞–Ω–¥–∞</TabsTrigger>
          {user.role === 'OWNER' && (
            <TabsTrigger value="billing">–ë–∏–ª–ª–∏–Ω–≥</TabsTrigger>
          )}
        </TabsList>
        
        <TabsContent value="general">
          <GeneralSettings />
        </TabsContent>
        
        <TabsContent value="loyalty">
          <LoyaltySystemSettings />
        </TabsContent>
        
        <TabsContent value="pos">
          <POSIntegrationSettings />
        </TabsContent>
        
        <TabsContent value="notifications">
          <NotificationSettings />
        </TabsContent>
        
        <TabsContent value="team">
          <TeamManagement />
        </TabsContent>
        
        {user.role === 'OWNER' && (
          <TabsContent value="billing">
            <BillingSettings />
          </TabsContent>
        )}
      </Tabs>
    </div>
  );
}
```

**General Settings Tab:**

```typescript
// components/settings/general-settings.tsx
export function GeneralSettings() {
  const { data: restaurant } = useRestaurant();
  const form = useForm<RestaurantFormData>({
    resolver: zodResolver(restaurantSchema),
    defaultValues: restaurant,
  });
  
  const updateRestaurant = useUpdateRestaurant();
  
  const onSubmit = (data: RestaurantFormData) => {
    updateRestaurant.mutate(data, {
      onSuccess: () => {
        toast.success('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
      },
    });
  };
  
  return (
    <Card>
      <CardHeader>
        <CardTitle>–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</CardTitle>
        <CardDescription>
          –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ
        </CardDescription>
      </CardHeader>
      <CardContent>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            <div className="grid gap-6 md:grid-cols-2">
              <FormField
                control={form.control}
                name="name"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              
              <FormField
                control={form.control}
                name="phone"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>–¢–µ–ª–µ—Ñ–æ–Ω</FormLabel>
                    <FormControl>
                      <Input type="tel" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
            
            <FormField
              control={form.control}
              name="address"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>–ê–¥—Ä–µ—Å</FormLabel>
                  <FormControl>
                    <Input {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            
            <FormField
              control={form.control}
              name="logo"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>–õ–æ–≥–æ—Ç–∏–ø</FormLabel>
                  <FormControl>
                    <FileUpload
                      onUpload={async (file) => {
                        const url = await uploadFile(file);
                        field.onChange(url);
                        return url;
                      }}
                      preview={field.value}
                    />
                  </FormControl>
                  <FormDescription>
                    PNG –∏–ª–∏ JPG, –º–∞–∫—Å–∏–º—É–º 5MB
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />
            
            <FormField
              control={form.control}
              name="timezone"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</FormLabel>
                  <Select value={field.value} onValueChange={field.onChange}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="Europe/Moscow">–ú–æ—Å–∫–≤–∞ (GMT+3)</SelectItem>
                      <SelectItem value="Europe/Samara">–°–∞–º–∞—Ä–∞ (GMT+4)</SelectItem>
                      <SelectItem value="Asia/Yekaterinburg">–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ (GMT+5)</SelectItem>
                      {/* ... –¥—Ä—É–≥–∏–µ */}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />
            
            <Button type="submit" disabled={updateRestaurant.isLoading}>
              {updateRestaurant.isLoading ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è'}
            </Button>
          </form>
        </Form>
      </CardContent>
    </Card>
  );
}
```

**Loyalty System Settings Tab:**

```typescript
// components/settings/loyalty-system-settings.tsx
export function LoyaltySystemSettings() {
  const { data: loyaltySystem } = useLoyaltySystem();
  const form = useForm<LoyaltySystemFormData>({
    resolver: zodResolver(loyaltySystemSchema),
    defaultValues: loyaltySystem,
  });
  
  const updateSystem = useUpdateLoyaltySystem();
  
  const onSubmit = (data: LoyaltySystemFormData) => {
    updateSystem.mutate(data, {
      onSuccess: () => {
        toast.success('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
      },
    });
  };
  
  return (
    <Card>
      <CardHeader>
        <CardTitle>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</CardTitle>
        <CardDescription>
          –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∏ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤
        </CardDescription>
      </CardHeader>
      <CardContent>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            {/* Ball Conversion */}
            <Alert>
              <Info className="h-4 w-4" />
              <AlertDescription>
                <strong>–ö–æ–Ω–≤–µ—Ä—Å–∏—è –±–∞–ª–ª–æ–≤:</strong> 1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ)
              </AlertDescription>
            </Alert>
            
            {/* Redeem Limit */}
            <FormField
              control={form.control}
              name="maxRedeemPercent"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>–õ–∏–º–∏—Ç —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤</FormLabel>
                  <FormControl>
                    <div className="flex items-center gap-4">
                      <Slider
                        value={[field.value]}
                        onValueChange={([value]) => field.onChange(value)}
                        min={10}
                        max={100}
                        step={5}
                        className="flex-1"
                      />
                      <Input
                        type="number"
                        value={field.value}
                        onChange={(e) => field.onChange(Number(e.target.value))}
                        className="w-20"
                      />
                      <span>%</span>
                    </div>
                  </FormControl>
                  <FormDescription>
                    –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —á–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏ (10-100%)
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />
            
            {/* Min Check Amount */}
            <FormField
              control={form.control}
              name="minCheckAmount"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞</FormLabel>
                  <FormControl>
                    <div className="flex items-center gap-2">
                      <Input
                        type="number"
                        {...field}
                        onChange={(e) => field.onChange(Number(e.target.value))}
                      />
                      <span>‚ÇΩ</span>
                    </div>
                  </FormControl>
                  <FormDescription>
                    –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è/—Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />
            
            {/* Inactivity Expiration */}
            <FormField
              control={form.control}
              name="inactivityExpireDays"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>–°–≥–æ—Ä–∞–Ω–∏–µ –ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</FormLabel>
                  <FormControl>
                    <div className="flex items-center gap-2">
                      <Input
                        type="number"
                        {...field}
                        onChange={(e) => field.onChange(Number(e.target.value))}
                      />
                      <span>–¥–Ω–µ–π</span>
                    </div>
                  </FormControl>
                  <FormDescription>
                    –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–∞–ª–ª—ã —Å–≥–æ—Ä–∞—é—Ç (–º–∏–Ω–∏–º—É–º 90 –¥–Ω–µ–π)
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />
            
            <Separator />
            
            {/* Transfer Settings */}
            <div className="space-y-4">
              ```
              <h3 className="font-semibold">–ü–µ—Ä–µ–≤–æ–¥—ã –º–µ–∂–¥—É –≥–æ—Å—Ç—è–º–∏</h3>
              ```
              
              <FormField
                control={form.control}
                name="allowTransfers"
                render={({ field }) => (
                  <FormItem className="flex items-center justify-between rounded-lg border p-4">
                    <div className="space-y-0.5">
                      <FormLabel>–†–∞–∑—Ä–µ—à–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã</FormLabel>
                      <FormDescription>
                        –ì–æ—Å—Ç–∏ —Å–º–æ–≥—É—Ç –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –±–∞–ª–ª—ã –¥—Ä—É–≥ –¥—Ä—É–≥—É
                      </FormDescription>
                    </div>
                    <FormControl>
                      <Switch
                        checked={field.value}
                        onCheckedChange={field.onChange}
                      />
                    </FormControl>
                  </FormItem>
                )}
              />
              
              {form.watch('allowTransfers') && (
                <div className="grid gap-4 md:grid-cols-3">
                  <FormField
                    control={form.control}
                    name="transferMinAmount"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>–ú–∏–Ω. —Å—É–º–º–∞</FormLabel>
                        <FormControl>
                          <Input
                            type="number"
                            {...field}
                            onChange={(e) => field.onChange(Number(e.target.value))}
                          />
                        </FormControl>
                      </FormItem>
                    )}
                  />
                  
                  <FormField
                    control={form.control}
                    name="transferMaxPerOperation"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>–ú–∞–∫—Å. –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏—é</FormLabel>
                        <FormControl>
                          <Input
                            type="number"
                            {...field}
                            onChange={(e) => field.onChange(Number(e.target.value))}
                          />
                        </FormControl>
                      </FormItem>
                    )}
                  />
                  
                  <FormField
                    control={form.control}
                    name="transferMaxPerDay"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>–ú–∞–∫—Å. –≤ –¥–µ–Ω—å</FormLabel>
                        <FormControl>
                          <Input
                            type="number"
                            {...field}
                            onChange={(e) => field.onChange(Number(e.target.value))}
                          />
                        </FormControl>
                      </FormItem>
                    )}
                  />
                </div>
              )}
            </div>
            
            <Button type="submit" disabled={updateSystem.isLoading}>
              {updateSystem.isLoading ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è'}
            </Button>
          </form>
        </Form>
      </CardContent>
    </Card>
  );
}
```


***

### 6.2. Team Management

**‚úÖ –†–ï–®–ï–ù–ò–ï: Table + Invite Modal**

*(–£–∂–µ –æ–ø–∏—Å–∞–Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å 32, —Å–º. –≤—ã—à–µ)*

***

### 6.3. Activity Log

**‚úÖ –†–ï–®–ï–ù–ò–ï: Filterable Table + Timeline**

*(–£–∂–µ –æ–ø–∏—Å–∞–Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å 33, —Å–º. –≤—ã—à–µ)*

***

### 6.4. Impersonation UI

**‚úÖ –†–ï–®–ï–ù–ò–ï: Red Banner + Clear Exit**

*(–£–∂–µ –æ–ø–∏—Å–∞–Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å 34, —Å–º. –≤—ã—à–µ)*

***

## üåê **7. –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø (–†–£–°–°–ö–ò–ô –Ø–ó–´–ö)**

### 7.1. –í—Å–µ —Ç–µ–∫—Å—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º

**‚úÖ –í–°–ï UI-—Ç–µ–∫—Å—Ç—ã, –∫–Ω–æ–ø–∫–∏, –ª–µ–π–±–ª—ã, —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ**

**–ü—Ä–∏–º–µ—Ä—ã:**

- –ö–Ω–æ–ø–∫–∏: "–°–æ–∑–¥–∞—Ç—å", "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "–û—Ç–º–µ–Ω–∞", "–£–¥–∞–ª–∏—Ç—å"
- –§–∏–ª—å—Ç—Ä—ã: "–í—Å–µ", "–ê–∫—Ç–∏–≤–Ω—ã–µ", "–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ"
- –°—Ç–∞—Ç—É—Å—ã: "–ê–∫—Ç–∏–≤–Ω–æ", "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ", "–£–¥–∞–ª–µ–Ω–æ"
- –î–∞—Ç—ã: "10 —Ñ–µ–≤—Ä–∞–ª—è 2026", "2 –¥–Ω—è –Ω–∞–∑–∞–¥", "–í—á–µ—Ä–∞"
- –í–∞–ª—é—Ç–∞: "2 350 ‚ÇΩ", "152 000 ‚ÇΩ"
- –ß–∏—Å–ª–∞: "1 523", "45 600"

**date-fns —Å —Ä—É—Å—Å–∫–æ–π –ª–æ–∫–∞–ª—å—é:**

```typescript
import { format } from 'date-fns';
import { ru } from 'date-fns/locale';

format(new Date(), 'dd MMMM yyyy', { locale: ru }); // "10 —Ñ–µ–≤—Ä–∞–ª—è 2026"
```

**–ß–∏—Å–ª–æ–≤—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:**

```typescript
// lib/formatters.ts
export function formatCurrency(amount: number): string {
  return new Intl.NumberFormat('ru-RU', {
    style: 'currency',
    currency: 'RUB',
    minimumFractionDigits: 0,
  }).format(amount); // "2 350 ‚ÇΩ"
}

export function formatNumber(number: number): string {
  return new Intl.NumberFormat('ru-RU').format(number); // "1 523"
}
```


***

## üéØ **–ò–¢–û–ì–û–í–´–ô CHECKLIST**

‚úÖ **Technology Stack:**

- Next.js 14+ (App Router)
- shadcn/ui + Radix UI + Tailwind CSS
- Zustand + TanStack Query
- React Hook Form + Zod
- TanStack Table + Virtualization
- Recharts
- React Day Picker + date-fns
- react-dropzone + Direct S3 Upload
- sonner (toast notifications)
- SSE + TanStack Query auto-refetch

‚úÖ **Layout \& Navigation:**

- Collapsible Sidebar (250px ‚Üí 60px mini)
- Top Navbar (breadcrumbs, search, notifications, restaurant selector, user menu)
- Global Search (CMD+K) —Å PostgreSQL Full-Text Search
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ Breadcrumbs
- Mobile Bottom Tab Bar

‚úÖ **Loyalty Builder:**

- Rules Builder (Form + Live Preview)
- Conditions Builder (tag-based + AND/OR)
- Priority Drag \& Drop (@dnd-kit)
- Levels Timeline (visual + form)
- Promo Wizard (5 steps, –ø–æ–ª–Ω–∞—è –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è)

‚úÖ **Analytics \& Dashboards:**

- Owner Dashboard (MRR, Churn, Tenants, Revenue charts)
- Admin Dashboard (Revenue, Guests, Loyalty ROI)
- Drill-down modals
- Export (XLSX, CSV, PDF)
- Auto-refresh (30 sec)

‚úÖ **Guests Management:**

- Guests Table (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏)
- Guest Profile (4 tabs: Overview, Transactions, Visits, Activity Log)
- Bulk Actions (Add/Remove –±–∞–ª–ª—ã, Export, Notifications, Tags, Block)
- Segmentation (Auto + Custom)
- Manual Adjustment Modal (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º > 1,000)

‚úÖ **Settings:**

- 6 tabs: General, Loyalty, POS, Notifications, Team, Billing
- Restaurant info, Logo upload
- Loyalty System settings (redeem limit, expiration, transfers)
- Team Management (invite, roles, permissions)
- Activity Log
- Impersonation (Red Banner)

‚úÖ **–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è:**

- –í—Å–µ UI –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- date-fns —Å ru locale
- Intl.NumberFormat –¥–ª—è –≤–∞–ª—é—Ç—ã –∏ —á–∏—Å–µ–ª

***

## üì¶ **DEPLOYMENT CHECKLIST**

```bash
# Build
npm run build

# Environment Variables
NEXT_PUBLIC_API_URL=https://api.max-loyalty.com
NEXT_PUBLIC_CDN_URL=https://cdn.max-loyalty.com
DATABASE_URL=postgresql://...
REDIS_URL=redis://...

# Deploy (Vercel)
vercel --prod

# Or (Self-hosted)
docker build -t admin-panel .
docker run -p 3000:3000 admin-panel
```


***

**üéâ Frontend Admin Panel –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω!**

**–°–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏:**

- Database Schema \& Prisma (–ø–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü, relations, indexes)
- Analytics \& Reporting (–¥–µ—Ç–∞–ª—å–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã —Ä–∞—Å—á—ë—Ç–∞)
- Deployment \& Infrastructure (Docker, CI/CD, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)

**–ö–∞–∫–æ–π –±–ª–æ–∫ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–º?** üöÄ

