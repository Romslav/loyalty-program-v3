# ğŸ“˜ **ĞŸĞĞ›ĞĞĞ¯ Ğ¡ĞŸĞ•Ğ¦Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ¯ ĞŸĞ›ĞĞ“Ğ˜ĞĞ MAX LOYALTY Ğ”Ğ›Ğ¯ R-KEEPER**


***

## **ğŸ“‹ Ğ¡ĞĞ”Ğ•Ğ Ğ–ĞĞĞ˜Ğ•**

1. [ĞĞ±Ñ‰ĞµĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ](#1-%D0%BE%D0%B1%D1%89%D0%B5%D0%B5-%D0%BE%D0%BF%D0%B8%D1%81%D0%B0%D0%BD%D0%B8%D0%B5)
2. [ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ](#2-%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0-%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D1%8F)
3. [ĞŸÑ€Ğ¾Ñ†ĞµÑÑ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·ĞºĞ¸ Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸](#3-%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81-%D0%BF%D1%80%D0%B8%D0%B2%D1%8F%D0%B7%D0%BA%D0%B8-%D0%B8-%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B8)
4. [External DLL ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ](#4-external-dll-%D1%81%D0%BF%D0%B5%D1%86%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F)
5. [UI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ](#5-ui-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5-%D1%81%D0%BF%D0%B5%D1%86%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F)
6. [Floating Button](#6-floating-button)
7. [ĞĞºĞ½Ğ° Ğ¸ workflow](#7-%D0%BE%D0%BA%D0%BD%D0%B0-%D0%B8-workflow)
8. [Ğ­ĞºÑ€Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹](#8-%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5-%D0%BA%D0%BB%D0%B0%D0%B2%D0%B8%D0%B0%D1%82%D1%83%D1%80%D1%8B)
9. [Shared Memory ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ](#9-shared-memory-%D1%81%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F)
10. [R-Keeper XML API Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ](#10-r-keeper-xml-api-%D0%B8%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D1%8F)
11. [Backend API endpoints](#11-backend-api-endpoints)
12. [Ğ¤Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹](#12-%D1%84%D0%B8%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D1%82%D1%80%D0%B0%D0%BD%D0%B7%D0%B0%D0%BA%D1%86%D0%B8%D0%B9)
13. [Offline Ñ€ĞµĞ¶Ğ¸Ğ¼](#13-offline-%D1%80%D0%B5%D0%B6%D0%B8%D0%BC)
14. [Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ](#14-%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D1%8C)
15. [Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³](#15-%D0%BB%D0%BE%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B8-%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3)
16. [Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°](#16-%D0%B4%D0%B8%D0%B0%D0%B3%D0%BD%D0%BE%D1%81%D1%82%D0%B8%D0%BA%D0%B0)
17. [ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ](#17-%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F)
18. [ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°](#18-%D0%B0%D0%BD%D0%B0%D0%BB%D0%B8%D1%82%D0%B8%D0%BA%D0%B0)

***

## **ğŸ¯ 1. ĞĞ‘Ğ©Ğ•Ğ• ĞĞŸĞ˜Ğ¡ĞĞĞ˜Ğ•**

### **1.1. ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ**

ĞŸĞ»Ğ°Ğ³Ğ¸Ğ½ Ğ´Ğ»Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ»Ğ¾ÑĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Max Loyalty Ğ² R-Keeper Ñ‡ĞµÑ€ĞµĞ· Ğ³Ğ¸Ğ±Ñ€Ğ¸Ğ´Ğ½ÑƒÑ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ (external.dll + Desktop UI). ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ ĞºĞ°ÑÑĞ¸Ñ€Ğ°Ğ¼ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ³Ğ¾ÑÑ‚ĞµĞ¹ Ğº Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ğ¼, Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ±Ğ¾Ğ½ÑƒÑÑ‹/ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ¸ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ÑÑ‚ÑŒ Ğ±Ğ°Ğ»Ğ»Ñ‹.

### **1.2. Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑÑ‚ĞµĞº**

| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ | Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ |
| :-- | :-- |
| **External DLL** | C++ (Native) Ğ¸Ğ»Ğ¸ C\# Ñ‡ĞµÑ€ĞµĞ· C++/CLI |
| **UI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ** | WPF + .NET Framework 4.7.2+ |
| **R-Keeper Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ** | XML API + FarCard Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ |
| **Backend API** | REST API Max Loyalty (NestJS) |
| **Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ** | Serilog (structured logging) |
| **ĞšĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ** | MemoryCache |
| **HTTP ĞºĞ»Ğ¸ĞµĞ½Ñ‚** | HttpClient + Polly (retry policies) |
| **Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ** | MemoryMappedFile (shared memory) |
| **ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ğ¸** | WPF Storyboard |
| **DI ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€** | Microsoft.Extensions.DependencyInjection |

### **1.3. ĞŸĞ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°**

- **ĞĞ¡**: Windows 10/11
- **R-Keeper**: 7.x+
- **FarCard**: Ğ’ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ (Ğ‘Ğ•Ğ¡ĞŸĞ›ĞĞ¢ĞĞ)
- **Hardware**: Touch-screen Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°


### **1.4. ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ¸Ñ Ğ¾Ñ‚ iiko**

| ĞÑĞ¿ĞµĞºÑ‚ | iiko | R-Keeper |
| :-- | :-- | :-- |
| **Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ** | ĞŸÑ€ÑĞ¼Ğ¾Ğ¹ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½ (SDK) | Ğ“Ğ¸Ğ±Ñ€Ğ¸Ğ´Ğ½Ğ°Ñ (DLL + UI) |
| **UI** | Ğ’ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ² iiko Front | ĞÑ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğµ WPF Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ |
| **ĞšĞ½Ğ¾Ğ¿ĞºĞ°** | Ğ’ Ğ¼ĞµĞ½Ñ Ğ”ĞĞŸĞĞ›ĞĞ•ĞĞ˜Ğ¯ | Floating Button (touch) |
| **API** | IFrontPlugin SDK | XML API + FarCard |
| **Ğ›Ğ¸Ñ†ĞµĞ½Ğ·Ğ¸Ñ** | Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾ | FarCard Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾ |
| **Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°** | .dll Ğ² Plugins/ | DLL + UI + Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° |


***

## **ğŸ—ï¸ 2. ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ¯**

### **2.1. Ğ¢Ñ€Ğ¸ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£  MaxLoyaltyRKeeper.dll (External DLL)             â”‚
â”‚      â€¢ C++ Native DLL Ğ´Ğ»Ñ FarCard                       â”‚
â”‚      â€¢ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ R-Keeper                â”‚
â”‚      â€¢ Ğ¢Ñ€Ğ°Ğ½ÑĞ»Ğ¸Ñ€ÑƒĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ â†’ Backend API                â”‚
â”‚      â€¢ Ğ Ğ°Ğ·Ğ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ: C:\RK7\Plugins\                      â”‚
â”‚      â€¢ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ÑÑ: ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ R-Keeper   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£  MaxLoyaltyRKeeperUI.exe (WPF Desktop)            â”‚
â”‚      â€¢ C# .NET 4.7.2+ WPF Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ                    â”‚
â”‚      â€¢ Floating Button Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…                    â”‚
â”‚      â€¢ Touch-friendly Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ                         â”‚
â”‚      â€¢ Ğ Ğ°Ğ·Ğ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ: C:\MaxLoyalty\                       â”‚
â”‚      â€¢ Ğ—Ğ°Ğ¿ÑƒÑĞº: ĞĞ²Ñ‚Ğ¾Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Windows + ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ñ‚Ñ€ĞµĞ¹    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£  R-Keeper FarCard (Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ)            â”‚
â”‚      â€¢ Ğ’ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ R-Keeper                       â”‚
â”‚      â€¢ Ğ‘Ğ•Ğ¡ĞŸĞ›ĞĞ¢ĞĞ (Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ² R-Keeper)                    â”‚
â”‚      â€¢ ĞŸĞ¾ÑÑ€ĞµĞ´Ğ½Ğ¸Ğº Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ°ÑÑĞ¾Ğ¹ Ğ¸ external.dll            â”‚
â”‚      â€¢ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°: ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ñ‡ĞµÑ€ĞµĞ· ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸Ğº       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### **2.2. Ğ¡Ñ…ĞµĞ¼Ğ° Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ**

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   R-KEEPER CASH      â”‚
                    â”‚  (ĞºĞ°ÑÑĞ¾Ğ²Ğ°Ñ ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ñ)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                         â”‚
          â–¼                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FarCard Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ  â”‚                    â”‚  XML API R-Keeper   â”‚
â”‚  (Ğ²ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹)    â”‚                    â”‚  localhost:8080     â”‚
â”‚                  â”‚                    â”‚  /rk7api/v0/...     â”‚
â”‚  â€¢ GetCardInfo   â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â€¢ ApplyDiscount â”‚                               â”‚
â”‚  â€¢ Finalize      â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
         â”‚                                          â”‚
         â–¼                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MaxLoyaltyRKeeper    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ MaxLoyaltyRKeeperUI.exe  â”‚
â”‚ .dll (external.dll)  â”‚  Shared    â”‚ (WPF Desktop UI)         â”‚
â”‚                      â”‚  Memory    â”‚                          â”‚
â”‚ â€¢ Initialize()       â”‚  (1 MB)    â”‚ â€¢ FloatingButtonWindow   â”‚
â”‚ â€¢ GetCardInfo()      â”‚            â”‚ â€¢ GuestSearchWindow      â”‚
â”‚ â€¢ ReservePoints()    â”‚            â”‚ â€¢ OperationWindow        â”‚
â”‚ â€¢ ReserveDiscount()  â”‚            â”‚ â€¢ NumericKeyboard        â”‚
â”‚ â€¢ UpdateReservation()â”‚            â”‚ â€¢ AlphabeticKeyboard     â”‚
â”‚ â€¢ CancelReservation()â”‚            â”‚ â€¢ DiagnosticsWindow      â”‚
â”‚ â€¢ FinalizeTransactionâ”‚            â”‚                          â”‚
â”‚ â€¢ Shutdown()         â”‚            â”‚ Services:                â”‚
â”‚                      â”‚            â”‚ â€¢ LoyaltyApiClient       â”‚
â”‚ HTTP/HTTPS           â”‚            â”‚ â€¢ RKeeperXmlClient       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ â€¢ SharedMemoryService    â”‚
           â”‚                        â”‚ â€¢ OfflineQueueService    â”‚
           â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚         â”‚
           â–¼         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Backend API         â”‚
    â”‚  Max Loyalty         â”‚
    â”‚  (NestJS + Prisma)   â”‚
    â”‚                      â”‚
    â”‚  Endpoints:          â”‚
    â”‚  â€¢ /search-guest     â”‚
    â”‚  â€¢ /calculate        â”‚
    â”‚  â€¢ /reserve-points   â”‚
    â”‚  â€¢ /reserve-discount â”‚
    â”‚  â€¢ /finalize-points  â”‚
    â”‚  â€¢ /finalize-discountâ”‚
    â”‚  â€¢ /update-reservationâ”‚
    â”‚  â€¢ /cancel-reservationâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### **2.3. Shared Memory ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°**

```json
// MemoryMappedFile: "MaxLoyaltyRKeeperShared" (1 MB)

{
  "version": "1.0.0",
  "lastUpdated": "2026-02-18T00:31:00Z",
  
  "backendStatus": {
    "isOnline": true,
    "lastCheckAt": "2026-02-18T00:30:45Z",
    "latencyMs": 45
  },
  
  "activeOrders": {
    "order_12345": {
      "orderId": "order_12345",
      "guestCardId": "card_uuid_abc",
      "guestName": "Ğ˜Ğ²Ğ°Ğ½ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²",
      "guestPhone": "+79991234567",
      "benefitType": "POINTS",
      "action": "SPEND",
      "pointsToSpend": 178.00,
      "maxAllowed": 178.00,
      "pointsToEarn": 45.00,
      "reservationId": "res_xyz789",
      "originalCheckAmount": 890.00,
      "appliedAt": "2026-02-18T00:29:30Z",
      "stationId": "STATION_001",
      "terminalId": "term_001"
    }
  },
  
  "offlineQueue": [
    {
      "id": "offline_001",
      "type": "FINALIZE_POINTS",
      "orderId": "order_99999",
      "payload": { ... },
      "queuedAt": "2026-02-18T00:25:00Z",
      "attempts": 0
    }
  ],
  
  "metrics": {
    "totalTransactionsToday": 145,
    "totalPointsSpentToday": 12450.00,
    "totalPointsEarnedToday": 3890.00,
    "averageResponseTimeMs": 120
  }
}
```


***

## **ğŸ”— 3. ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ¡ ĞŸĞ Ğ˜Ğ’Ğ¯Ğ—ĞšĞ˜ Ğ˜ Ğ£Ğ¡Ğ¢ĞĞĞĞ’ĞšĞ˜**

### **3.1. ĞŸÑ€Ğ¸Ğ²ÑĞ·ĞºĞ° Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸**

#### **Ğ¨Ğ°Ğ³ 1: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ R-Keeper Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸**

```
ĞĞ”ĞœĞ˜Ğ ĞŸĞĞĞ•Ğ›Ğ¬ â†’ Ğ ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ñ‹ â†’ "ĞŸĞ¸Ñ†Ñ†ĞµÑ€Ğ¸Ñ Ğ£ ĞœĞ°Ñ€Ğ¸Ğ¾ - Ğ¦ĞµĞ½Ñ‚Ñ€"
              â†’ POS Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ â†’ [â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ R-Keeper]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ĞĞĞ’ĞĞ¯ R-KEEPER Ğ˜ĞĞ¢Ğ•Ğ“Ğ ĞĞ¦Ğ˜Ğ¯                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tenant: Ğ¡ĞµÑ‚ÑŒ ĞŸĞ¸Ñ†Ñ†ĞµÑ€Ğ¸Ğ¹ ĞœĞ°Ñ€Ğ¸Ğ¾                    â”‚
â”‚  Ğ ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½: ĞŸĞ¸Ñ†Ñ†ĞµÑ€Ğ¸Ñ Ğ£ ĞœĞ°Ñ€Ğ¸Ğ¾ - Ğ¦ĞµĞ½Ñ‚Ñ€             â”‚
â”‚                                                 â”‚
â”‚  ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğ°: *                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ĞšĞ°ÑÑĞ° 1 (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ»)                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                 â”‚
â”‚  R-Keeper Station ID (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾):             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ STATION_001                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                 â”‚
â”‚  R-Keeper XML API URL:                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ http://localhost:8080/rk7api/v0/xmlinter..â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                 â”‚
â”‚  â„¹ï¸  ĞŸĞ¾ÑĞ»Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸       â”‚
â”‚     Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ Ğ²ĞµÑ€ÑĞ¸Ñ R-Keeper Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑÑ      â”‚
â”‚                                                 â”‚
â”‚  [Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


#### **Backend ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ:**

```typescript
// POST /api/admin/rkeeper/installations

interface CreateRKeeperInstallationDto {
  tenantId: string;
  restaurantId: string;
  terminalName: string;
  stationId?: string;
  xmlApiUrl: string;
}

async createRKeeperInstallation(dto: CreateRKeeperInstallationDto) {
  // 1. Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ API Key
  const apiKey = this.generateApiKey('rk_live_');
  
  // 2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ² Ğ‘Ğ”
  const installation = await this.prisma.rKeeperPluginInstallation.create({
    data: {
      id: generateUuid(),
      tenantId: dto.tenantId,
      restaurantId: dto.restaurantId,
      terminalName: dto.terminalName,
      stationId: dto.stationId,
      xmlApiUrl: dto.xmlApiUrl,
      apiKey,
      status: 'PENDING_INSTALLATION',
      createdAt: new Date(),
      createdBy: getCurrentUser().id
    }
  });
  
  // 3. Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸ĞºĞ°
  const installer = await this.installerBuilder.build({
    installationId: installation.id,
    tenantId: dto.tenantId,
    tenantName: getTenantName(dto.tenantId),
    restaurantId: dto.restaurantId,
    restaurantName: getRestaurantName(dto.restaurantId),
    terminalName: dto.terminalName,
    stationId: dto.stationId,
    apiKey,
    xmlApiUrl: dto.xmlApiUrl,
    backendApiUrl: config.backendApiUrl,
    environment: config.environment
  });
  
  // 4. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² S3/CDN
  const downloadUrl = await this.storage.uploadInstaller(
    installer.buffer,
    `MaxLoyaltyRKeeper_${sanitize(dto.terminalName)}.exe`
  );
  
  // 5. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ñ URL
  await this.prisma.rKeeperPluginInstallation.update({
    where: { id: installation.id },
    data: { installerDownloadUrl: downloadUrl }
  });
  
  return {
    installation,
    downloadUrl
  };
}
```


#### **ĞĞ´Ğ¼Ğ¸Ğ½ Ğ²Ğ¸Ğ´Ğ¸Ñ‚:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°!                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ID: inst_abc123                                â”‚
â”‚  Ğ¢ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»: ĞšĞ°ÑÑĞ° 1 (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ»)              â”‚
â”‚  API Key: rk_live_xYz789... [ğŸ“‹ ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ]    â”‚
â”‚  Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: â³ ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸                   â”‚
â”‚                                                 â”‚
â”‚  ğŸ“¥ Ğ¡ĞšĞĞ§ĞĞ¢Ğ¬ Ğ£Ğ¡Ğ¢ĞĞĞĞ’Ğ©Ğ˜Ğš:                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â¬‡ï¸ MaxLoyaltyRKeeper_Kassa1.exe (15.2 MB)â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                 â”‚
â”‚  Ğ’ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸Ğº Ğ·Ğ°ÑˆĞ¸Ñ‚Ñ‹:                           â”‚
â”‚  âœ… Tenant ID                                   â”‚
â”‚  âœ… Restaurant ID                               â”‚
â”‚  âœ… Terminal ID                                 â”‚
â”‚  âœ… Station ID                                  â”‚
â”‚  âœ… API Key (Ğ·Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹)                     â”‚
â”‚  âœ… XML API URL                                 â”‚
â”‚                                                 â”‚
â”‚  ğŸ“Œ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ:                                 â”‚
â”‚  1. Ğ¡ĞºĞ°Ñ‡Ğ°Ğ¹Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğ° ĞºĞ°ÑÑĞ¾Ğ²ÑƒÑ ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ñ          â”‚
â”‚  2. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ğ¾Ñ‚ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°          â”‚
â”‚  3. Ğ”Ğ¾Ğ¶Ğ´Ğ¸Ñ‚ĞµÑÑŒ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸             â”‚
â”‚  4. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ R-Keeper (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### **3.2. Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸ĞºĞ°**

```
MaxLoyaltyRKeeper_Kassa1.exe
â”œâ”€â”€ Manifest (Ğ²ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹)
â”‚   â”œâ”€â”€ installation_id: "inst_abc123"
â”‚   â”œâ”€â”€ tenant_id: "tenant_mario"
â”‚   â”œâ”€â”€ tenant_name: "Ğ¡ĞµÑ‚ÑŒ ĞŸĞ¸Ñ†Ñ†ĞµÑ€Ğ¸Ğ¹ ĞœĞ°Ñ€Ğ¸Ğ¾"
â”‚   â”œâ”€â”€ restaurant_id: "rest_centro"
â”‚   â”œâ”€â”€ restaurant_name: "ĞŸĞ¸Ñ†Ñ†ĞµÑ€Ğ¸Ñ Ğ£ ĞœĞ°Ñ€Ğ¸Ğ¾ - Ğ¦ĞµĞ½Ñ‚Ñ€"
â”‚   â”œâ”€â”€ terminal_id: "term_001"
â”‚   â”œâ”€â”€ terminal_name: "ĞšĞ°ÑÑĞ° 1 (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ»)"
â”‚   â”œâ”€â”€ station_id: "STATION_001"
â”‚   â”œâ”€â”€ api_key_encrypted: "AES256_encrypted..."
â”‚   â”œâ”€â”€ xml_api_url: "http://localhost:8080/..."
â”‚   â”œâ”€â”€ backend_api_url: "https://api.maxloyalty.ru"
â”‚   â””â”€â”€ environment: "production"
â”‚
â”œâ”€â”€ Files/
â”‚   â”œâ”€â”€ MaxLoyaltyRKeeper.dll (external DLL)
â”‚   â”œâ”€â”€ MaxLoyaltyRKeeperUI.exe (WPF UI)
â”‚   â”œâ”€â”€ Dependencies/
â”‚   â”‚   â”œâ”€â”€ Newtonsoft.Json.dll
â”‚   â”‚   â”œâ”€â”€ Serilog.dll
â”‚   â”‚   â”œâ”€â”€ Serilog.Sinks.File.dll
â”‚   â”‚   â”œâ”€â”€ Polly.dll
â”‚   â”‚   â”œâ”€â”€ System.Memory.dll
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ Resources/
â”‚   â”‚   â”œâ”€â”€ ML_Icon.png
â”‚   â”‚   â”œâ”€â”€ ML_Logo.png
â”‚   â”‚   â””â”€â”€ Sounds/
â”‚   â”‚       â”œâ”€â”€ click.wav
â”‚   â”‚       â””â”€â”€ success.wav
â”‚   â””â”€â”€ README.txt
â”‚
â””â”€â”€ Installer Logic (C# WPF)
    â”œâ”€â”€ DetectRKeeper()
    â”œâ”€â”€ InstallDLL()
    â”œâ”€â”€ InstallUI()
    â”œâ”€â”€ ConfigureFarCard()
    â”œâ”€â”€ AddToAutostart()
    â”œâ”€â”€ TestConnection()
    â””â”€â”€ ShowCompletion()
```


### **3.3. ĞŸÑ€Ğ¾Ñ†ĞµÑÑ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ (Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾)**

#### **Ğ¨Ğ°Ğ³ 1: Ğ—Ğ°Ğ¿ÑƒÑĞº ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸ĞºĞ°**

```csharp
public partial class InstallerWindow : Window
{
    private InstallationManifest manifest;
    private string rKeeperPath;
    
    protected override async void OnLoaded(object sender, RoutedEventArgs e)
    {
        try
        {
            // 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
            if (!IsAdministrator())
            {
                var result = MessageBox.Show(
                    "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°.\n" +
                    "ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°?",
                    "Ğ¢Ñ€ĞµĞ±ÑƒÑÑ‚ÑÑ Ğ¿Ñ€Ğ°Ğ²Ğ°",
                    MessageBoxButton.YesNo,
                    MessageBoxImage.Warning
                );
                
                if (result == MessageBoxResult.Yes)
                {
                    RestartAsAdmin();
                    Application.Current.Shutdown();
                }
                return;
            }
            
            // 2. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ° Ğ¸Ğ· Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
            manifest = LoadEmbeddedManifest();
            
            // 3. ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞºÑ€Ğ°Ğ½
            ShowWelcomeScreen();
            
            // 4. Ğ–Ğ´ĞµĞ¼ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ
            if (await WaitForUserConfirmation())
            {
                await StartInstallation();
            }
        }
        catch (Exception ex)
        {
            ShowError("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸", ex);
        }
    }
}
```


#### **Ğ¨Ğ°Ğ³ 2: ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ R-Keeper**

```csharp
private async Task<string> DetectRKeeperAsync()
{
    UpdateProgress("ĞŸĞ¾Ğ¸ÑĞº R-Keeper...", 10);
    
    // ĞœĞµÑ‚Ğ¾Ğ´ 1: Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ Ğ¿ÑƒÑ‚Ğ¸
    var standardPaths = new[]
    {
        @"C:\RK7\",
        @"C:\Program Files\UCS\RK7\",
        @"C:\Program Files (x86)\UCS\RK7\",
        @"D:\RK7\"
    };
    
    foreach (var path in standardPaths)
    {
        if (Directory.Exists(path) && File.Exists(Path.Combine(path, "RK7.exe")))
        {
            logger.LogInformation($"R-Keeper found at: {path}");
            return path;
        }
    }
    
    // ĞœĞµÑ‚Ğ¾Ğ´ 2: Ğ ĞµĞµÑÑ‚Ñ€
    try
    {
        using var key = Registry.LocalMachine.OpenSubKey(@"SOFTWARE\UCS\RK7");
        if (key != null)
        {
            var installPath = key.GetValue("InstallPath") as string;
            if (!string.IsNullOrEmpty(installPath) && Directory.Exists(installPath))
            {
                logger.LogInformation($"R-Keeper found via registry: {installPath}");
                return installPath;
            }
        }
    }
    catch (Exception ex)
    {
        logger.LogWarning(ex, "Failed to check registry");
    }
    
    // ĞœĞµÑ‚Ğ¾Ğ´ 3: ĞŸĞ¾Ğ¸ÑĞº Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°
    var processes = Process.GetProcessesByName("RK7");
    if (processes.Length > 0)
    {
        var mainModule = processes[0].MainModule;
        if (mainModule != null)
        {
            var path = Path.GetDirectoryName(mainModule.FileName);
            logger.LogInformation($"R-Keeper found via process: {path}");
            return path;
        }
    }
    
    // ĞœĞµÑ‚Ğ¾Ğ´ 4: ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ²ÑĞµĞ¼ Ğ´Ğ¸ÑĞºĞ°Ğ¼ (Ğ´Ğ¾Ğ»Ğ³Ğ¾)
    UpdateProgress("Ğ“Ğ»ÑƒĞ±Ğ¾ĞºĞ¸Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº R-Keeper...", 15);
    
    var drives = DriveInfo.GetDrives()
        .Where(d => d.DriveType == DriveType.Fixed && d.IsReady);
    
    foreach (var drive in drives)
    {
        var searchPaths = new[]
        {
            Path.Combine(drive.Name, "RK7"),
            Path.Combine(drive.Name, "Program Files", "UCS", "RK7"),
            Path.Combine(drive.Name, "Program Files (x86)", "UCS", "RK7")
        };
        
        foreach (var path in searchPaths)
        {
            if (Directory.Exists(path) && File.Exists(Path.Combine(path, "RK7.exe")))
            {
                logger.LogInformation($"R-Keeper found via deep search: {path}");
                return path;
            }
        }
    }
    
    // ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ - Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ²Ğ²Ğ¾Ğ´
    return await RequestManualPath();
}

private async Task<string> RequestManualPath()
{
    var dialog = new OpenFileDialog
    {
        Title = "Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¿ÑƒÑ‚ÑŒ Ğº R-Keeper (RK7.exe)",
        Filter = "R-Keeper|RK7.exe|All files|*.*",
        CheckFileExists = true
    };
    
    if (dialog.ShowDialog() == true)
    {
        return Path.GetDirectoryName(dialog.FileName);
    }
    
    throw new Exception("R-Keeper Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ°.");
}
```


#### **Ğ¨Ğ°Ğ³ 3: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° DLL**

```csharp
private async Task InstallDLLAsync()
{
    UpdateProgress("Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° external.dll...", 30);
    
    var targetPath = Path.Combine(rKeeperPath, "Plugins", "MaxLoyaltyRKeeper.dll");
    var targetDir = Path.GetDirectoryName(targetPath);
    
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Plugins ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
    if (!Directory.Exists(targetDir))
    {
        Directory.CreateDirectory(targetDir);
        logger.LogInformation($"Created Plugins directory: {targetDir}");
    }
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°
    if (File.Exists(targetPath))
    {
        // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ backup
        var backupPath = targetPath + ".backup_" + DateTime.Now.ToString("yyyyMMddHHmmss");
        File.Copy(targetPath, backupPath);
        logger.LogInformation($"Created backup: {backupPath}");
        
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğµ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ»Ğ¸ Ñ„Ğ°Ğ¹Ğ»
        if (IsFileLocked(targetPath))
        {
            var result = MessageBox.Show(
                "DLL Ñ„Ğ°Ğ¹Ğ» Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ R-Keeper.\n" +
                "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ R-Keeper Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ.\n\n" +
                "ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞµĞ¹Ñ‡Ğ°Ñ?",
                "Ğ¤Ğ°Ğ¹Ğ» Ğ·Ğ°Ğ½ÑÑ‚",
                MessageBoxButton.YesNo,
                MessageBoxImage.Warning
            );
            
            if (result == MessageBoxResult.Yes)
            {
                await StopRKeeperService();
            }
            else
            {
                throw new Exception("Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ°. DLL Ñ„Ğ°Ğ¹Ğ» Ğ·Ğ°Ğ½ÑÑ‚.");
            }
        }
    }
    
    // ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ DLL Ğ¸Ğ· Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
    var dllBytes = ExtractEmbeddedResource("MaxLoyaltyRKeeper.dll");
    await File.WriteAllBytesAsync(targetPath, dllBytes);
    
    logger.LogInformation($"DLL installed to: {targetPath}");
    UpdateProgress("DLL ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°", 40);
}
```


#### **Ğ¨Ğ°Ğ³ 4: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° UI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ**

```csharp
private async Task InstallUIAsync()
{
    UpdateProgress("Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° UI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ...", 50);
    
    var installDir = @"C:\MaxLoyalty";
    
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ
    if (!Directory.Exists(installDir))
    {
        Directory.CreateDirectory(installDir);
    }
    
    // ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ UI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
    var uiPath = Path.Combine(installDir, "MaxLoyaltyRKeeperUI.exe");
    var uiBytes = ExtractEmbeddedResource("MaxLoyaltyRKeeperUI.exe");
    await File.WriteAllBytesAsync(uiPath, uiBytes);
    
    // ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
    var dependencies = new[]
    {
        "Newtonsoft.Json.dll",
        "Serilog.dll",
        "Serilog.Sinks.File.dll",
        "Polly.dll",
        "System.Memory.dll",
        "Microsoft.Extensions.DependencyInjection.dll",
        "Microsoft.Extensions.DependencyInjection.Abstractions.dll"
    };
    
    foreach (var dep in dependencies)
    {
        var depPath = Path.Combine(installDir, dep);
        var depBytes = ExtractEmbeddedResource($"Dependencies.{dep}");
        await File.WriteAllBytesAsync(depPath, depBytes);
    }
    
    // ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµÑÑƒÑ€ÑÑ‹
    var resourcesDir = Path.Combine(installDir, "Resources");
    Directory.CreateDirectory(resourcesDir);
    
    var resources = new[] { "ML_Icon.png", "ML_Logo.png" };
    foreach (var res in resources)
    {
        var resPath = Path.Combine(resourcesDir, res);
        var resBytes = ExtractEmbeddedResource($"Resources.{res}");
        await File.WriteAllBytesAsync(resPath, resBytes);
    }
    
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
    await CreateConfigurationAsync(installDir);
    
    logger.LogInformation($"UI installed to: {installDir}");
    UpdateProgress("UI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾", 60);
}

private async Task CreateConfigurationAsync(string installDir)
{
    var configDir = Path.Combine(
        Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
        "MaxLoyaltyRKeeper"
    );
    
    if (!Directory.Exists(configDir))
    {
        Directory.CreateDirectory(configDir);
    }
    
    // Ğ Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²ĞºĞ° API Key Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ¹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹
    var machineId = GetMachineId();
    var apiKey = DecryptApiKey(manifest.ApiKeyEncrypted, machineId);
    
    var config = new
    {
        installation_id = manifest.InstallationId,
        tenant_id = manifest.TenantId,
        tenant_name = manifest.TenantName,
        restaurant_id = manifest.RestaurantId,
        restaurant_name = manifest.RestaurantName,
        terminal_id = manifest.TerminalId,
        terminal_name = manifest.TerminalName,
        station_id = manifest.StationId,
        api_key = apiKey, // Ğ Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹
        backend_api_url = manifest.BackendApiUrl,
        rkeeper_xml_api_url = manifest.XmlApiUrl,
        environment = manifest.Environment,
        
        offline_queue_max_size = 100,
        offline_queue_ttl_hours = 24,
        
        log_path = @"C:\Logs\MaxLoyaltyRKeeper\",
        log_retention_days = 7,
        
        ui_settings = new
        {
            floating_button_enabled = true,
            floating_button_position = "TopRight",
            floating_button_size = "Medium",
            floating_button_opacity = 0.7,
            edge_gesture_enabled = false,
            sounds_enabled = true,
            vibration_enabled = true,
            keyboard_size = "Medium"
        }
    };
    
    var configPath = Path.Combine(configDir, "config.json");
    var json = JsonConvert.SerializeObject(config, Formatting.Indented);
    await File.WriteAllTextAsync(configPath, json);
    
    logger.LogInformation($"Configuration created: {configPath}");
}
```


#### **Ğ¨Ğ°Ğ³ 5: ĞĞ²Ñ‚Ğ¾Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° FarCard**

```csharp
private async Task ConfigureFarCardAsync()
{
    UpdateProgress("ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° FarCard...", 70);
    
    var dllPath = Path.Combine(rKeeperPath, "Plugins", "MaxLoyaltyRKeeper.dll");
    
    // ĞœĞµÑ‚Ğ¾Ğ´ 1: Ğ§ĞµÑ€ĞµĞ· XML API R-Keeper
    try
    {
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""ConfigureFarCard"">
                <Settings>
                  <ExternalDllPath>{XmlEscape(dllPath)}</ExternalDllPath>
                  <Enabled>true</Enabled>
                  <LogLevel>2</LogLevel>
                  <TimeoutSeconds>30</TimeoutSeconds>
                  <RetryCount>3</RetryCount>
                </Settings>
              </RK7CMD>
            </RK7Query>
        ";
        
        using var httpClient = new HttpClient { Timeout = TimeSpan.FromSeconds(5) };
        var response = await httpClient.PostAsync(
            manifest.XmlApiUrl,
            new StringContent(xml, Encoding.UTF8, "text/xml")
        );
        
        if (response.IsSuccessStatusCode)
        {
            logger.LogInformation("FarCard configured via XML API");
            UpdateProgress("FarCard Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ñ‡ĞµÑ€ĞµĞ· API", 75);
            return;
        }
    }
    catch (Exception ex)
    {
        logger.LogWarning(ex, "Failed to configure via XML API, trying config file");
    }
    
    // ĞœĞµÑ‚Ğ¾Ğ´ 2: ĞŸÑ€ÑĞ¼Ğ¾Ğµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°
    var configPath = Path.Combine(rKeeperPath, "config", "FarCard.xml");
    
    if (File.Exists(configPath))
    {
        try
        {
            var doc = XDocument.Load(configPath);
            
            var externalDllElement = doc.Descendants("ExternalDll").FirstOrDefault();
            if (externalDllElement == null)
            {
                externalDllElement = new XElement("ExternalDll");
                doc.Root?.Add(externalDllElement);
            }
            
            externalDllElement.SetElementValue("Path", dllPath);
            externalDllElement.SetElementValue("Enabled", "true");
            externalDllElement.SetElementValue("LogLevel", "2");
            externalDllElement.SetElementValue("TimeoutSeconds", "30");
            externalDllElement.SetElementValue("RetryCount", "3");
            
            doc.Save(configPath);
            
            logger.LogInformation("FarCard configured via config file");
            UpdateProgress("FarCard Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ñ‡ĞµÑ€ĞµĞ· ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³", 75);
            return;
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to edit config file");
        }
    }
    
    // ĞœĞµÑ‚Ğ¾Ğ´ 3: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°
    var newConfigPath = Path.Combine(rKeeperPath, "config", "FarCard_MaxLoyalty.xml");
    var newConfig = new XDocument(
        new XElement("FarCard",
            new XElement("ExternalDll",
                new XElement("Path", dllPath),
                new XElement("Enabled", "true"),
                new XElement("LogLevel", "2"),
                new XElement("TimeoutSeconds", "30"),
                new XElement("RetryCount", "3")
            )
        )
    );
    
    newConfig.Save(newConfigPath);
    
    logger.LogInformation($"Created new FarCard config: {newConfigPath}");
    UpdateProgress("FarCard ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ ÑĞ¾Ğ·Ğ´Ğ°Ğ½", 75);
    
    // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
    ShowManualFarCardInstructions(newConfigPath);
}

private void ShowManualFarCardInstructions(string configPath)
{
    var instructions = $@"
âš ï¸ Ğ’ĞĞ–ĞĞ: Ğ ÑƒÑ‡Ğ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° FarCard

ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° FarCard Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ°ÑÑŒ.
ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ external.dll:

1. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ R-Keeper Manager
2. ĞŸĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ â†’ FarCard
3. Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ External DLL
4. Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¿ÑƒÑ‚ÑŒ: {configPath}
5. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
6. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ R-Keeper

Ğ˜Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³: {configPath}
    ";
    
    MessageBox.Show(
        instructions,
        "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ñ€ÑƒÑ‡Ğ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°",
        MessageBoxButton.OK,
        MessageBoxImage.Information
    );
}
```


#### **Ğ¨Ğ°Ğ³ 6: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ**

```csharp
private async Task AddToAutostartAsync()
{
    UpdateProgress("Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ...", 80);
    
    var uiPath = @"C:\MaxLoyalty\MaxLoyaltyRKeeperUI.exe";
    var startupArg = "--startup";
    
    try
    {
        using var key = Registry.CurrentUser.OpenSubKey(
            @"Software\Microsoft\Windows\CurrentVersion\Run",
            writable: true
        );
        
        if (key != null)
        {
            key.SetValue(
                "MaxLoyaltyRKeeper",
                $"\"{uiPath}\" {startupArg}",
                RegistryValueKind.String
            );
            
            logger.LogInformation("Added to Windows autostart");
            UpdateProgress("Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ", 85);
        }
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "Failed to add to autostart");
        
        // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ
        ShowManualAutostartInstructions(uiPath);
    }
}
```


#### **Ğ¨Ğ°Ğ³ 7: Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ**

```csharp
private async Task TestConnectionAsync()
{
    UpdateProgress("Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ...", 90);
    
    var configPath = Path.Combine(
        Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
        "MaxLoyaltyRKeeper",
        "config.json"
    );
    
    var config = JsonConvert.DeserializeObject<dynamic>(
        await File.ReadAllTextAsync(configPath)
    );
    
    // Ğ¢ĞµÑÑ‚ 1: Backend API
    try
    {
        using var httpClient = new HttpClient();
        httpClient.DefaultRequestHeaders.Add("X-API-Key", (string)config.api_key);
        httpClient.DefaultRequestHeaders.Add("X-Installation-Id", (string)config.installation_id);
        
        var response = await httpClient.GetAsync($"{config.backend_api_url}/api/health");
        
        if (response.IsSuccessStatusCode)
        {
            logger.LogInformation("âœ… Backend API: OK");
            testResults.Add("Backend API", true);
        }
        else
        {
            logger.LogWarning($"âš ï¸ Backend API: {response.StatusCode}");
            testResults.Add("Backend API", false);
        }
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "âŒ Backend API: Failed");
        testResults.Add("Backend API", false);
    }
    
    // Ğ¢ĞµÑÑ‚ 2: R-Keeper XML API
    try
    {
        using var httpClient = new HttpClient { Timeout = TimeSpan.FromSeconds(3) };
        var testXml = @"<RK7Query><RK7CMD CMD=""GetServerInfo""/></RK7Query>";
        
        var response = await httpClient.PostAsync(
            (string)config.rkeeper_xml_api_url,
            new StringContent(testXml, Encoding.UTF8, "text/xml")
        );
        
        if (response.IsSuccessStatusCode)
        {
            logger.LogInformation("âœ… R-Keeper XML API: OK");
            testResults.Add("R-Keeper XML API", true);
        }
        else
        {
            logger.LogWarning($"âš ï¸ R-Keeper XML API: {response.StatusCode}");
            testResults.Add("R-Keeper XML API", false);
        }
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "âŒ R-Keeper XML API: Failed");
        testResults.Add("R-Keeper XML API", false);
    }
    
    // Ğ¢ĞµÑÑ‚ 3: Shared Memory
    try
    {
        using var mmf = MemoryMappedFile.CreateOrOpen(
            "MaxLoyaltyRKeeperShared",
            1024 * 1024 // 1 MB
        );
        
        logger.LogInformation("âœ… Shared Memory: OK");
        testResults.Add("Shared Memory", true);
    }
    catch (Exception ex)
    {
        logger.LogError(ex, "âŒ Shared Memory: Failed");
        testResults.Add("Shared Memory", false);
    }
    
    UpdateProgress("Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾", 95);
}
```


#### **Ğ¨Ğ°Ğ³ 8: Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞºÑ€Ğ°Ğ½**

```csharp
private async Task ShowCompletionAsync()
{
    UpdateProgress("Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!", 100);
    
    var allTestsPassed = testResults.Values.All(v => v);
    
    var completionWindow = new CompletionWindow
    {
        InstallationId = manifest.InstallationId,
        TerminalName = manifest.TerminalName,
        TestResults = testResults,
        AllTestsPassed = allTestsPassed,
        RKeeperNeedsRestart = true
    };
    
    completionWindow.ShowDialog();
    
    // Ğ—Ğ°Ğ¿ÑƒÑĞº UI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
    if (allTestsPassed)
    {
        StartUIApplication();
    }
    
    // ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº R-Keeper
    if (completionWindow.RestartRKeeperNow)
    {
        await RestartRKeeperServiceAsync();
    }
}
```

```xaml
<!-- CompletionWindow.xaml -->
<Window x:Class="Installer.CompletionWindow"
        Title="Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°"
        Width="600" Height="700"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize">
    
    <Grid Margin="30">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,30">
            <Image Source="/Resources/ML_Logo.png" 
                   Width="100" Height="100"
                   Margin="0,0,0,20"/>
            <TextBlock Text="ğŸ‰ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!"
                       FontSize="28" FontWeight="Bold"
                       HorizontalAlignment="Center"/>
            <TextBlock Text="{Binding TerminalName}"
                       FontSize="18" Foreground="#666"
                       HorizontalAlignment="Center"
                       Margin="0,5,0,0"/>
        </StackPanel>
        
        <!-- Test Results -->
        <Border Grid.Row="1" 
                BorderBrush="#E5E7EB" BorderThickness="1"
                CornerRadius="8" Padding="20"
                Margin="0,0,0,20">
            <StackPanel>
                <TextBlock Text="Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:"
                           FontSize="16" FontWeight="SemiBold"
                           Margin="0,0,0,15"/>
                
                <ItemsControl ItemsSource="{Binding TestResults}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <TextBlock Text="{Binding Key}"
                                           FontSize="14"/>
                                
                                <TextBlock Grid.Column="1"
                                           Text="{Binding Value, Converter={StaticResource BoolToStatusConverter}}"
                                           FontSize="14" FontWeight="Bold"/>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <Separator Margin="0,15"/>
                
                <TextBlock FontSize="14" TextWrapping="Wrap">
                    <Run Text="âœ… UI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾" FontWeight="SemiBold"/><LineBreak/>
                    <Run Text="âœ… Floating button Ğ¿Ğ¾ÑĞ²Ğ¸Ñ‚ÑÑ Ğ½Ğ° ĞºĞ°ÑÑĞµ" FontWeight="SemiBold"/><LineBreak/>
                    <Run Text="âœ… ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ" FontWeight="SemiBold"/>
                </TextBlock>
            </StackPanel>
        </Border>
        
        <!-- Warning -->
        <Border Grid.Row="1" 
                Background="#FEF3C7" 
                BorderBrush="#F59E0B" 
                BorderThickness="2"
                CornerRadius="8" 
                Padding="20"
                Margin="0,10,0,20"
                VerticalAlignment="Bottom">
            <StackPanel>
                <TextBlock FontSize="16" FontWeight="Bold" 
                           Foreground="#92400E"
                           Margin="0,0,0,10">
                    âš ï¸ Ğ’ĞĞ–ĞĞ:
                </TextBlock>
                <TextBlock FontSize="14" TextWrapping="Wrap"
                           Foreground="#92400E">
                    Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ DLL (Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ñ ĞºĞ°Ñ€Ñ‚Ğ°Ğ¼Ğ¸ Ñ‡ĞµÑ€ĞµĞ· FarCard) 
                    Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ R-Keeper ĞºĞ°ÑÑĞ¾Ğ²Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€.
                    <LineBreak/><LineBreak/>
                    UI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ£Ğ–Ğ• Ğ¡Ğ•Ğ™Ğ§ĞĞ¡ Ğ¸ Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚:
                    <LineBreak/>
                    â€¢ Ğ˜ÑĞºĞ°Ñ‚ÑŒ Ğ³Ğ¾ÑÑ‚ĞµĞ¹
                    <LineBreak/>
                    â€¢ ĞŸÑ€Ğ¸Ğ²ÑĞ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğº Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ğ¼
                    <LineBreak/>
                    â€¢ Ğ¡Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ»Ñ‹ / Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑÑ‚ÑŒ ÑĞºĞ¸Ğ´ĞºĞ¸
                    <LineBreak/><LineBreak/>
                    DLL Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°.
                </TextBlock>
            </StackPanel>
        </Border>
        
        <!-- Actions -->
        <StackPanel Grid.Row="2" Orientation="Vertical">
            <Button Content="ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ R-Keeper ÑĞµĞ¹Ñ‡Ğ°Ñ"
                    Height="50" FontSize="16"
                    Background="#6366F1" Foreground="White"
                    Click="RestartNow_Click"
                    Margin="0,0,0,10"/>
            
            <Button Content="â­ï¸ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ"
                    Height="50" FontSize="16"
                    Background="White" BorderBrush="#6366F1"
                    Foreground="#6366F1" BorderThickness="2"
                    Click="RestartLater_Click"
                    Margin="0,0,0,10"/>
            
            <TextBlock FontSize="12" Foreground="#666"
                       TextAlignment="Center" TextWrapping="Wrap"
                       Margin="0,10,0,0">
                ğŸ’¡ Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ² Ğ½ĞµÑ€Ğ°Ğ±Ğ¾Ñ‡ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ
                <LineBreak/>
                (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ´Ğ¾ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾ÑĞ»Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ)
            </TextBlock>
        </StackPanel>
    </Grid>
</Window>
```


***

### **3.4. ĞŸĞµÑ€Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº backend**

```csharp
// UI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ

public class StartupService
{
    private readonly LoyaltyApiClient apiClient;
    private readonly ConfigService configService;
    
    public async Task InitializeAsync()
    {
        var config = configService.LoadConfig();
        
        try
        {
            // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸
            var response = await apiClient.PostAsync(
                "/api/pos-integration/rkeeper/first-connect",
                new
                {
                    installation_id = config.InstallationId,
                    terminal_name = config.TerminalName,
                    station_id = config.StationId,
                    machine_id = GetMachineId(),
                    os_version = Environment.OSVersion.ToString(),
                    plugin_version = GetPluginVersion(),
                    rkeeper_version = await DetectRKeeperVersion()
                }
            );
            
            if (response.Success)
            {
                // Backend Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ğ» ÑÑ‚Ğ°Ñ‚ÑƒÑ: PENDING_INSTALLATION â†’ ACTIVE
                logger.LogInformation("âœ… First connection successful");
                
                // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°
                var restaurantConfig = await apiClient.GetAsync<RestaurantConfig>(
                    "/api/pos-integration/rkeeper/config"
                );
                
                configService.SaveRestaurantConfig(restaurantConfig);
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to initialize");
            throw;
        }
    }
}
```

```typescript
// Backend: POST /api/pos-integration/rkeeper/first-connect

async handleFirstConnect(req: FirstConnectRequest) {
  const { installation_id, terminal_name, station_id, machine_id, plugin_version } = req;
  
  // 1. ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºÑƒ Ğ¿Ğ¾ ID
  const installation = await this.prisma.rKeeperPluginInstallation.findUnique({
    where: { id: installation_id }
  });
  
  if (!installation) {
    throw new NotFoundException('Installation not found');
  }
  
  // 2. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
  await this.prisma.rKeeperPluginInstallation.update({
    where: { id: installation_id },
    data: {
      status: 'ACTIVE',
      machineId: machine_id,
      pluginVersion: plugin_version,
      firstConnectedAt: new Date(),
      lastSeenAt: new Date()
    }
  });
  
  // 3. Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ
  await this.auditLog.create({
    type: 'RKEEPER_PLUGIN_ACTIVATED',
    tenantId: installation.tenantId,
    restaurantId: installation.restaurantId,
    metadata: { installation_id, terminal_name, station_id }
  });
  
  // 4. Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
  await this.notifications.send({
    to: installation.tenant.adminEmail,
    subject: `R-Keeper Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½: ${terminal_name}`,
    template: 'rkeeper-activated',
    data: { installation, terminal_name }
  });
  
  return { success: true };
}
```


***

ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ñ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ°Ğ¼Ğ¸ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ (4-18)?

---

# ğŸ“˜ **ĞŸĞĞ›ĞĞĞ¯ Ğ¡ĞŸĞ•Ğ¦Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ¯ - ĞŸĞ ĞĞ”ĞĞ›Ğ–Ğ•ĞĞ˜Ğ•**


***

## **ğŸ’» 4. EXTERNAL DLL Ğ¡ĞŸĞ•Ğ¦Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ¯**

### **4.1. Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹**

```cpp
// Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ: C++ Native DLL (Ğ¸Ğ»Ğ¸ C# Ñ‡ĞµÑ€ĞµĞ· C++/CLI)
// Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: Win32 DLL
// ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°: x86 Ğ¸Ğ»Ğ¸ x64 (Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ R-Keeper)
// Entry Point: DllMain
// Calling Convention: __stdcall
// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚: __declspec(dllexport)
```


### **4.2. Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ (Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾)**

#### **4.2.1. Initialize()**

```cpp
extern "C" __declspec(dllexport) int __stdcall Initialize(const char* configPath)
```

**ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ**: Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ DLL Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ FarCard Ğ¼Ğ¾Ğ´ÑƒĞ»ĞµĞ¼.

**ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹**:

- `configPath` - ĞŸÑƒÑ‚ÑŒ Ğº config.json (Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ `%AppData%\MaxLoyaltyRKeeper\config.json`)

**Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ**:

- `0` - Success
- `-1` - Error (Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³)
- `-2` - Error (Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ API Key)
- `-3` - Error (backend Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½)

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**:

```cpp
#include <Windows.h>
#include <string>
#include <fstream>
#include <memory>
#include "json.hpp"
#include "HttpClient.h"
#include "Logger.h"
#include "SharedMemory.h"

using json = nlohmann::json;

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
std::unique_ptr<HttpClient> g_httpClient;
std::unique_ptr<Logger> g_logger;
std::unique_ptr<SharedMemoryManager> g_sharedMemory;
std::string g_apiKey;
std::string g_backendUrl;
std::string g_installationId;
std::string g_tenantId;
std::string g_restaurantId;
std::string g_terminalId;

extern "C" __declspec(dllexport) int __stdcall Initialize(const char* configPath)
{
    try
    {
        // 1. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        std::string logPath = "C:\\Logs\\MaxLoyaltyRKeeper\\dll-";
        logPath += GetCurrentDate() + ".log";
        
        g_logger = std::make_unique<Logger>(logPath);
        g_logger->Info("MaxLoyaltyRKeeper.dll Initialize() called");
        g_logger->Info("Config path: " + std::string(configPath));
        
        // 2. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
        std::ifstream configFile(configPath);
        if (!configFile.is_open())
        {
            g_logger->Error("Failed to open config file: " + std::string(configPath));
            return -1;
        }
        
        json config;
        configFile >> config;
        configFile.close();
        
        // 3. Ğ Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²ĞºĞ° API Key
        std::string machineId = GetMachineId();
        g_apiKey = DecryptApiKey(config["api_key"].get<std::string>(), machineId);
        
        if (g_apiKey.empty())
        {
            g_logger->Error("Failed to decrypt API Key");
            return -2;
        }
        
        // 4. Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²
        g_backendUrl = config["backend_api_url"].get<std::string>();
        g_installationId = config["installation_id"].get<std::string>();
        g_tenantId = config["tenant_id"].get<std::string>();
        g_restaurantId = config["restaurant_id"].get<std::string>();
        g_terminalId = config["terminal_id"].get<std::string>();
        
        g_logger->Info("Backend URL: " + g_backendUrl);
        g_logger->Info("Installation ID: " + g_installationId);
        g_logger->Info("Terminal ID: " + g_terminalId);
        
        // 5. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ HTTP ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
        g_httpClient = std::make_unique<HttpClient>(g_backendUrl);
        g_httpClient->SetHeader("X-API-Key", g_apiKey);
        g_httpClient->SetHeader("X-Installation-Id", g_installationId);
        g_httpClient->SetHeader("X-Tenant-Id", g_tenantId);
        g_httpClient->SetHeader("X-Restaurant-Id", g_restaurantId);
        g_httpClient->SetHeader("X-Terminal-Id", g_terminalId);
        g_httpClient->SetTimeout(30000); // 30 ÑĞµĞºÑƒĞ½Ğ´
        
        // 6. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Shared Memory
        g_sharedMemory = std::make_unique<SharedMemoryManager>(
            "MaxLoyaltyRKeeperShared",
            1024 * 1024 // 1 MB
        );
        
        if (!g_sharedMemory->Open())
        {
            g_logger->Warning("Failed to open shared memory, creating new");
            g_sharedMemory->Create();
        }
        
        // 7. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº backend
        try
        {
            auto response = g_httpClient->Get("/api/health");
            if (response.statusCode == 200)
            {
                g_logger->Info("Backend connection: OK");
                g_sharedMemory->UpdateBackendStatus(true);
            }
            else
            {
                g_logger->Warning("Backend connection: Failed (status " + 
                    std::to_string(response.statusCode) + ")");
                g_sharedMemory->UpdateBackendStatus(false);
            }
        }
        catch (const std::exception& ex)
        {
            g_logger->Warning("Backend connection test failed: " + std::string(ex.what()));
            g_sharedMemory->UpdateBackendStatus(false);
        }
        
        // 8. Ğ£ÑĞ¿ĞµÑˆĞ½Ğ°Ñ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
        g_logger->Info("MaxLoyaltyRKeeper.dll initialized successfully");
        return 0;
    }
    catch (const std::exception& ex)
    {
        if (g_logger)
            g_logger->Error("Initialize() exception: " + std::string(ex.what()));
        return -1;
    }
}
```


#### **4.2.2. GetCardInfo()**

```cpp
extern "C" __declspec(dllexport) int __stdcall GetCardInfo(
    const char* cardNumber, 
    CardInfo* outInfo
)
```

**ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ**: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ ĞºĞ°Ñ€Ñ‚Ğµ Ğ³Ğ¾ÑÑ‚Ñ Ğ¿Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€Ñƒ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğ¸Ğ»Ğ¸ 6-digit ĞºĞ¾Ğ´Ñƒ.

**ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹**:

- `cardNumber` - ĞĞ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° (`+79991234567`) Ğ¸Ğ»Ğ¸ 6-digit ĞºĞ¾Ğ´ (`123456`)
- `outInfo` - Ğ£ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ° ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°

**Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ**:

- `0` - ĞšĞ°Ñ€Ñ‚Ğ° Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°
- `-1` - ĞšĞ°Ñ€Ñ‚Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°
- `-2` - ĞÑˆĞ¸Ğ±ĞºĞ° API
- `-3` - Backend offline

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**:

```cpp
extern "C" __declspec(dllexport) int __stdcall GetCardInfo(
    const char* cardNumber, 
    CardInfo* outInfo
)
{
    if (!cardNumber || !outInfo)
    {
        g_logger->Error("GetCardInfo: Invalid parameters");
        return -1;
    }
    
    g_logger->Info("GetCardInfo called: " + std::string(cardNumber));
    
    try
    {
        // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ¿Ğ¾Ğ¸ÑĞºĞ° (Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ´)
        std::string searchValue(cardNumber);
        bool isPhone = (searchValue.length() >= 10 && searchValue[0] == '+');
        
        // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ JSON Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
        json requestBody;
        if (isPhone)
            requestBody["phone"] = searchValue;
        else
            requestBody["code6Digit"] = searchValue;
        
        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ° backend
        auto response = g_httpClient->Post(
            "/api/pos-integration/rkeeper/search-guest",
            requestBody.dump()
        );
        
        if (response.statusCode != 200)
        {
            g_logger->Error("GetCardInfo: Backend returned " + 
                std::to_string(response.statusCode));
            return -2;
        }
        
        // ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚
        auto responseData = json::parse(response.body);
        
        if (!responseData["found"].get<bool>())
        {
            g_logger->Info("GetCardInfo: Guest not found");
            return -1;
        }
        
        auto guest = responseData["guest"];
        
        // Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ CardInfo
        ZeroMemory(outInfo, sizeof(CardInfo));
        
        strncpy_s(outInfo->guestName, 
            guest["name"].get<std::string>().c_str(), 
            255);
        
        strncpy_s(outInfo->phone, 
            guest["phone"].get<std::string>().c_str(), 
            31);
        
        strncpy_s(outInfo->cardId, 
            guest["cardId"].get<std::string>().c_str(), 
            63);
        
        strncpy_s(outInfo->levelName, 
            guest["levelName"].get<std::string>().c_str(), 
            127);
        
        outInfo->levelId = guest["levelId"].get<int>();
        outInfo->regularBalance = guest["regularBalance"].get<double>();
        outInfo->promoBalance = guest["promoBalance"].get<double>();
        outInfo->totalBalance = guest["totalBalance"].get<double>();
        
        if (guest.contains("code6Digit"))
        {
            strncpy_s(outInfo->code6Digit, 
                guest["code6Digit"].get<std::string>().c_str(), 
                7);
        }
        
        g_logger->Info("GetCardInfo: Success - " + guest["name"].get<std::string>());
        
        return 0;
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("GetCardInfo exception: " + std::string(ex.what()));
        return -2;
    }
}
```


#### **4.2.3. ReservePoints()**

```cpp
extern "C" __declspec(dllexport) int __stdcall ReservePoints(
    const char* cardId,
    double pointsToSpend,
    const char* orderId,
    char* outReservationId
)
```

**ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ**: Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² Ğ½Ğ° backend Ğ¿ĞµÑ€ĞµĞ´ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸ĞµĞ¼ Ğº Ğ·Ğ°ĞºĞ°Ğ·Ñƒ.

**ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹**:

- `cardId` - UUID ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ³Ğ¾ÑÑ‚Ñ
- `pointsToSpend` - ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ (Ğ² Ñ€ÑƒĞ±Ğ»ÑÑ…)
- `orderId` - ID Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ² R-Keeper
- `outReservationId` - Ğ‘ÑƒÑ„ĞµÑ€ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¸ (Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 64 Ğ±Ğ°Ğ¹Ñ‚Ğ°)

**Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ**:

- `0` - Success
- `-1` - ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²
- `-2` - ĞÑˆĞ¸Ğ±ĞºĞ° API
- `-3` - Backend offline

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**:

```cpp
extern "C" __declspec(dllexport) int __stdcall ReservePoints(
    const char* cardId,
    double pointsToSpend,
    const char* orderId,
    char* outReservationId
)
{
    if (!cardId || !orderId || !outReservationId || pointsToSpend <= 0)
    {
        g_logger->Error("ReservePoints: Invalid parameters");
        return -2;
    }
    
    g_logger->Info("ReservePoints: CardId=" + std::string(cardId) + 
        ", Points=" + std::to_string(pointsToSpend) + 
        ", OrderId=" + std::string(orderId));
    
    try
    {
        // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
        json requestBody = {
            {"guestCardId", cardId},
            {"pointsToSpend", pointsToSpend},
            {"orderId", orderId},
            {"restaurantId", g_restaurantId},
            {"terminalId", g_terminalId}
        };
        
        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ° backend
        auto response = g_httpClient->Post(
            "/api/pos-integration/rkeeper/reserve-points",
            requestBody.dump()
        );
        
        if (response.statusCode != 200)
        {
            g_logger->Error("ReservePoints: Backend returned " + 
                std::to_string(response.statusCode));
            return -2;
        }
        
        auto responseData = json::parse(response.body);
        
        if (!responseData["success"].get<bool>())
        {
            std::string error = responseData.value("error", "Unknown error");
            g_logger->Error("ReservePoints: " + error);
            
            if (error.find("Insufficient") != std::string::npos)
                return -1; // ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²
            
            return -2;
        }
        
        // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¸
        std::string reservationId = responseData["reservationId"].get<std::string>();
        strncpy_s(outReservationId, 64, reservationId.c_str(), 63);
        
        g_logger->Info("ReservePoints: Success - ReservationId=" + reservationId);
        
        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² shared memory
        g_sharedMemory->SaveOrderContext({
            std::string(orderId),
            std::string(cardId),
            reservationId,
            pointsToSpend,
            "POINTS",
            "SPEND"
        });
        
        return 0;
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("ReservePoints exception: " + std::string(ex.what()));
        return -2;
    }
}
```


#### **4.2.4. ReserveDiscount()**

```cpp
extern "C" __declspec(dllexport) int __stdcall ReserveDiscount(
    const char* cardId,
    double discountAmount,
    const char* orderId,
    char* outReservationId
)
```

**ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ**: Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ñ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ½Ğ° backend.

**ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹**:

- `cardId` - UUID ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ³Ğ¾ÑÑ‚Ñ
- `discountAmount` - Ğ¡ÑƒĞ¼Ğ¼Ğ° ÑĞºĞ¸Ğ´ĞºĞ¸ (Ğ² Ñ€ÑƒĞ±Ğ»ÑÑ…)
- `orderId` - ID Ğ·Ğ°ĞºĞ°Ğ·Ğ°
- `outReservationId` - Ğ‘ÑƒÑ„ĞµÑ€ Ğ´Ğ»Ñ ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¸

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**: ĞĞ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ° `ReservePoints`, Ğ½Ğ¾ endpoint `/reserve-discount`.

#### **4.2.5. FinalizeTransaction()**

```cpp
extern "C" __declspec(dllexport) int __stdcall FinalizeTransaction(
    const char* reservationId,
    double finalAmount,
    const char* orderId,
    const char* paymentTypesJson
)
```

**ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ**: Ğ¤Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ñ‡ĞµĞºĞ°. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ FarCard.

**ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹**:

- `reservationId` - ID Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ· Shared Memory
- `finalAmount` - Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ°
- `orderId` - ID Ğ·Ğ°ĞºĞ°Ğ·Ğ°
- `paymentTypesJson` - JSON Ğ¼Ğ°ÑÑĞ¸Ğ² Ñ‚Ğ¸Ğ¿Ğ¾Ğ² Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ `["CASH", "CARD"]`

**Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ**:

- `0` - Success
- `-1` - Error
- `-2` - Queued offline

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**:

```cpp
extern "C" __declspec(dllexport) int __stdcall FinalizeTransaction(
    const char* reservationId,
    double finalAmount,
    const char* orderId,
    const char* paymentTypesJson
)
{
    if (!reservationId || !orderId)
    {
        g_logger->Error("FinalizeTransaction: Invalid parameters");
        return -1;
    }
    
    g_logger->Info("FinalizeTransaction: OrderId=" + std::string(orderId) + 
        ", Amount=" + std::to_string(finalAmount));
    
    try
    {
        // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· shared memory
        auto context = g_sharedMemory->GetOrderContext(orderId);
        
        if (!context.has_value())
        {
            g_logger->Warning("FinalizeTransaction: No context for order " + 
                std::string(orderId));
            return 0; // ĞĞµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ½ĞµÑ‚ Ğ»Ğ¾ÑĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ½Ğ° ÑÑ‚Ğ¾Ğ¼ Ğ·Ğ°ĞºĞ°Ğ·Ğµ
        }
        
        // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
        json requestBody = {
            {"guestCardId", context->cardId},
            {"orderId", orderId},
            {"reservationId", reservationId},
            {"finalCheckAmount", finalAmount},
            {"originalCheckAmount", context->originalAmount},
            {"restaurantId", g_restaurantId},
            {"terminalId", g_terminalId},
            {"paymentTypes", json::parse(paymentTypesJson)}
        };
        
        std::string endpoint;
        
        if (context->benefitType == "POINTS")
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-points";
            requestBody["pointsSpent"] = context->amount;
            requestBody["pointsToEarn"] = context->earnAmount;
            requestBody["action"] = context->action;
        }
        else if (context->benefitType == "DISCOUNT")
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-discount";
            requestBody["discountAmount"] = context->amount;
            requestBody["discountPercentage"] = context->discountPercentage;
        }
        
        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ° backend
        auto response = g_httpClient->Post(endpoint, requestBody.dump());
        
        if (response.statusCode == 200)
        {
            auto responseData = json::parse(response.body);
            
            if (responseData["success"].get<bool>())
            {
                std::string txnId = responseData["transactionId"].get<std::string>();
                g_logger->Info("FinalizeTransaction: Success - TxnId=" + txnId);
                
                // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· shared memory
                g_sharedMemory->ClearOrderContext(orderId);
                
                // Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ UI Ğ¾Ğ± ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹ Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
                g_sharedMemory->NotifyUI("order_finalized", orderId);
                
                return 0;
            }
        }
        
        // Ğ•ÑĞ»Ğ¸ backend Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ - Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² offline queue
        g_logger->Warning("FinalizeTransaction: Backend unavailable, queueing...");
        
        g_sharedMemory->EnqueueOfflineOperation({
            "FINALIZE_" + context->benefitType,
            orderId,
            requestBody.dump(),
            GetCurrentTimestamp()
        });
        
        return -2; // Queued offline
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("FinalizeTransaction exception: " + std::string(ex.what()));
        return -1;
    }
}
```


#### **4.2.6. UpdateReservation()**

```cpp
extern "C" __declspec(dllexport) int __stdcall UpdateReservation(
    const char* reservationId,
    double newAmount
)
```

**ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ**: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¸ ĞµÑĞ»Ğ¸ ÑÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ°ÑÑŒ.

**Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ**: ĞšĞ¾Ğ³Ğ´Ğ° ĞºĞ°ÑÑĞ¸Ñ€ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ»/ÑƒĞ´Ğ°Ğ»Ğ¸Ğ» Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ»Ğ¾ÑĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸.

#### **4.2.7. CancelReservation()**

```cpp
extern "C" __declspec(dllexport) int __stdcall CancelReservation(
    const char* reservationId,
    const char* reason
)
```

**ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ**: ĞÑ‚Ğ¼ĞµĞ½Ğ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ğ¸.

**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹**:

- `USER_UNBIND` - ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ²ÑĞ·Ğ°Ğ» ĞºĞ°Ñ€Ñ‚Ñƒ
- `ORDER_CANCELLED` - Ğ—Ğ°ĞºĞ°Ğ· Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½


#### **4.2.8. Shutdown()**

```cpp
extern "C" __declspec(dllexport) void __stdcall Shutdown()
```

**ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ**: ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ DLL.

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**:

```cpp
extern "C" __declspec(dllexport) void __stdcall Shutdown()
{
    g_logger->Info("MaxLoyaltyRKeeper.dll Shutdown() called");
    
    try
    {
        // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ñ€ĞµÑÑƒÑ€ÑÑ‹
        g_httpClient.reset();
        g_sharedMemory.reset();
        
        g_logger->Info("Shutdown completed successfully");
        g_logger.reset();
    }
    catch (...)
    {
        // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¿Ñ€Ğ¸ shutdown
    }
}
```


### **4.3. Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…**

```cpp
// CardInfo.h
struct CardInfo
{
    char guestName[256];
    char phone[32];
    char cardId[64];          // UUID
    char levelName[128];
    int levelId;
    double regularBalance;
    double promoBalance;
    double totalBalance;
    char code6Digit[8];
};

// BenefitInfo.h
struct BenefitInfo
{
    int benefitType;          // 0=POINTS, 1=DISCOUNT
    double maxAllowedToSpend;
    double pointsToEarn;
    double discountPercentage;
    double discountAmount;
    double checkAmount;
    double minCheckAmount;
};

// OrderContext.h (Ğ² shared memory)
struct OrderContext
{
    char orderId[64];
    char guestCardId[64];
    char guestName[256];
    char guestPhone[32];
    int benefitType;          // 0=POINTS, 1=DISCOUNT
    int action;               // 0=SPEND, 1=EARN_ONLY, 2=APPLY_DISCOUNT
    double amount;            // pointsToSpend Ğ¸Ğ»Ğ¸ discountAmount
    double maxAllowed;
    double earnAmount;        // pointsToEarn
    double discountPercentage;
    char reservationId[64];
    double originalAmount;    // checkAmount
    long long appliedAt;      // Unix timestamp
    char stationId[64];
    char terminalId[64];
};

// OfflineOperation.h
struct OfflineOperation
{
    char id[64];
    char type[32];            // FINALIZE_POINTS, FINALIZE_DISCOUNT
    char orderId[64];
    char payload[4096];       // JSON string
    long long queuedAt;       // Unix timestamp
    int attempts;
};
```


### **4.4. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ² DLL**

```cpp
class ErrorHandler
{
public:
    static int HandleException(const std::exception& ex, const std::string& context)
    {
        g_logger->Error(context + " exception: " + ex.what());
        
        // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
        if (dynamic_cast<const HttpTimeoutException*>(&ex))
        {
            return ErrorCode::TIMEOUT;
        }
        else if (dynamic_cast<const NetworkException*>(&ex))
        {
            return ErrorCode::NETWORK_ERROR;
        }
        else if (dynamic_cast<const JsonParseException*>(&ex))
        {
            return ErrorCode::INVALID_RESPONSE;
        }
        
        return ErrorCode::UNKNOWN_ERROR;
    }
};

// Retry policy
class RetryPolicy
{
public:
    template<typename Func>
    static auto Execute(Func func, int maxAttempts = 3) -> decltype(func())
    {
        int attempt = 0;
        std::exception_ptr lastException;
        
        while (attempt < maxAttempts)
        {
            try
            {
                return func();
            }
            catch (const std::exception& ex)
            {
                lastException = std::current_exception();
                attempt++;
                
                if (attempt < maxAttempts)
                {
                    int delayMs = 1000 * std::pow(2, attempt - 1); // Exponential backoff
                    g_logger->Warning("Retry attempt " + std::to_string(attempt) + 
                        " after " + std::to_string(delayMs) + "ms");
                    Sleep(delayMs);
                }
            }
        }
        
        if (lastException)
            std::rethrow_exception(lastException);
        
        throw std::runtime_error("Unexpected retry failure");
    }
};
```


***

## **ğŸ¨ 5. UI ĞŸĞ Ğ˜Ğ›ĞĞ–Ğ•ĞĞ˜Ğ• Ğ¡ĞŸĞ•Ğ¦Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ¯**

### **5.1. Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° WPF**

```
MaxLoyaltyRKeeperUI/
â”œâ”€â”€ App.xaml                             # Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
â”œâ”€â”€ App.xaml.cs
â”‚
â”œâ”€â”€ Views/                               # ĞĞºĞ½Ğ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
â”‚   â”œâ”€â”€ FloatingButtonWindow.xaml        # ĞŸĞ»Ğ°Ğ²Ğ°ÑÑ‰Ğ°Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°
â”‚   â”œâ”€â”€ GuestSearchWindow.xaml           # ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾ÑÑ‚Ñ
â”‚   â”œâ”€â”€ PointsOperationWindow.xaml       # ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ Ğ±Ğ°Ğ»Ğ»Ğ°Ğ¼Ğ¸
â”‚   â”œâ”€â”€ DiscountOperationWindow.xaml     # ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ¾ ÑĞºĞ¸Ğ´ĞºĞ¾Ğ¹
â”‚   â”œâ”€â”€ CreateGuestWindow.xaml           # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ³Ğ¾ÑÑ‚Ñ
â”‚   â”œâ”€â”€ DiagnosticsWindow.xaml           # Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°
â”‚   â”œâ”€â”€ SettingsWindow.xaml              # ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
â”‚   â””â”€â”€ AboutWindow.xaml                 # Ğ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğµ
â”‚
â”œâ”€â”€ ViewModels/                          # View Models (MVVM)
â”‚   â”œâ”€â”€ ViewModelBase.cs
â”‚   â”œâ”€â”€ FloatingButtonViewModel.cs
â”‚   â”œâ”€â”€ GuestSearchViewModel.cs
â”‚   â”œâ”€â”€ PointsOperationViewModel.cs
â”‚   â”œâ”€â”€ DiscountOperationViewModel.cs
â”‚   â”œâ”€â”€ CreateGuestViewModel.cs
â”‚   â”œâ”€â”€ DiagnosticsViewModel.cs
â”‚   â””â”€â”€ SettingsViewModel.cs
â”‚
â”œâ”€â”€ UserControls/                        # ĞŸĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ñ‹
â”‚   â”œâ”€â”€ NumericKeyboard.xaml             # Ğ¦Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ°
â”‚   â”œâ”€â”€ AlphabeticKeyboard.xaml          # Ğ‘ÑƒĞºĞ²ĞµĞ½Ğ½Ğ°Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ°
â”‚   â”œâ”€â”€ LoadingOverlay.xaml              # Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
â”‚   â”œâ”€â”€ ErrorDialog.xaml                 # Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
â”‚   â”œâ”€â”€ SuccessNotification.xaml         # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑ…Ğ°
â”‚   â””â”€â”€ ConfirmDialog.xaml               # Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ
â”‚
â”œâ”€â”€ Services/                            # Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°
â”‚   â”œâ”€â”€ ILoyaltyApiClient.cs
â”‚   â”œâ”€â”€ LoyaltyApiClient.cs              # HTTP ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Backend API
â”‚   â”œâ”€â”€ IRKeeperXmlClient.cs
â”‚   â”œâ”€â”€ RKeeperXmlClient.cs              # ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ´Ğ»Ñ R-Keeper XML API
â”‚   â”œâ”€â”€ ISharedMemoryService.cs
â”‚   â”œâ”€â”€ SharedMemoryService.cs           # Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ shared memory
â”‚   â”œâ”€â”€ IOfflineQueueService.cs
â”‚   â”œâ”€â”€ OfflineQueueService.cs           # Offline Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ
â”‚   â”œâ”€â”€ IConfigService.cs
â”‚   â”œâ”€â”€ ConfigService.cs                 # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
â”‚   â”œâ”€â”€ ICacheService.cs
â”‚   â”œâ”€â”€ CacheService.cs                  # ĞšĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
â”‚   â”œâ”€â”€ IHealthCheckService.cs
â”‚   â”œâ”€â”€ HealthCheckService.cs            # ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ
â”‚   â”œâ”€â”€ IMetricsService.cs
â”‚   â”œâ”€â”€ MetricsService.cs                # Ğ¡Ğ±Ğ¾Ñ€ Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº
â”‚   â”œâ”€â”€ INotificationService.cs
â”‚   â”œâ”€â”€ NotificationService.cs           # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
â”‚   â””â”€â”€ INavigationService.cs
â”‚   â””â”€â”€ NavigationService.cs             # ĞĞ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¾ĞºĞ½Ğ°Ğ¼Ğ¸
â”‚
â”œâ”€â”€ Models/                              # ĞœĞ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
â”‚   â”œâ”€â”€ GuestInfo.cs
â”‚   â”œâ”€â”€ GuestCard.cs
â”‚   â”œâ”€â”€ LoyaltyLevel.cs
â”‚   â”œâ”€â”€ CalculateRequest.cs
â”‚   â”œâ”€â”€ CalculateResponse.cs
â”‚   â”œâ”€â”€ ReserveRequest.cs
â”‚   â”œâ”€â”€ ReserveResponse.cs
â”‚   â”œâ”€â”€ OrderContext.cs
â”‚   â”œâ”€â”€ RKeeperOrder.cs
â”‚   â”œâ”€â”€ RestaurantConfig.cs
â”‚   â”œâ”€â”€ OfflineOperation.cs
â”‚   â””â”€â”€ HealthStatus.cs
â”‚
â”œâ”€â”€ Utils/                               # Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹
â”‚   â”œâ”€â”€ Encryption.cs                    # Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ/Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²ĞºĞ°
â”‚   â”œâ”€â”€ ErrorHandler.cs                  # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
â”‚   â”œâ”€â”€ RetryPolicy.cs                   # Retry ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸
â”‚   â”œâ”€â”€ Validator.cs                     # Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
â”‚   â”œâ”€â”€ PhoneFormatter.cs                # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ¾Ğ²
â”‚   â””â”€â”€ DateTimeHelper.cs                # Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ´Ğ°Ñ‚Ğ°Ğ¼Ğ¸
â”‚
â”œâ”€â”€ Converters/                          # Value Converters Ğ´Ğ»Ñ XAML
â”‚   â”œâ”€â”€ BoolToVisibilityConverter.cs
â”‚   â”œâ”€â”€ InverseBoolConverter.cs
â”‚   â”œâ”€â”€ StatusToColorConverter.cs
â”‚   â”œâ”€â”€ AmountToStringConverter.cs
â”‚   â””â”€â”€ BenefitTypeToStringConverter.cs
â”‚
â”œâ”€â”€ Styles/                              # Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ¸ Ñ‚ĞµĞ¼Ñ‹
â”‚   â”œâ”€â”€ MaxLoyaltyStyles.xaml            # ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸
â”‚   â”œâ”€â”€ Colors.xaml                      # Ğ¦Ğ²ĞµÑ‚Ğ¾Ğ²Ğ°Ñ Ğ¿Ğ°Ğ»Ğ¸Ñ‚Ñ€Ğ°
â”‚   â”œâ”€â”€ Fonts.xaml                       # Ğ¨Ñ€Ğ¸Ñ„Ñ‚Ñ‹
â”‚   â””â”€â”€ Animations.xaml                  # ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ğ¸
â”‚
â””â”€â”€ Resources/                           # Ğ ĞµÑÑƒÑ€ÑÑ‹
    â”œâ”€â”€ Images/
    â”‚   â”œâ”€â”€ ML_Icon.png
    â”‚   â”œâ”€â”€ ML_Logo.png
    â”‚   â””â”€â”€ Icons/
    â””â”€â”€ Sounds/
        â”œâ”€â”€ click.wav
        â””â”€â”€ success.wav
```


### **5.2. App.xaml.cs - Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°**

```csharp
public partial class App : Application
{
    private IServiceProvider serviceProvider;
    private ILogger<App> logger;
    private FloatingButtonWindow floatingButton;
    private NotifyIcon trayIcon;
    
    protected override async void OnStartup(StartupEventArgs e)
    {
        base.OnStartup(e);
        
        try
        {
            // 1. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
            ConfigureLogging();
            
            // 2. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° DI ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
            serviceProvider = ConfigureServices();
            
            logger = serviceProvider.GetRequiredService<ILogger<App>>();
            logger.LogInformation("Max Loyalty RKeeper UI starting...");
            
            // 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞµĞ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€Ğ°
            if (!EnsureSingleInstance())
            {
                logger.LogWarning("Another instance is already running");
                Shutdown();
                return;
            }
            
            // 4. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
            var configService = serviceProvider.GetRequiredService<IConfigService>();
            var config = configService.LoadConfig();
            
            logger.LogInformation($"Installation ID: {config.InstallationId}");
            logger.LogInformation($"Terminal: {config.TerminalName}");
            
            // 5. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
            await InitializeServicesAsync();
            
            // 6. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ñ‚Ñ€ĞµÑ
            CreateTrayIcon();
            
            // 7. Ğ—Ğ°Ğ¿ÑƒÑĞº Floating Button
            ShowFloatingButton();
            
            // 8. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° offline Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
            ProcessOfflineQueueAsync();
            
            // 9. Ğ—Ğ°Ğ¿ÑƒÑĞº Health Check
            StartHealthMonitoring();
            
            logger.LogInformation("Max Loyalty RKeeper UI started successfully");
        }
        catch (Exception ex)
        {
            logger?.LogError(ex, "Failed to start application");
            MessageBox.Show(
                $"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ:\n{ex.Message}",
                "Max Loyalty - ĞÑˆĞ¸Ğ±ĞºĞ°",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
            Shutdown();
        }
    }
    
    private void ConfigureLogging()
    {
        Log.Logger = new LoggerConfiguration()
            .MinimumLevel.Information()
            .Enrich.WithProperty("Application", "MaxLoyaltyRKeeperUI")
            .Enrich.WithMachineName()
            .WriteTo.File(
                path: @"C:\Logs\MaxLoyaltyRKeeper\ui-.log",
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 7,
                outputTemplate: "[{Timestamp:yyyy-MM-dd HH:mm:ss}] [{Level:u3}] {Message:lj}{NewLine}{Exception}"
            )
            .CreateLogger();
    }
    
    private IServiceProvider ConfigureServices()
    {
        var services = new ServiceCollection();
        
        // Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
        services.AddLogging(builder =>
        {
            builder.AddSerilog(dispose: true);
        });
        
        // ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
        services.AddSingleton<IConfigService, ConfigService>();
        
        // HTTP ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹
        services.AddHttpClient<ILoyaltyApiClient, LoyaltyApiClient>()
            .AddPolicyHandler(GetRetryPolicy())
            .AddPolicyHandler(GetCircuitBreakerPolicy());
        
        services.AddSingleton<IRKeeperXmlClient, RKeeperXmlClient>();
        
        // Ğ¡ĞµÑ€Ğ²Ğ¸ÑÑ‹
        services.AddSingleton<ISharedMemoryService, SharedMemoryService>();
        services.AddSingleton<IOfflineQueueService, OfflineQueueService>();
        services.AddSingleton<ICacheService, CacheService>();
        services.AddSingleton<IHealthCheckService, HealthCheckService>();
        services.AddSingleton<IMetricsService, MetricsService>();
        services.AddSingleton<INotificationService, NotificationService>();
        services.AddSingleton<INavigationService, NavigationService>();
        
        // ViewModels
        services.AddTransient<FloatingButtonViewModel>();
        services.AddTransient<GuestSearchViewModel>();
        services.AddTransient<PointsOperationViewModel>();
        services.AddTransient<DiscountOperationViewModel>();
        services.AddTransient<CreateGuestViewModel>();
        services.AddTransient<DiagnosticsViewModel>();
        services.AddTransient<SettingsViewModel>();
        
        return services.BuildServiceProvider();
    }
    
    private IAsyncPolicy<HttpResponseMessage> GetRetryPolicy()
    {
        return HttpPolicyExtensions
            .HandleTransientHttpError()
            .WaitAndRetryAsync(
                retryCount: 3,
                sleepDurationProvider: retryAttempt => 
                    TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)),
                onRetry: (outcome, timespan, retryAttempt, context) =>
                {
                    logger?.LogWarning(
                        $"Retry {retryAttempt} after {timespan.TotalSeconds}s due to {outcome.Exception?.Message ?? outcome.Result.StatusCode.ToString()}"
                    );
                }
            );
    }
    
    private async Task InitializeServicesAsync()
    {
        // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Shared Memory
        var sharedMemory = serviceProvider.GetRequiredService<ISharedMemoryService>();
        await sharedMemory.InitializeAsync();
        
        // ĞŸĞµÑ€Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº backend
        var apiClient = serviceProvider.GetRequiredService<ILoyaltyApiClient>();
        try
        {
            await apiClient.SendFirstConnectAsync();
            logger.LogInformation("First connect successful");
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "First connect failed, will retry later");
        }
    }
    
    private void CreateTrayIcon()
    {
        trayIcon = new NotifyIcon
        {
            Icon = new System.Drawing.Icon(@"C:\MaxLoyalty\Resources\ML_Icon.ico"),
            Text = "Max Loyalty",
            Visible = true
        };
        
        var contextMenu = new ContextMenuStrip();
        contextMenu.Items.Add("ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Floating Button", null, (s, e) => ShowFloatingButton());
        contextMenu.Items.Add("Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°", null, (s, e) => ShowDiagnostics());
        contextMenu.Items.Add("ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸", null, (s, e) => ShowSettings());
        contextMenu.Items.Add("-");
        contextMenu.Items.Add("Ğ’Ñ‹Ñ…Ğ¾Ğ´", null, (s, e) => Shutdown());
        
        trayIcon.ContextMenuStrip = contextMenu;
        trayIcon.DoubleClick += (s, e) => ShowFloatingButton();
    }
    
    private void ShowFloatingButton()
    {
        if (floatingButton == null || !floatingButton.IsVisible)
        {
            var viewModel = serviceProvider.GetRequiredService<FloatingButtonViewModel>();
            floatingButton = new FloatingButtonWindow
            {
                DataContext = viewModel
            };
            floatingButton.Show();
        }
        else
        {
            floatingButton.Activate();
        }
    }
    
    private async void ProcessOfflineQueueAsync()
    {
        var offlineQueue = serviceProvider.GetRequiredService<IOfflineQueueService>();
        
        // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ
        await offlineQueue.ProcessQueueAsync();
        
        // Ğ—Ğ°Ñ‚ĞµĞ¼ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
        var timer = new System.Timers.Timer(5 * 60 * 1000); // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
        timer.Elapsed += async (s, e) => await offlineQueue.ProcessQueueAsync();
        timer.Start();
    }
    
    private void StartHealthMonitoring()
    {
        var healthCheck = serviceProvider.GetRequiredService<IHealthCheckService>();
        
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ
        var timer = new System.Timers.Timer(60 * 1000); // 1 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ğ°
        timer.Elapsed += async (s, e) =>
        {
            var status = await healthCheck.CheckHealthAsync();
            logger.LogInformation($"Health check: {status}");
        };
        timer.Start();
    }
    
    protected override void OnExit(ExitEventArgs e)
    {
        logger?.LogInformation("Max Loyalty RKeeper UI shutting down");
        
        floatingButton?.Close();
        trayIcon?.Dispose();
        
        Log.CloseAndFlush();
        
        base.OnExit(e);
    }
}
```

ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ñ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ°Ğ¼Ğ¸ (6-18)?

---

# ğŸ“˜ **ĞŸĞĞ›ĞĞĞ¯ Ğ¡ĞŸĞ•Ğ¦Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ¯ - ĞŸĞ ĞĞ”ĞĞ›Ğ–Ğ•ĞĞ˜Ğ• (Ñ‡Ğ°ÑÑ‚ÑŒ 2)**


***

## **ğŸ”˜ 6. FLOATING BUTTON**

### **6.1. FloatingButtonWindow.xaml**

```xaml
<Window x:Class="MaxLoyaltyRKeeperUI.Views.FloatingButtonWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Max Loyalty"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        Topmost="True"
        ShowInTaskbar="False"
        ResizeMode="NoResize"
        Width="60" Height="60"
        Loaded="Window_Loaded"
        MouseDown="Window_MouseDown"
        MouseMove="Window_MouseMove"
        MouseUp="Window_MouseUp"
        MouseEnter="Window_MouseEnter"
        MouseLeave="Window_MouseLeave">
    
    <Window.Resources>
        <!-- ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ğ¸ -->
        <Storyboard x:Key="PulseAnimation" RepeatBehavior="Forever">
            <DoubleAnimation Storyboard.TargetName="ActiveIndicator"
                           Storyboard.TargetProperty="Opacity"
                           From="0.3" To="1.0" Duration="0:0:1"
                           AutoReverse="True"/>
        </Storyboard>
        
        <Storyboard x:Key="ScaleUpAnimation">
            <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                           Storyboard.TargetProperty="ScaleX"
                           To="1.1" Duration="0:0:0.2"/>
            <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                           Storyboard.TargetProperty="ScaleY"
                           To="1.1" Duration="0:0:0.2"/>
        </Storyboard>
        
        <Storyboard x:Key="ScaleDownAnimation">
            <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                           Storyboard.TargetProperty="ScaleX"
                           To="1.0" Duration="0:0:0.2"/>
            <DoubleAnimation Storyboard.TargetName="ScaleTransform"
                           Storyboard.TargetProperty="ScaleY"
                           To="1.0" Duration="0:0:0.2"/>
        </Storyboard>
    </Window.Resources>
    
    <Grid>
        <Grid.RenderTransform>
            <ScaleTransform x:Name="ScaleTransform" 
                          ScaleX="1" ScaleY="1"
                          CenterX="30" CenterY="30"/>
        </Grid.RenderTransform>
        
        <!-- Ğ¢ĞµĞ½ÑŒ -->
        <Ellipse Width="60" Height="60">
            <Ellipse.Effect>
                <DropShadowEffect Color="Black" 
                                Direction="270" 
                                ShadowDepth="2" 
                                BlurRadius="10" 
                                Opacity="0.3"/>
            </Ellipse.Effect>
        </Ellipse>
        
        <!-- ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ° -->
        <Border x:Name="MainButton"
                Width="60" Height="60"
                CornerRadius="30"
                Background="#6366F1"
                Opacity="{Binding ButtonOpacity}">
            
            <!-- Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ ML -->
            <TextBlock Text="ML" 
                      FontSize="24" 
                      FontWeight="Bold"
                      Foreground="White"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center"/>
        </Border>
        
        <!-- Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ñ‹ -->
        <Ellipse x:Name="ActiveIndicator"
                Width="14" Height="14"
                Fill="#10B981"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Margin="0,3,3,0"
                Visibility="{Binding HasActiveCard, Converter={StaticResource BoolToVisibilityConverter}}"/>
        
        <!-- Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Drag Mode -->
        <Border x:Name="DragIndicator"
                Width="64" Height="64"
                CornerRadius="32"
                BorderBrush="#6366F1"
                BorderThickness="2"
                BorderDashArray="4 2"
                Visibility="Collapsed"/>
        
        <!-- ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ -->
        <Grid.ContextMenu>
            <ContextMenu>
                <MenuItem Header="ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾ÑÑ‚Ñ" 
                         Command="{Binding OpenSearchCommand}"/>
                <MenuItem Header="âŒ ĞÑ‚Ğ²ÑĞ·Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñƒ" 
                         Command="{Binding UnbindCardCommand}"
                         IsEnabled="{Binding HasActiveCard}"/>
                <Separator/>
                <MenuItem Header="ğŸ”§ Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°" 
                         Command="{Binding OpenDiagnosticsCommand}"/>
                <MenuItem Header="âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸" 
                         Command="{Binding OpenSettingsCommand}"/>
                <Separator/>
                <MenuItem Header="â„¹ï¸ Ğ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğµ" 
                         Command="{Binding OpenAboutCommand}"/>
                <MenuItem Header="âŒ Ğ’Ñ‹Ñ…Ğ¾Ğ´" 
                         Command="{Binding ExitCommand}"/>
            </ContextMenu>
        </Grid.ContextMenu>
    </Grid>
</Window>
```


### **6.2. FloatingButtonWindow.xaml.cs**

```csharp
public partial class FloatingButtonWindow : Window
{
    private readonly FloatingButtonViewModel viewModel;
    private readonly IConfigService configService;
    private readonly ILogger<FloatingButtonWindow> logger;
    
    private bool isDragging = false;
    private bool isLongPress = false;
    private DateTime mouseDownTime;
    private Point mouseDownPosition;
    private CancellationTokenSource longPressCts;
    
    public FloatingButtonWindow(
        FloatingButtonViewModel viewModel,
        IConfigService configService,
        ILogger<FloatingButtonWindow> logger)
    {
        InitializeComponent();
        
        this.viewModel = viewModel;
        this.configService = configService;
        this.logger = logger;
        
        DataContext = viewModel;
    }
    
    private void Window_Loaded(object sender, RoutedEventArgs e)
    {
        // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ¸Ğ· ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°
        LoadPosition();
        
        // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ğ° ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ°
        if (viewModel.HasActiveCard)
        {
            var storyboard = FindResource("PulseAnimation") as Storyboard;
            storyboard?.Begin();
        }
        
        logger.LogInformation("Floating button loaded at position ({0}, {1})", Left, Top);
    }
    
    private void Window_MouseDown(object sender, MouseButtonEventArgs e)
    {
        if (e.ChangedButton == MouseButton.Left)
        {
            mouseDownTime = DateTime.Now;
            mouseDownPosition = e.GetPosition(this);
            
            // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€ Ğ´Ğ»Ñ long press (1 ÑĞµĞºÑƒĞ½Ğ´Ğ°)
            longPressCts = new CancellationTokenSource();
            
            Task.Delay(1000, longPressCts.Token).ContinueWith(t =>
            {
                if (!t.IsCanceled && Mouse.LeftButton == MouseButtonState.Pressed)
                {
                    Dispatcher.Invoke(() =>
                    {
                        EnterDragMode();
                    });
                }
            });
        }
    }
    
    private void Window_MouseMove(object sender, MouseEventArgs e)
    {
        if (isDragging && e.LeftButton == MouseButtonState.Pressed)
        {
            // ĞŸĞµÑ€ĞµĞ¼ĞµÑ‰Ğ°ĞµĞ¼ Ğ¾ĞºĞ½Ğ¾
            var currentPosition = PointToScreen(e.GetPosition(this));
            Left = currentPosition.X - mouseDownPosition.X;
            Top = currentPosition.Y - mouseDownPosition.Y;
            
            // ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°Ğ¼Ğ¸ ÑĞºÑ€Ğ°Ğ½Ğ°
            ConstrainToScreen();
        }
        else if (e.LeftButton == MouseButtonState.Pressed)
        {
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¼Ñ‹ÑˆĞ¸ - ĞµÑĞ»Ğ¸ Ğ´Ğ²Ğ¸Ğ³Ğ°ĞµÑ‚ÑÑ, Ğ¾Ñ‚Ğ¼ĞµĞ½ÑĞµĞ¼ long press
            var currentPos = e.GetPosition(this);
            var distance = Math.Sqrt(
                Math.Pow(currentPos.X - mouseDownPosition.X, 2) + 
                Math.Pow(currentPos.Y - mouseDownPosition.Y, 2)
            );
            
            if (distance > 5) // 5px threshold
            {
                longPressCts?.Cancel();
            }
        }
    }
    
    private void Window_MouseUp(object sender, MouseButtonEventArgs e)
    {
        longPressCts?.Cancel();
        
        if (isDragging)
        {
            ExitDragMode();
            SavePosition();
        }
        else
        {
            // ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ»Ğ¸Ğº
            var clickDuration = (DateTime.Now - mouseDownTime).TotalMilliseconds;
            
            if (clickDuration < 500) // ĞœĞµĞ½ĞµĞµ 500ms = ĞºĞ»Ğ¸Ğº
            {
                OnSingleClick();
            }
        }
        
        isDragging = false;
    }
    
    private void Window_MouseEnter(object sender, MouseEventArgs e)
    {
        // ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ
        var storyboard = FindResource("ScaleUpAnimation") as Storyboard;
        storyboard?.Begin();
        
        // Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ opacity
        var opacityAnimation = new DoubleAnimation
        {
            To = 1.0,
            Duration = TimeSpan.FromMilliseconds(200)
        };
        MainButton.BeginAnimation(OpacityProperty, opacityAnimation);
    }
    
    private void Window_MouseLeave(object sender, MouseEventArgs e)
    {
        if (!isDragging)
        {
            // ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ ÑƒĞ¼ĞµĞ½ÑŒÑˆĞµĞ½Ğ¸Ñ
            var storyboard = FindResource("ScaleDownAnimation") as Storyboard;
            storyboard?.Begin();
            
            // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ opacity
            var opacityAnimation = new DoubleAnimation
            {
                To = viewModel.ButtonOpacity,
                Duration = TimeSpan.FromMilliseconds(200)
            };
            MainButton.BeginAnimation(OpacityProperty, opacityAnimation);
        }
    }
    
    private void OnSingleClick()
    {
        logger.LogInformation("Floating button clicked");
        
        // Ğ’Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ·Ğ²ÑƒĞº
        PlayClickSound();
        
        // ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ĞºĞ½Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ³Ğ¾ÑÑ‚Ñ
        viewModel.OpenSearchCommand?.Execute(null);
    }
    
    private void EnterDragMode()
    {
        isDragging = true;
        isLongPress = true;
        
        // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ drag mode
        DragIndicator.Visibility = Visibility.Visible;
        
        // Haptic feedback (Ğ²Ğ¸Ğ±Ñ€Ğ°Ñ†Ğ¸Ñ) ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ
        TriggerHapticFeedback();
        
        logger.LogInformation("Entered drag mode");
    }
    
    private void ExitDragMode()
    {
        DragIndicator.Visibility = Visibility.Collapsed;
        logger.LogInformation("Exited drag mode");
    }
    
    private void LoadPosition()
    {
        var config = configService.LoadConfig();
        var position = config.UiSettings.FloatingButtonPosition;
        
        switch (position)
        {
            case "TopLeft":
                Left = 20;
                Top = 20;
                break;
                
            case "TopCenter":
                Left = (SystemParameters.PrimaryScreenWidth - Width) / 2;
                Top = 20;
                break;
                
            case "TopRight":
                Left = SystemParameters.PrimaryScreenWidth - Width - 20;
                Top = 20;
                break;
                
            case "MiddleLeft":
                Left = 20;
                Top = (SystemParameters.PrimaryScreenHeight - Height) / 2;
                break;
                
            case "MiddleRight":
                Left = SystemParameters.PrimaryScreenWidth - Width - 20;
                Top = (SystemParameters.PrimaryScreenHeight - Height) / 2;
                break;
                
            case "BottomLeft":
                Left = 20;
                Top = SystemParameters.PrimaryScreenHeight - Height - 80;
                break;
                
            case "BottomCenter":
                Left = (SystemParameters.PrimaryScreenWidth - Width) / 2;
                Top = SystemParameters.PrimaryScreenHeight - Height - 80;
                break;
                
            case "BottomRight":
                Left = SystemParameters.PrimaryScreenWidth - Width - 20;
                Top = SystemParameters.PrimaryScreenHeight - Height - 80;
                break;
                
            case "Custom":
                Left = config.UiSettings.CustomX;
                Top = config.UiSettings.CustomY;
                break;
                
            default:
                // ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ TopRight
                Left = SystemParameters.PrimaryScreenWidth - Width - 20;
                Top = 20;
                break;
        }
        
        ConstrainToScreen();
    }
    
    private void SavePosition()
    {
        var config = configService.LoadConfig();
        config.UiSettings.FloatingButtonPosition = "Custom";
        config.UiSettings.CustomX = Left;
        config.UiSettings.CustomY = Top;
        configService.SaveConfig(config);
        
        logger.LogInformation("Saved new position: ({0}, {1})", Left, Top);
    }
    
    private void ConstrainToScreen()
    {
        // ĞĞµ Ğ´Ğ°ĞµĞ¼ Ğ²Ñ‹Ğ¹Ñ‚Ğ¸ Ğ·Ğ° Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ ÑĞºÑ€Ğ°Ğ½Ğ°
        if (Left < 0) Left = 0;
        if (Top < 0) Top = 0;
        if (Left + Width > SystemParameters.PrimaryScreenWidth)
            Left = SystemParameters.PrimaryScreenWidth - Width;
        if (Top + Height > SystemParameters.PrimaryScreenHeight)
            Top = SystemParameters.PrimaryScreenHeight - Height;
    }
    
    private void PlayClickSound()
    {
        var config = configService.LoadConfig();
        if (config.UiSettings.SoundsEnabled)
        {
            try
            {
                var player = new System.Media.SoundPlayer(@"C:\MaxLoyalty\Resources\Sounds\click.wav");
                player.Play();
            }
            catch (Exception ex)
            {
                logger.LogWarning(ex, "Failed to play click sound");
            }
        }
    }
    
    private void TriggerHapticFeedback()
    {
        var config = configService.LoadConfig();
        if (config.UiSettings.VibrationEnabled)
        {
            // Ğ”Ğ»Ñ Windows Ğ½ĞµÑ‚ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¾Ğ¹ Ğ²Ğ¸Ğ±Ñ€Ğ°Ñ†Ğ¸Ğ¸, Ğ½Ğ¾ Ğ¼Ğ¾Ğ¶ĞµĞ¼ ÑĞ¼ÑƒĞ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Ğ·Ğ²ÑƒĞº
            SystemSounds.Beep.Play();
        }
    }
}
```


### **6.3. FloatingButtonViewModel.cs**

```csharp
public class FloatingButtonViewModel : ViewModelBase
{
    private readonly ISharedMemoryService sharedMemoryService;
    private readonly INavigationService navigationService;
    private readonly ILogger<FloatingButtonViewModel> logger;
    
    private bool hasActiveCard;
    private double buttonOpacity;
    
    public bool HasActiveCard
    {
        get => hasActiveCard;
        set => SetProperty(ref hasActiveCard, value);
    }
    
    public double ButtonOpacity
    {
        get => buttonOpacity;
        set => SetProperty(ref buttonOpacity, value);
    }
    
    public ICommand OpenSearchCommand { get; }
    public ICommand UnbindCardCommand { get; }
    public ICommand OpenDiagnosticsCommand { get; }
    public ICommand OpenSettingsCommand { get; }
    public ICommand OpenAboutCommand { get; }
    public ICommand ExitCommand { get; }
    
    public FloatingButtonViewModel(
        ISharedMemoryService sharedMemoryService,
        INavigationService navigationService,
        IConfigService configService,
        ILogger<FloatingButtonViewModel> logger)
    {
        this.sharedMemoryService = sharedMemoryService;
        this.navigationService = navigationService;
        this.logger = logger;
        
        // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ opacity Ğ¸Ğ· ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°
        var config = configService.LoadConfig();
        ButtonOpacity = config.UiSettings.FloatingButtonOpacity;
        
        // Commands
        OpenSearchCommand = new RelayCommand(OpenSearch);
        UnbindCardCommand = new RelayCommand(UnbindCard, () => HasActiveCard);
        OpenDiagnosticsCommand = new RelayCommand(OpenDiagnostics);
        OpenSettingsCommand = new RelayCommand(OpenSettings);
        OpenAboutCommand = new RelayCommand(OpenAbout);
        ExitCommand = new RelayCommand(Exit);
        
        // ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ÑÑ Ğ½Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² Shared Memory
        sharedMemoryService.ActiveOrdersChanged += OnActiveOrdersChanged;
        
        // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
        UpdateActiveCardStatus();
    }
    
    private void OpenSearch()
    {
        logger.LogInformation("Opening guest search window");
        navigationService.NavigateTo<GuestSearchWindow>();
    }
    
    private async void UnbindCard()
    {
        var result = MessageBox.Show(
            "ĞÑ‚Ğ²ÑĞ·Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ¾Ñ‚ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğ°?",
            "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ",
            MessageBoxButton.YesNo,
            MessageBoxImage.Question
        );
        
        if (result == MessageBoxResult.Yes)
        {
            try
            {
                await sharedMemoryService.UnbindActiveCardAsync();
                HasActiveCard = false;
                logger.LogInformation("Card unbound successfully");
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "Failed to unbind card");
                MessageBox.Show(
                    "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ²ÑĞ·Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñƒ",
                    "ĞÑˆĞ¸Ğ±ĞºĞ°",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error
                );
            }
        }
    }
    
    private void OpenDiagnostics()
    {
        navigationService.NavigateTo<DiagnosticsWindow>();
    }
    
    private void OpenSettings()
    {
        navigationService.NavigateTo<SettingsWindow>();
    }
    
    private void OpenAbout()
    {
        navigationService.NavigateTo<AboutWindow>();
    }
    
    private void Exit()
    {
        var result = MessageBox.Show(
            "Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹ Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ²Ñ‹Ğ¹Ñ‚Ğ¸?\n\n" +
            "Max Loyalty Ğ¿ĞµÑ€ĞµÑÑ‚Ğ°Ğ½ĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ½Ğ° ÑÑ‚Ğ¾Ğ¹ ĞºĞ°ÑÑĞµ.",
            "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ°",
            MessageBoxButton.YesNo,
            MessageBoxImage.Warning
        );
        
        if (result == MessageBoxResult.Yes)
        {
            Application.Current.Shutdown();
        }
    }
    
    private void OnActiveOrdersChanged(object sender, EventArgs e)
    {
        UpdateActiveCardStatus();
    }
    
    private async void UpdateActiveCardStatus()
    {
        var activeOrders = await sharedMemoryService.GetActiveOrdersAsync();
        HasActiveCard = activeOrders.Any();
    }
}
```


***

## **ğŸ” 7. ĞĞšĞĞ Ğ˜ WORKFLOW**

### **7.1. GuestSearchWindow (ĞĞºĞ½Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ³Ğ¾ÑÑ‚Ñ)**

#### **7.1.1. GuestSearchWindow.xaml**

```xaml
<Window x:Class="MaxLoyaltyRKeeperUI.Views.GuestSearchWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:MaxLoyaltyRKeeperUI.UserControls"
        Title="Max Loyalty - ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾ÑÑ‚Ñ"
        Width="600" Height="900"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize"
        Topmost="True"
        ShowInTaskbar="False"
        Background="White">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Tabs -->
            <RowDefinition Height="Auto"/> <!-- Input -->
            <RowDefinition Height="Auto"/> <!-- Keyboard -->
            <RowDefinition Height="Auto"/> <!-- Orders -->
            <RowDefinition Height="Auto"/> <!-- Actions -->
            <RowDefinition Height="Auto"/> <!-- Footer -->
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" Background="#F9FAFB" Padding="20" BorderBrush="#E5E7EB" BorderThickness="0,0,0,1">
            <Grid>
                <TextBlock Text="MAX LOYALTY" 
                          FontSize="28" FontWeight="Bold"
                          VerticalAlignment="Center"/>
                <Button Content="âœ•" 
                       Width="40" Height="40"
                       HorizontalAlignment="Right"
                       Style="{StaticResource CloseButtonStyle}"
                       Command="{Binding CloseCommand}"/>
            </Grid>
        </Border>
        
        <!-- Tabs -->
        <Border Grid.Row="1" Padding="20,10" Background="White">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <Button Grid.Column="0" 
                       Content="Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½"
                       Height="50"
                       Style="{StaticResource TabButtonStyle}"
                       Command="{Binding SwitchToPhoneCommand}"
                       Background="{Binding IsPhoneTab, Converter={StaticResource TabBackgroundConverter}}"/>
                
                <Button Grid.Column="1" 
                       Content="6-Ğ·Ğ½Ğ°Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´"
                       Height="50"
                       Style="{StaticResource TabButtonStyle}"
                       Command="{Binding SwitchToCodeCommand}"
                       Background="{Binding IsCodeTab, Converter={StaticResource TabBackgroundConverter}}"/>
            </Grid>
        </Border>
        
        <!-- Input Field -->
        <Border Grid.Row="2" Padding="20">
            <Border BorderBrush="{Binding InputBorderBrush}" 
                   BorderThickness="2"
                   CornerRadius="8"
                   Padding="15">
                <TextBlock Text="{Binding DisplayValue}" 
                          FontSize="24"
                          TextAlignment="Center"
                          Foreground="{Binding InputForeground}"/>
            </Border>
        </Border>
        
        <!-- Numeric Keyboard -->
        <Border Grid.Row="3" Padding="20,0,20,20">
            <controls:NumericKeyboard 
                DisplayValue="{Binding SearchQuery, Mode=TwoWay}"
                MaxLength="{Binding MaxInputLength}"
                HasMaxButton="False"/>
        </Border>
        
        <!-- Active Orders -->
        <Border Grid.Row="4" Padding="20,0,20,20" 
               Visibility="{Binding HasActiveOrders, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel>
                <TextBlock Text="ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹:" 
                          FontSize="16" FontWeight="SemiBold"
                          Margin="0,0,0,10"/>
                
                <ItemsControl ItemsSource="{Binding ActiveOrders}" MaxHeight="200">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="#F9FAFB" 
                                   CornerRadius="8" 
                                   Padding="15" 
                                   Margin="0,0,0,10">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="{Binding DisplayName}" 
                                                  FontSize="16" FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding Amount, StringFormat={}{0:N2} â‚½}" 
                                                  FontSize="14" Foreground="#666"/>
                                    </StackPanel>
                                    
                                    <Button Grid.Column="1" 
                                           Content="Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ"
                                           Width="100" Height="40"
                                           Command="{Binding DataContext.SelectOrderCommand, 
                                                    RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                           CommandParameter="{Binding}"
                                           Style="{StaticResource PrimaryButtonStyle}"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Border>
        
        <!-- Action Buttons -->
        <Border Grid.Row="5" Padding="20">
            <StackPanel>
                <Button Content="ğŸ” ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ³Ğ¾ÑÑ‚Ñ"
                       Height="70"
                       FontSize="18"
                       Command="{Binding SearchGuestCommand}"
                       Style="{StaticResource PrimaryButtonStyle}"
                       Margin="0,0,0,10"/>
                
                <Button Content="â• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾"
                       Height="70"
                       FontSize="18"
                       Command="{Binding CreateGuestCommand}"
                       Style="{StaticResource SecondaryButtonStyle}"/>
            </StackPanel>
        </Border>
        
        <!-- Footer -->
        <Border Grid.Row="6" 
               Background="#F9FAFB" 
               Padding="20" 
               BorderBrush="#E5E7EB" 
               BorderThickness="0,1,0,0"
               Visibility="{Binding SelectedOrder, Converter={StaticResource NullToVisibilityConverter}}">
            <TextBlock FontSize="18" TextAlignment="Center">
                <Run Text="Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ°: "/>
                <Run Text="{Binding SelectedOrder.Amount, StringFormat={}{0:N2} â‚½}" 
                     FontWeight="Bold"/>
            </TextBlock>
        </Border>
        
        <!-- Loading Overlay -->
        <controls:LoadingOverlay Grid.RowSpan="7"
                                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"
                                Message="{Binding LoadingMessage}"/>
    </Grid>
</Window>
```


#### **7.1.2. GuestSearchViewModel.cs**

```csharp
public class GuestSearchViewModel : ViewModelBase
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly IRKeeperXmlClient rkeeperClient;
    private readonly INavigationService navigationService;
    private readonly ILogger<GuestSearchViewModel> logger;
    
    private string searchQuery;
    private bool isPhoneTab = true;
    private bool isLoading;
    private string loadingMessage;
    private ObservableCollection<RKeeperOrder> activeOrders;
    private RKeeperOrder selectedOrder;
    
    public string SearchQuery
    {
        get => searchQuery;
        set
        {
            SetProperty(ref searchQuery, value);
            OnPropertyChanged(nameof(DisplayValue));
            OnPropertyChanged(nameof(InputBorderBrush));
            ValidateInput();
        }
    }
    
    public bool IsPhoneTab
    {
        get => isPhoneTab;
        set
        {
            SetProperty(ref isPhoneTab, value);
            OnPropertyChanged(nameof(IsCodeTab));
            OnPropertyChanged(nameof(MaxInputLength));
            OnPropertyChanged(nameof(DisplayValue));
        }
    }
    
    public bool IsCodeTab => !IsPhoneTab;
    
    public int MaxInputLength => IsPhoneTab ? 11 : 6;
    
    public string DisplayValue
    {
        get
        {
            if (string.IsNullOrEmpty(SearchQuery))
                return IsPhoneTab ? "+7 (___) ___-__-__" : "______";
            
            if (IsPhoneTab)
                return FormatPhoneNumber(SearchQuery);
            else
                return SearchQuery;
        }
    }
    
    public Brush InputBorderBrush
    {
        get
        {
            if (string.IsNullOrEmpty(SearchQuery))
                return new SolidColorBrush(Color.FromRgb(229, 231, 235)); // #E5E7EB
            
            if (IsValid)
                return new SolidColorBrush(Color.FromRgb(16, 185, 129)); // #10B981 green
            else
                return new SolidColorBrush(Color.FromRgb(239, 68, 68)); // #EF4444 red
        }
    }
    
    public bool IsLoading
    {
        get => isLoading;
        set => SetProperty(ref isLoading, value);
    }
    
    public string LoadingMessage
    {
        get => loadingMessage;
        set => SetProperty(ref loadingMessage, value);
    }
    
    public ObservableCollection<RKeeperOrder> ActiveOrders
    {
        get => activeOrders;
        set
        {
            SetProperty(ref activeOrders, value);
            OnPropertyChanged(nameof(HasActiveOrders));
        }
    }
    
    public bool HasActiveOrders => ActiveOrders?.Any() ?? false;
    
    public RKeeperOrder SelectedOrder
    {
        get => selectedOrder;
        set => SetProperty(ref selectedOrder, value);
    }
    
    private bool IsValid { get; set; }
    
    public ICommand SwitchToPhoneCommand { get; }
    public ICommand SwitchToCodeCommand { get; }
    public ICommand SearchGuestCommand { get; }
    public ICommand CreateGuestCommand { get; }
    public ICommand SelectOrderCommand { get; }
    public ICommand CloseCommand { get; }
    
    public GuestSearchViewModel(
        ILoyaltyApiClient apiClient,
        IRKeeperXmlClient rkeeperClient,
        INavigationService navigationService,
        ILogger<GuestSearchViewModel> logger)
    {
        this.apiClient = apiClient;
        this.rkeeperClient = rkeeperClient;
        this.navigationService = navigationService;
        this.logger = logger;
        
        SwitchToPhoneCommand = new RelayCommand(() => IsPhoneTab = true);
        SwitchToCodeCommand = new RelayCommand(() => IsPhoneTab = false);
        SearchGuestCommand = new AsyncRelayCommand(SearchGuestAsync, CanSearch);
        CreateGuestCommand = new RelayCommand(CreateGuest);
        SelectOrderCommand = new RelayCommand<RKeeperOrder>(SelectOrder);
        CloseCommand = new RelayCommand(Close);
        
        // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²
        LoadActiveOrdersAsync();
    }
    
    private async Task LoadActiveOrdersAsync()
    {
        try
        {
            var orders = await rkeeperClient.GetOrderListAsync();
            ActiveOrders = new ObservableCollection<RKeeperOrder>(orders);
            
            // ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ ĞµÑĞ»Ğ¸ Ğ¾Ğ´Ğ¸Ğ½
            if (orders.Count == 1)
            {
                SelectedOrder = orders[0];
            }
            
            logger.LogInformation($"Loaded {orders.Count} active orders");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to load active orders");
            // ĞĞµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹
        }
    }
    
    private void ValidateInput()
    {
        if (string.IsNullOrEmpty(SearchQuery))
        {
            IsValid = false;
            return;
        }
        
        if (IsPhoneTab)
        {
            // Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° (11 Ñ†Ğ¸Ñ„Ñ€, Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ +7)
            var digits = new string(SearchQuery.Where(char.IsDigit).ToArray());
            IsValid = digits.Length == 11 && digits.StartsWith("7");
        }
        else
        {
            // Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ 6-digit ĞºĞ¾Ğ´Ğ°
            IsValid = SearchQuery.Length == 6 && SearchQuery.All(char.IsDigit);
        }
        
        OnPropertyChanged(nameof(InputBorderBrush));
        (SearchGuestCommand as AsyncRelayCommand)?.RaiseCanExecuteChanged();
    }
    
    private bool CanSearch()
    {
        return IsValid && SelectedOrder != null && !IsLoading;
    }
    
    private async Task SearchGuestAsync()
    {
        IsLoading = true;
        LoadingMessage = "ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾ÑÑ‚Ñ...";
        
        try
        {
            logger.LogInformation($"Searching guest: {SearchQuery}, OrderId: {SelectedOrder.Id}");
            
            // 1. ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾ÑÑ‚Ñ
            var searchRequest = new SearchGuestRequest
            {
                Phone = IsPhoneTab ? SearchQuery : null,
                Code6Digit = IsCodeTab ? SearchQuery : null
            };
            
            var searchResponse = await apiClient.SearchGuestAsync(searchRequest);
            
            if (!searchResponse.Found)
            {
                IsLoading = false;
                
                var result = MessageBox.Show(
                    "Ğ“Ğ¾ÑÑ‚ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.\n\nĞ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ³Ğ¾ÑÑ‚Ñ?",
                    "Ğ“Ğ¾ÑÑ‚ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½",
                    MessageBoxButton.YesNo,
                    MessageBoxImage.Question
                );
                
                if (result == MessageBoxResult.Yes)
                {
                    CreateGuest();
                }
                
                return;
            }
            
            var guest = searchResponse.Guest;
            logger.LogInformation($"Guest found: {guest.Name} ({guest.CardId})");
            
            // 2. Calculate
            LoadingMessage = "Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ±ĞµĞ½ĞµÑ„Ğ¸Ñ‚Ğ¾Ğ²...";
            
            var calculateRequest = new CalculateRequest
            {
                GuestCardId = guest.CardId,
                CheckAmount = SelectedOrder.Amount,
                OrderCategories = SelectedOrder.Categories,
                OrderType = SelectedOrder.Type,
                CalculateOnly = true
            };
            
            var calculateResponse = await apiClient.CalculateAsync(calculateRequest);
            
            logger.LogInformation($"Calculate result: {calculateResponse.BenefitType}");
            
            IsLoading = false;
            
            // 3. ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ĞºĞ½Ğ¾ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
            OpenOperationWindow(guest, calculateResponse);
        }
        catch (HttpRequestException ex)
        {
            IsLoading = false;
            logger.LogError(ex, "Network error during search");
            
            MessageBox.Show(
                "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚Ñƒ.",
                "ĞÑˆĞ¸Ğ±ĞºĞ°",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
        catch (Exception ex)
        {
            IsLoading = false;
            logger.LogError(ex, "Failed to search guest");
            
            MessageBox.Show(
                $"ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:\n{ex.Message}",
                "ĞÑˆĞ¸Ğ±ĞºĞ°",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
    
    private void OpenOperationWindow(GuestInfo guest, CalculateResponse calculateResult)
    {
        if (calculateResult.BenefitType == "POINTS")
        {
            navigationService.NavigateTo<PointsOperationWindow>(new
            {
                Guest = guest,
                CalculateResult = calculateResult,
                SelectedOrder = SelectedOrder
            });
        }
        else if (calculateResult.BenefitType == "DISCOUNT")
        {
            navigationService.NavigateTo<DiscountOperationWindow>(new
            {
                Guest = guest,
                CalculateResult = calculateResult,
                SelectedOrder = SelectedOrder
            });
        }
        
        // Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ĞºĞ½Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºĞ°
        Close();
    }
    
    private void CreateGuest()
    {
        navigationService.NavigateTo<CreateGuestWindow>(new
        {
            InitialPhone = IsPhoneTab ? SearchQuery : null,
            SelectedOrder = SelectedOrder
        });
        
        Close();
    }
    
    private void SelectOrder(RKeeperOrder order)
    {
        SelectedOrder = order;
        logger.LogInformation($"Order selected: {order.Id} ({order.Amount:N2}â‚½)");
    }
    
    private void Close()
    {
        (Application.Current.MainWindow as Window)?.Close();
    }
    
    private string FormatPhoneNumber(string input)
    {
        var digits = new string(input.Where(char.IsDigit).ToArray());
        
        if (digits.Length == 0)
            return "+7 (___) ___-__-__";
        
        if (digits.Length <= 1)
            return $"+{digits} (___) ___-__-__";
        
        if (digits.Length <= 4)
            return $"+{digits[0]} ({digits.Substring(1)}___)  ___-__-__";
        
        if (digits.Length <= 7)
            return $"+{digits[0]} ({digits.Substring(1, 3)}) {digits.Substring(4)}___-__-__";
        
        if (digits.Length <= 9)
            return $"+{digits[0]} ({digits.Substring(1, 3)}) {digits.Substring(4, 3)}-{digits.Substring(7)}__-__";
        
        return $"+{digits[0]} ({digits.Substring(1, 3)}) {digits.Substring(4, 3)}-{digits.Substring(7, 2)}-{digits.Substring(9, 2)}";
    }
}
```

ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ñ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¾ĞºĞ½Ğ°Ğ¼Ğ¸ Ğ¸ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ°Ğ¼Ğ¸ (7.2-18)?

---

# ğŸ“˜ **ĞŸĞĞ›ĞĞĞ¯ Ğ¡ĞŸĞ•Ğ¦Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ¯ - ĞŸĞ ĞĞ”ĞĞ›Ğ–Ğ•ĞĞ˜Ğ• (Ñ‡Ğ°ÑÑ‚ÑŒ 3)**


***

### **7.2. PointsOperationWindow (ĞĞºĞ½Ğ¾ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ±Ğ°Ğ»Ğ»Ğ°Ğ¼Ğ¸)**

#### **7.2.1. PointsOperationWindow.xaml**

```xaml
<Window x:Class="MaxLoyaltyRKeeperUI.Views.PointsOperationWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:MaxLoyaltyRKeeperUI.UserControls"
        Title="Max Loyalty - Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²"
        Width="600" Height="1000"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize"
        Topmost="True"
        ShowInTaskbar="False"
        Background="White">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Guest Info -->
            <RowDefinition Height="Auto"/> <!-- Balance -->
            <RowDefinition Height="Auto"/> <!-- Check Info -->
            <RowDefinition Height="Auto"/> <!-- Input -->
            <RowDefinition Height="Auto"/> <!-- Keyboard -->
            <RowDefinition Height="Auto"/> <!-- Earn Info -->
            <RowDefinition Height="Auto"/> <!-- Actions -->
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" Background="#6366F1" Padding="20">
            <Grid>
                <TextBlock Text="Ğ¡ĞŸĞ˜Ğ¡ĞĞĞ˜Ğ• Ğ‘ĞĞ›Ğ›ĞĞ’" 
                          FontSize="24" FontWeight="Bold"
                          Foreground="White"
                          VerticalAlignment="Center"/>
                <Button Content="âœ•" 
                       Width="40" Height="40"
                       HorizontalAlignment="Right"
                       Style="{StaticResource CloseButtonWhiteStyle}"
                       Command="{Binding CloseCommand}"/>
            </Grid>
        </Border>
        
        <!-- Guest Info -->
        <Border Grid.Row="1" Background="#F9FAFB" Padding="20" BorderBrush="#E5E7EB" BorderThickness="0,0,0,1">
            <StackPanel>
                <TextBlock FontSize="20" FontWeight="SemiBold">
                    <Run Text="ğŸ‘¤"/>
                    <Run Text="{Binding Guest.Name}"/>
                </TextBlock>
                <TextBlock FontSize="16" Foreground="#666" Margin="0,5,0,0">
                    <Run Text="ğŸ“±"/>
                    <Run Text="{Binding Guest.Phone}"/>
                </TextBlock>
                <Border Background="{Binding LevelColor}" 
                       CornerRadius="12" 
                       Padding="12,6"
                       HorizontalAlignment="Left"
                       Margin="0,10,0,0">
                    <TextBlock Text="{Binding Guest.LevelName}" 
                              FontSize="14" FontWeight="SemiBold"
                              Foreground="White"/>
                </Border>
            </StackPanel>
        </Border>
        
        <!-- Balance -->
        <Border Grid.Row="2" Padding="20">
            <Border Background="#EEF2FF" 
                   BorderBrush="#6366F1" 
                   BorderThickness="2"
                   CornerRadius="12" 
                   Padding="20">
                <StackPanel>
                    <TextBlock Text="ğŸ’° Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ" 
                              FontSize="16" 
                              Foreground="#4338CA"
                              HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding Guest.TotalBalance, StringFormat={}{0:N2} â‚½}" 
                              FontSize="36" 
                              FontWeight="Bold"
                              Foreground="#6366F1"
                              HorizontalAlignment="Center"
                              Margin="0,10,0,0"/>
                    
                    <!-- Ğ Ğ°Ğ·Ğ±Ğ¸Ğ²ĞºĞ° regular/promo ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ -->
                    <StackPanel Orientation="Horizontal" 
                               HorizontalAlignment="Center"
                               Margin="0,10,0,0"
                               Visibility="{Binding HasPromoBalance, Converter={StaticResource BoolToVisibilityConverter}}">
                        <TextBlock FontSize="14" Foreground="#666">
                            <Run Text="ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ:"/>
                            <Run Text="{Binding Guest.RegularBalance, StringFormat={}{0:N2}}" FontWeight="SemiBold"/>
                            <Run Text=" â€¢ ĞŸÑ€Ğ¾Ğ¼Ğ¾:"/>
                            <Run Text="{Binding Guest.PromoBalance, StringFormat={}{0:N2}}" FontWeight="SemiBold"/>
                        </TextBlock>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Border>
        
        <!-- Check Info -->
        <Border Grid.Row="3" Padding="20,0,20,20">
            <StackPanel>
                <Grid Margin="0,0,0,5">
                    <TextBlock Text="Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸:" FontSize="16"/>
                    <TextBlock Text="{Binding CheckAmount, StringFormat={}{0:N2} â‚½}" 
                              FontSize="16" FontWeight="SemiBold"
                              HorizontalAlignment="Right"/>
                </Grid>
                
                <Grid>
                    <TextBlock Text="Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğº ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ:" FontSize="16" Foreground="#059669"/>
                    <TextBlock Text="{Binding MaxAllowed, StringFormat={}{0:N2} â‚½}" 
                              FontSize="16" FontWeight="Bold"
                              Foreground="#059669"
                              HorizontalAlignment="Right"/>
                </Grid>
                
                <!-- ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ ĞµÑĞ»Ğ¸ Ğ¼Ğ°Ğ»Ğ¾ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² -->
                <Border Background="#FEF3C7" 
                       BorderBrush="#F59E0B" 
                       BorderThickness="1"
                       CornerRadius="8" 
                       Padding="12"
                       Margin="0,10,0,0"
                       Visibility="{Binding ShowLowBalanceWarning, Converter={StaticResource BoolToVisibilityConverter}}">
                    <TextBlock FontSize="14" Foreground="#92400E" TextWrapping="Wrap">
                        <Run Text="âš ï¸"/>
                        <Run Text="{Binding LowBalanceMessage}"/>
                    </TextBlock>
                </Border>
            </StackPanel>
        </Border>
        
        <!-- Input Field -->
        <Border Grid.Row="4" Padding="20,0,20,20">
            <Border BorderBrush="{Binding InputBorderBrush}" 
                   BorderThickness="3"
                   CornerRadius="8"
                   Padding="20">
                <Grid>
                    <TextBlock Text="Ğ¡Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²:" 
                              FontSize="16" 
                              Foreground="#666"
                              VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding PointsToSpendDisplay}" 
                              FontSize="32"
                              FontWeight="Bold"
                              HorizontalAlignment="Right"
                              VerticalAlignment="Center"
                              Foreground="{Binding InputTextColor}"/>
                </Grid>
            </Border>
        </Border>
        
        <!-- Numeric Keyboard -->
        <Border Grid.Row="5" Padding="20,0,20,20">
            <controls:NumericKeyboard 
                DisplayValue="{Binding PointsToSpendInput, Mode=TwoWay}"
                MaxValue="{Binding MaxAllowed}"
                HasMaxButton="True"
                MaxButtonCommand="{Binding SetMaxCommand}"/>
        </Border>
        
        <!-- Earn Info -->
        <Border Grid.Row="6" Padding="20,0,20,20">
            <Border Background="#D1FAE5" 
                   BorderBrush="#10B981" 
                   BorderThickness="1"
                   CornerRadius="8" 
                   Padding="15">
                <TextBlock FontSize="16" TextAlignment="Center">
                    <Run Text="Ğ‘ÑƒĞ´ĞµÑ‚ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾:" Foreground="#065F46"/>
                    <Run Text="{Binding PointsToEarn, StringFormat=+{0}}" 
                         FontWeight="Bold" 
                         FontSize="20"
                         Foreground="#059669"/>
                    <Run Text="Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²" Foreground="#065F46"/>
                </TextBlock>
            </Border>
        </Border>
        
        <!-- Action Buttons -->
        <Border Grid.Row="7" Padding="20">
            <StackPanel>
                <!-- Ğ¡Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ»Ñ‹ -->
                <Button Height="70" 
                       FontSize="18"
                       Command="{Binding ApplyPointsCommand}"
                       Style="{StaticResource PrimaryButtonStyle}"
                       Margin="0,0,0,10">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="ğŸ’³ " FontSize="24" VerticalAlignment="Center"/>
                        <TextBlock Text="Ğ¡Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ»Ñ‹" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
                
                <!-- Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»Ğ¸Ñ‚ÑŒ -->
                <Button Height="60" 
                       FontSize="16"
                       Command="{Binding EarnOnlyCommand}"
                       Style="{StaticResource SecondaryButtonStyle}"
                       Margin="0,0,0,10">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="â• " FontSize="20" VerticalAlignment="Center"/>
                        <TextBlock Text="Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»Ğ¸Ñ‚ÑŒ" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
                
                <!-- ĞÑ‚Ğ²ÑĞ·Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñƒ -->
                <Button Height="50" 
                       FontSize="14"
                       Command="{Binding UnbindCardCommand}"
                       Style="{StaticResource DangerButtonStyle}">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="âŒ " FontSize="18" VerticalAlignment="Center"/>
                        <TextBlock Text="ĞÑ‚Ğ²ÑĞ·Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñƒ" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Border>
        
        <!-- Loading Overlay -->
        <controls:LoadingOverlay Grid.RowSpan="8"
                                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"
                                Message="{Binding LoadingMessage}"/>
    </Grid>
</Window>
```


#### **7.2.2. PointsOperationViewModel.cs**

```csharp
public class PointsOperationViewModel : ViewModelBase
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly IRKeeperXmlClient rkeeperClient;
    private readonly ISharedMemoryService sharedMemoryService;
    private readonly IMetricsService metricsService;
    private readonly ILogger<PointsOperationViewModel> logger;
    
    private GuestInfo guest;
    private CalculateResponse calculateResult;
    private RKeeperOrder selectedOrder;
    private string pointsToSpendInput;
    private bool isLoading;
    private string loadingMessage;
    
    public GuestInfo Guest
    {
        get => guest;
        set => SetProperty(ref guest, value);
    }
    
    public decimal CheckAmount => selectedOrder?.Amount ?? 0;
    
    public decimal MaxAllowed => (decimal)(calculateResult?.MaxAllowedToSpend ?? 0);
    
    public decimal PointsToEarn => (decimal)(calculateResult?.PointsToEarn ?? 0);
    
    public string PointsToSpendInput
    {
        get => pointsToSpendInput;
        set
        {
            SetProperty(ref pointsToSpendInput, value);
            OnPropertyChanged(nameof(PointsToSpendDisplay));
            OnPropertyChanged(nameof(InputBorderBrush));
            OnPropertyChanged(nameof(InputTextColor));
            ValidateInput();
        }
    }
    
    public string PointsToSpendDisplay
    {
        get
        {
            if (string.IsNullOrEmpty(PointsToSpendInput))
                return "0";
            
            if (decimal.TryParse(PointsToSpendInput, out var value))
                return value.ToString("N0");
            
            return PointsToSpendInput;
        }
    }
    
    public Brush InputBorderBrush
    {
        get
        {
            if (string.IsNullOrEmpty(PointsToSpendInput))
                return new SolidColorBrush(Color.FromRgb(229, 231, 235)); // Gray
            
            if (IsValidAmount)
                return new SolidColorBrush(Color.FromRgb(99, 102, 241)); // Indigo
            else
                return new SolidColorBrush(Color.FromRgb(239, 68, 68)); // Red
        }
    }
    
    public Brush InputTextColor
    {
        get
        {
            if (!IsValidAmount && !string.IsNullOrEmpty(PointsToSpendInput))
                return Brushes.Red;
            
            return new SolidColorBrush(Color.FromRgb(31, 41, 55)); // Gray-800
        }
    }
    
    public bool ShowLowBalanceWarning => Guest.TotalBalance < MaxAllowed;
    
    public string LowBalanceMessage
    {
        get
        {
            if (Guest.TotalBalance == 0)
                return "Ğ£ Ğ³Ğ¾ÑÑ‚Ñ Ğ½ĞµÑ‚ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ². ĞœĞ¾Ğ¶Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»Ğ¸Ñ‚ÑŒ.";
            
            return $"Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ ({Guest.TotalBalance:N2}â‚½) Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾Ğ¹ ÑÑƒĞ¼Ğ¼Ñ‹ ({MaxAllowed:N2}â‚½)";
        }
    }
    
    public bool HasPromoBalance => Guest.PromoBalance > 0;
    
    public Brush LevelColor
    {
        get
        {
            // Ğ¦Ğ²ĞµÑ‚Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ¹
            return Guest.LevelId switch
            {
                1 => new SolidColorBrush(Color.FromRgb(107, 114, 128)), // Gray - Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚
                2 => new SolidColorBrush(Color.FromRgb(251, 191, 36)),  // Yellow - Ğ¡ĞµÑ€ĞµĞ±Ñ€Ğ¾
                3 => new SolidColorBrush(Color.FromRgb(251, 146, 60)),  // Orange - Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ¾
                4 => new SolidColorBrush(Color.FromRgb(147, 51, 234)),  // Purple - ĞŸĞ»Ğ°Ñ‚Ğ¸Ğ½Ğ°
                _ => new SolidColorBrush(Color.FromRgb(99, 102, 241))   // Indigo - default
            };
        }
    }
    
    public bool IsLoading
    {
        get => isLoading;
        set => SetProperty(ref isLoading, value);
    }
    
    public string LoadingMessage
    {
        get => loadingMessage;
        set => SetProperty(ref loadingMessage, value);
    }
    
    private bool IsValidAmount { get; set; }
    
    public ICommand SetMaxCommand { get; }
    public ICommand ApplyPointsCommand { get; }
    public ICommand EarnOnlyCommand { get; }
    public ICommand UnbindCardCommand { get; }
    public ICommand CloseCommand { get; }
    
    public PointsOperationViewModel(
        ILoyaltyApiClient apiClient,
        IRKeeperXmlClient rkeeperClient,
        ISharedMemoryService sharedMemoryService,
        IMetricsService metricsService,
        ILogger<PointsOperationViewModel> logger)
    {
        this.apiClient = apiClient;
        this.rkeeperClient = rkeeperClient;
        this.sharedMemoryService = sharedMemoryService;
        this.metricsService = metricsService;
        this.logger = logger;
        
        SetMaxCommand = new RelayCommand(SetMax);
        ApplyPointsCommand = new AsyncRelayCommand(ApplyPointsAsync, CanApplyPoints);
        EarnOnlyCommand = new AsyncRelayCommand(EarnOnlyAsync);
        UnbindCardCommand = new RelayCommand(UnbindCard);
        CloseCommand = new RelayCommand(Close);
    }
    
    public void Initialize(GuestInfo guest, CalculateResponse calculateResult, RKeeperOrder selectedOrder)
    {
        this.guest = guest;
        this.calculateResult = calculateResult;
        this.selectedOrder = selectedOrder;
        
        OnPropertyChanged(nameof(Guest));
        OnPropertyChanged(nameof(CheckAmount));
        OnPropertyChanged(nameof(MaxAllowed));
        OnPropertyChanged(nameof(PointsToEarn));
        OnPropertyChanged(nameof(ShowLowBalanceWarning));
        OnPropertyChanged(nameof(LowBalanceMessage));
        OnPropertyChanged(nameof(HasPromoBalance));
        OnPropertyChanged(nameof(LevelColor));
        
        logger.LogInformation(
            "Points operation initialized: Guest={GuestName}, Check={CheckAmount}, MaxAllowed={MaxAllowed}",
            guest.Name, CheckAmount, MaxAllowed
        );
    }
    
    private void SetMax()
    {
        var max = Math.Min(MaxAllowed, (decimal)Guest.TotalBalance);
        PointsToSpendInput = max.ToString("0");
        logger.LogInformation("Set MAX: {Amount}", max);
    }
    
    private void ValidateInput()
    {
        if (string.IsNullOrEmpty(PointsToSpendInput))
        {
            IsValidAmount = false;
            return;
        }
        
        if (!decimal.TryParse(PointsToSpendInput, out var value))
        {
            IsValidAmount = false;
            return;
        }
        
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
        IsValidAmount = value > 0 && 
                       value <= MaxAllowed && 
                       value <= (decimal)Guest.TotalBalance;
        
        (ApplyPointsCommand as AsyncRelayCommand)?.RaiseCanExecuteChanged();
    }
    
    private bool CanApplyPoints()
    {
        return IsValidAmount && !IsLoading;
    }
    
    private async Task ApplyPointsAsync()
    {
        var pointsToSpend = decimal.Parse(PointsToSpendInput);
        
        logger.LogInformation(
            "Applying points: Amount={Amount}, OrderId={OrderId}",
            pointsToSpend, selectedOrder.Id
        );
        
        IsLoading = true;
        LoadingMessage = "Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²...";
        
        try
        {
            // 1. Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° backend
            var reserveRequest = new ReservePointsRequest
            {
                GuestCardId = Guest.CardId,
                PointsToSpend = (double)pointsToSpend,
                MaxAllowed = (double)MaxAllowed,
                CheckAmount = (double)CheckAmount,
                OrderId = selectedOrder.Id
            };
            
            var reserveResponse = await apiClient.ReservePointsAsync(reserveRequest);
            
            if (!reserveResponse.Success)
            {
                IsLoading = false;
                MessageBox.Show(
                    reserveResponse.Error ?? "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ»Ñ‹",
                    "ĞÑˆĞ¸Ğ±ĞºĞ°",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error
                );
                return;
            }
            
            LoadingMessage = "ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğº Ğ·Ğ°ĞºĞ°Ğ·Ñƒ...";
            
            // 2. ĞŸÑ€Ğ¸Ğ²ÑĞ·ĞºĞ° ĞºĞ°Ñ€Ñ‚Ñ‹ Ğº Ğ·Ğ°ĞºĞ°Ğ·Ñƒ Ñ‡ĞµÑ€ĞµĞ· R-Keeper XML
            await rkeeperClient.BindCardToOrderAsync(
                selectedOrder.Id,
                Guest.Phone
            );
            
            // 3. ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ½Ğ° ÑÑƒĞ¼Ğ¼Ñƒ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²
            await rkeeperClient.ApplyManualDiscountAsync(
                selectedOrder.Id,
                pointsToSpend,
                $"Max Loyalty - Ğ‘Ğ°Ğ»Ğ»Ñ‹ ({Guest.Name})"
            );
            
            // 4. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° Ğ² Shared Memory
            await sharedMemoryService.SaveOrderContextAsync(new OrderContext
            {
                OrderId = selectedOrder.Id,
                GuestCardId = Guest.CardId,
                GuestName = Guest.Name,
                GuestPhone = Guest.Phone,
                BenefitType = BenefitType.Points,
                Action = LoyaltyAction.Spend,
                PointsToSpend = (double)pointsToSpend,
                MaxAllowed = (double)MaxAllowed,
                PointsToEarn = (double)PointsToEarn,
                ReservationId = reserveResponse.ReservationId,
                OriginalCheckAmount = (double)CheckAmount,
                AppliedAt = DateTime.UtcNow,
                StationId = selectedOrder.StationId,
                TerminalId = Environment.MachineName
            });
            
            // 5. ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸
            await metricsService.RecordMetricAsync("loyalty.points.applied", (double)pointsToSpend);
            
            IsLoading = false;
            
            // 6. Success notification
            ShowSuccessNotification(
                $"âœ… Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ {pointsToSpend:N0}â‚½ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¾\n\n" +
                $"Ğ‘ÑƒĞ´ĞµÑ‚ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾: +{PointsToEarn} Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²\n\n" +
                $"ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ±Ğ°Ğ»Ğ»Ñ‹ ÑĞ¿Ğ¸ÑˆÑƒÑ‚ÑÑ Ñ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ³Ğ¾ÑÑ‚Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸."
            );
            
            logger.LogInformation("Points applied successfully");
            
            // Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ĞºĞ½Ğ¾ Ñ‡ĞµÑ€ĞµĞ· 2 ÑĞµĞºÑƒĞ½Ğ´Ñ‹
            await Task.Delay(2000);
            Close();
        }
        catch (Exception ex)
        {
            IsLoading = false;
            logger.LogError(ex, "Failed to apply points");
            
            MessageBox.Show(
                $"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²:\n{ex.Message}",
                "ĞÑˆĞ¸Ğ±ĞºĞ°",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
    
    private async Task EarnOnlyAsync()
    {
        logger.LogInformation("Earn only mode: OrderId={OrderId}", selectedOrder.Id);
        
        IsLoading = true;
        LoadingMessage = "ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ...";
        
        try
        {
            // Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ñ Ñ pointsToSpend = 0 (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğµ)
            var reserveRequest = new ReservePointsRequest
            {
                GuestCardId = Guest.CardId,
                PointsToSpend = 0,
                MaxAllowed = 0,
                CheckAmount = (double)CheckAmount,
                OrderId = selectedOrder.Id,
                Action = "EARN_ONLY"
            };
            
            var reserveResponse = await apiClient.ReservePointsAsync(reserveRequest);
            
            if (!reserveResponse.Success)
            {
                IsLoading = false;
                MessageBox.Show(
                    reserveResponse.Error ?? "ĞÑˆĞ¸Ğ±ĞºĞ°",
                    "ĞÑˆĞ¸Ğ±ĞºĞ°",
                    MessageBoxButton.OK,
                    MessageBoxImage.Error
                );
                return;
            }
            
            // ĞŸÑ€Ğ¸Ğ²ÑĞ·ĞºĞ° ĞºĞ°Ñ€Ñ‚Ñ‹
            await rkeeperClient.BindCardToOrderAsync(selectedOrder.Id, Guest.Phone);
            
            // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
            await sharedMemoryService.SaveOrderContextAsync(new OrderContext
            {
                OrderId = selectedOrder.Id,
                GuestCardId = Guest.CardId,
                GuestName = Guest.Name,
                GuestPhone = Guest.Phone,
                BenefitType = BenefitType.Points,
                Action = LoyaltyAction.EarnOnly,
                PointsToSpend = 0,
                PointsToEarn = (double)PointsToEarn,
                ReservationId = reserveResponse.ReservationId,
                OriginalCheckAmount = (double)CheckAmount,
                AppliedAt = DateTime.UtcNow
            });
            
            await metricsService.RecordMetricAsync("loyalty.earn_only", (double)PointsToEarn);
            
            IsLoading = false;
            
            ShowSuccessNotification(
                $"âœ… ĞšĞ°Ñ€Ñ‚Ğ° Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½Ğ° Ğº Ğ·Ğ°ĞºĞ°Ğ·Ñƒ\n\n" +
                $"ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ±ÑƒĞ´ĞµÑ‚ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾ +{PointsToEarn} Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²"
            );
            
            logger.LogInformation("Earn only applied successfully");
            
            await Task.Delay(2000);
            Close();
        }
        catch (Exception ex)
        {
            IsLoading = false;
            logger.LogError(ex, "Failed to apply earn only");
            
            MessageBox.Show(
                $"ĞÑˆĞ¸Ğ±ĞºĞ°:\n{ex.Message}",
                "ĞÑˆĞ¸Ğ±ĞºĞ°",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
    
    private void UnbindCard()
    {
        var result = MessageBox.Show(
            "ĞÑ‚Ğ²ÑĞ·Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ¾Ñ‚ Ğ·Ğ°ĞºĞ°Ğ·Ğ°?",
            "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ",
            MessageBoxButton.YesNo,
            MessageBoxImage.Question
        );
        
        if (result == MessageBoxResult.Yes)
        {
            logger.LogInformation("Card unbound by user");
            Close();
        }
    }
    
    private void Close()
    {
        Application.Current.Windows.OfType<PointsOperationWindow>().FirstOrDefault()?.Close();
    }
    
    private void ShowSuccessNotification(string message)
    {
        var notification = new SuccessNotification
        {
            Message = message,
            Owner = Application.Current.MainWindow
        };
        notification.ShowDialog();
    }
}
```


***

### **7.3. DiscountOperationWindow (ĞĞºĞ½Ğ¾ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ÑĞ¾ ÑĞºĞ¸Ğ´ĞºĞ¾Ğ¹)**

**Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ° PointsOperationWindow**, Ğ½Ğ¾ Ñ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ¸ÑĞ¼Ğ¸:

```csharp
// ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ¸Ñ Ğ² ViewModel:

public decimal DiscountPercentage => (decimal)(calculateResult?.DiscountPercentage ?? 0);
public decimal DiscountAmount => (decimal)(calculateResult?.DiscountAmount ?? 0);

// Ğ’Ğ¼ĞµÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ğ° - Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞºĞ¸Ğ´ĞºÑƒ
public string DiscountDisplay => $"{DiscountPercentage:N0}% ÑĞºĞ¸Ğ´ĞºĞ° = {DiscountAmount:N2} â‚½";

// ĞœĞµÑ‚Ğ¾Ğ´ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ:
private async Task ApplyDiscountAsync()
{
    var reserveRequest = new ReserveDiscountRequest
    {
        GuestCardId = Guest.CardId,
        DiscountAmount = (double)DiscountAmount,
        DiscountPercentage = (double)DiscountPercentage,
        CheckAmount = (double)CheckAmount,
        OrderId = selectedOrder.Id
    };
    
    var reserveResponse = await apiClient.ReserveDiscountAsync(reserveRequest);
    
    // ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ½ÑƒÑ ÑĞºĞ¸Ğ´ĞºÑƒ Ğ² R-Keeper
    await rkeeperClient.ApplyPercentDiscountAsync(
        selectedOrder.Id,
        DiscountPercentage,
        $"Max Loyalty - {DiscountPercentage:N0}% ({Guest.LevelName})"
    );
    
    // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚
    await sharedMemoryService.SaveOrderContextAsync(new OrderContext
    {
        OrderId = selectedOrder.Id,
        GuestCardId = Guest.CardId,
        BenefitType = BenefitType.Discount,
        Action = LoyaltyAction.ApplyDiscount,
        DiscountAmount = (double)DiscountAmount,
        DiscountPercentage = (double)DiscountPercentage,
        ReservationId = reserveResponse.ReservationId,
        OriginalCheckAmount = (double)CheckAmount,
        AppliedAt = DateTime.UtcNow
    });
}
```


***

## **âŒ¨ï¸ 8. Ğ­ĞšĞ ĞĞĞĞ«Ğ• ĞšĞ›ĞĞ’Ğ˜ĞĞ¢Ğ£Ğ Ğ«**

### **8.1. NumericKeyboard.xaml**

```xaml
<UserControl x:Class="MaxLoyaltyRKeeperUI.UserControls.NumericKeyboard"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    
    <UserControl.Resources>
        <Style x:Key="KeyButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="#E5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                               BorderBrush="{TemplateBinding BorderBrush}"
                               BorderThickness="{TemplateBinding BorderThickness}"
                               CornerRadius="8">
                            <ContentPresenter HorizontalAlignment="Center"
                                            VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#F3F4F6"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#E5E7EB"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <Style x:Key="MaxButtonStyle" TargetType="Button" BasedOn="{StaticResource KeyButtonStyle}">
            <Setter Property="Background" Value="#10B981"/>
            <Setter Property="Foreground" Value="White"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#059669"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>
    
    <Grid Width="350" Height="400">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        
        <!-- Row 1: 1, 2, 3 -->
        <Button Grid.Row="0" Grid.Column="0" Content="1" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="1"
               Margin="5"/>
        <Button Grid.Row="0" Grid.Column="1" Content="2" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="2"
               Margin="5"/>
        <Button Grid.Row="0" Grid.Column="2" Content="3" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="3"
               Margin="5"/>
        
        <!-- Row 2: 4, 5, 6 -->
        <Button Grid.Row="1" Grid.Column="0" Content="4" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="4"
               Margin="5"/>
        <Button Grid.Row="1" Grid.Column="1" Content="5" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="5"
               Margin="5"/>
        <Button Grid.Row="1" Grid.Column="2" Content="6" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="6"
               Margin="5"/>
        
        <!-- Row 3: 7, 8, 9 -->
        <Button Grid.Row="2" Grid.Column="0" Content="7" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="7"
               Margin="5"/>
        <Button Grid.Row="2" Grid.Column="1" Content="8" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="8"
               Margin="5"/>
        <Button Grid.Row="2" Grid.Column="2" Content="9" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="9"
               Margin="5"/>
        
        <!-- Row 4: â†, 0, MAX/âœ“ -->
        <Button Grid.Row="3" Grid.Column="0" Content="â†" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding BackspaceCommand}"
               Margin="5"/>
        <Button Grid.Row="3" Grid.Column="1" Content="0" 
               Style="{StaticResource KeyButtonStyle}"
               Command="{Binding KeyPressCommand}" CommandParameter="0"
               Margin="5"/>
        <Button Grid.Row="3" Grid.Column="2" 
               Content="{Binding ThirdButtonContent}"
               Style="{Binding ThirdButtonStyle}"
               Command="{Binding ThirdButtonCommand}"
               Margin="5"/>
    </Grid>
</UserControl>
```


### **8.2. NumericKeyboardViewModel.cs**

```csharp
public class NumericKeyboardViewModel : ViewModelBase
{
    private string displayValue = "";
    private int maxLength = 10;
    private decimal? maxValue;
    private bool hasMaxButton;
    
    public string DisplayValue
    {
        get => displayValue;
        set
        {
            SetProperty(ref displayValue, value);
            InputChanged?.Invoke(this, value);
        }
    }
    
    public int MaxLength
    {
        get => maxLength;
        set => SetProperty(ref maxLength, value);
    }
    
    public decimal? MaxValue
    {
        get => maxValue;
        set => SetProperty(ref maxValue, value);
    }
    
    public bool HasMaxButton
    {
        get => hasMaxButton;
        set
        {
            SetProperty(ref hasMaxButton, value);
            OnPropertyChanged(nameof(ThirdButtonContent));
            OnPropertyChanged(nameof(ThirdButtonStyle));
        }
    }
    
    public string ThirdButtonContent => HasMaxButton ? "MAX" : "âœ“";
    
    public Style ThirdButtonStyle
    {
        get
        {
            if (HasMaxButton)
                return Application.Current.FindResource("MaxButtonStyle") as Style;
            else
                return Application.Current.FindResource("KeyButtonStyle") as Style;
        }
    }
    
    public ICommand KeyPressCommand { get; }
    public ICommand BackspaceCommand { get; }
    public ICommand ThirdButtonCommand { get; }
    public ICommand MaxButtonCommand { get; set; } // Ğ’Ğ½ĞµÑˆĞ½ÑÑ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°
    
    public event EventHandler<string> InputChanged;
    public event EventHandler ConfirmPressed;
    
    public NumericKeyboardViewModel()
    {
        KeyPressCommand = new RelayCommand<string>(OnKeyPress);
        BackspaceCommand = new RelayCommand(OnBackspace);
        ThirdButtonCommand = new RelayCommand(OnThirdButton);
    }
    
    private void OnKeyPress(string key)
    {
        if (DisplayValue.Length >= MaxLength)
            return;
        
        // ĞĞµ Ğ´Ğ°ĞµĞ¼ Ğ²Ğ²ĞµÑÑ‚Ğ¸ Ğ²ĞµĞ´ÑƒÑ‰Ğ¸Ğ¹ Ğ½Ğ¾Ğ»ÑŒ
        if (DisplayValue == "" && key == "0")
            return;
        
        DisplayValue += key;
        PlayClickSound();
    }
    
    private void OnBackspace()
    {
        if (DisplayValue.Length > 0)
        {
            DisplayValue = DisplayValue.Substring(0, DisplayValue.Length - 1);
            PlayClickSound();
        }
    }
    
    private void OnThirdButton()
    {
        if (HasMaxButton)
        {
            // MAX ĞºĞ½Ğ¾Ğ¿ĞºĞ°
            if (MaxValue.HasValue)
            {
                DisplayValue = MaxValue.Value.ToString("0");
                MaxButtonCommand?.Execute(null);
            }
        }
        else
        {
            // Confirm (âœ“) ĞºĞ½Ğ¾Ğ¿ĞºĞ°
            ConfirmPressed?.Invoke(this, EventArgs.Empty);
        }
        
        PlayClickSound();
    }
    
    private void PlayClickSound()
    {
        try
        {
            var player = new System.Media.SoundPlayer(
                @"C:\MaxLoyalty\Resources\Sounds\click.wav"
            );
            player.Play();
        }
        catch
        {
            // Ignore sound errors
        }
    }
}
```


### **8.3. AlphabeticKeyboard.xaml (Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ³Ğ¾ÑÑ‚Ñ)**

```xaml
<UserControl x:Class="MaxLoyaltyRKeeperUI.UserControls.AlphabeticKeyboard">
    <Grid Width="700" Height="350">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Ğ ÑƒÑÑĞºĞ°Ñ Ñ€Ğ°ÑĞºĞ»Ğ°Ğ´ĞºĞ° -->
        <Grid x:Name="RussianLayout" Visibility="{Binding IsRussianLayout, Converter={StaticResource BoolToVisibilityConverter}}">
            <!-- Ğ ÑĞ´ 1: Ğ™ Ğ¦ Ğ£ Ğš Ğ• Ğ Ğ“ Ğ¨ Ğ© Ğ— Ğ¥ Ğª -->
            <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Center">
                <Button Content="Ğ™" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="Ğ™" Width="50" Height="60" Margin="2"/>
                <Button Content="Ğ¦" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="Ğ¦" Width="50" Height="60" Margin="2"/>
                <Button Content="Ğ£" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="Ğ£" Width="50" Height="60" Margin="2"/>
                <Button Content="Ğš" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="Ğš" Width="50" Height="60" Margin="2"/>
                <Button Content="Ğ•" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="Ğ•" Width="50" Height="60" Margin="2"/>
                <Button Content="Ğ" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="Ğ" Width="50" Height="60" Margin="2"/>
                <Button Content="Ğ“" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="Ğ“" Width="50" Height="60" Margin="2"/>
                <Button Content="Ğ¨" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="Ğ¨" Width="50" Height="60" Margin="2"/>
                <Button Content="Ğ©" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="Ğ©" Width="50" Height="60" Margin="2"/>
                <Button Content="Ğ—" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="Ğ—" Width="50" Height="60" Margin="2"/>
                <Button Content="Ğ¥" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="Ğ¥" Width="50" Height="60" Margin="2"/>
                <Button Content="Ğª" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="Ğª" Width="50" Height="60" Margin="2"/>
            </StackPanel>
            
            <!-- Ğ ÑĞ´ 2: Ğ¤ Ğ« Ğ’ Ğ ĞŸ Ğ  Ğ Ğ› Ğ” Ğ– Ğ­ -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center">
                <Button Content="Ğ¤" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="Ğ¤" Width="50" Height="60" Margin="2"/>
                <!-- ... Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ... -->
            </StackPanel>
            
            <!-- Ğ ÑĞ´ 3: Ğ¯ Ğ§ Ğ¡ Ğœ Ğ˜ Ğ¢ Ğ¬ Ğ‘ Ğ® -->
            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center">
                <Button Content="â‡§" Width="70" Height="60" Style="{StaticResource KeyButtonStyle}" Command="{Binding ShiftCommand}" Margin="2"/>
                <Button Content="Ğ¯" Style="{StaticResource KeyButtonStyle}" Command="{Binding KeyPressCommand}" CommandParameter="Ğ¯" Width="50" Height="60" Margin="2"/>
                <!-- ... Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ... -->
                <Button Content="âŒ«" Width="70" Height="60" Style="{StaticResource KeyButtonStyle}" Command="{Binding BackspaceCommand}" Margin="2"/>
            </StackPanel>
            
            <!-- Ğ ÑĞ´ 4: Ğ¡Ğ»ÑƒĞ¶ĞµĞ±Ğ½Ñ‹Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ -->
            <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Center">
                <Button Content="EN" Width="80" Height="60" Style="{StaticResource KeyButtonStyle}" Command="{Binding SwitchLayoutCommand}" CommandParameter="EN" Margin="2"/>
                <Button Content="123" Width="80" Height="60" Style="{StaticResource KeyButtonStyle}" Command="{Binding SwitchToNumericCommand}" Margin="2"/>
                <Button Content="ĞŸĞ ĞĞ‘Ğ•Ğ›" Width="300" Height="60" Style="{StaticResource KeyButtonStyle}" Command="{Binding SpaceCommand}" Margin="2"/>
                <Button Content="âœ“" Width="80" Height="60" Style="{StaticResource PrimaryButtonStyle}" Command="{Binding ConfirmCommand}" Margin="2"/>
            </StackPanel>
        </Grid>
        
        <!-- ĞĞ½Ğ³Ğ»Ğ¸Ğ¹ÑĞºĞ°Ñ Ñ€Ğ°ÑĞºĞ»Ğ°Ğ´ĞºĞ° (Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾) -->
        <!-- ... -->
    </Grid>
</UserControl>
```


***

## **ğŸ”„ 9. SHARED MEMORY Ğ¡Ğ˜ĞĞ¥Ğ ĞĞĞ˜Ğ—ĞĞ¦Ğ˜Ğ¯**

### **9.1. SharedMemoryService.cs**

```csharp
public interface ISharedMemoryService
{
    Task InitializeAsync();
    Task<SharedMemoryData> GetDataAsync();
    Task UpdateBackendStatusAsync(bool isOnline);
    Task SaveOrderContextAsync(OrderContext context);
    Task<OrderContext> GetOrderContextAsync(string orderId);
    Task ClearOrderContextAsync(string orderId);
    Task<List<OrderContext>> GetActiveOrdersAsync();
    Task EnqueueOfflineOperationAsync(OfflineOperation operation);
    Task<List<OfflineOperation>> GetOfflineQueueAsync();
    Task UpdateMetricsAsync(Dictionary<string, object> metrics);
    event EventHandler ActiveOrdersChanged;
}

public class SharedMemoryService : ISharedMemoryService
{
    private readonly ILogger<SharedMemoryService> logger;
    private MemoryMappedFile mmf;
    private Mutex mutex;
    private const string MMF_NAME = "MaxLoyaltyRKeeperShared";
    private const int MMF_SIZE = 1024 * 1024; // 1 MB
    private const string MUTEX_NAME = "MaxLoyaltyRKeeperMutex";
    
    public event EventHandler ActiveOrdersChanged;
    
    public SharedMemoryService(ILogger<SharedMemoryService> logger)
    {
        this.logger = logger;
    }
    
    public async Task InitializeAsync()
    {
        try
        {
            // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Mutex
            mutex = new Mutex(false, MUTEX_NAME);
            
            // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Memory Mapped File
            try
            {
                mmf = MemoryMappedFile.OpenExisting(MMF_NAME);
                logger.LogInformation("Opened existing shared memory");
            }
            catch (FileNotFoundException)
            {
                mmf = MemoryMappedFile.CreateNew(MMF_NAME, MMF_SIZE);
                
                // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
                var initialData = new SharedMemoryData
                {
                    Version = "1.0.0",
                    LastUpdated = DateTime.UtcNow,
                    BackendStatus = new BackendStatus { IsOnline = false },
                    ActiveOrders = new Dictionary<string, OrderContext>(),
                    OfflineQueue = new List<OfflineOperation>(),
                    Metrics = new Dictionary<string, object>()
                };
                
                await WriteDataAsync(initialData);
                
                logger.LogInformation("Created new shared memory");
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to initialize shared memory");
            throw;
        }
    }
    
    public async Task<SharedMemoryData> GetDataAsync()
    {
        mutex.WaitOne();
        
        try
        {
            using var accessor = mmf.CreateViewAccessor();
            
            // Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 4 Ğ±Ğ°Ğ¹Ñ‚Ğ°)
            var dataSize = accessor.ReadInt32(0);
            
            if (dataSize == 0 || dataSize > MMF_SIZE - 4)
            {
                logger.LogWarning("Invalid data size in shared memory: {Size}", dataSize);
                return new SharedMemoryData();
            }
            
            // Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ JSON Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
            var jsonBytes = new byte[dataSize];
            accessor.ReadArray(4, jsonBytes, 0, dataSize);
            
            var json = Encoding.UTF8.GetString(jsonBytes);
            var data = JsonConvert.DeserializeObject<SharedMemoryData>(json);
            
            return data;
        }
        finally
        {
            mutex.ReleaseMutex();
        }
    }
    
    private async Task WriteDataAsync(SharedMemoryData data)
    {
        mutex.WaitOne();
        
        try
        {
            data.LastUpdated = DateTime.UtcNow;
            
            var json = JsonConvert.SerializeObject(data);
            var jsonBytes = Encoding.UTF8.GetBytes(json);
            
            if (jsonBytes.Length > MMF_SIZE - 4)
            {
                throw new InvalidOperationException(
                    $"Data too large for shared memory: {jsonBytes.Length} bytes"
                );
            }
            
            using var accessor = mmf.CreateViewAccessor();
            
            // Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
            accessor.Write(0, jsonBytes.Length);
            
            // Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
            accessor.WriteArray(4, jsonBytes, 0, jsonBytes.Length);
            
            logger.LogDebug("Wrote {Size} bytes to shared memory", jsonBytes.Length);
        }
        finally
        {
            mutex.ReleaseMutex();
        }
    }
    
    public async Task UpdateBackendStatusAsync(bool isOnline)
    {
        var data = await GetDataAsync();
        data.BackendStatus = new BackendStatus
        {
            IsOnline = isOnline,
            LastCheckAt = DateTime.UtcNow,
            LatencyMs = 0 // TODO: measure actual latency
        };
        await WriteDataAsync(data);
        
        logger.LogInformation("Backend status updated: {Status}", isOnline ? "Online" : "Offline");
    }
    
    public async Task SaveOrderContextAsync(OrderContext context)
    {
        var data = await GetDataAsync();
        data.ActiveOrders[context.OrderId] = context;
        await WriteDataAsync(data);
        
        logger.LogInformation("Order context saved: {OrderId}", context.OrderId);
        
        ActiveOrdersChanged?.Invoke(this, EventArgs.Empty);
    }
    
    public async Task<OrderContext> GetOrderContextAsync(string orderId)
    {
        var data = await GetDataAsync();
        return data.ActiveOrders.TryGetValue(orderId, out var context) ? context : null;
    }
    
    public async Task ClearOrderContextAsync(string orderId)
    {
        var data = await GetDataAsync();
        if (data.ActiveOrders.Remove(orderId))
        {
            await WriteDataAsync(data);
            logger.LogInformation("Order context cleared: {OrderId}", orderId);
            
            ActiveOrdersChanged?.Invoke(this, EventArgs.Empty);
        }
    }
    
    public async Task<List<OrderContext>> GetActiveOrdersAsync()
    {
        var data = await GetDataAsync();
        return data.ActiveOrders.Values.ToList();
    }
    
    public async Task EnqueueOfflineOperationAsync(OfflineOperation operation)
    {
        var data = await GetDataAsync();
        
        if (data.OfflineQueue.Count >= 100)
        {
            logger.LogWarning("Offline queue is full, removing oldest item");
            data.OfflineQueue.RemoveAt(0);
        }
        
        operation.Id = Guid.NewGuid().ToString();
        operation.QueuedAt = DateTime.UtcNow;
        operation.Attempts = 0;
        
        data.OfflineQueue.Add(operation);
        await WriteDataAsync(data);
        
        logger.LogWarning("Operation queued offline: {Type} - {OrderId}", 
            operation.Type, operation.OrderId);
    }
    
    public async Task<List<OfflineOperation>> GetOfflineQueueAsync()
    {
        var data = await GetDataAsync();
        return data.OfflineQueue;
    }
    
    public async Task UpdateMetricsAsync(Dictionary<string, object> metrics)
    {
        var data = await GetDataAsync();
        foreach (var kvp in metrics)
        {
            data.Metrics[kvp.Key] = kvp.Value;
        }
        await WriteDataAsync(data);
    }
}

// ĞœĞ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ»Ñ Shared Memory
public class SharedMemoryData
{
    public string Version { get; set; }
    public DateTime LastUpdated { get; set; }
    public BackendStatus BackendStatus { get; set; }
    public Dictionary<string, OrderContext> ActiveOrders { get; set; }
    public List<OfflineOperation> OfflineQueue { get; set; }
    public Dictionary<string, object> Metrics { get; set; }
}

public class BackendStatus
{
    public bool IsOnline { get; set; }
    public DateTime LastCheckAt { get; set; }
    public int LatencyMs { get; set; }
}
```


***

ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ñ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ°Ğ¼Ğ¸ 10-18 (R-Keeper XML API, Backend endpoints, Ğ¤Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ, Offline, Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ, Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°, ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ, ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°)?

---

# ğŸ“˜ **ĞŸĞĞ›ĞĞĞ¯ Ğ¡ĞŸĞ•Ğ¦Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ¯ - ĞŸĞ ĞĞ”ĞĞ›Ğ–Ğ•ĞĞ˜Ğ• (Ñ‡Ğ°ÑÑ‚ÑŒ 4)**


***

## **ğŸ”Œ 10. R-KEEPER XML API Ğ˜ĞĞ¢Ğ•Ğ“Ğ ĞĞ¦Ğ˜Ğ¯**

### **10.1. RKeeperXmlClient.cs**

```csharp
public interface IRKeeperXmlClient
{
    Task<List<RKeeperOrder>> GetOrderListAsync();
    Task<RKeeperOrder> GetOrderDetailsAsync(string orderId);
    Task BindCardToOrderAsync(string orderId, string cardNumber);
    Task ApplyManualDiscountAsync(string orderId, decimal amount, string reason);
    Task ApplyPercentDiscountAsync(string orderId, decimal percentage, string reason);
    Task<string> GetCashierNameAsync();
    Task<ServerInfo> GetServerInfoAsync();
}

public class RKeeperXmlClient : IRKeeperXmlClient
{
    private readonly HttpClient httpClient;
    private readonly IConfigService configService;
    private readonly ILogger<RKeeperXmlClient> logger;
    private readonly string xmlApiUrl;
    
    public RKeeperXmlClient(
        HttpClient httpClient,
        IConfigService configService,
        ILogger<RKeeperXmlClient> logger)
    {
        this.httpClient = httpClient;
        this.configService = configService;
        this.logger = logger;
        
        var config = configService.LoadConfig();
        xmlApiUrl = config.RKeeperXmlApiUrl;
        
        httpClient.Timeout = TimeSpan.FromSeconds(10);
    }
    
    public async Task<List<RKeeperOrder>> GetOrderListAsync()
    {
        logger.LogInformation("Getting order list from R-Keeper");
        
        var xml = @"
            <RK7Query>
              <RK7CMD CMD=""GetOrderList"">
                <Filter>
                  <Status>OPEN</Status>
                </Filter>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        
        // ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ XML Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
        var doc = XDocument.Parse(response);
        
        var orders = doc.Descendants("Order").Select(o => new RKeeperOrder
        {
            Id = o.Element("ident")?.Value,
            TableNumber = o.Element("Table")?.Value,
            Amount = ParseDecimal(o.Element("Amount")?.Value),
            Status = o.Element("Status")?.Value,
            Type = ParseOrderType(o.Element("OrderType")?.Value),
            Categories = ParseCategories(o.Element("Items")),
            StationId = o.Element("StationId")?.Value,
            OpenedAt = ParseDateTime(o.Element("OpenedAt")?.Value),
            DisplayName = GetOrderDisplayName(o)
        }).ToList();
        
        logger.LogInformation("Retrieved {Count} orders", orders.Count);
        
        return orders;
    }
    
    public async Task<RKeeperOrder> GetOrderDetailsAsync(string orderId)
    {
        logger.LogInformation("Getting order details: {OrderId}", orderId);
        
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""GetOrder"">
                <Order>
                  <ident>{XmlEscape(orderId)}</ident>
                </Order>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        var doc = XDocument.Parse(response);
        
        var orderElement = doc.Descendants("Order").FirstOrDefault();
        if (orderElement == null)
        {
            throw new Exception($"Order {orderId} not found");
        }
        
        return new RKeeperOrder
        {
            Id = orderElement.Element("ident")?.Value,
            TableNumber = orderElement.Element("Table")?.Value,
            Amount = ParseDecimal(orderElement.Element("Amount")?.Value),
            Status = orderElement.Element("Status")?.Value,
            Type = ParseOrderType(orderElement.Element("OrderType")?.Value),
            Categories = ParseCategories(orderElement.Element("Items")),
            Items = ParseItems(orderElement.Element("Items")),
            StationId = orderElement.Element("StationId")?.Value,
            CashierId = orderElement.Element("CashierId")?.Value,
            CashierName = orderElement.Element("CashierName")?.Value,
            OpenedAt = ParseDateTime(orderElement.Element("OpenedAt")?.Value)
        };
    }
    
    public async Task BindCardToOrderAsync(string orderId, string cardNumber)
    {
        logger.LogInformation("Binding card to order: {OrderId}, Card: {CardNumber}", 
            orderId, MaskCardNumber(cardNumber));
        
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""SaveOrder"">
                <Order>
                  <ident>{XmlEscape(orderId)}</ident>
                  <GuestCard>
                    <CardNumber>{XmlEscape(cardNumber)}</CardNumber>
                  </GuestCard>
                </Order>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ÑÑ‚Ğ¸
        var doc = XDocument.Parse(response);
        var status = doc.Descendants("Status").FirstOrDefault()?.Value;
        
        if (status != "OK")
        {
            var error = doc.Descendants("Error").FirstOrDefault()?.Value ?? "Unknown error";
            throw new Exception($"Failed to bind card: {error}");
        }
        
        logger.LogInformation("Card bound successfully");
    }
    
    public async Task ApplyManualDiscountAsync(string orderId, decimal amount, string reason)
    {
        logger.LogInformation("Applying manual discount: {OrderId}, Amount: {Amount}", 
            orderId, amount);
        
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""SaveOrder"">
                <Order>
                  <ident>{XmlEscape(orderId)}</ident>
                  <Discount>
                    <Type>MANUAL</Type>
                    <DiscountType>FIXED</DiscountType>
                    <Value>{amount.ToString("0.00", CultureInfo.InvariantCulture)}</Value>
                    <Reason>{XmlEscape(reason)}</Reason>
                  </Discount>
                </Order>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        ValidateResponse(response);
        
        logger.LogInformation("Manual discount applied successfully");
    }
    
    public async Task ApplyPercentDiscountAsync(string orderId, decimal percentage, string reason)
    {
        logger.LogInformation("Applying percent discount: {OrderId}, Percentage: {Percentage}%", 
            orderId, percentage);
        
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""SaveOrder"">
                <Order>
                  <ident>{XmlEscape(orderId)}</ident>
                  <Discount>
                    <Type>MANUAL</Type>
                    <DiscountType>PERCENT</DiscountType>
                    <Value>{percentage.ToString("0.00", CultureInfo.InvariantCulture)}</Value>
                    <Reason>{XmlEscape(reason)}</Reason>
                  </Discount>
                </Order>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        ValidateResponse(response);
        
        logger.LogInformation("Percent discount applied successfully");
    }
    
    public async Task<string> GetCashierNameAsync()
    {
        try
        {
            var xml = @"
                <RK7Query>
                  <RK7CMD CMD=""GetCurrentUser""/>
                </RK7Query>
            ";
            
            var response = await SendXmlRequestAsync(xml);
            var doc = XDocument.Parse(response);
            
            var cashierName = doc.Descendants("UserName").FirstOrDefault()?.Value;
            return cashierName ?? "Unknown";
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to get cashier name");
            return "Unknown";
        }
    }
    
    public async Task<ServerInfo> GetServerInfoAsync()
    {
        var xml = @"
            <RK7Query>
              <RK7CMD CMD=""GetServerInfo""/>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        var doc = XDocument.Parse(response);
        
        return new ServerInfo
        {
            Version = doc.Descendants("Version").FirstOrDefault()?.Value,
            ServerName = doc.Descendants("ServerName").FirstOrDefault()?.Value,
            DatabaseName = doc.Descendants("DatabaseName").FirstOrDefault()?.Value,
            IsOnline = true
        };
    }
    
    private async Task<string> SendXmlRequestAsync(string xmlRequest)
    {
        try
        {
            var content = new StringContent(xmlRequest, Encoding.UTF8, "text/xml");
            var response = await httpClient.PostAsync(xmlApiUrl, content);
            
            if (!response.IsSuccessStatusCode)
            {
                logger.LogError("R-Keeper XML API returned {StatusCode}", response.StatusCode);
                throw new HttpRequestException($"R-Keeper API error: {response.StatusCode}");
            }
            
            var responseXml = await response.Content.ReadAsStringAsync();
            
            logger.LogDebug("R-Keeper Response: {Response}", responseXml);
            
            return responseXml;
        }
        catch (TaskCanceledException ex)
        {
            logger.LogError(ex, "R-Keeper XML API request timeout");
            throw new TimeoutException("R-Keeper API timeout", ex);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "R-Keeper XML API request failed");
            throw;
        }
    }
    
    private void ValidateResponse(string xmlResponse)
    {
        var doc = XDocument.Parse(xmlResponse);
        var status = doc.Descendants("Status").FirstOrDefault()?.Value;
        
        if (status != "OK" && status != "SUCCESS")
        {
            var error = doc.Descendants("Error").FirstOrDefault()?.Value ?? "Unknown error";
            throw new Exception($"R-Keeper error: {error}");
        }
    }
    
    private decimal ParseDecimal(string value)
    {
        if (string.IsNullOrEmpty(value))
            return 0;
        
        return decimal.Parse(value, CultureInfo.InvariantCulture);
    }
    
    private DateTime? ParseDateTime(string value)
    {
        if (string.IsNullOrEmpty(value))
            return null;
        
        return DateTime.Parse(value, CultureInfo.InvariantCulture);
    }
    
    private string ParseOrderType(string value)
    {
        return value?.ToUpperInvariant() switch
        {
            "DINEIN" => "DINE_IN",
            "TAKEAWAY" => "TAKEAWAY",
            "DELIVERY" => "DELIVERY",
            _ => "DINE_IN"
        };
    }
    
    private List<string> ParseCategories(XElement itemsElement)
    {
        if (itemsElement == null)
            return new List<string>();
        
        return itemsElement.Descendants("Item")
            .Select(i => i.Element("Category")?.Value)
            .Where(c => !string.IsNullOrEmpty(c))
            .Distinct()
            .ToList();
    }
    
    private List<OrderItem> ParseItems(XElement itemsElement)
    {
        if (itemsElement == null)
            return new List<OrderItem>();
        
        return itemsElement.Descendants("Item").Select(i => new OrderItem
        {
            Name = i.Element("Name")?.Value,
            Quantity = ParseDecimal(i.Element("Quantity")?.Value),
            Price = ParseDecimal(i.Element("Price")?.Value),
            Category = i.Element("Category")?.Value
        }).ToList();
    }
    
    private string GetOrderDisplayName(XElement orderElement)
    {
        var table = orderElement.Element("Table")?.Value;
        var amount = ParseDecimal(orderElement.Element("Amount")?.Value);
        
        if (!string.IsNullOrEmpty(table))
            return $"Ğ¡Ñ‚Ğ¾Ğ» {table} - {amount:N0}â‚½";
        
        return $"Ğ—Ğ°ĞºĞ°Ğ· - {amount:N0}â‚½";
    }
    
    private string XmlEscape(string value)
    {
        return SecurityElement.Escape(value);
    }
    
    private string MaskCardNumber(string cardNumber)
    {
        if (cardNumber.Length <= 4)
            return "****";
        
        return "****" + cardNumber.Substring(cardNumber.Length - 4);
    }
}

// ĞœĞ¾Ğ´ĞµĞ»Ğ¸
public class RKeeperOrder
{
    public string Id { get; set; }
    public string TableNumber { get; set; }
    public decimal Amount { get; set; }
    public string Status { get; set; }
    public string Type { get; set; }
    public List<string> Categories { get; set; }
    public List<OrderItem> Items { get; set; }
    public string StationId { get; set; }
    public string CashierId { get; set; }
    public string CashierName { get; set; }
    public DateTime? OpenedAt { get; set; }
    public string DisplayName { get; set; }
}

public class OrderItem
{
    public string Name { get; set; }
    public decimal Quantity { get; set; }
    public decimal Price { get; set; }
    public string Category { get; set; }
}

public class ServerInfo
{
    public string Version { get; set; }
    public string ServerName { get; set; }
    public string DatabaseName { get; set; }
    public bool IsOnline { get; set; }
}
```


***

## **ğŸŒ 11. BACKEND API ENDPOINTS**

### **11.1. API Endpoints ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ**

```typescript
// ==========================================
// 1. ĞŸĞĞ˜Ğ¡Ğš Ğ“ĞĞ¡Ğ¢Ğ¯
// ==========================================

POST /api/pos-integration/rkeeper/search-guest

Headers:
  X-API-Key: rk_live_xxxxx
  X-Installation-Id: inst_abc123
  X-Tenant-Id: tenant_mario
  X-Restaurant-Id: rest_centro
  X-Terminal-Id: term_001
  Content-Type: application/json

Request Body:
{
  "phone"?: "+79991234567",
  "code6Digit"?: "123456"
}

Response 200:
{
  "found": true,
  "guest": {
    "cardId": "card_uuid_abc",
    "name": "Ğ˜Ğ²Ğ°Ğ½ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²",
    "phone": "+79991234567",
    "email": "ivan@example.com",
    "levelId": 2,
    "levelName": "Ğ¡ĞµÑ€ĞµĞ±Ñ€Ğ¾",
    "regularBalance": 1500.00,
    "promoBalance": 950.00,
    "totalBalance": 2450.00,
    "code6Digit": "123456",
    "birthDate": "1990-05-15",
    "registeredAt": "2024-01-10T10:30:00Z"
  }
}

Response 200 (not found):
{
  "found": false,
  "guest": null
}

Response 401:
{
  "error": "Unauthorized",
  "message": "Invalid API Key"
}

// ==========================================
// 2. Ğ ĞĞ¡Ğ§Ğ•Ğ¢ Ğ‘Ğ•ĞĞ•Ğ¤Ğ˜Ğ¢ĞĞ’
// ==========================================

POST /api/pos-integration/rkeeper/calculate

Request Body:
{
  "guestCardId": "card_uuid_abc",
  "checkAmount": 890.00,
  "orderCategories": ["ĞŸĞ¸Ñ†Ñ†Ğ°", "ĞĞ°Ğ¿Ğ¸Ñ‚ĞºĞ¸"],
  "orderType": "DINE_IN",
  "calculateOnly": true
}

Response 200:
{
  "benefitType": "POINTS",
  "maxAllowedToSpend": 178.00,
  "pointsToEarn": 45.00,
  "discountPercentage": 0,
  "discountAmount": 0,
  "checkAmount": 890.00,
  "minCheckAmount": 100.00,
  "rules": {
    "maxSpendPercentage": 20,
    "earnRate": 5,
    "excludedCategories": []
  }
}

Response 200 (DISCOUNT type):
{
  "benefitType": "DISCOUNT",
  "maxAllowedToSpend": 0,
  "pointsToEarn": 0,
  "discountPercentage": 15,
  "discountAmount": 133.50,
  "checkAmount": 890.00,
  "minCheckAmount": 100.00
}

// ==========================================
// 3. Ğ Ğ•Ğ—Ğ•Ğ Ğ’ĞĞ¦Ğ˜Ğ¯ Ğ‘ĞĞ›Ğ›ĞĞ’
// ==========================================

POST /api/pos-integration/rkeeper/reserve-points

Request Body:
{
  "guestCardId": "card_uuid_abc",
  "pointsToSpend": 178.00,
  "maxAllowed": 178.00,
  "checkAmount": 890.00,
  "orderId": "order_12345",
  "restaurantId": "rest_centro",
  "terminalId": "term_001",
  "action": "SPEND"
}

Response 200:
{
  "success": true,
  "reservationId": "res_xyz789",
  "pointsReserved": 178.00,
  "expiresAt": "2026-02-18T01:00:00Z",
  "newBalance": 2272.00
}

Response 400:
{
  "success": false,
  "error": "Insufficient balance",
  "message": "ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ². Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾: 150.00"
}

// ==========================================
// 4. Ğ Ğ•Ğ—Ğ•Ğ Ğ’ĞĞ¦Ğ˜Ğ¯ Ğ¡ĞšĞ˜Ğ”ĞšĞ˜
// ==========================================

POST /api/pos-integration/rkeeper/reserve-discount

Request Body:
{
  "guestCardId": "card_uuid_abc",
  "discountPercentage": 15,
  "discountAmount": 133.50,
  "checkAmount": 890.00,
  "orderId": "order_12345"
}

Response 200:
{
  "success": true,
  "reservationId": "res_discount_abc",
  "discountPercentage": 15,
  "discountAmount": 133.50,
  "expiresAt": "2026-02-18T01:00:00Z"
}

// ==========================================
// 5. Ğ¤Ğ˜ĞĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ‘ĞĞ›Ğ›ĞĞ’
// ==========================================

POST /api/pos-integration/rkeeper/finalize-points

Request Body:
{
  "guestCardId": "card_uuid_abc",
  "orderId": "order_12345",
  "reservationId": "res_xyz789",
  "pointsSpent": 178.00,
  "pointsToEarn": 45.00,
  "action": "SPEND",
  "checkAmount": 890.00,
  "finalCheckAmount": 890.00,
  "restaurantId": "rest_centro",
  "terminalId": "term_001",
  "stationId": "STATION_001",
  "cashierName": "Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ° Ğ.",
  "paymentTypes": ["CASH", "CARD"],
  "orderType": "DINE_IN"
}

Response 200:
{
  "success": true,
  "transactionId": "txn_abc123",
  "pointsSpent": 178.00,
  "pointsEarned": 45.00,
  "newBalance": 2317.00,
  "earnedAt": "2026-02-18T00:45:00Z"
}

// ==========================================
// 6. Ğ¤Ğ˜ĞĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ¡ĞšĞ˜Ğ”ĞšĞ˜
// ==========================================

POST /api/pos-integration/rkeeper/finalize-discount

Request Body:
{
  "guestCardId": "card_uuid_abc",
  "orderId": "order_12345",
  "reservationId": "res_discount_abc",
  "discountAmount": 133.50,
  "discountPercentage": 15,
  "checkAmount": 890.00,
  "finalCheckAmount": 756.50,
  "restaurantId": "rest_centro",
  "terminalId": "term_001",
  "cashierName": "Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ° Ğ.",
  "paymentTypes": ["CARD"]
}

Response 200:
{
  "success": true,
  "transactionId": "txn_discount_123",
  "discountApplied": 133.50,
  "finalAmount": 756.50
}

// ==========================================
// 7. ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ Ğ•Ğ—Ğ•Ğ Ğ’ĞĞ¦Ğ˜Ğ˜
// ==========================================

POST /api/pos-integration/rkeeper/update-reservation

Request Body:
{
  "reservationId": "res_xyz789",
  "newCheckAmount": 950.00,
  "newPointsToSpend": 190.00
}

Response 200:
{
  "success": true,
  "updatedAt": "2026-02-18T00:47:00Z"
}

// ==========================================
// 8. ĞĞ¢ĞœĞ•ĞĞ Ğ Ğ•Ğ—Ğ•Ğ Ğ’ĞĞ¦Ğ˜Ğ˜
// ==========================================

POST /api/pos-integration/rkeeper/cancel-reservation

Request Body:
{
  "reservationId": "res_xyz789",
  "orderId": "order_12345",
  "reason": "USER_UNBIND"
}

Response 200:
{
  "success": true,
  "cancelledAt": "2026-02-18T00:48:00Z"
}

// ==========================================
// 9. Ğ¡ĞĞ—Ğ”ĞĞĞ˜Ğ• Ğ“ĞĞ¡Ğ¢Ğ¯
// ==========================================

POST /api/pos-integration/rkeeper/create-guest

Request Body:
{
  "phone": "+79991234567",
  "name": "Ğ˜Ğ²Ğ°Ğ½ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²",
  "birthDate": "1990-05-15",
  "email": "ivan@example.com"
}

Response 200:
{
  "success": true,
  "guestCardId": "card_new_uuid",
  "code6Digit": "654321",
  "message": "Ğ“Ğ¾ÑÑ‚ÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾"
}

// ==========================================
// 10. ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯ Ğ Ğ•Ğ¡Ğ¢ĞĞ ĞĞĞ
// ==========================================

GET /api/pos-integration/rkeeper/config

Response 200:
{
  "restaurantId": "rest_centro",
  "restaurantName": "ĞŸĞ¸Ñ†Ñ†ĞµÑ€Ğ¸Ñ Ğ£ ĞœĞ°Ñ€Ğ¸Ğ¾ - Ğ¦ĞµĞ½Ñ‚Ñ€",
  "tenantId": "tenant_mario",
  "minCheckAmount": 100.00,
  "maxSpendPercentage": 20,
  "earnRate": 5,
  "supportedBenefitTypes": ["POINTS", "DISCOUNT"],
  "excludedCategories": [],
  "timezone": "Europe/Moscow"
}

// ==========================================
// 11. HEALTH CHECK
// ==========================================

GET /api/health

Response 200:
{
  "status": "ok",
  "timestamp": "2026-02-18T00:50:00Z",
  "version": "1.2.0"
}

// ==========================================
// 12. FIRST CONNECT
// ==========================================

POST /api/pos-integration/rkeeper/first-connect

Request Body:
{
  "installation_id": "inst_abc123",
  "terminal_name": "ĞšĞ°ÑÑĞ° 1 (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ»)",
  "station_id": "STATION_001",
  "machine_id": "MACHINE_XYZ",
  "os_version": "Windows 11 Pro",
  "plugin_version": "1.0.0",
  "rkeeper_version": "7.5.2"
}

Response 200:
{
  "success": true,
  "message": "Installation activated",
  "activatedAt": "2026-02-18T00:51:00Z"
}

// ==========================================
// 13. ĞĞ¢ĞŸĞ ĞĞ’ĞšĞ ĞœĞ•Ğ¢Ğ Ğ˜Ğš
// ==========================================

POST /api/pos-integration/rkeeper/metrics

Request Body:
[
  {
    "name": "loyalty.points.applied",
    "value": 178.00,
    "tags": {
      "terminal_id": "term_001",
      "restaurant_id": "rest_centro"
    },
    "timestamp": "2026-02-18T00:52:00Z"
  },
  {
    "name": "loyalty.transaction.completed",
    "value": 1,
    "tags": {
      "terminal_id": "term_001"
    },
    "timestamp": "2026-02-18T00:52:00Z"
  }
]

Response 200:
{
  "received": true,
  "count": 2
}
```


***

## **âœ… 12. Ğ¤Ğ˜ĞĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ¢Ğ ĞĞĞ—ĞĞšĞ¦Ğ˜Ğ™**

### **12.1. ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· FarCard**

```cpp
// Ğ’ external.dll: FinalizeTransaction Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ R-Keeper

int FinalizeTransaction(
    const char* reservationId,
    double finalAmount,
    const char* orderId,
    const char* paymentTypesJson
)
{
    g_logger->Info("FinalizeTransaction: OrderId=%s, Amount=%.2f", orderId, finalAmount);
    
    try
    {
        // 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· shared memory
        auto context = g_sharedMemory->GetOrderContext(orderId);
        
        if (!context.has_value())
        {
            g_logger->Warning("No loyalty context for order %s", orderId);
            return 0; // ĞĞµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ½ĞµÑ‚ Ğ»Ğ¾ÑĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
        }
        
        // 2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ¼Ñ ĞºĞ°ÑÑĞ¸Ñ€Ğ°
        std::string cashierName = GetCurrentCashierName();
        
        // 3. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº backend
        json requestBody = {
            {"guestCardId", context->cardId},
            {"orderId", orderId},
            {"reservationId", context->reservationId},
            {"checkAmount", context->originalAmount},
            {"finalCheckAmount", finalAmount},
            {"restaurantId", g_restaurantId},
            {"terminalId", g_terminalId},
            {"stationId", context->stationId},
            {"cashierName", cashierName},
            {"paymentTypes", json::parse(paymentTypesJson)},
            {"orderType", "DINE_IN"}
        };
        
        std::string endpoint;
        
        if (context->benefitType == BenefitType::Points)
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-points";
            requestBody["pointsSpent"] = context->pointsToSpend;
            requestBody["pointsToEarn"] = context->pointsToEarn;
            requestBody["action"] = context->action;
        }
        else if (context->benefitType == BenefitType::Discount)
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-discount";
            requestBody["discountAmount"] = context->discountAmount;
            requestBody["discountPercentage"] = context->discountPercentage;
        }
        
        // 4. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ retry
        auto response = RetryPolicy::Execute([&]() {
            return g_httpClient->Post(endpoint, requestBody.dump());
        }, 3);
        
        if (response.statusCode == 200)
        {
            auto responseData = json::parse(response.body);
            
            if (responseData["success"].get<bool>())
            {
                std::string txnId = responseData["transactionId"].get<std::string>();
                g_logger->Info("Finalized successfully: TxnId=%s", txnId.c_str());
                
                // 5. ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚
                g_sharedMemory->ClearOrderContext(orderId);
                
                // 6. Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ UI
                g_sharedMemory->NotifyUI("order_finalized", orderId);
                
                // 7. ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸
                SendMetric("loyalty.transaction.finalized", 1);
                
                return 0; // Success
            }
        }
        
        // Backend Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½
        g_logger->Warning("Backend unavailable, queueing offline...");
        
        // 8. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² offline queue
        g_sharedMemory->EnqueueOfflineOperation({
            "FINALIZE_" + std::string(context->benefitType == BenefitType::Points ? "POINTS" : "DISCOUNT"),
            orderId,
            requestBody.dump(),
            GetCurrentTimestamp(),
            0 // attempts
        });
        
        return -2; // Queued offline
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("FinalizeTransaction exception: %s", ex.what());
        return -1;
    }
}

// ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ¼ĞµĞ½Ğ¸ ĞºĞ°ÑÑĞ¸Ñ€Ğ°
std::string GetCurrentCashierName()
{
    try
    {
        // ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ R-Keeper
        char* cashier = std::getenv("RK7_CURRENT_USER");
        if (cashier != nullptr)
        {
            return std::string(cashier);
        }
        
        // Ğ˜Ğ»Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Windows API
        char username[256];
        DWORD size = sizeof(username);
        if (GetUserNameA(username, &size))
        {
            return std::string(username);
        }
        
        return "Unknown";
    }
    catch (...)
    {
        return "Unknown";
    }
}
```


### **12.2. Ğ¤Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ· UI (ĞµÑĞ»Ğ¸ DLL Ğ½Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°)**

```csharp
// UI Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ñ‡ĞµÑ€ĞµĞ· Backend API

public class OrderFinalizationService
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly ISharedMemoryService sharedMemory;
    private readonly ILogger<OrderFinalizationService> logger;
    
    public async Task<bool> TryFinalizeOrderAsync(string orderId)
    {
        var context = await sharedMemory.GetOrderContextAsync(orderId);
        
        if (context == null)
        {
            logger.LogInformation("No context for order {OrderId}", orderId);
            return false;
        }
        
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğµ Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ»Ğ¸ ÑƒĞ¶Ğµ
        if (DateTime.UtcNow - context.AppliedAt > TimeSpan.FromHours(24))
        {
            logger.LogWarning("Context expired for order {OrderId}", orderId);
            await sharedMemory.ClearOrderContextAsync(orderId);
            return false;
        }
        
        try
        {
            // ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
            if (context.BenefitType == BenefitType.Points)
            {
                var result = await apiClient.FinalizePointsAsync(new FinalizePointsRequest
                {
                    GuestCardId = context.GuestCardId,
                    OrderId = orderId,
                    ReservationId = context.ReservationId,
                    PointsSpent = context.PointsToSpend,
                    PointsToEarn = context.PointsToEarn,
                    CheckAmount = context.OriginalCheckAmount,
                    FinalCheckAmount = context.OriginalCheckAmount, // ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ° Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ
                    Action = context.Action.ToString()
                });
                
                if (result.Success)
                {
                    await sharedMemory.ClearOrderContextAsync(orderId);
                    logger.LogInformation("Order {OrderId} finalized successfully", orderId);
                    return true;
                }
            }
            
            return false;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to finalize order {OrderId}", orderId);
            return false;
        }
    }
}
```


***

## **ğŸ“´ 13. OFFLINE Ğ Ğ•Ğ–Ğ˜Ğœ**

### **13.1. OfflineQueueService.cs**

```csharp
public class OfflineQueueService : IOfflineQueueService
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly ISharedMemoryService sharedMemory;
    private readonly ILogger<OfflineQueueService> logger;
    private readonly string queueFilePath;
    private const int MaxQueueSize = 100;
    private const int TtlHours = 24;
    
    public OfflineQueueService(
        ILoyaltyApiClient apiClient,
        ISharedMemoryService sharedMemory,
        ILogger<OfflineQueueService> logger)
    {
        this.apiClient = apiClient;
        this.sharedMemory = sharedMemory;
        this.logger = logger;
        
        queueFilePath = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "MaxLoyaltyRKeeper",
            "offline_queue.json"
        );
    }
    
    public async Task EnqueueAsync(OfflineOperation operation)
    {
        var queue = await LoadQueueAsync();
        
        if (queue.Count >= MaxQueueSize)
        {
            logger.LogWarning("Offline queue is full ({Count}), removing oldest", queue.Count);
            queue.RemoveAt(0);
        }
        
        operation.Id = Guid.NewGuid().ToString();
        operation.QueuedAt = DateTime.UtcNow;
        operation.Attempts = 0;
        
        queue.Add(operation);
        await SaveQueueAsync(queue);
        
        // Ğ¢Ğ°ĞºĞ¶Ğµ Ğ² shared memory
        await sharedMemory.EnqueueOfflineOperationAsync(operation);
        
        logger.LogWarning(
            "Operation queued offline: Type={Type}, OrderId={OrderId}",
            operation.Type, operation.OrderId
        );
    }
    
    public async Task ProcessQueueAsync()
    {
        var queue = await LoadQueueAsync();
        
        if (queue.Count == 0)
        {
            logger.LogDebug("Offline queue is empty");
            return;
        }
        
        logger.LogInformation("Processing offline queue: {Count} operations", queue.Count);
        
        var processed = new List<OfflineOperation>();
        var failed = new List<OfflineOperation>();
        
        foreach (var operation in queue)
        {
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° TTL
            if (DateTime.UtcNow - operation.QueuedAt > TimeSpan.FromHours(TtlHours))
            {
                logger.LogWarning("Operation expired: {Id}, Age={Age}h", 
                    operation.Id, 
                    (DateTime.UtcNow - operation.QueuedAt).TotalHours);
                processed.Add(operation);
                continue;
            }
            
            // ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
            try
            {
                var success = await ProcessOperationAsync(operation);
                
                if (success)
                {
                    processed.Add(operation);
                    logger.LogInformation("Processed offline operation: {Id}", operation.Id);
                }
                else
                {
                    operation.Attempts++;
                    
                    if (operation.Attempts >= 5)
                    {
                        logger.LogError("Operation failed after 5 attempts: {Id}", operation.Id);
                        processed.Add(operation); // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¸Ğ· Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
                    }
                    else
                    {
                        failed.Add(operation);
                    }
                }
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "Error processing offline operation: {Id}", operation.Id);
                
                operation.Attempts++;
                failed.Add(operation);
            }
        }
        
        // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ
        queue = failed;
        await SaveQueueAsync(queue);
        
        // Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
        if (processed.Count > 0)
        {
            ShowNotification(
                "Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°",
                $"ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾ {processed.Count} Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ¸Ğ· Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸",
                NotificationType.Success
            );
        }
        
        logger.LogInformation(
            "Offline queue processed: Success={Success}, Failed={Failed}, Remaining={Remaining}",
            processed.Count, queue.Count - processed.Count, queue.Count
        );
    }
    
    private async Task<bool> ProcessOperationAsync(OfflineOperation operation)
    {
        var payload = JsonConvert.DeserializeObject<dynamic>(operation.Payload);
        
        switch (operation.Type)
        {
            case "FINALIZE_POINTS":
                var pointsRequest = JsonConvert.DeserializeObject<FinalizePointsRequest>(operation.Payload);
                var pointsResult = await apiClient.FinalizePointsAsync(pointsRequest);
                return pointsResult.Success;
                
            case "FINALIZE_DISCOUNT":
                var discountRequest = JsonConvert.DeserializeObject<FinalizeDiscountRequest>(operation.Payload);
                var discountResult = await apiClient.FinalizeDiscountAsync(discountRequest);
                return discountResult.Success;
                
            default:
                logger.LogWarning("Unknown operation type: {Type}", operation.Type);
                return false;
        }
    }
    
    private async Task<List<OfflineOperation>> LoadQueueAsync()
    {
        try
        {
            if (!File.Exists(queueFilePath))
                return new List<OfflineOperation>();
            
            var json = await File.ReadAllTextAsync(queueFilePath);
            return JsonConvert.DeserializeObject<List<OfflineOperation>>(json) 
                   ?? new List<OfflineOperation>();
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to load offline queue");
            return new List<OfflineOperation>();
        }
    }
    
    private async Task SaveQueueAsync(List<OfflineOperation> queue)
    {
        try
        {
            var directory = Path.GetDirectoryName(queueFilePath);
            if (!Directory.Exists(directory))
            {
                Directory.CreateDirectory(directory);
            }
            
            var json = JsonConvert.SerializeObject(queue, Formatting.Indented);
            await File.WriteAllTextAsync(queueFilePath, json);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to save offline queue");
        }
    }
    
    private void ShowNotification(string title, string message, NotificationType type)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            var notification = new ToastNotification
            {
                Title = title,
                Message = message,
                Type = type
            };
            notification.Show();
        });
    }
}
```


### **13.2. ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ offline Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ°**

```csharp
public class HealthCheckService : IHealthCheckService
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly ISharedMemoryService sharedMemory;
    private readonly ILogger<HealthCheckService> logger;
    private Timer healthCheckTimer;
    private bool isBackendHealthy = true;
    
    public bool IsBackendOnline => isBackendHealthy;
    
    public event EventHandler<bool> StatusChanged;
    
    public void StartMonitoring()
    {
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ
        healthCheckTimer = new Timer(60000); // 60 ÑĞµĞºÑƒĞ½Ğ´
        healthCheckTimer.Elapsed += async (s, e) => await CheckHealthAsync();
        healthCheckTimer.AutoReset = true;
        healthCheckTimer.Start();
        
        logger.LogInformation("Health monitoring started");
    }
    
    public async Task<HealthStatus> CheckHealthAsync()
    {
        try
        {
            var cts = new CancellationTokenSource(TimeSpan.FromSeconds(3));
            
            var stopwatch = Stopwatch.StartNew();
            var response = await apiClient.HealthCheckAsync(cts.Token);
            stopwatch.Stop();
            
            var wasOffline = !isBackendHealthy;
            isBackendHealthy = response.IsSuccessStatusCode;
            
            if (isBackendHealthy)
            {
                await sharedMemory.UpdateBackendStatusAsync(true);
                
                if (wasOffline)
                {
                    logger.LogInformation("Backend is back online");
                    StatusChanged?.Invoke(this, true);
                    
                    // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ offline Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
                    _ = ProcessOfflineQueueAsync();
                }
                
                return new HealthStatus
                {
                    IsOnline = true,
                    LatencyMs = (int)stopwatch.ElapsedMilliseconds,
                    CheckedAt = DateTime.UtcNow
                };
            }
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Health check failed");
        }
        
        // Backend offline
        var wasOnline = isBackendHealthy;
        isBackendHealthy = false;
        
        await sharedMemory.UpdateBackendStatusAsync(false);
        
        if (wasOnline)
        {
            logger.LogWarning("Backend went offline");
            StatusChanged?.Invoke(this, false);
        }
        
        return new HealthStatus
        {
            IsOnline = false,
            CheckedAt = DateTime.UtcNow
        };
    }
    
    private async Task ProcessOfflineQueueAsync()
    {
        try
        {
            var offlineQueue = Application.Current.Services
                .GetRequiredService<IOfflineQueueService>();
            
            await offlineQueue.ProcessQueueAsync();
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to process offline queue");
        }
    }
}
```


***

ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ñ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ°Ğ¼Ğ¸ 14-18 (Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ, Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°, ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ, ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°)?

---

# ğŸ“˜ **ĞŸĞĞ›ĞĞĞ¯ Ğ¡ĞŸĞ•Ğ¦Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ¯ - ĞŸĞ ĞĞ”ĞĞ›Ğ–Ğ•ĞĞ˜Ğ• (Ñ‡Ğ°ÑÑ‚ÑŒ 5)**


***

## **ğŸ” 14. Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¡Ğ¢Ğ¬**

### **14.1. Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ API Key**

```csharp
public class Encryption
{
    private const string SALT = "MaxLoyaltySalt2026";
    
    // Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Machine ID (ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹)
    public static string GetMachineId()
    {
        var sb = new StringBuilder();
        
        // CPU ID
        using (var searcher = new ManagementObjectSearcher("SELECT ProcessorId FROM Win32_Processor"))
        {
            foreach (var obj in searcher.Get())
            {
                sb.Append(obj["ProcessorId"]?.ToString());
            }
        }
        
        // Motherboard Serial
        using (var searcher = new ManagementObjectSearcher("SELECT SerialNumber FROM Win32_BaseBoard"))
        {
            foreach (var obj in searcher.Get())
            {
                sb.Append(obj["SerialNumber"]?.ToString());
            }
        }
        
        // MAC Address
        var nic = NetworkInterface.GetAllNetworkInterfaces()
            .FirstOrDefault(n => n.OperationalStatus == OperationalStatus.Up 
                              && n.NetworkInterfaceType != NetworkInterfaceType.Loopback);
        
        if (nic != null)
        {
            sb.Append(nic.GetPhysicalAddress().ToString());
        }
        
        // Ğ¥ĞµÑˆĞ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ID
        using var sha256 = SHA256.Create();
        var hash = sha256.ComputeHash(Encoding.UTF8.GetBytes(sb.ToString()));
        return Convert.ToBase64String(hash);
    }
    
    // Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ API Key (Ğ´Ğ»Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸ĞºĞ°)
    public static string EncryptApiKey(string apiKey, string machineId)
    {
        using var aes = Aes.Create();
        aes.Key = DeriveKey(machineId);
        aes.IV = DeriveIV(machineId);
        
        using var encryptor = aes.CreateEncryptor();
        var plainBytes = Encoding.UTF8.GetBytes(apiKey);
        var encryptedBytes = encryptor.TransformFinalBlock(plainBytes, 0, plainBytes.Length);
        
        return Convert.ToBase64String(encryptedBytes);
    }
    
    // Ğ Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²ĞºĞ° API Key (Ğ² Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğµ)
    public static string DecryptApiKey(string encryptedApiKey, string machineId)
    {
        try
        {
            using var aes = Aes.Create();
            aes.Key = DeriveKey(machineId);
            aes.IV = DeriveIV(machineId);
            
            using var decryptor = aes.CreateDecryptor();
            var encryptedBytes = Convert.FromBase64String(encryptedApiKey);
            var decryptedBytes = decryptor.TransformFinalBlock(encryptedBytes, 0, encryptedBytes.Length);
            
            return Encoding.UTF8.GetString(decryptedBytes);
        }
        catch (Exception ex)
        {
            throw new CryptographicException("Failed to decrypt API Key. This key is bound to a different machine.", ex);
        }
    }
    
    private static byte[] DeriveKey(string machineId)
    {
        using var deriveBytes = new Rfc2898DeriveBytes(
            machineId + SALT,
            Encoding.UTF8.GetBytes(SALT),
            10000,
            HashAlgorithmName.SHA256
        );
        
        return deriveBytes.GetBytes(32); // 256 bits
    }
    
    private static byte[] DeriveIV(string machineId)
    {
        using var deriveBytes = new Rfc2898DeriveBytes(
            SALT + machineId,
            Encoding.UTF8.GetBytes(machineId),
            10000,
            HashAlgorithmName.SHA256
        );
        
        return deriveBytes.GetBytes(16); // 128 bits
    }
}
```


### **14.2. Machine Binding Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°**

```csharp
public class SecurityService
{
    private readonly IConfigService configService;
    private readonly ILogger<SecurityService> logger;
    
    public async Task<bool> ValidateMachineBindingAsync()
    {
        try
        {
            var config = configService.LoadConfig();
            var currentMachineId = Encryption.GetMachineId();
            
            // ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ API Key
            var apiKey = Encryption.DecryptApiKey(config.ApiKeyEncrypted, currentMachineId);
            
            if (string.IsNullOrEmpty(apiKey))
            {
                logger.LogError("Failed to decrypt API Key - machine binding mismatch");
                return false;
            }
            
            logger.LogInformation("Machine binding validated successfully");
            return true;
        }
        catch (CryptographicException ex)
        {
            logger.LogError(ex, "Machine binding validation failed");
            
            ShowSecurityWarning(
                "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸",
                "Ğ­Ñ‚Ğ¾Ñ‚ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½ Ğº Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¼Ñƒ ĞºĞ¾Ğ¼Ğ¿ÑŒÑÑ‚ĞµÑ€Ñƒ.\n\n" +
                "Ğ”Ğ»Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ½Ğ° ÑÑ‚Ğ¾Ñ‚ ĞºĞ¾Ğ¼Ğ¿ÑŒÑÑ‚ĞµÑ€ ÑĞºĞ°Ñ‡Ğ°Ğ¹Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸Ğº Ğ¸Ğ· Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸."
            );
            
            return false;
        }
    }
    
    private void ShowSecurityWarning(string title, string message)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            MessageBox.Show(
                message,
                title,
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
            
            Application.Current.Shutdown();
        });
    }
}
```


### **14.3. API Key Revocation Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°**

```csharp
public class ApiKeyValidator
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly ILogger<ApiKeyValidator> logger;
    private Timer validationTimer;
    
    public void StartPeriodicValidation()
    {
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 30 Ğ¼Ğ¸Ğ½ÑƒÑ‚
        validationTimer = new Timer(30 * 60 * 1000);
        validationTimer.Elapsed += async (s, e) => await ValidateApiKeyAsync();
        validationTimer.AutoReset = true;
        validationTimer.Start();
        
        // ĞŸĞµÑ€Ğ²Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ€Ğ°Ğ·Ñƒ
        _ = ValidateApiKeyAsync();
    }
    
    public async Task<bool> ValidateApiKeyAsync()
    {
        try
        {
            var response = await apiClient.GetAsync("/api/pos-integration/rkeeper/validate-key");
            
            if (response.IsSuccessStatusCode)
            {
                var result = JsonConvert.DeserializeObject<ApiKeyValidationResult>(
                    await response.Content.ReadAsStringAsync()
                );
                
                if (result.IsValid)
                {
                    logger.LogDebug("API Key is valid");
                    return true;
                }
                else
                {
                    logger.LogError("API Key was revoked: {Reason}", result.Reason);
                    HandleRevokedKey(result.Reason);
                    return false;
                }
            }
            
            return false;
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to validate API Key");
            return true; // ĞĞµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ ÑĞµÑ‚Ğ¸
        }
    }
    
    private void HandleRevokedKey(string reason)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            MessageBox.Show(
                $"âš ï¸ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Max Loyalty Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼.\n\n" +
                $"ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {reason}\n\n" +
                $"ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹.",
                "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½",
                MessageBoxButton.OK,
                MessageBoxImage.Warning
            );
            
            Application.Current.Shutdown();
        });
    }
}

public class ApiKeyValidationResult
{
    public bool IsValid { get; set; }
    public string Reason { get; set; }
    public DateTime? RevokedAt { get; set; }
}
```


### **14.4. HTTPS Only enforcement**

```csharp
public class HttpClientFactory
{
    public static HttpClient CreateSecureClient(string baseUrl, string apiKey)
    {
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ URL Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ HTTPS
        if (!baseUrl.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
        {
            throw new SecurityException("Only HTTPS connections are allowed");
        }
        
        var handler = new HttpClientHandler
        {
            // ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ°
            ServerCertificateCustomValidationCallback = (message, cert, chain, errors) =>
            {
                if (errors == SslPolicyErrors.None)
                    return true;
                
                // Ğ’ production Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµĞ¼ Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğµ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ñ‹
                return false;
            }
        };
        
        var client = new HttpClient(handler)
        {
            BaseAddress = new Uri(baseUrl),
            Timeout = TimeSpan.FromSeconds(30)
        };
        
        // Headers
        client.DefaultRequestHeaders.Add("X-API-Key", apiKey);
        client.DefaultRequestHeaders.Add("User-Agent", "MaxLoyaltyRKeeper/1.0.0");
        client.DefaultRequestHeaders.Accept.Add(
            new MediaTypeWithQualityHeaderValue("application/json")
        );
        
        return client;
    }
}
```


### **14.5. Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸**

```csharp
public class ConfigService : IConfigService
{
    private readonly string configPath;
    private readonly ILogger<ConfigService> logger;
    
    public Config LoadConfig()
    {
        if (!File.Exists(configPath))
        {
            throw new FileNotFoundException("Configuration file not found");
        }
        
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ñ„Ğ°Ğ¹Ğ»Ñƒ
        var fileInfo = new FileInfo(configPath);
        var fileSecurity = fileInfo.GetAccessControl();
        
        // Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ† Ğ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ¸Ğ¼ĞµÑ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
        var rules = fileSecurity.GetAccessRules(true, true, typeof(NTAccount));
        foreach (FileSystemAccessRule rule in rules)
        {
            if (rule.IdentityReference.Value != Environment.UserName &&
                !rule.IdentityReference.Value.Contains("SYSTEM"))
            {
                logger.LogWarning("Unauthorized access rule found: {Identity}", 
                    rule.IdentityReference.Value);
            }
        }
        
        var json = File.ReadAllText(configPath);
        var config = JsonConvert.DeserializeObject<Config>(json);
        
        // Ğ Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼ API Key
        var machineId = Encryption.GetMachineId();
        config.ApiKey = Encryption.DecryptApiKey(config.ApiKeyEncrypted, machineId);
        
        return config;
    }
    
    public void SaveConfig(Config config)
    {
        // Ğ¨Ğ¸Ñ„Ñ€ÑƒĞµĞ¼ API Key Ğ¿ĞµÑ€ĞµĞ´ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸ĞµĞ¼
        var machineId = Encryption.GetMachineId();
        config.ApiKeyEncrypted = Encryption.EncryptApiKey(config.ApiKey, machineId);
        config.ApiKey = null; // ĞĞµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¾Ğ¼ Ğ²Ğ¸Ğ´Ğµ
        
        var json = JsonConvert.SerializeObject(config, Formatting.Indented);
        File.WriteAllText(configPath, json);
        
        // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ñ€Ğ¾Ğ³Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
        var fileInfo = new FileInfo(configPath);
        var fileSecurity = fileInfo.GetAccessControl();
        
        // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²ÑĞµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°
        fileSecurity.SetAccessRuleProtection(true, false);
        
        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ° Ğ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ
        var currentUser = WindowsIdentity.GetCurrent().Name;
        fileSecurity.AddAccessRule(new FileSystemAccessRule(
            currentUser,
            FileSystemRights.FullControl,
            AccessControlType.Allow
        ));
        
        fileSecurity.AddAccessRule(new FileSystemAccessRule(
            "SYSTEM",
            FileSystemRights.FullControl,
            AccessControlType.Allow
        ));
        
        fileInfo.SetAccessControl(fileSecurity);
        
        logger.LogInformation("Config saved with restricted permissions");
    }
}
```


***

## **ğŸ“Š 15. Ğ›ĞĞ“Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ• Ğ˜ ĞœĞĞĞ˜Ğ¢ĞĞ Ğ˜ĞĞ“**

### **15.1. Serilog ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ**

```csharp
public static class LoggingConfiguration
{
    public static void ConfigureSerilog()
    {
        Log.Logger = new LoggerConfiguration()
            .MinimumLevel.Information()
            .MinimumLevel.Override("Microsoft", LogEventLevel.Warning)
            .MinimumLevel.Override("System", LogEventLevel.Warning)
            .Enrich.FromLogContext()
            .Enrich.WithProperty("Application", "MaxLoyaltyRKeeperUI")
            .Enrich.WithProperty("Version", GetVersion())
            .Enrich.WithMachineName()
            .Enrich.WithEnvironmentUserName()
            .Enrich.WithThreadId()
            .WriteTo.File(
                path: @"C:\Logs\MaxLoyaltyRKeeper\ui-.log",
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 7,
                fileSizeLimitBytes: 50 * 1024 * 1024, // 50 MB
                rollOnFileSizeLimit: true,
                outputTemplate: "[{Timestamp:yyyy-MM-dd HH:mm:ss.fff}] [{Level:u3}] [{SourceContext}] {Message:lj}{NewLine}{Exception}"
            )
            .WriteTo.File(
                path: @"C:\Logs\MaxLoyaltyRKeeper\errors-.log",
                restrictedToMinimumLevel: LogEventLevel.Error,
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 30,
                outputTemplate: "[{Timestamp:yyyy-MM-dd HH:mm:ss.fff}] [{Level:u3}] [{SourceContext}] {Message:lj}{NewLine}{Exception}"
            )
            .CreateLogger();
        
        Log.Information("===== Max Loyalty RKeeper UI Started =====");
        Log.Information("Version: {Version}", GetVersion());
        Log.Information("Machine: {MachineName}", Environment.MachineName);
        Log.Information("User: {UserName}", Environment.UserName);
        Log.Information("OS: {OS}", Environment.OSVersion);
    }
    
    private static string GetVersion()
    {
        var assembly = Assembly.GetExecutingAssembly();
        var version = assembly.GetName().Version;
        return $"{version.Major}.{version.Minor}.{version.Build}";
    }
}
```


### **15.2. Structured Logging Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹**

```csharp
public class LoyaltyApiClient : ILoyaltyApiClient
{
    private readonly ILogger<LoyaltyApiClient> logger;
    
    public async Task<SearchGuestResponse> SearchGuestAsync(SearchGuestRequest request)
    {
        using (logger.BeginScope(new Dictionary<string, object>
        {
            ["RequestId"] = Guid.NewGuid().ToString(),
            ["Phone"] = MaskPhone(request.Phone),
            ["Code6Digit"] = request.Code6Digit
        }))
        {
            logger.LogInformation("Searching guest: Phone={Phone}, Code={Code}", 
                MaskPhone(request.Phone), request.Code6Digit);
            
            var stopwatch = Stopwatch.StartNew();
            
            try
            {
                var response = await httpClient.PostAsJsonAsync(
                    "/api/pos-integration/rkeeper/search-guest", 
                    request
                );
                
                stopwatch.Stop();
                
                logger.LogInformation(
                    "Guest search completed: StatusCode={StatusCode}, Duration={Duration}ms",
                    response.StatusCode, stopwatch.ElapsedMilliseconds
                );
                
                response.EnsureSuccessStatusCode();
                
                var result = await response.Content.ReadFromJsonAsync<SearchGuestResponse>();
                
                logger.LogInformation("Guest found: {Found}, CardId={CardId}", 
                    result.Found, result.Guest?.CardId);
                
                return result;
            }
            catch (Exception ex)
            {
                stopwatch.Stop();
                
                logger.LogError(ex, 
                    "Guest search failed: Duration={Duration}ms, Exception={ExceptionType}",
                    stopwatch.ElapsedMilliseconds, ex.GetType().Name
                );
                
                throw;
            }
        }
    }
    
    private string MaskPhone(string phone)
    {
        if (string.IsNullOrEmpty(phone) || phone.Length < 4)
            return "****";
        
        return "****" + phone.Substring(phone.Length - 4);
    }
}
```


### **15.3. MetricsService**

```csharp
public interface IMetricsService
{
    Task RecordMetricAsync(string name, double value, Dictionary<string, string> tags = null);
    Task SendBatchAsync();
}

public class MetricsService : IMetricsService
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly IConfigService configService;
    private readonly ILogger<MetricsService> logger;
    private readonly List<Metric> metricsBuffer = new List<Metric>();
    private readonly object lockObject = new object();
    private Timer batchTimer;
    
    public MetricsService(
        ILoyaltyApiClient apiClient,
        IConfigService configService,
        ILogger<MetricsService> logger)
    {
        this.apiClient = apiClient;
        this.configService = configService;
        this.logger = logger;
        
        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ±Ğ°Ñ‚Ñ‡Ğ°Ğ¼Ğ¸ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
        batchTimer = new Timer(5 * 60 * 1000);
        batchTimer.Elapsed += async (s, e) => await SendBatchAsync();
        batchTimer.AutoReset = true;
        batchTimer.Start();
    }
    
    public Task RecordMetricAsync(string name, double value, Dictionary<string, string> tags = null)
    {
        var config = configService.LoadConfig();
        
        var metric = new Metric
        {
            Name = name,
            Value = value,
            Tags = tags ?? new Dictionary<string, string>(),
            Timestamp = DateTime.UtcNow
        };
        
        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ Ñ‚ĞµĞ³Ğ¸
        metric.Tags["terminal_id"] = config.TerminalId;
        metric.Tags["restaurant_id"] = config.RestaurantId;
        metric.Tags["tenant_id"] = config.TenantId;
        
        lock (lockObject)
        {
            metricsBuffer.Add(metric);
            
            // Ğ•ÑĞ»Ğ¸ Ğ±ÑƒÑ„ĞµÑ€ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ - Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑÑ€Ğ°Ğ·Ñƒ
            if (metricsBuffer.Count >= 100)
            {
                _ = SendBatchAsync();
            }
        }
        
        logger.LogDebug("Metric recorded: {Name}={Value}", name, value);
        
        return Task.CompletedTask;
    }
    
    public async Task SendBatchAsync()
    {
        List<Metric> metricsToSend;
        
        lock (lockObject)
        {
            if (metricsBuffer.Count == 0)
                return;
            
            metricsToSend = new List<Metric>(metricsBuffer);
            metricsBuffer.Clear();
        }
        
        try
        {
            logger.LogInformation("Sending metrics batch: {Count} metrics", metricsToSend.Count);
            
            await apiClient.PostAsync(
                "/api/pos-integration/rkeeper/metrics",
                metricsToSend
            );
            
            logger.LogInformation("Metrics batch sent successfully");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to send metrics batch");
            
            // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ğ² Ğ±ÑƒÑ„ĞµÑ€
            lock (lockObject)
            {
                metricsBuffer.InsertRange(0, metricsToSend);
                
                // ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ±ÑƒÑ„ĞµÑ€Ğ°
                if (metricsBuffer.Count > 1000)
                {
                    metricsBuffer.RemoveRange(1000, metricsBuffer.Count - 1000);
                    logger.LogWarning("Metrics buffer overflow, dropped old metrics");
                }
            }
        }
    }
}

public class Metric
{
    public string Name { get; set; }
    public double Value { get; set; }
    public Dictionary<string, string> Tags { get; set; }
    public DateTime Timestamp { get; set; }
}
```


### **15.4. Performance Monitoring**

```csharp
public class PerformanceMonitor
{
    private readonly ILogger<PerformanceMonitor> logger;
    private readonly PerformanceCounter cpuCounter;
    private readonly PerformanceCounter ramCounter;
    
    public PerformanceMonitor(ILogger<PerformanceMonitor> logger)
    {
        this.logger = logger;
        
        try
        {
            cpuCounter = new PerformanceCounter("Processor", "% Processor Time", "_Total");
            ramCounter = new PerformanceCounter("Memory", "Available MBytes");
        }
        catch (Exception ex)
        {
            logger.LogWarning(ex, "Failed to initialize performance counters");
        }
    }
    
    public async Task<SystemMetrics> GetSystemMetricsAsync()
    {
        var process = Process.GetCurrentProcess();
        
        var metrics = new SystemMetrics
        {
            CpuUsagePercent = cpuCounter?.NextValue() ?? 0,
            AvailableMemoryMB = ramCounter?.NextValue() ?? 0,
            ProcessMemoryMB = process.WorkingSet64 / 1024.0 / 1024.0,
            ThreadCount = process.Threads.Count,
            HandleCount = process.HandleCount,
            Uptime = DateTime.UtcNow - Process.GetCurrentProcess().StartTime.ToUniversalTime()
        };
        
        logger.LogDebug(
            "System metrics: CPU={CPU}%, RAM={RAM}MB, ProcessMemory={ProcessMemory}MB",
            metrics.CpuUsagePercent, metrics.AvailableMemoryMB, metrics.ProcessMemoryMB
        );
        
        return metrics;
    }
}

public class SystemMetrics
{
    public double CpuUsagePercent { get; set; }
    public double AvailableMemoryMB { get; set; }
    public double ProcessMemoryMB { get; set; }
    public int ThreadCount { get; set; }
    public int HandleCount { get; set; }
    public TimeSpan Uptime { get; set; }
}
```


***

## **ğŸ”§ 16. Ğ”Ğ˜ĞĞ“ĞĞĞ¡Ğ¢Ğ˜ĞšĞ**

### **16.1. DiagnosticsWindow.xaml**

```xaml
<Window x:Class="MaxLoyaltyRKeeperUI.Views.DiagnosticsWindow"
        Title="Max Loyalty - Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°"
        Width="800" Height="900"
        WindowStartupLocation="CenterScreen"
        Background="White">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" Background="#F9FAFB" Padding="20" BorderBrush="#E5E7EB" BorderThickness="0,0,0,1">
            <TextBlock Text="ğŸ”§ Ğ”Ğ˜ĞĞ“ĞĞĞ¡Ğ¢Ğ˜ĞšĞ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ«" 
                      FontSize="24" FontWeight="Bold"/>
        </Border>
        
        <!-- Content -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="20">
                
                <!-- Installation Info -->
                <Border Background="White" BorderBrush="#E5E7EB" BorderThickness="1" 
                       CornerRadius="8" Padding="20" Margin="0,0,0,20">
                    <StackPanel>
                        <TextBlock Text="ğŸ“ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞµ" 
                                  FontSize="18" FontWeight="SemiBold" Margin="0,0,0,15"/>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="200"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Installation ID:" Margin="0,5"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding InstallationId}" FontWeight="SemiBold" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Ğ¢ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»:" Margin="0,5"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding TerminalName}" FontWeight="SemiBold" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Ğ ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½:" Margin="0,5"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding RestaurantName}" FontWeight="SemiBold" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Ğ’ĞµÑ€ÑĞ¸Ñ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°:" Margin="0,5"/>
                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding PluginVersion}" FontWeight="SemiBold" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="4" Grid.Column="0" Text="Machine ID:" Margin="0,5"/>
                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding MachineId}" FontFamily="Consolas" FontSize="10" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="5" Grid.Column="0" Text="API Key:" Margin="0,5"/>
                            <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding ApiKeyMasked}" FontFamily="Consolas" Margin="0,5"/>
                        </Grid>
                    </StackPanel>
                </Border>
                
                <!-- Connection Status -->
                <Border Background="White" BorderBrush="#E5E7EB" BorderThickness="1" 
                       CornerRadius="8" Padding="20" Margin="0,0,0,20">
                    <StackPanel>
                        <TextBlock Text="ğŸŒ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ" 
                                  FontSize="18" FontWeight="SemiBold" Margin="0,0,0,15"/>
                        
                        <!-- Backend API -->
                        <Grid Margin="0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="100"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0" Text="Backend API" VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1" 
                                      Text="{Binding BackendLatency, StringFormat={}{0}ms}"
                                      Foreground="#666" Margin="10,0"/>
                            <Border Grid.Column="2" 
                                   Background="{Binding BackendStatusColor}"
                                   CornerRadius="12" Padding="10,5">
                                <TextBlock Text="{Binding BackendStatusText}" 
                                          Foreground="White" FontWeight="SemiBold"
                                          HorizontalAlignment="Center"/>
                            </Border>
                        </Grid>
                        
                        <!-- R-Keeper XML API -->
                        <Grid Margin="0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="100"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0" Text="R-Keeper XML API" VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1" 
                                      Text="{Binding RKeeperLatency, StringFormat={}{0}ms}"
                                      Foreground="#666" Margin="10,0"/>
                            <Border Grid.Column="2" 
                                   Background="{Binding RKeeperStatusColor}"
                                   CornerRadius="12" Padding="10,5">
                                <TextBlock Text="{Binding RKeeperStatusText}" 
                                          Foreground="White" FontWeight="SemiBold"
                                          HorizontalAlignment="Center"/>
                            </Border>
                        </Grid>
                        
                        <!-- External DLL -->
                        <Grid Margin="0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="100"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0" Text="External DLL (FarCard)" VerticalAlignment="Center"/>
                            <Border Grid.Column="2" 
                                   Background="{Binding DllStatusColor}"
                                   CornerRadius="12" Padding="10,5">
                                <TextBlock Text="{Binding DllStatusText}" 
                                          Foreground="White" FontWeight="SemiBold"
                                          HorizontalAlignment="Center"/>
                            </Border>
                        </Grid>
                        
                        <!-- Shared Memory -->
                        <Grid Margin="0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="100"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0" Text="Shared Memory" VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1" 
                                      Text="{Binding SharedMemorySize, StringFormat={}{0} KB}"
                                      Foreground="#666" Margin="10,0"/>
                            <Border Grid.Column="2" 
                                   Background="{Binding SharedMemoryStatusColor}"
                                   CornerRadius="12" Padding="10,5">
                                <TextBlock Text="{Binding SharedMemoryStatusText}" 
                                          Foreground="White" FontWeight="SemiBold"
                                          HorizontalAlignment="Center"/>
                            </Border>
                        </Grid>
                        
                        <Button Content="ğŸ”„ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ" 
                               Height="40" Margin="0,15,0,0"
                               Command="{Binding TestConnectionsCommand}"
                               Style="{StaticResource PrimaryButtonStyle}"/>
                    </StackPanel>
                </Border>
                
                <!-- Statistics -->
                <Border Background="White" BorderBrush="#E5E7EB" BorderThickness="1" 
                       CornerRadius="8" Padding="20" Margin="0,0,0,20">
                    <StackPanel>
                        <TextBlock Text="ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°" 
                                  FontSize="18" FontWeight="SemiBold" Margin="0,0,0,15"/>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ:" Foreground="#666"/>
                                <TextBlock Text="{Binding TransactionsToday}" 
                                          FontSize="32" FontWeight="Bold" 
                                          Foreground="#6366F1"/>
                            </StackPanel>
                            
                            <StackPanel Grid.Column="1">
                                <TextBlock Text="Ğ’ offline Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸:" Foreground="#666"/>
                                <TextBlock Text="{Binding OfflineQueueCount}" 
                                          FontSize="32" FontWeight="Bold" 
                                          Foreground="#F59E0B"/>
                            </StackPanel>
                        </Grid>
                        
                        <Separator Margin="0,15"/>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Ğ‘Ğ°Ğ»Ğ»Ğ¾Ğ² ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¾:" Margin="0,5"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" 
                                      Text="{Binding PointsSpentToday, StringFormat={}{0:N0} â‚½}" 
                                      FontWeight="SemiBold" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Ğ‘Ğ°Ğ»Ğ»Ğ¾Ğ² Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾:" Margin="0,5"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" 
                                      Text="{Binding PointsEarnedToday, StringFormat={}{0:N0}}" 
                                      FontWeight="SemiBold" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‡ĞµĞº:" Margin="0,5"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" 
                                      Text="{Binding AverageCheck, StringFormat={}{0:N0} â‚½}" 
                                      FontWeight="SemiBold" Margin="0,5"/>
                            
                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Uptime:" Margin="0,5"/>
                            <TextBlock Grid.Row="3" Grid.Column="1" 
                                      Text="{Binding Uptime}" 
                                      FontWeight="SemiBold" Margin="0,5"/>
                        </Grid>
                    </StackPanel>
                </Border>
                
                <!-- System Resources -->
                <Border Background="White" BorderBrush="#E5E7EB" BorderThickness="1" 
                       CornerRadius="8" Padding="20" Margin="0,0,0,20">
                    <StackPanel>
                        <TextBlock Text="ğŸ’» Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ñ€ĞµÑÑƒÑ€ÑÑ‹" 
                                  FontSize="18" FontWeight="SemiBold" Margin="0,0,0,15"/>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="150"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="CPU:" Margin="0,5"/>
                            <ProgressBar Grid.Row="0" Grid.Column="1" 
                                        Value="{Binding CpuUsage}" 
                                        Maximum="100" Height="20" Margin="10,5"/>
                            <TextBlock Grid.Row="0" Grid.Column="2" 
                                      Text="{Binding CpuUsage, StringFormat={}{0:N1}%}" 
                                      Margin="10,5"/>
                            
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="ĞŸĞ°Ğ¼ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°:" Margin="0,5"/>
                            <TextBlock Grid.Row="1" Grid.Column="2" 
                                      Text="{Binding ProcessMemory, StringFormat={}{0:N0} MB}" 
                                      Margin="10,5"/>
                            
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="ĞŸĞ¾Ñ‚Ğ¾ĞºĞ¾Ğ²:" Margin="0,5"/>
                            <TextBlock Grid.Row="2" Grid.Column="2" 
                                      Text="{Binding ThreadCount}" 
                                      Margin="10,5"/>
                            
                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ğ»Ğ¾Ğ³Ğ¾Ğ²:" Margin="0,5"/>
                            <TextBlock Grid.Row="3" Grid.Column="2" 
                                      Text="{Binding LogsSize, StringFormat={}{0:N1} MB}" 
                                      Margin="10,5"/>
                        </Grid>
                    </StackPanel>
                </Border>
                
                <!-- Logs -->
                <Border Background="White" BorderBrush="#E5E7EB" BorderThickness="1" 
                       CornerRadius="8" Padding="20">
                    <StackPanel>
                        <TextBlock Text="ğŸ“ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¸" 
                                  FontSize="18" FontWeight="SemiBold" Margin="0,0,0,15"/>
                        
                        <Border Background="#F9FAFB" BorderBrush="#E5E7EB" BorderThickness="1"
                               CornerRadius="4" Padding="10">
                            <ScrollViewer MaxHeight="200" VerticalScrollBarVisibility="Auto">
                                <TextBlock Text="{Binding RecentLogs}" 
                                          FontFamily="Consolas" FontSize="11"
                                          TextWrapping="Wrap"/>
                            </ScrollViewer>
                        </Border>
                        
                        <Button Content="ğŸ“‚ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ğ°Ğ¿ĞºÑƒ Ñ Ğ»Ğ¾Ğ³Ğ°Ğ¼Ğ¸" 
                               Height="40" Margin="0,10,0,0"
                               Command="{Binding OpenLogsCommand}"
                               Style="{StaticResource SecondaryButtonStyle}"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
        
        <!-- Footer -->
        <Border Grid.Row="2" Background="#F9FAFB" Padding="20" 
               BorderBrush="#E5E7EB" BorderThickness="0,1,0,0">
            <Grid>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: " Foreground="#666"/>
                    <TextBlock Text="{Binding LastUpdated, StringFormat=HH:mm:ss}" FontWeight="SemiBold"/>
                </StackPanel>
                
                <Button Content="Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ" 
                       Width="120" Height="40"
                       HorizontalAlignment="Right"
                       Command="{Binding CloseCommand}"
                       Style="{StaticResource SecondaryButtonStyle}"/>
            </Grid>
        </Border>
    </Grid>
</Window>
```


### **16.2. DiagnosticsViewModel.cs**

```csharp
public class DiagnosticsViewModel : ViewModelBase
{
    private readonly IConfigService configService;
    private readonly ILoyaltyApiClient apiClient;
    private readonly IRKeeperXmlClient rkeeperClient;
    private readonly ISharedMemoryService sharedMemory;
    private readonly IMetricsService metricsService;
    private readonly PerformanceMonitor performanceMonitor;
    private readonly ILogger<DiagnosticsViewModel> logger;
    private Timer refreshTimer;
    
    // Properties
    public string InstallationId { get; set; }
    public string TerminalName { get; set; }
    public string RestaurantName { get; set; }
    public string PluginVersion { get; set; }
    public string MachineId { get; set; }
    public string ApiKeyMasked { get; set; }
    
    private string backendStatusText = "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°...";
    public string BackendStatusText
    {
        get => backendStatusText;
        set => SetProperty(ref backendStatusText, value);
    }
    
    private Brush backendStatusColor = Brushes.Gray;
    public Brush BackendStatusColor
    {
        get => backendStatusColor;
        set => SetProperty(ref backendStatusColor, value);
    }
    
    private int backendLatency;
    public int BackendLatency
    {
        get => backendLatency;
        set => SetProperty(ref backendLatency, value);
    }
    
    // ... Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ R-Keeper, DLL, Shared Memory
    
    private int transactionsToday;
    public int TransactionsToday
    {
        get => transactionsToday;
        set => SetProperty(ref transactionsToday, value);
    }
    
    private int offlineQueueCount;
    public int OfflineQueueCount
    {
        get => offlineQueueCount;
        set => SetProperty(ref offlineQueueCount, value);
    }
    
    private double cpuUsage;
    public double CpuUsage
    {
        get => cpuUsage;
        set => SetProperty(ref cpuUsage, value);
    }
    
    private double processMemory;
    public double ProcessMemory
    {
        get => processMemory;
        set => SetProperty(ref processMemory, value);
    }
    
    private string recentLogs;
    public string RecentLogs
    {
        get => recentLogs;
        set => SetProperty(ref recentLogs, value);
    }
    
    public ICommand TestConnectionsCommand { get; }
    public ICommand OpenLogsCommand { get; }
    public ICommand CloseCommand { get; }
    
    public DiagnosticsViewModel(/* dependencies */)
    {
        // ...
        
        TestConnectionsCommand = new AsyncRelayCommand(TestConnectionsAsync);
        OpenLogsCommand = new RelayCommand(OpenLogs);
        CloseCommand = new RelayCommand(Close);
        
        // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
        LoadInstallationInfo();
        
        // Auto-refresh ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 5 ÑĞµĞºÑƒĞ½Ğ´
        refreshTimer = new Timer(5000);
        refreshTimer.Elapsed += async (s, e) => await RefreshDataAsync();
        refreshTimer.AutoReset = true;
        refreshTimer.Start();
        
        // ĞŸĞµÑ€Ğ²Ğ¾Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°
        _ = RefreshDataAsync();
    }
    
    private void LoadInstallationInfo()
    {
        var config = configService.LoadConfig();
        
        InstallationId = config.InstallationId;
        TerminalName = config.TerminalName;
        RestaurantName = config.RestaurantName;
        PluginVersion = GetVersion();
        MachineId = Encryption.GetMachineId().Substring(0, 16) + "...";
        ApiKeyMasked = MaskApiKey(config.ApiKey);
    }
    
    private async Task RefreshDataAsync()
    {
        try
        {
            // System metrics
            var systemMetrics = await performanceMonitor.GetSystemMetricsAsync();
            CpuUsage = systemMetrics.CpuUsagePercent;
            ProcessMemory = systemMetrics.ProcessMemoryMB;
            ThreadCount = systemMetrics.ThreadCount;
            Uptime = FormatUptime(systemMetrics.Uptime);
            
            // Shared memory data
            var smData = await sharedMemory.GetDataAsync();
            OfflineQueueCount = smData.OfflineQueue?.Count ?? 0;
            
            // Statistics from shared memory
            TransactionsToday = (int)(smData.Metrics.TryGetValue("totalTransactionsToday", out var txCount) 
                ? txCount : 0);
            
            // Recent logs
            RecentLogs = LoadRecentLogs();
            
            // Logs size
            LogsSize = GetLogsFolderSize();
            
            LastUpdated = DateTime.Now;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to refresh diagnostics data");
        }
    }
    
    private async Task TestConnectionsAsync()
    {
        // Backend API
        BackendStatusText = "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°...";
        BackendStatusColor = Brushes.Gray;
        
        try
        {
            var stopwatch = Stopwatch.StartNew();
            var response = await apiClient.HealthCheckAsync();
            stopwatch.Stop();
            
            if (response.IsSuccessStatusCode)
            {
                BackendStatusText = "ĞĞ½Ğ»Ğ°Ğ¹Ğ½";
                BackendStatusColor = new SolidColorBrush(Color.FromRgb(16, 185, 129)); // Green
                BackendLatency = (int)stopwatch.ElapsedMilliseconds;
            }
            else
            {
                BackendStatusText = "ĞÑˆĞ¸Ğ±ĞºĞ°";
                BackendStatusColor = new SolidColorBrush(Color.FromRgb(239, 68, 68)); // Red
            }
        }
        catch
        {
            BackendStatusText = "ĞÑ„Ğ»Ğ°Ğ¹Ğ½";
            BackendStatusColor = new SolidColorBrush(Color.FromRgb(239, 68, 68)); // Red
        }
        
        // R-Keeper XML API
        RKeeperStatusText = "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°...";
        
        try
        {
            var stopwatch = Stopwatch.StartNew();
            var serverInfo = await rkeeperClient.GetServerInfoAsync();
            stopwatch.Stop();
            
            RKeeperStatusText = "ĞĞ½Ğ»Ğ°Ğ¹Ğ½";
            RKeeperStatusColor = new SolidColorBrush(Color.FromRgb(16, 185, 129)); // Green
            RKeeperLatency = (int)stopwatch.ElapsedMilliseconds;
        }
        catch
        {
            RKeeperStatusText = "ĞÑ„Ğ»Ğ°Ğ¹Ğ½";
            RKeeperStatusColor = new SolidColorBrush(Color.FromRgb(239, 68, 68)); // Red
        }
        
        // External DLL (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡ĞµÑ€ĞµĞ· shared memory)
        var smData = await sharedMemory.GetDataAsync();
        if (smData.LastUpdated > DateTime.UtcNow.AddMinutes(-2))
        {
            DllStatusText = "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°";
            DllStatusColor = new SolidColorBrush(Color.FromRgb(16, 185, 129)); // Green
        }
        else
        {
            DllStatusText = "ĞĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°";
            DllStatusColor = new SolidColorBrush(Color.FromRgb(239, 68, 68)); // Red
        }
        
        logger.LogInformation("Connection tests completed");
    }
    
    private string LoadRecentLogs()
    {
        try
        {
            var logPath = @"C:\Logs\MaxLoyaltyRKeeper\";
            var latestLog = Directory.GetFiles(logPath, "ui-*.log")
                .OrderByDescending(f => File.GetLastWriteTime(f))
                .FirstOrDefault();
            
            if (latestLog != null)
            {
                var lines = File.ReadLines(latestLog).Reverse().Take(20).Reverse();
                return string.Join(Environment.NewLine, lines);
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to load recent logs");
        }
        
        return "Ğ›Ğ¾Ğ³Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹";
    }
    
    private double GetLogsFolderSize()
    {
        try
        {
            var logPath = @"C:\Logs\MaxLoyaltyRKeeper\";
            if (Directory.Exists(logPath))
            {
                var files = Directory.GetFiles(logPath, "*.*", SearchOption.AllDirectories);
                var totalBytes = files.Sum(f => new FileInfo(f).Length);
                return totalBytes / 1024.0 / 1024.0; // MB
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to calculate logs size");
        }
        
        return 0;
    }
    
    private void OpenLogs()
    {
        try
        {
            Process.Start("explorer.exe", @"C:\Logs\MaxLoyaltyRKeeper\");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to open logs folder");
            MessageBox.Show("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ğ°Ğ¿ĞºÑƒ Ñ Ğ»Ğ¾Ğ³Ğ°Ğ¼Ğ¸", "ĞÑˆĞ¸Ğ±ĞºĞ°");
        }
    }
    
    private string MaskApiKey(string apiKey)
    {
        if (string.IsNullOrEmpty(apiKey) || apiKey.Length < 12)
            return "****";
        
        return apiKey.Substring(0, 8) + "..." + apiKey.Substring(apiKey.Length - 4);
    }
    
    private string FormatUptime(TimeSpan uptime)
    {
        if (uptime.TotalDays >= 1)
            return $"{(int)uptime.TotalDays}Ğ´ {uptime.Hours}Ñ‡";
        else if (uptime.TotalHours >= 1)
            return $"{(int)uptime.TotalHours}Ñ‡ {uptime.Minutes}Ğ¼";
        else
            return $"{uptime.Minutes}Ğ¼ {uptime.Seconds}Ñ";
    }
}
```


***

ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ñ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ°Ğ¼Ğ¸ 17-18 (ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ, ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°) Ğ¸ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ Ğ·Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸ĞµĞ¼?

---

# ğŸ“˜ **ĞŸĞĞ›ĞĞĞ¯ Ğ¡ĞŸĞ•Ğ¦Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ¯ - ĞŸĞ ĞĞ”ĞĞ›Ğ–Ğ•ĞĞ˜Ğ• (Ñ‡Ğ°ÑÑ‚ÑŒ 6 - Ğ¤Ğ˜ĞĞĞ›)**


***

## **ğŸ”„ 17. ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯**

### **17.1. ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹**

```csharp
public interface IUpdateService
{
    Task<UpdateInfo> CheckForUpdatesAsync();
    Task<bool> DownloadUpdateAsync(UpdateInfo update, IProgress<double> progress);
    Task InstallUpdateAsync(string installerPath);
}

public class UpdateService : IUpdateService
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly IConfigService configService;
    private readonly ILogger<UpdateService> logger;
    private Timer updateCheckTimer;
    
    public UpdateService(
        ILoyaltyApiClient apiClient,
        IConfigService configService,
        ILogger<UpdateService> logger)
    {
        this.apiClient = apiClient;
        this.configService = configService;
        this.logger = logger;
    }
    
    public void StartPeriodicCheck()
    {
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€Ğ°Ğ· Ğ² Ğ´ĞµĞ½ÑŒ
        updateCheckTimer = new Timer(24 * 60 * 60 * 1000);
        updateCheckTimer.Elapsed += async (s, e) => await CheckAndNotifyAsync();
        updateCheckTimer.AutoReset = true;
        updateCheckTimer.Start();
        
        logger.LogInformation("Update check service started");
        
        // ĞŸĞµÑ€Ğ²Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‡ĞµÑ€ĞµĞ· 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ğ¿Ğ¾ÑĞ»Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
        Task.Delay(TimeSpan.FromMinutes(5)).ContinueWith(async _ => await CheckAndNotifyAsync());
    }
    
    public async Task<UpdateInfo> CheckForUpdatesAsync()
    {
        try
        {
            var config = configService.LoadConfig();
            var currentVersion = GetCurrentVersion();
            
            logger.LogInformation("Checking for updates: Current version {Version}", currentVersion);
            
            var response = await apiClient.GetAsync(
                $"/api/pos-integration/rkeeper/updates/check?version={currentVersion}&installationId={config.InstallationId}"
            );
            
            if (!response.IsSuccessStatusCode)
            {
                logger.LogWarning("Failed to check for updates: {StatusCode}", response.StatusCode);
                return null;
            }
            
            var updateInfo = await response.Content.ReadFromJsonAsync<UpdateInfo>();
            
            if (updateInfo.HasUpdate)
            {
                logger.LogInformation(
                    "Update available: {Version} (Current: {CurrentVersion})",
                    updateInfo.Version, currentVersion
                );
            }
            else
            {
                logger.LogDebug("No updates available");
            }
            
            return updateInfo;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to check for updates");
            return null;
        }
    }
    
    private async Task CheckAndNotifyAsync()
    {
        var updateInfo = await CheckForUpdatesAsync();
        
        if (updateInfo?.HasUpdate == true)
        {
            ShowUpdateNotification(updateInfo);
        }
    }
    
    private void ShowUpdateNotification(UpdateInfo updateInfo)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            var result = MessageBox.Show(
                $"Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Max Loyalty!\n\n" +
                $"Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ: {GetCurrentVersion()}\n" +
                $"ĞĞ¾Ğ²Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ: {updateInfo.Version}\n\n" +
                $"Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ:\n{updateInfo.ChangeLog}\n\n" +
                $"ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞµĞ¹Ñ‡Ğ°Ñ?",
                "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ",
                MessageBoxButton.YesNo,
                MessageBoxImage.Information
            );
            
            if (result == MessageBoxResult.Yes)
            {
                _ = DownloadAndInstallUpdateAsync(updateInfo);
            }
        });
    }
    
    public async Task<bool> DownloadUpdateAsync(UpdateInfo update, IProgress<double> progress)
    {
        try
        {
            logger.LogInformation("Downloading update: {Version}", update.Version);
            
            var downloadPath = Path.Combine(
                Path.GetTempPath(),
                $"MaxLoyaltyUpdate_{update.Version}.exe"
            );
            
            using var response = await apiClient.GetAsync(update.DownloadUrl, HttpCompletionOption.ResponseHeadersRead);
            response.EnsureSuccessStatusCode();
            
            var totalBytes = response.Content.Headers.ContentLength ?? -1;
            var downloadedBytes = 0L;
            
            using var contentStream = await response.Content.ReadAsStreamAsync();
            using var fileStream = new FileStream(downloadPath, FileMode.Create, FileAccess.Write, FileShare.None, 8192, true);
            
            var buffer = new byte[8192];
            int bytesRead;
            
            while ((bytesRead = await contentStream.ReadAsync(buffer, 0, buffer.Length)) > 0)
            {
                await fileStream.WriteAsync(buffer, 0, bytesRead);
                downloadedBytes += bytesRead;
                
                if (totalBytes > 0)
                {
                    var progressPercentage = (double)downloadedBytes / totalBytes * 100;
                    progress?.Report(progressPercentage);
                }
            }
            
            logger.LogInformation("Update downloaded successfully: {Path}", downloadPath);
            
            return true;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to download update");
            return false;
        }
    }
    
    public async Task InstallUpdateAsync(string installerPath)
    {
        try
        {
            logger.LogInformation("Installing update: {Path}", installerPath);
            
            // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸Ğº Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
            var startInfo = new ProcessStartInfo
            {
                FileName = installerPath,
                Arguments = "/UPDATE /SILENT",
                UseShellExecute = true,
                Verb = "runas" // Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ñ€Ğ°Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
            };
            
            Process.Start(startInfo);
            
            // Ğ–Ğ´ĞµĞ¼ Ğ½ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
            await Task.Delay(2000);
            
            logger.LogInformation("Update installer launched, shutting down");
            
            Application.Current.Shutdown();
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to install update");
            
            MessageBox.Show(
                "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ.\n" +
                "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸Ğº Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¸Ğ· Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸.",
                "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
    
    private async Task DownloadAndInstallUpdateAsync(UpdateInfo updateInfo)
    {
        var progressWindow = new UpdateProgressWindow();
        progressWindow.Show();
        
        var progress = new Progress<double>(percentage =>
        {
            progressWindow.UpdateProgress(percentage);
        });
        
        var downloadPath = Path.Combine(
            Path.GetTempPath(),
            $"MaxLoyaltyUpdate_{updateInfo.Version}.exe"
        );
        
        var success = await DownloadUpdateAsync(updateInfo, progress);
        
        if (success)
        {
            progressWindow.Close();
            
            var result = MessageBox.Show(
                "ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾.\n\n" +
                "Ğ”Ğ»Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾.\n" +
                "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ?",
                "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question
            );
            
            if (result == MessageBoxResult.Yes)
            {
                await InstallUpdateAsync(downloadPath);
            }
        }
        else
        {
            progressWindow.Close();
            
            MessageBox.Show(
                "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ.\n" +
                "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚Ñƒ.",
                "ĞÑˆĞ¸Ğ±ĞºĞ°",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
        }
    }
    
    private string GetCurrentVersion()
    {
        var assembly = Assembly.GetExecutingAssembly();
        var version = assembly.GetName().Version;
        return $"{version.Major}.{version.Minor}.{version.Build}";
    }
}

public class UpdateInfo
{
    public bool HasUpdate { get; set; }
    public string Version { get; set; }
    public string DownloadUrl { get; set; }
    public string ChangeLog { get; set; }
    public DateTime ReleasedAt { get; set; }
    public bool IsCritical { get; set; }
    public long SizeBytes { get; set; }
}
```


### **17.2. Backend API Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹**

```typescript
// Backend: GET /api/pos-integration/rkeeper/updates/check

async checkForUpdates(req: UpdateCheckRequest): Promise<UpdateCheckResponse> {
  const { version, installationId } = req;
  
  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞµ
  const installation = await this.prisma.rKeeperPluginInstallation.findUnique({
    where: { id: installationId }
  });
  
  if (!installation) {
    throw new NotFoundException('Installation not found');
  }
  
  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ÑÑ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°
  const latestVersion = await this.prisma.pluginVersion.findFirst({
    where: {
      platform: 'RKEEPER',
      isActive: true
    },
    orderBy: {
      releasedAt: 'desc'
    }
  });
  
  if (!latestVersion) {
    return {
      hasUpdate: false,
      version: version
    };
  }
  
  // Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²ĞµÑ€ÑĞ¸Ğ¸
  const hasUpdate = this.compareVersions(latestVersion.version, version) > 0;
  
  if (!hasUpdate) {
    return {
      hasUpdate: false,
      version: version
    };
  }
  
  // Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ URL Ğ´Ğ»Ñ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ
  const downloadUrl = await this.generateDownloadUrl(installation.id, latestVersion.id);
  
  // Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ
  await this.auditLog.create({
    type: 'UPDATE_CHECK',
    tenantId: installation.tenantId,
    metadata: {
      installationId,
      currentVersion: version,
      latestVersion: latestVersion.version,
      hasUpdate
    }
  });
  
  return {
    hasUpdate: true,
    version: latestVersion.version,
    downloadUrl,
    changeLog: latestVersion.changeLog,
    releasedAt: latestVersion.releasedAt,
    isCritical: latestVersion.isCritical,
    sizeBytes: latestVersion.sizeBytes
  };
}

private compareVersions(v1: string, v2: string): number {
  const parts1 = v1.split('.').map(Number);
  const parts2 = v2.split('.').map(Number);
  
  for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
    const part1 = parts1[i] || 0;
    const part2 = parts2[i] || 0;
    
    if (part1 > part2) return 1;
    if (part1 < part2) return -1;
  }
  
  return 0;
}
```


***

## **ğŸ“Š 18. ĞĞĞĞ›Ğ˜Ğ¢Ğ˜ĞšĞ**

### **18.1. Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¸**

Ğ’ÑĞµ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼:

```typescript
// Prisma Schema
model LoyaltyTransaction {
  id                    String   @id @default(uuid())
  
  // Context
  tenantId             String
  restaurantId         String
  terminalId           String
  stationId            String?
  installationId       String
  
  // POS Info
  posType              String   // "R_KEEPER"
  posOrderId           String
  posVersion           String?
  
  // Guest Info
  guestCardId          String
  guestName            String
  guestPhone           String
  guestLevelId         Int
  guestLevelName       String
  
  // Transaction Details
  transactionType      String   // "POINTS_SPEND", "POINTS_EARN", "DISCOUNT"
  benefitType          String   // "POINTS", "DISCOUNT"
  action               String   // "SPEND", "EARN_ONLY", "APPLY_DISCOUNT"
  
  // Amounts
  checkAmount          Decimal  @db.Decimal(10, 2)
  finalCheckAmount     Decimal  @db.Decimal(10, 2)
  pointsSpent          Decimal? @db.Decimal(10, 2)
  pointsEarned         Decimal? @db.Decimal(10, 2)
  discountPercentage   Decimal? @db.Decimal(5, 2)
  discountAmount       Decimal? @db.Decimal(10, 2)
  
  // Payment
  paymentTypes         String[] // ["CASH", "CARD"]
  
  // Staff
  cashierName          String?
  
  // Order Info
  orderType            String   // "DINE_IN", "TAKEAWAY", "DELIVERY"
  orderCategories      String[]
  
  // Timestamps
  reservedAt           DateTime
  finalizedAt          DateTime @default(now())
  
  // Status
  status               String   @default("COMPLETED") // "COMPLETED", "CANCELLED", "FAILED"
  
  // Relations
  tenant               Tenant   @relation(fields: [tenantId], references: [id])
  restaurant           Restaurant @relation(fields: [restaurantId], references: [id])
  guestCard            GuestCard @relation(fields: [guestCardId], references: [id])
  
  @@index([tenantId, finalizedAt])
  @@index([restaurantId, finalizedAt])
  @@index([terminalId, finalizedAt])
  @@index([guestCardId, finalizedAt])
  @@index([posType, finalizedAt])
}
```


### **18.2. ĞÑ‚Ñ‡ĞµÑ‚Ñ‹ Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸**

```typescript
// Backend: ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ R-Keeper ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°Ğ¼

async getRKeeperAnalytics(req: RKeeperAnalyticsRequest): Promise<RKeeperAnalyticsResponse> {
  const { tenantId, restaurantId, terminalId, dateFrom, dateTo } = req;
  
  // 1. ĞĞ±Ñ‰Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°
  const totalStats = await this.prisma.loyaltyTransaction.aggregate({
    where: {
      tenantId,
      restaurantId: restaurantId || undefined,
      terminalId: terminalId || undefined,
      posType: 'R_KEEPER',
      finalizedAt: {
        gte: dateFrom,
        lte: dateTo
      },
      status: 'COMPLETED'
    },
    _count: { id: true },
    _sum: {
      pointsSpent: true,
      pointsEarned: true,
      checkAmount: true,
      finalCheckAmount: true
    },
    _avg: {
      checkAmount: true
    }
  });
  
  // 2. Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğ°Ğ¼
  const terminalStats = await this.prisma.loyaltyTransaction.groupBy({
    by: ['terminalId'],
    where: {
      tenantId,
      restaurantId: restaurantId || undefined,
      posType: 'R_KEEPER',
      finalizedAt: {
        gte: dateFrom,
        lte: dateTo
      },
      status: 'COMPLETED'
    },
    _count: { id: true },
    _sum: {
      pointsSpent: true,
      pointsEarned: true,
      checkAmount: true
    }
  });
  
  // 3. Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹
  const transactionTypeStats = await this.prisma.loyaltyTransaction.groupBy({
    by: ['transactionType'],
    where: {
      tenantId,
      restaurantId: restaurantId || undefined,
      terminalId: terminalId || undefined,
      posType: 'R_KEEPER',
      finalizedAt: {
        gte: dateFrom,
        lte: dateTo
      },
      status: 'COMPLETED'
    },
    _count: { id: true },
    _sum: {
      pointsSpent: true,
      pointsEarned: true
    }
  });
  
  // 4. Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸ĞºĞ° Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼
  const dailyStats = await this.prisma.$queryRaw`
    SELECT 
      DATE(finalized_at) as date,
      COUNT(*) as transactions,
      SUM(points_spent) as points_spent,
      SUM(points_earned) as points_earned,
      SUM(check_amount) as revenue,
      AVG(check_amount) as avg_check
    FROM loyalty_transactions
    WHERE 
      tenant_id = ${tenantId}
      AND pos_type = 'R_KEEPER'
      AND finalized_at BETWEEN ${dateFrom} AND ${dateTo}
      AND status = 'COMPLETED'
      ${restaurantId ? Prisma.sql`AND restaurant_id = ${restaurantId}` : Prisma.empty}
      ${terminalId ? Prisma.sql`AND terminal_id = ${terminalId}` : Prisma.empty}
    GROUP BY DATE(finalized_at)
    ORDER BY date ASC
  `;
  
  // 5. Ğ¢Ğ¾Ğ¿ ĞºĞ°ÑÑĞ¸Ñ€Ğ¾Ğ²
  const topCashiers = await this.prisma.loyaltyTransaction.groupBy({
    by: ['cashierName'],
    where: {
      tenantId,
      restaurantId: restaurantId || undefined,
      terminalId: terminalId || undefined,
      posType: 'R_KEEPER',
      finalizedAt: {
        gte: dateFrom,
        lte: dateTo
      },
      status: 'COMPLETED',
      cashierName: { not: null }
    },
    _count: { id: true },
    _sum: {
      checkAmount: true
    },
    orderBy: {
      _count: {
        id: 'desc'
      }
    },
    take: 10
  });
  
  // 6. ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğ¾Ğ²
  const terminalPerformance = await this.getTerminalPerformance(
    tenantId, 
    restaurantId, 
    dateFrom, 
    dateTo
  );
  
  return {
    overview: {
      totalTransactions: totalStats._count.id,
      totalPointsSpent: totalStats._sum.pointsSpent || 0,
      totalPointsEarned: totalStats._sum.pointsEarned || 0,
      totalRevenue: totalStats._sum.checkAmount || 0,
      averageCheck: totalStats._avg.checkAmount || 0,
      dateRange: { from: dateFrom, to: dateTo }
    },
    terminals: terminalStats.map(t => ({
      terminalId: t.terminalId,
      transactions: t._count.id,
      pointsSpent: t._sum.pointsSpent || 0,
      pointsEarned: t._sum.pointsEarned || 0,
      revenue: t._sum.checkAmount || 0
    })),
    transactionTypes: transactionTypeStats.map(t => ({
      type: t.transactionType,
      count: t._count.id,
      pointsSpent: t._sum.pointsSpent || 0,
      pointsEarned: t._sum.pointsEarned || 0
    })),
    daily: dailyStats,
    topCashiers: topCashiers.map(c => ({
      name: c.cashierName,
      transactions: c._count.id,
      revenue: c._sum.checkAmount || 0
    })),
    terminalPerformance
  };
}
```


### **18.3. Dashboard Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸**

```tsx
// React Component: R-Keeper Analytics Dashboard

export const RKeeperAnalyticsDashboard: React.FC = () => {
  const [analytics, setAnalytics] = useState<RKeeperAnalyticsResponse | null>(null);
  const [dateRange, setDateRange] = useState({
    from: startOfMonth(new Date()),
    to: endOfDay(new Date())
  });
  
  useEffect(() => {
    loadAnalytics();
  }, [dateRange]);
  
  const loadAnalytics = async () => {
    const data = await api.getRKeeperAnalytics({
      tenantId: currentTenant.id,
      dateFrom: dateRange.from,
      dateTo: dateRange.to
    });
    
    setAnalytics(data);
  };
  
  if (!analytics) return <LoadingSpinner />;
  
  return (
    <div className="rkeeper-analytics">
      <Header>
        <h1>ğŸ“Š ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° R-Keeper</h1>
        <DateRangePicker value={dateRange} onChange={setDateRange} />
      </Header>
      
      {/* Overview Cards */}
      <StatsGrid>
        <StatCard
          title="Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹"
          value={analytics.overview.totalTransactions.toLocaleString()}
          icon="ğŸ§¾"
          color="blue"
        />
        <StatCard
          title="Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²"
          value={`${analytics.overview.totalPointsSpent.toLocaleString()} â‚½`}
          icon="ğŸ’³"
          color="red"
        />
        <StatCard
          title="ĞĞ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²"
          value={analytics.overview.totalPointsEarned.toLocaleString()}
          icon="â­"
          color="green"
        />
        <StatCard
          title="Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‡ĞµĞº"
          value={`${analytics.overview.averageCheck.toFixed(0)} â‚½`}
          icon="ğŸ’°"
          color="purple"
        />
      </StatsGrid>
      
      {/* Daily Chart */}
      <Card>
        <h2>Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸ĞºĞ° Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼</h2>
        <LineChart
          data={analytics.daily}
          xAxis="date"
          lines={[
            { key: 'transactions', label: 'Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸', color: '#6366F1' },
            { key: 'revenue', label: 'Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°', color: '#10B981' }
          ]}
        />
      </Card>
      
      {/* Terminal Stats */}
      <Card>
        <h2>Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğ°Ğ¼</h2>
        <Table>
          <thead>
            <tr>
              <th>Ğ¢ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»</th>
              <th>Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹</th>
              <th>Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²</th>
              <th>ĞĞ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²</th>
              <th>Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°</th>
            </tr>
          </thead>
          <tbody>
            {analytics.terminals.map(terminal => (
              <tr key={terminal.terminalId}>
                <td>{terminal.terminalId}</td>
                <td>{terminal.transactions}</td>
                <td>{terminal.pointsSpent.toFixed(0)} â‚½</td>
                <td>{terminal.pointsEarned.toFixed(0)}</td>
                <td>{terminal.revenue.toFixed(0)} â‚½</td>
              </tr>
            ))}
          </tbody>
        </Table>
      </Card>
      
      {/* Transaction Types */}
      <Card>
        <h2>Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼</h2>
        <PieChart
          data={analytics.transactionTypes}
          valueKey="count"
          labelKey="type"
        />
      </Card>
      
      {/* Top Cashiers */}
      <Card>
        <h2>Ğ¢Ğ¾Ğ¿ ĞºĞ°ÑÑĞ¸Ñ€Ğ¾Ğ²</h2>
        <BarChart
          data={analytics.topCashiers}
          xAxis="name"
          bars={[
            { key: 'transactions', label: 'Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸', color: '#6366F1' }
          ]}
        />
      </Card>
    </div>
  );
};
```


***

## **âœ… 19. Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ Ğ§Ğ•ĞšĞ›Ğ˜Ğ¡Ğ¢**

### **19.1. Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ**

#### **ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:**

- âœ… ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾ÑÑ‚Ñ Ğ¿Ğ¾ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ñƒ
- âœ… ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾ÑÑ‚Ñ Ğ¿Ğ¾ 6-digit ĞºĞ¾Ğ´Ñƒ
- âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ³Ğ¾ÑÑ‚Ñ Ñ ĞºĞ°ÑÑÑ‹
- âœ… ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° POINTS (Ğ½Ğ°ĞºĞ¾Ğ¿Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°)
- âœ… ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° DISCOUNT (ÑĞºĞ¸Ğ´Ğ¾Ñ‡Ğ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°)
- âœ… Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²
- âœ… Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (EarnOnly)
- âœ… ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ½Ğ¾Ğ¹ ÑĞºĞ¸Ğ´ĞºĞ¸
- âœ… ĞÑ‚Ğ²ÑĞ·ĞºĞ° ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ¾Ñ‚ Ğ·Ğ°ĞºĞ°Ğ·Ğ°
- âœ… Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ñ + Ğ¤Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹


#### **UI/UX:**

- âœ… Floating Button (Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…)
- âœ… Touch-friendly Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ (Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 60x60px)
- âœ… Ğ¦Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° (80x80px ĞºĞ½Ğ¾Ğ¿ĞºĞ¸)
- âœ… Ğ‘ÑƒĞºĞ²ĞµĞ½Ğ½Ğ°Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° (Ğ Ğ£Ğ¡/EN)
- âœ… ĞšĞ½Ğ¾Ğ¿ĞºĞ° MAX Ğ´Ğ»Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑÑƒĞ¼Ğ¼Ñ‹
- âœ… Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ñ‹ (Ğ·ĞµĞ»ĞµĞ½Ğ°Ñ Ñ‚Ğ¾Ñ‡ĞºĞ°)
- âœ… Loading overlays
- âœ… ĞŸĞ¾Ğ½ÑÑ‚Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…
- âœ… ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ğ·Ğ²ÑƒĞºĞ¸


#### **Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ:**

- âœ… External DLL Ğ´Ğ»Ñ FarCard
- âœ… R-Keeper XML API ĞºĞ»Ğ¸ĞµĞ½Ñ‚
- âœ… ĞĞ²Ñ‚Ğ¾Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° FarCard Ğ¿Ñ€Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞµ
- âœ… ĞŸÑ€Ğ¸Ğ²ÑĞ·ĞºĞ° ĞºĞ°Ñ€Ñ‚ Ğº Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ğ¼
- âœ… ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ÑĞºĞ¸Ğ´Ğ¾Ğº Ğ² R-Keeper
- âœ… Shared Memory ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- âœ… ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ


### **19.2. Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ**

- âœ… Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ API Key (AES-256)
- âœ… Machine-binding (Ğ¿Ñ€Ğ¸Ğ²ÑĞ·ĞºĞ° Ğº Ğ¶ĞµĞ»ĞµĞ·Ñƒ)
- âœ… Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ API Key Ğ½Ğ° Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»
- âœ… Revoke Ñ‡ĞµÑ€ĞµĞ· backend
- âœ… HTTPS only
- âœ… ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚Ğ¸ ĞºĞ»ÑÑ‡Ğ°
- âœ… Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
- âœ… ĞœĞ°ÑĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ…


### **19.3. Offline Ñ€ĞµĞ¶Ğ¸Ğ¼**

- âœ… Health checks ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ
- âœ… Offline queue (Ğ¼Ğ°ĞºÑ. 100 Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹, TTL 24Ñ‡)
- âœ… ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸
- âœ… Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Ñ„Ğ°Ğ¹Ğ» + Shared Memory
- âœ… Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ğ± offline/online Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ°Ñ…
- âœ… Exponential backoff Ğ´Ğ»Ñ retry


### **19.4. ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³**

- âœ… Structured logging (Serilog)
- âœ… Ğ Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ² (7 Ğ´Ğ½ĞµĞ¹ Ğ´Ğ»Ñ info, 30 Ğ´Ğ½ĞµĞ¹ Ğ´Ğ»Ñ errors)
- âœ… Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ° Ğ»Ğ¾Ğ³-Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² (50 MB)
- âœ… ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ½Ğ° backend (Ğ±Ğ°Ñ‚Ñ‡ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 5 Ğ¼Ğ¸Ğ½)
- âœ… Performance monitoring
- âœ… Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑĞºÑ€Ğ°Ğ½
- âœ… Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ»Ğ¾Ğ³Ğ¾Ğ²


### **19.5. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ**

- âœ… ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹ (Ñ€Ğ°Ğ· Ğ² Ğ´ĞµĞ½ÑŒ)
- âœ… Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸ÑÑ…
- âœ… ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°
- âœ… Change log Ğ² ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¸
- âœ… ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ¾Ğ¼


### **19.6. ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°**

- âœ… ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸
- âœ… Tenant â†’ Restaurant â†’ Terminal Ğ¸ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ñ
- âœ… ĞÑ‚Ñ‡ĞµÑ‚Ñ‹ Ğ¿Ğ¾ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğ°Ğ¼
- âœ… ĞÑ‚Ñ‡ĞµÑ‚Ñ‹ Ğ¿Ğ¾ ĞºĞ°ÑÑĞ¸Ñ€Ğ°Ğ¼
- âœ… Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸ĞºĞ° Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼
- âœ… Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ R-Keeper vs iiko
- âœ… Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

***

## **ğŸ“¦ 20. Ğ˜Ğ¢ĞĞ“ĞĞ’ĞĞ¯ Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ¯**

### **20.1. Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ½Ğ° ĞºĞ°ÑÑĞµ**

```
C:\RK7\
â””â”€â”€ Plugins\
    â””â”€â”€ MaxLoyaltyRKeeper.dll          # External DLL (2 MB)

C:\MaxLoyalty\
â”œâ”€â”€ MaxLoyaltyRKeeperUI.exe            # UI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ (15 MB)
â”œâ”€â”€ Newtonsoft.Json.dll
â”œâ”€â”€ Serilog.dll
â”œâ”€â”€ Polly.dll
â””â”€â”€ Resources\
    â”œâ”€â”€ ML_Icon.png
    â”œâ”€â”€ ML_Logo.png
    â””â”€â”€ Sounds\
        â”œâ”€â”€ click.wav
        â””â”€â”€ success.wav

%AppData%\MaxLoyaltyRKeeper\
â”œâ”€â”€ config.json                         # Ğ—Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
â””â”€â”€ offline_queue.json                  # Offline Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ

C:\Logs\MaxLoyaltyRKeeper\
â”œâ”€â”€ ui-2026-02-18.log                   # UI Ğ»Ğ¾Ğ³Ğ¸ (Ñ€Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ñ 7 Ğ´Ğ½ĞµĞ¹)
â”œâ”€â”€ dll-2026-02-18.log                  # DLL Ğ»Ğ¾Ğ³Ğ¸ (Ñ€Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ñ 7 Ğ´Ğ½ĞµĞ¹)
â””â”€â”€ errors-2026-02-18.log               # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ (Ñ€Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ñ 30 Ğ´Ğ½ĞµĞ¹)
```


### **20.2. Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğº Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ**

| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ | Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ |
| :-- | :-- | :-- |
| **ĞĞ¡** | Windows 10 | Windows 11 |
| **RAM** | 2 GB | 4 GB |
| **CPU** | 2 cores | 4 cores |
| **Ğ”Ğ¸ÑĞº** | 100 MB | 500 MB |
| **Ğ˜Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚** | 1 Mbps | 10 Mbps |
| **R-Keeper** | 7.0+ | 7.5+ |
| **Ğ­ĞºÑ€Ğ°Ğ½** | 1024x768 | 1920x1080 Touch |

### **20.3. Ğ¡Ğ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ**

| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ | Ğ’ĞµÑ€ÑĞ¸Ñ | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ |
| :-- | :-- | :-- |
| R-Keeper 7.x | âœ… | ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° |
| R-Keeper 6.x | âš ï¸ | ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ğ°Ñ (Ğ±ĞµĞ· FarCard) |
| Windows 10 | âœ… | ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° |
| Windows 11 | âœ… | ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° |
| Windows Server | âœ… | ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° |
| FarCard | âœ… | Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾, Ğ²ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ² R-Keeper |


***

## **ğŸ‰ 21. Ğ—ĞĞšĞ›Ğ®Ğ§Ğ•ĞĞ˜Ğ•**

### **21.1. Ğ§Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ÑÑ Ğ² Ğ¸Ñ‚Ğ¾Ğ³Ğµ?**

**Ğ”Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°:**

1. Ğ—Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Max Loyalty
2. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ R-Keeper Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğ°
3. Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸Ğº (15 MB)
4. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ğ½Ğ° ĞºĞ°ÑÑĞµ
5. **Ğ§ĞµÑ€ĞµĞ· 1 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ Ğ²ÑÑ‘ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚!**

**Ğ”Ğ»Ñ ĞºĞ°ÑÑĞ¸Ñ€Ğ°:**

1. Ğ’Ğ¸Ğ´Ğ¸Ñ‚ Floating Button Ğ² ÑƒĞ³Ğ»Ñƒ ÑĞºÑ€Ğ°Ğ½Ğ°
2. Ğ¢Ğ°Ğ¿Ğ°ĞµÑ‚ â†’ Ğ’Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ³Ğ¾ÑÑ‚Ñ
3. Ğ’Ğ¸Ğ´Ğ¸Ñ‚ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹
4. ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ/ÑĞºĞ¸Ğ´ĞºÑƒ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹
5. ĞŸÑ€Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹ ÑĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸

**Ğ”Ğ»Ñ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ° ÑĞµÑ‚Ğ¸:**

1. Ğ’Ğ¸Ğ´Ğ¸Ñ‚ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºÑƒ Ğ¿Ğ¾ Ğ²ÑĞµĞ¼ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°Ğ¼
2. Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµÑ‚ R-Keeper Ğ¸ iiko Ñ„Ğ¸Ğ»Ğ¸Ğ°Ğ»Ñ‹
3. ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ĞµÑ‚ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹ Ğ»Ğ¾ÑĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
4. Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ğ¼Ğ¸ Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾

### **21.2. ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ñ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°**

âœ… **ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°**: Ğ¡ĞºĞ°Ñ‡Ğ°Ğ» â†’ Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ğ» â†’ Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
âœ… **ĞĞ²Ñ‚Ğ¾Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°**: FarCard Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸
âœ… **Touch-friendly**: ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ´Ğ»Ñ ÑĞµĞ½ÑĞ¾Ñ€Ğ½Ñ‹Ñ… ÑĞºÑ€Ğ°Ğ½Ğ¾Ğ²
âœ… **Offline Ñ€ĞµĞ¶Ğ¸Ğ¼**: Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ´Ğ°Ğ¶Ğµ Ğ±ĞµĞ· Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚Ğ°
âœ… **Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ**: Machine-binding + ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
âœ… **ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³**: ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° Ğ¸ Ğ»Ğ¾Ğ³Ğ¸
âœ… **ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°**: Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ñ‹ Ğ¿Ğ¾ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğ°Ğ¼
âœ… **ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ**: ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸ÑĞ¼Ğ¸
âœ… **Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾**: FarCard Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ² R-Keeper
âœ… **Ğ•Ğ´Ğ¸Ğ½Ğ°Ñ ÑĞºĞ¾ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°**: Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ ĞºĞ°Ğº Ğ² iiko, Ğ½Ğ¾ Ğ´Ğ»Ñ R-Keeper

### **21.3. ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ ÑƒÑĞ¿ĞµÑ…Ğ°**

**Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ:**

- â±ï¸ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°: **< 2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹**
- ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº UI: **< 5 ÑĞµĞºÑƒĞ½Ğ´**
- ğŸ“¡ Latency API: **< 200ms**
- ğŸ“´ Offline Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°: **Ğ”Ğ¾ 24 Ñ‡Ğ°ÑĞ¾Ğ²**
- ğŸ’¾ Ğ Ğ°Ğ·Ğ¼ĞµÑ€: **< 20 MB**

**Ğ‘Ğ¸Ğ·Ğ½ĞµÑ:**

- ğŸ‘¥ Ğ’Ñ€ĞµĞ¼Ñ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ ĞºĞ°ÑÑĞ¸Ñ€Ğ°: **< 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚**
- âš¡ Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ»Ğ¾ÑĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸: **< 10 ÑĞµĞºÑƒĞ½Ğ´**
- ğŸ“ˆ ĞÑ…Ğ²Ğ°Ñ‚ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹: **100%** (Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ)
- ğŸ¯ Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğ¹: **100%** (Ğ½ĞµÑ‚ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ²Ğ¾Ğ´Ğ°)


### **21.4. Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ADMIN ĞŸĞĞĞ•Ğ›Ğ¬                        â”‚
â”‚  â€¢ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¹                              â”‚
â”‚  â€¢ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸ĞºĞ¾Ğ²                           â”‚
â”‚  â€¢ ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğ°Ğ¼                          â”‚
â”‚  â€¢ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸ÑĞ¼Ğ¸                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ HTTPS
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BACKEND API (NestJS)                    â”‚
â”‚  â€¢ ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾ÑÑ‚ĞµĞ¹                                     â”‚
â”‚  â€¢ Calculate Ğ±ĞµĞ½ĞµÑ„Ğ¸Ñ‚Ğ¾Ğ²                              â”‚
â”‚  â€¢ Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ñ / Ğ¤Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ                         â”‚
â”‚  â€¢ ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                   â”‚
           â”‚ HTTPS             â”‚ HTTPS
           â”‚                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ MaxLoyalty    â”‚   â”‚ MaxLoyalty     â”‚
    â”‚ RKeeper.dll   â”‚   â”‚ RKeeperUI.exe  â”‚
    â”‚ (External)    â”‚â—„â”€â”€â”‚ (WPF)          â”‚
    â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚
           â”‚  Shared          â”‚  XML API
           â”‚  Memory          â”‚
           â”‚                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚      R-KEEPER CASH STATION      â”‚
    â”‚  â€¢ FarCard (Ğ‘Ğ•Ğ¡ĞŸĞ›ĞĞ¢ĞĞ)          â”‚
    â”‚  â€¢ ĞšĞ°ÑÑĞ¾Ğ²Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€              â”‚
    â”‚  â€¢ XML API                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


***

## **ğŸ“š Ğ”ĞĞšĞ£ĞœĞ•ĞĞ¢ĞĞ¦Ğ˜Ğ¯ Ğ˜ ĞŸĞĞ”Ğ”Ğ•Ğ Ğ–ĞšĞ**

### **Ğ”Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ²:**

- ğŸ“– ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ: âœ… Ğ­Ñ‚Ğ¾Ñ‚ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚
- ğŸ’» API Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ: Swagger Ğ½Ğ° `/api/docs`
- ğŸ”§ SDK: Plugin SDK Ğ´Ğ»Ñ R-Keeper
- ğŸ“ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ ĞºĞ¾Ğ´Ğ°: GitHub repository


### **Ğ”Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²:**

- ğŸ“ Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞµ: PDF Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ
- ğŸ”§ Troubleshooting: Ğ‘Ğ°Ğ·Ğ° Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹
- ğŸ“ Ğ¢ĞµÑ…Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°: support@maxloyalty.ru
- ğŸ’¬ Ğ§Ğ°Ñ‚: Telegram/WhatsApp support


### **Ğ”Ğ»Ñ ĞºĞ°ÑÑĞ¸Ñ€Ğ¾Ğ²:**

- ğŸ“± ĞšÑ€Ğ°Ñ‚ĞºĞ°Ñ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ: 1 ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° A4
- ğŸ¥ Ğ’Ğ¸Ğ´ĞµĞ¾-Ğ³Ğ°Ğ¹Ğ´: 3 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹
- â“ FAQ: Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹

***

# **ğŸ¯ Ğ¡ĞŸĞ•Ğ¦Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ¯ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ!**

ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ° Max Loyalty Ğ´Ğ»Ñ R-Keeper Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ° Ğº Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ:

âœ… **42 ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹** Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸
âœ… **20 Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¾Ğ²** Ñ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¼ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸ĞµĞ¼
âœ… **ĞšĞ¾Ğ´ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹** Ğ½Ğ° C++, C\#, TypeScript
âœ… **ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğµ ÑÑ…ĞµĞ¼Ñ‹** Ğ¸ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹
âœ… **UI/UX ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸** Ñ XAML
âœ… **API endpoints** Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ
âœ… **Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ** Ğ¸ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
âœ… **Offline Ñ€ĞµĞ¶Ğ¸Ğ¼** Ñ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒÑ
âœ… **ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³** Ğ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
âœ… **ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ** Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°

**Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ Ğº Ğ¸Ğ¼Ğ¿Ğ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸! ğŸš€**

---

# Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¾ÑÑŒ. Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸ ĞŸĞĞ›ĞĞĞ¯ Ğ¡ĞŸĞ•Ğ¦Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ¯ ĞŸĞ›ĞĞ“Ğ˜ĞĞ MAX LOYALTY Ğ´Ğ»Ñ r-kepper Ñ‚Ğ°ĞºĞ¶Ğµ ĞºĞ°Ğº Ğ±Ñ‹Ğ»Ğ¾ Ğ´Ğ»Ñ iiko. ĞšĞ¾Ñ€Ğ¾Ñ‡Ğµ, Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğ¸ ĞºĞ°Ğº Ğ²Ñ‹Ğ³Ğ»ÑĞ´Ğ¸Ñ‚, Ğ¿Ğ¾ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñƒ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°

ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ğ¼ ĞŸĞĞ›ĞĞ£Ğ® Ğ¡ĞŸĞ•Ğ¦Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ® Ğ´Ğ»Ñ R-Keeper Ğ² Ñ‚Ğ¾Ğ¼ Ğ¶Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾ Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ iiko.

Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ğ¼ Ğ¸ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ - Ğ³Ğ¾Ñ‚Ğ¾Ğ²?

# ğŸ“˜ **ĞŸĞĞ›ĞĞĞ¯ Ğ¡ĞŸĞ•Ğ¦Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ¯ ĞŸĞ›ĞĞ“Ğ˜ĞĞ MAX LOYALTY Ğ”Ğ›Ğ¯ R-KEEPER**


***

## **ğŸ¯ 1. ĞĞ‘Ğ©Ğ•Ğ• ĞĞŸĞ˜Ğ¡ĞĞĞ˜Ğ•**

### **ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:**

ĞŸĞ»Ğ°Ğ³Ğ¸Ğ½ Ğ´Ğ»Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ»Ğ¾ÑĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Max Loyalty Ğ² R-Keeper. ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ°Ğ¼ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ° (ĞºĞ°ÑÑĞ¸Ñ€Ğ°Ğ¼, Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ½Ñ‚Ğ°Ğ¼, Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°Ğ¼) Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ³Ğ¾ÑÑ‚ĞµĞ¹ Ğº Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ğ¼, Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ±Ğ¾Ğ½ÑƒÑÑ‹/ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ¸ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ÑÑ‚ÑŒ Ğ±Ğ°Ğ»Ğ»Ñ‹.

### **Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑÑ‚ĞµĞº:**

**Backend Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ (DLL):**

- **Ğ¯Ğ·Ñ‹Ğº:** C++ (Native DLL)
- **API:** FarCard External DLL Interface
- **ĞŸÑ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»:** Ğ”Ğ²ÑƒĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ (R-Keeper â†” DLL)

**Frontend (UI):**

- **Ğ¯Ğ·Ñ‹Ğº:** C\# (.NET 6.0+)
- **UI:** WPF (Windows Presentation Foundation)
- **API:** R-Keeper XML API + Max Loyalty REST API
- **Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:** Serilog
- **HTTP:** HttpClient Ñ Polly (retry policies)

**Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ:**

- **Shared Memory:** Memory-Mapped Files
- **Mutex:** Named Mutex Ğ´Ğ»Ñ thread-safety


### **ĞŸĞ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°:**

- Windows 10/11
- R-Keeper 7.x+ (FarCard Ğ²ĞºĞ»ÑÑ‡ĞµĞ½ Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾)


### **ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ¸Ñ Ğ¾Ñ‚ iiko:**

| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | iiko | R-Keeper |
| :-- | :-- | :-- |
| **Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ** | Plugin SDK | FarCard External DLL + XML API |
| **UI** | Ğ’ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ² iiko | ĞÑ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğµ WPF Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ |
| **Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°** | ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ² "Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸ÑÑ…" | Floating Button Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… R-Keeper |
| **Payment** | IPaymentType | FarCard callback + XML API ÑĞºĞ¸Ğ´ĞºĞ¸ |
| **ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°** | ĞœĞ¾Ğ½Ğ¾Ğ»Ğ¸Ñ‚Ğ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½ | DLL + UI + Shared Memory |


***

## **ğŸ—ï¸ 2. ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ¯**

### **2.1. ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   R-KEEPER CASH STATION                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         R-Keeper 7.x (ĞšĞ°ÑÑĞ¾Ğ²Ñ‹Ğ¹ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ)            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚        FarCard (Ğ”Ğ¸ÑĞºĞ¾Ğ½Ñ‚/Ğ‘Ğ¾Ğ½ÑƒÑÑ‹)              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  âœ… Ğ’ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾ Ğ² R-Keeper             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                  â”‚                                       â”‚
â”‚                  â–¼ (1) Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ external.dll           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    MaxLoyaltyRKeeper.dll (C++ Native)            â”‚  â”‚
â”‚  â”‚  â€¢ Initialize()                                   â”‚  â”‚
â”‚  â”‚  â€¢ GetCardInfo(phone/code6)                      â”‚  â”‚
â”‚  â”‚  â€¢ ReservePoints(amount)                         â”‚  â”‚
â”‚  â”‚  â€¢ FinalizeTransaction(orderId)                  â”‚  â”‚
â”‚  â”‚  â€¢ HTTP Client â†’ Backend API                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                â”‚                                         â”‚
â”‚                â–¼ (2) Shared Memory                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Memory-Mapped File (1MB)                         â”‚  â”‚
â”‚  â”‚  â€¢ ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ñ‹ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²                             â”‚  â”‚
â”‚  â”‚  â€¢ Backend status                                 â”‚  â”‚
â”‚  â”‚  â€¢ Offline queue                                  â”‚  â”‚
â”‚  â”‚  â€¢ ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                â”‚                                         â”‚
â”‚                â”‚ (3) Ğ§Ğ¸Ñ‚Ğ°ĞµÑ‚/Ğ¿Ğ¸ÑˆĞµÑ‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    MaxLoyaltyRKeeperUI.exe (C# WPF)              â”‚  â”‚
â”‚  â”‚  â€¢ Floating Button (Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…)               â”‚  â”‚
â”‚  â”‚  â€¢ ĞĞºĞ½Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ³Ğ¾ÑÑ‚Ñ                             â”‚  â”‚
â”‚  â”‚  â€¢ ĞĞºĞ½Ğ¾ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹                                  â”‚  â”‚
â”‚  â”‚  â€¢ Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°                                    â”‚  â”‚
â”‚  â”‚  â€¢ XML API ĞºĞ»Ğ¸ĞµĞ½Ñ‚ â†’ R-Keeper                     â”‚  â”‚
â”‚  â”‚  â€¢ HTTP Client â†’ Backend API                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼ HTTPS
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Backend API         â”‚
              â”‚   (Max Loyalty)       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### **2.2. Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°:**

```
MaxLoyaltyRKeeper/
â”œâ”€â”€ MaxLoyaltyRKeeper.dll (C++ Native DLL)
â”‚   â”œâ”€â”€ dllmain.cpp
â”‚   â”œâ”€â”€ exports.cpp                 # Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
â”‚   â”œâ”€â”€ http_client.cpp             # HTTP ĞºĞ»Ğ¸ĞµĞ½Ñ‚ (WinHTTP)
â”‚   â”œâ”€â”€ shared_memory.cpp           # Shared Memory ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
â”‚   â”œâ”€â”€ logger.cpp                  # Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
â”‚   â”œâ”€â”€ encryption.cpp              # Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ API Key
â”‚   â””â”€â”€ json_parser.cpp             # JSON Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³ (nlohmann/json)
â”‚
â”œâ”€â”€ MaxLoyaltyRKeeperUI (C# WPF)
â”‚   â”œâ”€â”€ App.xaml.cs                 # Entry point
â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â”œâ”€â”€ LoyaltyApiClient.cs    # HTTP ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Backend API
â”‚   â”‚   â”œâ”€â”€ RKeeperXmlClient.cs    # XML API ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ´Ğ»Ñ R-Keeper
â”‚   â”‚   â”œâ”€â”€ SharedMemoryService.cs # Shared Memory Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ
â”‚   â”‚   â”œâ”€â”€ ConfigService.cs       # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
â”‚   â”‚   â”œâ”€â”€ OfflineQueueService.cs # Offline Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ
â”‚   â”‚   â”œâ”€â”€ MetricsService.cs      # ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸
â”‚   â”‚   â””â”€â”€ HealthCheckService.cs  # Health checks
â”‚   â”œâ”€â”€ Views/
â”‚   â”‚   â”œâ”€â”€ FloatingButtonWindow.xaml     # Floating ĞºĞ½Ğ¾Ğ¿ĞºĞ°
â”‚   â”‚   â”œâ”€â”€ GuestSearchWindow.xaml        # ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾ÑÑ‚Ñ
â”‚   â”‚   â”œâ”€â”€ PointsOperationWindow.xaml    # ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ±Ğ°Ğ»Ğ»Ğ°Ğ¼Ğ¸
â”‚   â”‚   â”œâ”€â”€ DiscountOperationWindow.xaml  # ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ÑĞ¾ ÑĞºĞ¸Ğ´ĞºĞ¾Ğ¹
â”‚   â”‚   â”œâ”€â”€ CreateGuestWindow.xaml        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾ÑÑ‚Ñ
â”‚   â”‚   â””â”€â”€ DiagnosticsWindow.xaml        # Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°
â”‚   â”œâ”€â”€ ViewModels/
â”‚   â”‚   â”œâ”€â”€ FloatingButtonViewModel.cs
â”‚   â”‚   â”œâ”€â”€ GuestSearchViewModel.cs
â”‚   â”‚   â”œâ”€â”€ PointsOperationViewModel.cs
â”‚   â”‚   â””â”€â”€ DiagnosticsViewModel.cs
â”‚   â”œâ”€â”€ UserControls/
â”‚   â”‚   â”œâ”€â”€ NumericKeyboard.xaml          # Ğ¦Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ°
â”‚   â”‚   â”œâ”€â”€ AlphabeticKeyboard.xaml       # Ğ‘ÑƒĞºĞ²ĞµĞ½Ğ½Ğ°Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ°
â”‚   â”‚   â””â”€â”€ LoadingOverlay.xaml           # Loading Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€
â”‚   â”œâ”€â”€ Models/
â”‚   â”‚   â”œâ”€â”€ GuestInfo.cs
â”‚   â”‚   â”œâ”€â”€ CalculateResponse.cs
â”‚   â”‚   â”œâ”€â”€ OrderContext.cs
â”‚   â”‚   â”œâ”€â”€ RKeeperOrder.cs
â”‚   â”‚   â””â”€â”€ SharedMemoryData.cs
â”‚   â””â”€â”€ Styles/
â”‚       â””â”€â”€ MaxLoyaltyStyles.xaml
â”‚
â””â”€â”€ Installer/
    â”œâ”€â”€ MaxLoyaltyInstaller_Restaurant123.exe
    â”œâ”€â”€ install_script.nsi          # NSIS ÑĞºÑ€Ğ¸Ğ¿Ñ‚
    â””â”€â”€ config_template.json        # Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
```


***

## **âš™ï¸ 3. Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ĞšĞĞœĞŸĞĞĞ•ĞĞ¢ĞĞ’**

### **3.1. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°**

**ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸Ğº Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°:**

```
MaxLoyaltyInstaller_Restaurant123.exe
â”œâ”€â”€ Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚:
â”‚   â”œâ”€â”€ MaxLoyaltyRKeeper.dll (C++ External DLL)
â”‚   â”œâ”€â”€ MaxLoyaltyRKeeperUI.exe (WPF Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ)
â”‚   â”œâ”€â”€ Ğ—Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ API Key
â”‚   â”œâ”€â”€ URL Backend API
â”‚   â”œâ”€â”€ Restaurant ID
â”‚   â”œâ”€â”€ Terminal ID
â”‚   â””â”€â”€ Installation ID (UUID)
```

**ĞŸÑ€Ğ¾Ñ†ĞµÑÑ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ (NSIS installer):**

1. **ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ R-Keeper:**

```
Ğ˜Ñ‰ĞµÑ‚ Ğ² Ñ€ĞµĞµÑÑ‚Ñ€Ğµ:
HKLM\SOFTWARE\UCS\RKeeper7\InstallDir

Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ â†’ Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ Ğ¿ÑƒÑ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ
```

2. **ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ DLL:**

```
%RK7_INSTALL%\Plugins\MaxLoyaltyRKeeper.dll
```

3. **ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° FarCard:**

```xml
<!-- ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ² %RK7_DATA%\FarCard.xml -->
<ExternalDLL>
  <Path>%RK7_INSTALL%\Plugins\MaxLoyaltyRKeeper.dll</Path>
  <Enable>true</Enable>
  <Type>MaxLoyalty</Type>
</ExternalDLL>
```

4. **ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ UI:**

```
C:\MaxLoyalty\MaxLoyaltyRKeeperUI.exe
C:\MaxLoyalty\Resources\
```

5. **Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸:**

```json
// %AppData%\MaxLoyaltyRKeeper\config.json (Ğ·Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾)
{
  "api_key_encrypted": "...",
  "backend_api_url": "https://api.maxloyalty.ru",
  "installation_id": "inst_abc123",
  "tenant_id": "tenant_mario",
  "restaurant_id": "rest_centro",
  "terminal_id": "term_001",
  "terminal_name": "ĞšĞ°ÑÑĞ° 1 (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ»)",
  "rkeeper_xml_api_url": "http://localhost:8080/rk7api/v0/xmlinterface.xml",
  "machine_id_hash": "..."
}
```

6. **ĞĞ²Ñ‚Ğ¾Ğ·Ğ°Ğ¿ÑƒÑĞº UI:**

```
Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ ÑÑ€Ğ»Ñ‹Ğº Ğ²:
%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\MaxLoyaltyRKeeperUI.lnk
```

7. **ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº R-Keeper:**

```
ĞŸÑ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ R-Keeper Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ DLL
```


### **3.2. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ DLL (C++)**

```cpp
// MaxLoyaltyRKeeper.dll: dllmain.cpp

#include <Windows.h>
#include <string>
#include <memory>
#include <nlohmann/json.hpp>
#include "http_client.h"
#include "shared_memory.h"
#include "logger.h"
#include "encryption.h"

using json = nlohmann::json;

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ñ‹
std::unique_ptr<HttpClient> g_httpClient;
std::unique_ptr<SharedMemoryManager> g_sharedMemory;
std::unique_ptr<Logger> g_logger;
std::string g_apiKey;
std::string g_backendUrl;
std::string g_installationId;
std::string g_tenantId;
std::string g_restaurantId;
std::string g_terminalId;

BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
        // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ
        break;
    case DLL_PROCESS_DETACH:
        // ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ³Ñ€ÑƒĞ·ĞºĞµ
        break;
    }
    return TRUE;
}

// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ: Initialize
extern "C" __declspec(dllexport) int __stdcall Initialize(const char* configPath)
{
    try
    {
        // 1. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        std::string logPath = "C:\\Logs\\MaxLoyaltyRKeeper\\dll-" + GetCurrentDate() + ".log";
        g_logger = std::make_unique<Logger>(logPath);
        
        g_logger->Info("MaxLoyaltyRKeeper.dll Initialize() called");
        g_logger->Info("Config path: %s", configPath);
        
        // 2. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
        std::ifstream configFile(configPath);
        if (!configFile.is_open())
        {
            g_logger->Error("Failed to open config file: %s", configPath);
            return -1; // ERROR_CONFIG_NOT_FOUND
        }
        
        json config;
        configFile >> config;
        configFile.close();
        
        // 3. Ğ Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²ĞºĞ° API Key
        std::string machineId = GetMachineId();
        g_apiKey = DecryptApiKey(config["api_key_encrypted"].get<std::string>(), machineId);
        
        if (g_apiKey.empty())
        {
            g_logger->Error("Failed to decrypt API Key");
            return -2; // ERROR_DECRYPTION_FAILED
        }
        
        // 4. Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²
        g_backendUrl = config["backend_api_url"].get<std::string>();
        g_installationId = config["installation_id"].get<std::string>();
        g_tenantId = config["tenant_id"].get<std::string>();
        g_restaurantId = config["restaurant_id"].get<std::string>();
        g_terminalId = config["terminal_id"].get<std::string>();
        
        g_logger->Info("Backend URL: %s", g_backendUrl.c_str());
        g_logger->Info("Installation ID: %s", g_installationId.c_str());
        g_logger->Info("Terminal ID: %s", g_terminalId.c_str());
        
        // 5. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ HTTP ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
        g_httpClient = std::make_unique<HttpClient>(g_backendUrl);
        g_httpClient->SetHeader("X-API-Key", g_apiKey);
        g_httpClient->SetHeader("X-Installation-Id", g_installationId);
        g_httpClient->SetHeader("X-Tenant-Id", g_tenantId);
        g_httpClient->SetHeader("X-Restaurant-Id", g_restaurantId);
        g_httpClient->SetHeader("X-Terminal-Id", g_terminalId);
        g_httpClient->SetTimeout(30000); // 30 ÑĞµĞºÑƒĞ½Ğ´
        
        // 6. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Shared Memory
        g_sharedMemory = std::make_unique<SharedMemoryManager>(
            "MaxLoyaltyRKeeperShared",
            1024 * 1024 // 1 MB
        );
        
        if (!g_sharedMemory->Open())
        {
            g_logger->Warning("Failed to open shared memory, creating new");
            g_sharedMemory->Create();
        }
        
        // 7. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº backend
        try
        {
            auto response = g_httpClient->Get("/api/health");
            if (response.statusCode == 200)
            {
                g_logger->Info("Backend connection: OK");
                g_sharedMemory->UpdateBackendStatus(true);
            }
            else
            {
                g_logger->Warning("Backend connection: Failed (status %d)", response.statusCode);
                g_sharedMemory->UpdateBackendStatus(false);
            }
        }
        catch (const std::exception& ex)
        {
            g_logger->Warning("Backend connection test failed: %s", ex.what());
            g_sharedMemory->UpdateBackendStatus(false);
        }
        
        // 8. ĞŸĞµÑ€Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ (Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸)
        SendFirstConnect();
        
        // 9. Ğ£ÑĞ¿ĞµÑˆĞ½Ğ°Ñ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
        g_logger->Info("MaxLoyaltyRKeeper.dll initialized successfully");
        return 0; // SUCCESS
    }
    catch (const std::exception& ex)
    {
        if (g_logger)
            g_logger->Error("Initialize() exception: %s", ex.what());
        return -1; // ERROR_UNKNOWN
    }
}

// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ: GetCardInfo
extern "C" __declspec(dllexport) int __stdcall GetCardInfo(
    const char* cardNumber, 
    CardInfo* outInfo
)
{
    if (!cardNumber || !outInfo)
    {
        g_logger->Error("GetCardInfo: Invalid parameters");
        return -1;
    }
    
    g_logger->Info("GetCardInfo called: %s", MaskCardNumber(cardNumber));
    
    try
    {
        // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ¿Ğ¾Ğ¸ÑĞºĞ° (Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¸Ğ»Ğ¸ 6-digit ĞºĞ¾Ğ´)
        std::string searchValue(cardNumber);
        bool isPhone = (searchValue.length() >= 10 && searchValue[^19_0] == '+');
        
        // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ JSON Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
        json requestBody;
        if (isPhone)
            requestBody["phone"] = searchValue;
        else
            requestBody["code6Digit"] = searchValue;
        
        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ° backend
        auto response = g_httpClient->Post(
            "/api/pos-integration/rkeeper/search-guest",
            requestBody.dump()
        );
        
        if (response.statusCode != 200)
        {
            g_logger->Error("GetCardInfo: Backend returned %d", response.statusCode);
            return -2; // ERROR_API
        }
        
        // ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚
        auto responseData = json::parse(response.body);
        
        if (!responseData["found"].get<bool>())
        {
            g_logger->Info("GetCardInfo: Guest not found");
            return -1; // NOT_FOUND
        }
        
        auto guest = responseData["guest"];
        
        // Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ CardInfo
        ZeroMemory(outInfo, sizeof(CardInfo));
        
        strncpy_s(outInfo->guestName, guest["name"].get<std::string>().c_str(), 255);
        strncpy_s(outInfo->phone, guest["phone"].get<std::string>().c_str(), 31);
        strncpy_s(outInfo->cardId, guest["cardId"].get<std::string>().c_str(), 63);
        strncpy_s(outInfo->levelName, guest["levelName"].get<std::string>().c_str(), 127);
        
        outInfo->levelId = guest["levelId"].get<int>();
        outInfo->regularBalance = guest["regularBalance"].get<double>();
        outInfo->promoBalance = guest["promoBalance"].get<double>();
        outInfo->totalBalance = guest["totalBalance"].get<double>();
        
        if (guest.contains("code6Digit"))
        {
            strncpy_s(outInfo->code6Digit, guest["code6Digit"].get<std::string>().c_str(), 7);
        }
        
        g_logger->Info("GetCardInfo: Success - %s", guest["name"].get<std::string>().c_str());
        
        return 0; // SUCCESS
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("GetCardInfo exception: %s", ex.what());
        return -2; // ERROR_API
    }
}

// Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° CardInfo
struct CardInfo
{
    char guestName[^19_256];
    char phone[^19_32];
    char cardId[^19_64];
    char levelName[^19_128];
    char code6Digit[^19_7];
    int levelId;
    double regularBalance;
    double promoBalance;
    double totalBalance;
};

// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ: ReservePoints
extern "C" __declspec(dllexport) int __stdcall ReservePoints(
    const char* cardId,
    double pointsToSpend,
    const char* orderId,
    char* outReservationId
)
{
    if (!cardId || !orderId || !outReservationId || pointsToSpend <= 0)
    {
        g_logger->Error("ReservePoints: Invalid parameters");
        return -2;
    }
    
    g_logger->Info("ReservePoints: CardId=%s, Points=%.2f, OrderId=%s", 
        cardId, pointsToSpend, orderId);
    
    try
    {
        // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
        json requestBody = {
            {"guestCardId", cardId},
            {"pointsToSpend", pointsToSpend},
            {"orderId", orderId},
            {"restaurantId", g_restaurantId},
            {"terminalId", g_terminalId}
        };
        
        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ° backend
        auto response = g_httpClient->Post(
            "/api/pos-integration/rkeeper/reserve-points",
            requestBody.dump()
        );
        
        if (response.statusCode != 200)
        {
            g_logger->Error("ReservePoints: Backend returned %d", response.statusCode);
            return -2;
        }
        
        auto responseData = json::parse(response.body);
        
        if (!responseData["success"].get<bool>())
        {
            std::string error = responseData.value("error", "Unknown error");
            g_logger->Error("ReservePoints: %s", error.c_str());
            return -1; // INSUFFICIENT_BALANCE
        }
        
        // Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ reservation ID
        std::string reservationId = responseData["reservationId"].get<std::string>();
        strncpy_s(outReservationId, 64, reservationId.c_str(), _TRUNCATE);
        
        g_logger->Info("ReservePoints: Success, ReservationId=%s", reservationId.c_str());
        
        return 0; // SUCCESS
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("ReservePoints exception: %s", ex.what());
        return -2;
    }
}

// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ: FinalizeTransaction
extern "C" __declspec(dllexport) int __stdcall FinalizeTransaction(
    const char* reservationId,
    double finalAmount,
    const char* orderId,
    const char* paymentTypesJson
)
{
    g_logger->Info("FinalizeTransaction: OrderId=%s, Amount=%.2f", orderId, finalAmount);
    
    try
    {
        // 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· shared memory
        auto context = g_sharedMemory->GetOrderContext(orderId);
        
        if (!context.has_value())
        {
            g_logger->Warning("No loyalty context for order %s", orderId);
            return 0; // ĞĞµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ½ĞµÑ‚ Ğ»Ğ¾ÑĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
        }
        
        // 2. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº backend
        json requestBody = {
            {"guestCardId", context->cardId},
            {"orderId", orderId},
            {"reservationId", context->reservationId},
            {"checkAmount", context->originalAmount},
            {"finalCheckAmount", finalAmount},
            {"restaurantId", g_restaurantId},
            {"terminalId", g_terminalId},
            {"paymentTypes", json::parse(paymentTypesJson)}
        };
        
        std::string endpoint;
        
        if (context->benefitType == BenefitType::Points)
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-points";
            requestBody["pointsSpent"] = context->pointsToSpend;
            requestBody["pointsToEarn"] = context->pointsToEarn;
            requestBody["action"] = context->action;
        }
        else if (context->benefitType == BenefitType::Discount)
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-discount";
            requestBody["discountAmount"] = context->discountAmount;
            requestBody["discountPercentage"] = context->discountPercentage;
        }
        
        // 3. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ retry
        auto response = RetryPolicy::Execute([&]() {
            return g_httpClient->Post(endpoint, requestBody.dump());
        }, 3); // 3 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸
        
        if (response.statusCode == 200)
        {
            auto responseData = json::parse(response.body);
            
            if (responseData["success"].get<bool>())
            {
                std::string txnId = responseData["transactionId"].get<std::string>();
                g_logger->Info("Finalized successfully: TxnId=%s", txnId.c_str());
                
                // 4. ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚
                g_sharedMemory->ClearOrderContext(orderId);
                
                // 5. Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ UI
                g_sharedMemory->NotifyUI("order_finalized", orderId);
                
                return 0; // SUCCESS
            }
        }
        
        // Backend Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½
        g_logger->Warning("Backend unavailable, queueing offline...");
        
        // 6. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² offline queue
        g_sharedMemory->EnqueueOfflineOperation({
            "FINALIZE_" + std::string(context->benefitType == BenefitType::Points ? "POINTS" : "DISCOUNT"),
            orderId,
            requestBody.dump(),
            GetCurrentTimestamp(),
            0 // attempts
        });
        
        return -2; // QUEUED_OFFLINE
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("FinalizeTransaction exception: %s", ex.what());
        return -1;
    }
}
```


### **3.3. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ UI (C\# WPF)**

```csharp
// MaxLoyaltyRKeeperUI: App.xaml.cs

public partial class App : Application
{
    private IServiceProvider serviceProvider;
    private FloatingButtonWindow floatingButton;
    
    protected override async void OnStartup(StartupEventArgs e)
    {
        base.OnStartup(e);
        
        // 1. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        ConfigureLogging();
        
        Log.Information("===== Max Loyalty RKeeper UI Started =====");
        
        try
        {
            // 2. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° DI
            var services = new ServiceCollection();
            ConfigureServices(services);
            serviceProvider = services.BuildServiceProvider();
            
            // 3. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
            var configService = serviceProvider.GetRequiredService<IConfigService>();
            var config = configService.LoadConfig();
            
            Log.Information("Configuration loaded: Restaurant={Restaurant}, Terminal={Terminal}",
                config.RestaurantName, config.TerminalName);
            
            // 4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° machine binding
            var securityService = serviceProvider.GetRequiredService<SecurityService>();
            if (!await securityService.ValidateMachineBindingAsync())
            {
                Shutdown();
                return;
            }
            
            // 5. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Shared Memory
            var sharedMemory = serviceProvider.GetRequiredService<ISharedMemoryService>();
            await sharedMemory.InitializeAsync();
            
            // 6. Health checks
            var healthCheck = serviceProvider.GetRequiredService<IHealthCheckService>();
            healthCheck.StartMonitoring();
            
            // 7. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° offline Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
            var offlineQueue = serviceProvider.GetRequiredService<IOfflineQueueService>();
            _ = offlineQueue.ProcessQueueAsync();
            
            // 8. ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹
            var updateService = serviceProvider.GetRequiredService<IUpdateService>();
            updateService.StartPeriodicCheck();
            
            // 9. Ğ—Ğ°Ğ¿ÑƒÑĞº Floating Button
            floatingButton = serviceProvider.GetRequiredService<FloatingButtonWindow>();
            floatingButton.Show();
            
            Log.Information("UI initialized successfully");
        }
        catch (Exception ex)
        {
            Log.Fatal(ex, "Failed to initialize UI");
            
            MessageBox.Show(
                $"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Max Loyalty:\n{ex.Message}",
                "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸",
                MessageBoxButton.OK,
                MessageBoxImage.Error
            );
            
            Shutdown();
        }
    }
    
    private void ConfigureServices(IServiceCollection services)
    {
        // Configuration
        services.AddSingleton<IConfigService, ConfigService>();
        
        // Security
        services.AddSingleton<SecurityService>();
        
        // API Clients
        services.AddHttpClient<ILoyaltyApiClient, LoyaltyApiClient>()
            .ConfigurePrimaryHttpMessageHandler(() => new HttpClientHandler
            {
                ServerCertificateCustomValidationCallback = 
                    HttpClientHandler.DangerousAcceptAnyServerCertificateValidator
            })
            .AddPolicyHandler(GetRetryPolicy());
        
        services.AddHttpClient<IRKeeperXmlClient, RKeeperXmlClient>();
        
        // Services
        services.AddSingleton<ISharedMemoryService, SharedMemoryService>();
        services.AddSingleton<IOfflineQueueService, OfflineQueueService>();
        services.AddSingleton<IHealthCheckService, HealthCheckService>();
        services.AddSingleton<IMetricsService, MetricsService>();
        services.AddSingleton<IUpdateService, UpdateService>();
        services.AddSingleton<PerformanceMonitor>();
        
        // ViewModels
        services.AddTransient<FloatingButtonViewModel>();
        services.AddTransient<GuestSearchViewModel>();
        services.AddTransient<PointsOperationViewModel>();
        services.AddTransient<DiscountOperationViewModel>();
        services.AddTransient<DiagnosticsViewModel>();
        
        // Windows
        services.AddSingleton<FloatingButtonWindow>();
        services.AddTransient<GuestSearchWindow>();
        services.AddTransient<PointsOperationWindow>();
        services.AddTransient<DiscountOperationWindow>();
        services.AddTransient<DiagnosticsWindow>();
    }
    
    private IAsyncPolicy<HttpResponseMessage> GetRetryPolicy()
    {
        return HttpPolicyExtensions
            .HandleTransientHttpError()
            .WaitAndRetryAsync(
                3,
                retryAttempt => TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)),
                onRetry: (outcome, timespan, retryCount, context) =>
                {
                    Log.Warning("Retry {RetryCount} after {Delay}s", retryCount, timespan.TotalSeconds);
                }
            );
    }
    
    private void ConfigureLogging()
    {
        Log.Logger = new LoggerConfiguration()
            .MinimumLevel.Information()
            .MinimumLevel.Override("Microsoft", LogEventLevel.Warning)
            .MinimumLevel.Override("System", LogEventLevel.Warning)
            .Enrich.FromLogContext()
            .Enrich.WithProperty("Application", "MaxLoyaltyRKeeperUI")
            .Enrich.WithProperty("Version", GetVersion())
            .Enrich.WithMachineName()
            .Enrich.WithEnvironmentUserName()
            .WriteTo.File(
                path: @"C:\Logs\MaxLoyaltyRKeeper\ui-.log",
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 7,
                fileSizeLimitBytes: 50 * 1024 * 1024, // 50 MB
                rollOnFileSizeLimit: true,
                outputTemplate: "[{Timestamp:yyyy-MM-dd HH:mm:ss.fff}] [{Level:u3}] {Message:lj}{NewLine}{Exception}"
            )
            .WriteTo.File(
                path: @"C:\Logs\MaxLoyaltyRKeeper\errors-.log",
                restrictedToMinimumLevel: LogEventLevel.Error,
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 30
            )
            .CreateLogger();
    }
    
    private string GetVersion()
    {
        var assembly = Assembly.GetExecutingAssembly();
        var version = assembly.GetName().Version;
        return $"{version.Major}.{version.Minor}.{version.Build}";
    }
}
```


***

## **ğŸ¨ 4. UI/UX WORKFLOW**

### **4.1. Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°: Floating Button**

**Ğ Ğ°ÑĞ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ:**

```
Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… R-Keeper (Topmost)
ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ: ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: Ğ²ĞµÑ€Ñ…Ğ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ°Ğ²Ñ‹Ğ¹ ÑƒĞ³Ğ¾Ğ»)
Ğ Ğ°Ğ·Ğ¼ĞµÑ€: 60x60 px (touch-friendly)
```

**Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ R-KEEPER 7.x                                       â”‚
â”‚                                                    â”‚
â”‚  [Ğ¡Ñ‚Ğ¾Ğ»Ñ‹] [ĞœĞµĞ½Ñ] [Ğ—Ğ°ĞºĞ°Ğ·Ñ‹] [ĞšĞ°ÑÑĞ°]        â”Œâ”€â”€â”€â”€â”   â”‚
â”‚                                          â”‚ ML â”‚   â”‚ â† Floating Button
â”‚                                          â””â”€â”€â”€â”€â”˜   â”‚
â”‚  Ğ—Ğ°ĞºĞ°Ğ·: Ğ¡Ñ‚Ğ¾Ğ» 5                              ğŸŸ¢    â”‚ â† Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ñ‹
â”‚  â€¢ ĞŸĞ¸Ñ†Ñ†Ğ° ĞœĞ°Ñ€Ğ³Ğ°Ñ€Ğ¸Ñ‚Ğ° x1       500â‚½                  â”‚
â”‚  â€¢ Coca-Cola 0.5Ğ» x2        200â‚½                  â”‚
â”‚  â€¢ Ğ¡Ğ°Ğ»Ğ°Ñ‚ Ğ¦ĞµĞ·Ğ°Ñ€ÑŒ x1          350â‚½                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  Ğ˜Ğ¢ĞĞ“Ğ:                   1,050â‚½                   â”‚
â”‚                                                    â”‚
â”‚  [Ğš Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ]                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ’Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:**

- **ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ»Ğ¸Ğº** â†’ ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¾ĞºĞ½Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ³Ğ¾ÑÑ‚Ñ
- **Ğ”Ğ¾Ğ»Ğ³Ğ¾Ğµ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğµ (1 ÑĞµĞº)** â†’ Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¿ĞµÑ€ĞµÑ‚Ğ°ÑĞºĞ¸Ğ²Ğ°Ğ½Ğ¸Ñ
- **ĞŸÑ€Ğ°Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ¸Ğº** â†’ ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
- **Drag \& Drop** â†’ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ

**ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾ÑÑ‚Ñ          â”‚
â”‚ âŒ ĞÑ‚Ğ²ÑĞ·Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñƒ       â”‚ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”§ Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°          â”‚
â”‚ âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â„¹ï¸ Ğ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğµ          â”‚
â”‚ âŒ Ğ’Ñ‹Ñ…Ğ¾Ğ´                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### **4.2. ĞĞºĞ½Ğ¾ 1: ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾ÑÑ‚Ñ (GuestSearchWindow)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MAX LOYALTY                              [âœ•]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Ğ¢Ğ•Ğ›Ğ•Ğ¤ĞĞ]          [6-Ğ—ĞĞĞ§ĞĞ«Ğ™ ĞšĞĞ”]       â”‚  â”‚ â† Ğ¢Ğ°Ğ±Ñ‹
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â”‚     +7 (___) ___-__-__                    â”‚  â”‚ â† ĞŸĞ¾Ğ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ° (Ğ¼Ğ°ÑĞºĞ°)
â”‚  â”‚                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”                       â”‚
â”‚       â”‚  1  â”‚  2  â”‚  3  â”‚                       â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚       â”‚  4  â”‚  5  â”‚  6  â”‚   (80x80px)          â”‚ â† Ğ¦Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ
â”‚       â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                       â”‚   ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ°
â”‚       â”‚  7  â”‚  8  â”‚  9  â”‚                       â”‚   (touch-friendly)
â”‚       â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚       â”‚  â†  â”‚  0  â”‚  âœ“  â”‚                       â”‚
â”‚       â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ĞĞšĞ¢Ğ˜Ğ’ĞĞ«Ğ• Ğ—ĞĞšĞĞ—Ğ«                            â”‚  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â”‚ â˜‘ Ğ¡Ñ‚Ğ¾Ğ» 5 - 1,050â‚½                         â”‚  â”‚ â† Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ·Ğ°ĞºĞ°Ğ·Ğ°
â”‚  â”‚ â˜ Ğ¡Ñ‚Ğ¾Ğ» 12 - 2,340â‚½                        â”‚  â”‚   (ĞµÑĞ»Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾)
â”‚  â”‚                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ğŸ” ĞĞĞ™Ğ¢Ğ˜ Ğ“ĞĞ¡Ğ¢Ğ¯                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   â• Ğ¡ĞĞ—Ğ”ĞĞ¢Ğ¬ ĞĞĞ’ĞĞ“Ğ Ğ“ĞĞ¡Ğ¢Ğ¯                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ°: 1,050.00 â‚½                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:**

1. **ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ´:**

```csharp
private async void OnSearchClick()
{
    var input = SearchQueryInput;
    
    ShowLoading("ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾ÑÑ‚Ñ...");
    
    // 1. ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾ÑÑ‚Ñ Ğ½Ğ° backend
    var searchResponse = await apiClient.SearchGuestAsync(new SearchRequest
    {
        Phone = IsPhoneTab ? input : null,
        Code6Digit = IsCodeTab ? input : null
    });
    
    if (!searchResponse.Found)
    {
        HideLoading();
        ShowNotFoundDialog();
        return;
    }
    
    var guest = searchResponse.Guest;
    
    // 2. Calculate Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğ°
    var calculateResponse = await apiClient.CalculateAsync(new CalculateRequest
    {
        GuestCardId = guest.CardId,
        CheckAmount = SelectedOrder.Amount,
        OrderCategories = SelectedOrder.Categories,
        OrderType = SelectedOrder.Type
    });
    
    HideLoading();
    
    // 3. ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ĞºĞ½Ğ¾ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
    if (calculateResponse.BenefitType == "POINTS")
    {
        OpenPointsOperationWindow(guest, calculateResponse, SelectedOrder);
    }
    else if (calculateResponse.BenefitType == "DISCOUNT")
    {
        OpenDiscountOperationWindow(guest, calculateResponse, SelectedOrder);
    }
}
```

2. **ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· R-Keeper XML API:**

```csharp
private async Task LoadActiveOrdersAsync()
{
    var orders = await rkeeperClient.GetOrderListAsync();
    
    ActiveOrders = new ObservableCollection<RKeeperOrder>(orders);
    
    if (orders.Count == 1)
    {
        SelectedOrder = orders; // ĞĞ²Ñ‚Ğ¾Ğ²Ñ‹Ğ±Ğ¾Ñ€ ĞµÑĞ»Ğ¸ Ğ¾Ğ´Ğ¸Ğ½ Ğ·Ğ°ĞºĞ°Ğ·
    }
}
```


### **4.3. ĞĞºĞ½Ğ¾ 2A: ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ Ğ±Ğ°Ğ»Ğ»Ğ°Ğ¼Ğ¸ (PointsOperationWindow)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¡ĞŸĞ˜Ğ¡ĞĞĞ˜Ğ• Ğ‘ĞĞ›Ğ›ĞĞ’                          [âœ•]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ‘¤ Ğ˜Ğ’ĞĞ ĞŸĞ•Ğ¢Ğ ĞĞ’                                   â”‚
â”‚ ğŸ“± +7 999 123 45 67                              â”‚
â”‚ â­ Ğ—ĞĞ›ĞĞ¢ĞĞ™ Ğ£Ğ ĞĞ’Ğ•ĞĞ¬                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  ğŸ’° Ğ‘ĞĞĞ£Ğ¡ĞĞ«Ğ™ Ğ‘ĞĞ›ĞĞĞ¡                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚     â”‚        2,450.00 â‚½                 â”‚       â”‚
â”‚     â”‚                                   â”‚       â”‚
â”‚     â”‚  ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ: 1,500â‚½ â€¢ ĞŸÑ€Ğ¾Ğ¼Ğ¾: 950â‚½  â”‚       â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                  â”‚
â”‚  Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸:             1,050.00 â‚½          â”‚
â”‚  Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğº ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ:         210.00 â‚½   (20%)  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Ğ¡ĞŸĞ˜Ğ¡ĞĞ¢Ğ¬ Ğ‘ĞĞ›Ğ›ĞĞ’:           [^19_210] â‚½       â”‚  â”‚ â† ĞŸĞ¾Ğ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ°
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”                       â”‚
â”‚       â”‚  1  â”‚  2  â”‚  3  â”‚                       â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚       â”‚  4  â”‚  5  â”‚  6  â”‚                       â”‚ â† Ğ¦Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ
â”‚       â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                       â”‚   ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ°
â”‚       â”‚  7  â”‚  8  â”‚  9  â”‚                       â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚       â”‚  â†  â”‚  0  â”‚ MAX â”‚ â† ĞšĞ½Ğ¾Ğ¿ĞºĞ° MAX         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â• Ğ‘ÑƒĞ´ĞµÑ‚ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾: +53 Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ğŸ’³ Ğ¡ĞŸĞ˜Ğ¡ĞĞ¢Ğ¬ Ğ‘ĞĞ›Ğ›Ğ«                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   â• Ğ¢ĞĞ›Ğ¬ĞšĞ ĞĞĞ§Ğ˜Ğ¡Ğ›Ğ˜Ğ¢Ğ¬                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   âŒ ĞĞ¢Ğ’Ğ¯Ğ—ĞĞ¢Ğ¬ ĞšĞĞ Ğ¢Ğ£                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº:**

```csharp
// 1. ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¡ĞŸĞ˜Ğ¡ĞĞ¢Ğ¬ Ğ‘ĞĞ›Ğ›Ğ«"
private async void OnApplyPointsClick()
{
    var pointsToSpend = decimal.Parse(PointsToSpendInput);
    
    // Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
    if (pointsToSpend > MaxAllowed)
    {
        ShowError($"ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾: {MaxAllowed:N0}â‚½");
        return;
    }
    
    if (pointsToSpend > Guest.TotalBalance)
    {
        ShowError($"ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: {Guest.TotalBalance:N0}â‚½)");
        return;
    }
    
    ShowLoading("Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²...");
    
    // 1. Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° backend
    var reserveResponse = await apiClient.ReservePointsAsync(new ReserveRequest
    {
        GuestCardId = Guest.CardId,
        PointsToSpend = (double)pointsToSpend,
        MaxAllowed = (double)MaxAllowed,
        CheckAmount = (double)SelectedOrder.Amount,
        OrderId = SelectedOrder.Id
    });
    
    if (!reserveResponse.Success)
    {
        HideLoading();
        ShowError(reserveResponse.Error);
        return;
    }
    
    // 2. ĞŸÑ€Ğ¸Ğ²ÑĞ·ĞºĞ° ĞºĞ°Ñ€Ñ‚Ñ‹ Ğº Ğ·Ğ°ĞºĞ°Ğ·Ñƒ Ñ‡ĞµÑ€ĞµĞ· XML API
    await rkeeperClient.BindCardToOrderAsync(SelectedOrder.Id, Guest.Phone);
    
    // 3. ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ ÑĞºĞ¸Ğ´ĞºĞ¸ Ğ½Ğ° ÑÑƒĞ¼Ğ¼Ñƒ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²
    await rkeeperClient.ApplyManualDiscountAsync(
        SelectedOrder.Id,
        pointsToSpend,
        $"Max Loyalty - Ğ‘Ğ°Ğ»Ğ»Ñ‹ ({Guest.Name})"
    );
    
    // 4. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° Ğ² Shared Memory
    await sharedMemoryService.SaveOrderContextAsync(new OrderContext
    {
        OrderId = SelectedOrder.Id,
        GuestCardId = Guest.CardId,
        GuestName = Guest.Name,
        GuestPhone = Guest.Phone,
        BenefitType = BenefitType.Points,
        Action = LoyaltyAction.Spend,
        PointsToSpend = (double)pointsToSpend,
        MaxAllowed = (double)MaxAllowed,
        PointsToEarn = (double)PointsToEarn,
        ReservationId = reserveResponse.ReservationId,
        OriginalCheckAmount = (double)SelectedOrder.Amount,
        AppliedAt = DateTime.UtcNow
    });
    
    HideLoading();
    
    ShowSuccess(
        $"âœ… Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ {pointsToSpend:N0}â‚½ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¾\n\n" +
        $"Ğ‘ÑƒĞ´ĞµÑ‚ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾: +{PointsToEarn} Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²\n\n" +
        $"ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ±Ğ°Ğ»Ğ»Ñ‹ ÑĞ¿Ğ¸ÑˆÑƒÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸."
    );
    
    this.Close();
}

// 2. ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¢ĞĞ›Ğ¬ĞšĞ ĞĞĞ§Ğ˜Ğ¡Ğ›Ğ˜Ğ¢Ğ¬"
private async void OnEarnOnlyClick()
{
    ShowLoading("ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ...");
    
    // Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ñ Ñ pointsToSpend = 0
    var reserveResponse = await apiClient.ReservePointsAsync(new ReserveRequest
    {
        GuestCardId = Guest.CardId,
        PointsToSpend = 0,
        CheckAmount = (double)SelectedOrder.Amount,
        OrderId = SelectedOrder.Id,
        Action = "EARN_ONLY"
    });
    
    // ĞŸÑ€Ğ¸Ğ²ÑĞ·ĞºĞ° ĞºĞ°Ñ€Ñ‚Ñ‹
    await rkeeperClient.BindCardToOrderAsync(SelectedOrder.Id, Guest.Phone);
    
    // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
    await sharedMemoryService.SaveOrderContextAsync(new OrderContext
    {
        OrderId = SelectedOrder.Id,
        GuestCardId = Guest.CardId,
        GuestName = Guest.Name,
        GuestPhone = Guest.Phone,
        BenefitType = BenefitType.Points,
        Action = LoyaltyAction.EarnOnly,
        PointsToSpend = 0,
        PointsToEarn = (double)PointsToEarn,
        ReservationId = reserveResponse.ReservationId,
        OriginalCheckAmount = (double)SelectedOrder.Amount,
        AppliedAt = DateTime.UtcNow
    });
    
    HideLoading();
    
    ShowSuccess(
        $"âœ… ĞšĞ°Ñ€Ñ‚Ğ° Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½Ğ° Ğº Ğ·Ğ°ĞºĞ°Ğ·Ñƒ\n\n" +
        $"ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ±ÑƒĞ´ĞµÑ‚ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾ +{PointsToEarn} Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²"
    );
    
    this.Close();
}

// 3. ĞšĞ½Ğ¾Ğ¿ĞºĞ° "ĞĞ¢Ğ’Ğ¯Ğ—ĞĞ¢Ğ¬ ĞšĞĞ Ğ¢Ğ£"
private async void OnUnbindCardClick()
{
    var result = MessageBox.Show(
        "ĞÑ‚Ğ²ÑĞ·Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ¾Ñ‚ Ğ·Ğ°ĞºĞ°Ğ·Ğ°?",
        "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ",
        MessageBoxButton.YesNo,
        MessageBoxImage.Question
    );
    
    if (result == MessageBoxResult.Yes)
    {
        ShowLoading("ĞÑ‚Ğ²ÑĞ·ĞºĞ° ĞºĞ°Ñ€Ñ‚Ñ‹...");
        
        // ĞÑ‚Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° backend
        await apiClient.CancelReservationAsync(new CancelReservationRequest
        {
            ReservationId = ReservationId,
            OrderId = SelectedOrder.Id,
            Reason = "USER_UNBIND"
        });
        
        // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚
        await sharedMemoryService.ClearOrderContextAsync(SelectedOrder.Id);
        
        HideLoading();
        
        ShowSuccess("âœ… ĞšĞ°Ñ€Ñ‚Ğ° Ğ¾Ñ‚Ğ²ÑĞ·Ğ°Ğ½Ğ°");
        
        this.Close();
    }
}
```


### **4.4. ĞĞºĞ½Ğ¾ 2B: ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ¾ ÑĞºĞ¸Ğ´ĞºĞ¾Ğ¹ (DiscountOperationWindow)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ĞŸĞ Ğ˜ĞœĞ•ĞĞ•ĞĞ˜Ğ• Ğ¡ĞšĞ˜Ğ”ĞšĞ˜                        [âœ•]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ‘¤ ĞœĞĞ Ğ˜Ğ¯ Ğ¡Ğ˜Ğ”ĞĞ ĞĞ’Ğ                                â”‚
â”‚ ğŸ“± +7 999 765 43 21                              â”‚
â”‚ â­ Ğ¡Ğ•Ğ Ğ•Ğ‘Ğ Ğ¯ĞĞ«Ğ™ Ğ£Ğ ĞĞ’Ğ•ĞĞ¬ (Ğ¡ĞºĞ¸Ğ´ĞºĞ° 15%)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  ğŸ ĞŸĞ•Ğ Ğ¡ĞĞĞĞ›Ğ¬ĞĞĞ¯ Ğ¡ĞšĞ˜Ğ”ĞšĞ                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚     â”‚                                   â”‚       â”‚
â”‚     â”‚           15%                     â”‚       â”‚
â”‚     â”‚                                   â”‚       â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                  â”‚
â”‚  Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸:             1,050.00 â‚½          â”‚
â”‚  Ğ¡ĞºĞ¸Ğ´ĞºĞ° 15%:                 -157.50 â‚½          â”‚
â”‚  Ğš Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ:                    892.50 â‚½          â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ğŸ ĞŸĞ Ğ˜ĞœĞ•ĞĞ˜Ğ¢Ğ¬ Ğ¡ĞšĞ˜Ğ”ĞšĞ£                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   âŒ ĞĞ¢Ğ’Ğ¯Ğ—ĞĞ¢Ğ¬ ĞšĞĞ Ğ¢Ğ£                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â„¹ï¸ Ğ¡ĞºĞ¸Ğ´ĞºĞ° Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ¸ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ° â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:**

```csharp
private async void OnApplyDiscountClick()
{
    ShowLoading("ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ÑĞºĞ¸Ğ´ĞºĞ¸...");
    
    // 1. Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° backend
    var reserveResponse = await apiClient.ReserveDiscountAsync(new ReserveRequest
    {
        GuestCardId = Guest.CardId,
        DiscountPercentage = (double)DiscountPercentage,
        DiscountAmount = (double)DiscountAmount,
        CheckAmount = (double)SelectedOrder.Amount,
        OrderId = SelectedOrder.Id
    });
    
    if (!reserveResponse.Success)
    {
        HideLoading();
        ShowError(reserveResponse.Error);
        return;
    }
    
    // 2. ĞŸÑ€Ğ¸Ğ²ÑĞ·ĞºĞ° ĞºĞ°Ñ€Ñ‚Ñ‹ Ğº Ğ·Ğ°ĞºĞ°Ğ·Ñƒ
    await rkeeperClient.BindCardToOrderAsync(SelectedOrder.Id, Guest.Phone);
    
    // 3. ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ½Ğ¾Ğ¹ ÑĞºĞ¸Ğ´ĞºĞ¸ Ñ‡ĞµÑ€ĞµĞ· XML API
    await rkeeperClient.ApplyPercentDiscountAsync(
        SelectedOrder.Id,
        DiscountPercentage,
        $"Max Loyalty - {DiscountPercentage}% ({Guest.LevelName})"
    );
    
    // 4. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
    await sharedMemoryService.SaveOrderContextAsync(new OrderContext
    {
        OrderId = SelectedOrder.Id,
        GuestCardId = Guest.CardId,
        GuestName = Guest.Name,
        GuestPhone = Guest.Phone,
        BenefitType = BenefitType.Discount,
        Action = LoyaltyAction.ApplyDiscount,
        DiscountPercentage = (double)DiscountPercentage,
        DiscountAmount = (double)DiscountAmount,
        ReservationId = reserveResponse.ReservationId,
        OriginalCheckAmount = (double)SelectedOrder.Amount,
        AppliedAt = DateTime.UtcNow
    });
    
    HideLoading();
    
    ShowSuccess(
        $"âœ… Ğ¡ĞºĞ¸Ğ´ĞºĞ° {DiscountPercentage}% ({DiscountAmount:N0}â‚½) Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ°\n\n" +
        $"ğŸ”’ Ğ¡ÑƒĞ¼Ğ¼Ğ° Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ¸ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ°"
    );
    
    this.Close();
}
```


***

## **ğŸ’° 5. Ğ¤Ğ˜ĞĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ĞŸĞ Ğ˜ ĞĞŸĞ›ĞĞ¢Ğ•**

### **5.1. ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ñ„Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· FarCard**

ĞšĞ¾Ğ³Ğ´Ğ° ĞºĞ°ÑÑĞ¸Ñ€ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‡ĞµĞº, R-Keeper Ñ‡ĞµÑ€ĞµĞ· FarCard Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ `FinalizeTransaction()` Ğ² DLL:

```cpp
// Ğ’ MaxLoyaltyRKeeper.dll

extern "C" __declspec(dllexport) int __stdcall FinalizeTransaction(
    const char* reservationId,
    double finalAmount,
    const char* orderId,
    const char* paymentTypesJson
)
{
    g_logger->Info("FinalizeTransaction: OrderId=%s, Amount=%.2f", orderId, finalAmount);
    
    try
    {
        // 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· shared memory
        auto context = g_sharedMemory->GetOrderContext(orderId);
        
        if (!context.has_value())
        {
            g_logger->Warning("No loyalty context for order %s", orderId);
            return 0; // ĞĞµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ½ĞµÑ‚ Ğ»Ğ¾ÑĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
        }
        
        // 2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ¼Ñ ĞºĞ°ÑÑĞ¸Ñ€Ğ°
        std::string cashierName = GetCurrentCashierName();
        
        // 3. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº backend
        json requestBody = {
            {"guestCardId", context->cardId},
            {"orderId", orderId},
            {"reservationId", context->reservationId},
            {"checkAmount", context->originalAmount},
            {"finalCheckAmount", finalAmount},
            {"restaurantId", g_restaurantId},
            {"terminalId", g_terminalId},
            {"stationId", context->stationId},
            {"cashierName", cashierName},
            {"paymentTypes", json::parse(paymentTypesJson)},
            {"orderType", "DINE_IN"}
        };
        
        std::string endpoint;
        
        if (context->benefitType == BenefitType::Points)
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-points";
            requestBody["pointsSpent"] = context->pointsToSpend;
            requestBody["pointsToEarn"] = context->pointsToEarn;
            requestBody["action"] = context->action;
        }
        else if (context->benefitType == BenefitType::Discount)
        {
            endpoint = "/api/pos-integration/rkeeper/finalize-discount";
            requestBody["discountAmount"] = context->discountAmount;
            requestBody["discountPercentage"] = context->discountPercentage;
        }
        
        // 4. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ retry
        auto response = RetryPolicy::Execute([&]() {
            return g_httpClient->Post(endpoint, requestBody.dump());
        }, 3);
        
        if (response.statusCode == 200)
        {
            auto responseData = json::parse(response.body);
            
            if (responseData["success"].get<bool>())
            {
                std::string txnId = responseData["transactionId"].get<std::string>();
                g_logger->Info("Finalized successfully: TxnId=%s", txnId.c_str());
                
                // 5. ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚
                g_sharedMemory->ClearOrderContext(orderId);
                
                // 6. Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ UI
                g_sharedMemory->NotifyUI("order_finalized", orderId);
                
                // 7. ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸
                SendMetric("loyalty.transaction.finalized", 1);
                
                return 0; // SUCCESS
            }
        }
        
        // Backend Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½
        g_logger->Warning("Backend unavailable, queueing offline...");
        
        // 8. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² offline queue
        g_sharedMemory->EnqueueOfflineOperation({
            "FINALIZE_" + std::string(context->benefitType == BenefitType::Points ? "POINTS" : "DISCOUNT"),
            orderId,
            requestBody.dump(),
            GetCurrentTimestamp(),
            0 // attempts
        });
        
        return -2; // Queued offline
    }
    catch (const std::exception& ex)
    {
        g_logger->Error("FinalizeTransaction exception: %s", ex.what());
        return -1;
    }
}
```


### **5.2. ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ¼ĞµĞ½Ğ¸ ĞºĞ°ÑÑĞ¸Ñ€Ğ°**

```cpp
std::string GetCurrentCashierName()
{
    try
    {
        // 1. ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ R-Keeper
        char* cashier = std::getenv("RK7_CURRENT_USER");
        if (cashier != nullptr)
        {
            return std::string(cashier);
        }
        
        // 2. Ğ§ĞµÑ€ĞµĞ· Windows API (Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Windows)
        char username[^19_256];
        DWORD size = sizeof(username);
        if (GetUserNameA(username, &size))
        {
            return std::string(username);
        }
        
        return "Unknown";
    }
    catch (...)
    {
        return "Unknown";
    }
}
```


***

## **ğŸ”„ 6. R-KEEPER XML API Ğ˜ĞĞ¢Ğ•Ğ“Ğ ĞĞ¦Ğ˜Ğ¯**

### **6.1. RKeeperXmlClient.cs**

```csharp
public interface IRKeeperXmlClient
{
    Task<List<RKeeperOrder>> GetOrderListAsync();
    Task<RKeeperOrder> GetOrderDetailsAsync(string orderId);
    Task BindCardToOrderAsync(string orderId, string cardNumber);
    Task ApplyManualDiscountAsync(string orderId, decimal amount, string reason);
    Task ApplyPercentDiscountAsync(string orderId, decimal percentage, string reason);
    Task<string> GetCashierNameAsync();
    Task<ServerInfo> GetServerInfoAsync();
}

public class RKeeperXmlClient : IRKeeperXmlClient
{
    private readonly HttpClient httpClient;
    private readonly IConfigService configService;
    private readonly ILogger<RKeeperXmlClient> logger;
    private readonly string xmlApiUrl;
    
    public RKeeperXmlClient(
        HttpClient httpClient,
        IConfigService configService,
        ILogger<RKeeperXmlClient> logger)
    {
        this.httpClient = httpClient;
        this.configService = configService;
        this.logger = logger;
        
        var config = configService.LoadConfig();
        xmlApiUrl = config.RKeeperXmlApiUrl;
        
        httpClient.Timeout = TimeSpan.FromSeconds(10);
    }
    
    public async Task<List<RKeeperOrder>> GetOrderListAsync()
    {
        logger.LogInformation("Getting order list from R-Keeper");
        
        var xml = @"
            <RK7Query>
              <RK7CMD CMD=""GetOrderList"">
                <Filter>
                  <Status>OPEN</Status>
                </Filter>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        
        var doc = XDocument.Parse(response);
        
        var orders = doc.Descendants("Order").Select(o => new RKeeperOrder
        {
            Id = o.Element("ident")?.Value,
            TableNumber = o.Element("Table")?.Value,
            Amount = ParseDecimal(o.Element("Amount")?.Value),
            Status = o.Element("Status")?.Value,
            Type = ParseOrderType(o.Element("OrderType")?.Value),
            Categories = ParseCategories(o.Element("Items")),
            StationId = o.Element("StationId")?.Value,
            OpenedAt = ParseDateTime(o.Element("OpenedAt")?.Value),
            DisplayName = GetOrderDisplayName(o)
        }).ToList();
        
        logger.LogInformation("Retrieved {Count} orders", orders.Count);
        
        return orders;
    }
    
    public async Task BindCardToOrderAsync(string orderId, string cardNumber)
    {
        logger.LogInformation("Binding card to order: {OrderId}, Card: {CardNumber}", 
            orderId, MaskCardNumber(cardNumber));
        
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""SaveOrder"">
                <Order>
                  <ident>{XmlEscape(orderId)}</ident>
                  <GuestCard>
                    <CardNumber>{XmlEscape(cardNumber)}</CardNumber>
                  </GuestCard>
                </Order>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        ValidateResponse(response);
        
        logger.LogInformation("Card bound successfully");
    }
    
    public async Task ApplyManualDiscountAsync(string orderId, decimal amount, string reason)
    {
        logger.LogInformation("Applying manual discount: {OrderId}, Amount: {Amount}", 
            orderId, amount);
        
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""SaveOrder"">
                <Order>
                  <ident>{XmlEscape(orderId)}</ident>
                  <Discount>
                    <Type>MANUAL</Type>
                    <DiscountType>FIXED</DiscountType>
                    <Value>{amount.ToString("0.00", CultureInfo.InvariantCulture)}</Value>
                    <Reason>{XmlEscape(reason)}</Reason>
                  </Discount>
                </Order>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        ValidateResponse(response);
        
        logger.LogInformation("Manual discount applied successfully");
    }
    
    public async Task ApplyPercentDiscountAsync(string orderId, decimal percentage, string reason)
    {
        logger.LogInformation("Applying percent discount: {OrderId}, Percentage: {Percentage}%", 
            orderId, percentage);
        
        var xml = $@"
            <RK7Query>
              <RK7CMD CMD=""SaveOrder"">
                <Order>
                  <ident>{XmlEscape(orderId)}</ident>
                  <Discount>
                    <Type>MANUAL</Type>
                    <DiscountType>PERCENT</DiscountType>
                    <Value>{percentage.ToString("0.00", CultureInfo.InvariantCulture)}</Value>
                    <Reason>{XmlEscape(reason)}</Reason>
                  </Discount>
                </Order>
              </RK7CMD>
            </RK7Query>
        ";
        
        var response = await SendXmlRequestAsync(xml);
        ValidateResponse(response);
        
        logger.LogInformation("Percent discount applied successfully");
    }
    
    private async Task<string> SendXmlRequestAsync(string xmlRequest)
    {
        try
        {
            var content = new StringContent(xmlRequest, Encoding.UTF8, "text/xml");
            var response = await httpClient.PostAsync(xmlApiUrl, content);
            
            if (!response.IsSuccessStatusCode)
            {
                logger.LogError("R-Keeper XML API returned {StatusCode}", response.StatusCode);
                throw new HttpRequestException($"R-Keeper API error: {response.StatusCode}");
            }
            
            var responseXml = await response.Content.ReadAsStringAsync();
            
            logger.LogDebug("R-Keeper Response: {Response}", responseXml);
            
            return responseXml;
        }
        catch (TaskCanceledException ex)
        {
            logger.LogError(ex, "R-Keeper XML API request timeout");
            throw new TimeoutException("R-Keeper API timeout", ex);
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "R-Keeper XML API request failed");
            throw;
        }
    }
    
    private void ValidateResponse(string xmlResponse)
    {
        var doc = XDocument.Parse(xmlResponse);
        var status = doc.Descendants("Status").FirstOrDefault()?.Value;
        
        if (status != "OK" && status != "SUCCESS")
        {
            var error = doc.Descendants("Error").FirstOrDefault()?.Value ?? "Unknown error";
            throw new Exception($"R-Keeper error: {error}");
        }
    }
}
```


***

## **ğŸ“¡ 7. BACKEND API ENDPOINTS**

```typescript
// ==========================================
// 1. ĞŸĞĞ˜Ğ¡Ğš Ğ“ĞĞ¡Ğ¢Ğ¯
// ==========================================

POST /api/pos-integration/rkeeper/search-guest

Headers:
  X-API-Key: rk_live_xxxxx
  X-Installation-Id: inst_abc123
  X-Tenant-Id: tenant_mario
  X-Restaurant-Id: rest_centro
  X-Terminal-Id: term_001

Request:
{
  "phone"?: "+79991234567",
  "code6Digit"?: "123456"
}

Response 200:
{
  "found": true,
  "guest": {
    "cardId": "card_uuid_abc",
    "name": "Ğ˜Ğ²Ğ°Ğ½ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²",
    "phone": "+79991234567",
    "levelId": 2,
    "levelName": "Ğ¡ĞµÑ€ĞµĞ±Ñ€Ğ¾",
    "regularBalance": 1500.00,
    "promoBalance": 950.00,
    "totalBalance": 2450.00,
    "code6Digit": "123456"
  }
}

// ==========================================
// 2. Ğ ĞĞ¡Ğ§Ğ•Ğ¢ Ğ‘Ğ•ĞĞ•Ğ¤Ğ˜Ğ¢ĞĞ’
// ==========================================

POST /api/pos-integration/rkeeper/calculate

Request:
{
  "guestCardId": "card_uuid_abc",
  "checkAmount": 890.00,
  "orderCategories": ["ĞŸĞ¸Ñ†Ñ†Ğ°", "ĞĞ°Ğ¿Ğ¸Ñ‚ĞºĞ¸"],
  "orderType": "DINE_IN",
  "calculateOnly": true
}

Response 200:
{
  "benefitType": "POINTS",
  "maxAllowedToSpend": 178.00,
  "pointsToEarn": 45.00,
  "discountPercentage": 0,
  "discountAmount": 0,
  "checkAmount": 890.00
}

// ==========================================
// 3. Ğ Ğ•Ğ—Ğ•Ğ Ğ’ĞĞ¦Ğ˜Ğ¯ Ğ‘ĞĞ›Ğ›ĞĞ’
// ==========================================

POST /api/pos-integration/rkeeper/reserve-points

Request:
{
  "guestCardId": "card_uuid_abc",
  "pointsToSpend": 178.00,
  "maxAllowed": 178.00,
  "checkAmount": 890.00,
  "orderId": "order_12345",
  "restaurantId": "rest_centro",
  "terminalId": "term_001",
  "action": "SPEND"
}

Response 200:
{
  "success": true,
  "reservationId": "res_xyz789",
  "pointsReserved": 178.00,
  "expiresAt": "2026-02-18T01:00:00Z",
  "newBalance": 2272.00
}

// ==========================================
// 4. Ğ¤Ğ˜ĞĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ‘ĞĞ›Ğ›ĞĞ’
// ==========================================

POST /api/pos-integration/rkeeper/finalize-points

Request:
{
  "guestCardId": "card_uuid_abc",
  "orderId": "order_12345",
  "reservationId": "res_xyz789",
  "pointsSpent": 178.00,
  "pointsToEarn": 45.00,
  "action": "SPEND",
  "checkAmount": 890.00,
  "finalCheckAmount": 890.00,
  "restaurantId": "rest_centro",
  "terminalId": "term_001",
  "cashierName": "Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ° Ğ.",
  "paymentTypes": ["CASH", "CARD"]
}

Response 200:
{
  "success": true,
  "transactionId": "txn_abc123",
  "pointsSpent": 178.00,
  "pointsEarned": 45.00,
  "newBalance": 2317.00
}

// ==========================================
// 5. Ğ¡ĞĞ—Ğ”ĞĞĞ˜Ğ• Ğ“ĞĞ¡Ğ¢Ğ¯
// ==========================================

POST /api/pos-integration/rkeeper/create-guest

Request:
{
  "phone": "+79991234567",
  "name": "Ğ˜Ğ²Ğ°Ğ½ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²",
  "birthDate": "1990-05-15"
}

Response 200:
{
  "success": true,
  "guestCardId": "card_new_uuid",
  "code6Digit": "654321"
}

// ==========================================
// 6. ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯ Ğ Ğ•Ğ¡Ğ¢ĞĞ ĞĞĞ
// ==========================================

GET /api/pos-integration/rkeeper/config

Response 200:
{
  "restaurantId": "rest_centro",
  "restaurantName": "ĞŸĞ¸Ñ†Ñ†ĞµÑ€Ğ¸Ñ Ğ£ ĞœĞ°Ñ€Ğ¸Ğ¾ - Ğ¦ĞµĞ½Ñ‚Ñ€",
  "minCheckAmount": 100.00,
  "maxSpendPercentage": 20,
  "earnRate": 5
}
```


***

## **ğŸ” 8. Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¡Ğ¢Ğ¬**

### **8.1. Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ API Key**

```csharp
public class Encryption
{
    private const string SALT = "MaxLoyaltySalt2026";
    
    public static string GetMachineId()
    {
        var sb = new StringBuilder();
        
        // CPU ID
        using (var searcher = new ManagementObjectSearcher("SELECT ProcessorId FROM Win32_Processor"))
        {
            foreach (var obj in searcher.Get())
            {
                sb.Append(obj["ProcessorId"]?.ToString());
            }
        }
        
        // Motherboard Serial
        using (var searcher = new ManagementObjectSearcher("SELECT SerialNumber FROM Win32_BaseBoard"))
        {
            foreach (var obj in searcher.Get())
            {
                sb.Append(obj["SerialNumber"]?.ToString());
            }
        }
        
        // MAC Address
        var nic = NetworkInterface.GetAllNetworkInterfaces()
            .FirstOrDefault(n => n.OperationalStatus == OperationalStatus.Up 
                              && n.NetworkInterfaceType != NetworkInterfaceType.Loopback);
        
        if (nic != null)
        {
            sb.Append(nic.GetPhysicalAddress().ToString());
        }
        
        using var sha256 = SHA256.Create();
        var hash = sha256.ComputeHash(Encoding.UTF8.GetBytes(sb.ToString()));
        return Convert.ToBase64String(hash);
    }
    
    public static string EncryptApiKey(string apiKey, string machineId)
    {
        using var aes = Aes.Create();
        aes.Key = DeriveKey(machineId);
        aes.IV = DeriveIV(machineId);
        
        using var encryptor = aes.CreateEncryptor();
        var plainBytes = Encoding.UTF8.GetBytes(apiKey);
        var encryptedBytes = encryptor.TransformFinalBlock(plainBytes, 0, plainBytes.Length);
        
        return Convert.ToBase64String(encryptedBytes);
    }
    
    public static string DecryptApiKey(string encryptedApiKey, string machineId)
    {
        try
        {
            using var aes = Aes.Create();
            aes.Key = DeriveKey(machineId);
            aes.IV = DeriveIV(machineId);
            
            using var decryptor = aes.CreateDecryptor();
            var encryptedBytes = Convert.FromBase64String(encryptedApiKey);
            var decryptedBytes = decryptor.TransformFinalBlock(encryptedBytes, 0, encryptedBytes.Length);
            
            return Encoding.UTF8.GetString(decryptedBytes);
        }
        catch (Exception ex)
        {
            throw new CryptographicException("Failed to decrypt API Key", ex);
        }
    }
}
```


***

## **ğŸ“´ 9. OFFLINE Ğ Ğ•Ğ–Ğ˜Ğœ**

### **9.1. OfflineQueueService.cs**

```csharp
public class OfflineQueueService : IOfflineQueueService
{
    private readonly ILoyaltyApiClient apiClient;
    private readonly ISharedMemoryService sharedMemory;
    private readonly ILogger<OfflineQueueService> logger;
    private readonly string queueFilePath;
    private const int MaxQueueSize = 100;
    private const int TtlHours = 24;
    
    public async Task EnqueueAsync(OfflineOperation operation)
    {
        var queue = await LoadQueueAsync();
        
        if (queue.Count >= MaxQueueSize)
        {
            logger.LogWarning("Offline queue is full ({Count}), removing oldest", queue.Count);
            queue.RemoveAt(0);
        }
        
        operation.Id = Guid.NewGuid().ToString();
        operation.QueuedAt = DateTime.UtcNow;
        operation.Attempts = 0;
        
        queue.Add(operation);
        await SaveQueueAsync(queue);
        
        await sharedMemory.EnqueueOfflineOperationAsync(operation);
        
        logger.LogWarning("Operation queued offline: Type={Type}, OrderId={OrderId}",
            operation.Type, operation.OrderId);
    }
    
    public async Task ProcessQueueAsync()
    {
        var queue = await LoadQueueAsync();
        
        if (queue.Count == 0)
        {
            logger.LogDebug("Offline queue is empty");
            return;
        }
        
        logger.LogInformation("Processing offline queue: {Count} operations", queue.Count);
        
        var processed = new List<OfflineOperation>();
        
        foreach (var operation in queue)
        {
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° TTL
            if (DateTime.UtcNow - operation.QueuedAt > TimeSpan.FromHours(TtlHours))
            {
                logger.LogWarning("Operation expired: {Id}", operation.Id);
                processed.Add(operation);
                continue;
            }
            
            try
            {
                var success = await ProcessOperationAsync(operation);
                
                if (success)
                {
                    processed.Add(operation);
                    logger.LogInformation("Processed offline operation: {Id}", operation.Id);
                }
                else
                {
                    operation.Attempts++;
                    if (operation.Attempts >= 5)
                    {
                        logger.LogError("Operation failed after 5 attempts: {Id}", operation.Id);
                        processed.Add(operation);
                    }
                }
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "Error processing offline operation: {Id}", operation.Id);
                operation.Attempts++;
            }
        }
        
        queue = queue.Except(processed).ToList();
        await SaveQueueAsync(queue);
        
        if (processed.Count > 0)
        {
            ShowNotification($"ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾ {processed.Count} Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ¸Ğ· Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸");
        }
    }
}
```


***

## **ğŸ¯ 10. Ğ˜Ğ¢ĞĞ“ĞĞ’ĞĞ¯ Ğ¡Ğ¥Ğ•ĞœĞ Ğ ĞĞ‘ĞĞ¢Ğ«**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     R-KEEPER CASH STATION                          â”‚
â”‚                                                                    â”‚
â”‚  1ï¸âƒ£ ĞšĞ°ÑÑĞ¸Ñ€ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ·Ğ°ĞºĞ°Ğ·                                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚     â”‚ Ğ—Ğ°ĞºĞ°Ğ·: Ğ¡Ñ‚Ğ¾Ğ» 5                                â”‚              â”‚
â”‚     â”‚ â€¢ ĞŸĞ¸Ñ†Ñ†Ğ° ĞœĞ°Ñ€Ğ³Ğ°Ñ€Ğ¸Ñ‚Ğ°    500â‚½                    â”‚              â”‚
â”‚     â”‚ â€¢ Coca-Cola 0.5Ğ»     200â‚½                    â”‚              â”‚
â”‚     â”‚ â€¢ Ğ¡Ğ°Ğ»Ğ°Ñ‚ Ğ¦ĞµĞ·Ğ°Ñ€ÑŒ       350â‚½                    â”‚              â”‚
â”‚     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚              â”‚
â”‚     â”‚ Ğ˜Ğ¢ĞĞ“Ğ:             1,050â‚½                    â”‚              â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                    â”‚
â”‚  2ï¸âƒ£ Ğ’Ğ¸Ğ´Ğ¸Ñ‚ Floating Button                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”                                                        â”‚
â”‚     â”‚ ML â”‚ ğŸŸ¢ â† Floating Button (Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…)                  â”‚
â”‚     â””â”€â”€â”€â”€â”˜                                                        â”‚
â”‚                                                                    â”‚
â”‚  3ï¸âƒ£ ĞšĞ»Ğ¸ĞºĞ°ĞµÑ‚ â†’ ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¾ĞºĞ½Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ³Ğ¾ÑÑ‚Ñ                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚     â”‚ MAX LOYALTY                                  â”‚              â”‚
â”‚     â”‚ +7 999 123 45 67                            â”‚              â”‚
â”‚     â”‚ [OK] [Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ³Ğ¾ÑÑ‚Ñ]                        â”‚              â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚            â–¼                                                      â”‚
â”‚     Backend API: SearchGuest()                                    â”‚
â”‚            â–¼                                                      â”‚
â”‚     Backend API: Calculate()                                      â”‚
â”‚                                                                    â”‚
â”‚  4ï¸âƒ£ Ğ’Ğ¸Ğ´Ğ¸Ñ‚ Ğ¾ĞºĞ½Ğ¾ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ (Ğ±Ğ°Ğ»Ğ»Ñ‹/ÑĞºĞ¸Ğ´ĞºĞ°)                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚     â”‚ Ğ¡ĞŸĞ˜Ğ¡ĞĞĞ˜Ğ• Ğ‘ĞĞ›Ğ›ĞĞ’                              â”‚              â”‚
â”‚     â”‚ Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: 2,450â‚½                               â”‚              â”‚
â”‚     â”‚ Ğ¡Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ: [^19_210]â‚½                              â”‚              â”‚
â”‚     â”‚ [ğŸ’³ Ğ¡ĞŸĞ˜Ğ¡ĞĞ¢Ğ¬ Ğ‘ĞĞ›Ğ›Ğ«]                          â”‚              â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚            â–¼                                                      â”‚
â”‚     Backend API: ReservePoints()                                  â”‚
â”‚            â–¼                                                      â”‚
â”‚     XML API: BindCardToOrder()                                    â”‚
â”‚            â–¼                                                      â”‚
â”‚     XML API: ApplyManualDiscount()                                â”‚
â”‚            â–¼                                                      â”‚
â”‚     Shared Memory: SaveOrderContext()                             â”‚
â”‚                                                                    â”‚
â”‚  5ï¸âƒ£ Ğ’ Ğ·Ğ°ĞºĞ°Ğ·Ğµ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ÑÑ ÑĞºĞ¸Ğ´ĞºĞ°                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚     â”‚ Ğ—Ğ°ĞºĞ°Ğ·: Ğ¡Ñ‚Ğ¾Ğ» 5                                â”‚              â”‚
â”‚     â”‚ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹:                    1,050â‚½           â”‚              â”‚
â”‚     â”‚ Max Loyalty - Ğ‘Ğ°Ğ»Ğ»Ñ‹         -210â‚½           â”‚ â† Ğ¡ĞºĞ¸Ğ´ĞºĞ°     â”‚
â”‚     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚              â”‚
â”‚     â”‚ Ğš ĞĞŸĞ›ĞĞ¢Ğ•:                   840â‚½            â”‚              â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                    â”‚
â”‚  6ï¸âƒ£ ĞšĞ°ÑÑĞ¸Ñ€ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‡ĞµĞº (Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°)                                â”‚
â”‚            â–¼                                                      â”‚
â”‚     FarCard â†’ DLL: FinalizeTransaction()                          â”‚
â”‚            â–¼                                                      â”‚
â”‚     Backend API: FinalizePoints()                                 â”‚
â”‚            â–¼                                                      â”‚
â”‚     âœ… Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾ 210â‚½ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²                                       â”‚
â”‚     âœ… ĞĞ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾ +42 Ğ±Ğ°Ğ»Ğ»Ğ°                                       â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


***

## **âœ… Ğ§Ğ•ĞšĞ›Ğ˜Ğ¡Ğ¢ Ğ¤Ğ£ĞĞšĞ¦Ğ˜ĞĞĞĞ›Ğ¬ĞĞĞ¡Ğ¢Ğ˜**

### **ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:**

- âœ… ĞŸĞ¾Ğ¸ÑĞº Ğ³Ğ¾ÑÑ‚Ñ Ğ¿Ğ¾ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ñƒ/6-digit ĞºĞ¾Ğ´Ñƒ
- âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ³Ğ¾ÑÑ‚Ñ Ñ ĞºĞ°ÑÑÑ‹
- âœ… ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° POINTS (Ğ½Ğ°ĞºĞ¾Ğ¿Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ)
- âœ… ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° DISCOUNT (ÑĞºĞ¸Ğ´Ğ¾Ñ‡Ğ½Ğ°Ñ)
- âœ… Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· Ñ€ÑƒÑ‡Ğ½ÑƒÑ ÑĞºĞ¸Ğ´ĞºÑƒ
- âœ… ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ½Ğ¾Ğ¹ ÑĞºĞ¸Ğ´ĞºĞ¸
- âœ… Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğµ (EarnOnly)
- âœ… ĞÑ‚Ğ²ÑĞ·ĞºĞ° ĞºĞ°Ñ€Ñ‚Ñ‹
- âœ… Ğ ĞµĞ·ĞµÑ€Ğ²Ğ°Ñ†Ğ¸Ñ + Ğ¤Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- âœ… Floating Button (Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…)


### **Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ:**

- âœ… Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ API Key (AES-256)
- âœ… Machine-binding
- âœ… Revoke Ñ‡ĞµÑ€ĞµĞ· backend
- âœ… HTTPS only


### **Offline Ñ€ĞµĞ¶Ğ¸Ğ¼:**

- âœ… ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ offline
- âœ… Queue Ğ´Ğ»Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ (100 Ğ¼Ğ°ĞºÑ, TTL 24Ñ‡)
- âœ… ĞĞ²Ñ‚Ğ¾ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ


### **ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³:**

- âœ… Structured logging (Serilog)
- âœ… ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ½Ğ° backend
- âœ… Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑĞºÑ€Ğ°Ğ½
- âœ… Health checks


### **DevOps:**

- âœ… ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ installer (NSIS)
- âœ… ĞĞ²Ñ‚Ğ¾Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° FarCard
- âœ… ĞĞ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
- âœ… Uninstaller

***

## **ğŸ“‹ Ğ˜Ğ¢ĞĞ“Ğ**

**ĞŸĞ»Ğ°Ğ³Ğ¸Ğ½ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ!**

Ğ§Ñ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾:

1. âœ… ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ° (DLL + UI + Shared Memory)
2. âœ… UI/UX ÑĞ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ (Floating Button + Ğ¾ĞºĞ½Ğ°)
3. âœ… API endpoints Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹
4. âœ… FarCard Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°
5. âœ… XML API ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
6. âœ… Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞ¼Ğ°Ğ½Ğ°
7. âœ… Offline Ñ€ĞµĞ¶Ğ¸Ğ¼ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½
8. âœ… ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½

**Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ Ğº Ğ¸Ğ¼Ğ¿Ğ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸! ğŸš€**
<span style="display:none">[^19_1]</span>

<div align="center">â‚</div>

[^19_1]: Plagin-iiko.md

