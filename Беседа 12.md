


# Хочу детализировать полностью ui/ux проекта.
# Перед началом уточню. Интерфейсы, дашборды и экраны должны быть выполнены в такойм стиле как в прикрепленных. Прикрепил пример экранов, который я делал, изучи

Отлично! Я изучил твои дизайны! 🎨 Теперь вижу **конкретный визуальный стиль** для Max Loyalty. Сейчас детально проанализирую и зафиксирую все UI/UX паттерны.

***

# 🎨 **АНАЛИЗ ТВОИХ ДИЗАЙНОВ: ВИЗУАЛЬНЫЙ СТИЛЬ MAX LOYALTY**

## **📊 1. DASHBOARD (Max-Loyalty-Dashboard.html)**

### **✅ Ключевые паттерны, которые я вижу:**

#### **A) Цветовая схема**

- **Фон**: Тёмный (темно-серый/черный) — `#1a1a1a` или `#0f0f0f`
- **Карточки**: Чуть светлее фона — `#1f1f1f` или `#262626`
- **Акценты**:
    - Синий для PRIMARY — `#3b82f6` или `#2563eb`
    - Зелёный для SUCCESS/РОСТ — `#10b981` или `#22c55e`
    - Красный для DANGER/ПАДЕНИЕ — `#ef4444` или `#f87171`
    - Жёлтый для WARNING — `#f59e0b`
- **Текст**:
    - Заголовки белые — `#ffffff`
    - Описания серые — `#9ca3af` или `#6b7280`
- **Borders**: Тонкие, тёмные — `#2d2d2d` или `#374151`


#### **B) Типографика**

- **Заголовки**: Жирные (font-weight: 600-700)
- **Метрики**: Очень крупные (text-2xl, text-3xl), жирные
- **Иконки**: Используются эмодзи (🍕, 🥇, 📊, 💰) + символы (✓, ✕, ↑, ↓)
- **Статусы**: Иконки + текст (✓ Активен, ✕ Заблокирован)


#### **C) Layout паттерны**

- **Grid карточек**: 4 метрики в строке (responsive на mobile → 2 в строке)
- **Карточки метрик**:

```
┌─────────────────────┐
│ Всего рестораны     │ ← Заголовок (серый)
│ 24                  │ ← Большая цифра (белая)
│ ↑ 2 за месяц        │ ← Изменение (зелёная)
└─────────────────────┘
```

- **Таблицы**: Чередующиеся строки (hover эффект), компактные
- **Charts**: Встроены в карточки, тёмный фон, яркие цвета линий


#### **D) Компоненты**

- **Кнопки**: Округлые углы (rounded-md), иконка + текст
- **Badges**: Для тарифов (PRO, STANDARD, ULTIMA) — цветные
- **Status indicators**: Точка + текст (● Активен)
- **Dropdown filters**: Над таблицами (Тариф: Все, Статус: Все)
- **Search**: Placeholder с иконкой поиска


#### **E) Иконки и эмодзи**

- **Рестораны**: 🍕, 🍔, 🍜, ☕, 🥩
- **Уровни**: 🥉 Bronze, 🥈 Silver, 🥇 Gold, 👑 Platinum
- **Тарифы**: 🆓 FREE, 📊 STANDARD, 📈 PRO, 🚀 ULTIMA, ⚙️ CUSTOM
- **Действия**: ✅ Вход, ➕ Создание, ✏️ Редактирование, 🗑️ Удаление, 📥 Экспорт

***

## **👥 2. GUESTS PAGE (Guests-Enhanced-V4.html)**

### **✅ Ключевые паттерны:**

#### **A) Stats карточки (верх страницы)**

```
┌──────────────────────┐  ┌──────────────────────┐
│ 2,341               │  │ 1,876               │
│ Всего гостей        │  │ Активных (80%)      │
│ ↑ +123 за месяц     │  │ ↑ +98 за месяц      │
└──────────────────────┘  └──────────────────────┘
```

- 4 карточки в ряд
- Крупная цифра сверху
- Описание под ней
- Изменение с иконкой (↑/↓)


#### **B) Таблица гостей**

- **Columns**: Аватар (инициалы) | Имя | Email | Телефон | ДР (знак зодиака) | Уровень (эмодзи) | Статус | Посещений | Действия
- **Аватары**: Круглые с инициалами (ИИ, МП, ПС)
- **Уровни с эмодзи**: 🥇 Gold, 🥈 Silver, Standard
- **Статусы**: ✓ Активный (зелёный), ⊘ Неактивный (серый)
- **Действия**: Иконки (👁️ Просмотр, ✏️ Редактировать, 🗑️ Удалить)


#### **C) Hover эффекты**

- Строка таблицы подсвечивается при наведении
- Кнопки действий меняют цвет

***

## 🎯 **ФИНАЛЬНАЯ СПЕЦИФИКАЦИЯ UI/UX ДЛЯ MAX LOYALTY**

### **1. ЦВЕТОВАЯ ПАЛИТРА (DARK THEME)**

```css
/* Основные цвета */
--background: #0a0a0a;           /* Основной фон */
--card: #161616;                  /* Карточки */
--card-hover: #1f1f1f;           /* Hover карточек */
--border: #262626;                /* Borders */

/* Текст */
--text-primary: #ffffff;          /* Заголовки */
--text-secondary: #a1a1a1;       /* Описания */
--text-muted: #737373;           /* Плейсхолдеры */

/* Акценты */
--primary: #3b82f6;              /* Кнопки, ссылки */
--primary-hover: #2563eb;        
--success: #10b981;              /* Рост, успех */
--danger: #ef4444;               /* Ошибки, падение */
--warning: #f59e0b;              /* Предупреждения */
--info: #0ea5e9;                 /* Информация */

/* Badges тарифов */
--badge-free: #6b7280;           /* Серый */
--badge-standard: #3b82f6;       /* Синий */
--badge-pro: #10b981;            /* Зелёный */
--badge-ultima: #f59e0b;         /* Оранжевый */
--badge-custom: #8b5cf6;         /* Фиолетовый */
```


### **2. TYPOGRAPHY**

```css
/* Шрифт */
font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;

/* Размеры */
--text-xs: 0.75rem;      /* 12px - мелкие подписи */
--text-sm: 0.875rem;     /* 14px - таблицы, описания */
--text-base: 1rem;       /* 16px - основной текст */
--text-lg: 1.125rem;     /* 18px - подзаголовки */
--text-xl: 1.25rem;      /* 20px - заголовки карточек */
--text-2xl: 1.5rem;      /* 24px - метрики */
--text-3xl: 1.875rem;    /* 30px - большие цифры */
--text-4xl: 2.25rem;     /* 36px - главные метрики */

/* Веса */
--font-normal: 400;
--font-medium: 500;
--font-semibold: 600;
--font-bold: 700;
```


### **3. КОМПОНЕНТЫ**

#### **A) Карточка метрики**

```tsx
<Card className="bg-card border border-border hover:bg-card-hover transition">
  <CardContent className="p-6">
    <p className="text-sm text-secondary mb-2">Всего рестораны</p>
    <p className="text-3xl font-bold text-primary mb-1">24</p>
    <p className="text-xs text-success">↑ 2 за месяц</p>
  </CardContent>
</Card>
```


#### **B) Таблица с эмодзи**

```tsx
<Table>
  <TableHeader>
    <TableRow>
      <TableHead>Название</TableHead>
      <TableHead>Тариф</TableHead>
      <TableHead>Гости</TableHead>
      <TableHead>Статус</TableHead>
    </TableRow>
  </TableHeader>
  <TableBody>
    <TableRow className="hover:bg-card-hover">
      <TableCell>
        <div className="flex items-center gap-2">
          <span className="text-lg">🍕</span>
          <span>Пицца Ночная</span>
        </div>
      </TableCell>
      <TableCell>
        <Badge variant="pro">PRO</Badge>
      </TableCell>
      <TableCell>2,847</TableCell>
      <TableCell>
        <span className="text-success">✓ Активен</span>
      </TableCell>
    </TableRow>
  </TableBody>
</Table>
```


#### **C) Badge компонент**

```tsx
<Badge variant="pro">PRO</Badge>
<Badge variant="gold">🥇 Gold</Badge>
<Badge variant="active">✓ Активен</Badge>
```


### **4. ИКОНКИ И ЭМОДЗИ (СТАНДАРТ)**

```typescript
// Рестораны
const restaurantIcons = {
  pizza: '🍕',
  burger: '🍔',
  noodles: '🍜',
  coffee: '☕',
  steak: '🥩',
  sushi: '🍣',
  default: '🏪'
};

// Уровни лояльности
const levelIcons = {
  bronze: '🥉',
  silver: '🥈',
  gold: '🥇',
  platinum: '👑',
  diamond: '💎'
};

// Тарифы
const planIcons = {
  free: '🆓',
  standard: '📊',
  pro: '📈',
  ultima: '🚀',
  custom: '⚙️'
};

// Статусы
const statusIcons = {
  active: '✓',
  blocked: '✕',
  pending: '⏳',
  inactive: '⊘'
};

// Изменения
const changeIcons = {
  up: '↑',
  down: '↓',
  stable: '→'
};
```


### **5. LAYOUT PATTERNS**

#### **Dashboard**

```tsx
<div className="space-y-6">
  {/* Stats Grid */}
  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <MetricCard />
    <MetricCard />
    <MetricCard />
    <MetricCard />
  </div>
  
  {/* Charts Grid */}
  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <Card><LineChart /></Card>
    <Card><PieChart /></Card>
  </div>
  
  {/* Table */}
  <Card>
    <CardHeader>
      <div className="flex justify-between items-center">
        <h2>Рестораны</h2>
        <div className="flex gap-2">
          <FilterDropdown />
          <Button>+ Добавить</Button>
        </div>
      </div>
    </CardHeader>
    <CardContent>
      <Table />
    </CardContent>
  </Card>
</div>
```


***

## 🚀 **ГОТОВ ДЕТАЛИЗИРОВАТЬ UI/UX!**

Теперь, когда я понял **твой визуальный стиль**, готов детализировать любой блок **в этой эстетике**:

### **Какой блок детализируем?**

1. **Owner Platform Dashboard** (в стиле твоих примеров)
2. **Admin Loyalty Builder** (конструктор правил/уровней/промо)
3. **Guests Management** (расширенная версия твоего Guests-Enhanced)
4. **Restaurant Admin Dashboard** (для управления сетью)
5. **Manager Restaurant View** (один ресторан)
6. **Analytics \& Reports** (графики и таблицы)
7. **Billing \& Invoices** (платежи, счета)
8. **Settings \& Configuration** (настройки системы)

**Скажи номер или своё направление! Задам 25+ детальных вопросов с визуальными примерами в твоём стиле! 🎨**
<span style="display:none">[^5_1][^5_2]</span>

<div align="center">⁂</div>

[^5_1]: Max-Loyalty-Dashboard.html

[^5_2]: Guests-Enhanced-V4.html


---

# Owner Platform Dashboard делаем. Тщательно изучи проект, задай вопросы + с предложением твоего лучшего решения по вопросу с обоснованием

Отлично! Изучил проект **досконально**. Теперь задам **25+ детальных вопросов** для Owner Platform Dashboard с предложениями решений в **твоём визуальном стиле** (темная тема, эмодзи, метрики, графики).

***

# 🏢 **OWNER PLATFORM DASHBOARD - 25+ ВОПРОСОВ С РЕШЕНИЯМИ**

## **📊 1. DASHBOARD LAYOUT \& STRUCTURE**

### **1️⃣ Структура главной страницы Owner Dashboard**

**Контекст:**
Owner видит **всю платформу**: все тенанты (рестораны), MRR/ARR, Churn Rate, платежи, активные подписки. Это НЕ один ресторан, а **платформенная аналитика**.[^6_1]

**Вопрос:**
Какую структуру страницы использовать для Owner Dashboard?

**A)** Single Page - все метрики/графики/таблицы на одной длинной странице с вертикальным скроллом
**B)** Tabs - вкладки: Overview | Tenants | Billing | Analytics | Activity Log
**C)** Cards Grid с Quick Actions - карточки-метрики сверху, таблица тенантов снизу, сайдбар Quick Actions справа
**D)** Dashboard с drill-down модалами - компактные карточки, клик → модал с детальной аналитикой

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: A) Single Page с секциями**

**Обоснование:**

- ✅ Owner хочет видеть **всю картину сразу** (как в твоём примере Max-Loyalty-Dashboard.html)[^6_2]
- ✅ Секции логически разделены (KPIs → Charts → Tenants → Billing → Logs)
- ✅ Scroll естественен для дашбордов с большим объёмом данных
- ✅ Быстрый доступ - не нужно переключаться между табами
- ✅ Drill-down через модалы для детальной информации

**Структура:**

```
┌─────────────────────────────────────────────────────────┐
│ 🏠 Owner Dashboard                    [Search] [Profile] │
├─────────────────────────────────────────────────────────┤
│ SECTION 1: KEY METRICS (4 карточки)                     │
│ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐                    │
│ │ MRR  │ │Churn │ │Active│ │Total │                    │
│ │2.34M₽│ │ 3.2% │ │ 24   │ │12.8K │                    │
│ └──────┘ └──────┘ └──────┘ └──────┘                    │
│                                                          │
│ SECTION 2: REVENUE CHARTS (Grid 2 columns)              │
│ ┌────────────────────┐ ┌────────────────────┐          │
│ │ MRR Trend         │ │ Revenue by Plan    │          │
│ │ (Line Chart)      │ │ (Pie Chart)        │          │
│ └────────────────────┘ └────────────────────┘          │
│                                                          │
│ SECTION 3: TENANTS TABLE                                │
│ ┌────────────────────────────────────────────────────┐ │
│ │ Название | Тариф | Гости | Доход | Статус | ...  │ │
│ │ 🍕 Пицца...                                        │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ SECTION 4: BILLING SUMMARY                              │
│ ┌────────────────────────────────────────────────────┐ │
│ │ Активные подписки | Распределение доходов         │ │
│ └────────────────────────────────────────────────────┘ │
│                                                          │
│ SECTION 5: ACTIVITY LOG                                 │
│ ┌────────────────────────────────────────────────────┐ │
│ │ Время | Пользователь | Действие | Статус          │ │
│ └────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```


***

### **2️⃣ Top KPI Metrics - какие показать?**

**Контекст:**
Owner Dashboard показывает платформенные метрики. Из проекта известны: MRR, ARR, Churn Rate, Active Tenants, Total Guests, Total Transactions.[^6_1]

**Вопрос:**
Какие 4 главные метрики показать в топ-карточках?

**A)** MRR | Active Tenants | Total Guests | Total Transactions
**B)** MRR | Churn Rate | Active Tenants | Revenue Growth
**C)** ARR | New Tenants | Active Guests | Conversion Rate
**D)** MRR | Active Tenants | Total Revenue | Avg Revenue per Tenant

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) MRR | Churn Rate | Active Tenants | Revenue Growth**

**Обоснование:**

- ✅ **MRR (Monthly Recurring Revenue)** - главная метрика SaaS-платформы
- ✅ **Churn Rate** - критичная для понимания здоровья бизнеса (если Churn > 5% → alarm)
- ✅ **Active Tenants** - количество платящих клиентов (прямо влияет на MRR)
- ✅ **Revenue Growth** - тренд роста (% к прошлому месяцу) - мотивирует и показывает динамику

**Визуал (в твоём стиле):**

```
┌──────────────────────┐  ┌──────────────────────┐
│ 💰 Месячный доход    │  │ 📉 Churn Rate        │
│ 2.34M₽               │  │ 3.2%                 │
│ ↑ +12.4% за месяц    │  │ ↓ -0.5% (улучшение)  │
└──────────────────────┘  └──────────────────────┘

┌──────────────────────┐  ┌──────────────────────┐
│ 🏢 Активные тенанты  │  │ 📈 Рост выручки      │
│ 24                   │  │ +18.2%               │
│ ↑ +2 за месяц        │  │ за последние 6 мес   │
└──────────────────────┘  └──────────────────────┘
```

**Цветовая индикация:**

- Рост (↑) → зелёный `#10b981`
- Падение (↓) → красный `#ef4444` (если Churn растёт) или зелёный (если Churn падает)

***

### **3️⃣ Фильтры временного периода**

**Контекст:**
Owner хочет анализировать данные за разные периоды (сегодня, неделя, месяц, год).

**Вопрос:**
Где разместить фильтр периода и какие опции дать?

**A)** Global фильтр в правом верхнем углу (влияет на весь дашборд)
**B)** Отдельный фильтр для каждой карточки/графика
**C)** Tabs с предустановленными периодами (Today | Week | Month | Year)
**D)** Dropdown с Custom Date Range

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: A) Global фильтр + D) Custom Range**

**Обоснование:**

- ✅ **Global фильтр** - Owner хочет видеть данные за один период на всём дашборде (не переключать на каждом графике)
- ✅ **Preset + Custom** - быстрый доступ к популярным периодам + гибкость для детального анализа

**UI (в правом верхнем углу):**

```
┌─────────────────────────────────┐
│ 📅 [Last 30 days ▼]             │
│                                  │
│ Dropdown:                        │
│ • Today                          │
│ • Last 7 days                    │
│ • Last 30 days ✓                 │
│ • Last 3 months                  │
│ • Last 12 months                 │
│ • Year to Date                   │
│ • Custom Range...                │
└─────────────────────────────────┘
```

**Custom Range Modal:**

```
┌─────────────────────────────────┐
│ Выберите период                  │
│                                  │
│ От:  [2026-01-01] 📅            │
│ До:  [2026-02-15] 📅            │
│                                  │
│ [Отмена] [Применить]            │
└─────────────────────────────────┘
```


***

## **📈 2. CHARTS \& VISUALIZATION**

### **4️⃣ MRR Trend Chart - какой тип графика?**

**Контекст:**
Owner хочет видеть динамику MRR по месяцам (как растёт/падает платформа).

**Вопрос:**
Какой тип графика использовать для MRR Trend?

**A)** Line Chart (линия с точками)
**B)** Area Chart (залитая область под линией)
**C)** Bar Chart (столбцы по месяцам)
**D)** Combined: Bar (MRR) + Line (Growth %)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: D) Combined Bar + Line**

**Обоснование:**

- ✅ **Bar Chart для MRR** - абсолютные значения хорошо видны (высота столбца = деньги)
- ✅ **Line Chart для Growth %** - тренд роста/падения в процентах (вторая ось Y)
- ✅ **Визуально богаче** - Owner сразу видит и абсолютные значения, и темпы роста
- ✅ **Соответствует примеру** в твоём дашборде (комбинированные графики)[^6_2]

**Mockup (Recharts):**

```tsx
<Card>
  <CardHeader>
    <CardTitle>💰 Доход по месяцам</CardTitle>
    <CardDescription>MRR и темп роста</CardDescription>
  </CardHeader>
  <CardContent>
    <ResponsiveContainer width="100%" height={300}>
      <ComposedChart data={mrrData}>
        <CartesianGrid strokeDasharray="3 3" stroke="#262626" />
        <XAxis dataKey="month" stroke="#a1a1a1" />
        <YAxis yAxisId="left" stroke="#a1a1a1" />
        <YAxis yAxisId="right" orientation="right" stroke="#10b981" />
        <Tooltip 
          contentStyle={{ 
            backgroundColor: '#161616', 
            border: '1px solid #262626' 
          }} 
        />
        <Legend />
        
        {/* Bar для MRR */}
        <Bar 
          yAxisId="left" 
          dataKey="mrr" 
          fill="#3b82f6" 
          name="MRR (₽)" 
        />
        
        {/* Line для Growth % */}
        <Line 
          yAxisId="right" 
          type="monotone" 
          dataKey="growthPercent" 
          stroke="#10b981" 
          strokeWidth={2}
          name="Рост (%)" 
        />
      </ComposedChart>
    </ResponsiveContainer>
  </CardContent>
</Card>
```

**Data example:**

```typescript
const mrrData = [
  { month: 'Янв', mrr: 1800000, growthPercent: 8.5 },
  { month: 'Фев', mrr: 2100000, growthPercent: 16.7 },
  { month: 'Мар', mrr: 2340000, growthPercent: 11.4 },
  // ...
];
```


***

### **5️⃣ Revenue by Plan Distribution - Pie или Donut?**

**Контекст:**
Owner хочет видеть распределение доходов по тарифам (FREE, STANDARD, PRO, ULTIMA, CUSTOM).[^6_2]

**Вопрос:**
Какой тип графика использовать?

**A)** Pie Chart (классический круг)
**B)** Donut Chart (кольцо с центральной метрикой "Total MRR")
**C)** Bar Chart (горизонтальные столбцы)
**D)** Treemap (прямоугольники, размер = доход)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Donut Chart с Total MRR в центре**

**Обоснование:**

- ✅ **Визуально привлекательнее** чем обычный Pie
- ✅ **Центральная метрика** (Total MRR) сразу видна
- ✅ **Компактен** - занимает меньше места чем Bar Chart
- ✅ **Стандарт для SaaS дашбордов** (Stripe, Baremetrics используют Donut)

**Mockup:**

```tsx
<Card>
  <CardHeader>
    <CardTitle>💰 Распределение доходов</CardTitle>
    <CardDescription>По тарифам</CardDescription>
  </CardHeader>
  <CardContent>
    <ResponsiveContainer width="100%" height={300}>
      <PieChart>
        <Pie
          data={planData}
          cx="50%"
          cy="50%"
          innerRadius={60}   // Donut hole
          outerRadius={100}
          fill="#8884d8"
          dataKey="revenue"
          label={(entry) => `${entry.name}: ${formatCurrency(entry.revenue)}`}
        >
          {planData.map((entry, index) => (
            <Cell key={`cell-${index}`} fill={PLAN_COLORS[entry.plan]} />
          ))}
        </Pie>
        <Tooltip />
      </PieChart>
    </ResponsiveContainer>
    
    {/* Central Total MRR */}
    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
      <div className="text-center">
        <p className="text-2xl font-bold">{formatCurrency(totalMRR)}</p>
        <p className="text-sm text-secondary">Всего MRR</p>
      </div>
    </div>
  </CardContent>
</Card>
```

**Colors (из твоего стиля):**

```typescript
const PLAN_COLORS = {
  FREE: '#6b7280',      // Серый
  STANDARD: '#3b82f6',  // Синий
  PRO: '#10b981',       // Зелёный
  ULTIMA: '#f59e0b',    // Оранжевый
  CUSTOM: '#8b5cf6'     // Фиолетовый
};
```


***

### **6️⃣ Churn Analysis - как визуализировать причины оттока?**

**Контекст:**
Когда тенант отменяет подписку, Owner видит `cancelledReason` (например: "Too expensive", "Not using", "Technical issues").[^6_3]

**Вопрос:**
Как показать анализ причин Churn?

**A)** Horizontal Bar Chart (количество отмен по причинам)
**B)** Pie Chart (% от общего Churn)
**C)** Table со столбцами: Причина | Количество | %
**D)** Word Cloud (размер слова = частота причины)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: A) Horizontal Bar Chart**

**Обоснование:**

- ✅ **Легко читать** - длинные тексты причин помещаются слева
- ✅ **Сравнение очевидно** - длина бара = количество случаев
- ✅ **Sortable** - можно сортировать по убыванию
- ✅ **Actionable** - Owner сразу видит топ-причины и может работать над ними

**Mockup:**

```
┌────────────────────────────────────────────┐
│ 📉 Churn Analysis (Last 30 days)           │
├────────────────────────────────────────────┤
│ Too expensive          ████████████ 12     │
│ Not using features     ████████ 8          │
│ Technical issues       ████ 4              │
│ Found competitor       ███ 3               │
│ Other                  ██ 2                │
└────────────────────────────────────────────┘
```

**Recharts implementation:**

```tsx
<Card>
  <CardHeader>
    <CardTitle>📉 Анализ оттока</CardTitle>
    <CardDescription>За последние 30 дней</CardDescription>
  </CardHeader>
  <CardContent>
    <ResponsiveContainer width="100%" height={300}>
      <BarChart
        data={churnReasons}
        layout="horizontal"
        margin={{ left: 150 }}
      >
        <CartesianGrid strokeDasharray="3 3" stroke="#262626" />
        <XAxis type="number" stroke="#a1a1a1" />
        <YAxis 
          dataKey="reason" 
          type="category" 
          stroke="#a1a1a1" 
          width={140}
        />
        <Tooltip />
        <Bar dataKey="count" fill="#ef4444" />
      </BarChart>
    </ResponsiveContainer>
  </CardContent>
</Card>
```


***

## **🏢 3. TENANTS TABLE**

### **7️⃣ Tenants Table - какие колонки показать?**

**Контекст:**
Owner видит таблицу всех тенантов платформы. Из проекта известны поля: name, plan, guests count, monthly revenue, status, created_at.[^6_2]

**Вопрос:**
Какие колонки включить в таблицу по умолчанию?

**A)** Название | Тариф | Гости | Доход (месяц) | Статус | Дата регистрации
**B)** Название | Тариф | Гости | Доход | Статус | Последний платёж | Действия
**C)** Название | Контакт | Тариф | MRR | ARR | Статус | Действия
**D)** Название | Тариф | Активность | LTV | Churn Risk | Действия

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Название | Тариф | Гости | Доход | Статус | Последний платёж | Действия**

**Обоснование:**

- ✅ **Название с эмодзи** (🍕, 🍔) - визуальная идентификация (как в твоём примере)[^6_2]
- ✅ **Тариф** - Badge с цветом (STANDARD синий, PRO зелёный)
- ✅ **Гости** - показывает активность тенанта
- ✅ **Доход (месяц)** - MRR от этого тенанта
- ✅ **Статус** - ✓ Активен / ✕ Заблокирован / ⏳ Trial
- ✅ **Последний платёж** - когда платил (важно для понимания риска Churn)
- ✅ **Действия** - Dropdown: View Details / Impersonate / Block / Edit

**Таблица (в твоём стиле):**

```
┌──────────────────────────────────────────────────────────────────────────┐
│ Название              Тариф      Гости   Доход (мес)   Статус   Платёж   │
├──────────────────────────────────────────────────────────────────────────┤
│ 🍕 Пицца Ночная      PRO        2,847   185,400₽      ✓ Активен  2 дня   │
│ 🍔 Burger Dream      STANDARD   1,432    98,760₽      ✓ Активен  5 дней  │
│ 🍜 Азиатская Лапша   ULTIMA     5,214   342,680₽      ✓ Активен  1 день   │
│ ☕ Coffee House       STANDARD     892    62,450₽      ✕ Заблок.  30 дней │
│ 🥩 Steakhouse Prime  PRO        3,567   248,910₽      ✓ Активен  3 дня   │
└──────────────────────────────────────────────────────────────────────────┘
```

**Фильтры над таблицей:**

```
[Поиск...]  [Тариф: Все ▼]  [Статус: Все ▼]  [Экспорт CSV]
```


***

### **8️⃣ Status Column - как показать разные статусы?**

**Контекст:**
Tenant может быть в статусах: ACTIVE, TRIAL, PAST_DUE (просрочка оплаты), CANCELLED, BLOCKED.[^6_3]

**Вопрос:**
Как визуализировать статусы в таблице?

**A)** Только иконка (✓, ⏳, ✕, ⊘)
**B)** Иконка + текст (✓ Активен)
**C)** Colored Badge (<Badge variant="success">Активен</Badge>)
**D)** Иконка + текст + цветной фон строки

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Иконка + текст (как в твоём примере)**

**Обоснование:**

- ✅ **Быстрая визуальная индентификация** - иконка видна мгновенно
- ✅ **Понятно для всех** - текст объясняет статус
- ✅ **Компактно** - не занимает много места
- ✅ **Соответствует твоему стилю**[^6_2]

**Статусы:**

```typescript
const STATUS_DISPLAY = {
  ACTIVE: { icon: '✓', text: 'Активен', color: 'text-success' },
  TRIAL: { icon: '⏳', text: 'Trial', color: 'text-info' },
  PAST_DUE: { icon: '⚠️', text: 'Просрочка', color: 'text-warning' },
  CANCELLED: { icon: '✕', text: 'Отменён', color: 'text-danger' },
  BLOCKED: { icon: '⊘', text: 'Заблокирован', color: 'text-danger' }
};
```

**Component:**

```tsx
<span className={STATUS_DISPLAY[tenant.status].color}>
  {STATUS_DISPLAY[tenant.status].icon} {STATUS_DISPLAY[tenant.status].text}
</span>
```


***

### **9️⃣ Actions Dropdown - какие действия доступны Owner?**

**Контекст:**
Owner может: просматривать детали, impersonate (войти под тенантом), блокировать, редактировать тариф, менять пароль.[^6_4][^6_1]

**Вопрос:**
Какие действия включить в Dropdown?

**A)** View Details | Impersonate | Block
**B)** View | Edit Plan | Block | Reset Password
**C)** View | Impersonate | Edit Plan | Block | Activity Log
**D)** View | Impersonate | Edit Plan | Block | Invoices | Support Chat

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) View | Impersonate | Edit Plan | Block | Activity Log**

**Обоснование:**

- ✅ **View Details** - открывает модал или страницу с полной информацией о тенанте
- ✅ **Impersonate** - главная фича Owner'а для troubleshooting[^6_4]
- ✅ **Edit Plan** - быстрое изменение тарифа (upgrade/downgrade)
- ✅ **Block/Unblock** - блокировка при нарушениях
- ✅ **Activity Log** - аудит всех действий тенанта

**Dropdown UI:**

```tsx
<DropdownMenu>
  <DropdownMenuTrigger>
    <Button variant="ghost" size="sm">
      <MoreVertical className="h-4 w-4" />
    </Button>
  </DropdownMenuTrigger>
  <DropdownMenuContent align="end">
    <DropdownMenuItem onClick={() => viewDetails(tenant.id)}>
      <Eye className="mr-2 h-4 w-4" />
      Просмотр деталей
    </DropdownMenuItem>
    
    <DropdownMenuItem onClick={() => impersonate(tenant.id)}>
      <UserCog className="mr-2 h-4 w-4" />
      Войти как Admin
    </DropdownMenuItem>
    
    <DropdownMenuItem onClick={() => editPlan(tenant.id)}>
      <Edit className="mr-2 h-4 w-4" />
      Изменить тариф
    </DropdownMenuItem>
    
    <DropdownMenuSeparator />
    
    <DropdownMenuItem 
      onClick={() => blockTenant(tenant.id)}
      className="text-danger"
    >
      <Ban className="mr-2 h-4 w-4" />
      {tenant.status === 'BLOCKED' ? 'Разблокировать' : 'Заблокировать'}
    </DropdownMenuItem>
    
    <DropdownMenuItem onClick={() => viewActivityLog(tenant.id)}>
      <History className="mr-2 h-4 w-4" />
      Activity Log
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```


***

## **💳 4. BILLING SECTION**

### **🔟 Active Subscriptions Summary - как показать?**

**Контекст:**
Owner видит распределение активных подписок по тарифам: FREE (2), STANDARD (8), PRO (10), ULTIMA (4), CUSTOM (3).[^6_2]

**Вопрос:**
Как визуализировать Active Subscriptions?

**A)** Simple List с числами (FREE: 2, STANDARD: 8, ...)
**B)** Horizontal Bar Chart (количество подписок)
**C)** Pie Chart (% от общего количества)
**D)** Cards Grid (карточка на каждый тариф с иконкой + числом)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: D) Cards Grid с иконками тарифов**

**Обоснование:**

- ✅ **Визуально привлекательно** - каждый тариф = отдельная карточка
- ✅ **Цветовая кодировка** - каждый тариф свой цвет (как в твоём примере)[^6_2]
- ✅ **Кликабельно** - клик на карточку → drill-down с тенантами на этом тарифе
- ✅ **Компактно** - 5 карточек в ряд

**Mockup:**

```
┌───────────────────────────────────────────────────────────┐
│ 👥 Активные подписки                                      │
├───────────────────────────────────────────────────────────┤
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                 │
│ │🆓 2 │ │📊 8 │ │📈10 │ │🚀 4 │ │⚙️ 3 │                 │
│ │FREE │ │STD  │ │PRO  │ │ULT  │ │CUS  │                 │
│ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘                 │
└───────────────────────────────────────────────────────────┘
```

**Component:**

```tsx
<div className="grid grid-cols-5 gap-4">
  {plans.map((plan) => (
    <Card 
      key={plan.name}
      className="cursor-pointer hover:bg-card-hover transition"
      onClick={() => filterByPlan(plan.name)}
    >
      <CardContent className="p-4 text-center">
        <div className="text-3xl mb-2">{plan.icon}</div>
        <div className="text-2xl font-bold">{plan.count}</div>
        <div className="text-sm text-secondary">{plan.name}</div>
      </CardContent>
    </Card>
  ))}
</div>
```


***

Продолжить с оставшимися 15 вопросами? Или хочешь уточнить что-то по первым 10?

**Следующие темы:**

- 11-15: Impersonation UI, Activity Log, Search/Filters
- 16-20: Tenant Details Modal, Billing Management, Alerts
- 21-25: Mobile Responsiveness, Real-time Updates, Export
<span style="display:none">[^6_5][^6_6]</span>

<div align="center">⁂</div>

[^6_1]: Beseda-2.md

[^6_2]: Max-Loyalty-Dashboard.html

[^6_3]: Beseda-11.md

[^6_4]: Beseda-8.md

[^6_5]: Beseda-3.md

[^6_6]: Beseda-10.md


---

# 🏢 **OWNER PLATFORM DASHBOARD - ПРОДОЛЖЕНИЕ (11-25 ВОПРОСОВ)**


***

## **👤 5. IMPERSONATION \& ADMIN ACCESS**

### **1️⃣1️⃣ Impersonation Banner - как показать что Owner вошёл под тенантом?**

**Контекст:**
Owner может impersonate любого Admin'а тенанта для troubleshooting. Это должно быть **очевидно визуально** и логируется.[^7_1][^7_2]

**Вопрос:**
Как показать активную impersonation сессию?

**A)** Red Banner вверху экрана (fixed position)
**B)** Orange Badge рядом с именем пользователя
**C)** Modal при входе: "Вы вошли как Admin ресторана X"
**D)** Floating Button "Exit Impersonation" справа внизу

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: A) Red Banner (fixed top) + D) Floating Exit Button**

**Обоснование:**

- ✅ **Невозможно не заметить** - красный баннер на всю ширину экрана
- ✅ **Постоянно виден** - fixed position, не исчезает при скролле
- ✅ **Показывает контекст** - "Вы вошли как Admin ресторана 🍕 Пицца Ночная"
- ✅ **Быстрый выход** - кнопка "Выйти из режима" всегда доступна
- ✅ **Security** - Owner не забудет что он в чужом аккаунте

**UI:**

```tsx
{isImpersonating && (
  <>
    {/* Fixed Red Banner */}
    <div className="fixed top-0 left-0 right-0 z-50 bg-danger text-white">
      <div className="container mx-auto px-4 py-3 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <AlertTriangle className="h-5 w-5" />
          <div>
            <span className="font-semibold">Режим администратора:</span>
            <span className="ml-2">
              Вы вошли как Admin ресторана 
              <span className="font-bold mx-1">🍕 Пицца Ночная</span>
            </span>
          </div>
        </div>
        
        <Button 
          variant="outline" 
          size="sm"
          onClick={exitImpersonation}
          className="bg-white text-danger hover:bg-gray-100"
        >
          <LogOut className="mr-2 h-4 w-4" />
          Выйти из режима
        </Button>
      </div>
    </div>
    
    {/* Spacer для контента под баннером */}
    <div className="h-[56px]" />
  </>
)}
```

**Floating Exit Button (дополнительно):**

```tsx
{isImpersonating && (
  <Button
    size="lg"
    variant="destructive"
    className="fixed bottom-6 right-6 z-40 shadow-lg"
    onClick={exitImpersonation}
  >
    <LogOut className="mr-2 h-5 w-5" />
    Выйти из режима
  </Button>
)}
```

**Цвета:**

- Banner background: `#dc2626` (red-600)
- Text: `#ffffff` (white)
- Button: white bg, red text

***

### **1️⃣2️⃣ Impersonation Flow - что видит Owner после клика "Impersonate"?**

**Контекст:**
Owner кликает "Войти как Admin" в Dropdown → что происходит дальше?

**Вопрос:**
Какой флоу использовать?

**A)** Instant redirect → Owner сразу попадает в Admin Dashboard этого тенанта
**B)** Confirmation Modal → "Вы уверены? Это действие логируется" → Confirm → Redirect
**C)** Reason Modal → "Укажите причину входа" (required field) → Submit → Redirect
**D)** Toast notification → "Вход выполнен" → Redirect после 2 секунд

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Reason Modal (обязательное поле)**

**Обоснование:**

- ✅ **Compliance** - каждый impersonation логируется с причиной (для аудита)[^7_2]
- ✅ **Security** - предотвращает случайные/злонамеренные входы без цели
- ✅ **Transparency** - Admin может видеть в Activity Log почему Owner входил
- ✅ **Best Practice** - крупные SaaS (Stripe, Shopify) требуют reason

**Modal UI:**

```tsx
<Dialog open={showImpersonateModal} onOpenChange={setShowImpersonateModal}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Вход под администратором</DialogTitle>
      <DialogDescription>
        Вы собираетесь войти как Admin ресторана 
        <span className="font-semibold">🍕 Пицца Ночная</span>.
        Это действие будет записано в Activity Log.
      </DialogDescription>
    </DialogHeader>
    
    <form onSubmit={handleImpersonate}>
      <div className="space-y-4">
        <div>
          <Label htmlFor="reason">Причина входа *</Label>
          <Textarea
            id="reason"
            placeholder="Например: Troubleshooting проблемы с начислением баллов"
            value={reason}
            onChange={(e) => setReason(e.target.value)}
            required
            minLength={10}
            className="mt-2"
          />
          <p className="text-xs text-secondary mt-1">
            Минимум 10 символов
          </p>
        </div>
        
        <Alert variant="warning">
          <AlertTriangle className="h-4 w-4" />
          <AlertDescription>
            Все ваши действия будут видны администратору ресторана
          </AlertDescription>
        </Alert>
      </div>
      
      <DialogFooter className="mt-6">
        <Button 
          type="button" 
          variant="outline" 
          onClick={() => setShowImpersonateModal(false)}
        >
          Отмена
        </Button>
        <Button 
          type="submit" 
          variant="destructive"
          disabled={reason.length < 10 || isLoading}
        >
          {isLoading ? 'Вход...' : 'Войти как Admin'}
        </Button>
      </DialogFooter>
    </form>
  </DialogContent>
</Dialog>
```

**Backend logging:**

```typescript
await prisma.activityLog.create({
  data: {
    actionType: 'IMPERSONATION_START',
    performedBy: ownerId,
    targetUser: adminId,
    tenantId: tenant.id,
    ipAddress: req.ip,
    metadata: {
      reason: reason,
      tenant: { id: tenant.id, name: tenant.name },
      duration: '2h' // TTL token
    }
  }
});
```


***

### **1️⃣3️⃣ Activity Log Table - какие колонки показать?**

**Контекst:**
Owner видит Activity Log всех действий на платформе: impersonation, тариф changes, блокировки, создание тенантов.[^7_3][^7_2]

**Вопрос:**
Какие колонки включить в Activity Log?

**A)** Время | Пользователь | Действие | Статус
**B)** Время | Пользователь | Действие | Объект | IP адрес | Статус
**C)** Время | Тенант | Действие | Детали | Статус
**D)** Время | Пользователь | Тенант | Действие | Причина | IP | Статус

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Время | Пользователь | Действие | Объект | IP адрес | Статус**

**Обоснование:**

- ✅ **Время** - когда произошло (sortable, фильтр по дате)
- ✅ **Пользователь** - кто выполнил (Owner, Admin, Manager)
- ✅ **Действие** - что сделал (✅ Вход, ➕ Создание, ✏️ Редактирование, 🗑️ Удаление)
- ✅ **Объект** - над чем действие (Tenant "Пицца Ночная", Тариф "STANDARD")
- ✅ **IP адрес** - security (откуда было действие)
- ✅ **Статус** - Успешно/Ошибка

**Таблица (в твоём стиле):**

```
┌────────────────────────────────────────────────────────────────────────────┐
│ Время            Пользователь    Действие            Объект         Статус │
├────────────────────────────────────────────────────────────────────────────┤
│ 16.02 11:45     Owner           ✅ Вход в систему   System          Успешно│
│ 15.02 20:12     Manager         ➕ Создал ресторан  🍕 Пицца       Успешно│
│ 15.02 15:30     Owner           ✏️ Изменил тариф    STANDARD        Успешно│
│ 14.02 11:22     Manager         ✏️ Изменил статус   ☕ Coffee      Ошибка │
│ 12.02 09:15     Owner           📥 Экспорт отчета   Analytics_Q4   Успешно│
└────────────────────────────────────────────────────────────────────────────┘
```

**Фильтры:**

```tsx
<div className="flex gap-4 mb-4">
  <Select value={actionFilter} onValueChange={setActionFilter}>
    <SelectTrigger className="w-[200px]">
      <SelectValue placeholder="Тип действия" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="all">Все действия</SelectItem>
      <SelectItem value="LOGIN">Вход в систему</SelectItem>
      <SelectItem value="IMPERSONATION">Impersonation</SelectItem>
      <SelectItem value="CREATE">Создание</SelectItem>
      <SelectItem value="UPDATE">Редактирование</SelectItem>
      <SelectItem value="DELETE">Удаление</SelectItem>
    </SelectContent>
  </Select>
  
  <DateRangePicker
    value={dateRange}
    onChange={setDateRange}
  />
  
  <Input
    placeholder="Поиск по пользователю..."
    value={searchQuery}
    onChange={(e) => setSearchQuery(e.target.value)}
    className="max-w-sm"
  />
</div>
```


***

## **🔍 6. SEARCH \& FILTERS**

### **1️⃣4️⃣ Global Search - что искать на Owner Dashboard?**

**Контекст:**
Owner хочет быстро найти тенанта по названию, email, телефону или Admin'у.

**Вопрос:**
Что должен искать Global Search?

**A)** Только название тенанта
**B)** Название тенанта + email контакта
**C)** Название + email + телефон + имя Admin'а
**D)** Всё вышеперечисленное + Activity Log + Invoices

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Название + email + телефон + имя Admin'а**

**Обоснование:**

- ✅ **Практично** - Owner часто ищет по телефону/email из тикета Support
- ✅ **Быстро** - поиск по основным полям без overload
- ✅ **Fuzzy search** - поддержка опечаток ("picca" найдёт "Пицца Ночная")

**UI (CMDK):**

```tsx
<CommandDialog open={open} onOpenChange={setOpen}>
  <CommandInput 
    placeholder="Поиск тенанта по названию, email, телефону..." 
  />
  <CommandList>
    <CommandEmpty>Ничего не найдено</CommandEmpty>
    
    <CommandGroup heading="Тенанты">
      {tenants.map((tenant) => (
        <CommandItem
          key={tenant.id}
          onSelect={() => viewTenant(tenant.id)}
        >
          <div className="flex items-center gap-3 w-full">
            <span className="text-xl">{tenant.emoji}</span>
            <div className="flex-1">
              <div className="font-medium">{tenant.name}</div>
              <div className="text-sm text-secondary">
                {tenant.email} • {tenant.phone}
              </div>
            </div>
            <Badge variant={PLAN_VARIANTS[tenant.plan]}>
              {tenant.plan}
            </Badge>
          </div>
        </CommandItem>
      ))}
    </CommandGroup>
    
    <CommandGroup heading="Быстрые действия">
      <CommandItem onSelect={() => createTenant()}>
        <Plus className="mr-2 h-4 w-4" />
        Создать нового тенанта
      </CommandItem>
      <CommandItem onSelect={() => viewBilling()}>
        <CreditCard className="mr-2 h-4 w-4" />
        Управление платежами
      </CommandItem>
    </CommandGroup>
  </CommandList>
</CommandDialog>
```

**Keyboard shortcut:**

```tsx
// Открытие по Cmd+K (Mac) или Ctrl+K (Win)
useEffect(() => {
  const down = (e: KeyboardEvent) => {
    if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
      e.preventDefault();
      setOpen((open) => !open);
    }
  };
  document.addEventListener('keydown', down);
  return () => document.removeEventListener('keydown', down);
}, []);
```


***

### **1️⃣5️⃣ Table Filters - как фильтровать тенантов?**

**Контекст:**
Owner хочет фильтровать таблицу по тарифу, статусу, дате регистрации, сумме MRR.

**Вопрос:**
Как организовать фильтры?

**A)** Dropdown фильтры над таблицей (Тариф | Статус | Дата)
**B)** Sidebar с фильтрами слева от таблицы
**C)** Advanced Filters Modal (открывается по кнопке)
**D)** Column Header Filters (клик на заголовок → popup фильтр)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: A) Dropdown фильтры + Quick Filters**

**Обоснование:**

- ✅ **Простота** - Owner сразу видит доступные фильтры
- ✅ **Быстрые пресеты** - кнопки "At Risk", "High Value", "Trial"
- ✅ **Не перегружает UI** - компактно размещается над таблицей
- ✅ **Комбинируемые** - можно выбрать несколько фильтров одновременно

**UI:**

```tsx
<div className="space-y-4">
  {/* Quick Filter Buttons */}
  <div className="flex gap-2">
    <Button
      variant={quickFilter === 'at-risk' ? 'default' : 'outline'}
      size="sm"
      onClick={() => setQuickFilter('at-risk')}
    >
      ⚠️ At Risk (неактивны 30+ дней)
    </Button>
    <Button
      variant={quickFilter === 'high-value' ? 'default' : 'outline'}
      size="sm"
      onClick={() => setQuickFilter('high-value')}
    >
      💎 High Value (MRR > 100K)
    </Button>
    <Button
      variant={quickFilter === 'trial' ? 'default' : 'outline'}
      size="sm"
      onClick={() => setQuickFilter('trial')}
    >
      ⏳ Trial
    </Button>
    <Button
      variant={quickFilter === 'overdue' ? 'default' : 'outline'}
      size="sm"
      onClick={() => setQuickFilter('overdue')}
    >
      📛 Просрочка оплаты
    </Button>
  </div>
  
  {/* Advanced Filters */}
  <div className="flex gap-4 items-center">
    <Input
      placeholder="🔍 Поиск..."
      value={search}
      onChange={(e) => setSearch(e.target.value)}
      className="max-w-xs"
    />
    
    <Select value={planFilter} onValueChange={setPlanFilter}>
      <SelectTrigger className="w-[160px]">
        <SelectValue placeholder="Тариф" />
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="all">Все тарифы</SelectItem>
        <SelectItem value="FREE">🆓 FREE</SelectItem>
        <SelectItem value="STANDARD">📊 STANDARD</SelectItem>
        <SelectItem value="PRO">📈 PRO</SelectItem>
        <SelectItem value="ULTIMA">🚀 ULTIMA</SelectItem>
        <SelectItem value="CUSTOM">⚙️ CUSTOM</SelectItem>
      </SelectContent>
    </Select>
    
    <Select value={statusFilter} onValueChange={setStatusFilter}>
      <SelectTrigger className="w-[160px]">
        <SelectValue placeholder="Статус" />
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="all">Все статусы</SelectItem>
        <SelectItem value="ACTIVE">✓ Активен</SelectItem>
        <SelectItem value="TRIAL">⏳ Trial</SelectItem>
        <SelectItem value="PAST_DUE">⚠️ Просрочка</SelectItem>
        <SelectItem value="BLOCKED">⊘ Заблокирован</SelectItem>
      </SelectContent>
    </Select>
    
    <Popover>
      <PopoverTrigger asChild>
        <Button variant="outline" size="sm">
          <Calendar className="mr-2 h-4 w-4" />
          {dateRange ? formatDateRange(dateRange) : 'Дата регистрации'}
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-auto p-0" align="start">
        <CalendarDateRangePicker
          value={dateRange}
          onChange={setDateRange}
        />
      </PopoverContent>
    </Popover>
    
    {/* Reset Filters */}
    {hasActiveFilters && (
      <Button
        variant="ghost"
        size="sm"
        onClick={resetFilters}
      >
        <X className="mr-2 h-4 w-4" />
        Сбросить
      </Button>
    )}
  </div>
</div>
```

**Backend API:**

```typescript
GET /api/v1/owner/tenants?plan=PRO&status=ACTIVE&search=pizza&from=2026-01-01&to=2026-02-16
```


***

## **📋 7. TENANT DETAILS MODAL**

### **1️⃣6️⃣ Tenant Details Modal - какую информацию показать?**

**Контекст:**
Owner кликает "Просмотр деталей" → открывается модал с полной информацией о тенанте.

**Вопрос:**
Какие секции включить в модал?

**A)** Overview | Billing | Usage Stats | Activity Log
**B)** Basic Info | Subscription | Analytics | Support History
**C)** Overview | Billing | Analytics | Team Members | Activity Log
**D)** All of the above + Loyalty Settings + POS Integrations

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) 5 Tabs (Overview | Billing | Analytics | Team | Logs)**

**Обоснование:**

- ✅ **Overview** - основная инфо (название, контакт, дата регистрации, статус)
- ✅ **Billing** - текущий тариф, история платежей, invoices
- ✅ **Analytics** - MRR от тенанта, количество гостей, активность
- ✅ **Team Members** - список Admin/Manager/Cashier этого тенанта
- ✅ **Activity Log** - история действий (фильтр по этому тенанту)

**Modal UI:**

```tsx
<Dialog open={showDetailsModal} onOpenChange={setShowDetailsModal}>
  <DialogContent className="max-w-4xl max-h-[80vh] overflow-hidden">
    <DialogHeader>
      <DialogTitle className="flex items-center gap-3">
        <span className="text-2xl">{tenant.emoji}</span>
        <div>
          <div className="text-xl">{tenant.name}</div>
          <div className="text-sm text-secondary font-normal">
            ID: {tenant.id}
          </div>
        </div>
        <Badge variant={PLAN_VARIANTS[tenant.plan]} className="ml-auto">
          {tenant.plan}
        </Badge>
      </DialogTitle>
    </DialogHeader>
    
    <Tabs defaultValue="overview" className="flex-1">
      <TabsList className="grid w-full grid-cols-5">
        <TabsTrigger value="overview">Обзор</TabsTrigger>
        <TabsTrigger value="billing">Платежи</TabsTrigger>
        <TabsTrigger value="analytics">Аналитика</TabsTrigger>
        <TabsTrigger value="team">Команда</TabsTrigger>
        <TabsTrigger value="logs">Логи</TabsTrigger>
      </TabsList>
      
      <TabsContent value="overview" className="space-y-4">
        {/* Overview content */}
      </TabsContent>
      
      {/* Other tabs... */}
    </Tabs>
  </DialogContent>
</Dialog>
```


***

### **1️⃣7️⃣ Overview Tab - что показать?**

**Вопрос:**
Какую информацию включить во вкладку "Обзор"?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ:**

```tsx
<TabsContent value="overview" className="space-y-6">
  {/* Basic Info Card */}
  <Card>
    <CardHeader>
      <CardTitle>Основная информация</CardTitle>
    </CardHeader>
    <CardContent>
      <dl className="grid grid-cols-2 gap-4">
        <div>
          <dt className="text-sm text-secondary">Название</dt>
          <dd className="font-medium">{tenant.name}</dd>
        </div>
        <div>
          <dt className="text-sm text-secondary">Slug</dt>
          <dd className="font-mono text-sm">{tenant.slug}</dd>
        </div>
        <div>
          <dt className="text-sm text-secondary">Email</dt>
          <dd>{tenant.contactEmail}</dd>
        </div>
        <div>
          <dt className="text-sm text-secondary">Телефон</dt>
          <dd>{tenant.contactPhone}</dd>
        </div>
        <div>
          <dt className="text-sm text-secondary">Дата регистрации</dt>
          <dd>{formatDate(tenant.createdAt)}</dd>
        </div>
        <div>
          <dt className="text-sm text-secondary">Последний визит</dt>
          <dd>{formatRelative(tenant.lastActivityAt)}</dd>
        </div>
      </dl>
    </CardContent>
  </Card>
  
  {/* Quick Stats Grid */}
  <div className="grid grid-cols-4 gap-4">
    <Card>
      <CardContent className="p-4">
        <div className="text-2xl font-bold">{tenant.restaurantsCount}</div>
        <div className="text-sm text-secondary">Ресторанов</div>
      </CardContent>
    </Card>
    <Card>
      <CardContent className="p-4">
        <div className="text-2xl font-bold">{tenant.guestsCount}</div>
        <div className="text-sm text-secondary">Гостей</div>
      </CardContent>
    </Card>
    <Card>
      <CardContent className="p-4">
        <div className="text-2xl font-bold">{formatCurrency(tenant.mrr)}</div>
        <div className="text-sm text-secondary">MRR</div>
      </CardContent>
    </Card>
    <Card>
      <CardContent className="p-4">
        <div className="text-2xl font-bold">{tenant.transactionsCount}</div>
        <div className="text-sm text-secondary">Операций/мес</div>
      </CardContent>
    </Card>
  </div>
  
  {/* Current Limits Usage */}
  <Card>
    <CardHeader>
      <CardTitle>Использование лимитов</CardTitle>
    </CardHeader>
    <CardContent className="space-y-4">
      <LimitBar
        label="Рестораны"
        current={tenant.restaurantsCount}
        max={tenant.limits.maxRestaurants}
      />
      <LimitBar
        label="Гости"
        current={tenant.guestsCount}
        max={tenant.limits.maxGuests}
      />
      <LimitBar
        label="POS интеграции"
        current={tenant.posIntegrationsCount}
        max={tenant.limits.maxPosIntegrations}
      />
    </CardContent>
  </Card>
  
  {/* Quick Actions */}
  <div className="flex gap-2">
    <Button onClick={() => impersonate(tenant.id)}>
      <UserCog className="mr-2 h-4 w-4" />
      Войти как Admin
    </Button>
    <Button variant="outline" onClick={() => editTenant(tenant.id)}>
      <Edit className="mr-2 h-4 w-4" />
      Редактировать
    </Button>
    <Button variant="outline" onClick={() => viewAnalytics(tenant.id)}>
      <BarChart3 className="mr-2 h-4 w-4" />
      Полная аналитика
    </Button>
  </div>
</TabsContent>
```

**LimitBar Component:**

```tsx
function LimitBar({ label, current, max }: LimitBarProps) {
  const percentage = max ? (current / max) * 100 : 0;
  const isNearLimit = percentage >= 90;
  
  return (
    <div>
      <div className="flex justify-between text-sm mb-2">
        <span>{label}</span>
        <span className={isNearLimit ? 'text-warning' : ''}>
          {current} / {max || '∞'}
        </span>
      </div>
      <Progress 
        value={percentage} 
        className={isNearLimit ? 'bg-warning/20' : ''}
      />
    </div>
  );
}
```


***

## **💳 8. BILLING MANAGEMENT**

### **1️⃣8️⃣ Billing Tab - какую информацию показать?**

**Вопрос:**
Что включить во вкладку "Платежи"?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ:**

```tsx
<TabsContent value="billing" className="space-y-6">
  {/* Current Subscription Card */}
  <Card>
    <CardHeader>
      <CardTitle>Текущая подписка</CardTitle>
    </CardHeader>
    <CardContent>
      <div className="flex items-start justify-between">
        <div className="space-y-2">
          <div className="flex items-center gap-2">
            <Badge variant={PLAN_VARIANTS[subscription.plan]} className="text-lg">
              {subscription.plan}
            </Badge>
            <span className="text-2xl font-bold">
              {formatCurrency(subscription.priceMonthly)}/мес
            </span>
          </div>
          
          <dl className="grid grid-cols-2 gap-x-8 gap-y-2 text-sm">
            <div>
              <dt className="text-secondary">Статус</dt>
              <dd className="font-medium">
                <StatusBadge status={subscription.status} />
              </dd>
            </div>
            <div>
              <dt className="text-secondary">Период</dt>
              <dd>{subscription.billingPeriod === 'YEARLY' ? 'Годовая' : 'Месячная'}</dd>
            </div>
            <div>
              <dt className="text-secondary">Начало периода</dt>
              <dd>{formatDate(subscription.currentPeriodStart)}</dd>
            </div>
            <div>
              <dt className="text-secondary">Конец периода</dt>
              <dd>{formatDate(subscription.currentPeriodEnd)}</dd>
            </div>
            <div>
              <dt className="text-secondary">Автопродление</dt>
              <dd>{subscription.autoRenew ? '✓ Включено' : '✕ Выключено'}</dd>
            </div>
            <div>
              <dt className="text-secondary">Дней до продления</dt>
              <dd>{daysUntilRenewal(subscription.currentPeriodEnd)}</dd>
            </div>
          </dl>
        </div>
        
        <Button variant="outline" onClick={() => changePlan(tenant.id)}>
          <Edit className="mr-2 h-4 w-4" />
          Изменить тариф
        </Button>
      </div>
    </CardContent>
  </Card>
  
  {/* Payment History */}
  <Card>
    <CardHeader>
      <CardTitle>История платежей</CardTitle>
    </CardHeader>
    <CardContent>
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Дата</TableHead>
            <TableHead>Сумма</TableHead>
            <TableHead>Метод</TableHead>
            <TableHead>Статус</TableHead>
            <TableHead>Invoice</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {payments.map((payment) => (
            <TableRow key={payment.id}>
              <TableCell>{formatDate(payment.createdAt)}</TableCell>
              <TableCell className="font-medium">
                {formatCurrency(payment.amount)}
              </TableCell>
              <TableCell>
                <PaymentMethodBadge provider={payment.provider} />
              </TableCell>
              <TableCell>
                <PaymentStatusBadge status={payment.status} />
              </TableCell>
              <TableCell>
                <Button variant="ghost" size="sm" asChild>
                  <a href={`/invoices/${payment.invoiceId}`} target="_blank">
                    <Download className="h-4 w-4" />
                  </a>
                </Button>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </CardContent>
  </Card>
  
  {/* Billing Alerts (if any) */}
  {billingAlerts.length > 0 && (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <AlertTriangle className="h-5 w-5 text-warning" />
          Предупреждения
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-2">
        {billingAlerts.map((alert) => (
          <Alert key={alert.id} variant={alert.severity}>
            <AlertDescription>{alert.message}</AlertDescription>
          </Alert>
        ))}
      </CardContent>
    </Card>
  )}
</TabsContent>
```


***

### **1️⃣9️⃣ Change Plan Modal - как Owner меняет тариф тенанту?**

**Контекст:**
Owner может upgrade/downgrade тариф тенанта, это влияет на лимиты и MRR.[^7_2]

**Вопрос:**
Как организовать UI для смены тарифа?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: Plan Comparison Table + Confirmation**

```tsx
<Dialog open={showChangePlanModal} onOpenChange={setShowChangePlanModal}>
  <DialogContent className="max-w-3xl">
    <DialogHeader>
      <DialogTitle>Изменить тариф для {tenant.name}</DialogTitle>
      <DialogDescription>
        Текущий тариф: <Badge>{currentPlan}</Badge>
      </DialogDescription>
    </DialogHeader>
    
    <div className="space-y-4">
      {/* Plan Selection */}
      <RadioGroup value={selectedPlan} onValueChange={setSelectedPlan}>
        {PLANS.map((plan) => (
          <Card 
            key={plan.name}
            className={cn(
              "cursor-pointer transition",
              selectedPlan === plan.name && "border-primary"
            )}
          >
            <CardContent className="p-4">
              <RadioGroupItem value={plan.name} id={plan.name} className="sr-only" />
              <label htmlFor={plan.name} className="cursor-pointer">
                <div className="flex items-start justify-between">
                  <div className="space-y-2 flex-1">
                    <div className="flex items-center gap-2">
                      <span className="text-xl">{plan.icon}</span>
                      <span className="font-semibold">{plan.name}</span>
                      {plan.name === currentPlan && (
                        <Badge variant="outline" size="sm">Текущий</Badge>
                      )}
                    </div>
                    
                    <div className="grid grid-cols-3 gap-4 text-sm">
                      <div>
                        <span className="text-secondary">Рестораны: </span>
                        <span className="font-medium">{plan.maxRestaurants || '∞'}</span>
                      </div>
                      <div>
                        <span className="text-secondary">Гости: </span>
                        <span className="font-medium">{plan.maxGuests || '∞'}</span>
                      </div>
                      <div>
                        <span className="text-secondary">POS: </span>
                        <span className="font-medium">{plan.maxPOS || '∞'}</span>
                      </div>
                    </div>
                  </div>
                  
                  <div className="text-right">
                    <div className="text-2xl font-bold">
                      {formatCurrency(plan.priceMonthly)}
                    </div>
                    <div className="text-sm text-secondary">/месяц</div>
                  </div>
                </div>
              </label>
            </CardContent>
          </Card>
        ))}
      </RadioGroup>
      
      {/* Impact Summary */}
      {selectedPlan !== currentPlan && (
        <Alert>
          <Info className="h-4 w-4" />
          <AlertDescription>
            <strong>Изменения:</strong>
            <ul className="mt-2 space-y-1 text-sm">
              <li>• MRR изменится на {calculateMRRDiff(currentPlan, selectedPlan)}</li>
              <li>• Новые лимиты вступят в силу немедленно</li>
              <li>• {isUpgrade ? 'Доплата будет пропорциональна оставшимся дням' : 'Возврат средств на следующий период'}</li>
            </ul>
          </AlertDescription>
        </Alert>
      )}
      
      {/* Reason (required) */}
      <div>
        <Label htmlFor="reason">Причина изменения *</Label>
        <Textarea
          id="reason"
          placeholder="Например: Клиент запросил upgrade из-за роста бизнеса"
          value={reason}
          onChange={(e) => setReason(e.target.value)}
          required
        />
      </div>
    </div>
    
    <DialogFooter>
      <Button variant="outline" onClick={() => setShowChangePlanModal(false)}>
        Отмена
      </Button>
      <Button
        onClick={handleChangePlan}
        disabled={!selectedPlan || selectedPlan === currentPlan || !reason}
      >
        Изменить тариф
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```


***

## **⚡ 9. REAL-TIME UPDATES \& NOTIFICATIONS**

### **2️⃣0️⃣ Real-time Updates - как Owner видит изменения live?**

**Контекст:**
Когда тенант создаёт нового гостя, делает платёж, меняет настройки - Owner должен видеть обновления в реальном времени (для мониторинга платформы).

**Вопрос:**
Какую технологию использовать для real-time?

**A)** Polling (каждые 30 секунд fetch новых данных)
**B)** Server-Sent Events (SSE) - server push updates
**C)** WebSockets - bidirectional connection
**D)** Long Polling - держать connection открытым

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Server-Sent Events (SSE)**

**Обоснование:**

- ✅ **Проще чем WebSockets** - unidirectional (server → client), нет необходимости в bidirectional
- ✅ **Automatic reconnection** - браузер автоматически переподключается
- ✅ **HTTP-based** - работает через firewall/proxy без проблем
- ✅ **Event types** - можно слать разные типы событий (new_tenant, payment_received, etc.)
- ✅ **Поддержка в проекте** - уже упоминалось в Беседе 8[^7_1]

**Frontend (EventSource):**

```tsx
// hooks/useOwnerLiveUpdates.ts
export function useOwnerLiveUpdates() {
  const queryClient = useQueryClient();
  
  useEffect(() => {
    const eventSource = new EventSource('/api/v1/owner/live-updates', {
      withCredentials: true
    });
    
    // New tenant registered
    eventSource.addEventListener('new_tenant', (event) => {
      const tenant = JSON.parse(event.data);
      
      toast.success(`Новый тенант: ${tenant.name}`, {
        description: `Тариф: ${tenant.plan}`,
        action: {
          label: 'Просмотр',
          onClick: () => viewTenant(tenant.id)
        }
      });
      
      // Invalidate queries to refetch
      queryClient.invalidateQueries(['tenants']);
      queryClient.invalidateQueries(['metrics']);
    });
    
    // Payment received
    eventSource.addEventListener('payment_received', (event) => {
      const payment = JSON.parse(event.data);
      
      toast.success(`Платёж получен: ${formatCurrency(payment.amount)}`, {
        description: `От: ${payment.tenantName}`
      });
      
      queryClient.invalidateQueries(['payments']);
      queryClient.invalidateQueries(['mrr']);
    });
    
    // Churn alert (tenant cancelled)
    eventSource.addEventListener('tenant_cancelled', (event) => {
      const data = JSON.parse(event.data);
      
      toast.error(`Тенант отменил подписку: ${data.tenantName}`, {
        description: `Причина: ${data.reason}`,
        action: {
          label: 'Связаться',
          onClick: () => contactTenant(data.tenantId)
        }
      });
      
      queryClient.invalidateQueries(['tenants']);
      queryClient.invalidateQueries(['churn']);
    });
    
    // Connection errors
    eventSource.onerror = (error) => {
      console.error('SSE connection error:', error);
      // EventSource will auto-reconnect
    };
    
    return () => {
      eventSource.close();
    };
  }, [queryClient]);
}

// Usage in OwnerDashboard
export default function OwnerDashboard() {
  useOwnerLiveUpdates(); // Setup SSE
  
  return (
    <div>
      {/* Dashboard content */}
    </div>
  );
}
```

**Backend (NestJS SSE):**

```typescript
// owner.controller.ts
@Controller('owner')
export class OwnerController {
  @Sse('live-updates')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles('OWNER')
  liveUpdates(@CurrentUser() user: User): Observable<MessageEvent> {
    return this.ownerService.subscribeToUpdates(user.id);
  }
}

// owner.service.ts
@Injectable()
export class OwnerService {
  private eventSubjects = new Map<string, Subject<MessageEvent>>();
  
  subscribeToUpdates(ownerId: string): Observable<MessageEvent> {
    const subject = new Subject<MessageEvent>();
    this.eventSubjects.set(ownerId, subject);
    
    // Cleanup on disconnect
    return subject.asObservable().pipe(
      finalize(() => {
        this.eventSubjects.delete(ownerId);
      })
    );
  }
  
  // Called when tenant created
  async broadcastNewTenant(tenant: Tenant) {
    const event: MessageEvent = {
      type: 'new_tenant',
      data: JSON.stringify({
        id: tenant.id,
        name: tenant.name,
        plan: tenant.plan,
        createdAt: tenant.createdAt
      })
    };
    
    // Send to all connected owners
    this.eventSubjects.forEach((subject) => {
      subject.next(event);
    });
  }
  
  // Similar for other events...
}
```

**Auto-refresh indicator:**

```tsx
<div className="flex items-center gap-2 text-sm text-secondary">
  <div className="w-2 h-2 bg-success rounded-full animate-pulse" />
  <span>Live updates</span>
</div>
```


***

### **2️⃣1️⃣ Notifications Bell - какие уведомления показать Owner?**

**Контекст:**
Owner получает уведомления о важных событиях платформы (новый тенант, платёж просрочен, лимиты превышены, etc.).

**Вопрос:**
Какие типы уведомлений показать в Bell Dropdown?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ:**

**Типы уведомлений:**

```typescript
enum OwnerNotificationType {
  NEW_TENANT = 'new_tenant',              // 🎉 Новый тенант
  PAYMENT_RECEIVED = 'payment_received',  // 💰 Платёж получен
  PAYMENT_FAILED = 'payment_failed',      // ❌ Платёж не прошёл
  TENANT_CANCELLED = 'tenant_cancelled',  // 📉 Отмена подписки
  LIMIT_EXCEEDED = 'limit_exceeded',      // ⚠️ Лимит превышен
  HIGH_CHURN_ALERT = 'high_churn_alert',  // 📛 Высокий Churn
  SYSTEM_ERROR = 'system_error'           // 🔥 Системная ошибка
}
```

**UI (Bell Dropdown):**

```tsx
<Popover>
  <PopoverTrigger asChild>
    <Button variant="ghost" size="icon" className="relative">
      <Bell className="h-5 w-5" />
      {unreadCount > 0 && (
        <span className="absolute -top-1 -right-1 bg-danger text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
          {unreadCount}
        </span>
      )}
    </Button>
  </PopoverTrigger>
  
  <PopoverContent className="w-[400px] p-0" align="end">
    <div className="flex items-center justify-between p-4 border-b">
      <h3 className="font-semibold">Уведомления</h3>
      {unreadCount > 0 && (
        <Button 
          variant="ghost" 
          size="sm"
          onClick={markAllAsRead}
        >
          Отметить все
        </Button>
      )}
    </div>
    
    <ScrollArea className="h-[400px]">
      {notifications.length === 0 ? (
        <div className="p-8 text-center text-secondary">
          <Bell className="h-12 w-12 mx-auto mb-2 opacity-50" />
          <p>Нет новых уведомлений</p>
        </div>
      ) : (
        <div className="divide-y">
          {notifications.map((notification) => (
            <div
              key={notification.id}
              className={cn(
                "p-4 hover:bg-card-hover transition cursor-pointer",
                !notification.readAt && "bg-primary/5"
              )}
              onClick={() => handleNotificationClick(notification)}
            >
              <div className="flex gap-3">
                <div className="flex-shrink-0">
                  {NOTIFICATION_ICONS[notification.type]}
                </div>
                <div className="flex-1 space-y-1">
                  <p className="text-sm font-medium">
                    {notification.title}
                  </p>
                  <p className="text-sm text-secondary">
                    {notification.message}
                  </p>
                  <p className="text-xs text-secondary">
                    {formatRelative(notification.createdAt)}
                  </p>
                </div>
                {!notification.readAt && (
                  <div className="flex-shrink-0">
                    <div className="w-2 h-2 bg-primary rounded-full" />
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      )}
    </ScrollArea>
    
    <div className="p-2 border-t">
      <Button variant="ghost" size="sm" className="w-full" asChild>
        <Link href="/owner/notifications">
          Посмотреть все
        </Link>
      </Button>
    </div>
  </PopoverContent>
</Popover>
```


***

## **📱 10. MOBILE RESPONSIVENESS**

### **2️⃣2️⃣ Mobile View - как адаптировать Owner Dashboard для мобильных?**

**Контекст:**
Owner может заходить с телефона для быстрой проверки метрик.

**Вопрос:**
Как адаптировать dashboard для mobile?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ:**

**Breakpoint strategy:**

```typescript
// Mobile: < 768px
// Tablet: 768px - 1024px  
// Desktop: > 1024px
```

**Mobile Layout (< 768px):**

```tsx
<div className="pb-20"> {/* Space for bottom nav */}
  {/* KPI Metrics - 2 columns */}
  <div className="grid grid-cols-2 gap-3 p-4">
    <MetricCard {...} />
    <MetricCard {...} />
    <MetricCard {...} />
    <MetricCard {...} />
  </div>
  
  {/* Charts - Full width, stacked */}
  <div className="space-y-4 p-4">
    <Card>
      <CardHeader>
        <CardTitle className="text-base">MRR Trend</CardTitle>
      </CardHeader>
      <CardContent>
        <ResponsiveContainer width="100%" height={200}>
          {/* Simplified chart with fewer labels */}
        </ResponsiveContainer>
      </CardContent>
    </Card>
  </div>
  
  {/* Tenants Table → Cards */}
  <div className="space-y-3 p-4">
    <h2 className="text-lg font-semibold">Тенанты</h2>
    {tenants.map((tenant) => (
      <TenantMobileCard key={tenant.id} tenant={tenant} />
    ))}
  </div>
</div>
```

**TenantMobileCard:**

```tsx
<Card 
  className="cursor-pointer"
  onClick={() => viewTenant(tenant.id)}
>
  <CardContent className="p-4">
    <div className="flex items-start justify-between mb-3">
      <div className="flex items-center gap-2">
        <span className="text-2xl">{tenant.emoji}</span>
        <div>
          <div className="font-medium">{tenant.name}</div>
          <div className="text-sm text-secondary">{tenant.contactEmail}</div>
        </div>
      </div>
      <Badge variant={PLAN_VARIANTS[tenant.plan]}>
        {tenant.plan}
      </Badge>
    </div>
    
    <div className="grid grid-cols-2 gap-3 text-sm">
      <div>
        <div className="text-secondary">Гости</div>
        <div className="font-medium">{tenant.guestsCount}</div>
      </div>
      <div>
        <div className="text-secondary">MRR</div>
        <div className="font-medium">{formatCurrency(tenant.mrr)}</div>
      </div>
    </div>
    
    <div className="mt-3 flex items-center justify-between">
      <span className={STATUS_DISPLAY[tenant.status].color}>
        {STATUS_DISPLAY[tenant.status].icon} {STATUS_DISPLAY[tenant.status].text}
      </span>
      <ChevronRight className="h-4 w-4 text-secondary" />
    </div>
  </CardContent>
</Card>
```


***

## **📤 11. EXPORT \& REPORTING**

### **2️⃣3️⃣ Export Dashboard Data - в каких форматах?**

**Контекст:**
Owner хочет экспортировать данные для анализа в Excel/отчётности.

**Вопрос:**
Какие форматы export поддержать?

**A)** CSV only
**B)** CSV + XLSX (Excel)
**C)** CSV + XLSX + PDF
**D)** CSV + XLSX + PDF + JSON

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) CSV + XLSX + PDF**

**Обоснование:**

- ✅ **CSV** - универсальный, открывается везде, лёгкий
- ✅ **XLSX** - форматирование, формулы, графики (для презентаций)
- ✅ **PDF** - для печати/отправки клиентам, immutable

**Export Button:**

```tsx
<DropdownMenu>
  <DropdownMenuTrigger asChild>
    <Button variant="outline">
      <Download className="mr-2 h-4 w-4" />
      Экспорт
    </Button>
  </DropdownMenuTrigger>
  <DropdownMenuContent align="end">
    <DropdownMenuLabel>Формат экспорта</DropdownMenuLabel>
    <DropdownMenuSeparator />
    
    <DropdownMenuItem onClick={() => exportData('csv')}>
      <FileText className="mr-2 h-4 w-4" />
      CSV (таблица)
    </DropdownMenuItem>
    
    <DropdownMenuItem onClick={() => exportData('xlsx')}>
      <FileSpreadsheet className="mr-2 h-4 w-4" />
      XLSX (Excel)
    </DropdownMenuItem>
    
    <DropdownMenuItem onClick={() => exportData('pdf')}>
      <FileDown className="mr-2 h-4 w-4" />
      PDF (отчёт)
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

**Backend:**

```typescript
@Get('export')
@Roles('OWNER')
async exportDashboard(
  @Query('format') format: 'csv' | 'xlsx' | 'pdf',
  @Query('from') from: string,
  @Query('to') to: string,
  @Res() res: Response
) {
  const data = await this.ownerService.getDashboardData(from, to);
  
  switch (format) {
    case 'csv':
      const csv = this.csvService.generate(data);
      res.setHeader('Content-Type', 'text/csv');
      res.setHeader('Content-Disposition', `attachment; filename=dashboard-${Date.now()}.csv`);
      return res.send(csv);
      
    case 'xlsx':
      const xlsx = await this.excelService.generate(data);
      res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
      res.setHeader('Content-Disposition', `attachment; filename=dashboard-${Date.now()}.xlsx`);
      return res.send(xlsx);
      
    case 'pdf':
      const pdf = await this.pdfService.generateReport(data);
      res.setHeader('Content-Type', 'application/pdf');
      res.setHeader('Content-Disposition', `attachment; filename=dashboard-${Date.now()}.pdf`);
      return res.send(pdf);
  }
}
```


***

### **2️⃣4️⃣ Scheduled Reports - автоматическая отправка отчётов?**

**Контекст:**
Owner хочет получать еженедельный/месячный отчёт на email автоматически.

**Вопрос:**
Поддержать ли scheduled reports?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: ДА, с настройками в Owner Settings**

**Settings UI:**

```tsx
<Card>
  <CardHeader>
    <CardTitle>Автоматические отчёты</CardTitle>
    <CardDescription>
      Получайте сводку по платформе на email
    </CardDescription>
  </CardHeader>
  <CardContent className="space-y-4">
    <div className="flex items-center justify-between">
      <div>
        <div className="font-medium">Еженедельный отчёт</div>
        <div className="text-sm text-secondary">
          Каждый понедельник в 09:00 MSK
        </div>
      </div>
      <Switch
        checked={settings.weeklyReport}
        onCheckedChange={(checked) => updateSettings({ weeklyReport: checked })}
      />
    </div>
    
    <div className="flex items-center justify-between">
      <div>
        <div className="font-medium">Месячный отчёт</div>
        <div className="text-sm text-secondary">
          1-го числа каждого месяца в 09:00 MSK
        </div>
      </div>
      <Switch
        checked={settings.monthlyReport}
        onCheckedChange={(checked) => updateSettings({ monthlyReport: checked })}
      />
    </div>
    
    <Separator />
    
    <div>
      <Label>Email для отчётов</Label>
      <Input
        type="email"
        value={settings.reportEmail}
        onChange={(e) => updateSettings({ reportEmail: e.target.value })}
        placeholder="owner@example.com"
      />
    </div>
    
    <div>
      <Label>Формат отчёта</Label>
      <Select 
        value={settings.reportFormat} 
        onValueChange={(value) => updateSettings({ reportFormat: value })}
      >
        <SelectTrigger>
          <SelectValue />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="pdf">PDF (удобно для печати)</SelectItem>
          <SelectItem value="xlsx">XLSX (для анализа в Excel)</SelectItem>
        </SelectContent>
      </Select>
    </div>
  </CardContent>
</Card>
```

**CRON Job (Backend):**

```typescript
@Injectable()
export class ReportsService {
  @Cron('0 9 * * MON') // Every Monday at 9 AM
  async sendWeeklyReports() {
    const owners = await this.prisma.user.findMany({
      where: { 
        role: 'OWNER',
        settings: { path: ['weeklyReport'], equals: true }
      }
    });
    
    for (const owner of owners) {
      const data = await this.getDashboardData(
        subDays(new Date(), 7),
        new Date()
      );
      
      const report = await this.generateReport(data, 'weekly');
      
      await this.emailProvider.send({
        to: owner.email,
        subject: `📊 Еженедельный отчёт Max Loyalty`,
        template: 'weekly-report',
        attachments: [{
          filename: `weekly-report-${format(new Date(), 'yyyy-MM-dd')}.pdf`,
          content: report
        }]
      });
    }
  }
}
```


***

## **🎯 12. ALERTS \& MONITORING**

### **2️⃣5️⃣ Critical Alerts - какие алерты показать Owner?**

**Контекст:**
Owner должен быть уведомлён о критических событиях (высокий Churn, платёж failed, система недоступна).

**Вопрос:**
Какие алерты считать критичными и как их показать?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ:**

**Critical Alerts:**

```typescript
enum CriticalAlert {
  HIGH_CHURN = 'high_churn',             // Churn > 5% за месяц
  PAYMENT_FAILURES = 'payment_failures', // >10 неуспешных платежей за день
  SYSTEM_DOWN = 'system_down',           // API недоступен >5 минут
  DATABASE_SLOW = 'database_slow',       // Query time >1s
  DISK_SPACE = 'disk_space',             // Свободно <10%
  SECURITY_BREACH = 'security_breach'    // Подозрительная активность
}
```

**Alert Banner (Fixed Top):**

```tsx
{criticalAlerts.length > 0 && (
  <div className="fixed top-0 left-0 right-0 z-50 bg-danger text-white">
    <div className="container mx-auto px-4 py-3">
      <div className="flex items-center gap-3">
        <AlertTriangle className="h-5 w-5 animate-pulse" />
        <div className="flex-1">
          <div className="font-semibold">
            Критическое предупреждение
          </div>
          <div className="text-sm">
            {criticalAlerts[^7_0].message}
          </div>
        </div>
        <Button
          size="sm"
          variant="outline"
          className="bg-white text-danger"
          onClick={() => viewAlertDetails(criticalAlerts[^7_0])}
        >
          Подробнее
        </Button>
        <Button
          size="sm"
          variant="ghost"
          onClick={dismissAlert}
        >
          <X className="h-4 w-4" />
        </Button>
      </div>
    </div>
  </div>
)}
```

**Alerts Section on Dashboard:**

```tsx
{alerts.length > 0 && (
  <Card className="border-warning">
    <CardHeader>
      <CardTitle className="flex items-center gap-2">
        <AlertTriangle className="h-5 w-5 text-warning" />
        Требуют внимания ({alerts.length})
      </CardTitle>
    </CardHeader>
    <CardContent className="space-y-2">
      {alerts.map((alert) => (
        <Alert key={alert.id} variant={alert.severity}>
          <AlertDescription className="flex items-start justify-between">
            <div className="flex-1">
              <div className="font-medium">{alert.title}</div>
              <div className="text-sm mt-1">{alert.message}</div>
            </div>
            <Button
              size="sm"
              variant="ghost"
              onClick={() => resolveAlert(alert.id)}
            >
              Решить
            </Button>
          </AlertDescription>
        </Alert>
      ))}
    </CardContent>
  </Card>
)}
```


***

# 🎉 **ИТОГО: 25 ВОПРОСОВ РЕШЕНЫ!**

## **Финальная структура Owner Dashboard:**

```
┌─────────────────────────────────────────────────────────┐
│ [Impersonation Banner - если активен]                   │
├─────────────────────────────────────────────────────────┤
│ Top Bar: Logo | Search (Cmd+K) | Notifications | Profile│
├─────────────────────────────────────────────────────────┤
│ [Critical Alerts Banner - если есть]                    │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 1. KEY METRICS (4 карточки)                             │
│    💰 MRR | 📉 Churn | 🏢 Tenants | 📈 Growth          │
│                                                          │
│ 2. REVENUE CHARTS (2 columns)                           │
│    ├─ MRR Trend (Bar+Line)                              │
│    └─ Revenue by Plan (Donut)                           │
│                                                          │
│ 3. ALERTS (if any)                                      │
│    ⚠️ High Churn / Payment Failures / etc.             │
│                                                          │
│ 4. TENANTS TABLE                                        │
│    [Filters] [Quick Filters] [Export]                   │
│    │ Name | Plan | Guests | MRR | Status | Actions │   │
│                                                          │
│ 5. BILLING SUMMARY                                      │
│    Active Subscriptions (Cards Grid)                    │
│                                                          │
│ 6. ACTIVITY LOG                                         │
│    Recent actions across platform                       │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

**Технологии:**

- Next.js 14 + shadcn/ui (темная тема)
- TanStack Query (data fetching)
- TanStack Table (tenants table)
- Recharts (charts)
- Server-Sent Events (real-time)
- date-fns (dates)

**Готово к реализации!** 🚀

<div align="center">⁂</div>

[^7_1]: Beseda-8.md

[^7_2]: Beseda-11.md

[^7_3]: Max-Loyalty-Dashboard.html


---

# 📋 **OWNER PLATFORM DASHBOARD - ФИНАЛЬНЫЕ РЕШЕНИЯ ПО 25 ВОПРОСАМ**


***

## **📊 1. DASHBOARD LAYOUT \& STRUCTURE**

### **Вопрос 1: Структура главной страницы Owner Dashboard**

**Принятое решение:** Single Page с секциями (вертикальный скролл)

**Обоснование:**

- Owner видит всю картину платформы сразу без переключения между табами
- Секции логически разделены: KPIs → Charts → Tenants → Billing → Logs
- Соответствует примеру Max-Loyalty-Dashboard.html из твоих файлов
- Scroll естественен для дашбордов с большим объёмом данных
- Drill-down через модалы для детальной информации

**Структура:**

```
1. KEY METRICS (4 карточки в ряд)
2. REVENUE CHARTS (Grid 2 columns)
3. ALERTS (если есть критические предупреждения)
4. TENANTS TABLE (с фильтрами и поиском)
5. BILLING SUMMARY (Active Subscriptions)
6. ACTIVITY LOG (последние действия)
```


***

### **Вопрос 2: Top KPI Metrics - какие показать?**

**Принятое решение:** MRR | Churn Rate | Active Tenants | Revenue Growth

**Обоснование:**

- **MRR (Monthly Recurring Revenue)** - главная метрика SaaS-платформы, показывает ежемесячный доход
- **Churn Rate** - критичная для здоровья бизнеса (если Churn > 5% → alarm)
- **Active Tenants** - количество платящих клиентов (прямо влияет на MRR)
- **Revenue Growth** - тренд роста в % к прошлому месяцу, показывает динамику развития

**Визуал:**

```
┌──────────────────────┐  ┌──────────────────────┐
│ 💰 Месячный доход    │  │ 📉 Churn Rate        │
│ 2.34M₽               │  │ 3.2%                 │
│ ↑ +12.4% за месяц    │  │ ↓ -0.5% (улучшение)  │
└──────────────────────┘  └──────────────────────┘

┌──────────────────────┐  ┌──────────────────────┐
│ 🏢 Активные тенанты  │  │ 📈 Рост выручки      │
│ 24                   │  │ +18.2%               │
│ ↑ +2 за месяц        │  │ за последние 6 мес   │
└──────────────────────┘  └──────────────────────┘
```


***

### **Вопрос 3: Фильтры временного периода**

**Принятое решение:** Global фильтр (правый верхний угол) + Custom Date Range

**Обоснование:**

- Global фильтр применяется ко всему дашборду одновременно
- Preset периоды для быстрого доступа (Today, Last 7/30 days, Last 3/12 months, YTD)
- Custom Range для детального анализа произвольного периода
- Не нужно переключать фильтр на каждом графике отдельно

**UI компонент:**

```tsx
📅 [Last 30 days ▼]
   ├─ Today
   ├─ Last 7 days
   ├─ Last 30 days ✓
   ├─ Last 3 months
   ├─ Last 12 months
   ├─ Year to Date
   └─ Custom Range... → Modal с date picker
```


***

## **📈 2. CHARTS \& VISUALIZATION**

### **Вопрос 4: MRR Trend Chart - какой тип графика?**

**Принятое решение:** Combined Chart (Bar для MRR + Line для Growth %)

**Обоснование:**

- Bar Chart показывает абсолютные значения MRR (высота столбца = деньги)
- Line Chart на второй оси Y показывает темп роста в процентах
- Owner сразу видит и абсолютные цифры, и динамику изменений
- Визуально богаче чем простой Line или Bar
- Соответствует best practices SaaS дашбордов

**Технология:** Recharts ComposedChart с двумя Y-осями

***

### **Вопрос 5: Revenue by Plan Distribution - Pie или Donut?**

**Принятое решение:** Donut Chart с Total MRR в центре

**Обоснование:**

- Donut визуально привлекательнее чем обычный Pie
- Центральная метрика (Total MRR) видна сразу без лишних элементов
- Компактен - занимает меньше места чем Bar Chart
- Стандарт для SaaS дашбордов (Stripe, Baremetrics используют Donut)
- Каждый тариф своим цветом: FREE (серый), STANDARD (синий), PRO (зелёный), ULTIMA (оранжевый), CUSTOM (фиолетовый)

***

### **Вопрос 6: Churn Analysis - как визуализировать причины оттока?**

**Принятое решение:** Horizontal Bar Chart (количество отмен по причинам)

**Обоснование:**

- Легко читать - длинные тексты причин помещаются слева
- Сравнение очевидно - длина бара показывает количество случаев
- Sortable по убыванию - топ-причины сразу видны
- Actionable - Owner понимает над чем работать (например, "Too expensive" → пересмотреть тарифы)

**Пример:**

```
Too expensive          ████████████ 12
Not using features     ████████ 8
Technical issues       ████ 4
Found competitor       ███ 3
Other                  ██ 2
```


***

## **🏢 3. TENANTS TABLE**

### **Вопрос 7: Tenants Table - какие колонки показать?**

**Принятое решение:** Название | Тариф | Гости | Доход (мес) | Статус | Последний платёж | Действия

**Обоснование:**

- **Название с эмодзи** (🍕, 🍔) - визуальная идентификация как в твоём примере
- **Тариф** - Badge с цветом плана
- **Гости** - показывает активность тенанта (бизнес растёт или стагнирует)
- **Доход (месяц)** - MRR от этого конкретного тенанта
- **Статус** - ✓ Активен / ✕ Заблокирован / ⏳ Trial / ⚠️ Просрочка
- **Последний платёж** - "2 дня назад" - важно для понимания риска Churn
- **Действия** - Dropdown: View Details / Impersonate / Edit Plan / Block / Activity Log

***

### **Вопрос 8: Status Column - как показать разные статусы?**

**Принятое решение:** Иконка + текст (например: ✓ Активен)

**Обоснование:**

- Быстрая визуальная идентификация - иконка видна мгновенно
- Понятно для всех пользователей - текст объясняет статус
- Компактно - не занимает много места в таблице
- Соответствует твоему стилю (как в Guests-Enhanced-V4.html)

**Статусы:**

```typescript
ACTIVE:    ✓ Активен      (зелёный)
TRIAL:     ⏳ Trial        (синий)
PAST_DUE:  ⚠️ Просрочка   (оранжевый)
CANCELLED: ✕ Отменён      (красный)
BLOCKED:   ⊘ Заблокирован (красный)
```


***

### **Вопрос 9: Actions Dropdown - какие действия доступны Owner?**

**Принятое решение:** View Details | Impersonate | Edit Plan | Block | Activity Log

**Обоснование:**

- **View Details** - открывает модал с полной информацией о тенанте (5 табов)
- **Impersonate** - главная фича Owner'а для troubleshooting (требует причину)
- **Edit Plan** - быстрое изменение тарифа (upgrade/downgrade)
- **Block/Unblock** - блокировка при нарушениях или возврат доступа
- **Activity Log** - аудит всех действий конкретного тенанта

***

## **💳 4. BILLING SECTION**

### **Вопрос 10: Active Subscriptions Summary - как показать?**

**Принятое решение:** Cards Grid (карточка на каждый тариф с иконкой + числом)

**Обоснование:**

- Визуально привлекательно - каждый тариф отдельная карточка
- Цветовая кодировка - каждый план свой цвет (как в твоём примере)
- Кликабельно - клик на карточку → фильтрация таблицы тенантов по этому тарифу
- Компактно - 5 карточек в ряд, понятно с первого взгляда

**Пример:**

```
┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐
│🆓 2 │ │📊 8 │ │📈10 │ │🚀 4 │ │⚙️ 3 │
│FREE │ │STD  │ │PRO  │ │ULT  │ │CUS  │
└─────┘ └─────┘ └─────┘ └─────┘ └─────┘
```


***

## **👤 5. IMPERSONATION \& ADMIN ACCESS**

### **Вопрос 11: Impersonation Banner - как показать что Owner вошёл под тенантом?**

**Принятое решение:** Red Banner (fixed top) + Floating Exit Button

**Обоснование:**

- Невозможно не заметить - красный баннер на всю ширину экрана
- Постоянно виден - fixed position, не исчезает при скролле
- Показывает контекст - "Вы вошли как Admin ресторана 🍕 Пицца Ночная"
- Быстрый выход - кнопка "Выйти из режима" всегда доступна
- Security - Owner не забудет что он в чужом аккаунте

**Цвета:** Background `#dc2626` (red-600), Text белый, Exit button белый фон + красный текст

***

### **Вопрос 12: Impersonation Flow - что видит Owner после клика "Impersonate"?**

**Принятое решение:** Reason Modal (обязательное поле с минимум 10 символов) → Redirect

**Обоснование:**

- **Compliance** - каждый impersonation логируется с причиной для аудита
- **Security** - предотвращает случайные/злонамеренные входы без цели
- **Transparency** - Admin может видеть в Activity Log почему Owner входил
- **Best Practice** - крупные SaaS платформы (Stripe, Shopify) требуют reason

**Процесс:**

1. Owner кликает "Войти как Admin" в Dropdown
2. Открывается Modal с полем "Причина входа" (required, min 10 chars)
3. Warning: "Все ваши действия будут видны администратору ресторана"
4. Подтверждение → Backend создаёт impersonation token (TTL 2h) + лог в ActivityLog
5. Redirect в Admin Dashboard тенанта + красный баннер

***

### **Вопрос 13: Activity Log Table - какие колонки показать?**

**Принятое решение:** Время | Пользователь | Действие | Объект | IP адрес | Статус

**Обоснование:**

- **Время** - когда произошло (sortable, с фильтром по дате)
- **Пользователь** - кто выполнил (Owner, Admin, Manager)
- **Действие** - что сделал (✅ Вход, ➕ Создание, ✏️ Редактирование, 🗑️ Удаление, 📥 Экспорт)
- **Объект** - над чем действие (Tenant "Пицца Ночная", Тариф "STANDARD → PRO")
- **IP адрес** - security (откуда было действие, детектирование подозрительной активности)
- **Статус** - Успешно (зелёный) / Ошибка (красный)

**Фильтры:** Тип действия | Дата (range) | Поиск по пользователю

***

## **🔍 6. SEARCH \& FILTERS**

### **Вопрос 14: Global Search - что искать на Owner Dashboard?**

**Принятое решение:** Название тенанта + email контакта + телефон + имя Admin'а

**Обоснование:**

- Практично - Owner часто ищет по телефону/email из тикета Support
- Быстро - поиск по основным полям без overload
- Fuzzy search - поддержка опечаток ("picca" найдёт "Пицца Ночная")
- CMDK интерфейс - открывается по Cmd+K (Mac) или Ctrl+K (Win)

**UI компонент:** Command Palette (shadcn/ui) с группами: Тенанты | Быстрые действия

***

### **Вопрос 15: Table Filters - как фильтровать тенантов?**

**Принятое решение:** Dropdown фильтры над таблицей + Quick Filter Buttons

**Обоснование:**

- Простота - Owner сразу видит доступные фильтры
- Быстрые пресеты - кнопки "At Risk" (неактивны 30+ дней), "High Value" (MRR > 100K), "Trial", "Просрочка оплаты"
- Не перегружает UI - компактно размещается над таблицей
- Комбинируемые - можно выбрать несколько фильтров одновременно

**Фильтры:**

- Quick Buttons: At Risk | High Value | Trial | Overdue
- Advanced: Поиск | Тариф (dropdown) | Статус (dropdown) | Дата регистрации (date range)
- Reset Filters кнопка (показывается если есть активные фильтры)

***

## **📋 7. TENANT DETAILS MODAL**

### **Вопрос 16: Tenant Details Modal - какую информацию показать?**

**Принятое решение:** 5 Tabs (Overview | Billing | Analytics | Team | Activity Log)

**Обоснование:**

- **Overview** - основная инфо (название, контакт, дата регистрации, статус, quick stats, лимиты)
- **Billing** - текущий тариф, история платежей, invoices, billing alerts
- **Analytics** - MRR от тенанта, количество гостей, активность, графики
- **Team Members** - список Admin/Manager/Cashier этого тенанта с ролями
- **Activity Log** - история действий (фильтр по этому тенанту)

**Размер модала:** max-w-4xl (широкий) + max-h-[80vh] (вертикальный скролл внутри)

***

### **Вопрос 17: Overview Tab - что показать?**

**Принятое решение:** Основная информация (Card) + Quick Stats (Grid 4 карточки) + Использование лимитов (Progress bars) + Quick Actions (кнопки)

**Обоснование:**

- Basic Info Card - название, slug, email, телефон, дата регистрации, последний визит
- Quick Stats - количество ресторанов, гостей, MRR, операций/мес (крупные цифры)
- Лимиты - Progress bar для каждого лимита (Рестораны 2/5, Гости 1,234/10,000, POS интеграции 1/3)
- Warning если лимит превышен 90% (оранжевый цвет)
- Quick Actions - кнопки: Impersonate | Редактировать | Полная аналитика

***

## **💳 8. BILLING MANAGEMENT**

### **Вопрос 18: Billing Tab - какую информацию показать?**

**Принятое решение:** Current Subscription (Card) + Payment History (Table) + Billing Alerts (если есть)

**Обоснование:**

- **Current Subscription** - Badge с тарифом, цена/мес, статус, период, дата начала/конца, автопродление, дней до продления, кнопка "Изменить тариф"
- **Payment History** - таблица: Дата | Сумма | Метод (Stripe/YooKassa) | Статус | Invoice (download)
- **Billing Alerts** - предупреждения (просрочка оплаты, карта истекает, лимиты превышены)

***

### **Вопрос 19: Change Plan Modal - как Owner меняет тариф тенанту?**

**Принятое решение:** Plan Comparison Table (RadioGroup) + Impact Summary + Reason field → Confirmation

**Обоснование:**

- RadioGroup с карточками - каждый тариф отдельная карточка (иконка, название, лимиты, цена)
- Current plan помечен Badge "Текущий"
- Impact Summary - показывает изменения MRR, новые лимиты, пропорциональная доплата/возврат
- Reason field (required) - причина изменения для аудита
- Безопасность - нельзя подтвердить без причины

**Процесс:**

1. Owner выбирает новый план из списка
2. Видит Impact Summary (delta MRR, лимиты, billing changes)
3. Указывает причину изменения (минимум 10 символов)
4. Подтверждает → Backend обновляет подписку + логирует в ActivityLog

***

## **⚡ 9. REAL-TIME UPDATES \& NOTIFICATIONS**

### **Вопрос 20: Real-time Updates - как Owner видит изменения live?**

**Принятое решение:** Server-Sent Events (SSE) - server push updates

**Обоснование:**

- **Проще чем WebSockets** - unidirectional (server → client), нет необходимости в bidirectional
- **Automatic reconnection** - браузер автоматически переподключается при обрыве
- **HTTP-based** - работает через firewall/proxy без проблем
- **Event types** - можно слать разные типы (new_tenant, payment_received, tenant_cancelled)
- **Уже упоминалось в проекте** - есть поддержка в Беседе 8

**События:**

- `new_tenant` - новый тенант зарегистрировался → Toast notification + invalidate queries
- `payment_received` - платёж получен → Toast + update MRR
- `tenant_cancelled` - отмена подписки → Alert toast с причиной + возможность связаться
- `limit_exceeded` - тенант превысил лимиты → Alert

**UI индикатор:** "🟢 Live updates" в углу дашборда (пульсирующая точка)

***

### **Вопрос 21: Notifications Bell - какие уведомления показать Owner?**

**Принятое решение:** 7 типов уведомлений в Bell Dropdown

**Типы:**

1. **🎉 NEW_TENANT** - Новый тенант зарегистрировался
2. **💰 PAYMENT_RECEIVED** - Платёж успешно получен
3. **❌ PAYMENT_FAILED** - Платёж не прошёл (карта отклонена)
4. **📉 TENANT_CANCELLED** - Тенант отменил подписку (с причиной)
5. **⚠️ LIMIT_EXCEEDED** - Тенант превысил лимиты тарифа
6. **📛 HIGH_CHURN_ALERT** - Churn Rate превысил 5% за месяц
7. **🔥 SYSTEM_ERROR** - Критическая системная ошибка

**UI:**

- Bell icon с badge (количество непрочитанных)
- Dropdown 400px ширина, 400px высота (scroll)
- Каждое уведомление кликабельно → открывает детали
- Непрочитанные помечены синей точкой
- Кнопка "Отметить все прочитанными"
- Footer: "Посмотреть все" → страница /owner/notifications

***

## **📱 10. MOBILE RESPONSIVENESS**

### **Вопрос 22: Mobile View - как адаптировать Owner Dashboard для мобильных?**

**Принятое решение:** Responsive Layout с breakpoints (Mobile < 768px | Tablet 768-1024px | Desktop > 1024px)

**Mobile Layout (< 768px):**

- **KPI Metrics** - 2 колонки (вместо 4)
- **Charts** - полная ширина, стекируются вертикально, упрощённые (меньше labels)
- **Tenants Table** - трансформируется в Mobile Cards (каждый тенант = карточка)
- **Фильтры** - Sheet (боковая панель) вместо inline
- **Bottom Navigation** - fixed tab bar (Dashboard | Tenants | Billing | Settings)

**TenantMobileCard:**

- Эмодзи + название + email
- Badge с тарифом
- Grid 2x2: Гости | MRR
- Статус + ChevronRight
- Tap → открывает Details Modal

***

## **📤 11. EXPORT \& REPORTING**

### **Вопрос 23: Export Dashboard Data - в каких форматах?**

**Принятое решение:** CSV + XLSX + PDF

**Обоснование:**

- **CSV** - универсальный, открывается везде, лёгкий для импорта в другие системы
- **XLSX** - форматирование, формулы, графики (для презентаций и детального анализа)
- **PDF** - для печати/отправки клиентам, immutable документ

**UI:** Dropdown кнопка "Экспорт" с 3 опциями (иконки: FileText, FileSpreadsheet, FileDown)

**Backend:** endpoint GET /api/v1/owner/export?format=csv\&from=2026-01-01\&to=2026-02-16

***

### **Вопрос 24: Scheduled Reports - автоматическая отправка отчётов?**

**Принятое решение:** ДА, с настройками в Owner Settings

**Обоснование:**

- Еженедельный отчёт - каждый понедельник в 09:00 MSK
- Месячный отчёт - 1-го числа каждого месяца в 09:00 MSK
- Email для отчётов (configurable)
- Формат отчёта - PDF (печать) или XLSX (анализ)
- Enable/Disable переключатели для каждого типа

**Backend:** CRON Job (NestJS @Cron decorator) генерирует отчёт + отправляет через Email Provider (Resend/SendGrid)

***

## **🎯 12. ALERTS \& MONITORING**

### **Вопрос 25: Critical Alerts - какие алерты показать Owner?**

**Принятое решение:** 6 типов критических алертов

**Critical Alerts:**

1. **HIGH_CHURN** - Churn > 5% за месяц (требует немедленного внимания)
2. **PAYMENT_FAILURES** - >10 неуспешных платежей за день (проблемы с payment gateway)
3. **SYSTEM_DOWN** - API недоступен >5 минут (инфраструктура)
4. **DATABASE_SLOW** - Query time >1s (оптимизация БД)
5. **DISK_SPACE** - Свободно <10% (расширить storage)
6. **SECURITY_BREACH** - Подозрительная активность (логи, IP)

**UI:**

- **Fixed Top Banner** - красный фон, пульсирующая иконка, сообщение, кнопки "Подробнее" и "Закрыть"
- **Alerts Section на Dashboard** - карточка с border-warning, список всех активных алертов
- Каждый алерт кликабельный → открывает детали и возможные действия
- Кнопка "Решить" - помечает алерт как resolved

***

# ✅ **ИТОГО: 25 РЕШЕНИЙ ПРИНЯТЫ**

**Структура Owner Platform Dashboard определена:**

- Single Page Layout с 6 секциями
- Real-time updates через SSE
- Impersonation с audit trail
- Mobile responsive
- Export в 3 форматах
- Scheduled reports
- Critical alerts monitoring

**Технологии:**

- Next.js 14 + TypeScript
- shadcn/ui (темная тема)
- TanStack Query + TanStack Table
- Recharts (charts)
- Server-Sent Events (real-time)
- date-fns (локализация дат)

***

# 🚀 **ГОТОВ К СЛЕДУЮЩЕМУ БЛОКУ!**

**Что детализируем дальше?**

**Возможные варианты:**

1. **Admin Dashboard (RestaurantAdmin)** - управление рестораном, гостями, loyalty
2. **Manager Dashboard** - операционная панель для менеджеров
3. **Loyalty Builder** - конструктор правил, уровней, промо-акций
4. **Analytics \& Reporting** - детальная аналитика для всех ролей
5. **POS Integration Setup** - настройка интеграций с iiko, R-Keeper
6. **Guest App (Telegram Mini App)** - интерфейс для гостей
7. **Billing \& Subscriptions** - управление подписками, платежами, invoices

**Какой блок детализируем следующим?** 🎯

---

# 🍕 **ADMIN DASHBOARD (RESTAURANTADMIN) - 25+ ВОПРОСОВ С РЕШЕНИЯМИ**


***

## **📊 1. DASHBOARD LAYOUT \& STRUCTURE**

### **1️⃣ Структура Admin Dashboard - чем отличается от Owner?**

**Контекст:**
Admin управляет **одним рестораном** (или несколькими в рамках одного тенанта). Он видит гостей, loyalty систему, транзакции, analytics своего ресторана, но НЕ видит другие тенанты платформы.[^9_1][^9_2]

**Вопрос:**
Какую структуру использовать для Admin Dashboard?

**A)** Single Page как у Owner (все секции на одной странице)
**B)** Tabs (Overview | Guests | Loyalty | Analytics | Settings)
**C)** Sidebar Navigation + Content Area (как в твоём примере)
**D)** Dashboard Home + отдельные страницы для каждой секции

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: D) Dashboard Home + отдельные страницы**

**Обоснование:**

- ✅ **Scalability** - у Admin много разделов (Guests, Loyalty, Analytics, Team, Settings)
- ✅ **Performance** - не загружаем всё сразу, lazy loading по роутам
- ✅ **UX** - Admin работает с конкретными задачами (сегодня гости, завтра loyalty), не нужна вся инфа сразу
- ✅ **Соответствует примерам** - твой Max-Loyalty-Dashboard.html показывает sidebar навигацию[^9_3]
- ✅ **SEO/Deep linking** - можно шарить прямые ссылки на страницы

**Структура роутов:**

```
/admin/dashboard          → Overview (главная страница)
/admin/guests             → Guests Management
/admin/loyalty            → Loyalty Builder
/admin/analytics          → Analytics & Reports
/admin/pos                → POS Integration
/admin/team               → Team Management
/admin/settings           → Restaurant Settings
/admin/activity-log       → Activity Log
```

**Layout:**

```
┌────────────────────────────────────────────────────┐
│ Sidebar (240px)  │  Content Area                   │
│                  │                                  │
│ 🏠 Dashboard     │  ┌──────────────────────────┐  │
│ 👥 Guests        │  │                          │  │
│ 🎁 Loyalty       │  │   Page Content           │  │
│ 📊 Analytics     │  │                          │  │
│ 🔗 POS           │  └──────────────────────────┘  │
│ 👨‍💼 Team          │                                  │
│ ⚙️ Settings      │                                  │
│ 📝 Activity Log  │                                  │
│                  │                                  │
│ [Profile]        │                                  │
└────────────────────────────────────────────────────┘
```


***

### **2️⃣ Dashboard Home - какие метрики показать Admin?**

**Контекст:**
Admin заходит на главную страницу `/admin/dashboard` и хочет видеть **здоровье своего ресторана**: сколько гостей, активность, выручка, loyalty ROI.[^9_1]

**Вопрос:**
Какие KPI метрики показать на Admin Dashboard Home?

**A)** Всего гостей | Активных | Новых за месяц | Средний чек
**B)** Гости | Баланс баллов | Транзакций/день | Конверсия loyalty
**C)** Гости | Визиты/неделя | Выручка | Баллов начислено/списано
**D)** Всего гостей | Активных (30 дней) | Баллов начислено | Loyalty ROI

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: D) Всего гостей | Активных | Баллов начислено | Loyalty ROI**

**Обоснование:**

- ✅ **Всего гостей** - базовая метрика роста базы (2,847)
- ✅ **Активные гости** - кто был за последние 30 дней (показывает реальную активность)
- ✅ **Баллов начислено** - показывает вовлечённость loyalty программы (45,680 за месяц)
- ✅ **Loyalty ROI** - ключевая метрика: сколько выручки приносит 1 потраченный балл (например: 1:8 → 1₽ баллов = 8₽ выручки)

**Визуал (в твоём стиле):**

```
┌──────────────────────┐  ┌──────────────────────┐
│ 👥 Всего гостей      │  │ ✅ Активных (30д)    │
│ 2,847                │  │ 1,876 (66%)          │
│ ↑ +123 за месяц      │  │ ↑ +98 за месяц       │
└──────────────────────┘  └──────────────────────┘

┌──────────────────────┐  ┌──────────────────────┐
│ 🎁 Баллов начислено  │  │ 📈 Loyalty ROI       │
│ 45,680               │  │ 1:8.4                │
│ ↑ +5,420 за месяц    │  │ ↑ +0.3 (улучшение)   │
└──────────────────────┘  └──────────────────────┘
```

**Дополнительные метрики (вторая строка):**

```
┌──────────────────────┐  ┌──────────────────────┐
│ 💰 Выручка (мес)     │  │ 🎯 Средний чек       │
│ 2,845,600₽           │  │ 3,240₽               │
│ ↑ +12.8% за месяц    │  │ ↑ +180₽ за месяц     │
└──────────────────────┘  └──────────────────────┘

┌──────────────────────┐  ┌──────────────────────┐
│ 📊 Визитов (мес)     │  │ ⭐ NPS Score         │
│ 5,647                │  │ 72 (Excellent)       │
│ ↑ +342 за месяц      │  │ ↑ +5 за месяц        │
└──────────────────────┘  └──────────────────────┘
```


***

### **3️⃣ Dashboard Charts - какие графики показать?**

**Контекст:**
Admin хочет видеть **тренды** своего ресторана: рост гостей, активность, выручка, распределение по уровням loyalty.

**Вопрос:**
Какие 3-4 графика показать на Dashboard Home?

**A)** Guests Growth | Revenue Trend | Loyalty Levels Distribution
**B)** New Guests per Week | Active vs Inactive | Average Check Trend
**C)** Guests Growth | Revenue + Balls Trend | Loyalty Levels | Top Guests
**D)** Revenue | Visits | Balls Earned/Redeemed | Churn Rate

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Guests Growth | Revenue + Balls | Loyalty Levels | Top Guests**

**Обоснование:**

**График 1: Guests Growth (Line Chart, 6 месяцев)**

- Показывает рост базы гостей (новые + существующие)
- Line chart с точками, зелёная линия
- Данные: Total Guests по месяцам

**График 2: Revenue + Balls Earned (Combined Chart, 30 дней)**

- Bar chart для Revenue (выручка по дням)
- Line chart для Balls Earned (начислено баллов)
- Показывает корреляцию: больше выручка → больше баллов → лучше loyalty

**График 3: Loyalty Levels Distribution (Donut Chart)**

- Распределение гостей по уровням: 🥉 Bronze, 🥈 Silver, 🥇 Gold, 👑 Platinum
- Donut с центральной метрикой "Всего гостей"
- Клик на сегмент → фильтрация таблицы гостей

**График 4: Top 10 Guests (Leaderboard Card)**

- Топ-10 гостей по Lifetime Spent
- Список с аватарами (инициалы), именем, уровнем, суммой
- Показывает VIP клиентов ресторана

**Layout:**

```
┌──────────────────────┐  ┌──────────────────────┐
│ Guests Growth        │  │ Revenue + Balls      │
│ (Line Chart)         │  │ (Bar + Line)         │
└──────────────────────┘  └──────────────────────┘

┌──────────────────────┐  ┌──────────────────────┐
│ Loyalty Levels       │  │ Top 10 Guests        │
│ (Donut Chart)        │  │ (Leaderboard)        │
└──────────────────────┘  └──────────────────────┘
```


***

### **4️⃣ Quick Actions Panel - что Admin делает чаще всего?**

**Контекст:**
Admin выполняет повторяющиеся задачи: добавить гостя, начислить/списать баллы, экспортировать список, создать промо-акцию.

**Вопрос:**
Какие Quick Actions показать на Dashboard?

**A)** Добавить гостя | Начислить баллы | Экспорт списка
**B)** Добавить гостя | Ручная корректировка | Создать промо | Экспорт
**C)** Добавить гостя | Добавить баллы | Создать правило | Настройки
**D)** Добавить гостя | Bulk операции | Экспорт | Аналитика

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Добавить гостя | Ручная корректировка | Создать промо | Экспорт**

**Обоснование:**

- ✅ **➕ Добавить гостя** - самое частое действие (регистрация на кассе/вручную)
- ✅ **✏️ Ручная корректировка баллов** - Admin часто нужно начислить/списать баллы (компенсация, промо, ошибка)
- ✅ **🎁 Создать промо-акцию** - быстрый запуск акции (день рождения, выходные, новый товар)
- ✅ **📥 Экспорт гостей** - выгрузка базы для email-рассылок, анализа

**UI (Cards в ряд):**

```tsx
<div className="grid grid-cols-4 gap-4">
  <Card 
    className="cursor-pointer hover:bg-card-hover transition"
    onClick={openAddGuestModal}
  >
    <CardContent className="p-6 text-center">
      <UserPlus className="h-8 w-8 mx-auto mb-2 text-primary" />
      <div className="font-semibold">Добавить гостя</div>
      <div className="text-xs text-secondary mt-1">
        Регистрация вручную
      </div>
    </CardContent>
  </Card>
  
  <Card 
    className="cursor-pointer hover:bg-card-hover transition"
    onClick={openAdjustBallsModal}
  >
    <CardContent className="p-6 text-center">
      <Edit className="h-8 w-8 mx-auto mb-2 text-success" />
      <div className="font-semibold">Корректировка</div>
      <div className="text-xs text-secondary mt-1">
        Начислить/списать баллы
      </div>
    </CardContent>
  </Card>
  
  <Card 
    className="cursor-pointer hover:bg-card-hover transition"
    onClick={openCreatePromoModal}
  >
    <CardContent className="p-6 text-center">
      <Gift className="h-8 w-8 mx-auto mb-2 text-warning" />
      <div className="font-semibold">Создать промо</div>
      <div className="text-xs text-secondary mt-1">
        Акция или бонус
      </div>
    </CardContent>
  </Card>
  
  <Card 
    className="cursor-pointer hover:bg-card-hover transition"
    onClick={openExportModal}
  >
    <CardContent className="p-6 text-center">
      <Download className="h-8 w-8 mx-auto mb-2 text-info" />
      <div className="font-semibold">Экспорт</div>
      <div className="text-xs text-secondary mt-1">
        CSV, XLSX, PDF
      </div>
    </CardContent>
  </Card>
</div>
```


***

## **👥 2. GUESTS MANAGEMENT PAGE**

### **5️⃣ Guests Table - какие колонки показать Admin?**

**Контекст:**
Admin видит таблицу всех гостей своего ресторана. Из твоего примера Guests-Enhanced-V4.html известны: Аватар, Имя, Email, Телефон, ДР, Уровень, Статус, Посещений, Действия.[^9_4]

**Вопрос:**
Какие колонки включить по умолчанию?

**A)** Имя | Телефон | Email | Уровень | Баланс | Посещений | Статус | Действия
**B)** Аватар+Имя | Телефон | Уровень | Баланс | Lifetime Spent | Посещений | Действия
**C)** Имя | Телефон | ДР | Уровень | Баланс | Посещений | Последний визит | Действия
**D)** Аватар+Имя | Телефон | Email | ДР | Уровень | Баланс | Статус | Действия

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Имя | Телефон | ДР | Уровень | Баланс | Посещений | Последний визит | Действия**

**Обоснование:**

- ✅ **Имя с аватаром** (инициалы) - визуальная идентификация как в твоём примере[^9_4]
- ✅ **Телефон** - основной идентификатор (по нему ищут на кассе)
- ✅ **День рождения** - важно для промо-акций "День рождения" + знак зодиака
- ✅ **Уровень** - 🥉 Bronze, 🥈 Silver, 🥇 Gold с эмодзи
- ✅ **Баланс** - сколько баллов у гостя (Regular + Promo)
- ✅ **Посещений** - показывает лояльность (47 визитов = постоянный клиент)
- ✅ **Последний визит** - "2 дня назад" - показывает активность
- ✅ **Действия** - Dropdown: Просмотр | Редактировать | Корректировка | История | Удалить

**Таблица (в твоём стиле):**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ Имя              Телефон          ДР         Уровень  Баланс  Посещ.  Послед.  │
├─────────────────────────────────────────────────────────────────────────────────┤
│ ИИ Иван Иванов  +7 999 123-45-67 15.05 ♉  🥇 Gold   2,850   47      2 дня     │
│ МП Мария П.     +7 888 777-66-55 23.11 ♐  🥈 Silver 1,200   12      1 неделя  │
│ ПС Пётр Сидоров +7 777 555-44-33 08.03 ♓  🥉 Bronze   340   5       3 дня     │
│ АН Анна Н.      +7 666 444-33-22 30.07 ♌  Standard    120   2       2 недели  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

**Optional Columns (можно включить через настройки таблицы):**

- Email
- Lifetime Spent (сумма всех покупок)
- Средний чек
- Дата регистрации
- Источник (POS, Telegram, Web)
- Дети (если есть)
- Теги

***

### **6️⃣ Guest Search - как искать гостей?**

**Контекст:**
Admin на кассе говорит: "Найди гостя Иван Иванов" или "Телефон +7 999 123-45-67" или "Карта 000123".

**Вопрос:**
Что должен искать поиск?

**A)** Только имя
**B)** Имя + телефон
**C)** Имя + телефон + email + карта (QR/6-digit)
**D)** Всё выше + день рождения + теги

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Имя + телефон + email + карта (QR/6-digit)**

**Обоснование:**

- ✅ **Имя** - "Иван Иванов", "Иван", "Иванов" (fuzzy search)
- ✅ **Телефон** - "+7 999 123-45-67", "9991234567", "999 123" (partial match)
- ✅ **Email** - "ivan@example.com", "ivan" (partial)
- ✅ **Карта** - "000123" (6-digit code), "QR-123456" (QR code)
- ✅ **Быстрый результат** - поиск по индексам БД (phone, email, cardCode)

**UI (в хедере страницы):**

```tsx
<div className="relative w-full max-w-md">
  <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-secondary" />
  <Input
    placeholder="Поиск по имени, телефону, email, карте..."
    value={searchQuery}
    onChange={(e) => setSearchQuery(e.target.value)}
    className="pl-10"
  />
  {searchQuery && (
    <Button
      variant="ghost"
      size="sm"
      className="absolute right-2 top-1/2 -translate-y-1/2"
      onClick={() => setSearchQuery('')}
    >
      <X className="h-4 w-4" />
    </Button>
  )}
</div>
```

**Backend:**

```typescript
// Prisma query
where: {
  OR: [
    { firstName: { contains: searchQuery, mode: 'insensitive' } },
    { lastName: { contains: searchQuery, mode: 'insensitive' } },
    { phone: { contains: searchQuery } },
    { email: { contains: searchQuery, mode: 'insensitive' } },
    { guestCard: { displayCode: { contains: searchQuery } } },
    { guestCard: { qrCode: { contains: searchQuery } } }
  ]
}
```


***

### **7️⃣ Guest Filters - как фильтровать гостей?**

**Контекст:**
Admin хочет найти: "Всех Gold гостей", "Неактивных 30+ дней", "С днём рождения в этом месяце", "Баланс > 1000".

**Вопрос:**
Какие фильтры предоставить?

**A)** Уровень | Статус | Дата регистрации
**B)** Уровень | Статус | Баланс (min-max) | Последний визит
**C)** Уровень | Статус | Баланс | Посещений (min-max) | Дата регистрации | Последний визит
**D)** Всё выше + День рождения (месяц) + Lifetime Spent + Теги

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: D) Комплексные фильтры + Quick Filter Buttons**

**Quick Filter Buttons (над таблицей):**

```tsx
<div className="flex gap-2 mb-4">
  <Button
    variant={quickFilter === 'vip' ? 'default' : 'outline'}
    size="sm"
    onClick={() => setQuickFilter('vip')}
  >
    💎 VIP (Lifetime > 100K)
  </Button>
  <Button
    variant={quickFilter === 'at-risk' ? 'default' : 'outline'}
    size="sm"
    onClick={() => setQuickFilter('at-risk')}
  >
    ⚠️ At Risk (неактивны 30+ дней)
  </Button>
  <Button
    variant={quickFilter === 'birthday-month' ? 'default' : 'outline'}
    size="sm"
    onClick={() => setQuickFilter('birthday-month')}
  >
    🎂 ДР в этом месяце
  </Button>
  <Button
    variant={quickFilter === 'new' ? 'default' : 'outline'}
    size="sm"
    onClick={() => setQuickFilter('new')}
  >
    ✨ Новые (30 дней)
  </Button>
  <Button
    variant={quickFilter === 'high-balance' ? 'default' : 'outline'}
    size="sm"
    onClick={() => setQuickFilter('high-balance')}
  >
    💰 Баланс > 1,000
  </Button>
</div>
```

**Advanced Filters (Dropdown/Popover):**

```tsx
<Popover>
  <PopoverTrigger asChild>
    <Button variant="outline" size="sm">
      <Filter className="mr-2 h-4 w-4" />
      Фильтры {activeFiltersCount > 0 && `(${activeFiltersCount})`}
    </Button>
  </PopoverTrigger>
  <PopoverContent className="w-[400px]" align="start">
    <div className="space-y-4">
      {/* Level Filter */}
      <div>
        <Label>Уровень</Label>
        <MultiSelect
          options={loyaltyLevels}
          value={filters.levelIds}
          onChange={(value) => setFilters({ ...filters, levelIds: value })}
          placeholder="Выберите уровни"
        />
      </div>
      
      {/* Status Filter */}
      <div>
        <Label>Статус</Label>
        <Select value={filters.status} onValueChange={(value) => setFilters({ ...filters, status: value })}>
          <SelectTrigger>
            <SelectValue placeholder="Все статусы" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">Все</SelectItem>
            <SelectItem value="ACTIVE">✓ Активный</SelectItem>
            <SelectItem value="INACTIVE">⊘ Неактивный</SelectItem>
            <SelectItem value="BLOCKED">✕ Заблокирован</SelectItem>
          </SelectContent>
        </Select>
      </div>
      
      {/* Balance Range */}
      <div>
        <Label>Баланс баллов</Label>
        <div className="grid grid-cols-2 gap-2">
          <Input
            type="number"
            placeholder="От"
            value={filters.balanceMin ?? ''}
            onChange={(e) => setFilters({ ...filters, balanceMin: Number(e.target.value) })}
          />
          <Input
            type="number"
            placeholder="До"
            value={filters.balanceMax ?? ''}
            onChange={(e) => setFilters({ ...filters, balanceMax: Number(e.target.value) })}
          />
        </div>
      </div>
      
      {/* Visits Range */}
      <div>
        <Label>Количество посещений</Label>
        <div className="grid grid-cols-2 gap-2">
          <Input
            type="number"
            placeholder="От"
            value={filters.visitsMin ?? ''}
            onChange={(e) => setFilters({ ...filters, visitsMin: Number(e.target.value) })}
          />
          <Input
            type="number"
            placeholder="До"
            value={filters.visitsMax ?? ''}
            onChange={(e) => setFilters({ ...filters, visitsMax: Number(e.target.value) })}
          />
        </div>
      </div>
      
      {/* Birthday Month */}
      <div>
        <Label>Месяц рождения</Label>
        <Select value={filters.birthMonth} onValueChange={(value) => setFilters({ ...filters, birthMonth: value })}>
          <SelectTrigger>
            <SelectValue placeholder="Любой месяц" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">Любой месяц</SelectItem>
            {MONTHS_RU.map((month, idx) => (
              <SelectItem key={idx} value={String(idx + 1)}>
                {month}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
      
      {/* Last Visit */}
      <div>
        <Label>Последний визит</Label>
        <Select value={filters.lastVisit} onValueChange={(value) => setFilters({ ...filters, lastVisit: value })}>
          <SelectTrigger>
            <SelectValue placeholder="Любое время" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">Любое время</SelectItem>
            <SelectItem value="7d">За последние 7 дней</SelectItem>
            <SelectItem value="30d">За последние 30 дней</SelectItem>
            <SelectItem value="90d">За последние 90 дней</SelectItem>
            <SelectItem value="180d">За последние 180 дней</SelectItem>
          </SelectContent>
        </Select>
      </div>
      
      <Separator />
      
      <div className="flex justify-between">
        <Button variant="outline" size="sm" onClick={resetFilters}>
          Сбросить
        </Button>
        <Button size="sm" onClick={applyFilters}>
          Применить
        </Button>
      </div>
    </div>
  </PopoverContent>
</Popover>
```


***

### **8️⃣ Bulk Actions - что Admin может делать с выбранными гостями?**

**Контекст:**
Admin выбирает 10 гостей (checkboxes в таблице) и хочет выполнить массовое действие.

**Вопрос:**
Какие Bulk Actions предоставить?

**A)** Экспорт | Удалить
**B)** Экспорт | Добавить баллы | Удалить
**C)** Экспорт | Добавить баллы | Отправить уведомление | Применить тег | Удалить
**D)** Экспорт | Добавить/Удалить баллы | Уведомление | Тег | Изменить уровень | Блокировать

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Экспорт | Добавить баллы | Отправить уведомление | Применить тег | Удалить**

**Обоснование:**

- ✅ **📥 Экспорт выбранных** - CSV/XLSX для email-рассылок
- ✅ **🎁 Добавить баллы** - массовое начисление (например, "500 баллов всем Gold гостям")
- ✅ **📧 Отправить уведомление** - push через Telegram/Email (например, "Акция выходного дня")
- ✅ **🏷️ Применить тег** - сегментация ("VIP", "Inactive", "Birthdays")
- ✅ **🗑️ Удалить** - массовое удаление (с подтверждением)

**UI (появляется при выборе гостей):**

```tsx
{selectedGuests.length > 0 && (
  <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50">
    <Card className="shadow-lg border-primary">
      <CardContent className="p-4 flex items-center gap-4">
        <div className="flex items-center gap-2">
          <Checkbox
            checked={selectedGuests.length === guests.length}
            onCheckedChange={toggleSelectAll}
          />
          <span className="font-semibold">
            {selectedGuests.length} выбрано
          </span>
        </div>
        
        <Separator orientation="vertical" className="h-6" />
        
        <div className="flex gap-2">
          <Button variant="outline" size="sm" onClick={exportSelected}>
            <Download className="mr-2 h-4 w-4" />
            Экспорт
          </Button>
          
          <Button variant="outline" size="sm" onClick={openBulkAddBalls}>
            <Gift className="mr-2 h-4 w-4" />
            Добавить баллы
          </Button>
          
          <Button variant="outline" size="sm" onClick={openBulkNotification}>
            <Send className="mr-2 h-4 w-4" />
            Уведомление
          </Button>
          
          <Button variant="outline" size="sm" onClick={openBulkTag}>
            <Tag className="mr-2 h-4 w-4" />
            Применить тег
          </Button>
          
          <Separator orientation="vertical" className="h-6" />
          
          <Button variant="destructive" size="sm" onClick={openBulkDelete}>
            <Trash2 className="mr-2 h-4 w-4" />
            Удалить
          </Button>
        </div>
        
        <Button
          variant="ghost"
          size="sm"
          onClick={() => setSelectedGuests([])}
        >
          <X className="h-4 w-4" />
        </Button>
      </CardContent>
    </Card>
  </div>
)}
```


***

### **9️⃣ Guest Profile Page - какие табы показать?**

**Контекст:**
Admin кликает на гостя → открывается страница `/admin/guests/:id` с детальной информацией. Из твоего примера Guests-Enhanced-V4.html видны табы: Overview, Transactions, Visits, Activity Log.[^9_4]

**Вопрос:**
Какие табы включить в Guest Profile?

**A)** Overview | Transactions | Visits
**B)** Overview | Transactions | Visits | Activity Log
**C)** Overview | Баллы | Визиты | История | Дети
**D)** Overview | Transactions | Visits | Children | Activity Log | Analytics

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: D) 6 табов (Overview | Transactions | Visits | Children | Activity | Analytics)**

**Обоснование:**

**Tab 1: Overview**

- Личная информация (ФИО, телефон, email, ДР, фото)
- Loyalty карточка (уровень, баланс, QR-код, 6-digit код)
- Lifetime статистика (Lifetime Spent, Visits, Avg Check, Регистрация)
- Quick Actions (Добавить баллы, Трансфер, Сбросить QR, Отправить сообщение)

**Tab 2: Transactions (Транзакции с баллами)**

- Таблица: Дата | Тип (Начисление/Списание/Трансфер) | Сумма | Причина | Источник (POS/Manual) | Баланс после
- Фильтры: Тип | Дата | Источник

**Tab 3: Visits (Визиты в ресторан)**

- Таблица: Дата | Ресторан | Чек | Начислено | Списано | Детали
- Статистика: Частота визитов, Любимое время, Любимый день, Средний чек

**Tab 4: Children (Дети гостя)**

- Список детей с ФИО, ДР, фото
- Кнопка "Добавить ребёнка"
- Birthday promo для детей

**Tab 5: Activity Log (История действий)**

- Лог всех действий с этим гостем: создание, редактирование, начисления, блокировки, impersonation
- Фильтр по типу действия

**Tab 6: Analytics (Персональная аналитика)**

- График визитов по месяцам
- График трат (Lifetime Spent Trend)
- RFM сегмент (Recency, Frequency, Monetary)
- Рекомендации (например: "Давно не был → отправить промо")

***

### **🔟 Guest Profile Overview Tab - что показать?**

**Вопрос:**
Какую информацию включить в Overview?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ:**

```tsx
<div className="grid grid-cols-3 gap-6">
  {/* Left Column: Personal Info */}
  <Card className="col-span-1">
    <CardHeader>
      <CardTitle>Личная информация</CardTitle>
    </CardHeader>
    <CardContent className="space-y-4">
      {/* Avatar */}
      <div className="flex flex-col items-center">
        <Avatar className="h-24 w-24">
          {guest.avatar ? (
            <AvatarImage src={guest.avatar} />
          ) : (
            <AvatarFallback className="text-2xl">
              {getInitials(guest.firstName, guest.lastName)}
            </AvatarFallback>
          )}
        </Avatar>
        <Button variant="ghost" size="sm" className="mt-2">
          <Upload className="mr-2 h-4 w-4" />
          Загрузить фото
        </Button>
      </div>
      
      {/* Info Fields */}
      <Separator />
      
      <div className="space-y-3">
        <div>
          <Label className="text-xs text-secondary">ФИО</Label>
          <p className="font-medium">
            {guest.firstName} {guest.lastName}
          </p>
        </div>
        
        <div>
          <Label className="text-xs text-secondary">Телефон</Label>
          <p className="font-medium">{formatPhone(guest.phone)}</p>
        </div>
        
        <div>
          <Label className="text-xs text-secondary">Email</Label>
          <p className="font-medium">{guest.email || '—'}</p>
        </div>
        
        <div>
          <Label className="text-xs text-secondary">День рождения</Label>
          <p className="font-medium">
            {formatDate(guest.birthdate)} {getZodiacSign(guest.birthdate)}
          </p>
        </div>
        
        <div>
          <Label className="text-xs text-secondary">Регистрация</Label>
          <p className="font-medium">
            {formatDate(guest.createdAt)}
            <span className="text-sm text-secondary ml-2">
              ({formatRelative(guest.createdAt)})
            </span>
          </p>
        </div>
        
        <div>
          <Label className="text-xs text-secondary">Источник</Label>
          <Badge variant="outline">
            {SOURCE_ICONS[guest.registrationSource]}
            {guest.registrationSource}
          </Badge>
        </div>
      </div>
      
      <Separator />
      
      <Button variant="outline" className="w-full">
        <Edit className="mr-2 h-4 w-4" />
        Редактировать
      </Button>
    </CardContent>
  </Card>
  
  {/* Center Column: Loyalty Card */}
  <Card className="col-span-1">
    <CardHeader>
      <CardTitle>Loyalty карточка</CardTitle>
    </CardHeader>
    <CardContent className="space-y-4">
      {/* Level Badge */}
      <div className="flex items-center justify-center gap-3">
        <span className="text-4xl">{LEVEL_ICONS[guestCard.level]}</span>
        <div>
          <div className="text-2xl font-bold">{guestCard.level}</div>
          <div className="text-sm text-secondary">
            {formatCurrency(guestCard.lifetimeSpent)} потрачено
          </div>
        </div>
      </div>
      
      {/* Balance */}
      <Separator />
      
      <div className="text-center">
        <div className="text-3xl font-bold text-primary">
          {guestCard.totalBalance}
        </div>
        <div className="text-sm text-secondary">
          баллов на счёте
        </div>
        <div className="text-xs text-secondary mt-1">
          Regular: {guestCard.regularBalance} | Promo: {guestCard.promoBalance}
        </div>
      </div>
      
      {/* QR Code */}
      <div className="flex flex-col items-center bg-white p-4 rounded-lg">
        <QRCodeSVG value={guestCard.qrCode} size={150} />
        <div className="mt-2 font-mono text-lg">
          {guestCard.displayCode}
        </div>
      </div>
      
      {/* Actions */}
      <div className="grid grid-cols-2 gap-2">
        <Button variant="outline" size="sm" onClick={resetQR}>
          <RefreshCw className="mr-2 h-4 w-4" />
          Сбросить QR
        </Button>
        <Button variant="outline" size="sm" onClick={printCard}>
          <Printer className="mr-2 h-4 w-4" />
          Печать
        </Button>
      </div>
    </CardContent>
  </Card>
  
  {/* Right Column: Stats + Actions */}
  <Card className="col-span-1">
    <CardHeader>
      <CardTitle>Статистика</CardTitle>
    </CardHeader>
    <CardContent className="space-y-6">
      {/* Lifetime Stats */}
      <div className="grid grid-cols-2 gap-4">
        <div>
          <div className="text-2xl font-bold">
            {formatCurrency(guestCard.lifetimeSpent)}
          </div>
          <div className="text-xs text-secondary">Lifetime Spent</div>
        </div>
        
        <div>
          <div className="text-2xl font-bold">
            {guestCard.visitsCount}
          </div>
          <div className="text-xs text-secondary">Посещений</div>
        </div>
        
        <div>
          <div className="text-2xl font-bold">
            {formatCurrency(guestCard.avgCheck)}
          </div>
          <div className="text-xs text-secondary">Средний чек</div>
        </div>
        
        <div>
          <div className="text-2xl font-bold">
            {formatRelative(guestCard.lastVisit)}
          </div>
          <div className="text-xs text-secondary">Последний визит</div>
        </div>
      </div>
      
      <Separator />
      
      {/* Quick Actions */}
      <div className="space-y-2">
        <h4 className="text-sm font-semibold">Быстрые действия</h4>
        
        <Button variant="outline" className="w-full justify-start" onClick={openAddBalls}>
          <Plus className="mr-2 h-4 w-4 text-success" />
          Начислить баллы
        </Button>
        
        <Button variant="outline" className="w-full justify-start" onClick={openSubtractBalls}>
          <Minus className="mr-2 h-4 w-4 text-danger" />
          Списать баллы
        </Button>
        
        <Button variant="outline" className="w-full justify-start" onClick={openTransfer}>
          <ArrowLeftRight className="mr-2 h-4 w-4 text-info" />
          Трансфер баллов
        </Button>
        
        <Button variant="outline" className="w-full justify-start" onClick={openSendMessage}>
          <Send className="mr-2 h-4 w-4 text-primary" />
          Отправить сообщение
        </Button>
        
        <Separator />
        
        <Button variant="destructive" className="w-full justify-start" onClick={openBlockGuest}>
          <Ban className="mr-2 h-4 w-4" />
          Заблокировать гостя
        </Button>
      </div>
    </CardContent>
  </Card>
</div>
```


***

## **🎁 3. LOYALTY BUILDER PAGE**

### **1️⃣1️⃣ Loyalty Builder Structure - как организовать?**

**Контекст:**
Admin настраивает loyalty систему: правила начисления, уровни (Bronze/Silver/Gold), промо-акции, дизайн карточки.[^9_2][^9_1]

**Вопрос:**
Как организовать Loyalty Builder?

**A)** Одна страница с табами (Rules | Levels | Promos | Design)
**B)** Отдельные страницы (/loyalty/rules, /loyalty/levels, etc.)
**C)** Wizard flow (шаг за шагом)
**D)** Dashboard с карточками → клик открывает Builder

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: A) Одна страница с 4 табами**

**Обоснование:**

- ✅ **Всё в одном месте** - Admin видит всю loyalty систему сразу
- ✅ **Контекст не теряется** - переключение между табами быстрее чем навигация
- ✅ **Логическая группировка** - Rules, Levels, Promos, Design — связанные сущности

**Tabs:**

```
┌──────────────────────────────────────────────┐
│ 📏 Правила | 🏆 Уровни | 🎁 Промо | 🎨 Дизайн │
└──────────────────────────────────────────────┘
```


***

### **1️⃣2️⃣ Loyalty Rules Builder - как создавать правила?**

**Контекст:**
Admin создаёт правило: "Начислять 10% с каждого чека", "Двойные баллы по пятницам", "15% на категорию 'Пицца'".[^9_2]

**Вопрос:**
Какой UI использовать для создания правил?

**A)** Форма с полями (Название, Процент, Условия)
**B)** Visual Builder с drag-drop блоками
**C)** Форма + Live Preview (видно как правило работает)
**D)** Template Wizard (выбрать шаблон → настроить параметры)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Форма + Live Preview**

**Обоснование:**

- ✅ **Форма** - простота и понятность для Admin
- ✅ **Live Preview** - сразу видно как правило сработает на примере чека
- ✅ **Validation** - подсветка ошибок в реальном времени
- ✅ **Examples** - показывает "Пример чека: 2,000₽ → Начислено: 200 баллов"

**UI Layout:**

```
┌─────────────────────────────────────────────────┐
│ [Создать правило]  [Импорт]  [Шаблоны]         │
├─────────────────────────────────────────────────┤
│ АКТИВНЫЕ ПРАВИЛА (3)                            │
│                                                  │
│ ┌─ Priority 1 ─────────────────────────────┐   │
│ │ 🎉 Birthday Cashback         [✓ Активно] │   │
│ │ Начисление: 15%                           │   │
│ │ Условия: День рождения гостя              │   │
│ │ [Редактировать] [Деактивировать]          │   │
│ └──────────────────────────────────────────┘   │
│                                                  │
│ ┌─ Priority 2 ─────────────────────────────┐   │
│ │ 🍕 Weekend Bonus            [✓ Активно]  │   │
│ │ Начисление: 12%                           │   │
│ │ Условия: Сб-Вс, 18:00-22:00               │   │
│ │ [Редактировать] [Деактивировать]          │   │
│ └──────────────────────────────────────────┘   │
│                                                  │
│ ┌─ Priority 3 ─────────────────────────────┐   │
│ │ 💰 Base Cashback            [✓ Активно]  │   │
│ │ Начисление: 10%                           │   │
│ │ Условия: Всегда                           │   │
│ │ [Редактировать] [Деактивировать]          │   │
│ └──────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
```

**Create/Edit Rule Modal:**

```tsx
<Dialog open={showRuleBuilder} onOpenChange={setShowRuleBuilder}>
  <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
    <DialogHeader>
      <DialogTitle>
        {editingRule ? 'Редактировать правило' : 'Создать правило'}
      </DialogTitle>
    </DialogHeader>
    
    <div className="grid grid-cols-2 gap-6">
      {/* Left: Form */}
      <div className="space-y-4">
        <div>
          <Label>Название правила *</Label>
          <Input
            placeholder="Например: Birthday Cashback"
            value={rule.name}
            onChange={(e) => setRule({ ...rule, name: e.target.value })}
          />
        </div>
        
        <div>
          <Label>Процент начисления *</Label>
          <div className="flex items-center gap-2">
            <Slider
              value={[rule.earnPercent]}
              onValueChange={([value]) => setRule({ ...rule, earnPercent: value })}
              min={1}
              max={30}
              step={1}
              className="flex-1"
            />
            <Input
              type="number"
              value={rule.earnPercent}
              onChange={(e) => setRule({ ...rule, earnPercent: Number(e.target.value) })}
              className="w-20"
            />
            <span className="text-secondary">%</span>
          </div>
        </div>
        
        <Separator />
        
        <div>
          <Label className="flex items-center justify-between">
            <span>Условия</span>
            <Button
              variant="ghost"
              size="sm"
              onClick={() => addCondition()}
            >
              <Plus className="h-4 w-4 mr-1" />
              Добавить условие
            </Button>
          </Label>
          
          <div className="space-y-2 mt-2">
            {rule.conditions.map((condition, idx) => (
              <ConditionBuilder
                key={idx}
                condition={condition}
                onChange={(updated) => updateCondition(idx, updated)}
                onRemove={() => removeCondition(idx)}
              />
            ))}
            
            {rule.conditions.length === 0 && (
              <Alert>
                <Info className="h-4 w-4" />
                <AlertDescription>
                  Правило будет применяться ко всем чекам
                </AlertDescription>
              </Alert>
            )}
          </div>
        </div>
        
        <Separator />
        
        <div>
          <Label>Приоритет</Label>
          <Select
            value={String(rule.priority)}
            onValueChange={(value) => setRule({ ...rule, priority: Number(value) })}
          >
            <SelectTrigger>
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              {[1, 2, 3, 4, 5].map((p) => (
                <SelectItem key={p} value={String(p)}>
                  Приоритет {p}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
          <p className="text-xs text-secondary mt-1">
            Правила с меньшим номером выполняются первыми
          </p>
        </div>
        
        <div className="flex items-center justify-between">
          <Label>Статус</Label>
          <Switch
            checked={rule.isActive}
            onCheckedChange={(checked) => setRule({ ...rule, isActive: checked })}
          />
        </div>
      </div>
      
      {/* Right: Live Preview */}
      <div className="space-y-4">
        <Card className="bg-primary/5">
          <CardHeader>
            <CardTitle className="text-base">Предпросмотр</CardTitle>
            <CardDescription>
              Как правило сработает на примере чека
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* Example Check */}
            <div>
              <Label className="text-xs">Пример чека</Label>
              <div className="bg-card p-3 rounded-lg mt-1 space-y-2">
                <div className="flex justify-between text-sm">
                  <span>Сумма чека:</span>
                  <span className="font-medium">2,000₽</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span>Дата:</span>
                  <span className="font-medium">{formatDate(previewDate)}</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span>Уровень гостя:</span>
                  <Badge>Silver</Badge>
                </div>
              </div>
            </div>
            
            {/* Calculation Result */}
            <Separator />
            
            <div>
              <Label className="text-xs">Результат</Label>
              <div className="bg-success/10 border border-success/20 p-3 rounded-lg mt-1">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm">Начислено баллов:</span>
                  <span className="text-2xl font-bold text-success">
                    {calculateEarnedBalls(rule, 2000)}
                  </span>
                </div>
                <div className="text-xs text-secondary">
                  Расчёт: 2,000₽ × {rule.earnPercent}% = {calculateEarnedBalls(rule, 2000)} баллов
                </div>
              </div>
            </div>
            
            {/* Conditions Match */}
            {rule.conditions.length > 0 && (
              <>
                <Separator />
                <div>
                  <Label className="text-xs">Проверка условий</Label>
                  <div className="space-y-1 mt-1">
                    {rule.conditions.map((condition, idx) => (
                      <div
                        key={idx}
                        className="flex items-center gap-2 text-sm"
                      >
                        {checkCondition(condition, previewDate) ? (
                          <CheckCircle2 className="h-4 w-4 text-success" />
                        ) : (
                          <XCircle className="h-4 w-4 text-danger" />
                        )}
                        <span>{formatCondition(condition)}</span>
                      </div>
                    ))}
                  </div>
                </div>
              </>
            )}
          </CardContent>
        </Card>
        
        {/* Templates */}
        <Card>
          <CardHeader>
            <CardTitle className="text-base">Шаблоны</CardTitle>
          </CardHeader>
          <CardContent className="space-y-2">
            <Button
              variant="outline"
              size="sm"
              className="w-full justify-start"
              onClick={() => applyTemplate('birthday')}
            >
              🎉 День рождения (15%)
            </Button>
            <Button
              variant="outline"
              size="sm"
              className="w-full justify-start"
              onClick={() => applyTemplate('weekend')}
            >
              🍕 Выходные (12%)
            </Button>
            <Button
              variant="outline"
              size="sm"
              className="w-full justify-start"
              onClick={() => applyTemplate('happy-hour')}
            >
              🍹 Happy Hour (20%)
            </Button>
          </CardContent>
        </Card>
      </div>
    </div>
    
    <DialogFooter>
      <Button variant="outline" onClick={() => setShowRuleBuilder(false)}>
        Отмена
      </Button>
      <Button onClick={saveRule} disabled={!isRuleValid()}>
        {editingRule ? 'Сохранить' : 'Создать'}
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```


***

**Продолжить с вопросами 13-25?** Или хочешь уточнить что-то по первым 12 вопросам Admin Dashboard?

**Следующие темы:**

- 13-17: Loyalty Levels, Promos, Design
- 18-21: Analytics Page, Reports, Drill-down
- 22-25: Settings, Team Management, POS Integration, Mobile View

<div align="center">⁂</div>

[^9_1]: Beseda-2.md

[^9_2]: Beseda-8.md

[^9_3]: Max-Loyalty-Dashboard.html

[^9_4]: Guests-Enhanced-V4.html


---

# 🍕 **ADMIN DASHBOARD (RESTAURANTADMIN) - ПРОДОЛЖЕНИЕ (13-25 ВОПРОСОВ)**


***

## **🎁 3. LOYALTY BUILDER PAGE (продолжение)**

### **1️⃣3️⃣ Loyalty Levels - как Admin настраивает уровни?**

**Контекст:**
Admin создаёт уровни: Bronze (0₽), Silver (150,000₽), Gold (400,000₽), Platinum (1,000,000₽). Каждый уровень даёт бонус к начислению (+5%, +10%, +15%).[^10_1]

**Вопрос:**
Как организовать UI для настройки уровней?

**A)** Таблица с редактированием inline
**B)** Timeline визуализация (слева направо: Bronze → Silver → Gold)
**C)** Cards Grid с прогресс-баром между уровнями
**D)** Drag-and-drop Builder с визуальной шкалой

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Timeline визуализация + Modal для редактирования**

**Обоснование:**

- ✅ **Visual** - Admin сразу видит прогрессию уровней (0₽ → 150K → 400K → 1M)
- ✅ **Intuitive** - естественный flow "слева направо" = рост клиента
- ✅ **One-way up logic** - визуально понятно что клиент не может downgrade[^10_1]
- ✅ **Editable** - клик на уровень → Modal с детальными настройками

**UI (Timeline View):**

```tsx
<div className="space-y-6">
  <div className="flex items-center justify-between">
    <div>
      <h2 className="text-2xl font-bold">Уровни лояльности</h2>
      <p className="text-sm text-secondary mt-1">
        Настройте пороги и бонусы для каждого уровня
      </p>
    </div>
    <Button onClick={openCreateLevel}>
      <Plus className="mr-2 h-4 w-4" />
      Добавить уровень
    </Button>
  </div>
  
  <Alert>
    <Info className="h-4 w-4" />
    <AlertDescription>
      <strong>One-way up:</strong> Гости не могут спуститься на уровень ниже. 
      Уровень присваивается на основе Lifetime Spent.
    </AlertDescription>
  </Alert>
  
  {/* Timeline */}
  <div className="relative">
    {/* Progress Line */}
    <div className="absolute top-12 left-0 right-0 h-1 bg-border" />
    
    <div className="relative grid grid-cols-4 gap-4">
      {levels.map((level, idx) => (
        <Card
          key={level.id}
          className={cn(
            "cursor-pointer hover:border-primary transition",
            selectedLevel?.id === level.id && "border-primary shadow-lg"
          )}
          onClick={() => selectLevel(level)}
        >
          <CardContent className="p-6 text-center">
            {/* Level Icon */}
            <div className="text-5xl mb-3">
              {LEVEL_ICONS[level.name]}
            </div>
            
            {/* Level Name */}
            <h3 className="text-xl font-bold mb-2">
              {level.name}
            </h3>
            
            {/* Threshold */}
            <div className="text-sm text-secondary mb-4">
              {idx === 0 ? (
                'С первого дня'
              ) : (
                <>
                  От <span className="font-semibold text-foreground">
                    {formatCurrency(level.threshold)}
                  </span>
                </>
              )}
            </div>
            
            {/* Bonus */}
            <Badge variant="outline" className="mb-4">
              +{level.earnBonus}% к начислению
            </Badge>
            
            {/* Stats */}
            <div className="text-xs text-secondary">
              {level.guestsCount} гостей
            </div>
            
            {/* Arrow to next level */}
            {idx < levels.length - 1 && (
              <ChevronRight className="absolute right-0 top-1/2 -translate-y-1/2 translate-x-1/2 h-6 w-6 text-primary z-10" />
            )}
          </CardContent>
        </Card>
      ))}
    </div>
  </div>
  
  {/* Selected Level Details */}
  {selectedLevel && (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <span className="text-2xl">{LEVEL_ICONS[selectedLevel.name]}</span>
          <span>{selectedLevel.name}</span>
        </CardTitle>
      </CardHeader>
      <CardContent>
        <dl className="grid grid-cols-2 gap-4">
          <div>
            <dt className="text-sm text-secondary">Порог входа</dt>
            <dd className="text-2xl font-bold">
              {formatCurrency(selectedLevel.threshold)}
            </dd>
          </div>
          <div>
            <dt className="text-sm text-secondary">Бонус к начислению</dt>
            <dd className="text-2xl font-bold text-success">
              +{selectedLevel.earnBonus}%
            </dd>
          </div>
          <div>
            <dt className="text-sm text-secondary">Гостей на уровне</dt>
            <dd className="text-2xl font-bold">
              {selectedLevel.guestsCount}
            </dd>
          </div>
          <div>
            <dt className="text-sm text-secondary">Средний чек</dt>
            <dd className="text-2xl font-bold">
              {formatCurrency(selectedLevel.avgCheck)}
            </dd>
          </div>
        </dl>
        
        <div className="flex gap-2 mt-6">
          <Button onClick={() => editLevel(selectedLevel)}>
            <Edit className="mr-2 h-4 w-4" />
            Редактировать
          </Button>
          
          <Button variant="outline" onClick={() => viewGuests(selectedLevel)}>
            <Users className="mr-2 h-4 w-4" />
            Посмотреть гостей
          </Button>
          
          {selectedLevel.guestsCount === 0 && (
            <Button variant="destructive" onClick={() => deleteLevel(selectedLevel)}>
              <Trash2 className="mr-2 h-4 w-4" />
              Удалить
            </Button>
          )}
        </div>
      </CardContent>
    </Card>
  )}
</div>
```

**Edit Level Modal:**

```tsx
<Dialog open={showEditLevel} onOpenChange={setShowEditLevel}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Редактировать уровень</DialogTitle>
    </DialogHeader>
    
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <Label>Название *</Label>
        <Input
          placeholder="Например: Silver"
          value={editingLevel.name}
          onChange={(e) => setEditingLevel({ ...editingLevel, name: e.target.value })}
          required
        />
      </div>
      
      <div>
        <Label>Иконка</Label>
        <Select
          value={editingLevel.icon}
          onValueChange={(value) => setEditingLevel({ ...editingLevel, icon: value })}
        >
          <SelectTrigger>
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="🥉">🥉 Bronze</SelectItem>
            <SelectItem value="🥈">🥈 Silver</SelectItem>
            <SelectItem value="🥇">🥇 Gold</SelectItem>
            <SelectItem value="👑">👑 Platinum</SelectItem>
            <SelectItem value="💎">💎 Diamond</SelectItem>
          </SelectContent>
        </Select>
      </div>
      
      <div>
        <Label>Порог входа (Lifetime Spent) *</Label>
        <Input
          type="number"
          placeholder="150000"
          value={editingLevel.threshold}
          onChange={(e) => setEditingLevel({ ...editingLevel, threshold: Number(e.target.value) })}
          required
        />
        <p className="text-xs text-secondary mt-1">
          Гость достигнет уровня при накоплении этой суммы покупок
        </p>
      </div>
      
      <div>
        <Label>Бонус к начислению *</Label>
        <div className="flex items-center gap-2">
          <Slider
            value={[editingLevel.earnBonus]}
            onValueChange={([value]) => setEditingLevel({ ...editingLevel, earnBonus: value })}
            min={0}
            max={20}
            step={1}
            className="flex-1"
          />
          <Input
            type="number"
            value={editingLevel.earnBonus}
            onChange={(e) => setEditingLevel({ ...editingLevel, earnBonus: Number(e.target.value) })}
            className="w-20"
          />
          <span className="text-secondary">%</span>
        </div>
        <p className="text-xs text-secondary mt-1">
          Дополнительно к основному начислению (например: 10% + 5% = 15% итого)
        </p>
      </div>
      
      <div>
        <Label>Цвет</Label>
        <div className="flex gap-2">
          {COLOR_PRESETS.map((color) => (
            <button
              key={color}
              type="button"
              className={cn(
                "w-10 h-10 rounded-full border-2 transition",
                editingLevel.color === color ? "border-primary scale-110" : "border-transparent"
              )}
              style={{ backgroundColor: color }}
              onClick={() => setEditingLevel({ ...editingLevel, color })}
            />
          ))}
        </div>
      </div>
      
      <Alert variant="warning">
        <AlertTriangle className="h-4 w-4" />
        <AlertDescription>
          <strong>Внимание:</strong> Изменение порога повлияет на {editingLevel.guestsCount} гостей. 
          Пересчёт уровней произойдёт автоматически.
        </AlertDescription>
      </Alert>
    </form>
    
    <DialogFooter>
      <Button variant="outline" onClick={() => setShowEditLevel(false)}>
        Отмена
      </Button>
      <Button onClick={saveLevel}>
        Сохранить
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```


***

### **1️⃣4️⃣ Promo Campaigns Builder - как создавать акции?**

**Контекст:**
Admin создаёт промо: "500 баллов на день рождения", "Удвоенные баллы в выходные", "1000 баллов за первый визит".[^10_1]

**Вопрос:**
Какой UI использовать для создания промо?

**A)** Форма с полями (Название, Тип, Бонус, Даты)
**B)** Wizard (5 шагов: Тип → Условия → Бонус → Даты → Подтверждение)
**C)** Template Gallery → выбор шаблона → настройка параметров
**D)** AI Assistant (описываешь промо текстом → генерирует настройки)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Template Gallery + Form для кастомизации**

**Обоснование:**

- ✅ **Templates** - 80% промо-акций стандартные (День рождения, Выходные, Первый визит)
- ✅ **Быстрый старт** - клик на шаблон → параметры уже заполнены → только настроить детали
- ✅ **Custom option** - можно создать с нуля
- ✅ **Visual** - иконки и превью для каждого типа

**UI (Promo List + Template Gallery):**

```tsx
<div className="space-y-6">
  <div className="flex items-center justify-between">
    <div>
      <h2 className="text-2xl font-bold">Промо-акции</h2>
      <p className="text-sm text-secondary mt-1">
        Автоматические бонусы для гостей
      </p>
    </div>
    <Button onClick={() => setShowTemplateGallery(true)}>
      <Plus className="mr-2 h-4 w-4" />
      Создать промо
    </Button>
  </div>
  
  {/* Active Promos */}
  <Card>
    <CardHeader>
      <CardTitle className="text-base">Активные акции ({activePromos.length})</CardTitle>
    </CardHeader>
    <CardContent>
      <div className="space-y-3">
        {activePromos.map((promo) => (
          <div
            key={promo.id}
            className="flex items-center justify-between p-4 border rounded-lg hover:bg-card-hover transition"
          >
            <div className="flex items-center gap-4">
              <div className="text-3xl">
                {PROMO_ICONS[promo.type]}
              </div>
              <div>
                <div className="font-semibold">{promo.name}</div>
                <div className="text-sm text-secondary">
                  {promo.description}
                </div>
                <div className="flex items-center gap-3 mt-1">
                  <Badge variant="outline">
                    +{promo.bonusPoints} баллов
                  </Badge>
                  {promo.expiresInDays && (
                    <span className="text-xs text-secondary">
                      Действуют {promo.expiresInDays} дней
                    </span>
                  )}
                </div>
              </div>
            </div>
            
            <div className="flex items-center gap-2">
              <div className="text-right mr-4">
                <div className="text-sm text-secondary">Активаций</div>
                <div className="text-xl font-bold">{promo.activationsCount}</div>
              </div>
              
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button variant="ghost" size="sm">
                    <MoreVertical className="h-4 w-4" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end">
                  <DropdownMenuItem onClick={() => editPromo(promo)}>
                    <Edit className="mr-2 h-4 w-4" />
                    Редактировать
                  </DropdownMenuItem>
                  <DropdownMenuItem onClick={() => viewStats(promo)}>
                    <BarChart3 className="mr-2 h-4 w-4" />
                    Статистика
                  </DropdownMenuItem>
                  <DropdownMenuSeparator />
                  <DropdownMenuItem onClick={() => deactivatePromo(promo)}>
                    <PauseCircle className="mr-2 h-4 w-4" />
                    Деактивировать
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            </div>
          </div>
        ))}
      </div>
    </CardContent>
  </Card>
</div>

{/* Template Gallery Modal */}
<Dialog open={showTemplateGallery} onOpenChange={setShowTemplateGallery}>
  <DialogContent className="max-w-4xl">
    <DialogHeader>
      <DialogTitle>Выберите тип промо-акции</DialogTitle>
      <DialogDescription>
        Или создайте кастомную акцию с нуля
      </DialogDescription>
    </DialogHeader>
    
    <div className="grid grid-cols-3 gap-4">
      {PROMO_TEMPLATES.map((template) => (
        <Card
          key={template.type}
          className="cursor-pointer hover:border-primary transition"
          onClick={() => selectTemplate(template)}
        >
          <CardContent className="p-6 text-center">
            <div className="text-4xl mb-3">{template.icon}</div>
            <h3 className="font-semibold mb-2">{template.name}</h3>
            <p className="text-sm text-secondary mb-4">
              {template.description}
            </p>
            <Badge variant="outline">
              {template.defaultBonus} баллов
            </Badge>
          </CardContent>
        </Card>
      ))}
      
      {/* Custom Promo */}
      <Card
        className="cursor-pointer hover:border-primary transition border-dashed"
        onClick={() => createCustomPromo()}
      >
        <CardContent className="p-6 text-center flex flex-col items-center justify-center h-full">
          <Plus className="h-12 w-12 mb-3 text-secondary" />
          <h3 className="font-semibold">Кастомная акция</h3>
          <p className="text-sm text-secondary mt-2">
            Создать с нуля
          </p>
        </CardContent>
      </Card>
    </div>
  </DialogContent>
</Dialog>
```

**Promo Templates:**

```typescript
const PROMO_TEMPLATES = [
  {
    type: 'BIRTHDAY',
    icon: '🎂',
    name: 'День рождения',
    description: 'Бонус гостю в день рождения',
    defaultBonus: 500,
    expiresInDays: 7,
    conditions: { birthdayWindow: 7 }
  },
  {
    type: 'CHILD_BIRTHDAY',
    icon: '🎈',
    name: 'ДР ребёнка',
    description: 'Бонус на день рождения ребёнка',
    defaultBonus: 300,
    expiresInDays: 7,
    conditions: { childBirthdayWindow: 7 }
  },
  {
    type: 'FIRST_VISIT',
    icon: '✨',
    name: 'Первый визит',
    description: 'Приветственный бонус новому гостю',
    defaultBonus: 1000,
    expiresInDays: 30,
    conditions: { visitNumber: 1 }
  },
  {
    type: 'INACTIVITY',
    icon: '💤',
    name: 'Возвращение',
    description: 'Бонус после долгого отсутствия',
    defaultBonus: 500,
    expiresInDays: 14,
    conditions: { inactiveDays: 60 }
  },
  {
    type: 'WEEKEND',
    icon: '🎉',
    name: 'Выходные',
    description: 'Удвоенные баллы в Сб-Вс',
    multiplier: 2,
    conditions: { daysOfWeek: [6, 7] }
  },
  {
    type: 'HAPPY_HOUR',
    icon: '🍹',
    name: 'Happy Hour',
    description: 'Бонус в определённые часы',
    multiplier: 1.5,
    conditions: { timeRange: { from: '18:00', to: '22:00' } }
  }
];
```

**Edit Promo Form (after selecting template):**

```tsx
<Dialog open={showPromoForm} onOpenChange={setShowPromoForm}>
  <DialogContent className="max-w-2xl">
    <DialogHeader>
      <DialogTitle className="flex items-center gap-2">
        <span className="text-2xl">{selectedTemplate.icon}</span>
        <span>{selectedTemplate.name}</span>
      </DialogTitle>
    </DialogHeader>
    
    <form onSubmit={handleSavePromo} className="space-y-4">
      <div>
        <Label>Название акции *</Label>
        <Input
          placeholder="Например: Бонус на день рождения"
          value={promo.name}
          onChange={(e) => setPromo({ ...promo, name: e.target.value })}
          required
        />
      </div>
      
      <div>
        <Label>Описание</Label>
        <Textarea
          placeholder="Подробное описание акции..."
          value={promo.description}
          onChange={(e) => setPromo({ ...promo, description: e.target.value })}
          rows={3}
        />
      </div>
      
      <Separator />
      
      {/* Bonus Type */}
      <div>
        <Label>Тип бонуса</Label>
        <RadioGroup
          value={promo.bonusType}
          onValueChange={(value) => setPromo({ ...promo, bonusType: value })}
        >
          <div className="flex items-center space-x-2">
            <RadioGroupItem value="fixed" id="fixed" />
            <Label htmlFor="fixed">Фиксированная сумма баллов</Label>
          </div>
          <div className="flex items-center space-x-2">
            <RadioGroupItem value="multiplier" id="multiplier" />
            <Label htmlFor="multiplier">Множитель начисления</Label>
          </div>
          <div className="flex items-center space-x-2">
            <RadioGroupItem value="percentage" id="percentage" />
            <Label htmlFor="percentage">Процент от чека</Label>
          </div>
        </RadioGroup>
      </div>
      
      {promo.bonusType === 'fixed' && (
        <div>
          <Label>Количество баллов *</Label>
          <Input
            type="number"
            placeholder="500"
            value={promo.bonusPoints}
            onChange={(e) => setPromo({ ...promo, bonusPoints: Number(e.target.value) })}
            required
          />
        </div>
      )}
      
      {promo.bonusType === 'multiplier' && (
        <div>
          <Label>Множитель *</Label>
          <div className="flex items-center gap-2">
            <Input
              type="number"
              step="0.1"
              placeholder="2.0"
              value={promo.multiplier}
              onChange={(e) => setPromo({ ...promo, multiplier: Number(e.target.value) })}
              required
            />
            <span className="text-secondary">×</span>
          </div>
          <p className="text-xs text-secondary mt-1">
            Например: 2.0 = удвоенные баллы, 1.5 = +50% к начислению
          </p>
        </div>
      )}
      
      <Separator />
      
      {/* Expiration */}
      <div>
        <Label>Срок действия баллов (опционально)</Label>
        <div className="flex items-center gap-2">
          <Input
            type="number"
            placeholder="7"
            value={promo.expiresInDays ?? ''}
            onChange={(e) => setPromo({ ...promo, expiresInDays: e.target.value ? Number(e.target.value) : null })}
          />
          <span className="text-secondary">дней</span>
        </div>
        <p className="text-xs text-secondary mt-1">
          Оставьте пустым для бессрочных баллов
        </p>
      </div>
      
      {/* Dates */}
      <div className="grid grid-cols-2 gap-4">
        <div>
          <Label>Дата начала *</Label>
          <Input
            type="date"
            value={promo.startDate}
            onChange={(e) => setPromo({ ...promo, startDate: e.target.value })}
            required
          />
        </div>
        <div>
          <Label>Дата окончания</Label>
          <Input
            type="date"
            value={promo.endDate ?? ''}
            onChange={(e) => setPromo({ ...promo, endDate: e.target.value || null })}
          />
        </div>
      </div>
      
      {/* Conditions */}
      <Separator />
      
      <div>
        <Label className="flex items-center justify-between">
          <span>Дополнительные условия</span>
          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={() => setShowConditions(!showConditions)}
          >
            {showConditions ? 'Скрыть' : 'Показать'}
          </Button>
        </Label>
        
        {showConditions && (
          <div className="space-y-3 mt-3 p-4 border rounded-lg">
            <div>
              <Label className="text-sm">Минимальная сумма чека</Label>
              <Input
                type="number"
                placeholder="Без ограничений"
                value={promo.minCheckAmount ?? ''}
                onChange={(e) => setPromo({ ...promo, minCheckAmount: e.target.value ? Number(e.target.value) : null })}
              />
            </div>
            
            <div>
              <Label className="text-sm">Применимо к ресторанам</Label>
              <MultiSelect
                options={restaurants}
                value={promo.restaurantIds}
                onChange={(value) => setPromo({ ...promo, restaurantIds: value })}
                placeholder="Все рестораны"
              />
            </div>
            
            {selectedTemplate.type === 'WEEKEND' && (
              <div>
                <Label className="text-sm">Дни недели</Label>
                <div className="flex gap-2 mt-2">
                  {DAYS_OF_WEEK.map((day) => (
                    <Button
                      key={day.value}
                      type="button"
                      variant={promo.daysOfWeek?.includes(day.value) ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => toggleDayOfWeek(day.value)}
                    >
                      {day.short}
                    </Button>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}
      </div>
      
      {/* Active Status */}
      <div className="flex items-center justify-between p-4 border rounded-lg">
        <div>
          <Label>Активировать сразу после создания</Label>
          <p className="text-xs text-secondary mt-1">
            Акция начнёт работать с даты начала
          </p>
        </div>
        <Switch
          checked={promo.isActive}
          onCheckedChange={(checked) => setPromo({ ...promo, isActive: checked })}
        />
      </div>
      
      {/* Preview */}
      <Alert>
        <Gift className="h-4 w-4" />
        <AlertDescription>
          <strong>Предпросмотр:</strong> Гость получит {promo.bonusType === 'fixed' ? `${promo.bonusPoints} баллов` : `${promo.multiplier}× множитель`} 
          {promo.expiresInDays && ` (действуют ${promo.expiresInDays} дней)`}
        </AlertDescription>
      </Alert>
    </form>
    
    <DialogFooter>
      <Button variant="outline" onClick={() => setShowPromoForm(false)}>
        Отмена
      </Button>
      <Button onClick={savePromo}>
        Создать акцию
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```


***

### **1️⃣5️⃣ Loyalty Card Design - как кастомизировать дизайн карточки?**

**Контекст:**
Admin хочет изменить внешний вид loyalty карточки: цвета, логотип, фон, шрифты (для печати и в Telegram mini app).[^10_2]

**Вопрос:**
Какой UI для редактирования дизайна?

**A)** Форма с полями (Цвет, Логотип, Фон)
**B)** Visual Editor с Live Preview (как в Figma)
**C)** Template Gallery (выбрать готовый шаблон → настроить цвета)
**D)** AI-генерация (описать стиль → генерирует дизайн)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Template Gallery + Color Customizer + Live Preview**

**Обоснование:**

- ✅ **Templates** - готовые стили (Minimal, Modern, Elegant, Fun)
- ✅ **Customizer** - цвета бренда, логотип, паттерны
- ✅ **Live Preview** - видно как карточка выглядит в реальном времени
- ✅ **Простота** - не нужны дизайн-скиллы

**UI:**

```tsx
<div className="grid grid-cols-2 gap-6">
  {/* Left: Customizer */}
  <div className="space-y-6">
    <Card>
      <CardHeader>
        <CardTitle>Шаблоны дизайна</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-2 gap-3">
          {CARD_TEMPLATES.map((template) => (
            <Card
              key={template.id}
              className={cn(
                "cursor-pointer transition",
                selectedTemplate.id === template.id ? "border-primary" : "border-border"
              )}
              onClick={() => selectTemplate(template)}
            >
              <CardContent className="p-3">
                <img
                  src={template.preview}
                  alt={template.name}
                  className="w-full h-24 object-cover rounded mb-2"
                />
                <div className="text-sm font-medium">{template.name}</div>
              </CardContent>
            </Card>
          ))}
        </div>
      </CardContent>
    </Card>
    
    <Card>
      <CardHeader>
        <CardTitle>Цвета бренда</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <div>
          <Label>Основной цвет</Label>
          <div className="flex gap-2 mt-2">
            <Input
              type="color"
              value={design.primaryColor}
              onChange={(e) => setDesign({ ...design, primaryColor: e.target.value })}
              className="w-16 h-10"
            />
            <Input
              type="text"
              value={design.primaryColor}
              onChange={(e) => setDesign({ ...design, primaryColor: e.target.value })}
              placeholder="#3B82F6"
            />
          </div>
        </div>
        
        <div>
          <Label>Цвет фона</Label>
          <div className="flex gap-2 mt-2">
            <Input
              type="color"
              value={design.backgroundColor}
              onChange={(e) => setDesign({ ...design, backgroundColor: e.target.value })}
              className="w-16 h-10"
            />
            <Input
              type="text"
              value={design.backgroundColor}
              onChange={(e) => setDesign({ ...design, backgroundColor: e.target.value })}
              placeholder="#FFFFFF"
            />
          </div>
        </div>
        
        <div>
          <Label>Цвет текста</Label>
          <div className="flex gap-2 mt-2">
            <Input
              type="color"
              value={design.textColor}
              onChange={(e) => setDesign({ ...design, textColor: e.target.value })}
              className="w-16 h-10"
            />
            <Input
              type="text"
              value={design.textColor}
              onChange={(e) => setDesign({ ...design, textColor: e.target.value })}
              placeholder="#000000"
            />
          </div>
        </div>
      </CardContent>
    </Card>
    
    <Card>
      <CardHeader>
        <CardTitle>Логотип</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {design.logo ? (
          <div className="relative">
            <img
              src={design.logo}
              alt="Logo"
              className="w-full h-32 object-contain border rounded p-2"
            />
            <Button
              variant="ghost"
              size="sm"
              className="absolute top-2 right-2"
              onClick={() => setDesign({ ...design, logo: null })}
            >
              <X className="h-4 w-4" />
            </Button>
          </div>
        ) : (
          <div
            className="border-2 border-dashed rounded-lg p-8 text-center cursor-pointer hover:border-primary transition"
            onClick={() => uploadLogo()}
          >
            <Upload className="h-8 w-8 mx-auto mb-2 text-secondary" />
            <p className="text-sm text-secondary">
              Загрузите логотип (PNG, SVG)
            </p>
          </div>
        )}
      </CardContent>
    </Card>
    
    <Card>
      <CardHeader>
        <CardTitle>Паттерн фона</CardTitle>
      </CardHeader>
      <CardContent>
        <Select
          value={design.backgroundPattern}
          onValueChange={(value) => setDesign({ ...design, backgroundPattern: value })}
        >
          <SelectTrigger>
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="none">Без паттерна</SelectItem>
            <SelectItem value="dots">Точки</SelectItem>
            <SelectItem value="waves">Волны</SelectItem>
            <SelectItem value="geometric">Геометрия</SelectItem>
            <SelectItem value="gradient">Градиент</SelectItem>
          </SelectContent>
        </Select>
      </CardContent>
    </Card>
  </div>
  
  {/* Right: Live Preview */}
  <div className="space-y-6 sticky top-6">
    <Card>
      <CardHeader>
        <CardTitle>Предпросмотр</CardTitle>
        <CardDescription>
          Так карточка будет выглядеть у гостей
        </CardDescription>
      </CardHeader>
      <CardContent>
        <Tabs defaultValue="physical">
          <TabsList className="grid w-full grid-cols-2">
            <TabsTrigger value="physical">Физическая</TabsTrigger>
            <TabsTrigger value="digital">Telegram</TabsTrigger>
          </TabsList>
          
          <TabsContent value="physical" className="mt-4">
            <LoyaltyCardPreview
              design={design}
              guest={PREVIEW_GUEST}
              type="physical"
            />
          </TabsContent>
          
          <TabsContent value="digital" className="mt-4">
            <div className="bg-[#0088cc] p-4 rounded-lg">
              <LoyaltyCardPreview
                design={design}
                guest={PREVIEW_GUEST}
                type="digital"
              />
            </div>
          </TabsContent>
        </Tabs>
      </CardContent>
    </Card>
    
    <div className="flex gap-2">
      <Button variant="outline" onClick={resetToDefault}>
        Сбросить
      </Button>
      <Button className="flex-1" onClick={saveDesign}>
        Сохранить дизайн
      </Button>
    </div>
  </div>
</div>
```


***

## **📊 4. ANALYTICS PAGE**

### **1️⃣6️⃣ Analytics Dashboard Structure - какие разделы показать?**

**Контекст:**
Admin открывает `/admin/analytics` и хочет видеть детальную аналитику ресторана: выручка, гости, loyalty ROI, тренды.[^10_2]

**Вопрос:**
Как организовать Analytics Page?

**A)** Single Page с секциями (Overview | Guests | Revenue | Loyalty)
**B)** Tabs (Overview | Guests Analysis | Revenue | Loyalty ROI | Reports)
**C)** Dashboard с виджетами (drag-and-drop customizable)
**D)** Report Builder (выбираешь метрики → генерирует отчёт)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Tabs (5 разделов)**

**Обоснование:**

- ✅ **Overview** - общая картина (KPIs + главные графики)
- ✅ **Guests Analysis** - RFM сегментация, cohort analysis, churn
- ✅ **Revenue Analysis** - выручка, средний чек, распределение по источникам
- ✅ **Loyalty ROI** - эффективность программы лояльности
- ✅ **Reports** - готовые отчёты для экспорта

**Tabs:**

```tsx
<Tabs defaultValue="overview">
  <TabsList className="grid w-full grid-cols-5">
    <TabsTrigger value="overview">
      <BarChart3 className="mr-2 h-4 w-4" />
      Обзор
    </TabsTrigger>
    <TabsTrigger value="guests">
      <Users className="mr-2 h-4 w-4" />
      Гости
    </TabsTrigger>
    <TabsTrigger value="revenue">
      <TrendingUp className="mr-2 h-4 w-4" />
      Выручка
    </TabsTrigger>
    <TabsTrigger value="loyalty">
      <Gift className="mr-2 h-4 w-4" />
      Loyalty ROI
    </TabsTrigger>
    <TabsTrigger value="reports">
      <FileText className="mr-2 h-4 w-4" />
      Отчёты
    </TabsTrigger>
  </TabsList>
  
  <TabsContent value="overview">
    {/* Overview content */}
  </TabsContent>
  
  {/* Other tabs... */}
</Tabs>
```


***

### **1️⃣7️⃣ Guests Analysis Tab - какие графики показать?**

**Контекст:**
Admin хочет понять поведение гостей: кто активные, кто at-risk, сегменты по RFM (Recency, Frequency, Monetary).

**Вопрос:**
Какую аналитику включить?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ:**

**1. RFM Segmentation Chart (Scatter Plot)**

- X-axis: Recency (дней с последнего визита)
- Y-axis: Frequency (количество визитов)
- Bubble size: Monetary (Lifetime Spent)
- Цвета: Champions (зелёный), Loyal (синий), At Risk (оранжевый), Lost (красный)

**2. Guest Lifecycle Funnel**

```
Всего зарегистрировано: 2,847
  ↓ 92%
Сделали первый визит: 2,619
  ↓ 68%
Повторный визит: 1,781
  ↓ 45%
Лояльные (5+ визитов): 1,281
  ↓ 35%
VIP (20+ визитов): 997
```

**3. Cohort Retention Analysis (Heatmap)**

- Строки: Cohort (месяц регистрации)
- Столбцы: Месяцы с регистрации (Month 0, 1, 2, ...)
- Цвета: % удержания (100% зелёный → 0% красный)

**4. Churn Risk Matrix (Table)**

- Гости с риском оттока (не были 30+ дней, но раньше активные)
- Столбцы: Имя | Последний визит | Lifetime Spent | Риск оттока | Действие

**UI (Guests Analysis Tab):**

```tsx
<TabsContent value="guests" className="space-y-6">
  {/* Period Filter */}
  <div className="flex items-center justify-between">
    <div>
      <h3 className="text-xl font-bold">Анализ гостей</h3>
      <p className="text-sm text-secondary mt-1">
        RFM сегментация и retention analysis
      </p>
    </div>
    <Select value={period} onValueChange={setPeriod}>
      <SelectTrigger className="w-[180px]">
        <SelectValue />
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="30d">Последние 30 дней</SelectItem>
        <SelectItem value="90d">Последние 90 дней</SelectItem>
        <SelectItem value="12m">Последние 12 месяцев</SelectItem>
        <SelectItem value="all">За всё время</SelectItem>
      </SelectContent>
    </Select>
  </div>
  
  {/* RFM Segments Summary */}
  <div className="grid grid-cols-4 gap-4">
    {RFM_SEGMENTS.map((segment) => (
      <Card key={segment.id}>
        <CardContent className="p-4">
          <div className="flex items-center justify-between mb-2">
            <Badge style={{ backgroundColor: segment.color }}>
              {segment.name}
            </Badge>
            <span className="text-2xl font-bold">
              {segment.count}
            </span>
          </div>
          <p className="text-xs text-secondary">{segment.description}</p>
          <div className="mt-2">
            <Progress value={segment.percentage} />
            <p className="text-xs text-secondary mt-1">
              {segment.percentage}% от всех гостей
            </p>
          </div>
        </CardContent>
      </Card>
    ))}
  </div>
  
  {/* RFM Scatter Plot */}
  <Card>
    <CardHeader>
      <CardTitle>RFM сегментация</CardTitle>
      <CardDescription>
        Recency (дни), Frequency (визиты), Monetary (траты)
      </CardDescription>
    </CardHeader>
    <CardContent>
      <ResponsiveContainer width="100%" height={400}>
        <ScatterChart>
          <CartesianGrid strokeDasharray="3 3" stroke="#262626" />
          <XAxis 
            dataKey="recency" 
            name="Дней с визита" 
            stroke="#a1a1a1"
          />
          <YAxis 
            dataKey="frequency" 
            name="Визитов" 
            stroke="#a1a1a1"
          />
          <Tooltip 
            cursor={{ strokeDasharray: '3 3' }}
            content={<CustomTooltip />}
          />
          <Legend />
          
          {RFM_SEGMENTS.map((segment) => (
            <Scatter
              key={segment.id}
              name={segment.name}
              data={segment.data}
              fill={segment.color}
            />
          ))}
        </ScatterChart>
      </ResponsiveContainer>
    </CardContent>
  </Card>
  
  {/* Guest Lifecycle Funnel */}
  <Card>
    <CardHeader>
      <CardTitle>Воронка гостей</CardTitle>
    </CardHeader>
    <CardContent>
      <FunnelChart data={LIFECYCLE_FUNNEL} />
    </CardContent>
  </Card>
  
  {/* Cohort Retention */}
  <Card>
    <CardHeader>
      <CardTitle>Cohort Retention Analysis</CardTitle>
      <CardDescription>
        Процент гостей, вернувшихся после регистрации
      </CardDescription>
    </CardHeader>
    <CardContent>
      <CohortHeatmap data={COHORT_DATA} />
    </CardContent>
  </Card>
  
  {/* Churn Risk Table */}
  <Card>
    <CardHeader>
      <CardTitle className="flex items-center gap-2">
        <AlertTriangle className="h-5 w-5 text-warning" />
        Риск оттока ({churnRiskGuests.length})
      </CardTitle>
      <CardDescription>
        Гости, которых можно потерять
      </CardDescription>
    </CardHeader>
    <CardContent>
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Гость</TableHead>
            <TableHead>Последний визит</TableHead>
            <TableHead>Lifetime Spent</TableHead>
            <TableHead>Риск</TableHead>
            <TableHead>Действие</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {churnRiskGuests.map((guest) => (
            <TableRow key={guest.id}>
              <TableCell>
                <div className="flex items-center gap-2">
                  <Avatar className="h-8 w-8">
                    <AvatarFallback>
                      {getInitials(guest.firstName, guest.lastName)}
                    </AvatarFallback>
                  </Avatar>
                  <div>
                    <div className="font-medium">
                      {guest.firstName} {guest.lastName}
                    </div>
                    <div className="text-sm text-secondary">
                      {guest.phone}
                    </div>
                  </div>
                </div>
              </TableCell>
              <TableCell>
                <span className="text-warning">
                  {formatRelative(guest.lastVisit)}
                </span>
              </TableCell>
              <TableCell className="font-medium">
                {formatCurrency(guest.lifetimeSpent)}
              </TableCell>
              <TableCell>
                <Badge variant={RISK_VARIANTS[guest.riskLevel]}>
                  {guest.riskLevel}
                </Badge>
              </TableCell>
              <TableCell>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => sendWinbackOffer(guest)}
                >
                  <Send className="mr-2 h-4 w-4" />
                  Вернуть
                </Button>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </CardContent>
  </Card>
</TabsContent>
```


***

### **1️⃣8️⃣ Loyalty ROI Tab - как показать эффективность программы?**

**Контекст:**
Admin хочет понять: работает ли loyalty программа? Сколько приносит выручки на 1₽ потраченных баллов?

**Вопрос:**
Какие метрики показать?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ:**

**Key Metrics:**

1. **ROI** - 1:8.4 (на 1₽ баллов → 8.4₽ выручки)
2. **Earned vs Redeemed** - Начислено: 45,680 | Списано: 12,340 (27% redemption rate)
3. **Avg Check Lift** - +18% у гостей с баллами vs без баллов
4. **Repeat Rate** - 68% гостей с loyalty возвращаются vs 34% без loyalty

**Charts:**

1. **Balls Flow (Sankey Diagram)**
    - Earned → Active Balance → Redeemed
    - Earned → Active Balance → Expired
2. **Revenue Impact (Stacked Bar)**
    - С loyalty баллами (зелёный)
    - Без loyalty (серый)
    - По месяцам
3. **Level Distribution Performance**
    - Столбцы: Bronze, Silver, Gold, Platinum
    - Метрики на уровень: Avg Check, Visit Frequency, Lifetime Value

**UI:**

```tsx
<TabsContent value="loyalty" className="space-y-6">
  <div>
    <h3 className="text-xl font-bold">Loyalty ROI</h3>
    <p className="text-sm text-secondary mt-1">
      Эффективность программы лояльности
    </p>
  </div>
  
  {/* Key Metrics */}
  <div className="grid grid-cols-4 gap-4">
    <Card>
      <CardContent className="p-6">
        <div className="text-sm text-secondary mb-2">ROI</div>
        <div className="text-3xl font-bold text-success">1:8.4</div>
        <p className="text-xs text-secondary mt-2">
          На 1₽ баллов → 8.4₽ выручки
        </p>
      </CardContent>
    </Card>
    
    <Card>
      <CardContent className="p-6">
        <div className="text-sm text-secondary mb-2">Redemption Rate</div>
        <div className="text-3xl font-bold">27%</div>
        <p className="text-xs text-secondary mt-2">
          12,340 из 45,680 списано
        </p>
      </CardContent>
    </Card>
    
    <Card>
      <CardContent className="p-6">
        <div className="text-sm text-secondary mb-2">Avg Check Lift</div>
        <div className="text-3xl font-bold text-success">+18%</div>
        <p className="text-xs text-secondary mt-2">
          Гости с баллами vs без
        </p>
      </CardContent>
    </Card>
    
    <Card>
      <CardContent className="p-6">
        <div className="text-sm text-secondary mb-2">Repeat Rate</div>
        <div className="text-3xl font-bold text-success">68%</div>
        <p className="text-xs text-secondary mt-2">
          С loyalty vs 34% без
        </p>
      </CardContent>
    </Card>
  </div>
  
  {/* Charts Grid */}
  <div className="grid grid-cols-2 gap-6">
    <Card>
      <CardHeader>
        <CardTitle>Balls Flow</CardTitle>
      </CardHeader>
      <CardContent>
        <SankeyChart data={BALLS_FLOW} />
      </CardContent>
    </Card>
    
    <Card>
      <CardHeader>
        <CardTitle>Revenue Impact</CardTitle>
      </CardHeader>
      <CardContent>
        <ResponsiveContainer width="100%" height={300}>
          <BarChart data={REVENUE_IMPACT}>
            <CartesianGrid strokeDasharray="3 3" stroke="#262626" />
            <XAxis dataKey="month" stroke="#a1a1a1" />
            <YAxis stroke="#a1a1a1" />
            <Tooltip />
            <Legend />
            <Bar dataKey="withLoyalty" fill="#10b981" name="С loyalty" stackId="a" />
            <Bar dataKey="withoutLoyalty" fill="#6b7280" name="Без loyalty" stackId="a" />
          </BarChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  </div>
  
  {/* Level Performance */}
  <Card>
    <CardHeader>
      <CardTitle>Производительность по уровням</CardTitle>
    </CardHeader>
    <CardContent>
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Уровень</TableHead>
            <TableHead>Гостей</TableHead>
            <TableHead>Avg Check</TableHead>
            <TableHead>Visit Frequency</TableHead>
            <TableHead>Lifetime Value</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {LEVEL_PERFORMANCE.map((level) => (
            <TableRow key={level.name}>
              <TableCell>
                <div className="flex items-center gap-2">
                  <span className="text-xl">{level.icon}</span>
                  <span className="font-medium">{level.name}</span>
                </div>
              </TableCell>
              <TableCell>{level.guestsCount}</TableCell>
              <TableCell className="font-medium">
                {formatCurrency(level.avgCheck)}
              </TableCell>
              <TableCell>
                {level.visitFrequency} раз/мес
              </TableCell>
              <TableCell className="font-medium text-success">
                {formatCurrency(level.ltv)}
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </CardContent>
  </Card>
</TabsContent>
```


***

## **⚙️ 5. SETTINGS \& TEAM**

### **1️⃣9️⃣ Restaurant Settings - какие настройки дать Admin?**

**Контекст:**
Admin настраивает ресторан: название, адрес, часы работы, loyalty параметры, POS интеграцию.[^10_1]

**Вопрос:**
Как организовать Settings Page?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: 6 табов (General | Loyalty | POS | Notifications | Team | Security)**

**Settings Tabs:**

```tsx
<Tabs defaultValue="general">
  <TabsList className="grid w-full grid-cols-6">
    <TabsTrigger value="general">Основные</TabsTrigger>
    <TabsTrigger value="loyalty">Loyalty</TabsTrigger>
    <TabsTrigger value="pos">POS</TabsTrigger>
    <TabsTrigger value="notifications">Уведомления</TabsTrigger>
    <TabsTrigger value="team">Команда</TabsTrigger>
    <TabsTrigger value="security">Безопасность</TabsTrigger>
  </TabsList>
  
  {/* Tab Contents */}
</Tabs>
```

**General Tab:**

- Название ресторана, логотип
- Адрес, телефон, email, сайт
- Часы работы (каждый день недели)
- Timezone
- Язык интерфейса

**Loyalty Tab:**

- Ball conversion (1 балл = X₽)
- Redeem limit (10-100% от чека)
- Min check amount (минимум для начисления)
- Inactivity expiration (90 дней без активности → сгорание)
- Transfer settings (разрешить/запретить, лимиты)

**POS Tab:**

- Выбор POS системы (iiko, R-Keeper, Poster)
- API credentials (encrypted)
- Webhook URL
- Sync frequency
- Test connection button
- Last sync status

**Notifications Tab:**

- Channels (Telegram, Email, SMS)
- Templates customization
- Rate limits (сколько уведомлений в день)
- Quiet hours (23:00-09:00)

**Team Tab:**

- Список пользователей (Admin, Manager, Cashier)
- Роли и permissions
- Invite new user
- Activity log

**Security Tab:**

- Change password
- Two-factor authentication (включить/выключить)
- Active sessions (список устройств)
- API tokens management
- Audit log

***

### **2️⃣0️⃣ Team Management - как Admin управляет командой?**

**Контекст:**
Admin может приглашать Manager'ов и Cashier'ов, назначать permissions, блокировать пользователей.[^10_3][^10_2]

**Вопрос:**
Какой UI для управления командой?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: Table + Invite Modal**

**Team Table:**

```tsx
<Card>
  <CardHeader>
    <div className="flex items-center justify-between">
      <div>
        <CardTitle>Команда ({teamMembers.length})</CardTitle>
        <CardDescription>
          Управление пользователями и разрешениями
        </CardDescription>
      </div>
      <Button onClick={openInviteModal}>
        <UserPlus className="mr-2 h-4 w-4" />
        Пригласить
      </Button>
    </div>
  </CardHeader>
  <CardContent>
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Пользователь</TableHead>
          <TableHead>Роль</TableHead>
          <TableHead>Email</TableHead>
          <TableHead>Телефон</TableHead>
          <TableHead>Статус</TableHead>
          <TableHead>Последний вход</TableHead>
          <TableHead></TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {teamMembers.map((member) => (
          <TableRow key={member.id}>
            <TableCell>
              <div className="flex items-center gap-3">
                <Avatar>
                  {member.avatar ? (
                    <AvatarImage src={member.avatar} />
                  ) : (
                    <AvatarFallback>
                      {getInitials(member.firstName, member.lastName)}
                    </AvatarFallback>
                  )}
                </Avatar>
                <div>
                  <div className="font-medium">
                    {member.firstName} {member.lastName}
                  </div>
                  {member.isCurrentUser && (
                    <Badge variant="outline" className="text-xs">Вы</Badge>
                  )}
                </div>
              </div>
            </TableCell>
            <TableCell>
              <Badge variant={ROLE_VARIANTS[member.role]}>
                {ROLE_NAMES[member.role]}
              </Badge>
            </TableCell>
            <TableCell>{member.email}</TableCell>
            <TableCell>{formatPhone(member.phone)}</TableCell>
            <TableCell>
              <Badge variant={member.status === 'ACTIVE' ? 'success' : 'secondary'}>
                {member.status === 'ACTIVE' ? '✓ Активен' : '⏳ Приглашён'}
              </Badge>
            </TableCell>
            <TableCell>
              {member.lastLoginAt ? formatRelative(member.lastLoginAt) : '—'}
            </TableCell>
            <TableCell>
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button variant="ghost" size="sm">
                    <MoreVertical className="h-4 w-4" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end">
                  <DropdownMenuItem onClick={() => editMember(member)}>
                    <Edit className="mr-2 h-4 w-4" />
                    Редактировать
                  </DropdownMenuItem>
                  <DropdownMenuItem onClick={() => viewPermissions(member)}>
                    <Shield className="mr-2 h-4 w-4" />
                    Права доступа
                  </DropdownMenuItem>
                  {member.status === 'INVITED' && (
                    <DropdownMenuItem onClick={() => resendInvite(member)}>
                      <Mail className="mr-2 h-4 w-4" />
                      Отправить приглашение
                    </DropdownMenuItem>
                  )}
                  <DropdownMenuSeparator />
                  <DropdownMenuItem
                    onClick={() => removeMember(member)}
                    className="text-danger"
                    disabled={member.isCurrentUser}
                  >
                    <Trash2 className="mr-2 h-4 w-4" />
                    Удалить
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  </CardContent>
</Card>
```

**Invite User Modal:**

```tsx
<Dialog open={showInviteModal} onOpenChange={setShowInviteModal}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Пригласить пользователя</DialogTitle>
    </DialogHeader>
    
    <form onSubmit={handleInvite} className="space-y-4">
      <div>
        <Label>Email *</Label>
        <Input
          type="email"
          placeholder="manager@example.com"
          value={invite.email}
          onChange={(e) => setInvite({ ...invite, email: e.target.value })}
          required
        />
      </div>
      
      <div>
        <Label>Роль *</Label>
        <Select
          value={invite.role}
          onValueChange={(value) => setInvite({ ...invite, role: value })}
        >
          <SelectTrigger>
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="MANAGER">
              <div>
                <div className="font-medium">Manager</div>
                <div className="text-xs text-secondary">
                  Управление гостями, loyalty, аналитика
                </div>
              </div>
            </SelectItem>
            <SelectItem value="CASHIER">
              <div>
                <div className="font-medium">Cashier</div>
                <div className="text-xs text-secondary">
                  Работа с гостями на кассе
                </div>
              </div>
            </SelectItem>
          </SelectContent>
        </Select>
      </div>
      
      {invite.role === 'MANAGER' && (
        <div>
          <Label>Permissions</Label>
          <div className="space-y-2 mt-2 p-4 border rounded-lg">
            {MANAGER_PERMISSIONS.map((permission) => (
              <div key={permission.id} className="flex items-start gap-2">
                <Checkbox
                  id={permission.id}
                  checked={invite.permissions?.includes(permission.id)}
                  onCheckedChange={(checked) => {
                    if (checked) {
                      setInvite({
                        ...invite,
                        permissions: [...(invite.permissions || []), permission.id]
                      });
                    } else {
                      setInvite({
                        ...invite,
                        permissions: invite.permissions?.filter(p => p !== permission.id)
                      });
                    }
                  }}
                />
                <div className="flex-1">
                  <Label htmlFor={permission.id} className="font-normal cursor-pointer">
                    {permission.name}
                  </Label>
                  <p className="text-xs text-secondary">{permission.description}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
      
      <Alert>
        <Info className="h-4 w-4" />
        <AlertDescription>
          На указанный email будет отправлено приглашение для создания аккаунта
        </AlertDescription>
      </Alert>
    </form>
    
    <DialogFooter>
      <Button variant="outline" onClick={() => setShowInviteModal(false)}>
        Отмена
      </Button>
      <Button onClick={sendInvite}>
        Отправить приглашение
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```


***

## **📱 6. MOBILE \& RESPONSIVE**

### **2️⃣1️⃣ Mobile View - как адаптировать Admin Dashboard для мобильных?**

**Контекст:**
Admin может заходить с телефона для быстрых операций (добавить гостя, проверить баланс, начислить баллы).

**Вопрос:**
Как адаптировать для mobile?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ:**

**Mobile Layout (< 768px):**

```
┌──────────────────────────┐
│ [☰] Max Loyalty    [🔔]  │ ← Top Bar (fixed)
├──────────────────────────┤
│                           │
│ Dashboard Content         │
│ (scrollable)              │
│                           │
├──────────────────────────┤
│ [🏠][👥][🎁][📊][⚙️]    │ ← Bottom Nav (fixed)
└──────────────────────────┘
```

**Sidebar → Bottom Navigation:**

- 🏠 Dashboard
- 👥 Guests
- 🎁 Loyalty
- 📊 Analytics
- ⚙️ Settings

**Hamburger Menu (Sidebar overlay):**

- Profile
- Team
- Activity Log
- Support
- Logout

**Guest Table → Cards:**

```tsx
<Card className="mb-3" onClick={() => viewGuest(guest.id)}>
  <CardContent className="p-4">
    <div className="flex items-start justify-between mb-3">
      <div className="flex items-center gap-3">
        <Avatar>
          <AvatarFallback>ИИ</AvatarFallback>
        </Avatar>
        <div>
          <div className="font-medium">Иван Иванов</div>
          <div className="text-sm text-secondary">+7 999 123-45-67</div>
        </div>
      </div>
      <Badge>🥇 Gold</Badge>
    </div>
    
    <div className="grid grid-cols-2 gap-3 text-sm">
      <div>
        <div className="text-secondary">Баланс</div>
        <div className="font-medium">2,850 баллов</div>
      </div>
      <div>
        <div className="text-secondary">Посещений</div>
        <div className="font-medium">47</div>
      </div>
    </div>
    
    <div className="mt-3 flex items-center justify-between text-sm">
      <span className="text-secondary">Последний визит</span>
      <span>2 дня назад</span>
    </div>
  </CardContent>
</Card>
```

**Quick Actions (Floating Action Button):**

```tsx
<div className="fixed bottom-20 right-4 z-40">
  <DropdownMenu>
    <DropdownMenuTrigger asChild>
      <Button size="lg" className="rounded-full h-14 w-14 shadow-lg">
        <Plus className="h-6 w-6" />
      </Button>
    </DropdownMenuTrigger>
    <DropdownMenuContent align="end" className="w-56">
      <DropdownMenuItem onClick={openAddGuest}>
        <UserPlus className="mr-2 h-4 w-4" />
        Добавить гостя
      </DropdownMenuItem>
      <DropdownMenuItem onClick={openAdjustBalls}>
        <Gift className="mr-2 h-4 w-4" />
        Корректировка баллов
      </DropdownMenuItem>
      <DropdownMenuItem onClick={openCreatePromo}>
        <Sparkles className="mr-2 h-4 w-4" />
        Создать промо
      </DropdownMenuItem>
    </DropdownMenuContent>
  </DropdownMenu>
</div>
```


***

## **🔗 7. POS INTEGRATION**

### **2️⃣2️⃣ POS Integration Setup - как Admin настраивает интеграцию?**

**Контекст:**
Admin подключает iiko или R-Keeper для автоматического начисления/списания баллов при продаже.[^10_2][^10_1]

**Вопрос:**
Какой UI для настройки POS?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: Step-by-Step Wizard + Status Dashboard**

**POS Integration Page:**

```tsx
<div className="space-y-6">
  {!hasIntegration ? (
    // Setup Wizard
    <Card>
      <CardHeader>
        <CardTitle>Подключение POS системы</CardTitle>
        <CardDescription>
          Автоматическое начисление и списание баллов при продажах
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-3 gap-4">
          {POS_PROVIDERS.map((provider) => (
            <Card
              key={provider.id}
              className="cursor-pointer hover:border-primary transition"
              onClick={() => selectProvider(provider)}
            >
              <CardContent className="p-6 text-center">
                <img
                  src={provider.logo}
                  alt={provider.name}
                  className="h-16 mx-auto mb-4"
                />
                <h3 className="font-semibold mb-2">{provider.name}</h3>
                <Badge variant="outline">{provider.type}</Badge>
              </CardContent>
            </Card>
          ))}
        </div>
      </CardContent>
    </Card>
  ) : (
    // Integration Status
    <>
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <img
                src={integration.provider.logo}
                alt={integration.provider.name}
                className="h-12"
              />
              <div>
                <CardTitle>{integration.provider.name}</CardTitle>
                <CardDescription>
                  {integration.method === 'WEBHOOK' ? 'Webhook (Push)' : 'API Polling (Pull)'}
                </CardDescription>
              </div>
            </div>
            <Badge variant={integration.status === 'ACTIVE' ? 'success' : 'destructive'}>
              {integration.status === 'ACTIVE' ? '✓ Активна' : '✕ Ошибка'}
            </Badge>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-3 gap-4">
            <div>
              <Label className="text-xs text-secondary">Последняя синхронизация</Label>
              <p className="font-medium">{formatRelative(integration.lastSync)}</p>
            </div>
            <div>
              <Label className="text-xs text-secondary">Транзакций сегодня</Label>
              <p className="font-medium">{integration.todayTransactions}</p>
            </div>
            <div>
              <Label className="text-xs text-secondary">Ошибок</Label>
              <p className="font-medium text-danger">{integration.errorsCount}</p>
            </div>
          </div>
          
          {integration.method === 'WEBHOOK' && (
            <div>
              <Label className="text-xs">Webhook URL</Label>
              <div className="flex gap-2 mt-1">
                <Input
                  value={integration.webhookUrl}
                  readOnly
                  className="font-mono text-sm"
                />
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => copyToClipboard(integration.webhookUrl)}
                >
                  <Copy className="h-4 w-4" />
                </Button>
              </div>
              <p className="text-xs text-secondary mt-1">
                Укажите этот URL в настройках {integration.provider.name}
              </p>
            </div>
          )}
          
          <div className="flex gap-2">
            <Button onClick={testConnection}>
              <Zap className="mr-2 h-4 w-4" />
              Тестировать подключение
            </Button>
            <Button variant="outline" onClick={viewSyncLog}>
              <FileText className="mr-2 h-4 w-4" />
              Лог синхронизации
            </Button>
            <Button variant="outline" onClick={editIntegration}>
              <Settings className="mr-2 h-4 w-4" />
              Настройки
            </Button>
          </div>
        </CardContent>
      </Card>
      
      {/* Recent Transactions */}
      <Card>
        <CardHeader>
          <CardTitle>Последние транзакции из POS</CardTitle>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Дата</TableHead>
                <TableHead>Чек №</TableHead>
                <TableHead>Гость</TableHead>
                <TableHead>Сумма</TableHead>
                <TableHead>Начислено</TableHead>
                <TableHead>Списано</TableHead>
                <TableHead>Статус</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {posTransactions.map((tx) => (
                <TableRow key={tx.id}>
                  <TableCell>{formatDateTime(tx.createdAt)}</TableCell>
                  <TableCell className="font-mono">{tx.checkId}</TableCell>
                  <TableCell>{tx.guestName || tx.guestPhone}</TableCell>
                  <TableCell>{formatCurrency(tx.checkAmount)}</TableCell>
                  <TableCell className="text-success">
                    {tx.earnedPoints ? `+${tx.earnedPoints}` : '—'}
                  </TableCell>
                  <TableCell className="text-danger">
                    {tx.redeemedPoints ? `−${tx.redeemedPoints}` : '—'}
                  </TableCell>
                  <TableCell>
                    <Badge variant={tx.status === 'SUCCESS' ? 'success' : 'destructive'}>
                      {tx.status}
                    </Badge>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </>
  )}
</div>
```


***

## **🎯 8. FINAL QUESTIONS**

### **2️⃣3️⃣ Notifications System - как Admin получает уведомления?**

**Контекст:**
Admin должен быть уведомлён о важных событиях: новый гость, превышен лимит тарифа, ошибка POS sync, гость at-risk.

**Вопрос:**
Какие уведомления показать?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ:**

**Notification Types:**

- 👤 NEW_GUEST - Новый гость зарегистрировался
- 🎂 BIRTHDAY_TODAY - У гостя день рождения сегодня
- ⚠️ AT_RISK_GUEST - Гость давно не был (at-risk churn)
- 📉 LOW_BALANCE - У гостя заканчиваются баллы
- 🔥 POS_ERROR - Ошибка синхронизации с POS
- 📊 LIMIT_WARNING - Приближение к лимиту тарифа (90%)
- 💰 HIGH_VALUE_GUEST - Гость достиг нового уровня

**Bell Icon + Dropdown (как у Owner):**

- Badge с количеством непрочитанных
- Dropdown со списком уведомлений
- Группировка по типу
- Mark as read
- Settings (какие уведомления получать)

***

### **2️⃣4️⃣ Export \& Reports - какие отчёты нужны Admin?**

**Контекст:**
Admin экспортирует данные для отчётности, анализа, email-рассылок.

**Вопрос:**
Какие отчёты предоставить?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ:**

**Reports:**

1. **Guests Report** - список гостей с фильтрами (CSV, XLSX)
2. **Transactions Report** - все транзакции с баллами за период
3. **Revenue Report** - выручка, чеки, средний чек
4. **Loyalty ROI Report** - эффективность программы
5. **Birthday Report** - список гостей с ДР в этом месяце
6. **At-Risk Report** - гости с риском оттока

**Export Formats:** CSV, XLSX, PDF

**Scheduled Reports:**

- Weekly Summary (каждый понедельник)
- Monthly Report (1-го числа)
- Custom Schedule

***

### **2️⃣5️⃣ Onboarding Flow - как новый Admin знакомится с системой?**

**Контекст:**
Admin первый раз заходит в систему после регистрации/приглашения.

**Вопрос:**
Показать ли onboarding?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: ДА, Interactive Onboarding (4 шага)**

**Steps:**

1. **Welcome** - "Добро пожаловать в Max Loyalty! Настроим всё за 2 минуты"
2. **Restaurant Info** - Название, адрес, логотип (form)
3. **Loyalty Settings** - Ball conversion, redeem limit (form с подсказками)
4. **Invite Team** - Пригласить Manager/Cashier (optional, skip)
5. **Ready!** - "Всё готово! Начните с добавления первого гостя"

**UI:** Modal с прогресс-баром, кнопки "Назад" / "Далее" / "Пропустить"

**Skip option:** "Настроить позже" → Dashboard

***

# ✅ **ИТОГО: 25 ВОПРОСОВ ADMIN DASHBOARD РЕШЕНЫ!**

**Готов к финальному подведению итогов?** Хочешь чтобы я:

1. **Составил полный список всех 25 решений** (вопрос → решение → обоснование) для Admin Dashboard?
2. **Перешёл к следующему блоку** (Manager Dashboard, Cashier POS Interface, Guest Telegram Mini App, или другое)?

**Что делаем дальше?** 🚀

<div align="center">⁂</div>

[^10_1]: Beseda-8.md

[^10_2]: Beseda-2.md

[^10_3]: Beseda-3.md


---

# 📋 **ADMIN DASHBOARD (RESTAURANTADMIN) - ФИНАЛЬНЫЕ РЕШЕНИЯ ПО 25 ВОПРОСАМ**


***

## **📊 1. DASHBOARD LAYOUT \& STRUCTURE**

### **Вопрос 1: Структура Admin Dashboard - чем отличается от Owner?**

**Принятое решение:** Dashboard Home + отдельные страницы с Sidebar Navigation

**Обоснование:**

- Admin управляет одним рестораном (или несколькими в рамках тенанта), но НЕ видит другие тенанты платформы
- Scalability - много разделов (Guests, Loyalty, Analytics, Team, Settings)
- Performance - lazy loading по роутам, не загружаем всё сразу
- UX - Admin работает с конкретными задачами, не нужна вся информация на одной странице
- Соответствует примерам из файлов - sidebar навигация стандартна для multi-section дашбордов
- SEO/Deep linking - можно шарить прямые ссылки на конкретные страницы

**Структура роутов:**

```
/admin/dashboard          → Overview
/admin/guests             → Guests Management
/admin/loyalty            → Loyalty Builder
/admin/analytics          → Analytics & Reports
/admin/pos                → POS Integration
/admin/team               → Team Management
/admin/settings           → Restaurant Settings
/admin/activity-log       → Activity Log
```


***

### **Вопрос 2: Dashboard Home - какие метрики показать Admin?**

**Принятое решение:** Всего гостей | Активных (30 дней) | Баллов начислено | Loyalty ROI

**Обоснование:**

- **Всего гостей** - базовая метрика роста клиентской базы (например: 2,847)
- **Активные гости (30 дней)** - показывает реальную активность, а не просто общее число (например: 1,876 = 66%)
- **Баллов начислено за месяц** - показывает вовлечённость loyalty программы (45,680)
- **Loyalty ROI** - ключевая метрика эффективности: сколько выручки приносит 1₽ потраченных баллов (1:8.4 → на 1₽ баллов = 8.4₽ выручки)

**Дополнительные метрики (вторая строка):**

- Выручка за месяц
- Средний чек
- Визитов за месяц
- NPS Score

***

### **Вопрос 3: Dashboard Charts - какие графики показать?**

**Принятое решение:** 4 графика (Guests Growth | Revenue + Balls | Loyalty Levels | Top 10 Guests)

**Обоснование:**

**График 1: Guests Growth (Line Chart, 6 месяцев)**

- Показывает рост базы гостей
- Визуально понятный тренд (вверх = хорошо)
- Зелёная линия с точками

**График 2: Revenue + Balls Earned (Combined Chart, 30 дней)**

- Bar chart для выручки по дням
- Line chart для начисленных баллов
- Показывает корреляцию: больше выручка → больше баллов начислено

**График 3: Loyalty Levels Distribution (Donut Chart)**

- Распределение гостей по уровням (Bronze, Silver, Gold, Platinum)
- Donut с центральной метрикой "Всего гостей"
- Клик на сегмент → фильтрация таблицы гостей по уровню

**График 4: Top 10 Guests Leaderboard**

- Список топ-10 гостей по Lifetime Spent
- Аватары (инициалы), имя, уровень, сумма
- Показывает VIP клиентов ресторана для персонального внимания

***

### **Вопрос 4: Quick Actions Panel - что Admin делает чаще всего?**

**Принятое решение:** 4 карточки (Добавить гостя | Ручная корректировка | Создать промо | Экспорт)

**Обоснование:**

- **➕ Добавить гостя** - самое частое действие (регистрация на кассе вручную)
- **✏️ Ручная корректировка баллов** - Admin часто нужно начислить/списать баллы (компенсация за ошибку, промо, goodwill)
- **🎁 Создать промо-акцию** - быстрый запуск акции (день рождения, выходные, новый товар)
- **📥 Экспорт гостей** - выгрузка базы для email-рассылок, анализа в Excel

**UI:** Cards Grid в 4 колонки, каждая карточка кликабельна, открывает соответствующий модал

***

## **👥 2. GUESTS MANAGEMENT PAGE**

### **Вопрос 5: Guests Table - какие колонки показать Admin?**

**Принятое решение:** Имя с аватаром | Телефон | День рождения | Уровень | Баланс | Посещений | Последний визит | Действия

**Обоснование:**

- **Имя с аватаром (инициалы)** - визуальная идентификация как в примере Guests-Enhanced-V4.html
- **Телефон** - основной идентификатор, по нему ищут гостя на кассе
- **День рождения** - важно для промо-акций "День рождения" + показывается знак зодиака (♉, ♐, ♓)
- **Уровень** - Badge с эмодзи (🥉 Bronze, 🥈 Silver, 🥇 Gold, 👑 Platinum)
- **Баланс** - сколько баллов у гостя сейчас (Regular + Promo отдельно)
- **Посещений** - показывает лояльность (47 визитов = постоянный клиент)
- **Последний визит** - "2 дня назад" - показывает активность/риск оттока
- **Действия** - Dropdown: Просмотр деталей | Редактировать | Корректировка баллов | История | Удалить

**Optional columns** (настраиваются через Table Settings):

- Email, Lifetime Spent, Средний чек, Дата регистрации, Источник, Дети, Теги

***

### **Вопрос 6: Guest Search - как искать гостей?**

**Принятое решение:** Поиск по имени + телефон + email + карта (QR/6-digit код)

**Обоснование:**

- **Имя** - "Иван Иванов", "Иван", "Иванов" (fuzzy search для опечаток)
- **Телефон** - "+7 999 123-45-67", "9991234567", "999 123" (partial match)
- **Email** - "ivan@example.com", "ivan" (partial)
- **Карта** - "000123" (6-digit code), "QR-123456" (QR code)
- Быстрый результат через индексы БД (phone, email, cardCode)
- Единое поле поиска - не нужно выбирать "искать по телефону" или "по имени"

**Backend:** Prisma query с OR условиями по всем полям (firstName, lastName, phone, email, guestCard.displayCode, guestCard.qrCode)

***

### **Вопрос 7: Guest Filters - как фильтровать гостей?**

**Принятое решение:** Quick Filter Buttons + Advanced Filters (Dropdown/Popover)

**Обоснование:**

**Quick Filter Buttons (над таблицей):**

- 💎 VIP (Lifetime > 100K)
- ⚠️ At Risk (неактивны 30+ дней)
- 🎂 ДР в этом месяце
- ✨ Новые (зарегистрированы за последние 30 дней)
- 💰 Высокий баланс (>1,000 баллов)

**Advanced Filters (Popover):**

- Уровень (MultiSelect: Bronze, Silver, Gold, Platinum)
- Статус (Active, Inactive, Blocked)
- Баланс баллов (min-max range)
- Количество посещений (min-max range)
- Месяц рождения (dropdown: январь-декабрь)
- Последний визит (7d, 30d, 90d, 180d)

**Причина комбинированного подхода:**

- Quick Filters - для 80% задач (быстрый доступ к нужному сегменту)
- Advanced Filters - для сложной сегментации
- Можно комбинировать (например: VIP + ДР в этом месяце)

***

### **Вопрос 8: Bulk Actions - что Admin может делать с выбранными гостями?**

**Принятое решение:** Экспорт | Добавить баллы | Отправить уведомление | Применить тег | Удалить

**Обоснование:**

- **📥 Экспорт выбранных** - CSV/XLSX для email-рассылок или анализа в Excel
- **🎁 Добавить баллы** - массовое начисление (например: "500 баллов всем Gold гостям на Новый Год")
- **📧 Отправить уведомление** - push через Telegram/Email (например: "Акция выходного дня только для вас")
- **🏷️ Применить тег** - сегментация для последующей работы ("VIP", "Inactive", "Birthdays Feb")
- **🗑️ Удалить** - массовое удаление неактивных/тестовых гостей (с подтверждением)

**UI:** Fixed bottom bar появляется при выборе гостей (checkboxes), показывает количество выбранных + кнопки действий

***

### **Вопрос 9: Guest Profile Page - какие табы показать?**

**Принятое решение:** 6 табов (Overview | Transactions | Visits | Children | Activity Log | Analytics)

**Обоснование:**

**Tab 1: Overview**

- Личная информация (ФИО, телефон, email, ДР, фото)
- Loyalty карточка (уровень, баланс, QR-код, 6-digit код)
- Lifetime статистика (Lifetime Spent, Visits, Avg Check, дата регистрации)
- Quick Actions (Добавить/Списать баллы, Трансфер, Сбросить QR, Отправить сообщение, Заблокировать)

**Tab 2: Transactions**

- Таблица всех операций с баллами: Дата | Тип (Начисление/Списание/Трансфер/Возврат) | Сумма | Причина | Источник (POS/Manual/Promo) | Баланс после операции
- Фильтры по типу, дате, источнику

**Tab 3: Visits**

- Таблица визитов в ресторан: Дата | Ресторан | Сумма чека | Начислено | Списано | Детали
- Статистика: Частота визитов, Любимое время, Любимый день недели, Средний чек

**Tab 4: Children**

- Список детей гостя с ФИО, датой рождения, фото
- Кнопка "Добавить ребёнка"
- Birthday promo для детей автоматически

**Tab 5: Activity Log**

- История всех действий с этим гостем: создание, редактирование профиля, начисления/списания, блокировки, impersonation Owner'ом
- Фильтр по типу действия и дате

**Tab 6: Analytics**

- График визитов по месяцам (trend)
- График трат (Lifetime Spent Trend)
- RFM сегмент (Recency, Frequency, Monetary) с визуализацией
- Рекомендации (например: "Давно не был 45 дней → отправить win-back промо")

***

### **Вопрос 10: Guest Profile Overview Tab - что показать?**

**Принятое решение:** 3 колонки (Personal Info Card | Loyalty Card | Stats + Quick Actions)

**Обоснование:**

- **Left Column: Personal Info** - аватар (upload), ФИО, телефон, email, день рождения + знак зодиака, дата регистрации, источник (POS/Telegram/Web), кнопка "Редактировать"
- **Center Column: Loyalty Card** - уровень с иконкой (🥇 Gold), баланс баллов (крупно), Regular/Promo breakdown, QR-код (150x150px), 6-digit код, кнопки "Сбросить QR" и "Печать карточки"
- **Right Column: Stats + Actions** - Lifetime Spent, Visits Count, Avg Check, Last Visit (все крупными цифрами), Quick Actions (Начислить баллы, Списать баллы, Трансфер, Отправить сообщение, Заблокировать гостя)

**Grid layout:** 3 равные колонки, все в Card компонентах

***

## **🎁 3. LOYALTY BUILDER PAGE**

### **Вопрос 11: Loyalty Builder Structure - как организовать?**

**Принятое решение:** Одна страница с 4 табами (Rules | Levels | Promos | Design)

**Обоснование:**

- Всё в одном месте - Admin видит всю loyalty систему сразу, не теряя контекст
- Переключение между табами быстрее чем навигация между страницами
- Логическая группировка - правила начисления, уровни, промо-акции, дизайн карточки - это связанные сущности loyalty системы
- Соответствует best practices для Builder-интерфейсов

**Tabs:**

- 📏 Правила начисления
- 🏆 Уровни лояльности
- 🎁 Промо-акции
- 🎨 Дизайн карточки

***

### **Вопрос 12: Loyalty Rules Builder - как создавать правила?**

**Принятое решение:** Форма с параметрами + Live Preview (как правило работает на примере чека)

**Обоснование:**

- **Форма** - простота и понятность для Admin (название, процент, условия, приоритет)
- **Live Preview** - сразу видно как правило сработает на примере чека (2,000₽ → 200 баллов)
- **Validation** - подсветка ошибок в реальном времени
- **Examples** - показывает расчёт наглядно
- **Priority system** - правила с меньшим номером выполняются первыми (предотвращает конфликты)

**UI:**

- Список активных правил (Priority 1, 2, 3...) с возможностью drag-and-drop для изменения порядка
- Кнопка "Создать правило" → Modal с формой
- Form: Название, Процент начисления (slider 1-30%), Условия (ConditionBuilder: день рождения, день недели, время, категория товара, минимальная сумма), Приоритет, Статус (active/inactive)
- Live Preview справа показывает пример чека и результат начисления

***

### **Вопрос 13: Loyalty Levels - как Admin настраивает уровни?**

**Принятое решение:** Timeline визуализация (слева направо: Bronze → Silver → Gold → Platinum) + Modal для редактирования

**Обоснование:**

- **Visual** - Admin сразу видит прогрессию уровней с порогами входа (0₽ → 150K → 400K → 1M)
- **Intuitive** - естественный flow "слева направо" = рост клиента
- **One-way up logic** - визуально понятно что клиент не может downgrade на уровень ниже (согласно бизнес-логике из файлов)
- **Editable** - клик на уровень → Modal с детальными настройками (название, иконка, порог, бонус к начислению, цвет)

**Timeline показывает:**

- Иконку уровня (🥉, 🥈, 🥇, 👑)
- Название
- Порог входа (Lifetime Spent)
- Бонус к начислению (+5%, +10%, +15%)
- Количество гостей на уровне
- Стрелки между уровнями (ChevronRight)

**Edit Level Modal:**

- Название, иконка (emoji picker), порог (₽), бонус к начислению (%), цвет (color picker)
- Warning если изменение порога повлияет на текущих гостей (пересчёт уровней автоматический)

***

### **Вопрос 14: Promo Campaigns Builder - как создавать акции?**

**Принятое решение:** Template Gallery + Form для кастомизации

**Обоснование:**

- **Templates** - 80% промо-акций стандартные (День рождения, Выходные, Первый визит, Happy Hour, Возвращение после отсутствия, ДР ребёнка)
- **Быстрый старт** - клик на шаблон → параметры уже заполнены → только настроить детали (количество баллов, даты)
- **Custom option** - можно создать акцию с нуля
- **Visual** - иконки и превью для каждого типа промо

**Promo Templates:**

1. 🎂 День рождения - 500 баллов в ±7 дней от ДР
2. 🎈 ДР ребёнка - 300 баллов на день рождения ребёнка
3. ✨ Первый визит - 1000 баллов приветственный бонус
4. 💤 Возвращение - 500 баллов после 60 дней отсутствия
5. 🎉 Выходные - удвоенные баллы в Сб-Вс
6. 🍹 Happy Hour - множитель 1.5× в 18:00-22:00

**Promo Form:**

- Название, описание
- Тип бонуса: Fixed (500 баллов) | Multiplier (2×) | Percentage (15% от чека)
- Срок действия баллов (7 дней, 30 дней, бессрочно)
- Даты акции (начало, окончание)
- Дополнительные условия (минимальная сумма чека, конкретные рестораны, дни недели)
- Статус (активна/неактивна)

***

### **Вопрос 15: Loyalty Card Design - как кастомизировать дизайн карточки?**

**Принятое решение:** Template Gallery + Color Customizer + Live Preview (Physical \& Digital)

**Обоснование:**

- **Templates** - готовые стили дизайна (Minimal, Modern, Elegant, Fun) для быстрого старта
- **Customizer** - цвета бренда (primary, background, text), логотип (upload), паттерн фона (dots, waves, geometric, gradient)
- **Live Preview** - видно как карточка выглядит в реальном времени:
    - Physical card (для печати)
    - Digital card (в Telegram mini app с синим фоном Telegram UI)
- **Простота** - не нужны дизайн-скиллы, всё через UI

**UI Layout:** 2 колонки

- **Left:** Template gallery, Color pickers (primary, background, text), Logo upload, Background pattern selector
- **Right:** Live Preview с табами Physical/Digital, кнопки "Сбросить" и "Сохранить дизайн"

***

## **📊 4. ANALYTICS PAGE**

### **Вопрос 16: Analytics Dashboard Structure - какие разделы показать?**

**Принятое решение:** 5 табов (Overview | Guests Analysis | Revenue Analysis | Loyalty ROI | Reports)

**Обоснование:**

- **Overview** - общая картина (KPIs + главные графики) для быстрого понимания состояния
- **Guests Analysis** - RFM сегментация, cohort retention, churn risk, lifecycle funnel
- **Revenue Analysis** - выручка по месяцам, средний чек, распределение по источникам, тренды
- **Loyalty ROI** - эффективность программы лояльности (ROI, redemption rate, avg check lift, repeat rate)
- **Reports** - готовые отчёты для экспорта (Guests, Transactions, Revenue, Birthday, At-Risk)

**Tabs navigation:** TabsList с иконками для каждого раздела

***

### **Вопрос 17: Guests Analysis Tab - какие графики показать?**

**Принятое решение:** RFM Scatter Plot | Guest Lifecycle Funnel | Cohort Retention Heatmap | Churn Risk Table

**Обоснование:**

**1. RFM Segmentation Chart (Scatter Plot)**

- X-axis: Recency (дней с последнего визита)
- Y-axis: Frequency (количество визитов)
- Bubble size: Monetary (Lifetime Spent)
- Цвета: Champions (зелёный), Loyal (синий), At Risk (оранжевый), Lost (красный)
- Позволяет визуально увидеть сегменты гостей

**2. Guest Lifecycle Funnel**

- Воронка: Зарегистрировано → Первый визит → Повторный визит → Лояльные (5+) → VIP (20+)
- Показывает проценты конверсии между этапами
- Помогает найти "узкие места" в воронке

**3. Cohort Retention Analysis (Heatmap)**

- Строки: Cohort (месяц регистрации)
- Столбцы: Месяцы с регистрации (0, 1, 2, 3...)
- Цвета: % удержания (100% зелёный → 0% красный)
- Показывает как долго гости остаются активными

**4. Churn Risk Matrix (Table)**

- Гости с риском оттока (не были 30+ дней, но раньше были активные с высоким LTV)
- Столбцы: Имя, Последний визит, Lifetime Spent, Риск оттока (High/Medium/Low), Кнопка "Вернуть" (отправить win-back offer)

**Summary Cards:** Champions, Loyal, At Risk, Lost - с количеством гостей и процентом от общей базы

***

### **Вопрос 18: Loyalty ROI Tab - как показать эффективность программы?**

**Принятое решение:** 4 Key Metrics + 3 Charts (Balls Flow Sankey | Revenue Impact | Level Performance Table)

**Обоснование:**

**Key Metrics:**

1. **ROI: 1:8.4** - на 1₽ баллов → 8.4₽ выручки (показывает прибыльность программы)
2. **Redemption Rate: 27%** - сколько % начисленных баллов списывается (12,340 из 45,680)
3. **Avg Check Lift: +18%** - гости с баллами тратят больше vs гостей без баллов
4. **Repeat Rate: 68% vs 34%** - гости с loyalty возвращаются в 2 раза чаще

**Charts:**

**1. Balls Flow (Sankey Diagram)**

- Earned → Active Balance → Redeemed
- Earned → Active Balance → Expired
- Показывает путь баллов от начисления до использования/сгорания

**2. Revenue Impact (Stacked Bar Chart)**

- Столбцы по месяцам
- Stack: С loyalty (зелёный) + Без loyalty (серый)
- Показывает вклад loyalty в общую выручку

**3. Level Performance Table**

- Строки: Bronze, Silver, Gold, Platinum
- Столбцы: Количество гостей, Avg Check, Visit Frequency, Lifetime Value
- Показывает какие уровни самые прибыльные

***

## **⚙️ 5. SETTINGS \& TEAM**

### **Вопрос 19: Restaurant Settings - какие настройки дать Admin?**

**Принятое решение:** 6 табов (General | Loyalty | POS | Notifications | Team | Security)

**Обоснование:**

**General Tab:**

- Название ресторана, логотип, адрес, телефон, email, сайт
- Часы работы (для каждого дня недели)
- Timezone, язык интерфейса

**Loyalty Tab:**

- Ball conversion rate (1 балл = X₽)
- Redeem limit (10-100% от суммы чека)
- Minimum check amount для начисления
- Inactivity expiration (90 дней → сгорание неактивных баллов)
- Transfer settings (разрешить/запретить перевод между гостями, лимиты)

**POS Tab:**

- Выбор POS системы (iiko, R-Keeper, Poster, Custom)
- API credentials (encrypted хранение)
- Webhook URL
- Sync frequency (realtime, 5min, 15min)
- Test connection button
- Last sync status

**Notifications Tab:**

- Channels (Telegram, Email, SMS)
- Templates customization
- Rate limits (сколько уведомлений в день одному гостю)
- Quiet hours (23:00-09:00 не отправлять)

**Team Tab:**

- Список пользователей (Admin, Manager, Cashier)
- Роли и permissions
- Invite new user
- Activity log команды

**Security Tab:**

- Change password
- Two-factor authentication (включить/выключить)
- Active sessions (список устройств с IP и временем)
- API tokens management
- Audit log (история входов и критических действий)

***

### **Вопрос 20: Team Management - как Admin управляет командой?**

**Принятое решение:** Table с пользователями + Invite Modal для приглашения новых

**Обоснование:**

- **Table** показывает: Аватар + Имя, Роль (Badge), Email, Телефон, Статус (Active/Invited), Последний вход, Dropdown Actions (Редактировать, Права доступа, Отправить приглашение повторно, Удалить)
- **Invite Modal** - форма: Email, Роль (Manager/Cashier), Permissions (checkboxes для Manager), кнопка "Отправить приглашение"
- Пользователь с ролью Admin не может удалить сам себя (disabled)
- Invited status - пока пользователь не принял приглашение

**Manager Permissions (checkboxes):**

- Управление гостями (CRUD)
- Корректировка баллов вручную
- Создание промо-акций
- Просмотр аналитики
- Экспорт данных
- Управление настройками loyalty
- Управление командой (invite/remove)

**Cashier** - ограниченные права: только работа с гостями на кассе (поиск, просмотр баланса, начисление/списание по чеку)

***

## **📱 6. MOBILE \& RESPONSIVE**

### **Вопрос 21: Mobile View - как адаптировать Admin Dashboard для мобильных?**

**Принятое решение:** Responsive Layout с Bottom Navigation + Hamburger Menu

**Обоснование:**

- **Mobile Layout (< 768px):**
    - Top Bar (fixed) - Logo, Notifications Bell, Hamburger Menu
    - Content Area (scrollable)
    - Bottom Navigation (fixed) - 5 иконок: Dashboard, Guests, Loyalty, Analytics, Settings

**Sidebar → Bottom Nav:**

- Главные разделы в Bottom Nav для быстрого доступа
- Остальные пункты (Team, Activity Log, Support) в Hamburger Menu

**Guest Table → Mobile Cards:**

- Каждый гость = Card с аватаром, именем, телефоном, уровнем (Badge), балансом, посещениями
- Tap на карточку → открывает Guest Profile

**Quick Actions → Floating Action Button (FAB):**

- Fixed bottom-right (над Bottom Nav)
- Tap → Dropdown Menu: Добавить гостя, Корректировка баллов, Создать промо

**KPI Metrics:** 2 колонки (вместо 4 на desktop)

**Charts:** Full width, стекируются вертикально, упрощённые (меньше labels для экономии места)

***

## **🔗 7. POS INTEGRATION**

### **Вопрос 22: POS Integration Setup - как Admin настраивает интеграцию?**

**Принятое решение:** Step-by-Step Wizard (если нет интеграции) + Status Dashboard (если интеграция активна)

**Обоснование:**

**Setup Wizard (первая настройка):**

- Выбор POS провайдера (iiko, R-Keeper, Poster) - карточки с логотипами
- Клик → Modal с формой настройки:
    - API URL/Endpoint
    - API Key/Secret (encrypted)
    - Метод синхронизации: Webhook (push) или API Polling (pull)
    - Test Connection button
- После успешного подключения → redirect на Status Dashboard

**Status Dashboard (когда интеграция есть):**

- **Header:** Logo POS, название, метод (Webhook/Polling), статус (✓ Активна / ✕ Ошибка)
- **Metrics:** Последняя синхронизация, Транзакций сегодня, Ошибок за сутки
- **Webhook URL** (если метод = webhook) - поле с копированием, инструкция где указать в POS
- **Actions:** Тестировать подключение, Лог синхронизации, Настройки, Отключить интеграцию

**Recent Transactions from POS Table:**

- Последние 20 транзакций из POS
- Столбцы: Дата, Чек №, Гость (имя/телефон), Сумма, Начислено, Списано, Статус (Success/Error)
- Показывает что синхронизация работает

**Benefits:**

- Admin понимает что происходит с интеграцией
- Видит ошибки сразу (если есть)
- Может тестировать connection вручную

***

## **🎯 8. FINAL QUESTIONS**

### **Вопрос 23: Notifications System - как Admin получает уведомления?**

**Принятое решение:** Bell Icon + Dropdown (только критически важные уведомления)

**Типы уведомлений (ТОЛЬКО ЭТИ):**

- 🔥 **POS_ERROR** - Ошибка синхронизации с POS (не получены данные, API недоступен)
- 📊 **LIMIT_WARNING** - Приближение к лимиту тарифа (90% от лимита гостей/ресторанов/POS)

**Обоснование:**

- **Убраны лишние уведомления** - NEW_GUEST, BIRTHDAY_TODAY, AT_RISK_GUEST, LOW_BALANCE, HIGH_VALUE_GUEST не нужны Admin'у, это создаёт информационный шум
- **Только критичные события** - те, которые требуют немедленного действия Admin'а:
    - POS_ERROR - нужно проверить интеграцию, иначе баллы не начисляются
    - LIMIT_WARNING - нужно upgrade тарифа, иначе скоро блокировка функционала

**UI:**

- Bell icon в header с badge (количество непрочитанных)
- Dropdown со списком уведомлений
- Mark as read
- Link на Settings для настройки каналов уведомлений

***

### **Вопрос 24: Export \& Reports - какие отчёты нужны Admin?**

**Принятое решение:** 6 типов отчётов + 3 формата экспорта + Scheduled Reports

**Типы отчётов:**

1. **Guests Report** - список гостей с фильтрами (уровень, статус, баланс, посещения)
2. **Transactions Report** - все транзакции с баллами за период
3. **Revenue Report** - выручка по дням/месяцам, средний чек, распределение
4. **Loyalty ROI Report** - эффективность программы (ROI, redemption, lift)
5. **Birthday Report** - список гостей с днём рождения в выбранном месяце
6. **At-Risk Report** - гости с риском оттока (неактивны 30+ дней, но высокий LTV)

**Export Formats:**

- **CSV** - универсальный, открывается везде, для импорта в другие системы
- **XLSX** - с форматированием, формулами, для презентаций
- **PDF** - для печати, immutable документ

**Scheduled Reports (в Settings):**

- Weekly Summary (каждый понедельник в 09:00)
- Monthly Report (1-го числа в 09:00)
- Email для отчётов (configurable)
- Format (PDF/XLSX)
- Enable/Disable переключатели

**Обоснование:**

- Отчёты покрывают все основные задачи Admin'а (гости, деньги, loyalty эффективность)
- 3 формата под разные цели (анализ, презентация, печать)
- Scheduled Reports экономят время (не нужно генерировать вручную каждый месяц)

***

### **Вопрос 25: Onboarding Flow - как новый Admin знакомится с системой?**

**Принятое решение:** ДА, Interactive Onboarding (4 шага с возможностью skip)

**Steps:**

1. **Welcome** - "Добро пожаловать в Max Loyalty! Настроим всё за 2 минуты"
2. **Restaurant Info** - Название, адрес, логотип (form)
3. **Loyalty Settings** - Ball conversion (1 балл = ₽), Redeem limit (%), форма с подсказками
4. **Invite Team** - Пригласить Manager/Cashier (optional, можно skip)
5. **Ready!** - "Всё готово! Начните с добавления первого гостя" → CTA button "Добавить гостя"

**UI:**

- Modal во весь экран с прогресс-баром (шаг 1 из 5)
- Кнопки: "Назад" / "Далее" / "Пропустить"
- Можно skip весь onboarding → "Настроить позже" → Dashboard
- Onboarding показывается только один раз (при первом входе)
- Можно перезапустить из Settings → Help → "Пройти onboarding заново"

**Обоснование:**

- Новый Admin быстро понимает как работать с системой
- Interactive лучше чем просто Tour (подсказки на элементах) - Admin сразу вводит свои данные
- Skip option - для опытных пользователей или если Admin торопится
- 4 шага - оптимальное количество (не перегружает, но настраивает основное)

***

# ✅ **ИТОГО: 25 РЕШЕНИЙ ADMIN DASHBOARD ПРИНЯТЫ!**


***

## **📦 СТРУКТУРА ADMIN DASHBOARD**

**Роуты:**

```
/admin/dashboard          → Overview (KPIs, Charts, Quick Actions)
/admin/guests             → Guests Table + Filters + Search + Bulk Actions
/admin/guests/:id         → Guest Profile (6 tabs)
/admin/loyalty            → Loyalty Builder (4 tabs: Rules, Levels, Promos, Design)
/admin/analytics          → Analytics (5 tabs: Overview, Guests, Revenue, Loyalty ROI, Reports)
/admin/pos                → POS Integration Setup & Status
/admin/team               → Team Management (Table + Invite)
/admin/settings           → Settings (6 tabs: General, Loyalty, POS, Notifications, Team, Security)
/admin/activity-log       → Activity Log (все действия команды)
```

**Технологии:**

- Next.js 14 App Router + TypeScript
- shadcn/ui (темная тема)
- TanStack Query (data fetching) + TanStack Table (таблицы)
- Recharts (графики)
- date-fns (локализация дат)
- QRCode.react (генерация QR-кодов)
- React Hook Form + Zod (формы + валидация)

***

# 🚀 **ГОТОВ К СЛЕДУЮЩЕМУ БЛОКУ!**

**Какой блок детализируем следующим?**

1. **Manager Dashboard** - урезанная версия Admin Dashboard (без billing, team, некоторых settings)
2. **Cashier POS Interface** - специализированный интерфейс для работы на кассе (быстрый поиск гостя, начисление/списание баллов, регистрация нового гостя)
3. **Guest Telegram Mini App** - интерфейс для гостей (моя карточка, баланс, история, акции, QR-код)
4. **Owner Analytics \& Reporting** (детальнее) - углублённая аналитика для Owner'а (cohort analysis, LTV, CAC, unit economics)
5. **Billing \& Subscriptions** (детальнее) - управление подписками, invoices, payment methods, upgrades/downgrades
6. **API Documentation** - REST API endpoints, webhooks, authentication, rate limits

**Что делаем дальше?** 🎯

---

# 👨‍💼 **MANAGER DASHBOARD - 25 ВОПРОСОВ С РЕШЕНИЯМИ**


***

## **📊 1. ROLE \& PERMISSIONS**

### **1️⃣ Manager vs Admin - чем отличаются права доступа?**

**Контекст:**
Manager - это помощник Admin'а. Он управляет гостями, loyalty, видит аналитику, но **НЕ может** менять критичные настройки, billing, управлять командой.[^12_1][^12_2]

**Вопрос:**
Какие разделы доступны Manager'у vs Admin'у?

**A)** Manager видит всё то же что Admin, но read-only
**B)** Manager видит только Guests + Analytics (без Loyalty, Settings)
**C)** Manager видит всё кроме Billing, Team, некоторых Settings
**D)** Manager имеет полный доступ ко всему (нет отличий от Admin)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Всё кроме критичных секций + Permission-based restrictions**

**Обоснование:**

- ✅ **Manager имеет доступ к:**
    - Dashboard (KPIs, Charts, Quick Actions)
    - Guests Management (CRUD, фильтры, search, bulk actions, guest profiles)
    - Loyalty Builder (Rules, Levels, Promos, Design) - **С ОГРАНИЧЕНИЯМИ** (может создавать/редактировать, но активация требует подтверждения Admin)
    - Analytics (все 5 табов)
    - POS Integration (только просмотр статуса, НЕ может менять credentials)
    - Activity Log (только просмотр)
- ❌ **Manager НЕ имеет доступа к:**
    - Team Management (не может invite/remove пользователей)
    - Billing/Subscription (не видит тариф, оплату, invoices)
    - Critical Settings:
        - ❌ API credentials
        - ❌ Webhook URLs
        - ❌ Security settings (2FA, API tokens)
        - ❌ Subscription/Plan management
    - Impersonation (только Owner может impersonate)
- 🔒 **Permission-based restrictions** (Admin настраивает для каждого Manager'а):
    - ✅ Управление гостями (CRUD)
    - ✅ Ручная корректировка баллов
    - ✅ Создание промо-акций (может создать, но активация требует одобрения Admin)
    - ✅ Просмотр аналитики (full access)
    - ✅ Экспорт данных (CSV, XLSX, PDF)
    - ⚠️ Управление настройками loyalty (ball conversion, redeem limit) - read-only или по разрешению Admin
    - ❌ Удаление гостей (может деактивировать, но не удалять permanently)

**Таблица сравнения:**

```
┌──────────────────────────┬─────────┬──────────┐
│ Раздел / Функция         │ Admin   │ Manager  │
├──────────────────────────┼─────────┼──────────┤
│ Dashboard                │ ✓       │ ✓        │
│ Guests Management        │ ✓       │ ✓        │
│ Loyalty Rules            │ ✓       │ ✓*       │
│ Loyalty Levels           │ ✓       │ ✓*       │
│ Promo Campaigns          │ ✓       │ ✓*       │
│ Card Design              │ ✓       │ ✓*       │
│ Analytics                │ ✓       │ ✓        │
│ POS Integration          │ ✓       │ Read     │
│ Team Management          │ ✓       │ ✕        │
│ Billing/Subscription     │ ✓       │ ✕        │
│ Restaurant Settings      │ ✓       │ Partial  │
│ Security Settings        │ ✓       │ ✕        │
│ Activity Log             │ ✓       │ Read     │
│ Delete Guests            │ ✓       │ ✕        │
│ Export Data              │ ✓       │ ✓        │
└──────────────────────────┴─────────┴──────────┘

* С ограничениями или требует одобрения Admin
```


***

### **2️⃣ Permission Badges - как показать Manager'у его права?**

**Контекст:**
Manager заходит в систему и должен сразу понимать: что он может делать, а что нет. Избежать ситуации "кликнул, получил ошибку 403 Forbidden".

**Вопрос:**
Как визуально показать ограничения?

**A)** Скрыть недоступные разделы (Manager не видит Team, Billing вообще)
**B)** Показать всё, но заблокировать с Tooltip "Требуется роль Admin"
**C)** Badge "Read-only" на недоступных разделах + Tooltip
**D)** Показать всё, но при клике → Modal "У вас нет прав"

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: A) Скрыть недоступные + C) Badge на ограниченных**

**Обоснование:**

- ✅ **Скрыть полностью недоступные** - Team Management, Billing не показываются в sidebar (cleaner UI, Manager не отвлекается)
- ✅ **Badge "Read-only" на ограниченных** - POS Integration, Activity Log видны, но с Badge и Tooltip при hover: "Только просмотр"
- ✅ **Disable кнопок с Tooltip** - например, кнопка "Удалить гостя" disabled + Tooltip: "Требуется роль Admin"
- ✅ **Approval Required Badge** - на кнопке "Активировать промо" → Badge "Требует одобрения" + после создания → Toast: "Промо отправлено на одобрение Admin'у"

**UI Example (Sidebar Navigation):**

```tsx
// Manager видит:
<SidebarNav>
  <SidebarItem href="/manager/dashboard" icon={LayoutDashboard}>
    Dashboard
  </SidebarItem>
  <SidebarItem href="/manager/guests" icon={Users}>
    Guests
  </SidebarItem>
  <SidebarItem href="/manager/loyalty" icon={Gift}>
    Loyalty
  </SidebarItem>
  <SidebarItem href="/manager/analytics" icon={BarChart3}>
    Analytics
  </SidebarItem>
  <SidebarItem href="/manager/pos" icon={Link}>
    POS Integration
    <Badge variant="outline" className="ml-2">Read-only</Badge>
  </SidebarItem>
  <SidebarItem href="/manager/settings" icon={Settings}>
    Settings
  </SidebarItem>
  <SidebarItem href="/manager/activity-log" icon={FileText}>
    Activity Log
    <Badge variant="outline" className="ml-2">Read-only</Badge>
  </SidebarItem>
  
  {/* НЕ показываются Manager'у: */}
  {/* Team Management */}
  {/* Billing */}
</SidebarNav>
```

**Tooltip на disabled кнопке:**

```tsx
<Tooltip>
  <TooltipTrigger asChild>
    <span>
      <Button disabled className="cursor-not-allowed">
        <Trash2 className="mr-2 h-4 w-4" />
        Удалить гостя
      </Button>
    </span>
  </TooltipTrigger>
  <TooltipContent>
    <p>Требуется роль Admin</p>
  </TooltipContent>
</Tooltip>
```


***

### **3️⃣ Manager Profile Badge - как Manager понимает свою роль?**

**Контекст:**
В одном браузере может быть открыт Admin Dashboard и Manager Dashboard (разные пользователи). Нужно визуально отличить.

**Вопрос:**
Как показать Manager'у что он Manager (а не Admin)?

**A)** Badge "Manager" в header рядом с аватаром
**B)** Отличающийся цвет темы (Manager = синий, Admin = зелёный)
**C)** Watermark "Manager Mode" в углу экрана
**D)** Ничего не показывать (пользователь и так знает кто он)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: A) Badge "Manager" в header + Permission indicator в Profile Dropdown**

**Обоснование:**

- ✅ **Badge в header** - постоянно виден, не отвлекает (outline стиль)
- ✅ **Profile Dropdown** - показывает:
    - Имя пользователя
    - Email
    - Role Badge (Manager)
    - Permissions Summary (клик → Modal со списком разрешений)

**UI:**

```tsx
<DropdownMenu>
  <DropdownMenuTrigger asChild>
    <Button variant="ghost" className="relative">
      <Avatar>
        <AvatarImage src={user.avatar} />
        <AvatarFallback>{getInitials(user.firstName, user.lastName)}</AvatarFallback>
      </Avatar>
      <div className="ml-2 text-left">
        <div className="text-sm font-medium">{user.firstName}</div>
        <Badge variant="outline" className="text-xs">Manager</Badge>
      </div>
    </Button>
  </DropdownMenuTrigger>
  
  <DropdownMenuContent align="end" className="w-64">
    <DropdownMenuLabel>
      <div>{user.firstName} {user.lastName}</div>
      <div className="text-xs text-secondary font-normal">{user.email}</div>
    </DropdownMenuLabel>
    
    <DropdownMenuSeparator />
    
    <DropdownMenuItem onClick={viewPermissions}>
      <Shield className="mr-2 h-4 w-4" />
      Мои права доступа
    </DropdownMenuItem>
    
    <DropdownMenuItem onClick={viewProfile}>
      <User className="mr-2 h-4 w-4" />
      Профиль
    </DropdownMenuItem>
    
    <DropdownMenuSeparator />
    
    <DropdownMenuItem onClick={logout}>
      <LogOut className="mr-2 h-4 w-4" />
      Выйти
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

**Permissions Modal:**

```tsx
<Dialog open={showPermissions} onOpenChange={setShowPermissions}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Мои права доступа</DialogTitle>
      <DialogDescription>
        Эти разрешения назначены Admin'ом
      </DialogDescription>
    </DialogHeader>
    
    <div className="space-y-2">
      {userPermissions.map((permission) => (
        <div key={permission.id} className="flex items-center gap-2">
          {permission.granted ? (
            <CheckCircle2 className="h-4 w-4 text-success" />
          ) : (
            <XCircle className="h-4 w-4 text-secondary" />
          )}
          <div className="flex-1">
            <div className="text-sm font-medium">{permission.name}</div>
            <div className="text-xs text-secondary">{permission.description}</div>
          </div>
        </div>
      ))}
    </div>
    
    <DialogFooter>
      <p className="text-xs text-secondary">
        Для изменения прав обратитесь к Admin'у
      </p>
    </DialogFooter>
  </DialogContent>
</Dialog>
```


***

## **📊 2. DASHBOARD HOME**

### **4️⃣ Manager Dashboard - показать те же KPI что Admin?**

**Контекст:**
Manager видит Dashboard с метриками. Должны ли они быть идентичны Admin Dashboard?

**Вопрос:**
Какие метрики показать Manager'у?

**A)** Точно такие же как у Admin (Гости | Активных | Баллов | Loyalty ROI)
**B)** Упрощённые (Гости | Визитов | Баллов начислено)
**C)** Фокус на операционных метриках (Новых гостей сегодня | Обработано чеков | At-risk гостей)
**D)** Кастомизируемые (Manager сам выбирает какие метрики видеть)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: A) Такие же как у Admin**

**Обоснование:**

- ✅ **Consistency** - Manager и Admin видят одну картину, проще обсуждать результаты
- ✅ **Мотивация** - Manager видит те же KPI что влияют на успех ресторана
- ✅ **No confusion** - не нужно объяснять "почему у меня одни цифры, а у Admin'а другие"
- ✅ **Reusability** - один и тот же компонент для обеих ролей

**Метрики (те же что у Admin):**

```
┌──────────────────────┐  ┌──────────────────────┐
│ 👥 Всего гостей      │  │ ✅ Активных (30д)    │
│ 2,847                │  │ 1,876 (66%)          │
│ ↑ +123 за месяц      │  │ ↑ +98 за месяц       │
└──────────────────────┘  └──────────────────────┘

┌──────────────────────┐  ┌──────────────────────┐
│ 🎁 Баллов начислено  │  │ 📈 Loyalty ROI       │
│ 45,680               │  │ 1:8.4                │
│ ↑ +5,420 за месяц    │  │ ↑ +0.3 (улучшение)   │
└──────────────────────┘  └──────────────────────┘
```


***

### **5️⃣ Dashboard Charts - показать те же графики?**

**Контекст:**
Admin видит 4 графика (Guests Growth, Revenue+Balls, Loyalty Levels, Top 10 Guests).

**Вопрос:**
Показать Manager'у те же графики?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: ДА, те же 4 графика**

**Обоснование:**

- ✅ **Полная картина** - Manager должен понимать динамику бизнеса
- ✅ **No need to reinvent** - работающий набор графиков, покрывает основное
- ✅ **Component reuse** - DRY принцип

**Графики:**

1. Guests Growth (Line Chart, 6 месяцев)
2. Revenue + Balls Earned (Combined Chart, 30 дней)
3. Loyalty Levels Distribution (Donut Chart)
4. Top 10 Guests Leaderboard

***

### **6️⃣ Quick Actions - те же или другие для Manager?**

**Контекст:**
Admin видит Quick Actions: Добавить гостя | Корректировка | Создать промо | Экспорт.

**Вопрос:**
Какие Quick Actions показать Manager'у?

**A)** Те же самые (если есть permissions)
**B)** Только операционные (Добавить гостя | Найти гостя)
**C)** Убрать "Создать промо" (только Admin)
**D)** Добавить "Отправить уведомление гостям"

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: A) Те же + Permission-based visibility**

**Обоснование:**

- ✅ **Добавить гостя** - доступно всем Manager'ам (основное действие)
- ✅ **Ручная корректировка** - если Manager имеет permission "Корректировка баллов"
- ✅ **Создать промо** - если Manager имеет permission "Создание промо" (но с Badge "Требует одобрения")
- ✅ **Экспорт** - если Manager имеет permission "Экспорт данных"

**UI (conditional rendering):**

```tsx
<div className="grid grid-cols-4 gap-4">
  {/* Всегда доступно */}
  <QuickActionCard
    icon={UserPlus}
    title="Добавить гостя"
    description="Регистрация вручную"
    onClick={openAddGuestModal}
  />
  
  {/* Если есть permission */}
  {hasPermission('ADJUST_BALLS') && (
    <QuickActionCard
      icon={Edit}
      title="Корректировка"
      description="Начислить/списать баллы"
      onClick={openAdjustBallsModal}
    />
  )}
  
  {hasPermission('CREATE_PROMO') && (
    <QuickActionCard
      icon={Gift}
      title="Создать промо"
      description="Акция или бонус"
      badge="Требует одобрения"
      onClick={openCreatePromoModal}
    />
  )}
  
  {hasPermission('EXPORT_DATA') && (
    <QuickActionCard
      icon={Download}
      title="Экспорт"
      description="CSV, XLSX, PDF"
      onClick={openExportModal}
    />
  )}
</div>
```


***

## **👥 3. GUESTS MANAGEMENT**

### **7️⃣ Guests Page - полный доступ или ограничения?**

**Контекст:**
Manager работает с гостями: добавляет, редактирует, начисляет/списывает баллы, экспортирует.

**Вопрос:**
Какие ограничения для Manager'а на Guests Page?

**A)** Полный доступ как у Admin (без отличий)
**B)** Read-only (только просмотр, без редактирования)
**C)** Может всё кроме удаления гостей (delete permanently)
**D)** Может всё кроме bulk operations (экспорт, массовое начисление)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Может всё кроме permanent delete + Permission-based restrictions**

**Обоснование:**

- ✅ **Может:**
    - Просматривать всех гостей
    - Добавлять новых гостей
    - Редактировать профили (имя, телефон, email, ДР)
    - Начислять/списывать баллы (если есть permission)
    - Экспортировать (если есть permission)
    - Bulk actions (если есть permission)
    - Деактивировать гостя (статус INACTIVE)
    - Отправлять уведомления
- ❌ **НЕ может:**
    - Удалять гостя permanently (hard delete из БД) - это только Admin
    - Восстанавливать удалённых гостей (только Admin)

**UI отличия:**

```tsx
// В Dropdown Actions гостя
<DropdownMenu>
  <DropdownMenuContent>
    <DropdownMenuItem onClick={() => viewGuest(guest)}>
      <Eye className="mr-2 h-4 w-4" />
      Просмотр деталей
    </DropdownMenuItem>
    
    {hasPermission('EDIT_GUESTS') && (
      <DropdownMenuItem onClick={() => editGuest(guest)}>
        <Edit className="mr-2 h-4 w-4" />
        Редактировать
      </DropdownMenuItem>
    )}
    
    {hasPermission('ADJUST_BALLS') && (
      <DropdownMenuItem onClick={() => adjustBalls(guest)}>
        <Gift className="mr-2 h-4 w-4" />
        Корректировка баллов
      </DropdownMenuItem>
    )}
    
    <DropdownMenuItem onClick={() => viewHistory(guest)}>
      <History className="mr-2 h-4 w-4" />
      История операций
    </DropdownMenuItem>
    
    <DropdownMenuSeparator />
    
    <DropdownMenuItem onClick={() => deactivateGuest(guest)}>
      <Ban className="mr-2 h-4 w-4" />
      Деактивировать
    </DropdownMenuItem>
    
    {/* Delete НЕ показывается Manager'у */}
    {userRole === 'ADMIN' && (
      <DropdownMenuItem
        onClick={() => deleteGuest(guest)}
        className="text-danger"
      >
        <Trash2 className="mr-2 h-4 w-4" />
        Удалить навсегда
      </DropdownMenuItem>
    )}
  </DropdownMenuContent>
</DropdownMenu>
```


***

### **8️⃣ Guest Profile - те же табы что у Admin?**

**Контекст:**
Guest Profile имеет 6 табов (Overview, Transactions, Visits, Children, Activity Log, Analytics).

**Вопрос:**
Показать Manager'у все табы?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: ДА, все 6 табов (без ограничений на просмотр)**

**Обоснование:**

- ✅ Manager должен иметь полное представление о госте для качественного сервиса
- ✅ Все табы информативные, ничего критичного (типа billing)
- ✅ Activity Log показывает кто что делал с гостем (transparency)

**Возможные ограничения в табах:**

- **Overview Tab:**
    - Quick Actions (Начислить/Списать) - если нет permission → disabled с Tooltip
    - Кнопка "Удалить гостя" - не показывается Manager'у
    - Кнопка "Заблокировать" - доступна Manager'у
- **Transactions Tab:**
    - Полный просмотр истории
    - НЕ может редактировать/удалять транзакции (read-only)
- **Visits Tab:**
    - Полный просмотр
- **Children Tab:**
    - Может добавлять/редактировать детей
- **Activity Log Tab:**
    - Полный просмотр (видит действия Admin'а и других Manager'ов)
- **Analytics Tab:**
    - Полный просмотр (RFM сегмент, графики, рекомендации)

***

### **9️⃣ Bulk Actions - доступны Manager'у?**

**Контекст:**
Admin может делать bulk actions: Экспорт, Добавить баллы, Отправить уведомление, Применить тег, Удалить.

**Вопрос:**
Какие bulk actions доступны Manager'у?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: Все кроме "Удалить" + Permission-based**

**Обоснование:**

- ✅ **Экспорт выбранных** - если permission "Экспорт данных"
- ✅ **Добавить баллы** - если permission "Корректировка баллов"
- ✅ **Отправить уведомление** - всегда доступно Manager'у
- ✅ **Применить тег** - всегда доступно Manager'у
- ❌ **Удалить** - только Admin (Manager может деактивировать по одному)

**UI:**

```tsx
{selectedGuests.length > 0 && (
  <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50">
    <Card className="shadow-lg border-primary">
      <CardContent className="p-4 flex items-center gap-4">
        <div className="flex items-center gap-2">
          <Checkbox
            checked={allSelected}
            onCheckedChange={toggleSelectAll}
          />
          <span className="font-semibold">
            {selectedGuests.length} выбрано
          </span>
        </div>
        
        <Separator orientation="vertical" className="h-6" />
        
        <div className="flex gap-2">
          {hasPermission('EXPORT_DATA') && (
            <Button variant="outline" size="sm" onClick={exportSelected}>
              <Download className="mr-2 h-4 w-4" />
              Экспорт
            </Button>
          )}
          
          {hasPermission('ADJUST_BALLS') && (
            <Button variant="outline" size="sm" onClick={openBulkAddBalls}>
              <Gift className="mr-2 h-4 w-4" />
              Добавить баллы
            </Button>
          )}
          
          <Button variant="outline" size="sm" onClick={openBulkNotification}>
            <Send className="mr-2 h-4 w-4" />
            Уведомление
          </Button>
          
          <Button variant="outline" size="sm" onClick={openBulkTag}>
            <Tag className="mr-2 h-4 w-4" />
            Применить тег
          </Button>
          
          {/* Удалить НЕ показывается Manager'у */}
        </div>
        
        <Button
          variant="ghost"
          size="sm"
          onClick={() => setSelectedGuests([])}
        >
          <X className="h-4 w-4" />
        </Button>
      </CardContent>
    </Card>
  </div>
)}
```


***

## **🎁 4. LOYALTY BUILDER**

### **🔟 Loyalty Builder - полный доступ или ограничения?**

**Контекст:**
Admin создаёт/редактирует Rules, Levels, Promos, Design. Manager может помогать, но критичные изменения должны одобряться Admin'ом.

**Вопрос:**
Какой уровень доступа для Manager'а в Loyalty Builder?

**A)** Read-only (только просмотр, без редактирования)
**B)** Может создавать/редактировать, но активация требует одобрения Admin'а
**C)** Полный доступ как у Admin (без отличий)
**D)** Только Promo Campaigns доступны для создания, остальное read-only

**🎯 МОЉ ПРЕДЛОЖЕНИЕ: B) Создание/редактирование с одобрением Admin'а + D) Levels read-only**

**Обоснование:**

**Rules (Правила начисления):**

- ✅ Manager может создавать новые правила
- ✅ Manager может редактировать существующие
- ⚠️ **Activation/Deactivation требует одобрения Admin'а**
- Процесс: Manager создаёт → сохраняется в статусе PENDING_APPROVAL → Admin получает уведомление → Admin одобряет/отклоняет

**Levels (Уровни лояльности):**

- ❌ Manager НЕ может создавать/редактировать/удалять уровни (read-only)
- Причина: изменение порогов влияет на всех гостей (критичное действие)
- Manager видит уровни, количество гостей, статистику

**Promos (Промо-акции):**

- ✅ Manager может создавать промо из шаблонов
- ✅ Manager может редактировать свои промо (созданные им)
- ⚠️ **Activation требует одобрения Admin'а**
- ✅ Manager может деактивировать свои активные промо (без одобрения)

**Design (Дизайн карточки):**

- ❌ Manager НЕ может менять дизайн (read-only)
- Причина: дизайн карточки = бренд ресторана (только Admin решает)

**UI индикация:**

```tsx
// Rules Tab
<Tabs defaultValue="rules">
  <TabsContent value="rules">
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold">Правила начисления</h2>
          {userRole === 'MANAGER' && (
            <p className="text-sm text-secondary mt-1">
              Активация правил требует одобрения Admin'а
            </p>
          )}
        </div>
        
        {hasPermission('CREATE_RULES') && (
          <Button onClick={openCreateRule}>
            <Plus className="mr-2 h-4 w-4" />
            Создать правило
          </Button>
        )}
      </div>
      
      {/* Список правил */}
      {rules.map((rule) => (
        <RuleCard key={rule.id} rule={rule}>
          {rule.status === 'PENDING_APPROVAL' && (
            <Badge variant="warning">Ожидает одобрения</Badge>
          )}
          
          {rule.status === 'ACTIVE' && userRole === 'MANAGER' && (
            <Tooltip>
              <TooltipTrigger asChild>
                <span>
                  <Button disabled variant="outline" size="sm">
                    Деактивировать
                  </Button>
                </span>
              </TooltipTrigger>
              <TooltipContent>
                Требуется одобрение Admin'а
              </TooltipContent>
            </Tooltip>
          )}
        </RuleCard>
      ))}
    </div>
  </TabsContent>
  
  {/* Levels Tab */}
  <TabsContent value="levels">
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold">Уровни лояльности</h2>
          {userRole === 'MANAGER' && (
            <Badge variant="outline" className="ml-2">Read-only</Badge>
          )}
        </div>
        
        {/* Кнопка "Добавить уровень" НЕ показывается Manager'у */}
      </div>
      
      {/* Timeline с уровнями (без редактирования) */}
    </div>
  </TabsContent>
  
  {/* Promos Tab */}
  <TabsContent value="promos">
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold">Промо-акции</h2>
          {userRole === 'MANAGER' && (
            <p className="text-sm text-secondary mt-1">
              Активация промо требует одобрения Admin'а
            </p>
          )}
        </div>
        
        {hasPermission('CREATE_PROMO') && (
          <Button onClick={() => setShowTemplateGallery(true)}>
            <Plus className="mr-2 h-4 w-4" />
            Создать промо
          </Button>
        )}
      </div>
      
      {/* Список промо с Badge статуса */}
    </div>
  </TabsContent>
  
  {/* Design Tab */}
  <TabsContent value="design">
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold">Дизайн карточки</h2>
          {userRole === 'MANAGER' && (
            <Badge variant="outline" className="ml-2">Read-only</Badge>
          )}
        </div>
      </div>
      
      {/* Preview дизайна (без возможности редактирования) */}
      <Alert>
        <Info className="h-4 w-4" />
        <AlertDescription>
          Изменение дизайна доступно только Admin'у
        </AlertDescription>
      </Alert>
    </div>
  </TabsContent>
</Tabs>
```


***

### **1️⃣1️⃣ Approval Workflow - как Admin одобряет изменения Manager'а?**

**Контекст:**
Manager создал правило или промо со статусом PENDING_APPROVAL. Admin должен одобрить/отклонить.

**Вопрос:**
Как организовать approval workflow?

**A)** Email уведомление Admin'у → он заходит и одобряет
**B)** In-app Notification + Badge на Loyalty Builder
**C)** Отдельная страница "Pending Approvals" с очередью
**D)** Modal "Требуется ваше одобрение" при входе Admin'а

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) In-app Notification + Approval Queue в Loyalty Builder**

**Обоснование:**

- ✅ **Notification Bell** - Admin получает уведомление "Manager создал новое правило 'Weekend Bonus'"
- ✅ **Badge на Loyalty Builder** - в sidebar показывается Badge с количеством pending items
- ✅ **Approval Queue Section** - в начале Loyalty Builder страницы секция "Ожидают одобрения" (collapsible)

**UI (Approval Queue):**

```tsx
// В начале Loyalty Builder Page (для Admin)
{pendingApprovals.length > 0 && (
  <Card className="mb-6 border-warning">
    <CardHeader>
      <div className="flex items-center justify-between">
        <CardTitle className="flex items-center gap-2">
          <AlertCircle className="h-5 w-5 text-warning" />
          Ожидают одобрения ({pendingApprovals.length})
        </CardTitle>
        <Button
          variant="ghost"
          size="sm"
          onClick={() => setShowApprovals(!showApprovals)}
        >
          {showApprovals ? <ChevronUp /> : <ChevronDown />}
        </Button>
      </div>
    </CardHeader>
    
    {showApprovals && (
      <CardContent className="space-y-3">
        {pendingApprovals.map((item) => (
          <div
            key={item.id}
            className="flex items-start justify-between p-4 border rounded-lg"
          >
            <div className="flex items-start gap-3">
              <div className="text-2xl">
                {item.type === 'RULE' ? '📏' : '🎁'}
              </div>
              <div>
                <div className="font-semibold">{item.name}</div>
                <div className="text-sm text-secondary">
                  Создал: {item.createdBy.firstName} {item.createdBy.lastName}
                </div>
                <div className="text-sm text-secondary">
                  {formatRelative(item.createdAt)}
                </div>
                {item.type === 'RULE' && (
                  <div className="text-sm mt-1">
                    Начисление: {item.earnPercent}%
                  </div>
                )}
                {item.type === 'PROMO' && (
                  <div className="text-sm mt-1">
                    Бонус: {item.bonusPoints} баллов
                  </div>
                )}
              </div>
            </div>
            
            <div className="flex gap-2">
              <Button
                variant="outline"
                size="sm"
                onClick={() => viewDetails(item)}
              >
                <Eye className="mr-2 h-4 w-4" />
                Детали
              </Button>
              
              <Button
                variant="default"
                size="sm"
                onClick={() => approve(item)}
              >
                <Check className="mr-2 h-4 w-4" />
                Одобрить
              </Button>
              
              <Button
                variant="destructive"
                size="sm"
                onClick={() => reject(item)}
              >
                <X className="mr-2 h-4 w-4" />
                Отклонить
              </Button>
            </div>
          </div>
        ))}
      </CardContent>
    )}
  </Card>
)}
```

**Reject Modal (если Admin отклоняет):**

```tsx
<Dialog open={showRejectModal} onOpenChange={setShowRejectModal}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Отклонить изменение</DialogTitle>
      <DialogDescription>
        Укажите причину отклонения для {rejectingItem.createdBy.firstName}
      </DialogDescription>
    </DialogHeader>
    
    <Textarea
      placeholder="Например: Процент начисления слишком высокий, уменьшите до 10%"
      value={rejectReason}
      onChange={(e) => setRejectReason(e.target.value)}
      required
      minLength={10}
    />
    
    <DialogFooter>
      <Button variant="outline" onClick={() => setShowRejectModal(false)}>
        Отмена
      </Button>
      <Button variant="destructive" onClick={handleReject}>
        Отклонить
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

**Manager видит статус:**

- После создания → Toast: "Правило отправлено на одобрение Admin'у"
- В списке правил → Badge "Ожидает одобрения"
- Если одобрено → Notification: "Admin одобрил ваше правило 'Weekend Bonus'"
- Если отклонено → Notification с причиной: "Admin отклонил правило: Процент слишком высокий"

***

### **1️⃣2️⃣ Manager создал промо - может ли сам активировать?**

**Контекст:**
Manager создал промо "Happy Hour 20% баллов 18-22". Статус PENDING_APPROVAL.

**Вопрос:**
Может ли Manager активировать промо сразу или нужно ждать Admin'а?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: Зависит от permission "AUTO_ACTIVATE_PROMO"**

**Обоснование:**

- ✅ **Если Admin дал permission "AUTO_ACTIVATE_PROMO":**
    - Manager может активировать промо сразу (без одобрения)
    - Полезно для срочных акций (например, "Сегодня double баллы")
    - Admin всё равно видит в Activity Log кто активировал
- ⚠️ **Если permission НЕТ:**
    - Manager создаёт → статус PENDING_APPROVAL
    - Admin одобряет → статус APPROVED → Manager или Admin активирует

**UI (Create Promo Modal для Manager):**

```tsx
<DialogFooter>
  <Button variant="outline" onClick={() => setShowPromoForm(false)}>
    Отмена
  </Button>
  
  {hasPermission('AUTO_ACTIVATE_PROMO') ? (
    <>
      <Button onClick={() => savePromo({ activate: false })}>
        Сохранить как черновик
      </Button>
      <Button onClick={() => savePromo({ activate: true })}>
        Сохранить и активировать
      </Button>
    </>
  ) : (
    <Button onClick={() => savePromo({ activate: false })}>
      Отправить на одобрение
    </Button>
  )}
</DialogFooter>
```


***

## **📊 5. ANALYTICS PAGE**

### **1️⃣3️⃣ Analytics - полный доступ как у Admin?**

**Контекст:**
Admin видит 5 табов аналитики (Overview, Guests Analysis, Revenue, Loyalty ROI, Reports).

**Вопрос:**
Показать Manager'у все табы аналитики?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: ДА, полный доступ ко всем 5 табам (без ограничений)**

**Обоснование:**

- ✅ Manager должен понимать бизнес для принятия решений
- ✅ Analytics не содержит критичной информации (типа billing, API keys)
- ✅ RFM сегментация, cohort analysis, loyalty ROI - всё это полезно Manager'у для улучшения работы с гостями
- ✅ Transparency - Manager видит те же данные что Admin (единая картина)

**Tabs:**

1. **Overview** - KPIs + главные графики (полный доступ)
2. **Guests Analysis** - RFM, cohort, churn risk (полный доступ)
3. **Revenue Analysis** - выручка, средний чек (полный доступ)
4. **Loyalty ROI** - эффективность программы (полный доступ)
5. **Reports** - готовые отчёты для экспорта (если permission "EXPORT_DATA")

***

### **1️⃣4️⃣ Export Reports - доступен Manager'у?**

**Контекст:**
В табе Reports есть кнопки экспорта отчётов (CSV, XLSX, PDF).

**Вопрос:**
Может ли Manager экспортировать отчёты?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: ДА, если есть permission "EXPORT_DATA"**

**Обоснование:**

- ✅ Manager может нуждаться в экспорте для презентаций, анализа в Excel, отчётности
- ✅ Экспорт не меняет данные (read operation)
- ✅ Admin контролирует через permission

**UI (Reports Tab):**

```tsx
<TabsContent value="reports" className="space-y-6">
  <div>
    <h3 className="text-xl font-bold">Готовые отчёты</h3>
    <p className="text-sm text-secondary mt-1">
      Экспорт данных за выбранный период
    </p>
  </div>
  
  {hasPermission('EXPORT_DATA') ? (
    <div className="grid grid-cols-2 gap-4">
      <ReportCard
        icon={Users}
        title="Guests Report"
        description="Список гостей с фильтрами"
        onClick={() => exportReport('guests')}
      />
      
      <ReportCard
        icon={ArrowLeftRight}
        title="Transactions Report"
        description="Все операции с баллами"
        onClick={() => exportReport('transactions')}
      />
      
      <ReportCard
        icon={TrendingUp}
        title="Revenue Report"
        description="Выручка и средний чек"
        onClick={() => exportReport('revenue')}
      />
      
      <ReportCard
        icon={Gift}
        title="Loyalty ROI Report"
        description="Эффективность программы"
        onClick={() => exportReport('loyalty-roi')}
      />
      
      <ReportCard
        icon={Cake}
        title="Birthday Report"
        description="Гости с ДР в месяце"
        onClick={() => exportReport('birthday')}
      />
      
      <ReportCard
        icon={AlertTriangle}
        title="At-Risk Report"
        description="Гости с риском оттока"
        onClick={() => exportReport('at-risk')}
      />
    </div>
  ) : (
    <Alert>
      <Lock className="h-4 w-4" />
      <AlertDescription>
        Экспорт отчётов доступен только с разрешением Admin'а
      </AlertDescription>
    </Alert>
  )}
</TabsContent>
```


***

## **⚙️ 6. SETTINGS PAGE**

### **1️⃣5️⃣ Settings - что Manager может настраивать?**

**Контекст:**
Admin видит 6 табов Settings (General, Loyalty, POS, Notifications, Team, Security).

**Вопрос:**
Какие табы показать Manager'у?

**A)** Только Profile (свой профиль)
**B)** Profile + Notifications (свои уведомления)
**C)** Всё кроме Team, Security, критичных полей
**D)** Read-only доступ ко всему

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: Manager видит 3 таба (Profile | Restaurant Info (read-only) | Notifications)**

**Обоснование:**

**Profile Tab (полный доступ):**

- Своё фото, имя, email, телефон
- Смена пароля
- Язык интерфейса
- Timezone

**Restaurant Info Tab (read-only для Manager):**

- Название ресторана, логотип, адрес, часы работы
- Manager может видеть эту информацию, но НЕ редактировать
- Полезно для справки (например, часы работы при общении с гостями)

**Notifications Tab (полный доступ):**

- Каналы уведомлений (Email, Telegram)
- Типы уведомлений (какие получать)
- Quiet hours (когда не беспокоить)

**НЕ показываются Manager'у:**

- ❌ General Settings (критичные поля: API keys, webhook URLs)
- ❌ Loyalty Settings (ball conversion, redeem limit) - это Admin
- ❌ POS Integration Settings (credentials)
- ❌ Team Management (invite/remove)
- ❌ Security Settings (2FA for restaurant, API tokens)

**UI (Settings Page для Manager):**

```tsx
<Tabs defaultValue="profile">
  <TabsList>
    <TabsTrigger value="profile">
      <User className="mr-2 h-4 w-4" />
      Профиль
    </TabsTrigger>
    <TabsTrigger value="restaurant">
      <Building className="mr-2 h-4 w-4" />
      Ресторан
      <Badge variant="outline" className="ml-2 text-xs">Read-only</Badge>
    </TabsTrigger>
    <TabsTrigger value="notifications">
      <Bell className="mr-2 h-4 w-4" />
      Уведомления
    </TabsTrigger>
  </TabsList>
  
  <TabsContent value="profile">
    {/* Editable profile form */}
  </TabsContent>
  
  <TabsContent value="restaurant">
    <Alert className="mb-6">
      <Info className="h-4 w-4" />
      <AlertDescription>
        Информация доступна только для просмотра. Для изменений обратитесь к Admin'у.
      </AlertDescription>
    </Alert>
    
    {/* Read-only restaurant info */}
    <Card>
      <CardHeader>
        <CardTitle>Информация о ресторане</CardTitle>
      </CardHeader>
      <CardContent>
        <dl className="grid grid-cols-2 gap-4">
          <div>
            <dt className="text-sm text-secondary">Название</dt>
            <dd className="font-medium">{restaurant.name}</dd>
          </div>
          <div>
            <dt className="text-sm text-secondary">Адрес</dt>
            <dd className="font-medium">{restaurant.address}</dd>
          </div>
          <div>
            <dt className="text-sm text-secondary">Телефон</dt>
            <dd className="font-medium">{restaurant.phone}</dd>
          </div>
          <div>
            <dt className="text-sm text-secondary">Email</dt>
            <dd className="font-medium">{restaurant.email}</dd>
          </div>
        </dl>
        
        <Separator className="my-6" />
        
        <div>
          <Label className="mb-3">Часы работы</Label>
          <div className="space-y-2">
            {restaurant.workingHours.map((day) => (
              <div key={day.dayOfWeek} className="flex justify-between text-sm">
                <span className="text-secondary">{DAYS_RU[day.dayOfWeek]}</span>
                <span className="font-medium">
                  {day.isOpen ? `${day.openTime} - ${day.closeTime}` : 'Выходной'}
                </span>
              </div>
            ))}
          </div>
        </div>
      </CardContent>
    </Card>
  </TabsContent>
  
  <TabsContent value="notifications">
    {/* Editable notifications settings */}
  </TabsContent>
</Tabs>
```


***

### **1️⃣6️⃣ Manager Profile - что может редактировать?**

**Контекст:**
Manager открывает Settings → Profile Tab.

**Вопрос:**
Что Manager может изменить в своём профиле?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: Всё кроме Email (Email меняет Admin)**

**Обоснование:**

- ✅ **Может менять:**
    - Фото/аватар
    - Имя, Фамилия
    - Телефон
    - Пароль (с подтверждением старого)
    - Язык интерфейса
    - Timezone
- ❌ **НЕ может менять:**
    - Email (это идентификатор для входа, меняет только Admin)
    - Роль (Manager не может сделать себя Admin)
    - Permissions (назначает Admin)

**UI:**

```tsx
<Card>
  <CardHeader>
    <CardTitle>Мой профиль</CardTitle>
  </CardHeader>
  <CardContent>
    <form onSubmit={handleUpdateProfile} className="space-y-6">
      {/* Avatar */}
      <div className="flex items-center gap-4">
        <Avatar className="h-20 w-20">
          {profile.avatar ? (
            <AvatarImage src={profile.avatar} />
          ) : (
            <AvatarFallback className="text-2xl">
              {getInitials(profile.firstName, profile.lastName)}
            </AvatarFallback>
          )}
        </Avatar>
        <div>
          <Button variant="outline" onClick={uploadAvatar}>
            <Upload className="mr-2 h-4 w-4" />
            Загрузить фото
          </Button>
          {profile.avatar && (
            <Button variant="ghost" size="sm" onClick={removeAvatar}>
              Удалить
            </Button>
          )}
        </div>
      </div>
      
      <Separator />
      
      <div className="grid grid-cols-2 gap-4">
        <div>
          <Label>Имя *</Label>
          <Input
            value={profile.firstName}
            onChange={(e) => setProfile({ ...profile, firstName: e.target.value })}
            required
          />
        </div>
        
        <div>
          <Label>Фамилия *</Label>
          <Input
            value={profile.lastName}
            onChange={(e) => setProfile({ ...profile, lastName: e.target.value })}
            required
          />
        </div>
      </div>
      
      <div>
        <Label>Email</Label>
        <Input
          type="email"
          value={profile.email}
          disabled
          className="bg-muted"
        />
        <p className="text-xs text-secondary mt-1">
          Email используется для входа. Для изменения обратитесь к Admin'у.
        </p>
      </div>
      
      <div>
        <Label>Телефон</Label>
        <Input
          type="tel"
          value={profile.phone}
          onChange={(e) => setProfile({ ...profile, phone: e.target.value })}
        />
      </div>
      
      <Separator />
      
      <div>
        <Label>Язык интерфейса</Label>
        <Select
          value={profile.language}
          onValueChange={(value) => setProfile({ ...profile, language: value })}
        >
          <SelectTrigger>
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="ru">🇷🇺 Русский</SelectItem>
            <SelectItem value="en">🇬🇧 English</SelectItem>
          </SelectContent>
        </Select>
      </div>
      
      <div>
        <Label>Timezone</Label>
        <Select
          value={profile.timezone}
          onValueChange={(value) => setProfile({ ...profile, timezone: value })}
        >
          <SelectTrigger>
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="Europe/Moscow">МСК (UTC+3)</SelectItem>
            <SelectItem value="Europe/Kiev">Киев (UTC+2)</SelectItem>
            <SelectItem value="Asia/Almaty">Алматы (UTC+6)</SelectItem>
            {/* ... other timezones */}
          </SelectContent>
        </Select>
      </div>
      
      <Button type="submit">
        Сохранить изменения
      </Button>
    </form>
    
    <Separator className="my-6" />
    
    {/* Change Password Section */}
    <div>
      <h3 className="text-lg font-semibold mb-4">Смена пароля</h3>
      <form onSubmit={handleChangePassword} className="space-y-4">
        <div>
          <Label>Текущий пароль *</Label>
          <Input
            type="password"
            value={passwordForm.current}
            onChange={(e) => setPasswordForm({ ...passwordForm, current: e.target.value })}
            required
          />
        </div>
        
        <div>
          <Label>Новый пароль *</Label>
          <Input
            type="password"
            value={passwordForm.new}
            onChange={(e) => setPasswordForm({ ...passwordForm, new: e.target.value })}
            required
            minLength={8}
          />
          <p className="text-xs text-secondary mt-1">
            Минимум 8 символов
          </p>
        </div>
        
        <div>
          <Label>Подтвердите новый пароль *</Label>
          <Input
            type="password"
            value={passwordForm.confirm}
            onChange={(e) => setPasswordForm({ ...passwordForm, confirm: e.target.value })}
            required
          />
        </div>
        
        <Button type="submit">
          Изменить пароль
        </Button>
      </form>
    </div>
  </CardContent>
</Card>
```


***

## **🔔 7. NOTIFICATIONS**

### **1️⃣7️⃣ Notifications - какие уведомления получает Manager?**

**Контекст:**
Admin получает уведомления о POS_ERROR и LIMIT_WARNING.

**Вопрос:**
Какие уведомления показать Manager'у?

**A)** Те же что Admin (POS_ERROR, LIMIT_WARNING)
**B)** Только операционные (NEW_GUEST, AT_RISK_GUEST)
**C)** Approval-related (Admin одобрил/отклонил ваше правило/промо)
**D)** Никаких (Manager сам проверяет нужную информацию)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Approval-related + A) POS_ERROR (если ответственен)**

**Notification Types для Manager:**

1. **✅ APPROVAL_APPROVED** - Admin одобрил ваше правило/промо
2. **✕ APPROVAL_REJECTED** - Admin отклонил с причиной
3. **🔥 POS_ERROR** - Ошибка синхронизации с POS (если Manager ответственен за POS мониторинг)

**НЕ показываются Manager'у:**

- ❌ LIMIT_WARNING (это проблема тарифа, решает Admin)
- ❌ NEW_GUEST, BIRTHDAY_TODAY, AT_RISK_GUEST (информационный шум, Manager сам проверяет)

**UI (Bell Dropdown):**

```tsx
<Popover>
  <PopoverTrigger asChild>
    <Button variant="ghost" size="icon" className="relative">
      <Bell className="h-5 w-5" />
      {unreadCount > 0 && (
        <span className="absolute -top-1 -right-1 bg-danger text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
          {unreadCount}
        </span>
      )}
    </Button>
  </PopoverTrigger>
  
  <PopoverContent className="w-[400px] p-0" align="end">
    <div className="flex items-center justify-between p-4 border-b">
      <h3 className="font-semibold">Уведомления</h3>
      {unreadCount > 0 && (
        <Button variant="ghost" size="sm" onClick={markAllAsRead}>
          Отметить все
        </Button>
      )}
    </div>
    
    <ScrollArea className="h-[400px]">
      {notifications.length === 0 ? (
        <div className="p-8 text-center text-secondary">
          <Bell className="h-12 w-12 mx-auto mb-2 opacity-50" />
          <p>Нет новых уведомлений</p>
        </div>
      ) : (
        <div className="divide-y">
          {notifications.map((notification) => (
            <div
              key={notification.id}
              className={cn(
                "p-4 hover:bg-card-hover transition cursor-pointer",
                !notification.readAt && "bg-primary/5"
              )}
              onClick={() => handleNotificationClick(notification)}
            >
              <div className="flex gap-3">
                <div className="flex-shrink-0">
                  {notification.type === 'APPROVAL_APPROVED' && (
                    <div className="h-10 w-10 rounded-full bg-success/10 flex items-center justify-center">
                      <Check className="h-5 w-5 text-success" />
                    </div>
                  )}
                  {notification.type === 'APPROVAL_REJECTED' && (
                    <div className="h-10 w-10 rounded-full bg-danger/10 flex items-center justify-center">
                      <X className="h-5 w-5 text-danger" />
                    </div>
                  )}
                  {notification.type === 'POS_ERROR' && (
                    <div className="h-10 w-10 rounded-full bg-warning/10 flex items-center justify-center">
                      <AlertTriangle className="h-5 w-5 text-warning" />
                    </div>
                  )}
                </div>
                
                <div className="flex-1 space-y-1">
                  <p className="text-sm font-medium">
                    {notification.title}
                  </p>
                  <p className="text-sm text-secondary">
                    {notification.message}
                  </p>
                  <p className="text-xs text-secondary">
                    {formatRelative(notification.createdAt)}
                  </p>
                </div>
                
                {!notification.readAt && (
                  <div className="flex-shrink-0">
                    <div className="w-2 h-2 bg-primary rounded-full" />
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      )}
    </ScrollArea>
  </PopoverContent>
</Popover>
```


***

## **📝 8. ACTIVITY LOG**

### **1️⃣8️⃣ Activity Log - что Manager видит?**

**Контекст:**
Admin видит Activity Log всех действий команды.

**Вопрос:**
Что показать Manager'у в Activity Log?

**A)** Все действия всей команды (как у Admin)
**B)** Только свои действия (что делал этот Manager)
**C)** Действия всей команды, но read-only
**D)** Ничего (Activity Log только для Admin)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Все действия команды (read-only)**

**Обоснование:**

- ✅ **Transparency** - Manager видит что делает команда (другие Manager'ы, Cashier'ы, Admin)
- ✅ **Accountability** - понятно кто за что отвечает
- ✅ **Audit trail** - если возник вопрос "кто изменил баланс гостя?" → проверяем в Activity Log
- ✅ **Read-only** - Manager не может редактировать/удалять записи (только просмотр)

**Фильтры (те же что у Admin):**

- Тип действия (Вход, Создание, Редактирование, Удаление, Корректировка баллов)
- Дата (range picker)
- Пользователь (dropdown: Я, Admin, Другие Manager'ы)
- Объект (Гость, Правило, Промо)

**UI:**

```tsx
<Card>
  <CardHeader>
    <div className="flex items-center justify-between">
      <div>
        <CardTitle>Activity Log</CardTitle>
        <CardDescription>
          История действий команды
        </CardDescription>
      </div>
      
      {userRole === 'MANAGER' && (
        <Badge variant="outline">Read-only</Badge>
      )}
    </div>
  </CardHeader>
  
  <CardContent>
    {/* Filters */}
    <div className="flex gap-4 mb-4">
      <Select value={actionFilter} onValueChange={setActionFilter}>
        <SelectTrigger className="w-[200px]">
          <SelectValue placeholder="Тип действия" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="all">Все действия</SelectItem>
          <SelectItem value="LOGIN">Вход в систему</SelectItem>
          <SelectItem value="CREATE">Создание</SelectItem>
          <SelectItem value="UPDATE">Редактирование</SelectItem>
          <SelectItem value="ADJUST_BALLS">Корректировка баллов</SelectItem>
          <SelectItem value="DELETE">Удаление</SelectItem>
        </SelectContent>
      </Select>
      
      <Select value={userFilter} onValueChange={setUserFilter}>
        <SelectTrigger className="w-[200px]">
          <SelectValue placeholder="Пользователь" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="all">Все пользователи</SelectItem>
          <SelectItem value="me">Только я</SelectItem>
          <SelectItem value="admin">Admin</SelectItem>
          <SelectItem value="managers">Другие Manager'ы</SelectItem>
        </SelectContent>
      </Select>
      
      <DateRangePicker
        value={dateRange}
        onChange={setDateRange}
      />
      
      <Input
        placeholder="Поиск..."
        value={searchQuery}
        onChange={(e) => setSearchQuery(e.target.value)}
        className="max-w-sm"
      />
    </div>
    
    {/* Activity Log Table */}
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Время</TableHead>
          <TableHead>Пользователь</TableHead>
          <TableHead>Действие</TableHead>
          <TableHead>Объект</TableHead>
          <TableHead>IP адрес</TableHead>
          <TableHead>Статус</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {activityLogs.map((log) => (
          <TableRow key={log.id}>
            <TableCell>{formatDateTime(log.createdAt)}</TableCell>
            <TableCell>
              <div className="flex items-center gap-2">
                <Avatar className="h-6 w-6">
                  <AvatarFallback className="text-xs">
                    {getInitials(log.user.firstName, log.user.lastName)}
                  </AvatarFallback>
                </Avatar>
                <div>
                  <div className="text-sm font-medium">
                    {log.user.firstName} {log.user.lastName}
                  </div>
                  <Badge variant="outline" className="text-xs">
                    {log.user.role}
                  </Badge>
                </div>
              </div>
            </TableCell>
            <TableCell>
              <div className="flex items-center gap-2">
                {ACTION_ICONS[log.actionType]}
                <span>{ACTION_NAMES[log.actionType]}</span>
              </div>
            </TableCell>
            <TableCell>
              <div className="text-sm">
                {log.targetName}
              </div>
            </TableCell>
            <TableCell className="font-mono text-xs">
              {log.ipAddress}
            </TableCell>
            <TableCell>
              <Badge variant={log.status === 'SUCCESS' ? 'success' : 'destructive'}>
                {log.status}
              </Badge>
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  </CardContent>
</Card>
```


***

## **🔗 9. POS INTEGRATION**

### **1️⃣9️⃣ POS Integration - что Manager видит?**

**Контекст:**
Admin настраивает POS интеграцию (credentials, webhook URL, test connection).

**Вопрос:**
Что показать Manager'у на странице POS Integration?

**A)** Ничего (страница полностью скрыта)
**B)** Статус интеграции + Recent Transactions (read-only)
**C)** Полный доступ как у Admin (может менять credentials)
**D)** Статус + Test Connection button (может тестировать, но не менять настройки)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Статус + Recent Transactions (read-only) + D) Test Connection**

**Обоснование:**

- ✅ **Статус интеграции** - Manager видит работает ли POS sync (Active/Error)
- ✅ **Metrics** - Последняя синхронизация, Транзакций сегодня, Ошибок
- ✅ **Recent Transactions** - таблица последних транзакций из POS (Manager проверяет что баллы начисляются корректно)
- ✅ **Test Connection button** - Manager может протестировать подключение (без доступа к credentials)
- ❌ **НЕ показывается:**
    - API credentials (encrypted, только Admin видит)
    - Webhook URL (только Admin может копировать)
    - Кнопка "Редактировать настройки" (только Admin)
    - Кнопка "Отключить интеграцию" (только Admin)

**UI:**

```tsx
<Card>
  <CardHeader>
    <div className="flex items-center justify-between">
      <div className="flex items-center gap-4">
        <img
          src={integration.provider.logo}
          alt={integration.provider.name}
          className="h-12"
        />
        <div>
          <CardTitle>{integration.provider.name}</CardTitle>
          <CardDescription>
            {integration.method === 'WEBHOOK' ? 'Webhook (Push)' : 'API Polling (Pull)'}
          </CardDescription>
        </div>
      </div>
      <Badge variant={integration.status === 'ACTIVE' ? 'success' : 'destructive'}>
        {integration.status === 'ACTIVE' ? '✓ Активна' : '✕ Ошибка'}
      </Badge>
    </div>
  </CardHeader>
  
  <CardContent className="space-y-4">
    <div className="grid grid-cols-3 gap-4">
      <div>
        <Label className="text-xs text-secondary">Последняя синхронизация</Label>
        <p className="font-medium">{formatRelative(integration.lastSync)}</p>
      </div>
      <div>
        <Label className="text-xs text-secondary">Транзакций сегодня</Label>
        <p className="font-medium">{integration.todayTransactions}</p>
      </div>
      <div>
        <Label className="text-xs text-secondary">Ошибок</Label>
        <p className="font-medium text-danger">{integration.errorsCount}</p>
      </div>
    </div>
    
    {/* Manager может тестировать, но не видит credentials */}
    <div className="flex gap-2">
      <Button onClick={testConnection}>
        <Zap className="mr-2 h-4 w-4" />
        Тестировать подключение
      </Button>
      <Button variant="outline" onClick={viewSyncLog}>
        <FileText className="mr-2 h-4 w-4" />
        Лог синхронизации
      </Button>
      
      {/* Настройки НЕ доступны Manager'у */}
      {userRole === 'ADMIN' && (
        <Button variant="outline" onClick={editIntegration}>
          <Settings className="mr-2 h-4 w-4" />
          Настройки
        </Button>
      )}
    </div>
    
    {userRole === 'MANAGER' && (
      <Alert>
        <Lock className="h-4 w-4" />
        <AlertDescription>
          Настройки интеграции доступны только Admin'у
        </AlertDescription>
      </Alert>
    )}
  </CardContent>
</Card>

{/* Recent Transactions (read-only) */}
<Card>
  <CardHeader>
    <CardTitle>Последние транзакции из POS</CardTitle>
  </CardHeader>
  <CardContent>
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Дата</TableHead>
          <TableHead>Чек №</TableHead>
          <TableHead>Гость</TableHead>
          <TableHead>Сумма</TableHead>
          <TableHead>Начислено</TableHead>
          <TableHead>Списано</TableHead>
          <TableHead>Статус</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {posTransactions.map((tx) => (
          <TableRow key={tx.id}>
            <TableCell>{formatDateTime(tx.createdAt)}</TableCell>
            <TableCell className="font-mono">{tx.checkId}</TableCell>
            <TableCell>{tx.guestName || tx.guestPhone}</TableCell>
            <TableCell>{formatCurrency(tx.checkAmount)}</TableCell>
            <TableCell className="text-success">
              {tx.earnedPoints ? `+${tx.earnedPoints}` : '—'}
            </TableCell>
            <TableCell className="text-danger">
              {tx.redeemedPoints ? `−${tx.redeemedPoints}` : '—'}
            </TableCell>
            <TableCell>
              <Badge variant={tx.status === 'SUCCESS' ? 'success' : 'destructive'}>
                {tx.status}
              </Badge>
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  </CardContent>
</Card>
```


***

## **📱 10. MOBILE VIEW**

### **2️⃣0️⃣ Mobile - те же адаптации что у Admin?**

**Контекст:**
Admin Dashboard адаптирован для mobile (Bottom Nav, Cards вместо таблиц, FAB).

**Вопрос:**
Использовать ту же mobile адаптацию для Manager?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: ДА, идентичная mobile адаптация**

**Обоснование:**

- ✅ **Consistency** - одинаковый UX для всех ролей на mobile
- ✅ **Component reuse** - не нужно делать отдельные mobile компоненты
- ✅ **Manager часто на выезде** - мобильная версия критична

**Mobile Layout (< 768px):**

- Top Bar (fixed) - Logo, Notifications, Hamburger
- Content Area (scrollable)
- Bottom Navigation (fixed) - Dashboard, Guests, Loyalty, Analytics, Settings

**Отличие от Admin:** в Hamburger Menu нет пунктов Team и Billing

***

## **🎯 11. SPECIAL SCENARIOS**

### **2️⃣1️⃣ Multi-Manager Coordination - как избежать конфликтов?**

**Контекст:**
В ресторане несколько Manager'ов. Один создаёт правило, другой редактирует того же гостя одновременно.

**Вопрос:**
Как предотвратить конфликты?

**A)** Optimistic locking (последний сохранённый wins)
**B)** Pessimistic locking (кто открыл первым, тот блокирует)
**C)** Real-time indicators "Manager X сейчас редактирует этого гостя"
**D)** Version control с conflict resolution UI

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Real-time indicators + A) Optimistic locking с conflict warning**

**Обоснование:**

**Real-time indicators (через WebSocket/SSE):**

```tsx
// При открытии Guest Profile
{currentlyEditing.length > 0 && (
  <Alert className="mb-4">
    <Users className="h-4 w-4" />
    <AlertDescription>
      <strong>{currentlyEditing.map(u => u.firstName).join(', ')}</strong> 
      {currentlyEditing.length === 1 ? ' сейчас просматривает' : ' сейчас просматривают'} 
      этого гостя
    </AlertDescription>
  </Alert>
)}
```

**Optimistic locking с conflict detection:**

```tsx
// При сохранении
try {
  await updateGuest({
    id: guest.id,
    data: updatedData,
    version: guest.version // Prisma optimistic locking
  });
  
  toast.success('Гость обновлён');
} catch (error) {
  if (error.code === 'CONFLICT') {
    // Другой Manager сохранил изменения раньше
    setShowConflictModal(true);
  }
}
```

**Conflict Resolution Modal:**

```tsx
<Dialog open={showConflictModal} onOpenChange={setShowConflictModal}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Конфликт изменений</DialogTitle>
      <DialogDescription>
        {conflictingUser.firstName} сохранил изменения пока вы редактировали
      </DialogDescription>
    </DialogHeader>
    
    <div className="space-y-4">
      <div>
        <Label>Ваша версия</Label>
        <pre className="bg-muted p-3 rounded text-sm">
          {JSON.stringify(yourChanges, null, 2)}
        </pre>
      </div>
      
      <div>
        <Label>Их версия (актуальная)</Label>
        <pre className="bg-muted p-3 rounded text-sm">
          {JSON.stringify(theirChanges, null, 2)}
        </pre>
      </div>
    </div>
    
    <DialogFooter>
      <Button variant="outline" onClick={discardYourChanges}>
        Отменить мои изменения
      </Button>
      <Button onClick={overwriteTheirChanges}>
        Перезаписать их изменения
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```


***

### **2️⃣2️⃣ Manager Request to Admin - как Manager запрашивает что-то у Admin'а?**

**Контекст:**
Manager хочет: увеличить лимит экспорта, получить новый permission, изменить критичную настройку.

**Вопрос:**
Как Manager может запросить это у Admin'а?

**A)** Email/Telegram Admin'у вне системы
**B)** In-app "Request" button → Admin получает уведомление
**C)** Comment system (Manager оставляет комментарий к объекту)
**D)** Никак (Manager должен говорить лично)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) In-app Request System**

**Обоснование:**

- ✅ **Удобство** - не нужно выходить из системы
- ✅ **Audit trail** - все запросы логируются
- ✅ **Transparency** - Admin видит историю запросов

**UI (кнопка "Request" в разных местах):**

**1. Settings → Profile:**

```tsx
<Card>
  <CardHeader>
    <CardTitle>Мои права доступа</CardTitle>
  </CardHeader>
  <CardContent className="space-y-3">
    {AVAILABLE_PERMISSIONS.map((permission) => (
      <div key={permission.id} className="flex items-center justify-between">
        <div>
          <div className="font-medium">{permission.name}</div>
          <div className="text-sm text-secondary">{permission.description}</div>
        </div>
        
        {userPermissions.includes(permission.id) ? (
          <Badge variant="success">
            <Check className="mr-1 h-3 w-3" />
            Есть
          </Badge>
        ) : (
          <Button
            variant="outline"
            size="sm"
            onClick={() => requestPermission(permission)}
          >
            Запросить
          </Button>
        )}
      </div>
    ))}
  </CardContent>
</Card>
```

**2. Request Modal:**

```tsx
<Dialog open={showRequestModal} onOpenChange={setShowRequestModal}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Запрос разрешения</DialogTitle>
      <DialogDescription>
        Ваш запрос будет отправлен Admin'у
      </DialogDescription>
    </DialogHeader>
    
    <div className="space-y-4">
      <div>
        <Label>Разрешение</Label>
        <div className="mt-2 p-3 border rounded-lg">
          <div className="font-medium">{requestingPermission.name}</div>
          <div className="text-sm text-secondary">{requestingPermission.description}</div>
        </div>
      </div>
      
      <div>
        <Label>Причина запроса *</Label>
        <Textarea
          placeholder="Например: Мне нужно экспортировать базу гостей для email-рассылки"
          value={requestReason}
          onChange={(e) => setRequestReason(e.target.value)}
          required
          minLength={20}
          rows={4}
        />
      </div>
    </div>
    
    <DialogFooter>
      <Button variant="outline" onClick={() => setShowRequestModal(false)}>
        Отмена
      </Button>
      <Button onClick={submitRequest}>
        Отправить запрос
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

**3. Admin видит запросы:**

```tsx
// В Notifications или отдельная секция Team → Requests
<Card>
  <CardHeader>
    <CardTitle>
      Запросы от команды ({pendingRequests.length})
    </CardTitle>
  </CardHeader>
  <CardContent className="space-y-3">
    {pendingRequests.map((request) => (
      <div key={request.id} className="flex items-start justify-between p-4 border rounded-lg">
        <div>
          <div className="flex items-center gap-2 mb-1">
            <Avatar className="h-6 w-6">
              <AvatarFallback className="text-xs">
                {getInitials(request.user.firstName, request.user.lastName)}
              </AvatarFallback>
            </Avatar>
            <span className="font-semibold">
              {request.user.firstName} {request.user.lastName}
            </span>
            <Badge variant="outline">{request.user.role}</Badge>
          </div>
          
          <div className="text-sm mb-2">
            <strong>Запрашивает:</strong> {request.permissionName}
          </div>
          
          <div className="text-sm text-secondary">
            <strong>Причина:</strong> {request.reason}
          </div>
          
          <div className="text-xs text-secondary mt-1">
            {formatRelative(request.createdAt)}
          </div>
        </div>
        
        <div className="flex gap-2">
          <Button
            size="sm"
            onClick={() => approveRequest(request)}
          >
            <Check className="mr-2 h-4 w-4" />
            Одобрить
          </Button>
          <Button
            variant="outline"
            size="sm"
            onClick={() => rejectRequest(request)}
          >
            <X className="mr-2 h-4 w-4" />
            Отклонить
          </Button>
        </div>
      </div>
    ))}
  </CardContent>
</Card>
```


***

### **2️⃣3️⃣ Manager Training Mode - как обучить нового Manager'а?**

**Контекст:**
Новый Manager впервые заходит в систему после приглашения.

**Вопрос:**
Показать ли onboarding для Manager'а?

**A)** Нет (Manager сам разберётся)
**B)** Да, Interactive Tour (подсказки на элементах)
**C)** Да, Video Tutorial (встроенное видео)
**D)** Да, Practice Mode (тестовые данные для тренировки)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Interactive Tour + D) Practice Mode (опционально)**

**Обоснование:**

**Interactive Tour (при первом входе):**

```tsx
// Использовать библиотеку react-joyride
const tourSteps = [
  {
    target: '.dashboard-kpis',
    content: 'Здесь вы видите основные метрики ресторана: количество гостей, активность, Loyalty ROI',
    placement: 'bottom'
  },
  {
    target: '.quick-actions',
    content: 'Быстрые действия: добавить гостя, начислить баллы, создать промо-акцию',
    placement: 'bottom'
  },
  {
    target: '.sidebar-guests',
    content: 'Управление гостями: список, фильтры, профили',
    placement: 'right'
  },
  {
    target: '.sidebar-loyalty',
    content: 'Loyalty Builder: правила начисления, уровни, промо-акции. Активация требует одобрения Admin\'а',
    placement: 'right'
  },
  {
    target: '.sidebar-analytics',
    content: 'Аналитика: RFM сегментация, выручка, Loyalty ROI',
    placement: 'right'
  },
  {
    target: '.profile-dropdown',
    content: 'Здесь вы можете изменить профиль, увидеть свои права доступа, запросить новые разрешения',
    placement: 'bottom'
  }
];

<Joyride
  steps={tourSteps}
  run={showTour}
  continuous
  showProgress
  showSkipButton
  styles={{
    options: {
      primaryColor: '#3b82f6',
      zIndex: 1000
    }
  }}
/>
```

**Practice Mode (optional, в Settings):**

```tsx
<Card>
  <CardHeader>
    <CardTitle>Режим тренировки</CardTitle>
    <CardDescription>
      Попрактикуйтесь с тестовыми данными
    </CardDescription>
  </CardHeader>
  <CardContent>
    <Alert className="mb-4">
      <Info className="h-4 w-4" />
      <AlertDescription>
        В режиме тренировки вы работаете с тестовыми гостями. Изменения не влияют на реальные данные.
      </AlertDescription>
    </Alert>
    
    <Button onClick={enablePracticeMode}>
      <Play className="mr-2 h-4 w-4" />
      Начать тренировку
    </Button>
  </CardContent>
</Card>
```


***

## **🔒 12. SECURITY \& AUDIT**

### **2️⃣4️⃣ Audit Trail - логируются ли действия Manager'а?**

**Контекст:**
Manager начисляет баллы, создаёт промо, редактирует гостей.

**Вопрос:**
Логировать ли все действия Manager'а?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: ДА, полное логирование всех действий**

**Обоснование:**

- ✅ **Accountability** - понятно кто за что отвечает
- ✅ **Security** - детектирование подозрительной активности (например, Manager начислил себе 1M баллов)
- ✅ **Compliance** - audit trail для проверок
- ✅ **Troubleshooting** - если что-то сломалось, можно найти причину

**Логируемые события:**

```typescript
enum ManagerActionType {
  // Guest Management
  CREATE_GUEST = 'create_guest',
  UPDATE_GUEST = 'update_guest',
  DEACTIVATE_GUEST = 'deactivate_guest',
  
  // Balls Adjustment
  ADJUST_BALLS_MANUAL = 'adjust_balls_manual',
  BALLS_TRANSFER = 'balls_transfer',
  
  // Loyalty
  CREATE_RULE = 'create_rule',
  UPDATE_RULE = 'update_rule',
  CREATE_PROMO = 'create_promo',
  ACTIVATE_PROMO = 'activate_promo',
  DEACTIVATE_PROMO = 'deactivate_promo',
  
  // Export
  EXPORT_GUESTS = 'export_guests',
  EXPORT_REPORT = 'export_report',
  
  // Bulk Operations
  BULK_ADD_BALLS = 'bulk_add_balls',
  BULK_SEND_NOTIFICATION = 'bulk_send_notification',
  BULK_ADD_TAG = 'bulk_add_tag',
  
  // Settings
  UPDATE_PROFILE = 'update_profile',
  CHANGE_PASSWORD = 'change_password',
  
  // Requests
  REQUEST_PERMISSION = 'request_permission'
}
```

**Activity Log Entry:**

```typescript
{
  id: 'log_123',
  actionType: 'ADJUST_BALLS_MANUAL',
  performedBy: {
    id: 'manager_456',
    firstName: 'Мария',
    lastName: 'Петрова',
    role: 'MANAGER'
  },
  targetUser: {
    id: 'guest_789',
    firstName: 'Иван',
    lastName: 'Иванов'
  },
  metadata: {
    ballsAdded: 500,
    reason: 'Компенсация за ошибку',
    balanceBefore: 1200,
    balanceAfter: 1700
  },
  ipAddress: '192.168.1.100',
  userAgent: 'Mozilla/5.0...',
  createdAt: '2026-02-16T14:30:00Z'
}
```


***

### **2️⃣5️⃣ Permission Changes - как Manager узнаёт что права изменились?**

**Контекст:**
Admin изменил permissions Manager'а (добавил "Экспорт данных", убрал "Удаление гостей").

**Вопрос:**
Как Manager узнаёт об изменениях?

**A)** При следующем входе (перезагрузка страницы)
**B)** Real-time notification + автоматический refresh UI
**C)** Email уведомление
**D)** Manager сам проверяет в Settings → Permissions

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Real-time notification + Auto UI refresh**

**Обоснование:**

- ✅ **Instant feedback** - Manager сразу видит что права изменились
- ✅ **No confusion** - не возникает ситуация "раньше кнопка была, теперь пропала"
- ✅ **Transparency** - понятно что Admin изменил

**Implementation:**

**Backend (WebSocket/SSE event):**

```typescript
// Когда Admin меняет permissions
await this.eventBus.emit('permissions.updated', {
  userId: manager.id,
  updatedPermissions: newPermissions,
  changedBy: admin.id
});
```

**Frontend (Manager's session):**

```typescript
// Manager получает event
socket.on('permissions.updated', (data) => {
  // Показать notification
  toast.info('Ваши права доступа были изменены', {
    description: 'Обновляем интерфейс...',
    duration: 3000
  });
  
  // Fetch новые permissions
  queryClient.invalidateQueries(['user-permissions']);
  
  // Refresh UI (показать/скрыть кнопки)
  setTimeout(() => {
    window.location.reload(); // Или soft reload компонентов
  }, 3000);
});
```

**Toast Notification:**

```tsx
<Toast>
  <div className="flex items-start gap-3">
    <div className="h-10 w-10 rounded-full bg-info/10 flex items-center justify-center">
      <Shield className="h-5 w-5 text-info" />
    </div>
    <div className="flex-1">
      <div className="font-semibold">Права доступа изменены</div>
      <div className="text-sm text-secondary">
        Admin обновил ваши разрешения. Интерфейс будет обновлён через 3 секунды.
      </div>
      <Button
        variant="link"
        size="sm"
        className="mt-2 h-auto p-0"
        onClick={viewPermissions}
      >
        Посмотреть изменения
      </Button>
    </div>
  </div>
</Toast>
```


***

# ✅ **ИТОГО: 25 ВОПРОСОВ MANAGER DASHBOARD РЕШЕНЫ!**

**Готов составить полный список всех 25 решений для Manager Dashboard в следующем сообщении?** Или переходим к следующему блоку?

**Следующие блоки:**

1. **Cashier POS Interface** - специализированный интерфейс для кассиров
2. **Guest Telegram Mini App** - мобильное приложение для гостей
3. **Детализация API \& Webhooks** - REST API, authentication, rate limits
4. **Deployment \& Infrastructure** - Docker, CI/CD, monitoring

**Что делаем?** 🚀

<div align="center">⁂</div>

[^12_1]: Beseda-3.md

[^12_2]: Beseda-2.md


---

# 📋 **MANAGER DASHBOARD - ФИНАЛЬНЫЕ РЕШЕНИЯ ПО 25 ВОПРОСАМ**


***

## **🔐 1. ROLE \& PERMISSIONS**

### **Вопрос 1: Manager vs Admin - чем отличаются права доступа?**

**Принятое решение:** Manager видит всё кроме критичных секций (Billing, Team Management, Security Settings) + Permission-based restrictions

**Обоснование:**

**Manager имеет доступ к:**

- Dashboard (KPIs, Charts, Quick Actions) - полный доступ
- Guests Management (CRUD, фильтры, search, bulk actions, guest profiles) - полный доступ
- Loyalty Builder (Rules, Levels, Promos, Design) - с ограничениями (создание требует одобрения Admin, Levels и Design read-only)
- Analytics (все 5 табов) - полный доступ
- POS Integration - только просмотр статуса и recent transactions (НЕ может менять credentials)
- Activity Log - только просмотр (read-only)

**Manager НЕ имеет доступа к:**

- Team Management (не может invite/remove пользователей)
- Billing/Subscription (не видит тариф, оплату, invoices)
- Critical Settings: API credentials, Webhook URLs, Security settings (2FA, API tokens), Subscription management
- Impersonation (только Owner может)
- Permanent delete гостей (может деактивировать, но не удалить из БД)

**Permission-based restrictions (Admin настраивает):**

- Управление гостями (CRUD)
- Ручная корректировка баллов
- Создание промо-акций (с одобрением Admin)
- Просмотр аналитики
- Экспорт данных
- Управление настройками loyalty (read-only или по разрешению)
- Auto-activate promo (если разрешено, Manager может активировать промо без одобрения)

**Таблица сравнения:**

```
Раздел / Функция             Admin    Manager
──────────────────────────────────────────────
Dashboard                    ✓        ✓
Guests Management            ✓        ✓
Loyalty Rules                ✓        ✓* (одобрение)
Loyalty Levels               ✓        Read-only
Promo Campaigns              ✓        ✓* (одобрение)
Card Design                  ✓        Read-only
Analytics                    ✓        ✓
POS Integration              ✓        Read-only
Team Management              ✓        ✕
Billing/Subscription         ✓        ✕
Restaurant Settings          ✓        Partial
Security Settings            ✓        ✕
Activity Log                 ✓        Read-only
Delete Guests                ✓        ✕
Export Data                  ✓        ✓ (permission)
```


***

### **Вопрос 2: Permission Badges - как показать Manager'у его права?**

**Принятое решение:** Скрыть недоступные разделы + Badge "Read-only" на ограниченных + Disabled кнопки с Tooltip

**Обоснование:**

- **Скрыть полностью недоступные** - Team Management, Billing не показываются в sidebar (cleaner UI)
- **Badge "Read-only"** - POS Integration, Activity Log видны с Badge и Tooltip "Только просмотр"
- **Disable кнопок** - кнопка "Удалить гостя" disabled + Tooltip "Требуется роль Admin"
- **Approval Required Badge** - на кнопке "Активировать промо" → Badge + Toast "Отправлено на одобрение"

**UI Sidebar Navigation:**

```tsx
<SidebarNav>
  <SidebarItem href="/manager/dashboard">Dashboard</SidebarItem>
  <SidebarItem href="/manager/guests">Guests</SidebarItem>
  <SidebarItem href="/manager/loyalty">Loyalty</SidebarItem>
  <SidebarItem href="/manager/analytics">Analytics</SidebarItem>
  <SidebarItem href="/manager/pos">
    POS Integration
    <Badge variant="outline">Read-only</Badge>
  </SidebarItem>
  <SidebarItem href="/manager/settings">Settings</SidebarItem>
  <SidebarItem href="/manager/activity-log">
    Activity Log
    <Badge variant="outline">Read-only</Badge>
  </SidebarItem>
  
  {/* НЕ показываются: Team Management, Billing */}
</SidebarNav>
```

**Tooltip на disabled кнопке:**

```tsx
<Tooltip>
  <TooltipTrigger asChild>
    <span>
      <Button disabled className="cursor-not-allowed">
        <Trash2 className="mr-2 h-4 w-4" />
        Удалить гостя
      </Button>
    </span>
  </TooltipTrigger>
  <TooltipContent>
    Требуется роль Admin
  </TooltipContent>
</Tooltip>
```


***

### **Вопрос 3: Manager Profile Badge - как Manager понимает свою роль?**

**Принятое решение:** Badge "Manager" в header + Permission indicator в Profile Dropdown

**Обоснование:**

- **Badge в header** - постоянно виден рядом с именем пользователя (outline стиль)
- **Profile Dropdown** - показывает: имя, email, Role Badge (Manager), кнопка "Мои права доступа" → Modal со списком permissions

**UI Profile Dropdown:**

```tsx
<DropdownMenu>
  <DropdownMenuTrigger asChild>
    <Button variant="ghost">
      <Avatar>
        <AvatarImage src={user.avatar} />
        <AvatarFallback>{getInitials(user.firstName, user.lastName)}</AvatarFallback>
      </Avatar>
      <div className="ml-2 text-left">
        <div className="text-sm font-medium">{user.firstName}</div>
        <Badge variant="outline" className="text-xs">Manager</Badge>
      </div>
    </Button>
  </DropdownMenuTrigger>
  
  <DropdownMenuContent align="end" className="w-64">
    <DropdownMenuLabel>
      <div>{user.firstName} {user.lastName}</div>
      <div className="text-xs text-secondary font-normal">{user.email}</div>
    </DropdownMenuLabel>
    
    <DropdownMenuSeparator />
    
    <DropdownMenuItem onClick={viewPermissions}>
      <Shield className="mr-2 h-4 w-4" />
      Мои права доступа
    </DropdownMenuItem>
    
    <DropdownMenuItem onClick={viewProfile}>
      <User className="mr-2 h-4 w-4" />
      Профиль
    </DropdownMenuItem>
    
    <DropdownMenuSeparator />
    
    <DropdownMenuItem onClick={logout}>
      <LogOut className="mr-2 h-4 w-4" />
      Выйти
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

**Permissions Modal:**

- Список всех permissions с иконками ✓ (есть) или ✕ (нет)
- Описание каждого permission
- Текст внизу: "Для изменения прав обратитесь к Admin'у"

***

## **📊 2. DASHBOARD HOME**

### **Вопрос 4: Manager Dashboard - показать те же KPI что Admin?**

**Принятое решение:** ДА, идентичные KPI (Всего гостей | Активных (30д) | Баллов начислено | Loyalty ROI)

**Обоснование:**

- **Consistency** - Manager и Admin видят одну картину, проще обсуждать результаты
- **Мотивация** - Manager видит те же KPI что влияют на успех ресторана
- **No confusion** - не нужно объяснять "почему у меня одни цифры, а у Admin'а другие"
- **Reusability** - один компонент для обеих ролей

**Метрики:**

```
┌──────────────────────┐  ┌──────────────────────┐
│ 👥 Всего гостей      │  │ ✅ Активных (30д)    │
│ 2,847                │  │ 1,876 (66%)          │
│ ↑ +123 за месяц      │  │ ↑ +98 за месяц       │
└──────────────────────┘  └──────────────────────┘

┌──────────────────────┐  ┌──────────────────────┐
│ 🎁 Баллов начислено  │  │ 📈 Loyalty ROI       │
│ 45,680               │  │ 1:8.4                │
│ ↑ +5,420 за месяц    │  │ ↑ +0.3 (улучшение)   │
└──────────────────────┘  └──────────────────────┘
```


***

### **Вопрос 5: Dashboard Charts - показать те же графики?**

**Принятое решение:** ДА, те же 4 графика что у Admin

**Обоснование:**

- Полная картина бизнеса
- Component reuse (DRY)
- Manager должен понимать динамику

**Графики:**

1. **Guests Growth** (Line Chart, 6 месяцев) - рост базы гостей
2. **Revenue + Balls Earned** (Combined Chart, 30 дней) - выручка + начисленные баллы
3. **Loyalty Levels Distribution** (Donut Chart) - распределение по уровням
4. **Top 10 Guests Leaderboard** - топ-10 гостей по Lifetime Spent

***

### **Вопрос 6: Quick Actions - те же или другие для Manager?**

**Принятое решение:** Те же Quick Actions + Permission-based visibility

**Обоснование:**

- **Добавить гостя** - всегда доступно Manager'у
- **Ручная корректировка** - если permission "Корректировка баллов"
- **Создать промо** - если permission "Создание промо" (с Badge "Требует одобрения")
- **Экспорт** - если permission "Экспорт данных"

**UI Conditional Rendering:**

```tsx
<div className="grid grid-cols-4 gap-4">
  {/* Всегда доступно */}
  <QuickActionCard
    icon={UserPlus}
    title="Добавить гостя"
    onClick={openAddGuestModal}
  />
  
  {/* Permission-based */}
  {hasPermission('ADJUST_BALLS') && (
    <QuickActionCard
      icon={Edit}
      title="Корректировка"
      onClick={openAdjustBallsModal}
    />
  )}
  
  {hasPermission('CREATE_PROMO') && (
    <QuickActionCard
      icon={Gift}
      title="Создать промо"
      badge="Требует одобрения"
      onClick={openCreatePromoModal}
    />
  )}
  
  {hasPermission('EXPORT_DATA') && (
    <QuickActionCard
      icon={Download}
      title="Экспорт"
      onClick={openExportModal}
    />
  )}
</div>
```


***

## **👥 3. GUESTS MANAGEMENT**

### **Вопрос 7: Guests Page - полный доступ или ограничения?**

**Принятое решение:** Полный доступ кроме permanent delete + Permission-based restrictions

**Обоснование:**

**Может:**

- Просматривать всех гостей
- Добавлять новых гостей
- Редактировать профили (если permission)
- Начислять/списывать баллы (если permission)
- Экспортировать (если permission)
- Bulk actions (если permission)
- Деактивировать гостя (статус INACTIVE)
- Отправлять уведомления

**НЕ может:**

- Удалять гостя permanently (hard delete) - только Admin
- Восстанавливать удалённых гостей

**UI Dropdown Actions:**

```tsx
<DropdownMenu>
  <DropdownMenuContent>
    <DropdownMenuItem onClick={() => viewGuest(guest)}>
      <Eye className="mr-2 h-4 w-4" />
      Просмотр деталей
    </DropdownMenuItem>
    
    {hasPermission('EDIT_GUESTS') && (
      <DropdownMenuItem onClick={() => editGuest(guest)}>
        <Edit className="mr-2 h-4 w-4" />
        Редактировать
      </DropdownMenuItem>
    )}
    
    {hasPermission('ADJUST_BALLS') && (
      <DropdownMenuItem onClick={() => adjustBalls(guest)}>
        <Gift className="mr-2 h-4 w-4" />
        Корректировка баллов
      </DropdownMenuItem>
    )}
    
    <DropdownMenuItem onClick={() => viewHistory(guest)}>
      <History className="mr-2 h-4 w-4" />
      История
    </DropdownMenuItem>
    
    <DropdownMenuSeparator />
    
    <DropdownMenuItem onClick={() => deactivateGuest(guest)}>
      <Ban className="mr-2 h-4 w-4" />
      Деактивировать
    </DropdownMenuItem>
    
    {/* Delete НЕ показывается Manager'у */}
  </DropdownMenuContent>
</DropdownMenu>
```


***

### **Вопрос 8: Guest Profile - те же табы что у Admin?**

**Принятое решение:** ДА, все 6 табов (Overview, Transactions, Visits, Children, Activity Log, Analytics)

**Обоснование:**

- Manager должен иметь полное представление о госте
- Все табы информативные, ничего критичного
- Activity Log показывает transparency (кто что делал)

**Ограничения в табах:**

- **Overview:** Quick Actions disabled если нет permission, кнопка "Удалить" не показывается
- **Transactions:** Read-only (не может редактировать/удалять транзакции)
- **Visits:** Read-only
- **Children:** Может добавлять/редактировать
- **Activity Log:** Read-only
- **Analytics:** Read-only

***

### **Вопрос 9: Bulk Actions - доступны Manager'у?**

**Принятое решение:** Все кроме "Удалить" + Permission-based

**Обоснование:**

- **Экспорт** - если permission "Экспорт данных"
- **Добавить баллы** - если permission "Корректировка баллов"
- **Отправить уведомление** - всегда доступно
- **Применить тег** - всегда доступно
- **Удалить** - только Admin

**UI Fixed Bottom Bar:**

```tsx
{selectedGuests.length > 0 && (
  <Card className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 shadow-lg">
    <CardContent className="p-4 flex items-center gap-4">
      <Checkbox checked={allSelected} onCheckedChange={toggleSelectAll} />
      <span className="font-semibold">{selectedGuests.length} выбрано</span>
      
      <Separator orientation="vertical" className="h-6" />
      
      <div className="flex gap-2">
        {hasPermission('EXPORT_DATA') && (
          <Button variant="outline" size="sm" onClick={exportSelected}>
            <Download className="mr-2 h-4 w-4" />
            Экспорт
          </Button>
        )}
        
        {hasPermission('ADJUST_BALLS') && (
          <Button variant="outline" size="sm" onClick={openBulkAddBalls}>
            <Gift className="mr-2 h-4 w-4" />
            Добавить баллы
          </Button>
        )}
        
        <Button variant="outline" size="sm" onClick={openBulkNotification}>
          <Send className="mr-2 h-4 w-4" />
          Уведомление
        </Button>
        
        <Button variant="outline" size="sm" onClick={openBulkTag}>
          <Tag className="mr-2 h-4 w-4" />
          Применить тег
        </Button>
        
        {/* Удалить НЕ показывается */}
      </div>
      
      <Button variant="ghost" size="sm" onClick={() => setSelectedGuests([])}>
        <X className="h-4 w-4" />
      </Button>
    </CardContent>
  </Card>
)}
```


***

## **🎁 4. LOYALTY BUILDER**

### **Вопрос 10: Loyalty Builder - полный доступ или ограничения?**

**Принятое решение:** Создание/редактирование с одобрением Admin + Levels и Design read-only

**Обоснование:**

**Rules (Правила начисления):**

- ✅ Manager может создавать/редактировать
- ⚠️ Activation/Deactivation требует одобрения Admin
- Процесс: создаёт → PENDING_APPROVAL → Admin одобряет → APPROVED → активация

**Levels (Уровни лояльности):**

- ❌ Read-only для Manager
- Причина: изменение порогов критично (влияет на всех гостей)

**Promos (Промо-акции):**

- ✅ Manager может создавать/редактировать
- ⚠️ Activation требует одобрения (если нет permission AUTO_ACTIVATE_PROMO)
- ✅ Может деактивировать свои активные промо

**Design (Дизайн карточки):**

- ❌ Read-only для Manager
- Причина: дизайн = бренд ресторана (решает Admin)

**UI индикация:**

```tsx
<Tabs defaultValue="rules">
  <TabsContent value="rules">
    <div className="flex items-center justify-between">
      <div>
        <h2 className="text-2xl font-bold">Правила начисления</h2>
        {userRole === 'MANAGER' && (
          <p className="text-sm text-secondary">
            Активация требует одобрения Admin'а
          </p>
        )}
      </div>
      
      {hasPermission('CREATE_RULES') && (
        <Button onClick={openCreateRule}>
          <Plus className="mr-2 h-4 w-4" />
          Создать правило
        </Button>
      )}
    </div>
    
    {rules.map((rule) => (
      <RuleCard key={rule.id} rule={rule}>
        {rule.status === 'PENDING_APPROVAL' && (
          <Badge variant="warning">Ожидает одобрения</Badge>
        )}
      </RuleCard>
    ))}
  </TabsContent>
  
  <TabsContent value="levels">
    <div className="flex items-center justify-between">
      <h2 className="text-2xl font-bold">Уровни лояльности</h2>
      {userRole === 'MANAGER' && (
        <Badge variant="outline">Read-only</Badge>
      )}
    </div>
    {/* Timeline без редактирования */}
  </TabsContent>
</Tabs>
```


***

### **Вопрос 11: Approval Workflow - как Admin одобряет изменения Manager'а?**

**Принятое решение:** In-app Notification + Approval Queue в Loyalty Builder

**Обоснование:**

- **Notification Bell** - Admin получает "Manager создал правило 'Weekend Bonus'"
- **Badge на Loyalty Builder** - в sidebar показывается количество pending items
- **Approval Queue Section** - collapsible секция в начале Loyalty Builder

**UI Approval Queue (для Admin):**

```tsx
{pendingApprovals.length > 0 && (
  <Card className="mb-6 border-warning">
    <CardHeader>
      <div className="flex items-center justify-between">
        <CardTitle className="flex items-center gap-2">
          <AlertCircle className="h-5 w-5 text-warning" />
          Ожидают одобрения ({pendingApprovals.length})
        </CardTitle>
        <Button variant="ghost" size="sm" onClick={() => setShowApprovals(!showApprovals)}>
          {showApprovals ? <ChevronUp /> : <ChevronDown />}
        </Button>
      </div>
    </CardHeader>
    
    {showApprovals && (
      <CardContent>
        {pendingApprovals.map((item) => (
          <div key={item.id} className="flex items-start justify-between p-4 border rounded-lg">
            <div className="flex items-start gap-3">
              <div className="text-2xl">{item.type === 'RULE' ? '📏' : '🎁'}</div>
              <div>
                <div className="font-semibold">{item.name}</div>
                <div className="text-sm text-secondary">
                  Создал: {item.createdBy.firstName} {formatRelative(item.createdAt)}
                </div>
              </div>
            </div>
            
            <div className="flex gap-2">
              <Button variant="outline" size="sm" onClick={() => viewDetails(item)}>
                <Eye className="mr-2 h-4 w-4" />
                Детали
              </Button>
              <Button size="sm" onClick={() => approve(item)}>
                <Check className="mr-2 h-4 w-4" />
                Одобрить
              </Button>
              <Button variant="destructive" size="sm" onClick={() => reject(item)}>
                <X className="mr-2 h-4 w-4" />
                Отклонить
              </Button>
            </div>
          </div>
        ))}
      </CardContent>
    )}
  </Card>
)}
```

**Manager видит статус:**

- После создания → Toast "Отправлено на одобрение"
- Badge "Ожидает одобрения" на элементе
- Notification когда одобрено/отклонено (с причиной если отклонено)

***

### **Вопрос 12: Manager создал промо - может ли сам активировать?**

**Принятое решение:** Зависит от permission "AUTO_ACTIVATE_PROMO"

**Обоснование:**

- **Если permission есть:** Manager активирует сразу (полезно для срочных акций)
- **Если permission нет:** создаёт → PENDING_APPROVAL → Admin одобряет

**UI Create Promo Modal:**

```tsx
<DialogFooter>
  <Button variant="outline" onClick={() => setShowPromoForm(false)}>
    Отмена
  </Button>
  
  {hasPermission('AUTO_ACTIVATE_PROMO') ? (
    <>
      <Button onClick={() => savePromo({ activate: false })}>
        Сохранить как черновик
      </Button>
      <Button onClick={() => savePromo({ activate: true })}>
        Сохранить и активировать
      </Button>
    </>
  ) : (
    <Button onClick={() => savePromo({ activate: false })}>
      Отправить на одобрение
    </Button>
  )}
</DialogFooter>
```


***

## **📊 5. ANALYTICS PAGE**

### **Вопрос 13: Analytics - полный доступ как у Admin?**

**Принятое решение:** ДА, полный доступ ко всем 5 табам

**Обоснование:**

- Manager должен понимать бизнес для принятия решений
- Analytics не содержит критичной информации (billing, API keys)
- RFM, cohort analysis, loyalty ROI полезны для работы с гостями
- Transparency - единая картина с Admin'ом

**Tabs:**

1. **Overview** - KPIs + графики (полный доступ)
2. **Guests Analysis** - RFM, cohort, churn risk (полный доступ)
3. **Revenue Analysis** - выручка, средний чек (полный доступ)
4. **Loyalty ROI** - эффективность программы (полный доступ)
5. **Reports** - экспорт (если permission "EXPORT_DATA")

***

### **Вопрос 14: Export Reports - доступен Manager'у?**

**Принятое решение:** ДА, если есть permission "EXPORT_DATA"

**Обоснование:**

- Manager может нуждаться в экспорте для презентаций, анализа
- Экспорт не меняет данные (read operation)
- Admin контролирует через permission

**UI Reports Tab:**

```tsx
<TabsContent value="reports">
  {hasPermission('EXPORT_DATA') ? (
    <div className="grid grid-cols-2 gap-4">
      <ReportCard title="Guests Report" onClick={() => exportReport('guests')} />
      <ReportCard title="Transactions Report" onClick={() => exportReport('transactions')} />
      <ReportCard title="Revenue Report" onClick={() => exportReport('revenue')} />
      <ReportCard title="Loyalty ROI Report" onClick={() => exportReport('loyalty-roi')} />
      <ReportCard title="Birthday Report" onClick={() => exportReport('birthday')} />
      <ReportCard title="At-Risk Report" onClick={() => exportReport('at-risk')} />
    </div>
  ) : (
    <Alert>
      <Lock className="h-4 w-4" />
      <AlertDescription>
        Экспорт отчётов доступен только с разрешением Admin'а
      </AlertDescription>
    </Alert>
  )}
</TabsContent>
```


***

## **⚙️ 6. SETTINGS PAGE**

### **Вопрос 15: Settings - что Manager может настраивать?**

**Принятое решение:** 3 таба (Profile | Restaurant Info (read-only) | Notifications)

**Обоснование:**

**Profile Tab (полный доступ):**

- Фото, имя, email, телефон
- Смена пароля
- Язык интерфейса, timezone

**Restaurant Info Tab (read-only):**

- Название, логотип, адрес, часы работы
- Manager видит для справки, но НЕ редактирует

**Notifications Tab (полный доступ):**

- Каналы (Email, Telegram)
- Типы уведомлений
- Quiet hours

**НЕ показываются:**

- ❌ General Settings (API keys, webhooks)
- ❌ Loyalty Settings (ball conversion, redeem limit)
- ❌ POS Integration Settings (credentials)
- ❌ Team Management
- ❌ Security Settings (2FA, API tokens)

**UI Tabs:**

```tsx
<Tabs defaultValue="profile">
  <TabsList>
    <TabsTrigger value="profile">
      <User className="mr-2 h-4 w-4" />
      Профиль
    </TabsTrigger>
    <TabsTrigger value="restaurant">
      <Building className="mr-2 h-4 w-4" />
      Ресторан
      <Badge variant="outline" className="ml-2">Read-only</Badge>
    </TabsTrigger>
    <TabsTrigger value="notifications">
      <Bell className="mr-2 h-4 w-4" />
      Уведомления
    </TabsTrigger>
  </TabsList>
  
  <TabsContent value="profile">
    {/* Editable profile form */}
  </TabsContent>
  
  <TabsContent value="restaurant">
    <Alert className="mb-6">
      <Info className="h-4 w-4" />
      <AlertDescription>
        Информация доступна только для просмотра
      </AlertDescription>
    </Alert>
    {/* Read-only restaurant info */}
  </TabsContent>
  
  <TabsContent value="notifications">
    {/* Editable notifications */}
  </TabsContent>
</Tabs>
```


***

### **Вопрос 16: Manager Profile - что может редактировать?**

**Принятое решение:** Всё кроме Email (Email меняет Admin)

**Обоснование:**

**Может менять:**

- Фото/аватар
- Имя, Фамилия
- Телефон
- Пароль (с подтверждением старого)
- Язык интерфейса
- Timezone

**НЕ может менять:**

- Email (идентификатор для входа)
- Роль (Manager → Admin)
- Permissions (назначает Admin)

**UI Profile Form:**

```tsx
<form onSubmit={handleUpdateProfile}>
  {/* Avatar upload */}
  <div className="flex items-center gap-4">
    <Avatar className="h-20 w-20">
      {profile.avatar ? (
        <AvatarImage src={profile.avatar} />
      ) : (
        <AvatarFallback>{getInitials(profile.firstName, profile.lastName)}</AvatarFallback>
      )}
    </Avatar>
    <Button variant="outline" onClick={uploadAvatar}>
      <Upload className="mr-2 h-4 w-4" />
      Загрузить фото
    </Button>
  </div>
  
  {/* First Name, Last Name */}
  <div className="grid grid-cols-2 gap-4">
    <Input label="Имя" value={profile.firstName} onChange={...} required />
    <Input label="Фамилия" value={profile.lastName} onChange={...} required />
  </div>
  
  {/* Email (disabled) */}
  <Input
    label="Email"
    type="email"
    value={profile.email}
    disabled
    className="bg-muted"
  />
  <p className="text-xs text-secondary">
    Email используется для входа. Для изменения обратитесь к Admin'у.
  </p>
  
  {/* Phone, Language, Timezone */}
  <Input label="Телефон" value={profile.phone} onChange={...} />
  <Select label="Язык" value={profile.language} onValueChange={...} />
  <Select label="Timezone" value={profile.timezone} onValueChange={...} />
  
  <Button type="submit">Сохранить изменения</Button>
</form>

<Separator className="my-6" />

{/* Change Password */}
<form onSubmit={handleChangePassword}>
  <Input label="Текущий пароль" type="password" value={...} required />
  <Input label="Новый пароль" type="password" value={...} required minLength={8} />
  <Input label="Подтвердите пароль" type="password" value={...} required />
  <Button type="submit">Изменить пароль</Button>
</form>
```


***

## **🔔 7. NOTIFICATIONS**

### **Вопрос 17: Notifications - какие уведомления получает Manager?**

**Принятое решение:** Approval-related + POS_ERROR (если ответственен)

**Notification Types:**

1. **✅ APPROVAL_APPROVED** - Admin одобрил ваше правило/промо
2. **✕ APPROVAL_REJECTED** - Admin отклонил с причиной
3. **🔥 POS_ERROR** - Ошибка синхронизации (если Manager ответственен за мониторинг)

**НЕ показываются:**

- ❌ LIMIT_WARNING (тарифная проблема, решает Admin)
- ❌ NEW_GUEST, BIRTHDAY_TODAY, AT_RISK_GUEST (информационный шум)

**UI Bell Dropdown:**

```tsx
<Popover>
  <PopoverTrigger asChild>
    <Button variant="ghost" size="icon" className="relative">
      <Bell className="h-5 w-5" />
      {unreadCount > 0 && (
        <span className="absolute -top-1 -right-1 bg-danger text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
          {unreadCount}
        </span>
      )}
    </Button>
  </PopoverTrigger>
  
  <PopoverContent className="w-[400px] p-0" align="end">
    <div className="flex items-center justify-between p-4 border-b">
      <h3 className="font-semibold">Уведомления</h3>
      {unreadCount > 0 && (
        <Button variant="ghost" size="sm" onClick={markAllAsRead}>
          Отметить все
        </Button>
      )}
    </div>
    
    <ScrollArea className="h-[400px]">
      {notifications.map((notification) => (
        <div
          key={notification.id}
          className={cn(
            "p-4 hover:bg-card-hover transition cursor-pointer",
            !notification.readAt && "bg-primary/5"
          )}
          onClick={() => handleNotificationClick(notification)}
        >
          <div className="flex gap-3">
            <div className="flex-shrink-0">
              {notification.type === 'APPROVAL_APPROVED' && (
                <div className="h-10 w-10 rounded-full bg-success/10 flex items-center justify-center">
                  <Check className="h-5 w-5 text-success" />
                </div>
              )}
              {notification.type === 'APPROVAL_REJECTED' && (
                <div className="h-10 w-10 rounded-full bg-danger/10 flex items-center justify-center">
                  <X className="h-5 w-5 text-danger" />
                </div>
              )}
              {notification.type === 'POS_ERROR' && (
                <div className="h-10 w-10 rounded-full bg-warning/10 flex items-center justify-center">
                  <AlertTriangle className="h-5 w-5 text-warning" />
                </div>
              )}
            </div>
            
            <div className="flex-1">
              <p className="text-sm font-medium">{notification.title}</p>
              <p className="text-sm text-secondary">{notification.message}</p>
              <p className="text-xs text-secondary">{formatRelative(notification.createdAt)}</p>
            </div>
            
            {!notification.readAt && (
              <div className="w-2 h-2 bg-primary rounded-full" />
            )}
          </div>
        </div>
      ))}
    </ScrollArea>
  </PopoverContent>
</Popover>
```


***

## **📝 8. ACTIVITY LOG**

### **Вопрос 18: Activity Log - что Manager видит?**

**Принятое решение:** Все действия команды (read-only)

**Обоснование:**

- **Transparency** - Manager видит что делает вся команда
- **Accountability** - понятно кто за что отвечает
- **Audit trail** - можно проверить "кто изменил баланс гостя?"
- **Read-only** - Manager не может редактировать/удалять записи

**Фильтры:**

- Тип действия (Вход, Создание, Редактирование, Корректировка баллов, Удаление)
- Дата (range picker)
- Пользователь (Я, Admin, Другие Manager'ы, Все)
- Объект (Гость, Правило, Промо)

**UI Activity Log:**

```tsx
<Card>
  <CardHeader>
    <div className="flex items-center justify-between">
      <div>
        <CardTitle>Activity Log</CardTitle>
        <CardDescription>История действий команды</CardDescription>
      </div>
      {userRole === 'MANAGER' && (
        <Badge variant="outline">Read-only</Badge>
      )}
    </div>
  </CardHeader>
  
  <CardContent>
    {/* Filters */}
    <div className="flex gap-4 mb-4">
      <Select value={actionFilter} onValueChange={setActionFilter}>
        <SelectTrigger>
          <SelectValue placeholder="Тип действия" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="all">Все действия</SelectItem>
          <SelectItem value="LOGIN">Вход</SelectItem>
          <SelectItem value="CREATE">Создание</SelectItem>
          <SelectItem value="UPDATE">Редактирование</SelectItem>
          <SelectItem value="ADJUST_BALLS">Корректировка баллов</SelectItem>
        </SelectContent>
      </Select>
      
      <Select value={userFilter} onValueChange={setUserFilter}>
        <SelectTrigger>
          <SelectValue placeholder="Пользователь" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="all">Все</SelectItem>
          <SelectItem value="me">Только я</SelectItem>
          <SelectItem value="admin">Admin</SelectItem>
          <SelectItem value="managers">Другие Manager'ы</SelectItem>
        </SelectContent>
      </Select>
      
      <DateRangePicker value={dateRange} onChange={setDateRange} />
      <Input placeholder="Поиск..." value={searchQuery} onChange={...} />
    </div>
    
    {/* Table */}
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Время</TableHead>
          <TableHead>Пользователь</TableHead>
          <TableHead>Действие</TableHead>
          <TableHead>Объект</TableHead>
          <TableHead>IP адрес</TableHead>
          <TableHead>Статус</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {activityLogs.map((log) => (
          <TableRow key={log.id}>
            <TableCell>{formatDateTime(log.createdAt)}</TableCell>
            <TableCell>
              <div className="flex items-center gap-2">
                <Avatar className="h-6 w-6">
                  <AvatarFallback>{getInitials(log.user.firstName, log.user.lastName)}</AvatarFallback>
                </Avatar>
                <div>
                  <div className="text-sm">{log.user.firstName} {log.user.lastName}</div>
                  <Badge variant="outline" className="text-xs">{log.user.role}</Badge>
                </div>
              </div>
            </TableCell>
            <TableCell>
              {ACTION_ICONS[log.actionType]} {ACTION_NAMES[log.actionType]}
            </TableCell>
            <TableCell>{log.targetName}</TableCell>
            <TableCell className="font-mono text-xs">{log.ipAddress}</TableCell>
            <TableCell>
              <Badge variant={log.status === 'SUCCESS' ? 'success' : 'destructive'}>
                {log.status}
              </Badge>
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  </CardContent>
</Card>
```


***

## **🔗 9. POS INTEGRATION**

### **Вопрос 19: POS Integration - что Manager видит?**

**Принятое решение:** Статус + Recent Transactions (read-only) + Test Connection button

**Обоснование:**

- **Статус интеграции** - Manager видит Active/Error
- **Metrics** - Последняя синхронизация, Транзакций сегодня, Ошибок
- **Recent Transactions** - таблица последних операций (Manager проверяет что баллы начисляются)
- **Test Connection** - Manager может тестировать (без доступа к credentials)
- **НЕ показывается:** API credentials, Webhook URL, кнопки "Редактировать", "Отключить"

**UI POS Integration:**

```tsx
<Card>
  <CardHeader>
    <div className="flex items-center justify-between">
      <div className="flex items-center gap-4">
        <img src={integration.provider.logo} className="h-12" />
        <div>
          <CardTitle>{integration.provider.name}</CardTitle>
          <CardDescription>
            {integration.method === 'WEBHOOK' ? 'Webhook (Push)' : 'API Polling (Pull)'}
          </CardDescription>
        </div>
      </div>
      <Badge variant={integration.status === 'ACTIVE' ? 'success' : 'destructive'}>
        {integration.status === 'ACTIVE' ? '✓ Активна' : '✕ Ошибка'}
      </Badge>
    </div>
  </CardHeader>
  
  <CardContent>
    <div className="grid grid-cols-3 gap-4 mb-4">
      <div>
        <Label className="text-xs text-secondary">Последняя синхронизация</Label>
        <p className="font-medium">{formatRelative(integration.lastSync)}</p>
      </div>
      <div>
        <Label className="text-xs text-secondary">Транзакций сегодня</Label>
        <p className="font-medium">{integration.todayTransactions}</p>
      </div>
      <div>
        <Label className="text-xs text-secondary">Ошибок</Label>
        <p className="font-medium text-danger">{integration.errorsCount}</p>
      </div>
    </div>
    
    <div className="flex gap-2">
      <Button onClick={testConnection}>
        <Zap className="mr-2 h-4 w-4" />
        Тестировать
      </Button>
      <Button variant="outline" onClick={viewSyncLog}>
        <FileText className="mr-2 h-4 w-4" />
        Лог
      </Button>
      
      {/* Настройки только для Admin */}
      {userRole === 'ADMIN' && (
        <Button variant="outline" onClick={editIntegration}>
          <Settings className="mr-2 h-4 w-4" />
          Настройки
        </Button>
      )}
    </div>
    
    {userRole === 'MANAGER' && (
      <Alert className="mt-4">
        <Lock className="h-4 w-4" />
        <AlertDescription>
          Настройки интеграции доступны только Admin'у
        </AlertDescription>
      </Alert>
    )}
  </CardContent>
</Card>

{/* Recent Transactions Table */}
<Card>
  <CardHeader>
    <CardTitle>Последние транзакции из POS</CardTitle>
  </CardHeader>
  <CardContent>
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Дата</TableHead>
          <TableHead>Чек №</TableHead>
          <TableHead>Гость</TableHead>
          <TableHead>Сумма</TableHead>
          <TableHead>Начислено</TableHead>
          <TableHead>Списано</TableHead>
          <TableHead>Статус</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {posTransactions.map((tx) => (
          <TableRow key={tx.id}>
            <TableCell>{formatDateTime(tx.createdAt)}</TableCell>
            <TableCell className="font-mono">{tx.checkId}</TableCell>
            <TableCell>{tx.guestName || tx.guestPhone}</TableCell>
            <TableCell>{formatCurrency(tx.checkAmount)}</TableCell>
            <TableCell className="text-success">
              {tx.earnedPoints ? `+${tx.earnedPoints}` : '—'}
            </TableCell>
            <TableCell className="text-danger">
              {tx.redeemedPoints ? `−${tx.redeemedPoints}` : '—'}
            </TableCell>
            <TableCell>
              <Badge variant={tx.status === 'SUCCESS' ? 'success' : 'destructive'}>
                {tx.status}
              </Badge>
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  </CardContent>
</Card>
```


***

## **📱 10. MOBILE VIEW**

### **Вопрос 20: Mobile - те же адаптации что у Admin?**

**Принятое решение:** ДА, идентичная mobile адаптация

**Обоснование:**

- **Consistency** - одинаковый UX для всех ролей
- **Component reuse** - не нужно делать отдельные компоненты
- **Manager часто на выезде** - mobile критична

**Mobile Layout (< 768px):**

- Top Bar (fixed) - Logo, Notifications, Hamburger
- Content Area (scrollable)
- Bottom Navigation (fixed) - Dashboard, Guests, Loyalty, Analytics, Settings

**Отличие:** В Hamburger Menu нет пунктов Team и Billing

***

## **🎯 11. SPECIAL SCENARIOS**

### **Вопрос 21: Multi-Manager Coordination - как избежать конфликтов?**

**Принятое решение:** Real-time indicators + Optimistic locking с conflict warning

**Обоснование:**

**Real-time indicators (через WebSocket):**

```tsx
{currentlyEditing.length > 0 && (
  <Alert className="mb-4">
    <Users className="h-4 w-4" />
    <AlertDescription>
      <strong>{currentlyEditing.map(u => u.firstName).join(', ')}</strong> 
      сейчас просматривает этого гостя
    </AlertDescription>
  </Alert>
)}
```

**Optimistic locking:**

```tsx
try {
  await updateGuest({
    id: guest.id,
    data: updatedData,
    version: guest.version // Prisma optimistic locking
  });
  toast.success('Гость обновлён');
} catch (error) {
  if (error.code === 'CONFLICT') {
    setShowConflictModal(true);
  }
}
```

**Conflict Resolution Modal:**

- Показывает "Ваша версия" vs "Их версия (актуальная)"
- Кнопки: "Отменить мои изменения" | "Перезаписать их изменения"

***

### **Вопрос 22: Manager Request to Admin - как Manager запрашивает что-то у Admin'а?**

**Принятое решение:** In-app Request System

**Обоснование:**

- **Удобство** - не нужно выходить из системы
- **Audit trail** - все запросы логируются
- **Transparency** - Admin видит историю

**UI Request Permission (в Settings → Profile):**

```tsx
<Card>
  <CardHeader>
    <CardTitle>Мои права доступа</CardTitle>
  </CardHeader>
  <CardContent>
    {AVAILABLE_PERMISSIONS.map((permission) => (
      <div key={permission.id} className="flex items-center justify-between">
        <div>
          <div className="font-medium">{permission.name}</div>
          <div className="text-sm text-secondary">{permission.description}</div>
        </div>
        
        {userPermissions.includes(permission.id) ? (
          <Badge variant="success">
            <Check className="mr-1 h-3 w-3" />
            Есть
          </Badge>
        ) : (
          <Button variant="outline" size="sm" onClick={() => requestPermission(permission)}>
            Запросить
          </Button>
        )}
      </div>
    ))}
  </CardContent>
</Card>
```

**Request Modal:**

```tsx
<Dialog open={showRequestModal} onOpenChange={setShowRequestModal}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Запрос разрешения</DialogTitle>
      <DialogDescription>
        Ваш запрос будет отправлен Admin'у
      </DialogDescription>
    </DialogHeader>
    
    <div>
      <Label>Разрешение</Label>
      <div className="p-3 border rounded-lg">
        <div className="font-medium">{requestingPermission.name}</div>
        <div className="text-sm text-secondary">{requestingPermission.description}</div>
      </div>
    </div>
    
    <Textarea
      label="Причина запроса *"
      placeholder="Например: Мне нужно экспортировать базу для email-рассылки"
      value={requestReason}
      onChange={...}
      required
      minLength={20}
    />
    
    <DialogFooter>
      <Button variant="outline" onClick={() => setShowRequestModal(false)}>
        Отмена
      </Button>
      <Button onClick={submitRequest}>
        Отправить запрос
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

**Admin видит запросы:**

- В Notifications или отдельная секция Team → Requests
- Карточка запроса: Кто, Что, Причина, Дата
- Кнопки: Одобрить | Отклонить

***

### **Вопрос 23: Manager Training Mode - как обучить нового Manager'а?**

**Принятое решение:** Interactive Tour + Practice Mode (опционально)

**Обоснование:**

**Interactive Tour (react-joyride):**

```tsx
const tourSteps = [
  {
    target: '.dashboard-kpis',
    content: 'Здесь основные метрики ресторана',
    placement: 'bottom'
  },
  {
    target: '.quick-actions',
    content: 'Быстрые действия: добавить гостя, начислить баллы',
    placement: 'bottom'
  },
  {
    target: '.sidebar-guests',
    content: 'Управление гостями: список, фильтры, профили',
    placement: 'right'
  },
  {
    target: '.sidebar-loyalty',
    content: 'Loyalty Builder. Активация требует одобрения Admin\'а',
    placement: 'right'
  },
  {
    target: '.sidebar-analytics',
    content: 'Аналитика: RFM сегментация, выручка, Loyalty ROI',
    placement: 'right'
  }
];

<Joyride
  steps={tourSteps}
  run={showTour}
  continuous
  showProgress
  showSkipButton
/>
```

**Practice Mode (в Settings):**

```tsx
<Card>
  <CardHeader>
    <CardTitle>Режим тренировки</CardTitle>
    <CardDescription>
      Попрактикуйтесь с тестовыми данными
    </CardDescription>
  </CardHeader>
  <CardContent>
    <Alert className="mb-4">
      <Info className="h-4 w-4" />
      <AlertDescription>
        В режиме тренировки вы работаете с тестовыми гостями. Изменения не влияют на реальные данные.
      </AlertDescription>
    </Alert>
    
    <Button onClick={enablePracticeMode}>
      <Play className="mr-2 h-4 w-4" />
      Начать тренировку
    </Button>
  </CardContent>
</Card>
```


***

## **🔒 12. SECURITY \& AUDIT**

### **Вопрос 24: Audit Trail - логируются ли действия Manager'а?**

**Принятое решение:** ДА, полное логирование всех действий

**Обоснование:**

- **Accountability** - понятно кто за что отвечает
- **Security** - детектирование подозрительной активности
- **Compliance** - audit trail для проверок
- **Troubleshooting** - можно найти причину проблем

**Логируемые события:**

```typescript
enum ManagerActionType {
  // Guest Management
  CREATE_GUEST,
  UPDATE_GUEST,
  DEACTIVATE_GUEST,
  
  // Balls Adjustment
  ADJUST_BALLS_MANUAL,
  BALLS_TRANSFER,
  
  // Loyalty
  CREATE_RULE,
  UPDATE_RULE,
  CREATE_PROMO,
  ACTIVATE_PROMO,
  DEACTIVATE_PROMO,
  
  // Export
  EXPORT_GUESTS,
  EXPORT_REPORT,
  
  // Bulk Operations
  BULK_ADD_BALLS,
  BULK_SEND_NOTIFICATION,
  BULK_ADD_TAG,
  
  // Settings
  UPDATE_PROFILE,
  CHANGE_PASSWORD,
  
  // Requests
  REQUEST_PERMISSION
}
```

**Activity Log Entry:**

```typescript
{
  id: 'log_123',
  actionType: 'ADJUST_BALLS_MANUAL',
  performedBy: {
    id: 'manager_456',
    firstName: 'Мария',
    role: 'MANAGER'
  },
  targetUser: {
    id: 'guest_789',
    firstName: 'Иван'
  },
  metadata: {
    ballsAdded: 500,
    reason: 'Компенсация за ошибку',
    balanceBefore: 1200,
    balanceAfter: 1700
  },
  ipAddress: '192.168.1.100',
  userAgent: 'Mozilla/5.0...',
  createdAt: '2026-02-16T14:30:00Z'
}
```


***

### **Вопрос 25: Permission Changes - как Manager узнаёт что права изменились?**

**Принятое решение:** Real-time notification + Auto UI refresh

**Обоснование:**

- **Instant feedback** - Manager сразу видит изменения
- **No confusion** - не возникает "раньше кнопка была, теперь нет"
- **Transparency** - понятно что Admin изменил

**Implementation:**

**Backend (WebSocket event):**

```typescript
// Когда Admin меняет permissions
await this.eventBus.emit('permissions.updated', {
  userId: manager.id,
  updatedPermissions: newPermissions,
  changedBy: admin.id
});
```

**Frontend (Manager session):**

```typescript
socket.on('permissions.updated', (data) => {
  toast.info('Ваши права доступа были изменены', {
    description: 'Обновляем интерфейс...',
    duration: 3000
  });
  
  queryClient.invalidateQueries(['user-permissions']);
  
  setTimeout(() => {
    window.location.reload(); // Или soft reload
  }, 3000);
});
```

**Toast Notification:**

```tsx
<Toast>
  <div className="flex items-start gap-3">
    <div className="h-10 w-10 rounded-full bg-info/10 flex items-center justify-center">
      <Shield className="h-5 w-5 text-info" />
    </div>
    <div className="flex-1">
      <div className="font-semibold">Права доступа изменены</div>
      <div className="text-sm text-secondary">
        Admin обновил ваши разрешения. Интерфейс будет обновлён через 3 секунды.
      </div>
      <Button variant="link" size="sm" onClick={viewPermissions}>
        Посмотреть изменения
      </Button>
    </div>
  </div>
</Toast>
```


***

# ✅ **ИТОГО: 25 РЕШЕНИЙ MANAGER DASHBOARD ПРИНЯТЫ!**


***

## **📦 СТРУКТУРА MANAGER DASHBOARD**

**Роуты:**

```
/manager/dashboard          → Overview (KPIs, Charts, Quick Actions)
/manager/guests             → Guests Table + Filters + Search
/manager/guests/:id         → Guest Profile (6 tabs)
/manager/loyalty            → Loyalty Builder (4 tabs: Rules*, Levels read-only, Promos*, Design read-only)
/manager/analytics          → Analytics (5 tabs)
/manager/pos                → POS Integration (read-only + test connection)
/manager/settings           → Settings (3 tabs: Profile, Restaurant Info read-only, Notifications)
/manager/activity-log       → Activity Log (read-only)

* = с одобрением Admin
```

**Ключевые отличия от Admin:**

- ❌ Нет Team Management
- ❌ Нет Billing/Subscription
- ❌ Loyalty: Levels и Design read-only, Rules/Promos требуют одобрения
- ❌ POS Integration read-only (credentials не видит)
- ❌ Не может permanent delete гостей
- ✅ Permission-based restrictions на все действия
- ✅ Real-time indicators для coordination
- ✅ Request system для запроса permissions у Admin
- ✅ Полное логирование всех действий

**Технологии (те же что Admin):**

- Next.js 14 App Router + TypeScript
- shadcn/ui (темная тема)
- TanStack Query + TanStack Table
- Recharts
- date-fns
- QRCode.react
- React Hook Form + Zod
- WebSocket (для real-time indicators и permission updates)

***

# 🚀 **ГОТОВ К СЛЕДУЮЩЕМУ БЛОКУ!**

**Какой блок детализируем следующим?**

1. **Cashier POS Interface** - специализированный интерфейс для работы на кассе (быстрый поиск гостя, начисление/списание баллов по чеку, регистрация нового гостя, минимальный UI)
2. **Guest Telegram Mini App** - мобильное приложение для гостей (моя карточка, баланс, история транзакций, акции, QR-код для показа кассиру)
3. **API Documentation \& Webhooks** - REST API endpoints, authentication, rate limits, webhook events для POS интеграции
4. **Owner Analytics Deep Dive** - углублённая аналитика для Owner'а (multi-tenant analytics, cross-restaurant comparison, tenant health metrics)

**Что делаем дальше?** 🎯

---

# 💰 **CASHIER POS INTERFACE - 25 ВОПРОСОВ С РЕШЕНИЯМИ**


***

## **🎯 1. ROLE \& PURPOSE**

### **1️⃣ Cashier Interface - это отдельное приложение или часть Dashboard?**

**Контекст:**
Cashier работает на кассе ресторана. Ему нужен быстрый, простой интерфейс для работы с гостями: найти гостя по телефону/карте, показать баланс, начислить/списать баллы по чеку.[^14_1][^14_2]

**Вопрос:**
Как организовать Cashier интерфейс?

**A)** Отдельное приложение (отдельный роут `/cashier`, полностью изолированное от Dashboard)
**B)** Часть Dashboard с упрощённым UI (те же компоненты, но урезанные)
**C)** Standalone web app (отдельный домен `pos.maxloyalty.app`)
**D)** Desktop приложение (Electron) для установки на кассовый терминал

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: A) Отдельный роут `/cashier` + Fullscreen mode + Optimized для тач-экранов**

**Обоснование:**

- ✅ **Отдельный роут** - `/cashier` полностью изолирован от Admin/Manager Dashboard (нет sidebar, меню, лишних элементов)
- ✅ **Fullscreen mode** - Cashier работает на кассовом терминале в fullscreen (нет отвлекающих элементов браузера)
- ✅ **Touch-optimized** - большие кнопки, крупный шрифт, минимум текста (кассир работает на тач-экране)
- ✅ **Single-purpose** - одна задача = найти гостя, обработать чек (без аналитики, настроек, loyalty builder)
- ✅ **Fast** - мгновенная загрузка, минимальный JS bundle (критично для производительности на кассе)
- ✅ **Offline-ready** - может работать без интернета с sync later (для случаев когда WiFi нестабилен)

**Роуты Cashier:**

```
/cashier/login              → Вход (PIN-код или email/password)
/cashier                    → Главный экран (поиск гостя + quick actions)
/cashier/guest/:id          → Guest Quick View (баланс, начисление/списание)
/cashier/register-guest     → Регистрация нового гостя (быстрая форма)
/cashier/transaction/:id    → Подтверждение транзакции (receipt screen)
```

**НЕТ доступа к:**

- ❌ Dashboard/Analytics
- ❌ Loyalty Builder
- ❌ Settings (кроме смены своего PIN-кода)
- ❌ Team Management
- ❌ Полные профили гостей (только quick view)

***

### **2️⃣ Cashier Authentication - как Cashier логинится?**

**Контекст:**
Cashier работает на общем кассовом терминале (несколько кассиров меняются в течение дня). Нужна быстрая аутентификация.

**Вопрос:**
Какой метод входа для Cashier?

**A)** Email + Password (как у Admin/Manager)
**B)** PIN-код (4-6 цифр) для быстрого входа
**C)** QR-код (сканирование через мобильный)
**D)** Биометрия (отпечаток пальца)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) PIN-код (4 цифры) + Optional Email/Password**

**Обоснование:**

- ✅ **PIN-код (4 цифры)** - самый быстрый метод для смены кассиров (кассир вводит 1234 → вошёл за 2 секунды)
- ✅ **Numpad UI** - большие кнопки для тач-экрана (как банкомат)
- ✅ **Session timeout** - автоматический logout через 15 минут бездействия (безопасность)
- ✅ **Fallback Email/Password** - если кассир забыл PIN (ссылка "Войти через email")
- ✅ **Admin assigns PIN** - Admin создаёт Cashier аккаунт и назначает начальный PIN (кассир может сменить)

**UI Login Screen:**

```tsx
<div className="flex h-screen items-center justify-center bg-background">
  <Card className="w-[400px]">
    <CardHeader className="text-center">
      <img src="/logo.svg" alt="Max Loyalty" className="h-12 mx-auto mb-4" />
      <CardTitle className="text-2xl">Вход в кассу</CardTitle>
      <CardDescription>Введите ваш PIN-код</CardDescription>
    </CardHeader>
    
    <CardContent>
      {/* PIN Display */}
      <div className="flex justify-center gap-3 mb-6">
        {[0, 1, 2, 3].map((index) => (
          <div
            key={index}
            className={cn(
              "w-14 h-14 rounded-lg border-2 flex items-center justify-center text-2xl font-bold",
              pin.length > index ? "border-primary bg-primary/10" : "border-border"
            )}
          >
            {pin.length > index && '●'}
          </div>
        ))}
      </div>
      
      {/* Numpad */}
      <div className="grid grid-cols-3 gap-3">
        {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((num) => (
          <Button
            key={num}
            variant="outline"
            size="lg"
            className="h-16 text-2xl font-bold"
            onClick={() => handlePinInput(num)}
          >
            {num}
          </Button>
        ))}
        
        <Button
          variant="ghost"
          size="lg"
          className="h-16"
          onClick={clearPin}
        >
          <X className="h-6 w-6" />
        </Button>
        
        <Button
          variant="outline"
          size="lg"
          className="h-16 text-2xl font-bold"
          onClick={() => handlePinInput(0)}
        >
          0
        </Button>
        
        <Button
          variant="ghost"
          size="lg"
          className="h-16"
          onClick={backspace}
        >
          <Delete className="h-6 w-6" />
        </Button>
      </div>
      
      {error && (
        <Alert variant="destructive" className="mt-4">
          <AlertCircle className="h-4 w-4" />
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
      
      <Separator className="my-6" />
      
      <Button
        variant="link"
        className="w-full"
        onClick={() => setShowEmailLogin(true)}
      >
        Войти через email и пароль
      </Button>
    </CardContent>
  </Card>
</div>
```

**После входа:**

- Session создаётся с timeout 15 минут бездействия
- Cashier видит свою фотку и имя в header
- Кнопка "Выйти" (или автоматический logout)

***

### **3️⃣ Cashier Permissions - что Cashier может делать?**

**Контекст:**
Cashier - это самая ограниченная роль. Он работает только на кассе с гостями.

**Вопрос:**
Какие действия доступны Cashier'у?

**A)** Только просмотр баланса гостя (read-only)
**B)** Просмотр + начисление/списание баллов по чеку
**C)** Всё что может Manager (полный доступ к Guests)
**D)** Custom permissions (Admin настраивает для каждого Cashier'а)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Просмотр + начисление/списание по чеку + Регистрация гостей**

**Обоснование:**

**Cashier МОЖЕТ:**

- ✅ Искать гостя (по телефону, карте, имени)
- ✅ Просматривать баланс гостя (Regular + Promo balls)
- ✅ Просматривать уровень гостя (Bronze, Silver, Gold)
- ✅ Начислять баллы по чеку (автоматический расчёт: сумма чека × earn rate)
- ✅ Списывать баллы (с подтверждением: 500 баллов = 500₽ скидка)
- ✅ Регистрировать нового гостя (быстрая форма: имя, телефон, ДР)
- ✅ Просматривать краткую историю транзакций гостя (последние 5)
- ✅ Сменить свой PIN-код

**Cashier НЕ МОЖЕТ:**

- ❌ Редактировать профиль гостя (имя, email, дети) - только Manager/Admin
- ❌ Ручная корректировка баллов (arbitrary adjustment без чека) - только Manager/Admin
- ❌ Удалять/деактивировать гостей
- ❌ Экспортировать данные
- ❌ Видеть аналитику
- ❌ Создавать промо-акции
- ❌ Менять настройки loyalty
- ❌ Видеть Activity Log

**Таблица сравнения:**

```
Действие                    Admin  Manager  Cashier
────────────────────────────────────────────────────
Поиск гостя                 ✓      ✓        ✓
Просмотр баланса            ✓      ✓        ✓
Начисление по чеку          ✓      ✓        ✓
Списание по чеку            ✓      ✓        ✓
Регистрация гостя           ✓      ✓        ✓
Редактирование профиля      ✓      ✓        ✕
Ручная корректировка        ✓      ✓*       ✕
Просмотр полной истории     ✓      ✓        ✕
Analytics                   ✓      ✓        ✕
Loyalty Builder             ✓      ✓*       ✕
Export                      ✓      ✓*       ✕

* = с ограничениями / permission-based
```


***

## **🔍 2. MAIN SCREEN (SEARCH \& QUICK ACTIONS)**

### **4️⃣ Main Screen Layout - что показать Cashier'у по умолчанию?**

**Контекст:**
Cashier открывает `/cashier` после login. Это главный рабочий экран.

**Вопрос:**
Какой layout использовать?

**A)** Search bar по центру + список последних гостей
**B)** Split screen: поиск слева, инфо справа
**C)** Dashboard с KPI (как у Admin, но упрощённый)
**D)** Пустой экран с одним поиском (minimalist)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: A) Search bar по центру + Recent Guests + Quick Stats**

**Обоснование:**

- ✅ **Focus on search** - главная задача кассира = найти гостя → Search bar крупный, по центру, автофокус
- ✅ **Recent Guests** - список последних 10 гостей (кассир часто обслуживает одних и тех же постоянных клиентов)
- ✅ **Quick Stats** - 3 метрики вверху (Гостей сегодня | Транзакций | Баллов начислено) для контекста
- ✅ **Quick Actions** - 2 кнопки: "Зарегистрировать гостя" и "Помощь"

**UI Main Screen:**

```tsx
<div className="flex flex-col h-screen bg-background">
  {/* Header */}
  <header className="border-b px-6 py-4 flex items-center justify-between">
    <div className="flex items-center gap-3">
      <img src="/logo.svg" alt="Max Loyalty" className="h-8" />
      <div>
        <div className="text-sm text-secondary">Касса</div>
        <div className="font-semibold">{restaurant.name}</div>
      </div>
    </div>
    
    {/* Cashier Info */}
    <div className="flex items-center gap-4">
      {/* Quick Stats */}
      <div className="flex gap-6 text-sm">
        <div>
          <div className="text-secondary">Гостей сегодня</div>
          <div className="text-xl font-bold">{stats.guestsToday}</div>
        </div>
        <div>
          <div className="text-secondary">Транзакций</div>
          <div className="text-xl font-bold">{stats.transactionsToday}</div>
        </div>
        <div>
          <div className="text-secondary">Баллов начислено</div>
          <div className="text-xl font-bold">{stats.ballsEarnedToday}</div>
        </div>
      </div>
      
      <Separator orientation="vertical" className="h-12" />
      
      {/* Cashier Profile */}
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="ghost" className="gap-2">
            <Avatar>
              <AvatarImage src={cashier.avatar} />
              <AvatarFallback>{getInitials(cashier.firstName, cashier.lastName)}</AvatarFallback>
            </Avatar>
            <div className="text-left">
              <div className="text-sm font-medium">{cashier.firstName}</div>
              <Badge variant="outline" className="text-xs">Кассир</Badge>
            </div>
          </Button>
        </DropdownMenuTrigger>
        
        <DropdownMenuContent align="end">
          <DropdownMenuItem onClick={changePin}>
            <Key className="mr-2 h-4 w-4" />
            Сменить PIN-код
          </DropdownMenuItem>
          <DropdownMenuItem onClick={viewHelp}>
            <HelpCircle className="mr-2 h-4 w-4" />
            Помощь
          </DropdownMenuItem>
          <DropdownMenuSeparator />
          <DropdownMenuItem onClick={logout}>
            <LogOut className="mr-2 h-4 w-4" />
            Выйти
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>
    </div>
  </header>
  
  {/* Main Content */}
  <main className="flex-1 overflow-auto">
    <div className="max-w-4xl mx-auto px-6 py-12">
      {/* Search Section */}
      <div className="text-center mb-12">
        <h1 className="text-4xl font-bold mb-3">Найти гостя</h1>
        <p className="text-secondary text-lg">
          Введите телефон, номер карты или имя
        </p>
      </div>
      
      {/* Search Input */}
      <div className="relative mb-8">
        <Search className="absolute left-6 top-1/2 -translate-y-1/2 h-6 w-6 text-secondary" />
        <Input
          ref={searchInputRef}
          placeholder="Телефон, карта или имя..."
          className="h-20 pl-16 pr-6 text-2xl rounded-2xl border-2"
          value={searchQuery}
          onChange={handleSearch}
          onKeyDown={handleKeyDown}
        />
        
        {/* Search Results Dropdown */}
        {searchResults.length > 0 && (
          <Card className="absolute top-full mt-2 w-full max-h-[400px] overflow-auto z-50">
            <CardContent className="p-0">
              {searchResults.map((guest) => (
                <button
                  key={guest.id}
                  className="w-full p-4 flex items-center gap-4 hover:bg-card-hover transition border-b last:border-0"
                  onClick={() => selectGuest(guest)}
                >
                  <Avatar className="h-12 w-12">
                    <AvatarFallback className="text-lg">
                      {getInitials(guest.firstName, guest.lastName)}
                    </AvatarFallback>
                  </Avatar>
                  
                  <div className="flex-1 text-left">
                    <div className="font-semibold text-lg">
                      {guest.firstName} {guest.lastName}
                    </div>
                    <div className="text-secondary">{formatPhone(guest.phone)}</div>
                  </div>
                  
                  <div className="text-right">
                    <Badge>{LEVEL_ICONS[guest.level]} {guest.level}</Badge>
                    <div className="text-lg font-bold mt-1">
                      {guest.ballBalance} баллов
                    </div>
                  </div>
                  
                  <ChevronRight className="h-6 w-6 text-secondary" />
                </button>
              ))}
            </CardContent>
          </Card>
        )}
        
        {/* No Results */}
        {searchQuery.length >= 3 && searchResults.length === 0 && (
          <Card className="absolute top-full mt-2 w-full">
            <CardContent className="p-8 text-center">
              <UserX className="h-12 w-12 mx-auto mb-3 text-secondary" />
              <p className="text-lg font-semibold mb-2">Гость не найден</p>
              <p className="text-secondary mb-4">
                По запросу "{searchQuery}" не найдено гостей
              </p>
              <Button onClick={openRegisterGuest}>
                <UserPlus className="mr-2 h-5 w-5" />
                Зарегистрировать нового гостя
              </Button>
            </CardContent>
          </Card>
        )}
      </div>
      
      {/* Quick Actions */}
      <div className="flex gap-4 justify-center mb-12">
        <Button size="lg" onClick={openRegisterGuest}>
          <UserPlus className="mr-2 h-5 w-5" />
          Зарегистрировать гостя
        </Button>
        
        <Button variant="outline" size="lg" onClick={openHelp}>
          <HelpCircle className="mr-2 h-5 w-5" />
          Помощь
        </Button>
      </div>
      
      {/* Recent Guests */}
      {recentGuests.length > 0 && (
        <div>
          <h2 className="text-xl font-semibold mb-4">Последние гости</h2>
          <div className="grid grid-cols-2 gap-4">
            {recentGuests.map((guest) => (
              <Card
                key={guest.id}
                className="cursor-pointer hover:border-primary transition"
                onClick={() => selectGuest(guest)}
              >
                <CardContent className="p-4 flex items-center gap-3">
                  <Avatar className="h-10 w-10">
                    <AvatarFallback>
                      {getInitials(guest.firstName, guest.lastName)}
                    </AvatarFallback>
                  </Avatar>
                  
                  <div className="flex-1">
                    <div className="font-medium">
                      {guest.firstName} {guest.lastName}
                    </div>
                    <div className="text-sm text-secondary">
                      {formatPhone(guest.phone)}
                    </div>
                  </div>
                  
                  <div className="text-right">
                    <Badge variant="outline">{LEVEL_ICONS[guest.level]}</Badge>
                    <div className="text-sm font-semibold mt-1">
                      {guest.ballBalance} б.
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>
      )}
    </div>
  </main>
</div>
```


***

### **5️⃣ Guest Search - как искать быстро на кассе?**

**Контекст:**
Cashier вводит запрос в search bar. Нужна мгновенная реакция (гость стоит у кассы, ждёт).

**Вопрос:**
Какой тип поиска использовать?

**A)** Search as you type (каждая буква → запрос к API)
**B)** Debounced search (300ms задержка перед запросом)
**C)** Enter to search (ввёл запрос → нажал Enter)
**D)** Barcode scanner (сканирование QR-кода карты)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Debounced search (200ms) + D) Barcode scanner support**

**Обоснование:**

- ✅ **Debounced 200ms** - баланс между скоростью и нагрузкой на API (кассир печатает быстро, не нужен запрос на каждую букву)
- ✅ **Min 3 chars** - поиск начинается с 3 символов (избегаем слишком широких результатов)
- ✅ **Barcode scanner** - если введён QR-код карты (начинается с `MLTY-`) → direct lookup по cardCode
- ✅ **Phone normalization** - автоматическая нормализация телефона: `8 999 123-45-67` → `+79991234567`
- ✅ **Fuzzy search** - находит с опечатками (Иван → Ивн, Ivan)

**Search Logic:**

```typescript
const handleSearch = useDebouncedCallback(async (query: string) => {
  if (query.length < 3) {
    setSearchResults([]);
    return;
  }
  
  setIsSearching(true);
  
  try {
    // Check if QR code
    if (query.startsWith('MLTY-')) {
      const guest = await api.guests.findByCard(query);
      if (guest) {
        selectGuest(guest);
        return;
      }
    }
    
    // Normalize phone
    const normalizedPhone = normalizePhone(query);
    
    // Search
    const results = await api.guests.search({
      query: normalizedPhone || query,
      limit: 10
    });
    
    setSearchResults(results);
  } catch (error) {
    toast.error('Ошибка поиска');
  } finally {
    setIsSearching(false);
  }
}, 200);
```

**Barcode Scanner Integration:**

```typescript
useEffect(() => {
  // Listen for barcode scanner input
  let buffer = '';
  let timeout: NodeJS.Timeout;
  
  const handleKeyPress = (e: KeyboardEvent) => {
    // Barcode scanner types fast (< 50ms between chars)
    clearTimeout(timeout);
    
    if (e.key === 'Enter') {
      if (buffer.startsWith('MLTY-')) {
        handleBarcodeScanned(buffer);
      }
      buffer = '';
    } else {
      buffer += e.key;
      
      timeout = setTimeout(() => {
        buffer = ''; // Clear if typing is slow (human)
      }, 100);
    }
  };
  
  window.addEventListener('keypress', handleKeyPress);
  return () => window.removeEventListener('keypress', handleKeyPress);
}, []);

const handleBarcodeScanned = async (cardCode: string) => {
  const guest = await api.guests.findByCard(cardCode);
  if (guest) {
    selectGuest(guest);
  } else {
    toast.error('Карта не найдена');
  }
};
```


***

### **6️⃣ Search Results - как показать результаты?**

**Контекст:**
Cashier ввёл "Иван" → нашлось 5 гостей. Как их показать?

**Вопрос:**
Какой UI для результатов?

**A)** Dropdown список под search bar
**B)** Modal с полным списком
**C)** Grid cards на странице
**D)** Table с сортировкой

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: A) Dropdown список (как в примере выше)**

**Обоснование:**

- ✅ **Instant access** - результаты появляются сразу под search bar (не нужно скроллить)
- ✅ **Focus retention** - search bar остаётся в фокусе, можно уточнить запрос
- ✅ **One click** - клик на гостя → открывает Guest Quick View
- ✅ **Compact** - помещается 5-7 результатов на экран (если больше → scroll)
- ✅ **Visual** - показывает аватар, имя, телефон, уровень, баланс (вся нужная инфо)

**Search Result Item:**

```tsx
<button
  className="w-full p-4 flex items-center gap-4 hover:bg-card-hover transition border-b"
  onClick={() => selectGuest(guest)}
>
  <Avatar className="h-12 w-12">
    <AvatarFallback className="text-lg">
      {getInitials(guest.firstName, guest.lastName)}
    </AvatarFallback>
  </Avatar>
  
  <div className="flex-1 text-left">
    <div className="font-semibold text-lg">
      {guest.firstName} {guest.lastName}
    </div>
    <div className="text-secondary">
      {formatPhone(guest.phone)}
    </div>
    {guest.email && (
      <div className="text-xs text-secondary">{guest.email}</div>
    )}
  </div>
  
  <div className="text-right">
    <Badge className="mb-1">
      {LEVEL_ICONS[guest.level]} {guest.level}
    </Badge>
    <div className="text-lg font-bold">
      {guest.ballBalance} баллов
    </div>
    {guest.promoBallBalance > 0 && (
      <div className="text-sm text-secondary">
        + {guest.promoBallBalance} промо
      </div>
    )}
  </div>
  
  <ChevronRight className="h-6 w-6 text-secondary" />
</button>
```


***

## **👤 3. GUEST QUICK VIEW**

### **7️⃣ Guest Quick View - что показать Cashier'у о госте?**

**Контекст:**
Cashier нашёл гостя → клик → открывается Guest Quick View. Это экран для работы с чеком.

**Вопрос:**
Какую информацию показать?

**A)** Только баланс баллов (минимально)
**B)** Баланс + уровень + краткая история (5 транзакций)
**C)** Полный профиль (как у Manager) с табами
**D)** Split screen: инфо слева, форма начисления/списания справа

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: D) Split screen (инфо слева, actions справа) + Bottom action bar**

**Обоснование:**

- ✅ **Left Panel: Guest Info** - аватар, имя, телефон, уровень, баланс (Regular + Promo), последние 3 транзакции
- ✅ **Right Panel: Check Actions** - 2 большие кнопки: "Начислить баллы" и "Списать баллы"
- ✅ **Bottom Bar: Quick Actions** - "Назад к поиску", "Печать карточки", "Позвать Manager'а"
- ✅ **No tabs** - всё на одном экране (не нужно переключаться)
- ✅ **Large touch targets** - кнопки большие для тач-экрана

**UI Guest Quick View:**

```tsx
<div className="flex h-screen bg-background">
  {/* Left Panel: Guest Info */}
  <div className="w-1/2 border-r p-8 overflow-auto">
    <Button
      variant="ghost"
      className="mb-6"
      onClick={() => router.push('/cashier')}
    >
      <ArrowLeft className="mr-2 h-5 w-5" />
      Назад к поиску
    </Button>
    
    {/* Guest Header */}
    <div className="flex items-start gap-6 mb-8">
      <Avatar className="h-24 w-24">
        <AvatarImage src={guest.avatar} />
        <AvatarFallback className="text-3xl">
          {getInitials(guest.firstName, guest.lastName)}
        </AvatarFallback>
      </Avatar>
      
      <div className="flex-1">
        <h1 className="text-3xl font-bold mb-2">
          {guest.firstName} {guest.lastName}
        </h1>
        <div className="flex items-center gap-3 text-secondary mb-3">
          <Phone className="h-4 w-4" />
          <span className="text-lg">{formatPhone(guest.phone)}</span>
        </div>
        {guest.email && (
          <div className="flex items-center gap-3 text-secondary">
            <Mail className="h-4 w-4" />
            <span>{guest.email}</span>
          </div>
        )}
      </div>
    </div>
    
    {/* Loyalty Level */}
    <Card className="mb-6">
      <CardContent className="p-6">
        <div className="flex items-center justify-between mb-4">
          <div>
            <div className="text-sm text-secondary mb-1">Уровень лояльности</div>
            <div className="text-2xl font-bold flex items-center gap-2">
              <span className="text-3xl">{LEVEL_ICONS[guest.level]}</span>
              <span>{guest.level}</span>
            </div>
          </div>
          <Badge variant="outline" className="text-lg px-4 py-2">
            +{guest.earnBonus}% к начислению
          </Badge>
        </div>
        
        <div className="text-sm text-secondary">
          Потрачено за всё время: <span className="font-semibold text-foreground">
            {formatCurrency(guest.lifetimeSpent)}
          </span>
        </div>
      </CardContent>
    </Card>
    
    {/* Ball Balance */}
    <Card className="mb-6">
      <CardContent className="p-6">
        <div className="text-sm text-secondary mb-2">Баланс баллов</div>
        
        <div className="flex items-baseline gap-3 mb-4">
          <div className="text-5xl font-bold">
            {guest.ballBalance}
          </div>
          <div className="text-2xl text-secondary">баллов</div>
        </div>
        
        {guest.promoBallBalance > 0 && (
          <div className="flex items-center gap-2 text-warning">
            <Gift className="h-4 w-4" />
            <span className="text-sm">
              + {guest.promoBallBalance} промо-баллов
            </span>
          </div>
        )}
        
        <Separator className="my-4" />
        
        <div className="text-sm text-secondary">
          Можно списать до <span className="font-semibold text-foreground text-base">
            {formatCurrency(guest.ballBalance)}
          </span> скидки
        </div>
      </CardContent>
    </Card>
    
    {/* Recent Transactions */}
    <div>
      <h3 className="text-lg font-semibold mb-3">Последние операции</h3>
      
      {guest.recentTransactions.length === 0 ? (
        <Card>
          <CardContent className="p-8 text-center text-secondary">
            <History className="h-8 w-8 mx-auto mb-2 opacity-50" />
            <p>Пока нет транзакций</p>
          </CardContent>
        </Card>
      ) : (
        <div className="space-y-2">
          {guest.recentTransactions.slice(0, 3).map((tx) => (
            <Card key={tx.id}>
              <CardContent className="p-4 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  {tx.type === 'EARN' ? (
                    <div className="h-10 w-10 rounded-full bg-success/10 flex items-center justify-center">
                      <Plus className="h-5 w-5 text-success" />
                    </div>
                  ) : (
                    <div className="h-10 w-10 rounded-full bg-danger/10 flex items-center justify-center">
                      <Minus className="h-5 w-5 text-danger" />
                    </div>
                  )}
                  
                  <div>
                    <div className="font-medium">
                      {tx.type === 'EARN' ? 'Начисление' : 'Списание'}
                    </div>
                    <div className="text-sm text-secondary">
                      {formatRelative(tx.createdAt)}
                    </div>
                  </div>
                </div>
                
                <div className="text-right">
                  <div className={cn(
                    "text-xl font-bold",
                    tx.type === 'EARN' ? "text-success" : "text-danger"
                  )}>
                    {tx.type === 'EARN' ? '+' : '−'}{tx.amount}
                  </div>
                  {tx.checkAmount && (
                    <div className="text-sm text-secondary">
                      Чек: {formatCurrency(tx.checkAmount)}
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}
    </div>
  </div>
  
  {/* Right Panel: Actions */}
  <div className="w-1/2 p-8 flex flex-col">
    <div className="flex-1 flex flex-col items-center justify-center gap-6">
      <h2 className="text-3xl font-bold text-center mb-4">
        Обработка чека
      </h2>
      
      {/* Earn Balls Button */}
      <Button
        size="lg"
        className="w-full max-w-md h-32 text-2xl"
        onClick={() => setShowEarnModal(true)}
      >
        <Plus className="mr-3 h-8 w-8" />
        Начислить баллы
      </Button>
      
      {/* Redeem Balls Button */}
      <Button
        variant="outline"
        size="lg"
        className="w-full max-w-md h-32 text-2xl"
        onClick={() => setShowRedeemModal(true)}
        disabled={guest.ballBalance === 0}
      >
        <Minus className="mr-3 h-8 w-8" />
        Списать баллы
      </Button>
      
      {guest.ballBalance === 0 && (
        <p className="text-secondary text-center">
          У гостя нет баллов для списания
        </p>
      )}
    </div>
    
    {/* Bottom Quick Actions */}
    <div className="flex gap-3">
      <Button
        variant="outline"
        className="flex-1"
        onClick={printLoyaltyCard}
      >
        <Printer className="mr-2 h-5 w-5" />
        Печать карточки
      </Button>
      
      <Button
        variant="outline"
        className="flex-1"
        onClick={callManager}
      >
        <UserCog className="mr-2 h-5 w-5" />
        Позвать Manager'а
      </Button>
    </div>
  </div>
</div>
```


***

### **8️⃣ Earn Balls Modal - как начислить баллы по чеку?**

**Контекст:**
Cashier клик "Начислить баллы" → открывается Modal для ввода суммы чека.

**Вопрос:**
Какой UI использовать?

**A)** Простая форма (поле "Сумма чека" + кнопка "Начислить")
**B)** Calculator UI (кнопки 0-9 для ввода суммы как калькулятор)
**C)** QR-код (гость сканирует QR → автоматически начисляется)
**D)** POS интеграция (автоматически из чека)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Calculator UI + Real-time calculation preview**

**Обоснование:**

- ✅ **Calculator UI** - кассир быстро вводит сумму на тач-экране (как калькулятор или банкомат)
- ✅ **Real-time preview** - показывает сколько баллов начислится (сумма × earn rate × level bonus)
- ✅ **Large buttons** - кнопки 0-9 большие (80px) для тач-экрана
- ✅ **Clear validation** - минимальная сумма чека (например, 100₽)
- ✅ **Confirmation** - итоговый экран "Начислено X баллов"

**UI Earn Balls Modal:**

```tsx
<Dialog open={showEarnModal} onOpenChange={setShowEarnModal}>
  <DialogContent className="max-w-2xl">
    <DialogHeader>
      <DialogTitle className="text-2xl">Начисление баллов</DialogTitle>
      <DialogDescription>
        {guest.firstName} {guest.lastName} • {LEVEL_ICONS[guest.level]} {guest.level}
      </DialogDescription>
    </DialogHeader>
    
    <div className="space-y-6">
      {/* Check Amount Display */}
      <div className="bg-muted rounded-xl p-6 text-center">
        <div className="text-sm text-secondary mb-2">Сумма чека</div>
        <div className="text-5xl font-bold mb-4">
          {checkAmount === 0 ? '0' : formatCurrency(checkAmount)}
        </div>
        
        {checkAmount > 0 && (
          <div className="flex items-center justify-center gap-2 text-success">
            <ArrowRight className="h-5 w-5" />
            <span className="text-2xl font-bold">
              +{calculateEarnedBalls(checkAmount, guest)} баллов
            </span>
          </div>
        )}
      </div>
      
      {/* Calculator Numpad */}
      <div className="grid grid-cols-3 gap-3">
        {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((num) => (
          <Button
            key={num}
            variant="outline"
            size="lg"
            className="h-20 text-3xl font-bold"
            onClick={() => handleNumpadInput(num)}
          >
            {num}
          </Button>
        ))}
        
        <Button
          variant="outline"
          size="lg"
          className="h-20 text-2xl"
          onClick={handleClear}
        >
          C
        </Button>
        
        <Button
          variant="outline"
          size="lg"
          className="h-20 text-3xl font-bold"
          onClick={() => handleNumpadInput(0)}
        >
          0
        </Button>
        
        <Button
          variant="outline"
          size="lg"
          className="h-20"
          onClick={handleBackspace}
        >
          <Delete className="h-6 w-6" />
        </Button>
      </div>
      
      {/* Calculation Breakdown */}
      {checkAmount > 0 && (
        <Card>
          <CardContent className="p-4">
            <div className="text-sm space-y-2">
              <div className="flex justify-between">
                <span className="text-secondary">Сумма чека:</span>
                <span className="font-medium">{formatCurrency(checkAmount)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-secondary">Базовое начисление ({loyaltySettings.earnPercent}%):</span>
                <span className="font-medium">+{Math.floor(checkAmount * loyaltySettings.earnPercent / 100)} б.</span>
              </div>
              {guest.earnBonus > 0 && (
                <div className="flex justify-between">
                  <span className="text-secondary">Бонус уровня ({guest.earnBonus}%):</span>
                  <span className="font-medium text-success">
                    +{Math.floor(checkAmount * guest.earnBonus / 100)} б.
                  </span>
                </div>
              )}
              <Separator />
              <div className="flex justify-between text-lg font-bold">
                <span>Итого начислится:</span>
                <span className="text-success">
                  +{calculateEarnedBalls(checkAmount, guest)} баллов
                </span>
              </div>
            </div>
          </CardContent>
        </Card>
      )}
      
      {/* Validation Error */}
      {checkAmount > 0 && checkAmount < loyaltySettings.minCheckAmount && (
        <Alert variant="destructive">
          <AlertTriangle className="h-4 w-4" />
          <AlertDescription>
            Минимальная сумма чека для начисления: {formatCurrency(loyaltySettings.minCheckAmount)}
          </AlertDescription>
        </Alert>
      )}
    </div>
    
    <DialogFooter>
      <Button
        variant="outline"
        size="lg"
        onClick={() => setShowEarnModal(false)}
      >
        Отмена
      </Button>
      <Button
        size="lg"
        onClick={handleEarnConfirm}
        disabled={checkAmount < loyaltySettings.minCheckAmount}
      >
        <Check className="mr-2 h-5 w-5" />
        Начислить {calculateEarnedBalls(checkAmount, guest)} баллов
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

**Calculation Logic:**

```typescript
function calculateEarnedBalls(checkAmount: number, guest: Guest): number {
  // Base earn (e.g., 10% = 2000₽ → 200 balls)
  const baseEarn = Math.floor(checkAmount * (loyaltySettings.earnPercent / 100));
  
  // Level bonus (e.g., Gold +10% = 2000₽ → 20 balls)
  const levelBonus = Math.floor(checkAmount * (guest.earnBonus / 100));
  
  return baseEarn + levelBonus;
}
```


***

### **9️⃣ Redeem Balls Modal - как списать баллы?**

**Контекст:**
Cashier клик "Списать баллы" → открывается Modal для выбора количества баллов.

**Вопрос:**
Как задать количество баллов для списания?

**A)** Свободный ввод (кассир вводит любое число)
**B)** Slider (перетаскивание ползунка от 0 до max)
**C)** Preset buttons (100, 500, 1000, Всё) + Custom
**D)** Calculator UI (как в Earn Balls)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Preset buttons + D) Calculator UI + A) Custom input**

**Обоснование:**

- ✅ **Preset buttons** - быстрые суммы (100, 500, 1000, Весь баланс) для скорости
- ✅ **Calculator UI** - если нужна точная сумма (например, 437 баллов)
- ✅ **Max limit enforcement** - не может списать больше баланса или больше redeem limit % от чека
- ✅ **Real-time discount preview** - показывает сколько ₽ скидки получит гость

**UI Redeem Balls Modal:**

```tsx
<Dialog open={showRedeemModal} onOpenChange={setShowRedeemModal}>
  <DialogContent className="max-w-2xl">
    <DialogHeader>
      <DialogTitle className="text-2xl">Списание баллов</DialogTitle>
      <DialogDescription>
        {guest.firstName} {guest.lastName} • Баланс: {guest.ballBalance} баллов
      </DialogDescription>
    </DialogHeader>
    
    <div className="space-y-6">
      {/* Redemption Amount Display */}
      <div className="bg-muted rounded-xl p-6 text-center">
        <div className="text-sm text-secondary mb-2">Списать баллов</div>
        <div className="text-5xl font-bold mb-4 text-danger">
          {redeemAmount === 0 ? '0' : redeemAmount}
        </div>
        
        {redeemAmount > 0 && (
          <div className="flex items-center justify-center gap-2 text-success">
            <span className="text-2xl font-bold">
              = {formatCurrency(redeemAmount)} скидка
            </span>
          </div>
        )}
      </div>
      
      {/* Preset Buttons */}
      <div className="grid grid-cols-4 gap-3">
        {[100, 500, 1000].map((amount) => (
          <Button
            key={amount}
            variant="outline"
            size="lg"
            className="h-16 text-xl"
            onClick={() => setRedeemAmount(Math.min(amount, guest.ballBalance))}
            disabled={guest.ballBalance < amount}
          >
            {amount}
          </Button>
        ))}
        
        <Button
          variant="outline"
          size="lg"
          className="h-16 text-xl"
          onClick={() => setRedeemAmount(guest.ballBalance)}
        >
          Всё
        </Button>
      </div>
      
      {/* Calculator Numpad */}
      <div className="grid grid-cols-3 gap-3">
        {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((num) => (
          <Button
            key={num}
            variant="outline"
            size="lg"
            className="h-20 text-3xl font-bold"
            onClick={() => handleRedeemNumpadInput(num)}
          >
            {num}
          </Button>
        ))}
        
        <Button
          variant="outline"
          size="lg"
          className="h-20 text-2xl"
          onClick={() => setRedeemAmount(0)}
        >
          C
        </Button>
        
        <Button
          variant="outline"
          size="lg"
          className="h-20 text-3xl font-bold"
          onClick={() => handleRedeemNumpadInput(0)}
        >
          0
        </Button>
        
        <Button
          variant="outline"
          size="lg"
          className="h-20"
          onClick={handleRedeemBackspace}
        >
          <Delete className="h-6 w-6" />
        </Button>
      </div>
      
      {/* Calculation Info */}
      {redeemAmount > 0 && (
        <Card>
          <CardContent className="p-4">
            <div className="text-sm space-y-2">
              <div className="flex justify-between">
                <span className="text-secondary">Списать баллов:</span>
                <span className="font-medium text-danger">−{redeemAmount}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-secondary">Скидка:</span>
                <span className="font-medium text-success">{formatCurrency(redeemAmount)}</span>
              </div>
              <Separator />
              <div className="flex justify-between text-lg font-bold">
                <span>Останется баллов:</span>
                <span>{guest.ballBalance - redeemAmount}</span>
              </div>
            </div>
          </CardContent>
        </Card>
      )}
      
      {/* Validation Warnings */}
      {redeemAmount > guest.ballBalance && (
        <Alert variant="destructive">
          <AlertTriangle className="h-4 w-4" />
          <AlertDescription>
            У гостя только {guest.ballBalance} баллов
          </AlertDescription>
        </Alert>
      )}
      
      {/* Check Amount Input (для валидации redeem limit) */}
      <div>
        <Label className="text-base mb-2">Сумма чека (для проверки лимита списания)</Label>
        <Input
          type="number"
          placeholder="Введите сумму чека..."
          value={checkAmountForRedeem || ''}
          onChange={(e) => setCheckAmountForRedeem(Number(e.target.value))}
          className="h-14 text-xl"
        />
        {checkAmountForRedeem && (
          <p className="text-sm text-secondary mt-2">
            Можно списать до {Math.floor(checkAmountForRedeem * loyaltySettings.redeemLimit / 100)} баллов 
            ({loyaltySettings.redeemLimit}% от чека)
          </p>
        )}
      </div>
      
      {checkAmountForRedeem && redeemAmount > Math.floor(checkAmountForRedeem * loyaltySettings.redeemLimit / 100) && (
        <Alert variant="destructive">
          <AlertTriangle className="h-4 w-4" />
          <AlertDescription>
            Превышен лимит списания ({loyaltySettings.redeemLimit}% от чека). 
            Максимум: {Math.floor(checkAmountForRedeem * loyaltySettings.redeemLimit / 100)} баллов
          </AlertDescription>
        </Alert>
      )}
    </div>
    
    <DialogFooter>
      <Button
        variant="outline"
        size="lg"
        onClick={() => setShowRedeemModal(false)}
      >
        Отмена
      </Button>
      <Button
        variant="destructive"
        size="lg"
        onClick={handleRedeemConfirm}
        disabled={
          redeemAmount === 0 ||
          redeemAmount > guest.ballBalance ||
          (checkAmountForRedeem && redeemAmount > Math.floor(checkAmountForRedeem * loyaltySettings.redeemLimit / 100))
        }
      >
        <Check className="mr-2 h-5 w-5" />
        Списать {redeemAmount} баллов
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```


***

### **🔟 Transaction Confirmation - как показать успешную транзакцию?**

**Контекст:**
Cashier начислил/списал баллы → транзакция успешна → нужно показать подтверждение.

**Вопрос:**
Какой UI для подтверждения?

**A)** Toast notification (3 секунды → исчезает)
**B)** Success Modal с деталями транзакции
**C)** Receipt screen (как чек) с кнопкой "Печать"
**D)** Redirect обратно на Main Screen с toast

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Receipt screen + Auto-redirect через 5 секунд + Кнопка "Печать чека"**

**Обоснование:**

- ✅ **Receipt screen** - визуально похоже на чек (гость привык видеть чек)
- ✅ **All details** - показывает: что сделали, сколько баллов, баланс после операции, время, кассир
- ✅ **Print button** - кассир может распечатать чек с балансом для гостя
- ✅ **Auto-redirect** - через 5 секунд возвращается на Main Screen (для следующего гостя)
- ✅ **Manual control** - кнопка "Готово" для ручного возврата

**UI Transaction Receipt:**

```tsx
<div className="flex h-screen items-center justify-center bg-background">
  <Card className="w-[500px]">
    <CardContent className="p-8 text-center">
      {/* Success Icon */}
      <div className="h-24 w-24 rounded-full bg-success/10 flex items-center justify-center mx-auto mb-6">
        <CheckCircle2 className="h-12 w-12 text-success" />
      </div>
      
      {/* Title */}
      <h2 className="text-3xl font-bold mb-2">
        {transaction.type === 'EARN' ? 'Баллы начислены!' : 'Баллы списаны!'}
      </h2>
      
      <p className="text-secondary mb-8">
        {guest.firstName} {guest.lastName}
      </p>
      
      {/* Transaction Amount */}
      <div className="bg-muted rounded-xl p-6 mb-6">
        <div className="text-sm text-secondary mb-2">
          {transaction.type === 'EARN' ? 'Начислено' : 'Списано'}
        </div>
        <div className={cn(
          "text-6xl font-bold mb-4",
          transaction.type === 'EARN' ? "text-success" : "text-danger"
        )}>
          {transaction.type === 'EARN' ? '+' : '−'}{transaction.amount}
        </div>
        <div className="text-2xl text-secondary">баллов</div>
      </div>
      
      {/* Details */}
      <div className="space-y-3 mb-6 text-left">
        {transaction.checkAmount && (
          <div className="flex justify-between text-lg">
            <span className="text-secondary">Сумма чека:</span>
            <span className="font-semibold">{formatCurrency(transaction.checkAmount)}</span>
          </div>
        )}
        
        <Separator />
        
        <div className="flex justify-between text-lg">
          <span className="text-secondary">Баланс до:</span>
          <span className="font-semibold">{transaction.balanceBefore} б.</span>
        </div>
        
        <div className="flex justify-between text-xl font-bold">
          <span>Баланс после:</span>
          <span className="text-success">{transaction.balanceAfter} б.</span>
        </div>
        
        <Separator />
        
        <div className="text-sm text-secondary text-center">
          <div>{formatDateTime(transaction.createdAt)}</div>
          <div>Кассир: {cashier.firstName} {cashier.lastName}</div>
          <div className="font-mono">ID: {transaction.id}</div>
        </div>
      </div>
      
      {/* Actions */}
      <div className="flex gap-3">
        <Button
          variant="outline"
          size="lg"
          className="flex-1"
          onClick={printReceipt}
        >
          <Printer className="mr-2 h-5 w-5" />
          Печать чека
        </Button>
        
        <Button
          size="lg"
          className="flex-1"
          onClick={() => router.push('/cashier')}
        >
          Готово
        </Button>
      </div>
      
      {/* Auto-redirect countdown */}
      <p className="text-sm text-secondary mt-4">
        Автоматический возврат через {countdown} сек.
      </p>
    </CardContent>
  </Card>
</div>
```

**Auto-redirect Logic:**

```typescript
useEffect(() => {
  if (countdown === 0) {
    router.push('/cashier');
  }
  
  const timer = setTimeout(() => {
    setCountdown(countdown - 1);
  }, 1000);
  
  return () => clearTimeout(timer);
}, [countdown]);
```


***

## **➕ 4. REGISTER GUEST**

### **1️⃣1️⃣ Register Guest Form - какие поля минимально нужны?**

**Контекст:**
Cashier клик "Зарегистрировать гостя" → быстрая форма (гость стоит у кассы, нужно быстро).

**Вопрос:**
Какие поля запрашивать?

**A)** Только телефон (минимально)
**B)** Телефон + Имя
**C)** Телефон + Имя + День рождения
**D)** Полная форма (как у Manager: телефон, имя, email, ДР, дети)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) Телефон + Имя + День рождения (optional)**

**Обоснование:**

- ✅ **Телефон (required)** - уникальный идентификатор для поиска
- ✅ **Имя (required)** - персонализация (кассир обращается по имени)
- ✅ **День рождения (optional)** - для birthday promo, но не обязательно (можно добавить позже)
- ❌ **Email, Дети, Адрес** - НЕ запрашиваем на кассе (слишком долго, гость торопится)
- ✅ **Auto-generate card** - QR-код и 6-digit код генерируются автоматически

**UI Register Guest Modal:**

```tsx
<Dialog open={showRegisterModal} onOpenChange={setShowRegisterModal}>
  <DialogContent className="max-w-xl">
    <DialogHeader>
      <DialogTitle className="text-2xl">Регистрация гостя</DialogTitle>
      <DialogDescription>
        Заполните минимальную информацию для создания карты лояльности
      </DialogDescription>
    </DialogHeader>
    
    <form onSubmit={handleRegister} className="space-y-6">
      {/* Phone */}
      <div>
        <Label className="text-base">Телефон *</Label>
        <Input
          ref={phoneInputRef}
          type="tel"
          placeholder="+7 999 123-45-67"
          value={newGuest.phone}
          onChange={(e) => setNewGuest({ ...newGuest, phone: e.target.value })}
          className="h-14 text-xl"
          required
        />
        <p className="text-sm text-secondary mt-1">
          Используется для поиска и получения уведомлений
        </p>
      </div>
      
      {/* First Name */}
      <div>
        <Label className="text-base">Имя *</Label>
        <Input
          placeholder="Иван"
          value={newGuest.firstName}
          onChange={(e) => setNewGuest({ ...newGuest, firstName: e.target.value })}
          className="h-14 text-xl"
          required
        />
      </div>
      
      {/* Last Name */}
      <div>
        <Label className="text-base">Фамилия</Label>
        <Input
          placeholder="Иванов"
          value={newGuest.lastName}
          onChange={(e) => setNewGuest({ ...newGuest, lastName: e.target.value })}
          className="h-14 text-xl"
        />
        <p className="text-sm text-secondary mt-1">
          Не обязательно, но помогает отличить гостей с одинаковыми именами
        </p>
      </div>
      
      {/* Birthday */}
      <div>
        <Label className="text-base">День рождения</Label>
        <Input
          type="date"
          value={newGuest.birthday}
          onChange={(e) => setNewGuest({ ...newGuest, birthday: e.target.value })}
          className="h-14 text-xl"
        />
        <p className="text-sm text-secondary mt-1">
          Для начисления birthday bonus (можно добавить позже)
        </p>
      </div>
      
      <Alert>
        <Info className="h-4 w-4" />
        <AlertDescription>
          После регистрации гость получит карту лояльности с QR-кодом. 
          Дополнительную информацию можно добавить позже в профиле.
        </AlertDescription>
      </Alert>
    </form>
    
    <DialogFooter>
      <Button
        variant="outline"
        size="lg"
        onClick={() => setShowRegisterModal(false)}
      >
        Отмена
      </Button>
      <Button
        size="lg"
        onClick={handleRegister}
      >
        <UserPlus className="mr-2 h-5 w-5" />
        Зарегистрировать
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

**После регистрации:**

- Guest создаётся в БД
- Генерируется GuestCard (QR-код, 6-digit display code)
- Начальный уровень = Bronze (tier 1)
- Баланс = 0 баллов
- Welcome promo автоматически применяется (если настроено)
- Redirect на Guest Quick View → можно сразу обработать чек

***

### **1️⃣2️⃣ Duplicate Phone Detection - что если телефон уже есть?**

**Контекст:**
Cashier регистрирует гостя с телефоном `+79991234567` → но этот телефон уже в базе.

**Вопрос:**
Как обработать дубликат?

**A)** Показать ошибку "Телефон уже зарегистрирован"
**B)** Предложить открыть существующего гостя
**C)** Позволить создать дубликат (несколько гостей с одним телефоном)
**D)** Автоматически merge (объединить данные)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Показать Alert с предложением открыть существующего гостя**

**Обоснование:**

- ✅ **Prevent duplicates** - один телефон = один гость (уникальный идентификатор)
- ✅ **User-friendly** - кассир видит "Гость уже зарегистрирован" + карточка с инфо + кнопка "Открыть"
- ✅ **Fast recovery** - кассир не теряет время (клик → открывается Guest Quick View)

**UI Duplicate Detection:**

```tsx
// В handleRegister()
const existingGuest = await api.guests.findByPhone(newGuest.phone);

if (existingGuest) {
  setDuplicateGuest(existingGuest);
  return;
}

// Если дубликат найден
{duplicateGuest && (
  <Alert variant="warning" className="mb-4">
    <AlertTriangle className="h-4 w-4" />
    <AlertDescription>
      <div className="font-semibold mb-2">Гость уже зарегистрирован</div>
      
      <Card className="mt-3">
        <CardContent className="p-3 flex items-center gap-3">
          <Avatar>
            <AvatarFallback>
              {getInitials(duplicateGuest.firstName, duplicateGuest.lastName)}
            </AvatarFallback>
          </Avatar>
          
          <div className="flex-1">
            <div className="font-medium">
              {duplicateGuest.firstName} {duplicateGuest.lastName}
            </div>
            <div className="text-sm text-secondary">
              {formatPhone(duplicateGuest.phone)}
            </div>
          </div>
          
          <Badge>{LEVEL_ICONS[duplicateGuest.level]}</Badge>
        </CardContent>
      </Card>
      
      <div className="flex gap-2 mt-3">
        <Button
          variant="outline"
          size="sm"
          onClick={() => setDuplicateGuest(null)}
        >
          Отмена
        </Button>
        <Button
          size="sm"
          onClick={() => {
            setShowRegisterModal(false);
            router.push(`/cashier/guest/${duplicateGuest.id}`);
          }}
        >
          Открыть гостя
        </Button>
      </div>
    </AlertDescription>
  </Alert>
)}
```


***

## **🖨️ 5. PRINT \& RECEIPTS**

### **1️⃣3️⃣ Print Loyalty Card - как печатать карточку?**

**Контекст:**
Cashier регистрировал нового гостя или гость потерял карточку → нужно распечатать физическую карту.

**Вопрос:**
Как организовать печать?

**A)** Browser print dialog (window.print())
**B)** Thermal printer integration (ESC/POS commands)
**C)** PDF generation → скачать → печатать
**D)** Отправить на email гостю (digital card)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Thermal printer (ESC/POS) + A) Fallback browser print**

**Обоснование:**

- ✅ **Thermal printer** - на кассе обычно есть чековый принтер (80mm width)
- ✅ **ESC/POS commands** - стандартный протокол для термопринтеров
- ✅ **Instant print** - клик → печатает сразу (без диалогов)
- ✅ **Fallback** - если принтер не подключен → browser print dialog
- ✅ **Card layout** - QR-код + 6-digit код + имя гостя + баланс

**Print Layout (Thermal 80mm):**

```
┌────────────────────────────────┐
│      MAX LOYALTY               │
│      Ресторан "Макс"           │
├────────────────────────────────┤
│                                │
│   [QR-код 150x150px]           │
│                                │
│        000123                  │
│   (покажите кассиру)           │
│                                │
├────────────────────────────────┤
│  Иван Иванов                   │
│  🥇 Gold                       │
│                                │
│  Баланс: 2,850 баллов          │
│                                │
├────────────────────────────────┤
│  Телефон: +7 999 123-45-67     │
│  maxloyalty.app                │
└────────────────────────────────┘
```

**Print Function:**

```typescript
async function printLoyaltyCard(guest: Guest) {
  try {
    // Try thermal printer first
    if (thermalPrinter.isConnected()) {
      await printToThermalPrinter(guest);
    } else {
      // Fallback to browser print
      printToBrowser(guest);
    }
  } catch (error) {
    toast.error('Ошибка печати');
  }
}

async function printToThermalPrinter(guest: Guest) {
  const printer = new ThermalPrinter();
  
  // ESC/POS commands
  printer.alignCenter();
  printer.setTextSize(2, 2);
  printer.println(restaurant.name);
  printer.println('');
  
  // QR Code
  printer.printQRCode(guest.guestCard.qrCode, {
    size: 8,
    errorCorrection: 'M'
  });
  printer.println('');
  
  // Display Code
  printer.setTextSize(3, 3);
  printer.println(guest.guestCard.displayCode);
  printer.setTextSize(1, 1);
  printer.println('(покажите кассиру)');
  printer.println('');
  
  // Guest Info
  printer.alignLeft();
  printer.setTextSize(2, 2);
  printer.println(`${guest.firstName} ${guest.lastName}`);
  printer.setTextSize(1, 1);
  printer.println(`${LEVEL_ICONS[guest.level]} ${guest.level}`);
  printer.println('');
  printer.println(`Баланс: ${guest.ballBalance} баллов`);
  printer.println('');
  
  // Footer
  printer.alignCenter();
  printer.println(formatPhone(guest.phone));
  printer.println('maxloyalty.app');
  printer.println('');
  printer.println('');
  printer.cut();
  
  await printer.execute();
}

function printToBrowser(guest: Guest) {
  // Open print-friendly page
  const printWindow = window.open(`/cashier/print-card/${guest.id}`, '_blank');
  printWindow?.addEventListener('load', () => {
    printWindow.print();
  });
}
```

**Print-friendly Page (`/cashier/print-card/[id]`):**

```tsx
<div className="print-card">
  <style jsx>{`
    @media print {
      @page {
        size: 80mm auto;
        margin: 0;
      }
      body {
        margin: 0;
        padding: 10mm;
      }
    }
    .print-card {
      max-width: 80mm;
      text-align: center;
      font-family: monospace;
    }
  `}</style>
  
  <div className="text-center">
    <h1 className="text-2xl font-bold mb-2">{restaurant.name}</h1>
    <p className="text-sm mb-6">Карта лояльности</p>
    
    <QRCode
      value={guest.guestCard.qrCode}
      size={200}
      level="M"
      className="mx-auto mb-4"
    />
    
    <div className="text-4xl font-bold mb-2">
      {guest.guestCard.displayCode}
    </div>
    <p className="text-xs text-secondary mb-6">
      (покажите кассиру)
    </p>
    
    <div className="text-left border-t pt-4">
      <p className="font-semibold text-lg">
        {guest.firstName} {guest.lastName}
      </p>
      <p className="text-sm">
        {LEVEL_ICONS[guest.level]} {guest.level}
      </p>
      <p className="text-sm">
        Баланс: {guest.ballBalance} баллов
      </p>
    </div>
    
    <div className="border-t mt-4 pt-4 text-xs text-center">
      <p>{formatPhone(guest.phone)}</p>
      <p>maxloyalty.app</p>
    </div>
  </div>
</div>
```


***

### **1️⃣4️⃣ Print Transaction Receipt - печатать ли чек после транзакции?**

**Контекст:**
После начисления/списания баллов кассир может распечатать чек с балансом.

**Вопрос:**
Нужна ли печать чеков?

**A)** Да, автоматически после каждой транзакции
**B)** Да, но optional (кнопка "Печать")
**C)** Нет, только digital (показать на экране)
**D)** Да, но только по запросу гостя

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Optional печать (кнопка "Печать чека" на Receipt screen)**

**Обоснование:**

- ✅ **Optional** - не все гости хотят бумажный чек (экология, минимализм)
- ✅ **Fast** - кассир решает: нужен чек или нет (гость попросил = печатаем)
- ✅ **Thermal printer** - быстрая печать на чековом принтере
- ✅ **Compact** - чек небольшой (дата, сумма, баллы, баланс)

**Receipt Layout (Thermal 80mm):**

```
┌────────────────────────────────┐
│      MAX LOYALTY               │
│      Ресторан "Макс"           │
├────────────────────────────────┤
│  Чек №123456                   │
│  16.02.2026 14:35              │
│                                │
│  Гость: Иван Иванов            │
│  Карта: 000123                 │
│                                │
├────────────────────────────────┤
│  Сумма чека:    2,000 ₽        │
│  Начислено:       +200 б.      │
│                                │
│  Баланс до:     2,650 б.       │
│  Баланс после:  2,850 б.       │
├────────────────────────────────┤
│  Кассир: Анна П.               │
│                                │
│  Спасибо за покупку!           │
│  maxloyalty.app                │
└────────────────────────────────┘
```

**Print Function:**

```typescript
async function printTransactionReceipt(transaction: Transaction) {
  const printer = new ThermalPrinter();
  
  printer.alignCenter();
  printer.setTextSize(2, 2);
  printer.println(restaurant.name);
  printer.setTextSize(1, 1);
  printer.println('');
  
  printer.alignLeft();
  printer.println(`Чек №${transaction.id.slice(0, 8)}`);
  printer.println(formatDateTime(transaction.createdAt));
  printer.println('');
  printer.println(`Гость: ${guest.firstName} ${guest.lastName}`);
  printer.println(`Карта: ${guest.guestCard.displayCode}`);
  printer.println('');
  
  printer.drawLine();
  
  if (transaction.checkAmount) {
    printer.println(`Сумма чека:    ${formatCurrency(transaction.checkAmount)}`);
  }
  
  if (transaction.type === 'EARN') {
    printer.println(`Начислено:       +${transaction.amount} б.`);
  } else {
    printer.println(`Списано:         -${transaction.amount} б.`);
  }
  
  printer.println('');
  printer.println(`Баланс до:     ${transaction.balanceBefore} б.`);
  printer.println(`Баланс после:  ${transaction.balanceAfter} б.`);
  
  printer.drawLine();
  
  printer.println(`Кассир: ${cashier.firstName} ${cashier.lastName[^14_0]}.`);
  printer.println('');
  
  printer.alignCenter();
  printer.println('Спасибо за покупку!');
  printer.println('maxloyalty.app');
  printer.println('');
  printer.println('');
  printer.cut();
  
  await printer.execute();
}
```


***

## **⚙️ 6. SETTINGS \& HELP**

### **1️⃣5️⃣ Cashier Settings - что Cashier может настроить?**

**Контекст:**
Cashier клик на профиль → Dropdown с опциями.

**Вопрос:**
Какие настройки доступны Cashier'у?

**A)** Ничего (нет настроек вообще)
**B)** Только смена PIN-кода
**C)** PIN-код + язык интерфейса
**D)** PIN-код + язык + printer settings

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: D) PIN-код + Язык + Printer settings**

**Обоснование:**

- ✅ **Смена PIN-кода** - кассир может сменить свой PIN для безопасности
- ✅ **Язык интерфейса** - если в ресторане работают иностранные кассиры
- ✅ **Printer settings** - выбор принтера (если несколько), test print

**UI Cashier Settings (в Dropdown):**

```tsx
<DropdownMenu>
  <DropdownMenuContent align="end">
    <DropdownMenuItem onClick={openChangePinModal}>
      <Key className="mr-2 h-4 w-4" />
      Сменить PIN-код
    </DropdownMenuItem>
    
    <DropdownMenuItem onClick={openLanguageSettings}>
      <Languages className="mr-2 h-4 w-4" />
      Язык интерфейса
    </DropdownMenuItem>
    
    <DropdownMenuItem onClick={openPrinterSettings}>
      <Printer className="mr-2 h-4 w-4" />
      Настройки печати
    </DropdownMenuItem>
    
    <DropdownMenuSeparator />
    
    <DropdownMenuItem onClick={viewHelp}>
      <HelpCircle className="mr-2 h-4 w-4" />
      Помощь
    </DropdownMenuItem>
    
    <DropdownMenuSeparator />
    
    <DropdownMenuItem onClick={logout}>
      <LogOut className="mr-2 h-4 w-4" />
      Выйти
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

**Change PIN Modal:**

```tsx
<Dialog open={showChangePinModal} onOpenChange={setShowChangePinModal}>
  <DialogContent className="max-w-md">
    <DialogHeader>
      <DialogTitle>Смена PIN-кода</DialogTitle>
    </DialogHeader>
    
    <div className="space-y-6">
      {/* Current PIN */}
      <div>
        <Label>Текущий PIN-код</Label>
        <div className="flex justify-center gap-2 mt-2">
          {[0, 1, 2, 3].map((index) => (
            <div
              key={index}
              className="w-12 h-12 rounded border-2 flex items-center justify-center text-xl"
            >
              {currentPin.length > index && '●'}
            </div>
          ))}
        </div>
      </div>
      
      {/* New PIN */}
      <div>
        <Label>Новый PIN-код</Label>
        <div className="flex justify-center gap-2 mt-2">
          {[0, 1, 2, 3].map((index) => (
            <div
              key={index}
              className="w-12 h-12 rounded border-2 flex items-center justify-center text-xl"
            >
              {newPin.length > index && '●'}
            </div>
          ))}
        </div>
      </div>
      
      {/* Confirm New PIN */}
      <div>
        <Label>Подтвердите новый PIN-код</Label>
        <div className="flex justify-center gap-2 mt-2">
          {[0, 1, 2, 3].map((index) => (
            <div
              key={index}
              className="w-12 h-12 rounded border-2 flex items-center justify-center text-xl"
            >
              {confirmPin.length > index && '●'}
            </div>
          ))}
        </div>
      </div>
      
      {/* Numpad */}
      <div className="grid grid-cols-3 gap-2">
        {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((num) => (
          <Button
            key={num}
            variant="outline"
            className="h-14 text-xl"
            onClick={() => handlePinInput(num)}
          >
            {num}
          </Button>
        ))}
        
        <Button variant="ghost" className="h-14" onClick={clearPin}>
          <X className="h-5 w-5" />
        </Button>
        
        <Button
          variant="outline"
          className="h-14 text-xl"
          onClick={() => handlePinInput(0)}
        >
          0
        </Button>
        
        <Button variant="ghost" className="h-14" onClick={backspace}>
          <Delete className="h-5 w-5" />
        </Button>
      </div>
      
      {error && (
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
    </div>
    
    <DialogFooter>
      <Button variant="outline" onClick={() => setShowChangePinModal(false)}>
        Отмена
      </Button>
      <Button
        onClick={handleChangePinConfirm}
        disabled={!currentPin || !newPin || !confirmPin || newPin !== confirmPin}
      >
        Сохранить
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

**Printer Settings Modal:**

```tsx
<Dialog open={showPrinterSettings} onOpenChange={setShowPrinterSettings}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Настройки печати</DialogTitle>
    </DialogHeader>
    
    <div className="space-y-4">
      <div>
        <Label>Выбор принтера</Label>
        <Select value={selectedPrinter} onValueChange={setSelectedPrinter}>
          <SelectTrigger>
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            {availablePrinters.map((printer) => (
              <SelectItem key={printer.id} value={printer.id}>
                {printer.name}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
      
      <div>
        <Label>Тестовая печать</Label>
        <Button onClick={printTest} className="w-full mt-2">
          <Printer className="mr-2 h-4 w-4" />
          Напечатать тестовый чек
        </Button>
      </div>
      
      <Alert>
        <Info className="h-4 w-4" />
        <AlertDescription>
          Если принтер не работает, обратитесь к Admin'у или техподдержке
        </AlertDescription>
      </Alert>
    </div>
  </DialogContent>
</Dialog>
```


***

### **1️⃣6️⃣ Help Screen - как помочь Cashier'у если что-то непонятно?**

**Контекст:**
Cashier клик "Помощь" → нужно показать инструкции.

**Вопрос:**
Какой формат помощи?

**A)** FAQ текстом (вопрос-ответ)
**B)** Video tutorials (встроенные видео)
**C)** Interactive walkthrough (step-by-step guide)
**D)** Link to documentation

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: A) FAQ + C) Quick Guide + D) Contact support**

**Обоснование:**

- ✅ **FAQ** - быстрые ответы на частые вопросы (Как найти гостя? Как начислить баллы? Что делать если не печатает?)
- ✅ **Quick Guide** - пошаговые инструкции с скриншотами
- ✅ **Contact Support** - кнопка "Позвать Manager'а" или "Техподдержка"

**UI Help Modal:**

```tsx
<Dialog open={showHelp} onOpenChange={setShowHelp}>
  <DialogContent className="max-w-3xl max-h-[80vh] overflow-auto">
    <DialogHeader>
      <DialogTitle className="text-2xl">Помощь</DialogTitle>
    </DialogHeader>
    
    <Tabs defaultValue="faq">
      <TabsList className="grid w-full grid-cols-2">
        <TabsTrigger value="faq">Частые вопросы</TabsTrigger>
        <TabsTrigger value="guide">Инструкции</TabsTrigger>
      </TabsList>
      
      <TabsContent value="faq" className="space-y-4">
        <Accordion type="single" collapsible>
          <AccordionItem value="search">
            <AccordionTrigger>Как найти гостя?</AccordionTrigger>
            <AccordionContent>
              <p className="mb-2">
                Введите в поиск:
              </p>
              <ul className="list-disc pl-6 space-y-1">
                <li>Номер телефона (можно с +7 или без)</li>
                <li>Имя гостя (Иван, Петров)</li>
                <li>Номер карты (000123)</li>
                <li>Отсканируйте QR-код карты</li>
              </ul>
            </AccordionContent>
          </AccordionItem>
          
          <AccordionItem value="earn">
            <AccordionTrigger>Как начислить баллы?</AccordionTrigger>
            <AccordionContent>
              <ol className="list-decimal pl-6 space-y-1">
                <li>Найдите гостя в поиске</li>
                <li>Нажмите "Начислить баллы"</li>
                <li>Введите сумму чека</li>
                <li>Нажмите "Начислить"</li>
              </ol>
              <p className="mt-2 text-sm text-secondary">
                Баллы рассчитываются автоматически исходя из суммы чека и уровня гостя
              </p>
            </AccordionContent>
          </AccordionItem>
          
          <AccordionItem value="redeem">
            <AccordionTrigger>Как списать баллы?</AccordionTrigger>
            <AccordionContent>
              <ol className="list-decimal pl-6 space-y-1">
                <li>Найдите гостя в поиске</li>
                <li>Нажмите "Списать баллы"</li>
                <li>Введите количество баллов или выберите preset</li>
                <li>Введите сумму чека (для проверки лимита)</li>
                <li>Нажмите "Списать"</li>
              </ol>
              <Alert className="mt-3">
                <Info className="h-4 w-4" />
                <AlertDescription>
                  1 балл = 1₽ скидки. Максимум можно списать {loyaltySettings.redeemLimit}% от суммы чека.
                </AlertDescription>
              </Alert>
            </AccordionContent>
          </AccordionItem>
          
          <AccordionItem value="register">
            <AccordionTrigger>Как зарегистрировать гостя?</AccordionTrigger>
            <AccordionContent>
              <ol className="list-decimal pl-6 space-y-1">
                <li>Нажмите "Зарегистрировать гостя"</li>
                <li>Введите телефон гостя</li>
                <li>Введите имя</li>
                <li>Опционально: день рождения</li>
                <li>Нажмите "Зарегистрировать"</li>
              </ol>
              <p className="mt-2 text-sm text-secondary">
                После регистрации можно распечатать карточку лояльности
              </p>
            </AccordionContent>
          </AccordionItem>
          
          <AccordionItem value="print">
            <AccordionTrigger>Что делать если не печатает?</AccordionTrigger>
            <AccordionContent>
              <ol className="list-decimal pl-6 space-y-1">
                <li>Проверьте что принтер включён</li>
                <li>Проверьте бумагу в принтере</li>
                <li>Попробуйте тестовую печать (Настройки → Печать → Тест)</li>
                <li>Если не помогло, позовите Manager'а</li>
              </ol>
            </AccordionContent>
          </AccordionItem>
        </Accordion>
      </TabsContent>
      
      <TabsContent value="guide" className="space-y-6">
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">Быстрый старт</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="flex items-start gap-3">
              <div className="h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                <span className="font-bold">1</span>
              </div>
              <div>
                <h4 className="font-semibold mb-1">Войдите в систему</h4>
                <p className="text-sm text-secondary">
                  Введите свой 4-значный PIN-код
                </p>
              </div>
            </div>
            
            <div className="flex items-start gap-3">
              <div className="h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                <span className="font-bold">2</span>
              </div>
              <div>
                <h4 className="font-semibold mb-1">Найдите гостя</h4>
                <p className="text-sm text-secondary">
                  Введите телефон, имя или отсканируйте карту
                </p>
              </div>
            </div>
            
            <div className="flex items-start gap-3">
              <div className="h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                <span className="font-bold">3</span>
              </div>
              <div>
                <h4 className="font-semibold mb-1">Обработайте чек</h4>
                <p className="text-sm text-secondary">
                  Начислите или спишите баллы
                </p>
              </div>
            </div>
            
            <div className="flex items-start gap-3">
              <div className="h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                <span className="font-bold">4</span>
              </div>
              <div>
                <h4 className="font-semibold mb-1">Готово!</h4>
                <p className="text-sm text-secondary">
                  Гость получил баллы или скидку
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      </TabsContent>
    </Tabs>
    
    <div className="flex gap-3 pt-4 border-t">
      <Button
        variant="outline"
        className="flex-1"
        onClick={callManager}
      >
        <UserCog className="mr-2 h-4 w-4" />
        Позвать Manager'а
      </Button>
      
      <Button
        variant="outline"
        className="flex-1"
        onClick={() => window.open('https://support.maxloyalty.app', '_blank')}
      >
        <ExternalLink className="mr-2 h-4 w-4" />
        Техподдержка
      </Button>
    </div>
  </DialogContent>
</Dialog>
```


***

## **🔄 7. OFFLINE MODE \& SYNC**

### **1️⃣7️⃣ Offline Support - что если нет интернета на кассе?**

**Контекст:**
WiFi на кассе нестабилен → кассир не может найти гостя / начислить баллы.

**Вопрос:**
Поддерживать ли offline mode?

**A)** Нет, только online (без интернета не работает)
**B)** Да, с local storage (кеширование последних гостей)
**C)** Да, с IndexedDB + sync queue
**D)** Да, с Service Worker + full offline mode

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: C) IndexedDB + Sync Queue (limited offline mode)**

**Обоснование:**

- ✅ **IndexedDB** - кешируем последних 100 гостей (most frequent)
- ✅ **Sync Queue** - транзакции сохраняются локально → синхронизируются когда интернет вернётся
- ✅ **Read-only offline** - можно искать cached гостей, видеть баланс (но данные могут быть устаревшие)
- ✅ **Write with queue** - можно начислять/списывать баллы → транзакция в очередь → sync later
- ⚠️ **Conflicts possible** - если гость использовал баллы в другом месте while offline

**Offline Indicator:**

```tsx
{isOffline && (
  <Alert variant="warning" className="mb-4">
    <WifiOff className="h-4 w-4" />
    <AlertDescription>
      <strong>Режим офлайн.</strong> Данные могут быть устаревшими. 
      Транзакции будут синхронизированы когда интернет вернётся.
    </AlertDescription>
  </Alert>
)}
```

**Sync Queue:**

```typescript
interface QueuedTransaction {
  id: string;
  guestId: string;
  type: 'EARN' | 'REDEEM';
  amount: number;
  checkAmount?: number;
  createdAt: string;
  status: 'PENDING' | 'SYNCED' | 'FAILED';
}

// Save to IndexedDB when offline
async function processTransactionOffline(transaction: QueuedTransaction) {
  // Add to sync queue
  await db.syncQueue.add(transaction);
  
  // Update local guest balance
  await db.guests.update(transaction.guestId, {
    ballBalance: guest.ballBalance + (transaction.type === 'EARN' ? transaction.amount : -transaction.amount)
  });
  
  toast.warning('Транзакция сохранена. Будет синхронизирована когда появится интернет.');
}

// Sync when online
async function syncQueue() {
  const pendingTransactions = await db.syncQueue.where('status').equals('PENDING').toArray();
  
  for (const tx of pendingTransactions) {
    try {
      await api.transactions.create(tx);
      await db.syncQueue.update(tx.id, { status: 'SYNCED' });
    } catch (error) {
      await db.syncQueue.update(tx.id, { status: 'FAILED' });
      console.error('Sync failed:', tx.id, error);
    }
  }
  
  if (pendingTransactions.length > 0) {
    toast.success(`Синхронизировано ${pendingTransactions.length} транзакций`);
  }
}

// Listen for online/offline events
useEffect(() => {
  const handleOnline = () => {
    setIsOffline(false);
    syncQueue();
  };
  
  const handleOffline = () => {
    setIsOffline(true);
  };
  
  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);
  
  return () => {
    window.removeEventListener('online', handleOnline);
    window.removeEventListener('offline', handleOffline);
  };
}, []);
```


***

### **1️⃣8️⃣ Auto-logout on Inactivity - как защитить от несанкционированного доступа?**

**Контекст:**
Cashier ушёл на обед, забыл выйти → другой человек может зайти на кассу.

**Вопрос:**
Нужен ли auto-logout?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: ДА, auto-logout через 15 минут бездействия**

**Обоснование:**

- ✅ **Security** - предотвращает доступ посторонних
- ✅ **15 минут** - баланс между удобством и безопасностью (кассир может отойти на несколько минут)
- ✅ **Warning before logout** - за 1 минуту до logout показывается предупреждение "Вы будете выведены через 60 секунд"
- ✅ **Continue button** - кассир может продлить сессию кликом

**Inactivity Timer:**

```typescript
const INACTIVITY_TIMEOUT = 15 * 60 * 1000; // 15 minutes
const WARNING_BEFORE_LOGOUT = 60 * 1000; // 1 minute

useEffect(() => {
  let inactivityTimer: NodeJS.Timeout;
  let warningTimer: NodeJS.Timeout;
  
  const resetTimer = () => {
    clearTimeout(inactivityTimer);
    clearTimeout(warningTimer);
    setShowInactivityWarning(false);
    
    // Show warning 1 minute before logout
    warningTimer = setTimeout(() => {
      setShowInactivityWarning(true);
      setCountdown(60);
    }, INACTIVITY_TIMEOUT - WARNING_BEFORE_LOGOUT);
    
    // Auto-logout after timeout
    inactivityTimer = setTimeout(() => {
      handleLogout();
    }, INACTIVITY_TIMEOUT);
  };
  
  // Listen for user activity
  const events = ['mousedown', 'keydown', 'touchstart', 'scroll'];
  events.forEach((event) => {
    window.addEventListener(event, resetTimer);
  });
  
  resetTimer(); // Start timer
  
  return () => {
    clearTimeout(inactivityTimer);
    clearTimeout(warningTimer);
    events.forEach((event) => {
      window.removeEventListener(event, resetTimer);
    });
  };
}, []);

// Countdown for warning
useEffect(() => {
  if (showInactivityWarning && countdown > 0) {
    const timer = setTimeout(() => {
      setCountdown(countdown - 1);
    }, 1000);
    
    return () => clearTimeout(timer);
  }
}, [showInactivityWarning, countdown]);
```

**Inactivity Warning Modal:**

```tsx
<Dialog open={showInactivityWarning} onOpenChange={() => {}}>
  <DialogContent className="max-w-md">
    <DialogHeader>
      <DialogTitle>Вы ещё здесь?</DialogTitle>
      <DialogDescription>
        Вы будете автоматически выведены из системы через {countdown} секунд
      </DialogDescription>
    </DialogHeader>
    
    <div className="text-center py-6">
      <div className="text-6xl font-bold mb-4">{countdown}</div>
      <p className="text-secondary">
        Нажмите "Продолжить" чтобы остаться
      </p>
    </div>
    
    <DialogFooter>
      <Button
        variant="outline"
        onClick={handleLogout}
      >
        Выйти сейчас
      </Button>
      <Button
        onClick={() => {
          setShowInactivityWarning(false);
          resetTimer();
        }}
      >
        Продолжить работу
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```


***

## **📊 8. CASHIER ANALYTICS (LIMITED)**

### **1️⃣9️⃣ Cashier Stats - видит ли Cashier свою статистику?**

**Контекст:**
Cashier хочет знать: сколько он обработал чеков сегодня, сколько баллов начислил.

**Вопрос:**
Показывать ли статистику Cashier'у?

**A)** Нет (только Admin/Manager видят статистику)
**B)** Да, но только свою (сколько я обработал)
**C)** Да, свою + общую по всем кассирам
**D)** Да, полная аналитика (как у Manager)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Только своя статистика (в header Quick Stats)**

**Обоснование:**

- ✅ **Motivation** - кассир видит свой прогресс за день (геймификация)
- ✅ **Minimal** - только 3 метрики (не отвлекает от основной работы)
- ✅ **No comparison** - не показываем статистику других кассиров (избегаем соревнования)

**Quick Stats (в header):**

```tsx
<div className="flex gap-6 text-sm">
  <div>
    <div className="text-secondary">Гостей сегодня</div>
    <div className="text-xl font-bold">{cashierStats.guestsToday}</div>
  </div>
  <div>
    <div className="text-secondary">Транзакций</div>
    <div className="text-xl font-bold">{cashierStats.transactionsToday}</div>
  </div>
  <div>
    <div className="text-secondary">Баллов начислено</div>
    <div className="text-xl font-bold">{cashierStats.ballsEarnedToday}</div>
  </div>
</div>
```

**Stats reset:** Сбрасываются каждый день в 00:00 (показывают только сегодняшние данные)

***

### **2️⃣0️⃣ Recent Guests Widget - как помочь Cashier'у работать быстрее?**

**Контекст:**
Постоянные клиенты приходят каждый день → кассир их часто ищет.

**Вопрос:**
Показывать ли Recent Guests?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: ДА, Recent Guests на Main Screen (последние 10)**

**Обоснование:**

- ✅ **Speed** - клик на карточку → сразу открывается Guest Quick View (без поиска)
- ✅ **Personalization** - показывает последних гостей обработанных этим кассиром (не всех)
- ✅ **Storage** - хранится в localStorage (персистентно между сессиями)

**Recent Guests (на Main Screen):**

```tsx
{recentGuests.length > 0 && (
  <div>
    <h2 className="text-xl font-semibold mb-4">Последние гости</h2>
    <div className="grid grid-cols-2 gap-4">
      {recentGuests.map((guest) => (
        <Card
          key={guest.id}
          className="cursor-pointer hover:border-primary transition"
          onClick={() => selectGuest(guest)}
        >
          <CardContent className="p-4 flex items-center gap-3">
            <Avatar className="h-10 w-10">
              <AvatarFallback>
                {getInitials(guest.firstName, guest.lastName)}
              </AvatarFallback>
            </Avatar>
            
            <div className="flex-1">
              <div className="font-medium">
                {guest.firstName} {guest.lastName}
              </div>
              <div className="text-sm text-secondary">
                {formatPhone(guest.phone)}
              </div>
            </div>
            
            <div className="text-right">
              <Badge variant="outline">{LEVEL_ICONS[guest.level]}</Badge>
              <div className="text-sm font-semibold mt-1">
                {guest.ballBalance} б.
              </div>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  </div>
)}
```

**Store Recent Guests:**

```typescript
function addToRecentGuests(guest: Guest) {
  const recent = JSON.parse(localStorage.getItem('cashier_recent_guests') || '[]');
  
  // Remove if already exists (move to top)
  const filtered = recent.filter((g: Guest) => g.id !== guest.id);
  
  // Add to beginning
  filtered.unshift(guest);
  
  // Keep only last 10
  const trimmed = filtered.slice(0, 10);
  
  localStorage.setItem('cashier_recent_guests', JSON.stringify(trimmed));
  setRecentGuests(trimmed);
}
```


***

## **⚡ 9. PERFORMANCE \& OPTIMIZATION**

### **2️⃣1️⃣ Keyboard Shortcuts - нужны ли хоткеи для кассира?**

**Контекст:**
Опытный кассир работает быстро → хочет использовать клавиатуру вместо мыши.

**Вопрос:**
Добавить ли keyboard shortcuts?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: ДА, базовые shortcuts для основных действий**

**Обоснование:**

- ✅ **Speed** - опытный кассир работает на 30% быстрее с хоткеями
- ✅ **Minimal learning curve** - только самые очевидные сочетания
- ✅ **Optional** - мышь продолжает работать (хоткеи = дополнение)

**Keyboard Shortcuts:**

```
F1  - Помощь
F2  - Поиск гостя (focus на search input)
F3  - Регистрация нового гостя
F5  - Обновить данные (refresh)

ESC - Закрыть modal / Вернуться назад

Цифры 0-9 - Ввод в numpad (когда modal открыт)
Enter       - Подтвердить действие
```

**Implementation:**

```typescript
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    // F1 - Help
    if (e.key === 'F1') {
      e.preventDefault();
      setShowHelp(true);
    }
    
    // F2 - Focus search
    if (e.key === 'F2') {
      e.preventDefault();
      searchInputRef.current?.focus();
    }
    
    // F3 - Register guest
    if (e.key === 'F3') {
      e.preventDefault();
      setShowRegisterModal(true);
    }
    
    // ESC - Close modals / Go back
    if (e.key === 'Escape') {
      if (showEarnModal) setShowEarnModal(false);
      else if (showRedeemModal) setShowRedeemModal(false);
      else if (showRegisterModal) setShowRegisterModal(false);
      else if (showHelp) setShowHelp(false);
      else router.push('/cashier'); // Go to main screen
    }
  };
  
  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [showEarnModal, showRedeemModal, showRegisterModal, showHelp]);
```

**Shortcuts Help (в Help Modal):**

```tsx
<Card>
  <CardHeader>
    <CardTitle>Горячие клавиши</CardTitle>
  </CardHeader>
  <CardContent>
    <dl className="space-y-2 text-sm">
      <div className="flex justify-between">
        <dt className="text-secondary">F1</dt>
        <dd className="font-medium">Помощь</dd>
      </div>
      <div className="flex justify-between">
        <dt className="text-secondary">F2</dt>
        <dd className="font-medium">Поиск гостя</dd>
      </div>
      <div className="flex justify-between">
        <dt className="text-secondary">F3</dt>
        <dd className="font-medium">Регистрация гостя</dd>
      </div>
      <div className="flex justify-between">
        <dt className="text-secondary">ESC</dt>
        <dd className="font-medium">Назад / Закрыть</dd>
      </div>
    </dl>
  </CardContent>
</Card>
```


***

### **2️⃣2️⃣ Bundle Size Optimization - как минимизировать загрузку?**

**Контекст:**
Cashier интерфейс должен загружаться мгновенно (даже на медленном WiFi).

**Вопрос:**
Как оптимизировать производительность?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: Code splitting + Minimal dependencies + Preload critical assets**

**Обоснование:**

- ✅ **Code splitting** - отдельный chunk для `/cashier` роутов (не загружаем Admin/Manager код)
- ✅ **Tree shaking** - только используемые компоненты из shadcn/ui
- ✅ **No heavy libs** - избегаем Recharts (не нужна аналитика кассиру)
- ✅ **Critical CSS inline** - первый render без FOUC
- ✅ **Service Worker** - кеширование assets для повторных загрузок

**Webpack/Next.js config:**

```javascript
// next.config.js
module.exports = {
  webpack: (config) => {
    config.optimization.splitChunks = {
      chunks: 'all',
      cacheGroups: {
        cashier: {
          test: /[\\/]app[\\/]cashier[\\/]/,
          name: 'cashier',
          priority: 10
        }
      }
    };
    return config;
  }
};
```

**Bundle size target:**

- Initial load: < 100KB gzipped
- Total: < 300KB gzipped

***

## **🔒 10. SECURITY \& AUDIT**

### **2️⃣3️⃣ Cashier Activity Log - логируются ли все действия?**

**Контекст:**
Cashier начисляет баллы, списывает баллы, регистрирует гостей.

**Вопрос:**
Нужно ли логировать действия Cashier'а?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: ДА, полное логирование всех транзакций**

**Обоснование:**

- ✅ **Accountability** - Admin/Manager видят кто что делал
- ✅ **Fraud detection** - детектирование аномалий (кассир начислил себе 10,000 баллов)
- ✅ **Dispute resolution** - если гость жалуется "мне не начислили" → проверяем лог
- ✅ **Performance tracking** - сколько гостей обработал каждый кассир

**Logged Events:**

```typescript
enum CashierActionType {
  // Authentication
  LOGIN = 'login',
  LOGOUT = 'logout',
  CHANGE_PIN = 'change_pin',
  
  // Guest Operations
  SEARCH_GUEST = 'search_guest',
  VIEW_GUEST = 'view_guest',
  REGISTER_GUEST = 'register_guest',
  
  // Transactions
  EARN_BALLS = 'earn_balls',
  REDEEM_BALLS = 'redeem_balls',
  
  // Print
  PRINT_CARD = 'print_card',
  PRINT_RECEIPT = 'print_receipt',
  
  // Other
  CALL_MANAGER = 'call_manager',
  VIEW_HELP = 'view_help'
}
```

**Activity Log Entry:**

```typescript
{
  id: 'log_abc123',
  actionType: 'EARN_BALLS',
  performedBy: {
    id: 'cashier_xyz',
    firstName: 'Анна',
    lastName: 'Петрова',
    role: 'CASHIER'
  },
  targetGuest: {
    id: 'guest_123',
    firstName: 'Иван',
    phone: '+79991234567'
  },
  metadata: {
    checkAmount: 2000,
    ballsEarned: 220,
    balanceBefore: 500,
    balanceAfter: 720
  },
  ipAddress: '192.168.1.50',
  terminal: 'POS-1',
  createdAt: '2026-02-16T14:30:00Z'
}
```

**Admin/Manager видят в Activity Log:**

- Кто (кассир)
- Что (действие)
- Когда (timestamp)
- С кем (гость)
- Где (терминал)
- Детали (суммы, баланс)

***

### **2️⃣4️⃣ Fraud Prevention - как предотвратить мошенничество?**

**Контекст:**
Кассир может начислить баллы себе или знакомым без реального чека.

**Вопрос:**
Как детектировать fraud?

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: Anomaly detection + Manual check amounts limits**

**Обоснование:**

**Anomaly Detection (backend):**

- ⚠️ **Unusually high check** - если кассир начислил баллы по чеку >50,000₽ → alert Manager'у
- ⚠️ **Self-transaction** - если кассир начислил баллы на свой собственный аккаунт → alert
- ⚠️ **Frequent same guest** - если кассир обрабатывает одного гостя >10 раз в день → suspicious
- ⚠️ **After hours** - если транзакция в 3:00 ночи (когда ресторан закрыт) → alert

**Check Amount Limits:**

- Max check amount без подтверждения Manager'а: 20,000₽
- Если больше → требуется PIN-код Manager'а

**UI Manager Confirmation:**

```tsx
{checkAmount > MAX_CHECK_WITHOUT_APPROVAL && (
  <Alert variant="warning">
    <ShieldAlert className="h-4 w-4" />
    <AlertDescription>
      <div className="font-semibold mb-2">
        Требуется подтверждение Manager'а
      </div>
      <p className="mb-3">
        Сумма чека ({formatCurrency(checkAmount)}) превышает лимит. 
        Попросите Manager'а ввести PIN-код.
      </p>
      
      <div>
        <Label>PIN-код Manager'а</Label>
        <Input
          type="password"
          maxLength={4}
          placeholder="••••"
          value={managerPin}
          onChange={(e) => setManagerPin(e.target.value)}
          className="max-w-[150px] mt-2"
        />
      </div>
    </AlertDescription>
  </Alert>
)}
```

**Backend Validation:**

```typescript
// При создании транзакции
if (checkAmount > MAX_CHECK_WITHOUT_APPROVAL) {
  // Verify manager PIN
  const managerValid = await verifyManagerPin(restaurantId, managerPin);
  
  if (!managerValid) {
    throw new Error('Неверный PIN-код Manager\'а');
  }
  
  // Log manager approval
  await createActivityLog({
    actionType: 'MANAGER_APPROVAL',
    performedBy: cashierId,
    approvedBy: managerId,
    metadata: {
      reason: 'High check amount',
      checkAmount
    }
  });
}
```


***

### **2️⃣5️⃣ Terminal Assignment - как привязать кассира к терминалу?**

**Контекст:**
В ресторане несколько касс (POS-1, POS-2, POS-3). Нужно знать с какого терминала работал кассир.

**Вопрос:**
Как идентифицировать терминал?

**A)** По IP-адресу
**B)** Manual selection при login (кассир выбирает "Касса 1")
**C)** Device fingerprint (browser + hardware ID)
**D)** QR-код на терминале (сканирование

<div align="center">⁂</div>

[^14_1]: Beseda-3.md

[^14_2]: Beseda-2.md


---

# 💰 **CASHIER POS INTERFACE - ПРОДОЛЖЕНИЕ**


***

### **2️⃣5️⃣ Terminal Assignment - как привязать кассира к терминалу?**

**Контекст:**
В ресторане несколько касс (POS-1, POS-2, POS-3). Нужно знать с какого терминала работал кассир.

**Вопрос:**
Как идентифицировать терминал?

**A)** По IP-адресу
**B)** Manual selection при login (кассир выбирает "Касса 1")
**C)** Device fingerprint (browser + hardware ID)
**D)** QR-код на терминале (сканирование при входе)

**🎯 МОЁ ПРЕДЛОЖЕНИЕ: B) Manual selection при login + C) Device fingerprint для auto-detection**

**Обоснование:**

- ✅ **Manual selection** - при первом входе кассир выбирает терминал из dropdown
- ✅ **Device fingerprint** - браузер запоминает терминал (при следующем входе автоматически определяет)
- ✅ **Override option** - кассир может сменить терминал если работает с другой кассы
- ✅ **Admin visibility** - в Activity Log показывается с какого терминала была транзакция

**UI Terminal Selection (при login):**

```tsx
<Dialog open={showTerminalSelection} onOpenChange={setShowTerminalSelection}>
  <DialogContent className="max-w-md">
    <DialogHeader>
      <DialogTitle>Выберите терминал</DialogTitle>
      <DialogDescription>
        С какой кассы вы работаете?
      </DialogDescription>
    </DialogHeader>
    
    <div className="space-y-3">
      {terminals.map((terminal) => (
        <Card
          key={terminal.id}
          className={cn(
            "cursor-pointer transition hover:border-primary",
            selectedTerminal?.id === terminal.id && "border-primary bg-primary/5"
          )}
          onClick={() => setSelectedTerminal(terminal)}
        >
          <CardContent className="p-4 flex items-center gap-3">
            <div className="h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center">
              <Monitor className="h-6 w-6" />
            </div>
            
            <div className="flex-1">
              <div className="font-semibold text-lg">{terminal.name}</div>
              <div className="text-sm text-secondary">{terminal.location}</div>
            </div>
            
            {selectedTerminal?.id === terminal.id && (
              <CheckCircle2 className="h-6 w-6 text-primary" />
            )}
          </CardContent>
        </Card>
      ))}
    </div>
    
    <DialogFooter>
      <Button
        onClick={handleTerminalConfirm}
        disabled={!selectedTerminal}
        className="w-full"
      >
        Продолжить
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

**Device Fingerprint (для auto-detection):**

```typescript
import FingerprintJS from '@fingerprintjs/fingerprintjs';

async function getDeviceFingerprint(): Promise<string> {
  const fp = await FingerprintJS.load();
  const result = await fp.get();
  return result.visitorId;
}

// При login
async function handleLogin(pin: string) {
  const fingerprint = await getDeviceFingerprint();
  
  // Check if this device has assigned terminal
  const savedTerminal = localStorage.getItem(`terminal_${fingerprint}`);
  
  if (savedTerminal) {
    // Auto-select saved terminal
    setSelectedTerminal(JSON.parse(savedTerminal));
    proceedToLogin(pin);
  } else {
    // Show terminal selection
    setShowTerminalSelection(true);
  }
}

// Save terminal assignment
function handleTerminalConfirm() {
  const fingerprint = await getDeviceFingerprint();
  localStorage.setItem(`terminal_${fingerprint}`, JSON.stringify(selectedTerminal));
  proceedToLogin();
}
```

**Terminal Info в Header:**

```tsx
<div className="flex items-center gap-2 text-sm">
  <Monitor className="h-4 w-4 text-secondary" />
  <span className="text-secondary">Терминал:</span>
  <Badge variant="outline">{currentTerminal.name}</Badge>
  
  <Button
    variant="ghost"
    size="sm"
    onClick={() => setShowTerminalSelection(true)}
  >
    <RefreshCw className="h-3 w-3" />
  </Button>
</div>
```

**Activity Log с Terminal ID:**

```typescript
{
  id: 'log_abc123',
  actionType: 'EARN_BALLS',
  performedBy: {
    id: 'cashier_xyz',
    firstName: 'Анна',
    role: 'CASHIER'
  },
  terminal: {
    id: 'terminal_001',
    name: 'POS-1',
    location: 'Главный зал'
  },
  // ... rest of log
}
```


***

# ✅ **ИТОГО: 25 РЕШЕНИЙ CASHIER POS INTERFACE ПРИНЯТЫ!**


***

## **📦 СТРУКТУРА CASHIER INTERFACE**

### **Роуты:**

```
/cashier/login                → PIN-код вход (numpad UI)
/cashier                      → Main Screen (search + recent guests + quick stats)
/cashier/guest/:id            → Guest Quick View (split screen: info + actions)
/cashier/register-guest       → Register Guest Modal
/cashier/transaction/:id      → Transaction Receipt (success screen)
/cashier/print-card/:id       → Print-friendly card layout
/cashier/help                 → Help & FAQ
```


### **Ключевые компоненты:**

**1. Login Screen:**

- PIN-код numpad (4 цифры)
- Fallback email/password
- Terminal selection
- Auto-logout через 15 мин

**2. Main Screen:**

- Large search bar (автофокус)
- Search as you type (debounced 200ms)
- Barcode scanner support
- Recent guests (last 10)
- Quick stats (Гостей | Транзакций | Баллов)
- Quick actions (Регистрация | Помощь)

**3. Guest Quick View:**

- Split screen layout
- Left: Guest info (аватар, имя, уровень, баланс, последние 3 транзакции)
- Right: Actions (Начислить баллы | Списать баллы)
- Bottom: Quick actions (Печать карточки | Позвать Manager'а)

**4. Earn Balls Modal:**

- Calculator UI (numpad 0-9)
- Real-time calculation preview
- Breakdown (base + level bonus)
- Validation (min check amount)
- Confirmation

**5. Redeem Balls Modal:**

- Preset buttons (100 | 500 | 1000 | Всё)
- Calculator UI (numpad 0-9)
- Check amount input (для redeem limit)
- Real-time discount preview
- Validation (max balance, max % от чека)

**6. Register Guest Form:**

- Minimal fields (Телефон* | Имя* | Фамилия | ДР)
- Duplicate detection
- Auto-generate card
- Fast modal (не отвлекает от работы)

**7. Transaction Receipt:**

- Success screen с деталями
- Large amount display
- Balance before/after
- Print button
- Auto-redirect через 5 сек

**8. Print:**

- Thermal printer (ESC/POS)
- Loyalty card layout (QR + display code)
- Transaction receipt
- Fallback browser print

**9. Offline Mode:**

- IndexedDB cache (last 100 guests)
- Sync queue (pending transactions)
- Offline indicator
- Auto-sync when online

**10. Security:**

- Auto-logout (15 min inactivity)
- Activity logging (все действия)
- Fraud detection (anomalies)
- Manager approval (high amounts)

***

## **🎯 CASHIER PERMISSIONS (RECAP)**

### **✅ МОЖЕТ:**

- Искать гостя (телефон | имя | карта | QR-код)
- Просматривать баланс гостя
- Начислять баллы по чеку
- Списывать баллы по чеку
- Регистрировать нового гостя (базовая инфо)
- Печатать карточку лояльности
- Печатать чек транзакции
- Видеть свою статистику (гостей сегодня, транзакций, баллов)
- Видеть последних гостей (recent)
- Сменить свой PIN-код
- Выбрать терминал


### **❌ НЕ МОЖЕТ:**

- Редактировать профиль гостя (только Manager/Admin)
- Ручная корректировка баллов (arbitrary adjustment)
- Удалять гостей
- Видеть полную историю транзакций гостя (только last 3)
- Видеть аналитику (RFM, cohort, ROI)
- Создавать промо-акции
- Менять настройки loyalty
- Экспортировать данные
- Видеть Activity Log других кассиров
- Начислять >20,000₽ без подтверждения Manager'а

***

## **🚀 ТЕХНОЛОГИИ \& ОПТИМИЗАЦИЯ**

### **Frontend:**

- Next.js 14 App Router + TypeScript
- shadcn/ui (темная тема)
- TanStack Query (data fetching)
- IndexedDB (offline cache)
- FingerprintJS (device identification)
- QRCode.react (для карточек)
- React Hook Form + Zod (валидация)


### **Performance:**

- Code splitting (отдельный chunk для `/cashier`)
- Bundle size < 300KB gzipped
- Tree shaking (только используемые компоненты)
- Critical CSS inline
- Service Worker (asset caching)
- Debounced search (200ms)
- Lazy loading (modals)


### **Hardware Integration:**

- Thermal printer (ESC/POS protocol)
- Barcode scanner (keyboard wedge)
- Touch screen optimized (large buttons 80px+)


### **Security:**

- PIN-код (4 цифры)
- Session timeout (15 min)
- Activity logging (все действия)
- Anomaly detection (fraud prevention)
- Manager approval (high amounts)
- Device fingerprint (terminal tracking)


### **Offline Support:**

- IndexedDB (cache последних 100 гостей)
- Sync queue (pending transactions)
- Read-only offline (cached data)
- Write with queue (sync later)
- Offline indicator (warning banner)

***

## **📊 UI/UX ОСОБЕННОСТИ**

### **Design Principles:**

1. **Large touch targets** - минимум 60px для кнопок (оптимально 80px)
2. **High contrast** - темная тема с яркими акцентами
3. **Minimal text** - иконки + короткие labels
4. **Single focus** - одна задача на экран
5. **Fast feedback** - instant response на действия
6. **Clear validation** - ошибки показываются сразу
7. **Escape hatch** - всегда есть кнопка "Назад"
8. **No distractions** - нет sidebar, меню, лишних элементов

### **Touch Screen Optimization:**

- Кнопки 80px+ height
- Gap между элементами 16px+
- Swipe gestures (опционально)
- No hover states (только active/pressed)
- Large font sizes (18px+ для текста, 24px+ для чисел)


### **Color Coding:**

- 🟢 **Green** - Earn (начисление баллов)
- 🔴 **Red** - Redeem (списание баллов)
- 🟡 **Yellow** - Warning (offline, high amount)
- 🔵 **Blue** - Info (помощь, подсказки)
- ⚪ **Gray** - Neutral (отмена, назад)

***

## **🔗 ИНТЕГРАЦИЯ С ДРУГИМИ ЧАСТЯМИ СИСТЕМЫ**

### **Admin Dashboard:**

- Admin создаёт Cashier аккаунт (email + начальный PIN)
- Admin назначает терминалы
- Admin видит Activity Log всех кассиров
- Admin настраивает fraud detection rules
- Admin устанавливает max check amount без approval


### **Manager Dashboard:**

- Manager видит Activity Log своих кассиров
- Manager одобряет high amount transactions (PIN-код)
- Manager может помочь Cashier'у (кнопка "Позвать Manager'а")
- Manager видит статистику кассиров (кто сколько обработал)


### **Guest Telegram Mini App:**

- Гость получает уведомление о транзакции (начислено/списано)
- Гость видит баланс в real-time (WebSocket sync)
- Гость показывает QR-код → Cashier сканирует


### **POS Integration:**

- Автоматическое начисление баллов при оплате чека (webhook от POS)
- Cashier видит в Quick Stats транзакции из POS
- Fallback: manual начисление если POS не интегрирована

***

## **📱 MOBILE VIEW (для планшета на кассе)**

**Responsive breakpoints:**

- Desktop (>= 1024px) - Split screen layout
- Tablet (768px - 1023px) - Vertical stack
- Mobile (< 768px) - Single column (не рекомендуется для касс)

**Tablet Layout (портретная ориентация):**

```
┌─────────────────────────────┐
│ Header (Терминал + Stats)   │
├─────────────────────────────┤
│                             │
│   Search Bar (large)        │
│                             │
├─────────────────────────────┤
│                             │
│   Guest Info Card           │
│   (если выбран)             │
│                             │
├─────────────────────────────┤
│                             │
│   Action Buttons            │
│   [Начислить] [Списать]     │
│                             │
├─────────────────────────────┤
│                             │
│   Recent Guests             │
│   (grid 2 columns)          │
│                             │
└─────────────────────────────┘
```


***

## **🎓 ONBOARDING \& TRAINING**

### **Cashier Onboarding (при первом входе):**

**Step 1: Welcome Screen**

```tsx
<Dialog open={isFirstLogin}>
  <DialogContent className="max-w-2xl">
    <DialogHeader>
      <DialogTitle className="text-3xl">Добро пожаловать в Max Loyalty!</DialogTitle>
      <DialogDescription>
        Давайте покажем как работать с кассой (займёт 2 минуты)
      </DialogDescription>
    </DialogHeader>
    
    <div className="space-y-6">
      <div className="flex items-center gap-4">
        <div className="h-16 w-16 rounded-full bg-primary/10 flex items-center justify-center">
          <Search className="h-8 w-8 text-primary" />
        </div>
        <div>
          <h3 className="font-semibold text-lg">1. Найдите гостя</h3>
          <p className="text-secondary">
            Введите телефон, имя или отсканируйте карту
          </p>
        </div>
      </div>
      
      <div className="flex items-center gap-4">
        <div className="h-16 w-16 rounded-full bg-primary/10 flex items-center justify-center">
          <Gift className="h-8 w-8 text-primary" />
        </div>
        <div>
          <h3 className="font-semibold text-lg">2. Обработайте чек</h3>
          <p className="text-secondary">
            Начислите или спишите баллы
          </p>
        </div>
      </div>
      
      <div className="flex items-center gap-4">
        <div className="h-16 w-16 rounded-full bg-primary/10 flex items-center justify-center">
          <CheckCircle2 className="h-8 w-8 text-primary" />
        </div>
        <div>
          <h3 className="font-semibold text-lg">3. Готово!</h3>
          <p className="text-secondary">
            Гость получил баллы или скидку
          </p>
        </div>
      </div>
    </div>
    
    <DialogFooter>
      <Button
        variant="outline"
        onClick={() => setShowInteractiveTour(true)}
      >
        Показать интерактивный тур
      </Button>
      <Button onClick={handleSkipOnboarding}>
        Начать работу
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

**Step 2: Interactive Tour (react-joyride):**

- Highlight search bar → "Здесь ищите гостя"
- Highlight recent guests → "Или выберите из последних"
- Highlight quick stats → "Ваша статистика за день"
- Highlight register button → "Регистрация нового гостя"
- Highlight help button → "Если что-то непонятно"

***

## **🐛 ERROR HANDLING**

### **Common Errors:**

**1. Guest Not Found:**

```tsx
{searchQuery.length >= 3 && searchResults.length === 0 && (
  <Card className="absolute top-full mt-2 w-full">
    <CardContent className="p-8 text-center">
      <UserX className="h-12 w-12 mx-auto mb-3 text-secondary" />
      <p className="text-lg font-semibold mb-2">Гость не найден</p>
      <p className="text-secondary mb-4">
        По запросу "{searchQuery}" не найдено гостей
      </p>
      <Button onClick={openRegisterGuest}>
        <UserPlus className="mr-2 h-5 w-5" />
        Зарегистрировать нового гостя
      </Button>
    </CardContent>
  </Card>
)}
```

**2. Network Error:**

```tsx
{networkError && (
  <Alert variant="destructive" className="mb-4">
    <WifiOff className="h-4 w-4" />
    <AlertTitle>Нет соединения</AlertTitle>
    <AlertDescription>
      Проверьте подключение к интернету. Транзакции будут сохранены и синхронизированы позже.
    </AlertDescription>
  </Alert>
)}
```

**3. Printer Error:**

```tsx
{printerError && (
  <Alert variant="warning" className="mb-4">
    <Printer className="h-4 w-4" />
    <AlertTitle>Ошибка печати</AlertTitle>
    <AlertDescription>
      Принтер недоступен. Проверьте подключение или обратитесь к Manager'у.
      <Button variant="link" size="sm" onClick={retryPrint}>
        Попробовать снова
      </Button>
    </AlertDescription>
  </Alert>
)}
```

**4. Insufficient Balance:**

```tsx
{redeemAmount > guest.ballBalance && (
  <Alert variant="destructive">
    <AlertTriangle className="h-4 w-4" />
    <AlertDescription>
      Недостаточно баллов. У гостя только {guest.ballBalance} баллов.
    </AlertDescription>
  </Alert>
)}
```

**5. Redeem Limit Exceeded:**

```tsx
{redeemAmount > maxRedeemForCheck && (
  <Alert variant="destructive">
    <AlertTriangle className="h-4 w-4" />
    <AlertDescription>
      Превышен лимит списания ({loyaltySettings.redeemLimit}% от чека).
      Максимум можно списать {maxRedeemForCheck} баллов для чека на {formatCurrency(checkAmount)}.
    </AlertDescription>
  </Alert>
)}
```


***

# 🎉 **CASHIER POS INTERFACE - ЗАВЕРШЕНО!**


***

## **КРАТКОЕ РЕЗЮМЕ:**

✅ **25 вопросов решены**
✅ **Отдельный роут `/cashier`** (изолирован от Admin/Manager)
✅ **PIN-код вход** (4 цифры, numpad UI)
✅ **Touch-optimized** (большие кнопки, крупный шрифт)
✅ **Fast search** (debounced, barcode scanner)
✅ **Calculator UI** (earn/redeem баллов)
✅ **Minimal permissions** (только касса, без аналитики)
✅ **Offline support** (IndexedDB + sync queue)
✅ **Thermal printer** (ESC/POS для карточек и чеков)
✅ **Security** (auto-logout, activity log, fraud detection)
✅ **Terminal tracking** (device fingerprint)
✅ **Performance** (< 300KB bundle, code splitting)
✅ **Help system** (FAQ, interactive tour)
✅ **Error handling** (graceful degradation)

***

# 🚀 **ГОТОВ К СЛЕДУЮЩЕМУ БЛОКУ!**

**Какой блок детализируем следующим?**

1. **Guest Telegram Mini App** - мобильное приложение для гостей (моя карточка, баланс, история транзакций, акции, QR-код для показа кассиру)
2. **API Documentation \& Webhooks** - REST API endpoints, authentication, rate limits, webhook events для POS интеграции
3. **Owner Analytics Deep Dive** - углублённая аналитика для Owner'а (multi-tenant analytics, cross-restaurant comparison, tenant health metrics)

**Что делаем дальше?** 🎯

---

# 📋 **CASHIER POS INTERFACE - ФИНАЛЬНЫЕ РЕШЕНИЯ ПО 25 ВОПРОСАМ**


***

## **🎯 1. ROLE \& PURPOSE**

### **Вопрос 1: Cashier Interface - это отдельное приложение или часть Dashboard?**

**Принятое решение:** Отдельный роут `/cashier` + Fullscreen mode + Touch-optimized UI

**Обоснование:**

- Отдельный роут `/cashier` полностью изолирован от Admin/Manager Dashboard (нет sidebar, меню, лишних элементов)
- Fullscreen mode для работы на кассовом терминале (immersive experience)
- Touch-optimized с большими кнопками (80px+ height), крупным шрифтом (18px+ text, 24px+ numbers)
- Single-purpose интерфейс - одна задача = найти гостя, обработать чек
- Fast loading (< 300KB bundle) критично для производительности на кассе
- Offline-ready с IndexedDB для работы при нестабильном WiFi

**Роуты:**

```
/cashier/login              → PIN-код вход
/cashier                    → Main Screen (search + quick actions)
/cashier/guest/:id          → Guest Quick View
/cashier/register-guest     → Регистрация гостя
/cashier/transaction/:id    → Receipt screen
/cashier/print-card/:id     → Print layout
```


***

### **Вопрос 2: Cashier Authentication - как Cashier логинится?**

**Принятое решение:** PIN-код (4 цифры) + Optional Email/Password fallback

**Обоснование:**

- PIN-код (4 цифры) - самый быстрый метод для смены кассиров (вход за 2 секунды)
- Numpad UI с большими кнопками для тач-экрана (как банкомат)
- Session timeout 15 минут бездействия (автоматический logout для безопасности)
- Fallback Email/Password если кассир забыл PIN (ссылка "Войти через email")
- Admin assigns PIN при создании Cashier аккаунта (кассир может сменить позже)

**UI Login:**

- 4 круга для отображения введённых цифр (●●●●)
- Numpad 3x4 (1-9, C, 0, Backspace)
- Large buttons (80px height, text-2xl)
- Error message если неверный PIN
- Auto-submit после 4-й цифры

***

### **Вопрос 3: Cashier Permissions - что Cashier может делать?**

**Принятое решение:** Просмотр + начисление/списание по чеку + Регистрация гостей (без ручной корректировки, без удаления, без аналитики)

**Обоснование:**

**Cashier МОЖЕТ:**

- Искать гостя (по телефону, карте, имени, QR-коду)
- Просматривать баланс (Regular + Promo balls)
- Просматривать уровень гостя и earn bonus
- Начислять баллы по чеку (автоматический расчёт: сумма × earn rate × level bonus)
- Списывать баллы с подтверждением и проверкой redeem limit
- Регистрировать нового гостя (телефон + имя + ДР optional)
- Просматривать краткую историю транзакций (last 3)
- Печатать карточку лояльности и чеки
- Сменить свой PIN-код

**Cashier НЕ МОЖЕТ:**

- Редактировать профиль гостя (имя, email, дети) - только Manager/Admin
- Ручная корректировка баллов (arbitrary adjustment без чека)
- Удалять/деактивировать гостей
- Экспортировать данные
- Видеть полную аналитику
- Создавать промо-акции
- Менять настройки loyalty
- Видеть Activity Log

**Таблица прав:**

```
Действие                    Admin  Manager  Cashier
────────────────────────────────────────────────────
Поиск гостя                 ✓      ✓        ✓
Просмотр баланса            ✓      ✓        ✓
Начисление по чеку          ✓      ✓        ✓
Списание по чеку            ✓      ✓        ✓
Регистрация гостя           ✓      ✓        ✓ (minimal)
Редактирование профиля      ✓      ✓        ✕
Ручная корректировка        ✓      ✓*       ✕
Просмотр полной истории     ✓      ✓        ✕ (only last 3)
Analytics                   ✓      ✓        ✕
Loyalty Builder             ✓      ✓*       ✕
Export                      ✓      ✓*       ✕
Delete guests               ✓      ✕        ✕
```


***

## **🔍 2. MAIN SCREEN (SEARCH \& QUICK ACTIONS)**

### **Вопрос 4: Main Screen Layout - что показать Cashier'у по умолчанию?**

**Принятое решение:** Search bar по центру + Recent Guests (last 10) + Quick Stats (3 метрики)

**Обоснование:**

- Focus on search - главная задача кассира = найти гостя → Search bar крупный, по центру, автофокус
- Recent Guests показывает последних 10 гостей (кассир часто обслуживает постоянных клиентов) → one-click access
- Quick Stats (Гостей сегодня | Транзакций | Баллов начислено) в header для контекста и мотивации
- Quick Actions: "Зарегистрировать гостя" и "Помощь" (крупные кнопки)
- Clean layout без отвлекающих элементов (no sidebar, no navigation)

**Header:**

- Logo + Restaurant name слева
- Quick Stats по центру
- Cashier profile + Terminal dropdown справа

**Main Content:**

- Hero section: заголовок "Найти гостя" + описание
- Large search input (h-20, text-2xl)
- Search results dropdown (если есть)
- Quick action buttons
- Recent guests grid (2 columns)

***

### **Вопрос 5: Guest Search - как искать быстро на кассе?**

**Принятое решение:** Debounced search (200ms) + Barcode scanner support + Phone normalization

**Обоснование:**

- Debounced 200ms - баланс между скоростью и нагрузкой (не бомбардируем API на каждую букву)
- Min 3 chars для начала поиска (избегаем слишком широких результатов)
- Barcode scanner support для QR-кодов карт (если код начинается с `MLTY-` → direct lookup)
- Phone normalization автоматическая: `8 999 123-45-67` → `+79991234567`
- Fuzzy search находит с опечатками (Иван → Ивн, Ivan)

**Search Logic:**

```typescript
const handleSearch = useDebouncedCallback(async (query: string) => {
  if (query.length < 3) return;
  
  // Check if QR code
  if (query.startsWith('MLTY-')) {
    const guest = await api.guests.findByCard(query);
    if (guest) selectGuest(guest);
    return;
  }
  
  // Normalize phone
  const normalizedPhone = normalizePhone(query);
  
  // Search
  const results = await api.guests.search({
    query: normalizedPhone || query,
    limit: 10
  });
  
  setSearchResults(results);
}, 200);
```

**Barcode Scanner Integration:**

- Listen for fast keyboard input (< 50ms between chars)
- Buffer characters until Enter
- If starts with `MLTY-` → direct guest lookup

***

### **Вопрос 6: Search Results - как показать результаты?**

**Принятое решение:** Dropdown список под search bar (как autocomplete)

**Обоснование:**

- Instant access - результаты появляются сразу под search bar (не нужно скроллить)
- Focus retention - search bar остаётся в фокусе, можно уточнить запрос
- One click to select - клик на гостя → открывает Guest Quick View
- Compact - помещается 5-7 результатов на экран (если больше → scroll в dropdown)
- Visual - показывает аватар, имя, телефон, уровень, баланс (вся критичная инфо)

**Result Item:**

- Avatar (48px) слева
- Имя + телефон в центре
- Уровень (badge) + баланс справа
- Chevron icon (→) для указания "кликабельно"
- Hover state для тач-экрана (bg-card-hover)

***

## **👤 3. GUEST QUICK VIEW**

### **Вопрос 7: Guest Quick View - что показать Cashier'у о госте?**

**Принятое решение:** Split screen layout (инфо слева, actions справа) + Bottom quick actions

**Обоснование:**

- Split screen эффективно использует пространство на широком мониторе кассы
- Left Panel: Guest Info - аватар (96px), имя, телефон, уровень, баланс (Regular + Promo), последние 3 транзакции
- Right Panel: Check Actions - 2 большие кнопки (h-32, text-2xl): "Начислить баллы" и "Списать баллы"
- Bottom Bar: Quick Actions - "Назад к поиску", "Печать карточки", "Позвать Manager'а"
- No tabs - всё на одном экране (кассир не переключается между табами)
- Large touch targets - кнопки большие для тач-экрана

**Left Panel содержит:**

- Guest header (avatar + name + phone + email)
- Loyalty level card (уровень + earn bonus + lifetime spent)
- Ball balance card (баланс + промо-баллы + сколько можно списать)
- Recent transactions (last 3 with type, amount, date)

**Right Panel:**

- Centered vertically
- Заголовок "Обработка чека"
- Кнопка "Начислить баллы" (success style, large)
- Кнопка "Списать баллы" (outline, large, disabled если баланс = 0)

***

### **Вопрос 8: Earn Balls Modal - как начислить баллы по чеку?**

**Принятое решение:** Calculator UI (numpad) + Real-time calculation preview + Breakdown

**Обоснование:**

- Calculator UI с кнопками 0-9 (80px height) для быстрого ввода суммы на тач-экране
- Real-time preview показывает сколько баллов начислится (сумма × earn rate × level bonus)
- Large display показывает сумму чека (text-5xl) и начисляемые баллы
- Calculation breakdown card показывает: базовое начисление + бонус уровня = итого
- Clear validation: минимальная сумма чека (например 100₽), показывается error alert
- Confirmation button disabled пока не введена валидная сумма

**UI Elements:**

- Check amount display (bg-muted, rounded-xl, центрированный)
- Numpad grid 3x3 + C/0/Backspace
- Breakdown card с детализацией расчёта
- Validation alert если сумма < min check amount
- Footer buttons: Отмена | Начислить X баллов

**Calculation:**

```typescript
baseEarn = floor(checkAmount × earnPercent / 100)
levelBonus = floor(checkAmount × guestEarnBonus / 100)
total = baseEarn + levelBonus
```


***

### **Вопрос 9: Redeem Balls Modal - как списать баллы?**

**Принятое решение:** Preset buttons + Calculator UI + Custom input + Check amount для redeem limit

**Обоснование:**

- Preset buttons (100, 500, 1000, Всё) для быстрого выбора популярных сумм
- Calculator UI (numpad) для точного ввода произвольной суммы
- Check amount input обязателен для проверки redeem limit (максимум X% от чека можно списать)
- Real-time discount preview (баллы = рубли скидки, 1:1)
- Max limit enforcement - не может списать больше баланса или больше redeem limit % от чека
- Balance after показывает сколько останется баллов

**UI Elements:**

- Redemption amount display (text-5xl, text-danger)
- Preset buttons grid 1x4
- Numpad grid 3x3
- Check amount input field (для валидации redeem limit)
- Calculation card: списать | скидка | останется
- Validation alerts: insufficient balance, redeem limit exceeded
- Footer buttons: Отмена | Списать X баллов (destructive style)

**Validation:**

```typescript
if (redeemAmount > guest.ballBalance) → error
if (redeemAmount > checkAmount × redeemLimit / 100) → error
```


***

### **Вопрос 10: Transaction Confirmation - как показать успешную транзакцию?**

**Принятое решение:** Receipt screen (как чек) + Auto-redirect через 5 секунд + Print button

**Обоснование:**

- Receipt screen визуально похож на чек (знакомый формат для гостя и кассира)
- All details: что сделали, сколько баллов, сумма чека, баланс до/после, дата/время, кассир, ID транзакции
- Large success icon (CheckCircle2, 96px, green)
- Print button для печати чека с балансом
- Auto-redirect через 5 секунд возвращает на Main Screen (для следующего гостя)
- Manual "Готово" button для немедленного возврата
- Countdown показывает "Автоматический возврат через X сек"

**Receipt содержит:**

- Success icon + заголовок
- Имя гостя
- Transaction amount (text-6xl, colored)
- Details: сумма чека, баланс до/после
- Meta: timestamp, кассир, transaction ID
- Actions: Печать чека | Готово

***

## **➕ 4. REGISTER GUEST**

### **Вопрос 11: Register Guest Form - какие поля минимально нужны?**

**Принятое решение:** Телефон* + Имя* + Фамилия + День рождения (optional)

**Обоснование:**

- Телефон (required) - уникальный идентификатор для поиска, used for notifications
- Имя (required) - персонализация (кассир обращается по имени)
- Фамилия (optional) - помогает различить гостей с одинаковыми именами
- День рождения (optional) - для birthday promo, но не обязательно на кассе (можно добавить позже)
- Email, Дети, Адрес НЕ запрашиваем (слишком долго, гость торопится) - Manager добавит позже
- Auto-generate card (QR-код + 6-digit display code) автоматически при создании

**Form Flow:**

1. Phone input (autofocus, tel format, validation)
2. First name input (required)
3. Last name input (optional)
4. Birthday input (date picker, optional)
5. Info alert: "Дополнительную информацию можно добавить позже"
6. Buttons: Отмена | Зарегистрировать

**После регистрации:**

- Guest создаётся с начальным уровнем Bronze
- GuestCard генерируется автоматически
- Баланс = 0 (или welcome bonus если настроен)
- Redirect на Guest Quick View → можно сразу обработать чек

***

### **Вопрос 12: Duplicate Phone Detection - что если телефон уже есть?**

**Принятое решение:** Alert с предложением открыть существующего гостя

**Обоснование:**

- Prevent duplicates - один телефон = один гость (уникальный identifier)
- User-friendly - кассир сразу видит "Гость уже зарегистрирован" + карточка с инфо
- Fast recovery - кнопка "Открыть гостя" ведёт в Guest Quick View (не теряем время)
- Кассир может отменить и ввести другой телефон если ошибся

**UI Duplicate Alert:**

- Warning alert появляется в форме
- Заголовок "Гость уже зарегистрирован"
- Guest card preview (avatar, name, phone, level, balance)
- Buttons: Отмена | Открыть гостя

***

## **🖨️ 5. PRINT \& RECEIPTS**

### **Вопрос 13: Print Loyalty Card - как печатать карточку?**

**Принятое решение:** Thermal printer (ESC/POS) + Fallback browser print

**Обоснование:**

- Thermal printer standard на кассах (80mm width чековый принтер)
- ESC/POS protocol поддерживается большинством принтеров
- Instant print - клик → печатает сразу (без диалогов)
- Fallback browser print если принтер не подключен
- Card layout: QR-код (150x150px) + 6-digit display code + имя + уровень + баланс + телефон

**Print Layout (80mm thermal):**

```
┌────────────────────────────────┐
│      MAX LOYALTY               │
│      Ресторан "Макс"           │
├────────────────────────────────┤
│   [QR-код 150x150px]           │
│        000123                  │
│   (покажите кассиру)           │
├────────────────────────────────┤
│  Иван Иванов                   │
│  🥇 Gold                       │
│  Баланс: 2,850 баллов          │
├────────────────────────────────┤
│  +7 999 123-45-67              │
│  maxloyalty.app                │
└────────────────────────────────┘
```

**Implementation:**

- ThermalPrinter class с ESC/POS commands
- QR code printing (printQRCode method)
- Text formatting (size, alignment)
- Cut command после печати
- Error handling с retry option

***

### **Вопрос 14: Print Transaction Receipt - печатать ли чек после транзакции?**

**Принятое решение:** Optional печать (кнопка "Печать чека" на Receipt screen)

**Обоснование:**

- Optional - не все гости хотят бумажный чек (экология, минимализм)
- Fast - кассир решает по запросу гостя
- Thermal printer - быстрая печать на чековом принтере
- Compact receipt: дата, сумма чека, баллы начислены/списаны, баланс до/после, кассир, ID

**Receipt Layout (80mm thermal):**

```
┌────────────────────────────────┐
│      MAX LOYALTY               │
│      Ресторан "Макс"           │
├────────────────────────────────┤
│  Чек №123456                   │
│  16.02.2026 14:35              │
│                                │
│  Гость: Иван Иванов            │
│  Карта: 000123                 │
├────────────────────────────────┤
│  Сумма чека:    2,000 ₽        │
│  Начислено:       +200 б.      │
│                                │
│  Баланс до:     2,650 б.       │
│  Баланс после:  2,850 б.       │
├────────────────────────────────┤
│  Кассир: Анна П.               │
│  Спасибо за покупку!           │
│  maxloyalty.app                │
└────────────────────────────────┘
```


***

## **⚙️ 6. SETTINGS \& HELP**

### **Вопрос 15: Cashier Settings - что Cashier может настроить?**

**Принятое решение:** PIN-код + Язык интерфейса + Printer settings

**Обоснование:**

- Смена PIN-кода - кассир может сменить для безопасности (4-digit PIN input с подтверждением)
- Язык интерфейса - если работают иностранные кассиры (dropdown с языками)
- Printer settings - выбор принтера если несколько, test print для проверки
- Minimal settings - только самое необходимое (не отвлекаем от работы)

**Settings доступны через Profile Dropdown:**

- Сменить PIN-код → Modal с numpad (Current PIN | New PIN | Confirm PIN)
- Язык интерфейса → Select dropdown
- Настройки печати → Modal (Выбор принтера | Тестовая печать)
- Помощь → Help Modal
- Выйти → Logout

**Change PIN Modal:**

- 3 секции: Current PIN (4 circles), New PIN (4 circles), Confirm PIN (4 circles)
- Numpad 3x3 для ввода
- Validation: current PIN must be correct, new PIN must match confirm
- Error alert если что-то не так

***

### **Вопрос 16: Help Screen - как помочь Cashier'у если что-то непонятно?**

**Принятое решение:** FAQ + Quick Guide + Contact support

**Обоснование:**

- FAQ - быстрые ответы на частые вопросы (Accordion UI)
- Quick Guide - пошаговые инструкции "Быстрый старт"
- Contact Support - кнопки "Позвать Manager'а" и "Техподдержка"
- Встроено в интерфейс (не нужно выходить из приложения)
- Searchable FAQ для быстрого поиска ответа

**FAQ Topics:**

1. Как найти гостя? (Search by phone/name/card/QR)
2. Как начислить баллы? (Step-by-step)
3. Как списать баллы? (Step-by-step + redeem limit explanation)
4. Как зарегистрировать гостя? (Minimal fields)
5. Что делать если не печатает? (Troubleshooting)

**Quick Guide:**

- Step 1: Войдите (PIN-код)
- Step 2: Найдите гостя (Search)
- Step 3: Обработайте чек (Earn/Redeem)
- Step 4: Готово!

**Contact Support:**

- "Позвать Manager'а" button (отправляет уведомление Manager'у)
- "Техподдержка" button (opens support.maxloyalty.app)

***

## **🔄 7. OFFLINE MODE \& SYNC**

### **Вопрос 17: Offline Support - что если нет интернета на кассе?**

**Принятое решение:** IndexedDB cache + Sync Queue (limited offline mode)

**Обоснование:**

- IndexedDB кеширует последних 100 гостей (most frequent visitors)
- Sync Queue сохраняет транзакции локально → синхронизирует когда интернет вернётся
- Read-only offline - можно искать cached гостей, видеть баланс (но данные могут быть устаревшие)
- Write with queue - можно начислять/списывать баллы → транзакция в очередь → sync later
- Offline indicator (warning banner) показывает что данные могут быть неактуальны
- Conflicts возможны если гость использовал баллы в другом месте while offline (но редко)

**Offline Flow:**

1. WiFi пропал → offline event trigger
2. Показать warning banner "Режим офлайн"
3. Search работает только по cached гостям (IndexedDB)
4. Transaction сохраняется в sync queue (IndexedDB)
5. Guest balance обновляется локально (optimistic update)
6. WiFi вернулся → online event trigger
7. Sync queue обрабатывается (POST transactions to API)
8. Toast "Синхронизировано X транзакций"

**Sync Queue Implementation:**

```typescript
interface QueuedTransaction {
  id: string;
  guestId: string;
  type: 'EARN' | 'REDEEM';
  amount: number;
  checkAmount?: number;
  createdAt: string;
  status: 'PENDING' | 'SYNCED' | 'FAILED';
}

async function syncQueue() {
  const pending = await db.syncQueue.where('status').equals('PENDING').toArray();
  
  for (const tx of pending) {
    try {
      await api.transactions.create(tx);
      await db.syncQueue.update(tx.id, { status: 'SYNCED' });
    } catch (error) {
      await db.syncQueue.update(tx.id, { status: 'FAILED' });
    }
  }
}
```


***

### **Вопрос 18: Auto-logout on Inactivity - как защитить от несанкционированного доступа?**

**Принятое решение:** Auto-logout через 15 минут бездействия + Warning за 1 минуту

**Обоснование:**

- Security - предотвращает доступ посторонних если кассир ушёл
- 15 минут - баланс между удобством и безопасностью (кассир может отойти на перерыв)
- Warning за 1 минуту - Modal с countdown "Вы будете выведены через 60 сек"
- Continue button - кассир может продлить сессию кликом
- Activity detection - любое движение мыши/клавиатуры/тач сбрасывает таймер

**Inactivity Timer:**

```typescript
const INACTIVITY_TIMEOUT = 15 * 60 * 1000; // 15 min
const WARNING_BEFORE = 60 * 1000; // 1 min

useEffect(() => {
  let timer, warningTimer;
  
  const resetTimer = () => {
    clearTimeout(timer);
    clearTimeout(warningTimer);
    
    warningTimer = setTimeout(() => {
      setShowWarning(true);
      setCountdown(60);
    }, INACTIVITY_TIMEOUT - WARNING_BEFORE);
    
    timer = setTimeout(() => {
      handleLogout();
    }, INACTIVITY_TIMEOUT);
  };
  
  ['mousedown', 'keydown', 'touchstart'].forEach(event => {
    window.addEventListener(event, resetTimer);
  });
  
  resetTimer();
}, []);
```

**Warning Modal:**

- Title: "Вы ещё здесь?"
- Countdown: "60" (text-6xl, decrementing)
- Buttons: Выйти сейчас | Продолжить работу

***

## **📊 8. CASHIER ANALYTICS (LIMITED)**

### **Вопрос 19: Cashier Stats - видит ли Cashier свою статистику?**

**Принятое решение:** Только своя статистика в header (3 метрики за сегодня)

**Обоснование:**

- Motivation - кассир видит свой прогресс (геймификация работы)
- Minimal - только 3 метрики (не отвлекает от основной работы)
- No comparison - не показываем статистику других кассиров (избегаем нездоровой конкуренции)
- Today only - сбрасывается каждый день в 00:00 (показывает только сегодняшние данные)

**Quick Stats (в header):**

- Гостей сегодня (количество уникальных гостей обработанных кассиром)
- Транзакций (earn + redeem операций)
- Баллов начислено (total earned balls за день)

**Отображение:**

```tsx
<div className="flex gap-6 text-sm">
  <div>
    <div className="text-secondary">Гостей сегодня</div>
    <div className="text-xl font-bold">42</div>
  </div>
  <div>
    <div className="text-secondary">Транзакций</div>
    <div className="text-xl font-bold">58</div>
  </div>
  <div>
    <div className="text-secondary">Баллов начислено</div>
    <div className="text-xl font-bold">12,450</div>
  </div>
</div>
```


***

### **Вопрос 20: Recent Guests Widget - как помочь Cashier'у работать быстрее?**

**Принятое решение:** Recent Guests на Main Screen (последние 10 гостей этого кассира)

**Обоснование:**

- Speed - one-click access без search (постоянные клиенты)
- Personalization - показывает последних гостей обработанных ЭТИМ кассиром (не всех, не других кассиров)
- Persistent - хранится в localStorage (сохраняется между сессиями)
- Move to top - если гость уже в списке, при повторном обращении поднимается наверх
- Limit 10 - не перегружаем экран

**Recent Guests Grid:**

- 2 columns layout
- Guest cards с hover effect
- Avatar + Name + Phone + Level badge + Balance
- Click → открывает Guest Quick View

**Storage Logic:**

```typescript
function addToRecentGuests(guest: Guest) {
  let recent = JSON.parse(localStorage.getItem('cashier_recent_guests') || '[]');
  
  // Remove if exists
  recent = recent.filter(g => g.id !== guest.id);
  
  // Add to top
  recent.unshift(guest);
  
  // Keep only 10
  recent = recent.slice(0, 10);
  
  localStorage.setItem('cashier_recent_guests', JSON.stringify(recent));
}
```


***

## **⚡ 9. PERFORMANCE \& OPTIMIZATION**

### **Вопрос 21: Keyboard Shortcuts - нужны ли хоткеи для кассира?**

**Принятое решение:** Базовые shortcuts для основных действий (F1-F5, ESC, Enter)

**Обоснование:**

- Speed - опытный кассир работает на 30% быстрее с клавиатурой
- Minimal learning curve - только очевидные сочетания
- Optional - мышь/тач продолжают работать (хоткеи = enhancement)
- Standard keys - F-keys знакомы всем

**Keyboard Shortcuts:**

```
F1  → Помощь
F2  → Focus на поиск
F3  → Регистрация гостя
F5  → Refresh данных
ESC → Закрыть modal / Назад
Enter → Подтвердить действие
0-9 → Numpad input (в modals)
```

**Implementation:**

```typescript
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.key === 'F1') {
      e.preventDefault();
      setShowHelp(true);
    }
    if (e.key === 'F2') {
      e.preventDefault();
      searchInputRef.current?.focus();
    }
    if (e.key === 'Escape') {
      closeAllModals();
    }
  };
  
  window.addEventListener('keydown', handleKeyDown);
  return () => removeEventListener('keydown', handleKeyDown);
}, []);
```

**Shortcuts Help Card (в Help Modal):**

- Table с двумя колонками: Key | Action
- F1 → Помощь, F2 → Поиск, F3 → Регистрация, ESC → Назад

***

### **Вопрос 22: Bundle Size Optimization - как минимизировать загрузку?**

**Принятое решение:** Code splitting + Minimal dependencies + Tree shaking + Service Worker

**Обоснование:**

- Code splitting - отдельный chunk для `/cashier` routes (не загружаем Admin/Manager код)
- Tree shaking - только используемые компоненты из shadcn/ui
- No heavy libs - избегаем Recharts (не нужна аналитика кассиру), no Recharts, no date-fns-tz
- Critical CSS inline - первый render без FOUC
- Service Worker - кеширование assets для instant повторных загрузок
- Lazy loading - modals загружаются on-demand

**Bundle Size Target:**

- Initial load: < 100KB gzipped (критично для медленного WiFi)
- Total: < 300KB gzipped
- Time to Interactive: < 2 seconds

**Webpack Config:**

```javascript
module.exports = {
  webpack: (config) => {
    config.optimization.splitChunks = {
      cacheGroups: {
        cashier: {
          test: /[\\/]app[\\/]cashier[\\/]/,
          name: 'cashier',
          priority: 10
        }
      }
    };
    return config;
  }
};
```


***

## **🔒 10. SECURITY \& AUDIT**

### **Вопрос 23: Cashier Activity Log - логируются ли все действия?**

**Принятое решение:** Полное логирование всех транзакций и операций

**Обоснование:**

- Accountability - Admin/Manager видят кто что делал
- Fraud detection - детектирование аномалий (кассир начислил себе 10K баллов)
- Dispute resolution - если гость жалуется "мне не начислили" → проверяем лог
- Performance tracking - сколько гостей обработал каждый кассир

**Logged Events:**

```typescript
enum CashierActionType {
  LOGIN, LOGOUT, CHANGE_PIN,
  SEARCH_GUEST, VIEW_GUEST, REGISTER_GUEST,
  EARN_BALLS, REDEEM_BALLS,
  PRINT_CARD, PRINT_RECEIPT,
  CALL_MANAGER, VIEW_HELP
}
```

**Activity Log Entry:**

```typescript
{
  id: 'log_abc123',
  actionType: 'EARN_BALLS',
  performedBy: {
    id: 'cashier_xyz',
    firstName: 'Анна',
    role: 'CASHIER'
  },
  targetGuest: {
    id: 'guest_123',
    firstName: 'Иван'
  },
  terminal: {
    id: 'terminal_001',
    name: 'POS-1'
  },
  metadata: {
    checkAmount: 2000,
    ballsEarned: 220,
    balanceBefore: 500,
    balanceAfter: 720
  },
  ipAddress: '192.168.1.50',
  createdAt: '2026-02-16T14:30:00Z'
}
```

**Admin/Manager видят:**

- Кто (cashier name + role)
- Что (action type)
- Когда (timestamp)
- С кем (guest name)
- Где (terminal name)
- Детали (amounts, balances)

***

### **Вопрос 24: Fraud Prevention - как предотвратить мошенничество?**

**Принятое решение:** Anomaly detection + Manual check amount limits + Manager approval для high amounts

**Обоснование:**

**Anomaly Detection (backend):**

- ⚠️ Unusually high check - если чек >50,000₽ → alert Manager'у
- ⚠️ Self-transaction - кассир начислил баллы на свой аккаунт → alert
- ⚠️ Frequent same guest - один гость >10 раз в день → suspicious
- ⚠️ After hours - транзакция в 3:00 ночи (ресторан закрыт) → alert

**Check Amount Limits:**

- Max check amount без подтверждения: 20,000₽
- Если больше → требуется PIN-код Manager'а
- Manager PIN validation на backend
- Activity Log записывает manager approval

**UI Manager Approval:**

```tsx
{checkAmount > 20000 && (
  <Alert variant="warning">
    <ShieldAlert className="h-4 w-4" />
    <AlertDescription>
      <div className="font-semibold mb-2">
        Требуется подтверждение Manager'а
      </div>
      <p className="mb-3">
        Сумма чека превышает лимит. 
        Попросите Manager'а ввести PIN-код.
      </p>
      <Input
        type="password"
        maxLength={4}
        placeholder="PIN Manager'а"
        value={managerPin}
        onChange={...}
      />
    </AlertDescription>
  </Alert>
)}
```

**Backend Validation:**

```typescript
if (checkAmount > MAX_CHECK) {
  const valid = await verifyManagerPin(restaurantId, managerPin);
  if (!valid) throw new Error('Invalid PIN');
  
  await logActivity({
    type: 'MANAGER_APPROVAL',
    reason: 'High check amount',
    checkAmount
  });
}
```


***

### **Вопрос 25: Terminal Assignment - как привязать кассира к терминалу?**

**Принятое решение:** Manual selection при login + Device fingerprint для auto-detection

**Обоснование:**

- Manual selection - при первом входе кассир выбирает терминал из списка (Касса 1, Касса 2, etc)
- Device fingerprint - браузер запоминает терминал (FingerprintJS), при следующем входе auto-select
- Override option - кассир может сменить терминал если работает с другой кассы (button в header)
- Admin visibility - в Activity Log показывается terminal name и location
- Multiple terminals - Admin создаёт терминалы в настройках (name + location)

**UI Terminal Selection (при login):**

- Modal с карточками терминалов
- Terminal card: icon + name + location
- Click to select
- Selected state (border-primary, checkmark)
- Button "Продолжить"

**Device Fingerprint:**

```typescript
import FingerprintJS from '@fingerprintjs/fingerprintjs';

async function getFingerprint() {
  const fp = await FingerprintJS.load();
  const result = await fp.get();
  return result.visitorId; // unique device ID
}

// Auto-detect terminal
const fingerprint = await getFingerprint();
const savedTerminal = localStorage.getItem(`terminal_${fingerprint}`);

if (savedTerminal) {
  setSelectedTerminal(JSON.parse(savedTerminal));
} else {
  setShowTerminalSelection(true);
}
```

**Terminal Info в Header:**

```tsx
<div className="flex items-center gap-2">
  <Monitor className="h-4 w-4 text-secondary" />
  <span className="text-secondary">Терминал:</span>
  <Badge variant="outline">{currentTerminal.name}</Badge>
  <Button variant="ghost" size="sm" onClick={changeTerminal}>
    <RefreshCw className="h-3 w-3" />
  </Button>
</div>
```


***

# ✅ **ИТОГО: 25 РЕШЕНИЙ CASHIER POS INTERFACE ПРИНЯТЫ!**


***

## **📦 КРАТКОЕ РЕЗЮМЕ**

### **Архитектура:**

- Отдельный роут `/cashier` (изолирован от Admin/Manager)
- Fullscreen mode для кассовых терминалов
- Touch-optimized UI (кнопки 80px+, шрифт 18px+)
- Code splitting (< 300KB bundle)
- Offline support (IndexedDB + sync queue)


### **Authentication:**

- PIN-код (4 цифры, numpad UI)
- Fallback email/password
- Terminal selection с auto-detection
- Auto-logout через 15 минут бездействия


### **Core Features:**

- Fast search (debounced 200ms, barcode scanner)
- Split screen Guest Quick View
- Calculator UI для earn/redeem
- Minimal register form (phone + name)
- Thermal printer integration (ESC/POS)
- Recent guests widget (last 10)
- Quick stats (гостей | транзакций | баллов)


### **Permissions:**

- ✅ Поиск, просмотр, начисление/списание по чеку, регистрация
- ❌ Ручная корректировка, удаление, аналитика, export


### **Security:**

- Activity logging (все действия)
- Fraud detection (anomaly alerts)
- Manager approval (high amounts > 20K₽)
- Terminal tracking (device fingerprint)
- Auto-logout (15 min inactivity)


### **Performance:**

- Bundle < 300KB gzipped
- Time to Interactive < 2s
- Service Worker caching
- Lazy loading modals
- Keyboard shortcuts (F1-F5, ESC)


### **Hardware:**

- Thermal printer (80mm, ESC/POS)
- Barcode scanner (keyboard wedge)
- Touch screen (large targets, no hover)

***

# 🚀 **ГОТОВ К СЛЕДУЮЩЕМУ БЛОКУ!**

