
**–ö–∞–∫–æ–π –±–ª–æ–∫ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–ª–µ–µ?**

1. **Frontend (–¥–µ—Ç–∞–ª–∏ UI/UX –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤)**
2. **POS Integration (—Ñ–∏–Ω–∞–ª—å–Ω—ã–µ JSON-—Å—Ö–µ–º—ã webhooks iiko/R-Keeper)**
3. **Notifications System (Email/SMS/Push –ª–æ–≥–∏–∫–∞)**
4. **Testing Strategy (Unit/Integration/E2E)**
5. **Deployment \& CI/CD**
6. **–ù–æ–≤—ã–π –±–ª–æ–∫** (–Ω–∞–∑–æ–≤–∏ —Å–≤–æ–π)

**–°–∫–∞–∂–∏ –Ω–æ–º–µ—Ä –∏–ª–∏ —Å–≤–æ—ë –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ!** üöÄ
<span style="display:none">[^1_1][^1_2][^1_3][^1_4][^1_5][^1_6][^1_7][^1_8][^1_9]</span>

<div align="center">‚ÅÇ</div>

[^1_1]: Beseda-9.md

[^1_2]: Beseda-8.md

[^1_3]: Beseda-7.md

[^1_4]: Beseda-6.md

[^1_5]: Beseda-5.md

[^1_6]: Beseda-4.md

[^1_7]: Beseda-3.md

[^1_8]: Beseda-2.md

[^1_9]: Beseda-1.md


---

# Frontend (–¥–µ—Ç–∞–ª–∏ UI/UX –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤) –¥–µ–ª–∞–µ–º. –ó–∞–¥–∞–π 30+ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ + —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ —Ç–≤–æ–µ–º—É –ª—É—á—à–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ –¥–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö. –ü–µ—Ä–µ–¥ –∑–∞–¥–∞–≤–∞–Ω–∏–µ–º –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–≤–µ—Ä—å—Å—è —Å —Ñ–∞–π–ª–∞–º–∏, –º–æ–∂–µ—Ç –æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ –∏–ª–∏ –æ—Ç–≤–µ—Ç —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å.

–û—Ç–ª–∏—á–Ω–æ! –Ø —Å–≤–µ—Ä–∏–ª—Å—è —Å —Ñ–∞–π–ª–∞–º–∏. –í–∏–∂—É, —á—Ç–æ –≤ **–ë–µ—Å–µ–¥–µ 8** —É–∂–µ —Ä–µ—à–µ–Ω—ã –±–∞–∑–æ–≤—ã–µ tech stack –≤–æ–ø—Ä–æ—Å—ã (Next.js, shadcn/ui, Zustand, TanStack Query –∏ —Ç.–¥.) –∏ –æ–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞. –¢–µ–ø–µ—Ä—å –∑–∞–¥–∞–º **30+ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ UX/UI –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º, —Ñ–ª–æ—É –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —ç–∫—Ä–∞–Ω–∞–º**, –∫–æ—Ç–æ—Ä—ã–µ –µ—â—ë –ù–ï –±—ã–ª–∏ —Ä–µ—à–µ–Ω—ã.

***

# üé® **FRONTEND UI/UX: 35 –î–ï–¢–ê–õ–¨–ù–´–• –í–û–ü–†–û–°–û–í**

## **üì± 1. RESPONSIVE \& MOBILE UX (6 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **1. –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (< 768px)**

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ –ë–µ—Å–µ–¥—ã 8:** Bottom tabs –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
**–í–û–ü–†–û–°:** –ö–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª–µ–π?

- **A)** Hamburger menu (drawer —Å–ª–µ–≤–∞) + bottom tabs –¥–ª—è –≥–ª–∞–≤–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ (Dashboard, Guests, Loyalty, Analytics)
- **B)** –¢–æ–ª—å–∫–æ bottom tabs (4-5 –∏–∫–æ–Ω–æ–∫) + "More" –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
- **C)** Fullscreen overlay menu —Å –∫—Ä—É–ø–Ω—ã–º–∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ —Ä–∞–∑–¥–µ–ª–æ–≤
- **D)** –ö–æ–º–±–æ: Top hamburger + bottom tabs –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) Hamburger + bottom tabs**

- Hamburger (—Å–ª–µ–≤–∞ –≤–≤–µ—Ä—Ö—É) ‚Üí –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–∞–∑–¥–µ–ª–æ–≤ —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π
- Bottom tabs: `[Dashboard, Guests, Analytics, More]` (4 –∏–∫–æ–Ω–∫–∏)
- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ: –ø—Ä–∏–≤—ã—á–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω, –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ä–∞–∑–¥–µ–ª–∞–º, —ç–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞

***

### **2. Breakpoints —Å—Ç—Ä–∞—Ç–µ–≥–∏—è**

**–í–û–ü–†–û–°:** –ö–∞–∫–∏–µ breakpoints –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏?

- **A)** Mobile: < 640px, Tablet: 640-1024px, Desktop: > 1024px
- **B)** sm: 640px, md: 768px, lg: 1024px, xl: 1280px, 2xl: 1536px (Tailwind default)
- **C)** Mobile: < 768px, Tablet: 768-1200px, Desktop: > 1200px
- **D)** –ö–∞—Å—Ç–æ–º–Ω—ã–µ: xs: 480px, sm: 640px, md: 768px, lg: 1024px, xl: 1280px, 2xl: 1600px

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Tailwind default breakpoints**

```typescript
// tailwind.config.ts
screens: {
  sm: '640px',  // Mobile landscape
  md: '768px',  // Tablets
  lg: '1024px', // Desktop
  xl: '1280px', // Large desktop
  '2xl': '1536px' // Ultra-wide
}
```

- Sidebar: hidden –Ω–∞ sm/md, mini –Ω–∞ lg, full –Ω–∞ xl+
- Tables: scroll –Ω–∞ sm/md, full –Ω–∞ lg+
- Charts: stack –Ω–∞ sm, grid –Ω–∞ md+

***

### **3. –¢–∞–±–ª–∏—Ü—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö**

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:** TanStack Table v8
**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö (Guests, Transactions, Analytics)?

- **A)** Horizontal scroll —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–µ—Ä–≤–æ–π –∫–æ–ª–æ–Ω–∫–æ–π (name/phone)
- **B)** –ö–∞—Ä—Ç–æ—á–∫–∏ –≤–º–µ—Å—Ç–æ —Ç–∞–±–ª–∏—Ü (–∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = card)
- **C)** Accordion cards (tap to expand –¥–ª—è –¥–µ—Ç–∞–ª–µ–π)
- **D)** –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ 2-3 –≥–ª–∞–≤–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ + actions)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **C) Accordion cards –Ω–∞ mobile**

```tsx
// Mobile: Accordion Cards
<GuestCard>
  <CardHeader onClick={toggleExpand}>
    <Avatar />
    <Name>–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤</Name>
    <Balance>+2,450 ‚ÇΩ</Balance>
    <ChevronDown />
  </CardHeader>
  {expanded && (
    <CardContent>
      <Row label="–¢–µ–ª–µ—Ñ–æ–Ω" value="+7 999 123 45 67" />
      <Row label="–£—Ä–æ–≤–µ–Ω—å" value="Silver" />
      <Row label="–í–∏–∑–∏—Ç—ã" value="12" />
      <Row label="–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç" value="2 –¥–Ω—è –Ω–∞–∑–∞–¥" />
      <Actions /> {/* Edit, Adjust, Block */}
    </CardContent>
  )}
</GuestCard>

// Desktop: TanStack Table (–∫–∞–∫ –≤ –ë–µ—Å–µ–¥–µ 8)
```

- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ: —á–∏—Ç–∞–µ–º–æ—Å—Ç—å, –Ω–µ –Ω—É–∂–µ–Ω scroll, –ø—Ä–∏–≤—ã—á–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω

***

### **4. –§–æ—Ä–º—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö**

**–í–û–ü–†–û–°:** –ö–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã (Create Guest, Edit Loyalty Rule) –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö?

- **A)** –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π scroll (–≤—Å–µ –ø–æ–ª—è –ø–æ–¥—Ä—è–¥)
- **B)** Wizard —Å —à–∞–≥–∞–º–∏ (1 —à–∞–≥ = 3-4 –ø–æ–ª—è)
- **C)** Accordion sections (General Info, Contact, Loyalty Settings)
- **D)** Bottom Sheet —Å –ø–æ—à–∞–≥–æ–≤—ã–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Wizard –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Ñ–æ—Ä–º, A) –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö**

```tsx
// –°–ª–æ–∂–Ω–∞—è —Ñ–æ—Ä–º–∞ (Create Loyalty Rule):
<WizardForm steps={['Type', 'Conditions', 'Reward', 'Settings']}>
  // Mobile: progress bar + —Ç–µ–∫—É—â–∏–π —à–∞–≥
  // Desktop: –≤—Å–µ —à–∞–≥–∏ –≤–∏–¥–Ω—ã —Å–ª–µ–≤–∞ (stepper)
</WizardForm>

// –ü—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º–∞ (Quick Add Guest):
<Form> {/* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π scroll, –≤—Å–µ –ø–æ–ª—è */}
  <Input label="–ò–º—è" />
  <Input label="–¢–µ–ª–µ—Ñ–æ–Ω" />
  <DatePicker label="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è" />
  <Button>–°–æ–∑–¥–∞—Ç—å</Button>
</Form>
```


***

### **5. –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (Edit Guest, Manual Adjustment) –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö?

- **A)** Full-screen modal (–∑–∞–Ω–∏–º–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω)
- **B)** Bottom Sheet (–≤—ã–µ–∑–∂–∞–µ—Ç —Å–Ω–∏–∑—É –Ω–∞ 70-90% —ç–∫—Ä–∞–Ω–∞)
- **C)** Centered modal (—É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π, –Ω–æ —Å backdrop)
- **D)** Slide-from-right (–∫–∞–∫ drawer)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Bottom Sheet**

```tsx
// shadcn/ui <Sheet> –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
<Sheet>
  <SheetTrigger>Edit Guest</SheetTrigger>
  <SheetContent side="bottom" className="h-[90vh]">
    <SheetHeader>
      <SheetTitle>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Å—Ç—è</SheetTitle>
    </SheetHeader>
    <Form /> {/* React Hook Form */}
    <SheetFooter>
      <Button variant="outline">–û—Ç–º–µ–Ω–∞</Button>
      <Button>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</Button>
    </SheetFooter>
  </SheetContent>
</Sheet>
```

- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ: –Ω–∞—Ç–∏–≤–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω iOS/Android, –ª–µ–≥–∫–æ –∑–∞–∫—Ä—ã—Ç—å —Å–≤–∞–π–ø–æ–º –≤–Ω–∏–∑

***

### **6. Charts –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö**

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:** Recharts
**–í–û–ü–†–û–°:** –ö–∞–∫ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞—à–±–æ—Ä–¥—ã —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö?

- **A)** –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫ (1 chart = full width)
- **B)** Horizontal scroll (charts –≤ –∫–∞—Ä—É—Å–µ–ª–∏)
- **C)** –£–ø—Ä–æ—â—ë–Ω–Ω—ã–µ —á–∞—Ä—Ç—ã (–º–µ–Ω—å—à–µ –¥–∞–Ω–Ω—ã—Ö, –∫—Ä—É–ø–Ω–µ–µ —à—Ä–∏—Ñ—Ç—ã)
- **D)** Tabs (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ —á–∞—Ä—Ç–∞–º–∏)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫ + —É–ø—Ä–æ—â–µ–Ω–∏–µ**

```tsx
// Mobile:
<DashboardMobile>
  <MetricCard title="MRR" value="‚ÇΩ450,000" change="+12%" />
  <MetricCard title="Churn" value="3.2%" change="-0.5%" />
  <LineChart data={revenue} height={250} simplified /> {/* –ú–µ–Ω—å—à–µ labels */}
  <PieChart data={planDistribution} height={300} />
</DashboardMobile>

// Desktop: grid layout (2 columns)
```

- Recharts responsive: `<ResponsiveContainer width="100%" height={250}>`

***

## **üé® 2. UI PATTERNS \& STATES (8 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **7. Empty States**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—É—Å—Ç—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–Ω–µ—Ç –≥–æ—Å—Ç–µ–π, –Ω–µ—Ç –ø—Ä–∞–≤–∏–ª –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏)?

- **A)** –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç + –∫–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ –≥–æ—Å—Ç—è"
- **B)** –ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è + –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –æ–ø–∏—Å–∞–Ω–∏–µ + CTA –∫–Ω–æ–ø–∫–∞
- **C)** Onboarding card —Å —à–∞–≥–∞–º–∏ ("–î–æ–±–∞–≤—å—Ç–µ –≥–æ—Å—Ç—è ‚Üí –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–æ ‚Üí ...")
- **D)** Placeholder —Ç–∞–±–ª–∏—Ü–∞ —Å –æ–¥–Ω–æ–π —Å–µ—Ä–æ–π —Å—Ç—Ä–æ–∫–æ–π + "+"

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) –ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è + CTA**

```tsx
<EmptyState>
  <EmptyStateIcon icon={UsersIcon} /> {/* Lucide icon –∏–ª–∏ custom SVG */}
  <EmptyStateTitle>–ì–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</EmptyStateTitle>
  <EmptyStateDescription>
    –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –≥–æ—Å—Ç—è —á–µ—Ä–µ–∑ –∫–∞—Å—Å—É, —Å—Å—ã–ª–∫—É –∏–ª–∏ Telegram –±–æ—Ç
  </EmptyStateDescription>
  <Button onClick={openCreateModal}>
    <PlusIcon /> –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Å—Ç—è
  </Button>
</EmptyState>
```

- –ò—Å–ø–æ–ª—å–∑—É–µ–º lucide-react –∏–∫–æ–Ω–∫–∏ (—É–∂–µ –≤ stack –∏–∑ –ë–µ—Å–µ–¥—ã 8)
- –í–∏–∑—É–∞–ª—å–Ω–æ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ, –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

***

### **8. Loading States**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö (—Ç–∞–±–ª–∏—Ü—ã, –¥–∞—à–±–æ—Ä–¥—ã, —Ñ–æ—Ä–º—ã)?

- **A)** Fullscreen spinner (–≤–µ—Å—å —ç–∫—Ä–∞–Ω)
- **B)** Skeleton screens (–∫–æ–Ω—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã/–∫–∞—Ä—Ç–æ—á–µ–∫)
- **C)** Linear progress bar (–≤–≤–µ—Ä—Ö—É —ç–∫—Ä–∞–Ω–∞)
- **D)** Inline spinners (–≤ –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ/—Ç–∞–±–ª–∏—Ü–µ)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Skeleton screens + C) Linear progress**

```tsx
// shadcn/ui Skeleton –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
<GuestsTableSkeleton>
  {[...Array(5)].map((_, i) => (
    <TableRow key={i}>
      <TableCell><Skeleton className="h-10 w-10 rounded-full" /></TableCell>
      <TableCell><Skeleton className="h-4 w-[150px]" /></TableCell>
      <TableCell><Skeleton className="h-4 w-[100px]" /></TableCell>
      <TableCell><Skeleton className="h-4 w-[80px]" /></TableCell>
    </TableRow>
  ))}
</GuestsTableSkeleton>

// + nprogress –¥–ª—è navigation (top linear bar)
```

```
- TanStack Query: `isLoading ? <Skeleton /> : <Table data={data} />`
```

- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –Ω–µ—Ç "–ø—Ä—ã–∂–∫–æ–≤" layout

***

### **9. Error States**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ (failed API calls, network errors)?

- **A)** Toast notification (–ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª)
- **B)** Alert banner (–≤–≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å)
- **C)** Inline error (–ø–æ–¥ —Ñ–æ—Ä–º–æ–π/—Ç–∞–±–ª–∏—Ü–µ–π)
- **D)** Error boundary —Å fullscreen message

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **–ö–æ–º–±–æ –≤—Å–µ—Ö –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞**

```tsx
// 1. Network errors / API failures ‚Üí Toast (sonner)
toast.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–æ—Å—Ç–µ–π', {
  action: { label: '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å', onClick: () => refetch() }
})

// 2. Form validation errors ‚Üí Inline –ø–æ–¥ –ø–æ–ª–µ–º
<FormMessage>–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å +7</FormMessage>

// 3. Critical errors (500, auth) ‚Üí Alert Banner
<Alert variant="destructive">
  <AlertCircle className="h-4 w-4" />
  <AlertTitle>–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</AlertTitle>
  <AlertDescription>
    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É
  </AlertDescription>
</Alert>

// 4. React Error Boundary ‚Üí Fullscreen —Å –∫–Ω–æ–ø–∫–æ–π "Report Bug"
```


***

### **10. Success States**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–≥–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω, –ø—Ä–∞–≤–∏–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ)?

- **A)** Toast notification (–∑–µ–ª—ë–Ω—ã–π, 3-4 —Å–µ–∫)
- **B)** Inline success message (–ø–æ–¥ —Ñ–æ—Ä–º–æ–π)
- **C)** Modal "Success!" —Å –≥–∞–ª–æ—á–∫–æ–π (–∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 2 —Å–µ–∫)
- **D)** –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è (–Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ —Å highlight)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) Toast + D) Highlight –∞–Ω–∏–º–∞—Ü–∏—è**

```tsx
// 1. Toast (sonner)
toast.success('–ì–æ—Å—Ç—å –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ —Å–æ–∑–¥–∞–Ω', {
  description: '–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞',
  duration: 3000
})

// 2. Highlight new row in table
const [highlightedId, setHighlightedId] = useState<string | null>(null)

// –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≥–æ—Å—Ç—è:
setHighlightedId(newGuest.id)
setTimeout(() => setHighlightedId(null), 2000) // Remove highlight after 2s

// –í —Ç–∞–±–ª–∏—Ü–µ:
<TableRow className={highlightedId === guest.id ? 'animate-highlight' : ''}>
```

- `animate-highlight`: fade green ‚Üí white (Tailwind animation)

***

### **11. Optimistic Updates**

**–í–û–ü–†–û–°:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ optimistic updates (UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –î–û –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞)?

- **A)** –î–∞, –¥–ª—è –≤—Å–µ—Ö –º—É—Ç–∞—Ü–∏–π (create, update, delete)
- **B)** –¢–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (toggle status, increment counter)
- **C)** –ù–µ—Ç, –≤—Å–µ–≥–¥–∞ –∂–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
- **D)** –î–∞, –Ω–æ —Å rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ + toast "Undo"

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Optimistic + rollback + undo**

```tsx
// TanStack Query useMutation
const blockGuest = useMutation({
  mutationFn: (guestId: string) => api.guests.block(guestId),
  onMutate: async (guestId) => {
    // Optimistic update
    await queryClient.cancelQueries({ queryKey: ['guests'] })
    const previous = queryClient.getQueryData(['guests'])
    
    queryClient.setQueryData(['guests'], (old) => 
      old.map(g => g.id === guestId ? { ...g, status: 'BLOCKED' } : g)
    )
    
    return { previous } // Context –¥–ª—è rollback
  },
  onError: (err, guestId, context) => {
    // Rollback
    queryClient.setQueryData(['guests'], context.previous)
    toast.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Å—Ç—è', {
      action: { label: '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å', onClick: () => blockGuest.mutate(guestId) }
    })
  },
  onSuccess: () => {
    toast.success('–ì–æ—Å—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω')
  }
})
```

- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ: –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–ª–∏–∫ UI, –Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ (rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ)

***

### **12. Disabled States (Permissions)**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (Cashier –Ω–µ –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å Analytics)?

- **A)** –°–∫—Ä—ã–≤–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã/–∫–Ω–æ–ø–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é
- **B)** –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å, –Ω–æ disabled + tooltip "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞"
- **C)** –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å –∑–∞–º–∫–æ–º üîí + modal "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ Admin"
- **D)** –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å blur/opacity + upgrade prompt (–¥–ª—è Free —Ç–∞—Ä–∏—Ñ–∞)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **–ö–æ–º–±–æ B) –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π, A) –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤**

```tsx
// –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –≤ sidebar
{hasPermission('view_analytics') && (
  <SidebarItem href="/analytics" icon={ChartIcon}>
    Analytics
  </SidebarItem>
)}

// –ù–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º disabled –∫–Ω–æ–ø–∫–∏ —Å tooltip
<Tooltip>
  <TooltipTrigger asChild>
    <Button disabled={!hasPermission('manual_adjust')}>
      –†—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
    </Button>
  </TooltipTrigger>
  <TooltipContent>
    –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
  </TooltipContent>
</Tooltip>

// –î–ª—è —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (Free ‚Üí Standard):
<FeatureCard locked={currentPlan === 'FREE'}>
  <LockIcon />
  <Title>–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</Title>
  <Button onClick={openUpgradeModal}>Upgrade to Standard</Button>
</FeatureCard>
```


***

### **13. Confirmation Dialogs**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å –æ–ø–∞—Å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (—É–¥–∞–ª–∏—Ç—å –≥–æ—Å—Ç—è, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É)?

- **A)** AlertDialog —Å "–í—ã —É–≤–µ—Ä–µ–Ω—ã?" + –û—Ç–º–µ–Ω–∞/–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
- **B)** –î–≤–æ–π–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (–∫–ª–∏–∫ ‚Üí modal ‚Üí –≤–≤–µ—Å—Ç–∏ "DELETE" ‚Üí confirm)
- **C)** Toast —Å Undo (–¥–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å—Ä–∞–∑—É, –Ω–æ –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å 5 —Å–µ–∫)
- **D)** Checkbox "–Ø –ø–æ–Ω–∏–º–∞—é –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è" + Confirm button

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) –¥–ª—è –æ–±—ã—á–Ω—ã—Ö, B) –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö**

```tsx
// –û–±—ã—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (Delete Rule):
<AlertDialog>
  <AlertDialogTrigger>–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ</AlertDialogTrigger>
  <AlertDialogContent>
    <AlertDialogTitle>–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏?</AlertDialogTitle>
    <AlertDialogDescription>
      –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ü—Ä–∞–≤–∏–ª–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –Ω–∞–≤—Å–µ–≥–¥–∞.
    </AlertDialogDescription>
    <AlertDialogFooter>
      <AlertDialogCancel>–û—Ç–º–µ–Ω–∞</AlertDialogCancel>
      <AlertDialogAction onClick={deleteRule} variant="destructive">
        –£–¥–∞–ª–∏—Ç—å
      </AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>

// –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ (Delete Tenant / Wipe all data):
<AlertDialog>
  <AlertDialogContent>
    <AlertDialogTitle>–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞?</AlertDialogTitle>
    <AlertDialogDescription>
      –í—Å–µ –¥–∞–Ω–Ω—ã–µ (–≥–æ—Å—Ç–∏, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –ø—Ä–∞–≤–∏–ª–∞) –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –ë–ï–ó–í–û–ó–í–†–ê–¢–ù–û.
      –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:
    </AlertDialogDescription>
    <Input
      placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞"
      value={confirmText}
      onChange={(e) => setConfirmText(e.target.value)}
    />
    <AlertDialogFooter>
      <AlertDialogCancel>–û—Ç–º–µ–Ω–∞</AlertDialogCancel>
      <AlertDialogAction
        disabled={confirmText !== restaurant.name}
        variant="destructive"
      >
        –£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞
      </AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```


***

### **14. Bulk Actions UI**

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ –ë–µ—Å–µ–¥—ã 8:** Bulk actions –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö
**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å bulk actions (–≤—ã–±—Ä–∞–Ω–æ 15 –≥–æ—Å—Ç–µ–π ‚Üí –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ—Ö)?

- **A)** Top bar –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–µ–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ (floating)
- **B)** Sticky header —Å –∫–Ω–æ–ø–∫–∞–º–∏ (Block, Export, Assign Segment)
- **C)** Bottom bar —Å –∫–Ω–æ–ø–∫–∞–º–∏ (mobile-friendly)
- **D)** Context menu (right-click –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Sticky top bar (desktop), C) Bottom bar (mobile)**

```tsx
// TanStack Table row selection
const [rowSelection, setRowSelection] = useState({})
const selectedCount = Object.keys(rowSelection).length

{selectedCount > 0 && (
  <BulkActionsBar className="sticky top-0 z-10">
    <span>{selectedCount} –≤—ã–±—Ä–∞–Ω–æ</span>
    <div className="flex gap-2">
      <Button variant="outline" size="sm">
        <Download /> –≠–∫—Å–ø–æ—Ä—Ç
      </Button>
      <Button variant="outline" size="sm">
        <Tag /> –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–µ–≥–º–µ–Ω—Ç
      </Button>
      <Button variant="destructive" size="sm">
        <Ban /> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
      </Button>
    </div>
    <Button variant="ghost" size="sm" onClick={() => setRowSelection({})}>
      –û—Ç–º–µ–Ω–∏—Ç—å
    </Button>
  </BulkActionsBar>
)}

// Mobile: bottom fixed bar
<BulkActionsBarMobile className="fixed bottom-0 left-0 right-0 safe-area-inset">
  {/* Same buttons */}
</BulkActionsBarMobile>
```


***

## **üöÄ 3. NAVIGATION \& FLOW (6 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **15. Breadcrumbs –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è**

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ –ë–µ—Å–µ–¥—ã 8:** Breadcrumbs –≤ top navbar
**–í–û–ü–†–û–°:** –ö–∞–∫ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å breadcrumbs –∏ –¥–µ–ª–∞—Ç—å –∏—Ö –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏?

- **A)** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ URL (`/guests/123/edit` ‚Üí Dashboard / Guests / –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ / Edit)
- **B)** –í—Ä—É—á–Ω—É—é –ø—Ä–æ–ø–∏—Å—ã–≤–∞—Ç—å –≤ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
- **C)** Dynamic –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∏–º—è –≥–æ—Å—Ç—è –ø–æ ID –∏–∑ API)
- **D)** Breadcrumbs + dropdown –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–æ—Å–µ–¥–Ω–∏–º —Ä–∞–∑–¥–µ–ª–∞–º

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **C) Dynamic + D) Dropdown –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏**

```tsx
// components/ui/breadcrumbs.tsx
import { useQuery } from '@tanstack/react-query'
import { useParams } from 'next/navigation'

const Breadcrumbs = () => {
  const params = useParams()
  const { data: guest } = useQuery({
    queryKey: ['guest', params.guestId],
    queryFn: () => api.guests.get(params.guestId),
    enabled: !!params.guestId
  })
  
  return (
    <BreadcrumbsContainer>
      <BreadcrumbItem href="/dashboard">Dashboard</BreadcrumbItem>
      <BreadcrumbSeparator />
      <BreadcrumbDropdown>
        <BreadcrumbItem>Guests</BreadcrumbItem>
        <DropdownMenu>
          <DropdownMenuItem href="/loyalty">Loyalty</DropdownMenuItem>
          <DropdownMenuItem href="/analytics">Analytics</DropdownMenuItem>
        </DropdownMenu>
      </BreadcrumbDropdown>
      {guest && (
        <>
          <BreadcrumbSeparator />
          <BreadcrumbItem>{guest.name}</BreadcrumbItem>
        </>
      )}
    </BreadcrumbsContainer>
  )
}
```

- Dynamic labels (–ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∏–º—è –≥–æ—Å—Ç—è/–ø—Ä–∞–≤–∏–ª–∞ –∏–∑ TanStack Query cache)
- Dropdown –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏

***

### **16. Global Search (CMDK) –¥–µ—Ç–∞–ª–∏**

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ –ë–µ—Å–µ–¥—ã 8:** Global Search —Å CMDK
**–í–û–ü–†–û–°:** –ß—Ç–æ –∏—Å–∫–∞—Ç—å —á–µ—Ä–µ–∑ Global Search –∏ –∫–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?

- **A)** –¢–æ–ª—å–∫–æ –≥–æ—Å—Ç–µ–π (–ø–æ –∏–º–µ–Ω–∏/—Ç–µ–ª–µ—Ñ–æ–Ω—É)
- **B)** –ì–æ—Å—Ç–∏ + –ü—Ä–∞–≤–∏–ª–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ + –ü—Ä–æ–º–æ + –†–µ—Å—Ç–æ—Ä–∞–Ω—ã
- **C)** –í—Å—ë –≤—ã—à–µ + Actions ("–°–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç—è", "–≠–∫—Å–ø–æ—Ä—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏")
- **D)** –í—Å—ë –≤—ã—à–µ + Recent searches + Keyboard shortcuts

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø–æ–∏—Å–∫ (–≥–æ—Å—Ç–∏, —Ä–∞–∑–¥–µ–ª—ã, actions, shortcuts)**

```tsx
// cmdk –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (shadcn/ui)
<CommandDialog open={open} onOpenChange={setOpen}>
  <CommandInput placeholder="–ü–æ–∏—Å–∫ –≥–æ—Å—Ç–µ–π, —Ä–∞–∑–¥–µ–ª–æ–≤, –¥–µ–π—Å—Ç–≤–∏–π..." />
  <CommandList>
    <CommandEmpty>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</CommandEmpty>
    
    {/* Recent */}
    <CommandGroup heading="–ù–µ–¥–∞–≤–Ω–∏–µ">
      <CommandItem>–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤</CommandItem>
      <CommandItem>Analytics Dashboard</CommandItem>
    </CommandGroup>
    
    {/* Guests */}
    <CommandGroup heading="–ì–æ—Å—Ç–∏">
      {guests.map(g => (
        <CommandItem key={g.id} onSelect={() => router.push(`/guests/${g.id}`)}>
          <User className="mr-2 h-4 w-4" />
          <span>{g.name}</span>
          <CommandShortcut>{g.phone}</CommandShortcut>
        </CommandItem>
      ))}
    </CommandGroup>
    
    {/* Quick Actions */}
    <CommandGroup heading="–î–µ–π—Å—Ç–≤–∏—è">
      <CommandItem onSelect={() => openCreateGuestModal()}>
        <Plus className="mr-2 h-4 w-4" />
        –°–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç—è
      </CommandItem>
      <CommandItem onSelect={() => router.push('/loyalty/rules/create')}>
        <Sparkles className="mr-2 h-4 w-4" />
        –ù–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
      </CommandItem>
    </CommandGroup>
    
    {/* Keyboard Shortcuts */}
    <CommandGroup heading="–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏">
      <CommandItem>
        <Keyboard className="mr-2 h-4 w-4" />
        –û—Ç–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫
        <CommandShortcut>‚åòK</CommandShortcut>
      </CommandItem>
    </CommandGroup>
  </CommandList>
</CommandDialog>

// Trigger: Cmd+K / Ctrl+K
useEffect(() => {
  const down = (e: KeyboardEvent) => {
    if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
      e.preventDefault()
      setOpen(true)
    }
  }
  document.addEventListener('keydown', down)
  return () => document.removeEventListener('keydown', down)
}, [])
```

- **Recent searches** —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ localStorage
- **Fuzzy search** (fuse.js –¥–ª—è –Ω–µ—á—ë—Ç–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞)

***

### **17. Sidebar —Å–æ—Å—Ç–æ—è–Ω–∏—è (expanded/mini/hidden)**

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ –ë–µ—Å–µ–¥—ã 8:** Collapsible sidebar (250px / 60px mini / hidden)
**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è sidebar –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ?

- **A)** Toggle button (–≥–∞–º–±—É—Ä–≥–µ—Ä –≤–≤–µ—Ä—Ö—É sidebar) + auto-collapse –Ω–∞ mobile
- **B)** Hover –¥–ª—è mini ‚Üí temporary expand (–∫–∞–∫ VS Code)
- **C)** –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage
- **D)** Responsive auto: hidden –Ω–∞ sm/md, mini –Ω–∞ lg, expanded –Ω–∞ xl+

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **–ö–æ–º–±–æ A + B + C + D**

```tsx
// Zustand store
interface UIStore {
  sidebarState: 'expanded' | 'mini' | 'hidden'
  setSidebarState: (state) => void
}

const useUIStore = create<UIStore>((set) => ({
  sidebarState: 
    (localStorage.getItem('sidebarState') as any) || 
    (window.innerWidth < 1024 ? 'hidden' : 'expanded'),
  setSidebarState: (state) => {
    localStorage.setItem('sidebarState', state)
    set({ sidebarState: state })
  }
}))

// Sidebar –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
<Sidebar
  className={cn(
    'transition-all duration-300',
    sidebarState === 'expanded' && 'w-[250px]',
    sidebarState === 'mini' && 'w-[60px]',
    sidebarState === 'hidden' && 'w-0'
  )}
  onMouseEnter={() => {
    if (sidebarState === 'mini') {
      setTempExpanded(true) // Temporary expand on hover
    }
  }}
  onMouseLeave={() => setTempExpanded(false)}
>
  <SidebarToggle onClick={toggleSidebar} />
  {/* ... nav items */}
</Sidebar>

// Responsive:
// < md: hidden (hamburger menu overlay)
// md-lg: mini (60px)
// > lg: expanded (250px)
```


***

### **18. Top Navbar sticky/scroll behaviour**

**–í–û–ü–†–û–°:** –ö–∞–∫ –≤–µ–¥—ë—Ç —Å–µ–±—è top navbar –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã?

- **A)** Always sticky (–≤—Å–µ–≥–¥–∞ –≤–≤–µ—Ä—Ö—É)
- **B)** Hide on scroll down, show on scroll up (–∫–∞–∫ YouTube)
- **C)** Sticky —Å —Ç–µ–Ω—å—é –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ > 0
- **D)** –ù–µ sticky (—Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **C) Sticky + shadow on scroll**

```tsx
const [isScrolled, setIsScrolled] = useState(false)

useEffect(() => {
  const handleScroll = () => {
    setIsScrolled(window.scrollY > 10)
  }
  window.addEventListener('scroll', handleScroll)
  return () => window.removeEventListener('scroll', handleScroll)
}, [])

<TopNavbar
  className={cn(
    'sticky top-0 z-50 transition-shadow',
    isScrolled && 'shadow-md'
  )}
>
  <Breadcrumbs />
  <GlobalSearch />
  <Notifications />
  <UserMenu />
</TopNavbar>
```

- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ: –≤–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ, –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è

***

### **19. Page transitions**

**–í–û–ü–†–û–°:** –ê–Ω–∏–º–∏—Ä–æ–≤–∞—Ç—å –ª–∏ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏?

- **A)** –ù–µ—Ç –∞–Ω–∏–º–∞—Ü–∏–π (instant)
- **B)** Fade in/out (opacity transition)
- **C)** Slide transitions (–∫–∞–∫ mobile apps)
- **D)** Skeleton ‚Üí Content (–∑–∞–≥—Ä—É–∂–∞–µ–º skeleton, –ø–æ—Ç–æ–º –ø–ª–∞–≤–Ω–æ fade in –∫–æ–Ω—Ç–µ–Ω—Ç)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Skeleton ‚Üí Fade in content**

```tsx
// Next.js 14 App Router + Suspense
import { Suspense } from 'react'

export default function GuestsPage() {
  return (
    <Suspense fallback={<GuestsTableSkeleton />}>
      <GuestsTable /> {/* Server Component –∏–ª–∏ client —Å useQuery */}
    </Suspense>
  )
}

// + nprogress –¥–ª—è navigation bar (top linear progress)
import NProgress from 'nprogress'
import { useRouter } from 'next/navigation'

useEffect(() => {
  Router.events.on('routeChangeStart', () => NProgress.start())
  Router.events.on('routeChangeComplete', () => NProgress.done())
  Router.events.on('routeChangeError', () => NProgress.done())
}, [])
```

- –ù–µ—Ç —Ä–µ–∑–∫–∏—Ö "–ø—Ä—ã–∂–∫–æ–≤", –ø–ª–∞–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

***

### **20. Impersonation UI –¥–ª—è Owner**

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ –ë–µ—Å–µ–¥—ã 8:** Impersonation flow –¥–ª—è Owner
**–í–û–ü–†–û–°:** –ö–∞–∫ –≤–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å, —á—Ç–æ Owner –∑–∞—à—ë–ª –≤ –∞–∫–∫–∞—É–Ω—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ (impersonation mode)?

- **A)** Top banner "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ [Restaurant Name]" + Exit button
- **B)** –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ navbar/sidebar (–∫—Ä–∞—Å–Ω—ã–π/–æ—Ä–∞–Ω–∂–µ–≤—ã–π)
- **C)** Floating badge –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
- **D)** Avatar border (–∫—Ä–∞—Å–Ω–∞—è —Ä–∞–º–∫–∞ –≤–æ–∫—Ä—É–≥ –∞–≤–∞—Ç–∞—Ä–∞ Owner)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) Top banner + B) –¶–≤–µ—Ç accent**

```tsx
{isImpersonating && (
  <ImpersonationBanner className="bg-orange-500 text-white">
    <AlertTriangle className="h-4 w-4" />
    <span>
      –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ <strong>{impersonatedTenant.name}</strong>
    </span>
    <Button
      variant="outline"
      size="sm"
      onClick={exitImpersonation}
      className="ml-auto"
    >
      –í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    </Button>
  </ImpersonationBanner>
)}

// + –∏–∑–º–µ–Ω–µ–Ω–∏–µ accent —Ü–≤–µ—Ç–∞ –≤ Tailwind
<html className={isImpersonating ? 'theme-impersonation' : ''}>
  {/* CSS: .theme-impersonation { --primary: orange; } */}
</html>
```

- –û—á–µ–≤–∏–¥–Ω–æ, —á—Ç–æ Owner –≤ —á—É–∂–æ–º –∞–∫–∫–∞—É–Ω—Ç–µ
- –õ–µ–≥–∫–æ –≤—ã–π—Ç–∏ –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º

***

## **üéØ 4. LOYALTY BUILDER (5 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **21. Rules Builder: Drag \& Drop Priority**

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ –ë–µ—Å–µ–¥—ã 8:** Priority drag-drop
**–í–û–ü–†–û–°:** –ö–∞–∫—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è drag \& drop –ø—Ä–∞–≤–∏–ª (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞)?

- **A)** dnd-kit (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è, lightweight, touch-friendly)
- **B)** react-beautiful-dnd (–ø–æ–ø—É–ª—è—Ä–Ω–∞—è, –Ω–æ deprecated)
- **C)** react-dnd (–º–æ—â–Ω–∞—è, –Ω–æ —Å–ª–æ–∂–Ω–∞—è)
- **D)** –°–≤–æ—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ HTML5 Drag \& Drop API

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) dnd-kit**

```tsx
import { DndContext, closestCenter, DragEndEvent } from '@dnd-kit/core'
import { SortableContext, useSortable, verticalListSortingStrategy } from '@dnd-kit/sortable'

const RulesList = ({ rules, onReorder }) => {
  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event
    if (active.id !== over?.id) {
      const oldIndex = rules.findIndex(r => r.id === active.id)
      const newIndex = rules.findIndex(r => r.id === over.id)
      onReorder(arrayMove(rules, oldIndex, newIndex))
    }
  }
  
  return (
    <DndContext collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
      <SortableContext items={rules.map(r => r.id)} strategy={verticalListSortingStrategy}>
        {rules.map((rule, index) => (
          <SortableRuleItem key={rule.id} rule={rule} priority={index + 1} />
        ))}
      </SortableContext>
    </DndContext>
  )
}

const SortableRuleItem = ({ rule, priority }) => {
  const { attributes, listeners, setNodeRef, transform, transition } = useSortable({ id: rule.id })
  
  return (
    <Card
      ref={setNodeRef}
      style={{ transform: CSS.Transform.toString(transform), transition }}
    >
      <CardHeader>
        <div className="flex items-center gap-3">
          <GripVertical {...attributes} {...listeners} className="cursor-grab" />
          <Badge>{priority}</Badge>
          <CardTitle>{rule.name}</CardTitle>
        </div>
      </CardHeader>
    </Card>
  )
}
```

- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ dnd-kit: TypeScript, accessibility, touch support, small bundle

***

### **22. Conditions Builder: Tag-based UI**

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ –ë–µ—Å–µ–¥—ã 8:** Tag-based conditions
**–í–û–ü–†–û–°:** –ö–∞–∫ —Å—Ç—Ä–æ–∏—Ç—å —Å–ª–æ–∂–Ω—ã–µ —É—Å–ª–æ–≤–∏—è (check amount > 5000 AND weekday = Friday OR level = Gold)?

- **A)** –í–∏–∑—É–∞–ª—å–Ω—ã–π query builder (–∫–∞–∫ Notion database filters)
- **B)** Tag pills —Å dropdown (+ Add condition ‚Üí –≤—ã–±–∏—Ä–∞–µ–º field ‚Üí operator ‚Üí value)
- **C)** JSON editor –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö (—Å preview –≤ visual mode)
- **D)** Natural language input ("—Å—É–º–º–∞ —á–µ–∫–∞ –±–æ–ª—å—à–µ 5000 –≤ –ø—è—Ç–Ω–∏—Ü—É")

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Tag pills + visual builder**

```tsx
<ConditionsBuilder>
  <ConditionGroup operator="AND">
    <ConditionTag>
      <Select value="checkAmount" onChange={...}>
        <option>–°—É–º–º–∞ —á–µ–∫–∞</option>
        <option>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</option>
        <option>–£—Ä–æ–≤–µ–Ω—å</option>
      </Select>
      <Select value="greaterThan">
        <option>&gt;</option>
        <option>&gt;=</option>
        <option>=</option>
      </Select>
      <Input type="number" value={5000} />
      <Button variant="ghost" size="sm"><X /></Button> {/* Remove */}
    </ConditionTag>
    
    <ConditionTag operator="OR" indent>
      <Badge variant="secondary">–ò–õ–ò</Badge>
      {/* ... */}
    </ConditionTag>
    
    <Button variant="outline" size="sm">
      <Plus /> –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–∏–µ
    </Button>
  </ConditionGroup>
  
  {/* Live Preview */}
  <ConditionsPreview>
    <CodeBlock language="json">
      {JSON.stringify(conditions, null, 2)}
    </CodeBlock>
  </ConditionsPreview>
</ConditionsBuilder>
```

- –í–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–Ω—è—Ç–Ω–æ, –ª–µ–≥–∫–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
- Advanced users –º–æ–≥—É—Ç –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –≤ JSON mode

***

### **23. Levels Builder: Visual Timeline**

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ –ë–µ—Å–µ–¥—ã 8:** Visual timeline –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω–µ–π (Bronze ‚Üí Silver ‚Üí Gold)?

- **A)** Horizontal timeline —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ —É—Ä–æ–≤–Ω–µ–π
- **B)** –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞–º–∏ –º–µ–∂–¥—É —É—Ä–æ–≤–Ω—è–º–∏
- **C)** Interactive chart (threshold amounts –Ω–∞ –æ—Å–∏ X)
- **D)** Kanban-style columns (–∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å = –∫–æ–ª–æ–Ω–∫–∞)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) Horizontal timeline (desktop), B) Vertical (mobile)**

```tsx
<LevelsTimeline>
  {levels.map((level, index) => (
    <>
      <LevelCard key={level.id} level={level}>
        <LevelIcon color={level.color} emoji={level.icon} />
        <LevelName>{level.name}</LevelName>
        <LevelThreshold>–æ—Ç {formatCurrency(level.thresholdAmount)}</LevelThreshold>
        <LevelBenefit>{level.earnPercentage}% –±–∞–ª–ª–æ–≤</LevelBenefit>
        <EditButton onClick={() => openEditModal(level)} />
      </LevelCard>
      
      {index < levels.length - 1 && (
        <TimelineConnector>
          <ArrowRight />
        </TimelineConnector>
      )}
    </>
  ))}
  
  <AddLevelButton onClick={openCreateModal}>
    <Plus /> –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å
  </AddLevelButton>
</LevelsTimeline>

// Guest View (progress bar):
<LevelProgressBar currentLevel="Silver" progress={65} nextLevel="Gold">
  {/* 65% –¥–æ Gold (–µ—â–µ 52,500‚ÇΩ) */}
</LevelProgressBar>
```


***

### **24. Promo Builder: Wizard vs Single Page**

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ –ë–µ—Å–µ–¥—ã 8:** Wizard-style –¥–ª—è –ø—Ä–æ–º–æ
**–í–û–ü–†–û–°:** Wizard (4 —à–∞–≥–∞) –∏–ª–∏ Single Page —Å sections –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–æ?

- **A)** Wizard (Type ‚Üí Trigger ‚Üí Reward ‚Üí Settings) —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º
- **B)** Single page —Å anchor navigation (scroll to section)
- **C)** Accordion sections (collapse/expand –∫–∞–∂–¥—É—é —Å–µ–∫—Ü–∏—é)
- **D)** Tabs (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–±—ã –≤–≤–µ—Ä—Ö—É)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) Wizard (–∫–∞–∫ –≤ –ë–µ—Å–µ–¥–µ 8 - —É–∂–µ —Ö–æ—Ä–æ—à–æ)**

```tsx
// –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –ë–µ—Å–µ–¥–µ 8, –Ω–æ –¥–æ–±–∞–≤–∏–º:
// - Save as Draft (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ –Ω–∞ –ª—é–±–æ–º —à–∞–≥–µ)
// - Preview –ø—Ä–æ–º–æ –≤ right panel (–∫–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –¥–ª—è –≥–æ—Å—Ç—è)

<PromoWizard steps={['–¢–∏–ø', '–¢—Ä–∏–≥–≥–µ—Ä', '–ù–∞–≥—Ä–∞–¥–∞', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏']}>
  <WizardProgress currentStep={2} totalSteps={4} />
  
  <WizardContent>
    <WizardStep>{/* –¢–µ–∫—É—â–∏–π —à–∞–≥ */}</WizardStep>
    
    {/* Live Preview (sticky right panel) */}
    <WizardPreview>
      <MobileFrame>
        <TelegramMiniApp>
          <NotificationCard promo={formData} />
        </TelegramMiniApp>
      </MobileFrame>
    </WizardPreview>
  </WizardContent>
  
  <WizardFooter>
    <Button variant="outline" onClick={saveAsDraft}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫</Button>
    <Button onClick={nextStep}>–î–∞–ª–µ–µ</Button>
  </WizardFooter>
</PromoWizard>
```


***

### **25. Loyalty Card Design Preview**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å preview –¥–∏–∑–∞–π–Ω–∞ –∫–∞—Ä—Ç—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (–ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–æ–Ω–∞/–ª–æ–≥–æ)?

- **A)** Static image preview (PNG/JPG –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä)
- **B)** Live iframe —Å —Ä–µ–∞–ª—å–Ω—ã–º Telegram Mini App
- **C)** React component preview (render –∫–∞—Ä—Ç—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ)
- **D)** Split screen: —Å–ª–µ–≤–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Å–ø—Ä–∞–≤–∞ live preview

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Split screen —Å live preview**

```tsx
<CardDesigner>
  <DesignerPanel>
    <Section title="–§–æ–Ω –∫–∞—Ä—Ç—ã">
      <BackgroundPicker
        presets={presetBackgrounds}
        onSelect={setBackground}
        onUpload={uploadCustomBackground}
      />
    </Section>
    
    <Section title="–õ–æ–≥–æ—Ç–∏–ø">
      <LogoUploader onUpload={setLogo} />
    </Section>
    
    <Section title="–¶–≤–µ—Ç–∞ —É—Ä–æ–≤–Ω–µ–π">
      <ColorPicker level="Bronze" color={colors.bronze} onChange={...} />
      <ColorPicker level="Silver" color={colors.silver} onChange={...} />
    </Section>
  </DesignerPanel>
  
  <PreviewPanel>
    <DeviceFrame device="iphone">
      <LoyaltyCardPreview
        background={background}
        logo={logo}
        colors={colors}
        guestData={mockGuest} // Mock data –¥–ª—è –¥–µ–º–æ
      />
    </DeviceFrame>
    
    <ToggleButtons>
      <Button variant={device === 'iphone' ? 'default' : 'outline'}>iPhone</Button>
      <Button variant={device === 'android' ? 'default' : 'outline'}>Android</Button>
    </ToggleButtons>
  </PreviewPanel>
</CardDesigner>
```

- Real-time preview –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É iPhone/Android preview

***

## **üìä 5. DASHBOARDS \& ANALYTICS (5 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **26. Dashboard Layout: Grid System**

**–í–û–ü–†–û–°:** –ö–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –≤–∏–¥–∂–µ—Ç—ã –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ (Owner, Admin, Manager)?

- **A)** –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π layout (2 columns –Ω–∞ desktop, stack –Ω–∞ mobile)
- **B)** Draggable widgets (react-grid-layout, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ä–∞—Å—Å—Ç–∞–≤–ª—è–µ—Ç)
- **C)** Responsive CSS Grid (auto-fit columns)
- **D)** Tabs (Overview, Revenue, Guests, Loyalty)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π grid + C) Responsive**

```tsx
<Dashboard>
  <DashboardGrid className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
    {/* Metric Cards (1 row, 3 cols on xl) */}
    <MetricCard title="MRR" value="‚ÇΩ450,000" change="+12%" />
    <MetricCard title="Active Tenants" value="127" change="+8" />
    <MetricCard title="Churn Rate" value="3.2%" change="-0.5%" trend="down" />
    
    {/* Charts (2 cols on xl) */}
    <Card className="col-span-1 md:col-span-2">
      <CardHeader>
        <CardTitle>–í—ã—Ä—É—á–∫–∞ –∑–∞ 30 –¥–Ω–µ–π</CardTitle>
      </CardHeader>
      <CardContent>
        <LineChart data={revenueData} />
      </CardContent>
    </Card>
    
    <Card>
      <CardHeader>
        <CardTitle>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤</CardTitle>
      </CardHeader>
      <CardContent>
        <PieChart data={planDistribution} />
      </CardContent>
    </Card>
    
    {/* Table (full width) */}
    <Card className="col-span-1 md:col-span-2 xl:col-span-3">
      <CardHeader>
        <CardTitle>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</CardTitle>
      </CardHeader>
      <CardContent>
        <RecentTransactionsTable />
      </CardContent>
    </Card>
  </DashboardGrid>
</Dashboard>
```

- –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –±—ã—Å—Ç—Ä—ã–π —Ä–µ–Ω–¥–µ—Ä
- Responsive (auto-stack –Ω–∞ mobile)
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å react-grid-layout –≤ Phase 2 –¥–ª—è customization

***

### **27. Charts Interactivity**

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:** Recharts
**–í–û–ü–†–û–°:** –ö–∞–∫—É—é –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–∏—Ç—å –∫ –≥—Ä–∞—Ñ–∏–∫–∞–º?

- **A)** Tooltip on hover (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
- **B)** Click on data point ‚Üí drill-down (modal —Å –¥–µ—Ç–∞–ª—è–º–∏)
- **C)** Zoom/Pan (–∫–∞–∫ Google Analytics)
- **D)** Export chart as PNG/SVG

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) Tooltip + B) Drill-down + D) Export**

```tsx
<RechartsLineChart data={revenueData}>
  <Tooltip
    content={({ active, payload }) => {
      if (active && payload?.length) {
        return (
          <TooltipCard>
            <TooltipTitle>{payload[^2_0].payload.date}</TooltipTitle>
            <TooltipValue>‚ÇΩ{formatCurrency(payload[^2_0].value)}</TooltipValue>
            <TooltipAction onClick={() => openDrillDown(payload[^2_0].payload)}>
              –ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí
            </TooltipAction>
          </TooltipCard>
        )
      }
      return null
    }}
  />
  <Line
    dataKey="revenue"
    stroke="hsl(var(--primary))"
    strokeWidth={2}
    dot={{ r: 4 }}
    activeDot={{ r: 6, onClick: (data) => openDrillDown(data.payload) }}
  />
</RechartsLineChart>

// Export chart
<Button variant="outline" size="sm" onClick={exportChartAsPNG}>
  <Download /> –≠–∫—Å–ø–æ—Ä—Ç PNG
</Button>
```

- Zoom/Pan –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ `<Brush>` –∫–æ–º–ø–æ–Ω–µ–Ω—Ç Recharts

***

### **28. Drill-down: Modal vs Page**

**–í–û–ü–†–û–°:** –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —á–∞—Ä—Ç/–º–µ—Ç—Ä–∏–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Churn Rate 3.2%") –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –∏–ª–∏ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ?

- **A)** Modal (overlay —Å —Ç–∞–±–ª–∏—Ü–µ–π —É—à–µ–¥—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤)
- **B)** Drawer (side panel —Å–ø—Ä–∞–≤–∞)
- **C)** –ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (`/analytics/churn`)
- **D)** Expand in place (accordion —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ–¥ –º–µ—Ç—Ä–∏–∫–æ–π)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Drawer (desktop), A) Modal fullscreen (mobile)**

```tsx
<MetricCard onClick={() => setDrillDownOpen(true)}>
  <MetricTitle>Churn Rate</MetricTitle>
  <MetricValue>3.2%</MetricValue>
  <MetricTrend>-0.5% –∑–∞ –º–µ—Å—è—Ü</MetricTrend>
</MetricCard>

<Sheet open={drillDownOpen} onOpenChange={setDrillDownOpen}>
  <SheetContent side="right" className="w-[600px]">
    <SheetHeader>
      <SheetTitle>Churn Analysis</SheetTitle>
      <SheetDescription>
        –†–µ—Å—Ç–æ—Ä–∞–Ω—ã, –æ—Ç–º–µ–Ω–∏–≤—à–∏–µ –ø–æ–¥–ø–∏—Å–∫—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
      </SheetDescription>
    </SheetHeader>
    
    <SheetBody>
      <LineChart data={churnOverTime} height={200} />
      
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>–†–µ—Å—Ç–æ—Ä–∞–Ω</TableHead>
            <TableHead>–î–∞—Ç–∞ –æ—Ç–º–µ–Ω—ã</TableHead>
            <TableHead>–ü—Ä–∏—á–∏–Ω–∞</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {churnedTenants.map(t => (
            <TableRow key={t.id}>
              <TableCell>{t.name}</TableCell>
              <TableCell>{format(t.cancelledAt, 'dd.MM.yyyy')}</TableCell>
              <TableCell>{t.reason}</TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </SheetBody>
    
    <SheetFooter>
      <Button variant="outline" onClick={exportCSV}>–≠–∫—Å–ø–æ—Ä—Ç CSV</Button>
    </SheetFooter>
  </SheetContent>
</Sheet>
```

- Drawer —É–¥–æ–±–µ–Ω: –Ω–µ —Ç–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∞—à–±–æ—Ä–¥–∞, –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –∑–∞–∫—Ä—ã—Ç—å

***

### **29. Date Range Picker UX**

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ –ë–µ—Å–µ–¥—ã 8:** React Day Picker + date-fns
**–í–û–ü–†–û–°:** –ö–∞–∫ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (Last 7 days, This month, Custom)?

- **A)** Dropdown —Å presets + custom range picker
- **B)** Buttons –¥–ª—è presets (7d, 30d, 90d, All time) + datepicker icon
- **C)** Inline calendar (–≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç)
- **D)** Natural language input ("last week", "january 2026")

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) Dropdown —Å presets (–∫–∞–∫ –≤ –ë–µ—Å–µ–¥–µ 8, —Ö–æ—Ä–æ—à–æ)**

```tsx
// –î–æ–±–∞–≤–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ last selected range –≤ localStorage + quick toggle
<DateRangePicker>
  <PopoverTrigger asChild>
    <Button variant="outline">
      <Calendar className="mr-2 h-4 w-4" />
      {selectedRange ? (
        `${format(selectedRange.from, 'dd MMM')} - ${format(selectedRange.to, 'dd MMM')}`
      ) : (
        '–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥'
      )}
    </Button>
  </PopoverTrigger>
  
  <PopoverContent align="end" className="w-auto p-0">
    <div className="flex">
      {/* Presets */}
      <div className="border-r p-3">
        <PresetButton onClick={() => setRange(last7Days())}>
          –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
        </PresetButton>
        <PresetButton onClick={() => setRange(last30Days())}>
          –ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
        </PresetButton>
        <PresetButton onClick={() => setRange(thisMonth())}>
          –≠—Ç–æ—Ç –º–µ—Å—è—Ü
        </PresetButton>
        <PresetButton onClick={() => setRange(lastMonth())}>
          –ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
        </PresetButton>
        <PresetButton onClick={() => setRange(thisYear())}>
          –≠—Ç–æ—Ç –≥–æ–¥
        </PresetButton>
      </div>
      
      {/* Calendar */}
      <DayPicker
        mode="range"
        selected={selectedRange}
        onSelect={setSelectedRange}
        numberOfMonths={2}
        locale={ru}
      />
    </div>
    
    <div className="border-t p-3 flex justify-between">
      <Button variant="outline" onClick={reset}>–°–±—Ä–æ—Å–∏—Ç—å</Button>
      <Button onClick={applyRange}>–ü—Ä–∏–º–µ–Ω–∏—Ç—å</Button>
    </div>
  </PopoverContent>
</DateRangePicker>

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
useEffect(() => {
  localStorage.setItem('lastDateRange', JSON.stringify(selectedRange))
}, [selectedRange])
```


***

### **30. Export Flow (CSV/Excel/PDF)**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ (—Ç–∞–±–ª–∏—Ü—ã, –æ—Ç—á—ë—Ç—ã)?

- **A)** –ö–Ω–æ–ø–∫–∞ "–≠–∫—Å–ø–æ—Ä—Ç" ‚Üí dropdown (CSV, Excel, PDF) ‚Üí instant download
- **B)** Modal —Å preview + –≤—ã–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫ + download
- **C)** Background job (—ç–∫—Å–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ email –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö)
- **D)** API endpoint (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ) + download link

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Modal —Å preview –¥–ª—è –º–∞–ª—ã—Ö, C) Email –¥–ª—è –±–æ–ª—å—à–∏—Ö**

```tsx
<Button onClick={() => setExportModalOpen(true)}>
  <Download /> –≠–∫—Å–ø–æ—Ä—Ç
</Button>

<Dialog open={exportModalOpen} onOpenChange={setExportModalOpen}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</DialogTitle>
      <DialogDescription>
        –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
      </DialogDescription>
    </DialogHeader>
    
    <DialogBody>
      {/* Format */}
      <RadioGroup value={format} onValueChange={setFormat}>
        <RadioGroupItem value="csv">CSV</RadioGroupItem>
        <RadioGroupItem value="xlsx">Excel (XLSX)</RadioGroupItem>
        <RadioGroupItem value="pdf">PDF</RadioGroupItem>
      </RadioGroup>
      
      {/* Column selection */}
      <Label>–ö–æ–ª–æ–Ω–∫–∏:</Label>
      <div className="grid grid-cols-2 gap-2">
        {columns.map(col => (
          <Checkbox
            key={col.id}
            checked={selectedColumns.includes(col.id)}
            onCheckedChange={(checked) => toggleColumn(col.id, checked)}
          >
            {col.label}
          </Checkbox>
        ))}
      </div>
      
      {/* Preview (first 10 rows) */}
      {format !== 'pdf' && (
        <div>
          <Label>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–ø–µ—Ä–≤—ã–µ 10 –∑–∞–ø–∏—Å–µ–π):</Label>
          <PreviewTable data={data.slice(0, 10)} columns={selectedColumns} />
        </div>
      )}
    </DialogBody>
    
    <DialogFooter>
      <Button variant="outline" onClick={close}>–û—Ç–º–µ–Ω–∞</Button>
      <Button onClick={handleExport} disabled={isExporting}>
        {isExporting ? '–≠–∫—Å–ø–æ—Ä—Ç...' : '–°–∫–∞—á–∞—Ç—å'}
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>

// –î–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö (> 10,000 rows):
if (data.length > 10000) {
  // Backend job
  const job = await api.exports.create({ format, columns })
  toast.success('–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–ø—É—â–µ–Ω. –°—Å—ã–ª–∫–∞ –ø—Ä–∏–¥—ë—Ç –Ω–∞ email —á–µ—Ä–µ–∑ 5-10 –º–∏–Ω—É—Ç.')
} else {
  // Client-side export (xlsx, papaparse –¥–ª—è CSV)
  downloadFile(data, format)
}
```


***

## **‚öôÔ∏è 6. SETTINGS \& CONFIGURATION (5 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **31. Restaurant Settings: Tabs vs Sidebar**

**–í–û–ü–†–û–°:** –ö–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ (General, Loyalty, Billing, Team, Integrations)?

- **A)** Horizontal tabs –≤–≤–µ—Ä—Ö—É
- **B)** Vertical sidebar —Å–ª–µ–≤–∞ (–∫–∞–∫ Gmail Settings)
- **C)** Accordion sections (–≤—Å–µ –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ)
- **D)** Separate pages (–∫–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª = –æ—Ç–¥–µ–ª—å–Ω—ã–π URL)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Vertical sidebar (desktop), A) Tabs (mobile)**

```tsx
<SettingsLayout>
  <SettingsSidebar>
    <SidebarItem href="/settings/general" icon={Settings}>
      –û—Å–Ω–æ–≤–Ω—ã–µ
    </SidebarItem>
    <SidebarItem href="/settings/loyalty" icon={Gift}>
      –õ–æ—è–ª—å–Ω–æ—Å—Ç—å
    </SidebarItem>
    <SidebarItem href="/settings/billing" icon={CreditCard}>
      –ü–æ–¥–ø–∏—Å–∫–∞ –∏ –æ–ø–ª–∞—Ç–∞
    </SidebarItem>
    <SidebarItem href="/settings/team" icon={Users}>
      –ö–æ–º–∞–Ω–¥–∞
    </SidebarItem>
    <SidebarItem href="/settings/integrations" icon={Plug}>
      –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (POS, Telegram)
    </SidebarItem>
  </SettingsSidebar>
  
  <SettingsContent>
    {children} {/* –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */}
  </SettingsContent>
</SettingsLayout>

// Mobile: Tabs
<Tabs value={activeTab} onValueChange={setActiveTab}>
  <TabsList>
    <TabsTrigger value="general">–û—Å–Ω–æ–≤–Ω—ã–µ</TabsTrigger>
    <TabsTrigger value="loyalty">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</TabsTrigger>
    <TabsTrigger value="billing">–û–ø–ª–∞—Ç–∞</TabsTrigger>
  </TabsList>
  <TabsContent value="general">{/* ... */}</TabsContent>
</Tabs>
```


***

### **32. Unsaved Changes Warning**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å –æ –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Ñ–æ—Ä–º—É –∏ –ø—ã—Ç–∞–µ—Ç—Å—è —É–π—Ç–∏)?

- **A)** Browser confirm dialog ("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
- **B)** Custom modal —Å –∫–Ω–æ–ø–∫–∞–º–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "–ù–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å", "–û—Ç–º–µ–Ω–∞"
- **C)** Toast notification "–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è" + floating "Save" button
- **D)** Auto-save (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Custom modal + D) Auto-save –¥–ª—è draft**

```tsx
// React Hook Form + Next.js router
const form = useForm()
const router = useRouter()
const [showUnsavedModal, setShowUnsavedModal] = useState(false)
const [nextPath, setNextPath] = useState<string | null>(null)

useEffect(() => {
  const handleRouteChange = (url: string) => {
    if (form.formState.isDirty) {
      setNextPath(url)
      setShowUnsavedModal(true)
      router.events.emit('routeChangeError')
      throw 'Route change aborted by user' // Prevent navigation
    }
  }
  
  router.events.on('routeChangeStart', handleRouteChange)
  return () => router.events.off('routeChangeStart', handleRouteChange)
}, [form.formState.isDirty])

<AlertDialog open={showUnsavedModal} onOpenChange={setShowUnsavedModal}>
  <AlertDialogContent>
    <AlertDialogTitle>–ù–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</AlertDialogTitle>
    <AlertDialogDescription>
      –£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?
    </AlertDialogDescription>
    <AlertDialogFooter>
      <AlertDialogCancel>–û—Å—Ç–∞—Ç—å—Å—è</AlertDialogCancel>
      <Button
        variant="outline"
        onClick={() => {
          setShowUnsavedModal(false)
          router.push(nextPath!)
        }}
      >
        –ù–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å
      </Button>
      <Button
        onClick={async () => {
          await form.handleSubmit(onSubmit)()
          setShowUnsavedModal(false)
          router.push(nextPath!)
        }}
      >
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
      </Button>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>

// Auto-save draft (–¥–ª—è loyalty rules, promo)
useEffect(() => {
  const timer = setInterval(() => {
    if (form.formState.isDirty) {
      saveDraft(form.getValues())
    }
  }, 5000) // Auto-save every 5s
  
  return () => clearInterval(timer)
}, [form.formState.isDirty])
```


***

### **33. Activity Log: Filters \& Search**

**–í–û–ü–†–û–°:** –ö–∞–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å Activity Log (User, Action Type, Date Range)?

- **A)** Filters –≤ sidebar (checkboxes –¥–ª—è action types, user dropdown, date range)
- **B)** Top bar —Å inline filters (dropdowns + search input)
- **C)** Advanced filters modal (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ –∫–Ω–æ–ø–∫–µ "–§–∏–ª—å—Ç—Ä—ã")
- **D)** Tag-based filters (–¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥–∏, –∫–∞–∫ Gmail labels)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Top bar inline filters + C) Advanced modal**

```tsx
<ActivityLogPage>
  <ActivityLogFilters>
    {/* Quick filters */}
    <Select value={actionType} onValueChange={setActionType}>
      <SelectTrigger>–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è</SelectTrigger>
      <SelectContent>
        <SelectItem value="all">–í—Å–µ</SelectItem>
        <SelectItem value="BALLS_EARNED">–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤</SelectItem>
        <SelectItem value="BALLS_REDEEMED">–°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤</SelectItem>
        <SelectItem value="GUEST_CREATED">–°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç—è</SelectItem>
      </SelectContent>
    </Select>
    
    <Select value={userId} onValueChange={setUserId}>
      <SelectTrigger>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</SelectTrigger>
      <SelectContent>
        {users.map(u => (
          <SelectItem key={u.id} value={u.id}>{u.name}</SelectItem>
        ))}
      </SelectContent>
    </Select>
    
    <DateRangePicker value={dateRange} onChange={setDateRange} />
    
    <Button variant="outline" onClick={() => setAdvancedFiltersOpen(true)}>
      <Filter /> –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    </Button>
    
    <Button variant="ghost" onClick={resetFilters}>
      –°–±—Ä–æ—Å–∏—Ç—å
    </Button>
  </ActivityLogFilters>
  
  <ActivityLogTable data={filteredLogs} />
</ActivityLogPage>

// Advanced Filters Modal
<Dialog open={advancedFiltersOpen} onOpenChange={setAdvancedFiltersOpen}>
  <DialogContent>
    <DialogHeader>–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</DialogHeader>
    <DialogBody>
      <Label>IP-–∞–¥—Ä–µ—Å:</Label>
      <Input placeholder="192.168.1.1" />
      
      <Label>Device Type:</Label>
      <CheckboxGroup>
        <Checkbox>Desktop</Checkbox>
        <Checkbox>Mobile</Checkbox>
        <Checkbox>Tablet</Checkbox>
      </CheckboxGroup>
      
      <Label>–†–µ—Å—Ç–æ—Ä–∞–Ω (–¥–ª—è Owner):</Label>
      <Select>{/* ... */}</Select>
    </DialogBody>
    <DialogFooter>
      <Button onClick={applyAdvancedFilters}>–ü—Ä–∏–º–µ–Ω–∏—Ç—å</Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```


***

### **34. Team Management: Roles \& Permissions UI**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª–∏/–ø—Ä–∞–≤–∞ —á–ª–µ–Ω–æ–≤ –∫–æ–º–∞–Ω–¥—ã?

- **A)** Table —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏ (Name, Email, Role, Status) + Edit button ‚Üí modal
- **B)** Cards (–∫–∞–∂–¥—ã–π member = card —Å avatar, role badge, actions)
- **C)** Tree view (Admin ‚Üí Managers ‚Üí Cashiers)
- **D)** Kanban (–∫–æ–ª–æ–Ω–∫–∏ –ø–æ —Ä–æ–ª—è–º: Admin, Manager, Cashier)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) Table (desktop), B) Cards (mobile)**

```tsx
<TeamManagementPage>
  <PageHeader>
    <PageTitle>–ö–æ–º–∞–Ω–¥–∞</PageTitle>
    <Button onClick={() => setInviteModalOpen(true)}>
      <Plus /> –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å —á–ª–µ–Ω–∞
    </Button>
  </PageHeader>
  
  <TeamTable>
    <TableHeader>
      <TableRow>
        <TableHead>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</TableHead>
        <TableHead>–†–æ–ª—å</TableHead>
        <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
        <TableHead>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</TableHead>
        <TableHead>–î–µ–π—Å—Ç–≤–∏—è</TableHead>
      </TableRow>
    </TableHeader>
    <TableBody>
      {members.map(m => (
        <TableRow key={m.id}>
          <TableCell>
            <div className="flex items-center gap-3">
              <Avatar src={m.avatar} fallback={m.name[^2_0]} />
              <div>
                <div className="font-medium">{m.name}</div>
                <div className="text-sm text-muted-foreground">{m.email}</div>
              </div>
            </div>
          </TableCell>
          <TableCell>
            <Badge variant={getRoleBadgeVariant(m.role)}>
              {m.role}
            </Badge>
          </TableCell>
          <TableCell>
            <StatusBadge status={m.status} />
          </TableCell>
          <TableCell>{formatRelativeTime(m.lastLoginAt)}</TableCell>
          <TableCell>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" size="sm">
                  <MoreVertical className="h-4 w-4" />
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent>
                <DropdownMenuItem onClick={() => openEditModal(m)}>
                  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª—å
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => resetPassword(m)}>
                  –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å
                </DropdownMenuItem>
                <DropdownMenuSeparator />
                <DropdownMenuItem className="text-destructive">
                  –£–¥–∞–ª–∏—Ç—å
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </TableCell>
        </TableRow>
      ))}
    </TableBody>
  </TeamTable>
</TeamManagementPage>

// Edit Role Modal (dynamic permissions checkboxes)
<Dialog>
  <DialogContent>
    <DialogHeader>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª—å: {member.name}</DialogHeader>
    <DialogBody>
      <Select value={role} onValueChange={setRole}>
        <SelectItem value="MANAGER">Manager</SelectItem>
        <SelectItem value="CASHIER">Cashier</SelectItem>
      </Select>
      
      <Label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞:</Label>
      <div className="space-y-2">
        <Checkbox checked={permissions.viewAnalytics}>
          –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        </Checkbox>
        <Checkbox checked={permissions.manualAdjust}>
          –†—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
        </Checkbox>
        <Checkbox checked={permissions.exportData}>
          –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        </Checkbox>
      </div>
    </DialogBody>
    <DialogFooter>
      <Button onClick={saveRole}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```


***

### **35. Notifications Center**

**–í–û–ü–†–û–°:** –ì–¥–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (bell icon ‚Üí dropdown list)?

- **A)** Dropdown panel (max 5 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö + "View all" link)
- **B)** Dedicated page (`/notifications`)
- **C)** Slide-in panel (drawer —Å–ø—Ä–∞–≤–∞)
- **D)** Toast notifications —Ç–æ–ª—å–∫–æ (no persistent list)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) Dropdown panel + B) Full page –¥–ª—è –≤—Å–µ—Ö**

```tsx
<Popover>
  <PopoverTrigger asChild>
    <Button variant="ghost" size="icon" className="relative">
      <Bell className="h-5 w-5" />
      {unreadCount > 0 && (
        <Badge className="absolute -top-1 -right-1 h-5 w-5 rounded-full p-0 flex items-center justify-center">
          {unreadCount}
        </Badge>
      )}
    </Button>
  </PopoverTrigger>
  
  <PopoverContent align="end" className="w-[380px] p-0">
    <div className="flex items-center justify-between p-4 border-b">
      <h3 className="font-semibold">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
      {unreadCount > 0 && (
        <Button variant="ghost" size="sm" onClick={markAllAsRead}>
          –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏
        </Button>
      )}
    </div>
    
    <div className="max-h-[400px] overflow-y-auto">
      {notifications.slice(0, 5).map(n => (
        <NotificationItem
          key={n.id}
          notification={n}
          onClick={() => handleNotificationClick(n)}
        >
          <NotificationIcon type={n.type} />
          <div className="flex-1">
            <NotificationTitle>{n.title}</NotificationTitle>
            <NotificationDescription>{n.description}</NotificationDescription>
            <NotificationTime>{formatRelativeTime(n.createdAt)}</NotificationTime>
          </div>
          {!n.isRead && <UnreadDot />}
        </NotificationItem>
      ))}
    </div>
    
    <div className="p-2 border-t">
      <Button variant="ghost" className="w-full" asChild>
        <Link href="/notifications">–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</Link>
      </Button>
    </div>
  </PopoverContent>
</Popover>

// Full page: /notifications
<NotificationsPage>
  <NotificationsList>
    {notifications.map(n => (
      <NotificationCard key={n.id} notification={n} />
    ))}
  </NotificationsList>
</NotificationsPage>
```


***

## **‚úÖ –ò–¢–û–ì–û: 35 –î–ï–¢–ê–õ–¨–ù–´–• –í–û–ü–†–û–°–û–í**

| **–ö–∞—Ç–µ–≥–æ—Ä–∏—è** | **–í–æ–ø—Ä–æ—Å—ã** |
| :-- | :-- |
| 1. Responsive \& Mobile UX | 6 –≤–æ–ø—Ä–æ—Å–æ–≤ (\#1-6) |
| 2. UI Patterns \& States | 8 –≤–æ–ø—Ä–æ—Å–æ–≤ (\#7-14) |
| 3. Navigation \& Flow | 6 –≤–æ–ø—Ä–æ—Å–æ–≤ (\#15-20) |
| 4. Loyalty Builder | 5 –≤–æ–ø—Ä–æ—Å–æ–≤ (\#21-25) |
| 5. Dashboards \& Analytics | 5 –≤–æ–ø—Ä–æ—Å–æ–≤ (\#26-30) |
| 6. Settings \& Configuration | 5 –≤–æ–ø—Ä–æ—Å–æ–≤ (\#31-35) |


***

**–¢–µ–ø–µ—Ä—å —Ç–≤–æ—è –æ—á–µ—Ä–µ–¥—å!** üéØ

**–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –Ω–æ–º–µ—Ä–∞–º–∏:**

- –ù–∞–ø—Ä–∏–º–µ—Ä: `1A, 2B, 3C, 4A, 5B...` (–∏–ª–∏ —Å–∫–∞–∂–∏ "—Å–æ–≥–ª–∞—Å–µ–Ω —Å–æ –≤—Å–µ–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏")
- –ò–ª–∏ —É–∫–∞–∂–∏, –≥–¥–µ —Ö–æ—á–µ—à—å –¥—Ä—É–≥–æ–µ —Ä–µ—à–µ–Ω–∏–µ

**–ü–æ—Å–ª–µ —è –¥–∞–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å–≤–æ–¥–∫—É –≤—Å–µ—Ö UI/UX —Ä–µ—à–µ–Ω–∏–π –¥–ª—è Frontend! üöÄ**
<span style="display:none">[^2_1][^2_2][^2_3]</span>

<div align="center">‚ÅÇ</div>

[^2_1]: Beseda-8.md

[^2_2]: Beseda-9.md

[^2_3]: Beseda-3.md


---

# ‚úÖ **FRONTEND UI/UX: –ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø**

–í—Å–µ 35 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø—Ä–∏–Ω—è—Ç—ã! –í–æ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

***

## üì± **1. RESPONSIVE \& MOBILE UX**

### **1.1. –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Hamburger menu + Bottom tabs

```tsx
// Mobile Layout
<MobileLayout>
  <TopBar>
    <HamburgerButton /> {/* –û—Ç–∫—Ä—ã–≤–∞–µ—Ç fullscreen menu */}
    <Logo />
    <NotificationsBell />
  </TopBar>
  
  <Content>{children}</Content>
  
  <BottomTabs>
    <Tab icon={LayoutDashboard} label="Dashboard" href="/dashboard" />
    <Tab icon={Users} label="Guests" href="/guests" />
    <Tab icon={BarChart3} label="Analytics" href="/analytics" />
    <Tab icon={Menu} label="More" onClick={openMenu} />
  </BottomTabs>
</MobileLayout>
```


### **1.2. Breakpoints**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Tailwind default

- `sm: 640px` - Mobile landscape
- `md: 768px` - Tablets
- `lg: 1024px` - Desktop (sidebar mini)
- `xl: 1280px` - Large desktop (sidebar expanded)
- `2xl: 1536px` - Ultra-wide


### **1.3. –¢–∞–±–ª–∏—Ü—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Accordion Cards

```tsx
// Mobile: –ö–∞—Ä—Ç–æ—á–∫–∏ —Å —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ–º
<GuestCard expandable>
  <CardHeader>
    <Avatar name={guest.name} />
    <Name>{guest.name}</Name>
    <Balance>+{guest.balance} ‚ÇΩ</Balance>
    <ChevronDown />
  </CardHeader>
  <CardContent collapsed>
    <InfoRow label="–¢–µ–ª–µ—Ñ–æ–Ω" value={guest.phone} />
    <InfoRow label="–£—Ä–æ–≤–µ–Ω—å" value={guest.level} />
    <InfoRow label="–í–∏–∑–∏—Ç—ã" value={guest.visits} />
    <Actions>
      <ActionButton icon={Edit} />
      <ActionButton icon={Ban} />
    </Actions>
  </CardContent>
</GuestCard>

// Desktop: TanStack Table
<TanStackTable columns={columns} data={guests} />
```


### **1.4. –§–æ—Ä–º—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Wizard –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö, –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π scroll –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö

- –°–ª–æ–∂–Ω—ã–µ (Loyalty Rules, Promo): Wizard —Å —à–∞–≥–∞–º–∏
- –ü—Ä–æ—Å—Ç—ã–µ (Add Guest): –æ–±—ã—á–Ω–∞—è —Ñ–æ—Ä–º–∞ —Å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–º scroll


### **1.5. –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Bottom Sheet (shadcn/ui `<Sheet>`)

```tsx
<Sheet>
  <SheetContent side="bottom" className="h-[90vh]">
    <SheetHeader>
      <SheetTitle>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Å—Ç—è</SheetTitle>
    </SheetHeader>
    <Form>{/* ... */}</Form>
    <SheetFooter>
      <Button variant="outline">–û—Ç–º–µ–Ω–∞</Button>
      <Button>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</Button>
    </SheetFooter>
  </SheetContent>
</Sheet>
```


### **1.6. Charts –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫ + —É–ø—Ä–æ—â–µ–Ω–∏–µ

- Mobile: 1 chart –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É, –º–µ–Ω—å—à–µ labels
- Desktop: CSS Grid (2-3 columns)
- Recharts `<ResponsiveContainer width="100%" height={250}>`

***

## üé® **2. UI PATTERNS \& STATES**

### **2.1. Empty States**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** –ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è + CTA

```tsx
<EmptyState>
  <EmptyStateIcon icon={UsersIcon} />
  <EmptyStateTitle>–ì–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</EmptyStateTitle>
  <EmptyStateDescription>
    –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –≥–æ—Å—Ç—è —á–µ—Ä–µ–∑ –∫–∞—Å—Å—É, —Å—Å—ã–ª–∫—É –∏–ª–∏ Telegram –±–æ—Ç
  </EmptyStateDescription>
  <Button onClick={openCreateModal}>
    <PlusIcon /> –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Å—Ç—è
  </Button>
</EmptyState>
```


### **2.2. Loading States**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Skeleton screens + Linear progress (nprogress)

```tsx
// TanStack Query integration
{isLoading ? (
  <TableSkeleton rows={5} />
) : (
  <Table data={data} />
)}

// + nprogress –¥–ª—è navigation
import NProgress from 'nprogress'
Router.events.on('routeChangeStart', () => NProgress.start())
Router.events.on('routeChangeComplete', () => NProgress.done())
```


### **2.3. Error States**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** –ö–æ–º–±–æ –ø–æ–¥—Ö–æ–¥

- **Network errors / API failures** ‚Üí Toast (sonner)
- **Form validation** ‚Üí Inline –ø–æ–¥ –ø–æ–ª–µ–º
- **Critical errors (500)** ‚Üí Alert Banner –≤–≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- **React crashes** ‚Üí Error Boundary fullscreen

```tsx
// Toast –¥–ª—è API errors
toast.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–æ—Å—Ç–µ–π', {
  action: { label: '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å', onClick: () => refetch() }
})

// Inline –¥–ª—è —Ñ–æ—Ä–º
<FormMessage>–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å +7</FormMessage>

// Alert Banner –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö
<Alert variant="destructive">
  <AlertCircle />
  <AlertTitle>–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</AlertTitle>
  <AlertDescription>–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</AlertDescription>
</Alert>
```


### **2.4. Success States**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Toast + Highlight –∞–Ω–∏–º–∞—Ü–∏—è

```tsx
// Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
toast.success('–ì–æ—Å—Ç—å –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ —Å–æ–∑–¥–∞–Ω', {
  description: '–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞'
})

// + Highlight –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ (green fade ‚Üí white, 2 —Å–µ–∫)
<TableRow className={highlightedId === guest.id ? 'animate-highlight' : ''}>
```


### **2.5. Optimistic Updates**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Optimistic + rollback + undo

```tsx
const blockGuest = useMutation({
  onMutate: async (guestId) => {
    // Optimistic update UI
    queryClient.setQueryData(['guests'], (old) => 
      old.map(g => g.id === guestId ? { ...g, status: 'BLOCKED' } : g)
    )
    return { previous }
  },
  onError: (err, guestId, context) => {
    // Rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ
    queryClient.setQueryData(['guests'], context.previous)
    toast.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å', {
      action: { label: '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å', onClick: () => retry() }
    })
  }
})
```


### **2.6. Disabled States (Permissions)**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** –°–∫—Ä—ã–≤–∞—Ç—å —Ä–∞–∑–¥–µ–ª—ã, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å disabled –∫–Ω–æ–ø–∫–∏ —Å tooltip

```tsx
// –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã
{hasPermission('view_analytics') && (
  <SidebarItem href="/analytics">Analytics</SidebarItem>
)}

// Disabled –∫–Ω–æ–ø–∫–∏ —Å tooltip
<Tooltip>
  <TooltipTrigger>
    <Button disabled={!hasPermission('manual_adjust')}>
      –†—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
    </Button>
  </TooltipTrigger>
  <TooltipContent>–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ</TooltipContent>
</Tooltip>

// –î–ª—è —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
<FeatureCard locked={plan === 'FREE'}>
  <LockIcon />
  <Title>–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</Title>
  <Button onClick={openUpgradeModal}>Upgrade to Standard</Button>
</FeatureCard>
```


### **2.7. Confirmation Dialogs**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** AlertDialog –¥–ª—è –æ–±—ã—á–Ω—ã—Ö, –¥–≤–æ–π–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö

```tsx
// –û–±—ã—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
<AlertDialog>
  <AlertDialogTitle>–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏?</AlertDialogTitle>
  <AlertDialogDescription>
    –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å
  </AlertDialogDescription>
  <AlertDialogFooter>
    <AlertDialogCancel>–û—Ç–º–µ–Ω–∞</AlertDialogCancel>
    <AlertDialogAction variant="destructive">–£–¥–∞–ª–∏—Ç—å</AlertDialogAction>
  </AlertDialogFooter>
</AlertDialog>

// –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ (Delete Tenant)
<AlertDialog>
  <AlertDialogTitle>–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞?</AlertDialogTitle>
  <AlertDialogDescription>
    –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:
  </AlertDialogDescription>
  <Input
    placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
    value={confirmText}
    onChange={(e) => setConfirmText(e.target.value)}
  />
  <AlertDialogAction disabled={confirmText !== restaurant.name}>
    –£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞
  </AlertDialogAction>
</AlertDialog>
```


### **2.8. Bulk Actions UI**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Sticky top bar (desktop), bottom bar (mobile)

```tsx
{selectedCount > 0 && (
  <BulkActionsBar className="sticky top-0 z-10 bg-muted border-b">
    <span className="font-medium">{selectedCount} –≤—ã–±—Ä–∞–Ω–æ</span>
    <div className="flex gap-2">
      <Button variant="outline" size="sm">
        <Download /> –≠–∫—Å–ø–æ—Ä—Ç
      </Button>
      <Button variant="outline" size="sm">
        <Tag /> –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–µ–≥–º–µ–Ω—Ç
      </Button>
      <Button variant="destructive" size="sm">
        <Ban /> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
      </Button>
    </div>
    <Button variant="ghost" onClick={() => setRowSelection({})}>
      –û—Ç–º–µ–Ω–∏—Ç—å
    </Button>
  </BulkActionsBar>
)}
```


***

## üöÄ **3. NAVIGATION \& FLOW**

### **3.1. Breadcrumbs**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Dynamic (–ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∏–∑ API) + Dropdown –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

```tsx
const Breadcrumbs = () => {
  const { guestId } = useParams()
  const { data: guest } = useQuery({
    queryKey: ['guest', guestId],
    queryFn: () => api.guests.get(guestId),
    enabled: !!guestId
  })
  
  return (
    <BreadcrumbsContainer>
      <BreadcrumbItem href="/dashboard">Dashboard</BreadcrumbItem>
      <BreadcrumbSeparator />
      <BreadcrumbDropdown>
        <BreadcrumbItem>Guests</BreadcrumbItem>
        <DropdownMenu>
          <DropdownMenuItem href="/loyalty">Loyalty</DropdownMenuItem>
          <DropdownMenuItem href="/analytics">Analytics</DropdownMenuItem>
        </DropdownMenu>
      </BreadcrumbDropdown>
      {guest && (
        <>
          <BreadcrumbSeparator />
          <BreadcrumbItem>{guest.name}</BreadcrumbItem>
        </>
      )}
    </BreadcrumbsContainer>
  )
}
```


### **3.2. Global Search (CMDK)**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø–æ–∏—Å–∫ (–≥–æ—Å—Ç–∏, —Ä–∞–∑–¥–µ–ª—ã, actions, shortcuts)

```tsx
<CommandDialog open={open} onOpenChange={setOpen}>
  <CommandInput placeholder="–ü–æ–∏—Å–∫ –≥–æ—Å—Ç–µ–π, —Ä–∞–∑–¥–µ–ª–æ–≤, –¥–µ–π—Å—Ç–≤–∏–π..." />
  <CommandList>
    {/* Recent */}
    <CommandGroup heading="–ù–µ–¥–∞–≤–Ω–∏–µ">
      <CommandItem>–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤</CommandItem>
    </CommandGroup>
    
    {/* Guests */}
    <CommandGroup heading="–ì–æ—Å—Ç–∏">
      {guests.map(g => (
        <CommandItem onSelect={() => router.push(`/guests/${g.id}`)}>
          <User className="mr-2" />
          {g.name}
          <CommandShortcut>{g.phone}</CommandShortcut>
        </CommandItem>
      ))}
    </CommandGroup>
    
    {/* Quick Actions */}
    <CommandGroup heading="–î–µ–π—Å—Ç–≤–∏—è">
      <CommandItem onSelect={openCreateGuestModal}>
        <Plus className="mr-2" />
        –°–æ–∑–¥–∞—Ç—å –≥–æ—Å—Ç—è
      </CommandItem>
    </CommandGroup>
    
    {/* Shortcuts */}
    <CommandGroup heading="–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏">
      <CommandItem>
        –û—Ç–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫ <CommandShortcut>‚åòK</CommandShortcut>
      </CommandItem>
    </CommandGroup>
  </CommandList>
</CommandDialog>

// Trigger: Cmd+K / Ctrl+K
```


### **3.3. Sidebar —Å–æ—Å—Ç–æ—è–Ω–∏—è**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Expanded (250px) / Mini (60px) / Hidden + hover expand

```tsx
// Zustand store
const useUIStore = create((set) => ({
  sidebarState: 'expanded', // expanded | mini | hidden
  setSidebarState: (state) => {
    localStorage.setItem('sidebarState', state)
    set({ sidebarState: state })
  }
}))

// Responsive auto:
// < md: hidden (hamburger overlay)
// md-lg: mini (60px)
// > lg: expanded (250px)

// Hover to expand (mini ‚Üí temporary expanded)
<Sidebar
  onMouseEnter={() => sidebarState === 'mini' && setTempExpanded(true)}
  onMouseLeave={() => setTempExpanded(false)}
>
```


### **3.4. Top Navbar**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Sticky + shadow on scroll

```tsx
const [isScrolled, setIsScrolled] = useState(false)

useEffect(() => {
  const handleScroll = () => setIsScrolled(window.scrollY > 10)
  window.addEventListener('scroll', handleScroll)
  return () => window.removeEventListener('scroll', handleScroll)
}, [])

<TopNavbar className={cn('sticky top-0 z-50', isScrolled && 'shadow-md')}>
  <Breadcrumbs />
  <GlobalSearch />
  <Notifications />
  <UserMenu />
</TopNavbar>
```


### **3.5. Page transitions**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Skeleton ‚Üí Fade in content + nprogress

```tsx
// Next.js 14 App Router + Suspense
<Suspense fallback={<GuestsTableSkeleton />}>
  <GuestsTable />
</Suspense>

// + nprogress –¥–ª—è top linear bar
```


### **3.6. Impersonation UI**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Top banner + accent —Ü–≤–µ—Ç

```tsx
{isImpersonating && (
  <ImpersonationBanner className="bg-orange-500 text-white sticky top-0 z-50">
    <AlertTriangle className="h-4 w-4" />
    <span>
      –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ <strong>{impersonatedTenant.name}</strong>
    </span>
    <Button variant="outline" size="sm" onClick={exitImpersonation}>
      –í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    </Button>
  </ImpersonationBanner>
)}

// + CSS theme override
<html className={isImpersonating ? 'theme-impersonation' : ''}>
```


***

## üéØ **4. LOYALTY BUILDER**

### **4.1. Rules Priority: Drag \& Drop**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** dnd-kit

```tsx
import { DndContext, closestCenter } from '@dnd-kit/core'
import { SortableContext, useSortable } from '@dnd-kit/sortable'

<DndContext onDragEnd={handleDragEnd}>
  <SortableContext items={rules.map(r => r.id)}>
    {rules.map((rule, index) => (
      <SortableRuleItem key={rule.id} rule={rule} priority={index + 1} />
    ))}
  </SortableContext>
</DndContext>

// SortableRuleItem —Å GripVertical handle
<Card>
  <GripVertical {...listeners} className="cursor-grab" />
  <Badge>{priority}</Badge>
  <CardTitle>{rule.name}</CardTitle>
</Card>
```

**–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞:** `@dnd-kit/core` + `@dnd-kit/sortable`

### **4.2. Conditions Builder**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Tag pills + visual builder

```tsx
<ConditionsBuilder>
  <ConditionGroup operator="AND">
    <ConditionTag>
      <Select value="checkAmount">
        <option>–°—É–º–º–∞ —á–µ–∫–∞</option>
        <option>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</option>
        <option>–£—Ä–æ–≤–µ–Ω—å –≥–æ—Å—Ç—è</option>
      </Select>
      <Select value="greaterThan">
        <option>&gt;</option>
        <option>&gt;=</option>
        <option>=</option>
      </Select>
      <Input type="number" value={5000} />
      <Button variant="ghost" size="sm"><X /></Button>
    </ConditionTag>
    
    <Button variant="outline" size="sm">
      <Plus /> –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–∏–µ
    </Button>
  </ConditionGroup>
  
  <ConditionsPreview>
    <CodeBlock language="json">
      {JSON.stringify(conditions, null, 2)}
    </CodeBlock>
  </ConditionsPreview>
</ConditionsBuilder>
```


### **4.3. Levels Builder**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Horizontal timeline (desktop), vertical (mobile)

```tsx
<LevelsTimeline>
  {levels.map((level, index) => (
    <>
      <LevelCard level={level}>
        <LevelIcon color={level.color} emoji={level.icon} />
        <LevelName>{level.name}</LevelName>
        <LevelThreshold>–æ—Ç {formatCurrency(level.thresholdAmount)}</LevelThreshold>
        <LevelBenefit>{level.earnPercentage}% –±–∞–ª–ª–æ–≤</LevelBenefit>
        <EditButton />
      </LevelCard>
      
      {index < levels.length - 1 && (
        <TimelineConnector>
          <ArrowRight />
        </TimelineConnector>
      )}
    </>
  ))}
  
  <AddLevelButton>
    <Plus /> –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å
  </AddLevelButton>
</LevelsTimeline>
```


### **4.4. Promo Builder**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Wizard (–∏–∑ –ë–µ—Å–µ–¥—ã 8) + Save as Draft + Live Preview

```tsx
<PromoWizard steps={['–¢–∏–ø', '–¢—Ä–∏–≥–≥–µ—Ä', '–ù–∞–≥—Ä–∞–¥–∞', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏']}>
  <WizardProgress currentStep={2} totalSteps={4} />
  
  <WizardContent>
    <WizardStep>{/* –¢–µ–∫—É—â–∏–π —à–∞–≥ */}</WizardStep>
    
    {/* Live Preview –≤ right panel */}
    <WizardPreview>
      <MobileFrame device="iphone">
        <TelegramMiniApp>
          <NotificationCard promo={formData} />
        </TelegramMiniApp>
      </MobileFrame>
    </WizardPreview>
  </WizardContent>
  
  <WizardFooter>
    <Button variant="outline" onClick={saveAsDraft}>
      –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
    </Button>
    <Button onClick={nextStep}>–î–∞–ª–µ–µ</Button>
  </WizardFooter>
</PromoWizard>
```


### **4.5. Loyalty Card Design Preview**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Split screen —Å live preview

```tsx
<CardDesigner>
  <DesignerPanel>
    <BackgroundPicker presets={presets} onSelect={setBackground} />
    <LogoUploader onUpload={setLogo} />
    <ColorPicker level="Bronze" color={colors.bronze} />
  </DesignerPanel>
  
  <PreviewPanel>
    <DeviceFrame device="iphone">
      <LoyaltyCardPreview
        background={background}
        logo={logo}
        colors={colors}
        guestData={mockGuest}
      />
    </DeviceFrame>
    
    <ToggleButtons>
      <Button>iPhone</Button>
      <Button>Android</Button>
    </ToggleButtons>
  </PreviewPanel>
</CardDesigner>
```


***

## üìä **5. DASHBOARDS \& ANALYTICS**

### **5.1. Dashboard Layout**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π responsive grid

```tsx
<DashboardGrid className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
  {/* Metric Cards - 1 row, 3 cols –Ω–∞ xl */}
  <MetricCard title="MRR" value="‚ÇΩ450,000" change="+12%" />
  <MetricCard title="Active Tenants" value="127" change="+8" />
  <MetricCard title="Churn Rate" value="3.2%" change="-0.5%" />
  
  {/* Charts - 2 cols –Ω–∞ xl */}
  <Card className="col-span-1 md:col-span-2">
    <CardHeader><CardTitle>–í—ã—Ä—É—á–∫–∞ –∑–∞ 30 –¥–Ω–µ–π</CardTitle></CardHeader>
    <CardContent><LineChart data={revenue} /></CardContent>
  </Card>
  
  <Card>
    <CardHeader><CardTitle>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤</CardTitle></CardHeader>
    <CardContent><PieChart data={plans} /></CardContent>
  </Card>
  
  {/* Table - full width */}
  <Card className="col-span-1 md:col-span-2 xl:col-span-3">
    <CardHeader><CardTitle>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</CardTitle></CardHeader>
    <CardContent><TransactionsTable /></CardContent>
  </Card>
</DashboardGrid>
```


### **5.2. Charts Interactivity**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Tooltip + Drill-down + Export

```tsx
<RechartsLineChart data={revenue}>
  <Tooltip
    content={({ payload }) => (
      <TooltipCard>
        <TooltipTitle>{payload[0].payload.date}</TooltipTitle>
        <TooltipValue>‚ÇΩ{formatCurrency(payload[0].value)}</TooltipValue>
        <TooltipAction onClick={() => openDrillDown(payload[0].payload)}>
          –ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí
        </TooltipAction>
      </TooltipCard>
    )}
  />
  <Line
    dataKey="revenue"
    activeDot={{
      r: 6,
      onClick: (data) => openDrillDown(data.payload)
    }}
  />
</RechartsLineChart>

<Button onClick={exportChartAsPNG}>
  <Download /> –≠–∫—Å–ø–æ—Ä—Ç PNG
</Button>
```


### **5.3. Drill-down**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Drawer (desktop), fullscreen modal (mobile)

```tsx
<Sheet open={drillDownOpen} onOpenChange={setDrillDownOpen}>
  <SheetContent side="right" className="w-[600px]">
    <SheetHeader>
      <SheetTitle>Churn Analysis</SheetTitle>
      <SheetDescription>
        –†–µ—Å—Ç–æ—Ä–∞–Ω—ã, –æ—Ç–º–µ–Ω–∏–≤—à–∏–µ –ø–æ–¥–ø–∏—Å–∫—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
      </SheetDescription>
    </SheetHeader>
    
    <SheetBody>
      <LineChart data={churnOverTime} height={200} />
      <Table>{/* –î–µ—Ç–∞–ª–∏ —É—à–µ–¥—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ */}</Table>
    </SheetBody>
    
    <SheetFooter>
      <Button onClick={exportCSV}>–≠–∫—Å–ø–æ—Ä—Ç CSV</Button>
    </SheetFooter>
  </SheetContent>
</Sheet>
```


### **5.4. Date Range Picker**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Dropdown —Å presets (–∏–∑ –ë–µ—Å–µ–¥—ã 8) + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage

```tsx
<DateRangePicker>
  <PopoverTrigger>
    <Button variant="outline">
      <Calendar className="mr-2" />
      {formatRange(selectedRange)}
    </Button>
  </PopoverTrigger>
  
  <PopoverContent>
    <div className="flex">
      {/* Presets */}
      <div className="border-r p-3">
        <PresetButton onClick={() => setRange(last7Days())}>
          –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
        </PresetButton>
        <PresetButton onClick={() => setRange(last30Days())}>
          –ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
        </PresetButton>
        <PresetButton onClick={() => setRange(thisMonth())}>
          –≠—Ç–æ—Ç –º–µ—Å—è—Ü
        </PresetButton>
        <PresetButton onClick={() => setRange(lastMonth())}>
          –ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
        </PresetButton>
      </div>
      
      {/* Calendar */}
      <DayPicker
        mode="range"
        selected={selectedRange}
        onSelect={setSelectedRange}
        numberOfMonths={2}
        locale={ru}
      />
    </div>
  </PopoverContent>
</DateRangePicker>

// Auto-save to localStorage
useEffect(() => {
  localStorage.setItem('lastDateRange', JSON.stringify(selectedRange))
}, [selectedRange])
```


### **5.5. Export Flow**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Modal —Å preview (–º–∞–ª—ã–µ –¥–∞–Ω–Ω—ã–µ), email (–±–æ–ª—å—à–∏–µ)

```tsx
<Dialog open={exportModalOpen}>
  <DialogContent>
    <DialogHeader>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</DialogHeader>
    
    <DialogBody>
      {/* Format selection */}
      <RadioGroup value={format}>
        <RadioGroupItem value="csv">CSV</RadioGroupItem>
        <RadioGroupItem value="xlsx">Excel (XLSX)</RadioGroupItem>
        <RadioGroupItem value="pdf">PDF</RadioGroupItem>
      </RadioGroup>
      
      {/* Column selection */}
      <Label>–ö–æ–ª–æ–Ω–∫–∏:</Label>
      {columns.map(col => (
        <Checkbox key={col.id} checked={selectedColumns.includes(col.id)}>
          {col.label}
        </Checkbox>
      ))}
      
      {/* Preview */}
      <Label>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–ø–µ—Ä–≤—ã–µ 10 –∑–∞–ø–∏—Å–µ–π):</Label>
      <PreviewTable data={data.slice(0, 10)} columns={selectedColumns} />
    </DialogBody>
    
    <DialogFooter>
      <Button onClick={handleExport}>–°–∫–∞—á–∞—Ç—å</Button>
    </DialogFooter>
  </DialogContent>
</Dialog>

// –î–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö (> 10k rows):
if (data.length > 10000) {
  await api.exports.create({ format, columns })
  toast.success('–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–ø—É—â–µ–Ω. –°—Å—ã–ª–∫–∞ –ø—Ä–∏–¥—ë—Ç –Ω–∞ email —á–µ—Ä–µ–∑ 5-10 –º–∏–Ω—É—Ç.')
} else {
  downloadFile(data, format) // Client-side export
}
```


***

## ‚öôÔ∏è **6. SETTINGS \& CONFIGURATION**

### **6.1. Restaurant Settings**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Vertical sidebar (desktop), tabs (mobile)

```tsx
<SettingsLayout>
  <SettingsSidebar>
    <SidebarItem href="/settings/general" icon={Settings}>
      –û—Å–Ω–æ–≤–Ω—ã–µ
    </SidebarItem>
    <SidebarItem href="/settings/loyalty" icon={Gift}>
      –õ–æ—è–ª—å–Ω–æ—Å—Ç—å
    </SidebarItem>
    <SidebarItem href="/settings/billing" icon={CreditCard}>
      –ü–æ–¥–ø–∏—Å–∫–∞ –∏ –æ–ø–ª–∞—Ç–∞
    </SidebarItem>
    <SidebarItem href="/settings/team" icon={Users}>
      –ö–æ–º–∞–Ω–¥–∞
    </SidebarItem>
    <SidebarItem href="/settings/integrations" icon={Plug}>
      –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
    </SidebarItem>
  </SettingsSidebar>
  
  <SettingsContent>{children}</SettingsContent>
</SettingsLayout>

// Mobile: <Tabs>
```


### **6.2. Unsaved Changes Warning**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Custom modal + Auto-save draft

```tsx
// React Hook Form + Next.js router
<AlertDialog open={showUnsavedModal}>
  <AlertDialogTitle>–ù–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</AlertDialogTitle>
  <AlertDialogDescription>
    –£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?
  </AlertDialogDescription>
  <AlertDialogFooter>
    <AlertDialogCancel>–û—Å—Ç–∞—Ç—å—Å—è</AlertDialogCancel>
    <Button variant="outline" onClick={discardAndLeave}>
      –ù–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å
    </Button>
    <Button onClick={saveAndLeave}>
      –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
    </Button>
  </AlertDialogFooter>
</AlertDialog>

// Auto-save draft –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
useEffect(() => {
  const timer = setInterval(() => {
    if (form.formState.isDirty) saveDraft(form.getValues())
  }, 5000)
  return () => clearInterval(timer)
}, [form.formState.isDirty])
```


### **6.3. Activity Log: Filters**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Top bar inline + Advanced modal

```tsx
<ActivityLogFilters>
  <Select value={actionType} onValueChange={setActionType}>
    <SelectItem value="all">–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è</SelectItem>
    <SelectItem value="BALLS_EARNED">–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤</SelectItem>
  </Select>
  
  <Select value={userId}>
    <SelectItem value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</SelectItem>
    {users.map(u => (
      <SelectItem key={u.id} value={u.id}>{u.name}</SelectItem>
    ))}
  </Select>
  
  <DateRangePicker />
  
  <Button variant="outline" onClick={openAdvancedFilters}>
    <Filter /> –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
  </Button>
  
  <Button variant="ghost" onClick={resetFilters}>
    –°–±—Ä–æ—Å–∏—Ç—å
  </Button>
</ActivityLogFilters>
```


### **6.4. Team Management**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Table (desktop), cards (mobile)

```tsx
<TeamTable>
  <TableRow>
    <TableCell>
      <div className="flex items-center gap-3">
        <Avatar src={member.avatar} />
        <div>
          <div className="font-medium">{member.name}</div>
          <div className="text-sm text-muted-foreground">{member.email}</div>
        </div>
      </div>
    </TableCell>
    <TableCell>
      <Badge variant={getRoleBadgeVariant(member.role)}>
        {member.role}
      </Badge>
    </TableCell>
    <TableCell>
      <StatusBadge status={member.status} />
    </TableCell>
    <TableCell>
      {formatRelativeTime(member.lastLoginAt)}
    </TableCell>
    <TableCell>
      <DropdownMenu>
        <DropdownMenuItem onClick={openEditModal}>
          –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª—å
        </DropdownMenuItem>
        <DropdownMenuItem onClick={resetPassword}>
          –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å
        </DropdownMenuItem>
        <DropdownMenuItem className="text-destructive">
          –£–¥–∞–ª–∏—Ç—å
        </DropdownMenuItem>
      </DropdownMenu>
    </TableCell>
  </TableRow>
</TeamTable>
```


### **6.5. Notifications Center**

‚úÖ **–†–µ—à–µ–Ω–∏–µ:** Dropdown panel (last 5) + full page (/notifications)

```tsx
<Popover>
  <PopoverTrigger>
    <Button variant="ghost" size="icon" className="relative">
      <Bell className="h-5 w-5" />
      {unreadCount > 0 && (
        <Badge className="absolute -top-1 -right-1 rounded-full">
          {unreadCount}
        </Badge>
      )}
    </Button>
  </PopoverTrigger>
  
  <PopoverContent align="end" className="w-[380px] p-0">
    <div className="flex items-center justify-between p-4 border-b">
      <h3 className="font-semibold">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
      <Button variant="ghost" size="sm" onClick={markAllAsRead}>
        –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏
      </Button>
    </div>
    
    <div className="max-h-[400px] overflow-y-auto">
      {notifications.slice(0, 5).map(n => (
        <NotificationItem key={n.id} notification={n}>
          <NotificationIcon type={n.type} />
          <div>
            <NotificationTitle>{n.title}</NotificationTitle>
            <NotificationDescription>{n.description}</NotificationDescription>
            <NotificationTime>{formatRelativeTime(n.createdAt)}</NotificationTime>
          </div>
          {!n.isRead && <UnreadDot />}
        </NotificationItem>
      ))}
    </div>
    
    <div className="p-2 border-t">
      <Button variant="ghost" className="w-full" asChild>
        <Link href="/notifications">–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</Link>
      </Button>
    </div>
  </PopoverContent>
</Popover>
```


***

## üõ†Ô∏è **TECH STACK SUMMARY**

### **Core Framework**

- **Next.js 14** (App Router, Server Components, API Routes)
- **React 18** (Concurrent rendering, Suspense)
- **TypeScript** (type safety)


### **UI Components**

- **shadcn/ui** (Radix UI + Tailwind CSS, composable components)
- **Lucide Icons** (1000+ icons, tree-shakeable)
- **Recharts** (charts)
- **TanStack Table v8** (tables)
- **React Day Picker v8** + date-fns (date picker)


### **State Management**

- **TanStack Query (React Query)** (server state, caching, auto-refetch)
- **Zustand** (client state: UI, sidebar, modals)


### **Forms**

- **React Hook Form** (uncontrolled forms, performance)
- **Zod** (schema validation)


### **File Upload**

- **react-dropzone** (drag \& drop area)
- **Uppy** (chunked uploads, retry, progress)


### **Notifications**

- **sonner** (toast notifications by shadcn)


### **Drag \& Drop**

- **dnd-kit** (drag \& drop –¥–ª—è rules priority)


### **Real-time**

- **Server-Sent Events (SSE)** + TanStack Query auto-refetch


### **Other**

- **nprogress** (top linear progress bar)
- **cmdk** (global search, Command K)
- **clsx** + **tailwind-merge** (className utilities)

***

## üì¶ **COMPONENT STRUCTURE**

```
frontend/
‚îú‚îÄ‚îÄ app/                          # Next.js 14 App Router
‚îÇ   ‚îú‚îÄ‚îÄ (auth)/                   # Auth routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ register/
‚îÇ   ‚îú‚îÄ‚îÄ (dashboard)/              # Main app (authenticated)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx            # DashboardLayout (sidebar + navbar)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/            # Owner/Admin/Manager dashboards
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guests/               # Guests management
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx          # Guests table
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/             # Guest detail
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ loyalty/              # Loyalty builder
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rules/            # Rules CRUD
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ levels/           # Levels builder
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ promos/           # Promo campaigns
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analytics/            # Analytics dashboards
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings/             # Settings pages
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx        # SettingsLayout (sidebar)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ general/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ loyalty/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ billing/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ team/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ integrations/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ notifications/        # Notifications page
‚îÇ   ‚îî‚îÄ‚îÄ api/                      # API routes (BFF if needed)
‚îÇ
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/                       # shadcn/ui components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ button.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dialog.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sheet.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ table.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ...
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ layout/                   # Layout components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard-layout.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sidebar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ top-navbar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ breadcrumbs.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ global-search.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mobile-nav.tsx
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ guests/                   # Guests domain
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guests-table.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guest-card.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create-guest-modal.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ edit-guest-modal.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ manual-adjustment-modal.tsx
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ loyalty/                  # Loyalty domain
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rules-builder/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rules-list.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rule-card.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ conditions-builder.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ drag-drop-rules.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ levels-builder/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ levels-timeline.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ level-card.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ promos-builder/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ promo-wizard.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ promo-preview.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ card-designer/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ loyalty-card-preview.tsx
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ analytics/                # Analytics components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ metric-card.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ charts/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ line-chart.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pie-chart.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ bar-chart.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ drill-down-drawer.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ date-range-picker.tsx
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ settings/                 # Settings components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings-layout.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ team-management-table.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ activity-log-table.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ unsaved-changes-modal.tsx
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ shared/                   # Shared components
‚îÇ       ‚îú‚îÄ‚îÄ empty-state.tsx
‚îÇ       ‚îú‚îÄ‚îÄ skeleton.tsx
‚îÇ       ‚îú‚îÄ‚îÄ error-boundary.tsx
‚îÇ       ‚îú‚îÄ‚îÄ loading-spinner.tsx
‚îÇ       ‚îú‚îÄ‚îÄ impersonation-banner.tsx
‚îÇ       ‚îî‚îÄ‚îÄ bulk-actions-bar.tsx
‚îÇ
‚îú‚îÄ‚îÄ hooks/                        # Custom hooks
‚îÇ   ‚îú‚îÄ‚îÄ use-guests.ts
‚îÇ   ‚îú‚îÄ‚îÄ use-loyalty-rules.ts
‚îÇ   ‚îú‚îÄ‚îÄ use-analytics.ts
‚îÇ   ‚îú‚îÄ‚îÄ use-permissions.ts
‚îÇ   ‚îî‚îÄ‚îÄ use-toast.ts
‚îÇ
‚îú‚îÄ‚îÄ lib/                          # Utilities
‚îÇ   ‚îú‚îÄ‚îÄ api.ts                    # API client (fetch/axios)
‚îÇ   ‚îú‚îÄ‚îÄ utils.ts                  # cn(), formatters
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îî‚îÄ‚îÄ validators.ts             # Zod schemas
‚îÇ
‚îú‚îÄ‚îÄ stores/                       # Zustand stores
‚îÇ   ‚îú‚îÄ‚îÄ ui-store.ts               # Sidebar state, modals
‚îÇ   ‚îî‚îÄ‚îÄ auth-store.ts             # Auth context
‚îÇ
‚îú‚îÄ‚îÄ styles/
‚îÇ   ‚îî‚îÄ‚îÄ globals.css               # Tailwind + custom styles
‚îÇ
‚îî‚îÄ‚îÄ types/
    ‚îú‚îÄ‚îÄ guest.ts
    ‚îú‚îÄ‚îÄ loyalty.ts
    ‚îú‚îÄ‚îÄ analytics.ts
    ‚îî‚îÄ‚îÄ user.ts
```


***

## ‚úÖ **–ò–¢–û–ì–û: 35 –†–ï–®–ï–ù–ò–ô –ü–†–ò–ù–Ø–¢–´**

| **–ö–∞—Ç–µ–≥–æ—Ä–∏—è** | **–†–µ—à–µ–Ω–∏–π** | **–ö–ª—é—á–µ–≤—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏** |
| :-- | :-- | :-- |
| **1. Responsive \& Mobile** | 6 | Tailwind breakpoints, shadcn Sheet |
| **2. UI Patterns \& States** | 8 | sonner, Skeleton, TanStack Query |
| **3. Navigation \& Flow** | 6 | cmdk, nprogress, Zustand |
| **4. Loyalty Builder** | 5 | dnd-kit, React Hook Form |
| **5. Dashboards \& Analytics** | 5 | Recharts, React Day Picker |
| **6. Settings \& Configuration** | 5 | shadcn Tabs, AlertDialog |


***

## üéØ **–ì–û–¢–û–í –ö –°–õ–ï–î–£–Æ–©–ï–ú–£ –ë–õ–û–ö–£!**

Frontend UI/UX **–ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω**. –í—Å–µ 35 –≤–æ–ø—Ä–æ—Å–æ–≤ —Ä–µ—à–µ–Ω—ã. –°–∏—Å—Ç–µ–º–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞, tech stack –æ–ø—Ä–µ–¥–µ–ª—ë–Ω, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≥–æ—Ç–æ–≤–∞.

**–ö–∞–∫–æ–π –±–ª–æ–∫ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–ª–µ–µ?**

1. **Database Schema Prisma** (–¥–µ—Ç–∞–ª–∏ –∏–Ω–¥–µ–∫—Å–æ–≤, –º–∏–≥—Ä–∞—Ü–∏–π, seed data)
2. **Infrastructure \& DevOps** (Docker, CI/CD, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –¥–µ–ø–ª–æ–π)
3. **Testing Strategy** (Unit, Integration, E2E, Load testing)
4. **Security \& Compliance** (OWASP, GDPR, PCI DSS)
5. **POS Integration (–¥–µ—Ç–∞–ª–∏)** (JSON-—Å—Ö–µ–º—ã webhooks iiko/R-Keeper, reconciliation –∞–ª–≥–æ—Ä–∏—Ç–º—ã)
6. **Notifications System** (Email/SMS/Push –¥–µ—Ç–∞–ª–∏, —à–∞–±–ª–æ–Ω—ã, –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã)

**–°–∫–∞–∂–∏ –Ω–æ–º–µ—Ä –±–ª–æ–∫–∞ –∏–ª–∏ —Å–≤–æ—ë –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ!** üöÄ

---

# Notifications System (Email/SMS/Push –¥–µ—Ç–∞–ª–∏, —à–∞–±–ª–æ–Ω—ã, –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã) –¥–µ–ª–∞–µ–º. –ó–∞–¥–∞–π 30+ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ + —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ —Ç–≤–æ–µ–º—É –ª—É—á—à–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ –¥–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö. –ü–µ—Ä–µ–¥ –∑–∞–¥–∞–≤–∞–Ω–∏–µ–º –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–≤–µ—Ä—å—Å—è —Å —Ñ–∞–π–ª–∞–º–∏, –º–æ–∂–µ—Ç –æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ –∏–ª–∏ –æ—Ç–≤–µ—Ç —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å.

–û—Ç–ª–∏—á–Ω–æ! –Ø —Å–≤–µ—Ä–∏–ª—Å—è —Å —Ñ–∞–π–ª–∞–º–∏. –í–æ—Ç —á—Ç–æ —É–∂–µ –±—ã–ª–æ —Ä–µ—à–µ–Ω–æ –æ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è—Ö:

**‚úÖ –ò–ó –ë–ï–°–ï–î–´ 8 (Backend API Services):**

- Notification Service (centralized)
- Channels: TELEGRAM, EMAIL, SMS, PUSH (Phase 2)
- Types: ballsearned, ballsredeemed, ballsexpired, levelupgraded, birthdaypromo, paymentfailed, welcome, etc.
- Priority: LOW, NORMAL, HIGH
- Guest settings (GET/PUT preferences)
- Notification History
- BullMQ –¥–ª—è queue

**‚úÖ –ò–ó –ë–ï–°–ï–î–´ 7 (Telegram Bot):**

- Rate limiting (10/–¥–µ–Ω—å)
- Batching (LOW priority ‚Üí 3+ –≤ –æ–¥–Ω—É)
- Bot blocked handling

**‚ùå –ù–ï –†–ï–®–ï–ù–û (–±—É–¥—É —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å):**

- Email/SMS –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
- –®–∞–±–ª–æ–Ω—ã (HTML, templating engine)
- Retry logic
- Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- Delivery tracking
- Cost optimization
- Deep links
- Localization
- A/B testing

***

# üîî **NOTIFICATIONS SYSTEM: 36 –î–ï–¢–ê–õ–¨–ù–´–• –í–û–ü–†–û–°–û–í**

## **üìß 1. EMAIL PROVIDER \& INFRASTRUCTURE (6 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **1. Email Provider –≤—ã–±–æ—Ä**

**–í–û–ü–†–û–°:** –ö–∞–∫–æ–π Email –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è transactional/marketing emails?

- **A)** Resend (modern, developer-friendly, 100 emails/day free, React Email support)
- **B)** SendGrid (enterprise, 100 emails/day free, powerful API, –Ω–æ —Å–ª–æ–∂–Ω—ã–π)
- **C)** AWS SES (cheapest \$0.10/1000 emails, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç SMTP setup)
- **D)** Nodemailer + SMTP (–≥–∏–±–∫–æ—Å—Ç—å, –Ω–æ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) Resend –¥–ª—è transactional + B) SendGrid –¥–ª—è marketing**

```typescript
// libs/notifications/src/providers/email/email.provider.ts
import { Resend } from 'resend'
import sgMail from '@sendgrid/mail'

interface EmailProviderConfig {
  transactional: 'resend' | 'sendgrid' | 'ses'
  marketing: 'sendgrid' | 'mailchimp'
}

@Injectable()
export class EmailProvider {
  private resend: Resend
  private sendgrid: typeof sgMail
  
  constructor(private config: ConfigService) {
    // Transactional: Resend (simple, fast, React Email templates)
    this.resend = new Resend(config.get('RESEND_API_KEY'))
    
    // Marketing: SendGrid (—Å–ø–∏—Å–∫–∏, —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è, A/B testing)
    this.sendgrid = sgMail
    this.sendgrid.setApiKey(config.get('SENDGRID_API_KEY'))
  }
  
  async sendTransactional(dto: SendEmailDto) {
    return this.resend.emails.send({
      from: 'noreply@max-loyalty.com',
      to: dto.to,
      subject: dto.subject,
      react: dto.reactComponent, // React Email –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
    })
  }
  
  async sendMarketing(dto: SendMarketingEmailDto) {
    return this.sendgrid.send({
      to: dto.recipientList,
      from: 'marketing@max-loyalty.com',
      templateId: dto.sendgridTemplateId,
      dynamicTemplateData: dto.variables,
    })
  }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- **Resend**: React Email –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –ø—Ä–æ—Å—Ç–æ—Ç–∞, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π DX
- **SendGrid**: –º–æ—â–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è marketing (A/B, —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è, unsubscribe)
- **Fallback**: –µ—Å–ª–∏ Resend down ‚Üí AWS SES backup

***

### **2. Email Templates: React Email vs Handlebars**

**–í–û–ü–†–û–°:** –ö–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å email templates (HTML)?

- **A)** React Email (JSX –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, type-safe, preview –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
- **B)** Handlebars (–ø—Ä–æ—Å—Ç–æ–π templating, {{variable}})
- **C)** MJML (responsive email framework, –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –≤ HTML)
- **D)** –•—Ä–∞–Ω–∏—Ç—å –≥–æ—Ç–æ–≤—ã–µ HTML –≤ –ë–î (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –∞–¥–º–∏–Ω–∞–º–∏)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) React Email**

```tsx
// libs/notifications/src/templates/emails/BallsEarnedEmail.tsx
import { 
  Html, 
  Head, 
  Body, 
  Container, 
  Text, 
  Button, 
  Img 
} from '@react-email/components'

interface BallsEarnedEmailProps {
  guestName: string
  earnedPoints: number
  newBalance: number
  checkAmount: number
  restaurantName: string
  restaurantLogo: string
  viewBalanceUrl: string
}

export default function BallsEarnedEmail(props: BallsEarnedEmailProps) {
  return (
    <Html>
      <Head />
      <Body style={main}>
        <Container style={container}>
          <Img
            src={props.restaurantLogo}
            alt={props.restaurantName}
            width="120"
            height="40"
            style={logo}
          />
          
          <Text style={heading}>
            –ù–∞—á–∏—Å–ª–µ–Ω–æ {props.earnedPoints} –±–∞–ª–ª–æ–≤! üéâ
          </Text>
          
          <Text style={paragraph}>
            –ü—Ä–∏–≤–µ—Ç, {props.guestName}!
          </Text>
          
          <Text style={paragraph}>
            –ó–∞ —á–µ–∫ –Ω–∞ —Å—É–º–º—É <strong>{props.checkAmount} ‚ÇΩ</strong> –≤ {props.restaurantName} 
            –≤–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ <strong>{props.earnedPoints} –±–∞–ª–ª–æ–≤</strong>.
          </Text>
          
          <Text style={balanceBox}>
            –í–∞—à –±–∞–ª–∞–Ω—Å: {props.newBalance} –±–∞–ª–ª–æ–≤
          </Text>
          
          <Button href={props.viewBalanceUrl} style={button}>
            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –±–∞–ª–∞–Ω—Å
          </Button>
          
          <Text style={footer}>
            –≠—Ç–æ –ø–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ù–µ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –Ω–µ–≥–æ.
          </Text>
        </Container>
      </Body>
    </Html>
  )
}

// Styles (inline CSS)
const main = { backgroundColor: '#f6f9fc', fontFamily: 'Arial, sans-serif' }
const container = { margin: '0 auto', padding: '40px', maxWidth: '600px', backgroundColor: '#ffffff' }
const logo = { margin: '0 auto' }
const heading = { fontSize: '24px', fontWeight: 'bold', marginBottom: '20px' }
// ...
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ NotificationService:**

```typescript
import BallsEarnedEmail from '@/templates/emails/BallsEarnedEmail'
import { render } from '@react-email/render'

async sendBallsEarnedEmail(guest: Guest, data: BallsEarnedData) {
  const html = render(BallsEarnedEmail({
    guestName: guest.firstName,
    earnedPoints: data.amount,
    newBalance: data.balance,
    checkAmount: data.checkAmount,
    restaurantName: data.restaurant.name,
    restaurantLogo: data.restaurant.logoUrl,
    viewBalanceUrl: `https://loyalty.max.ru/balance?token=${guest.token}`,
  }))
  
  await this.emailProvider.sendTransactional({
    to: guest.email,
    subject: `–ù–∞—á–∏—Å–ª–µ–Ω–æ ${data.amount} –±–∞–ª–ª–æ–≤!`,
    html,
  })
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ React Email:**

- Type-safe props (TypeScript)
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)
- Live preview (`npm run dev`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è inlining CSS
- Responsive –∏–∑ –∫–æ—Ä–æ–±–∫–∏

***

### **3. Email Attachments (QR code)**

**–í–û–ü–†–û–°:** –ü—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å –ª–∏ QR-–∫–æ–¥ –∫–∞—Ä—Ç—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∫ welcome email?

- **A)** –î–∞, –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR PNG –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å –∫–∞–∫ attachment
- **B)** –î–∞, –Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å QR inline –≤ HTML (`<img src="cid:qrcode">`)
- **C)** –ù–µ—Ç, —Ç–æ–ª—å–∫–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ web/Telegram Mini App
- **D)** –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (Guest –º–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å QR —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Inline QR –≤ HTML**

```typescript
import QRCode from 'qrcode'

async sendWelcomeEmail(guest: Guest, guestCard: GuestCard) {
  // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR code PNG (base64)
  const qrCodeBase64 = await QRCode.toDataURL(guestCard.qrCode, {
    width: 280,
    margin: 2,
    color: {
      dark: '#000000',
      light: '#ffffff',
    },
  })
  
  // 2. –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤ email HTML
  const html = render(WelcomeEmail({
    guestName: guest.firstName,
    qrCodeBase64, // data:image/png;base64,...
    digitCode: guestCard.code6Digit,
    restaurantName: tenant.name,
    telegramBotLink: `https://t.me/${tenant.telegramBot.username}`,
  }))
  
  await this.emailProvider.send({
    to: guest.email,
    subject: `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ${tenant.name}!`,
    html,
  })
}
```

```tsx
// WelcomeEmail.tsx
<Img
  src={props.qrCodeBase64} // data:image/png;base64,...
  alt="QR Code"
  width="280"
  height="280"
  style={{ margin: '20px auto', display: 'block' }}
/>

<Text style={{ textAlign: 'center', fontSize: '32px', letterSpacing: '8px' }}>
  {props.digitCode}
</Text>
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** QR –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫)

***

### **4. Email Unsubscribe –º–µ—Ö–∞–Ω–∏–∑–º**

**–í–û–ü–†–û–°:** –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å unsubscribe (–¥–ª—è marketing emails)?

- **A)** –°—Å—ã–ª–∫–∞ –≤ footer ‚Üí GET `/notifications/unsubscribe?token=xxx` ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø–∏—Å–∫–∞
- **B)** –°—Å—ã–ª–∫–∞ ‚Üí landing page —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º ("–í—ã —É–≤–µ—Ä–µ–Ω—ã?") ‚Üí POST
- **C)** List-Unsubscribe header (RFC 8058) –¥–ª—è email –∫–ª–∏–µ–Ω—Ç–æ–≤
- **D)** –ö–æ–º–±–æ: A + C (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è + header)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) –ö–æ–º–±–æ**

```typescript
async sendMarketingEmail(guest: Guest, campaign: MarketingCampaign) {
  // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º unsubscribe token (JWT, TTL 90 –¥–Ω–µ–π)
  const unsubscribeToken = this.jwtService.sign(
    { userId: guest.userId, type: 'unsubscribe' },
    { expiresIn: '90d' }
  )
  
  const unsubscribeUrl = `https://max-loyalty.com/unsubscribe?token=${unsubscribeToken}`
  
  // 2. –î–æ–±–∞–≤–ª—è–µ–º List-Unsubscribe header (RFC 8058)
  await this.emailProvider.send({
    to: guest.email,
    subject: campaign.subject,
    html: render(MarketingEmail({
      ...campaign.data,
      unsubscribeUrl,
    })),
    headers: {
      'List-Unsubscribe': `<${unsubscribeUrl}>`,
      'List-Unsubscribe-Post': 'List-Unsubscribe=One-Click', // Gmail one-click unsubscribe
    },
  })
}

// Controller
@Get('/unsubscribe')
async unsubscribe(@Query('token') token: string) {
  const { userId } = this.jwtService.verify(token)
  
  // –û—Ç–∫–ª—é—á–∞–µ–º marketing emails
  await this.prisma.guestNotificationSettings.update({
    where: { userId },
    data: { 'settings.marketing.enabled': false },
  })
  
  return {
    message: '–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç —Ä–∞—Å—Å—ã–ª–æ–∫',
    redirect: 'https://max-loyalty.com/unsubscribed',
  }
}
```

**Email footer:**

```tsx
<Text style={footer}>
  –ù–µ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —Ç–∞–∫–∏–µ –ø–∏—Å—å–º–∞? 
  <Link href={props.unsubscribeUrl}>–û—Ç–ø–∏—Å–∞—Ç—å—Å—è</Link>
</Text>
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** Compliance —Å CAN-SPAM Act, GDPR

***

### **5. Email Delivery Tracking (Open Rate, Click Rate)**

**–í–û–ü–†–û–°:** –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ª–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∫–ª–∏–∫–∏ email?

- **A)** –î–∞, tracking pixel (1x1 transparent PNG) + tracked links
- **B)** –î–∞, –Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è marketing emails (–Ω–µ –¥–ª—è transactional)
- **C)** –ù–µ—Ç (privacy-first –ø–æ–¥—Ö–æ–¥)
- **D)** –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (Guest –º–æ–∂–µ—Ç –æ—Ç–∫–ª—é—á–∏—Ç—å tracking –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Tracking —Ç–æ–ª—å–∫–æ –¥–ª—è marketing**

```typescript
async sendMarketingEmail(guest: Guest, campaign: MarketingCampaign) {
  // 1. Tracking pixel (1x1 PNG)
  const trackingPixelUrl = `https://cdn.max-loyalty.com/tracking/email/${campaign.id}/${guest.userId}/open.png`
  
  // 2. Wrapped links –¥–ª—è click tracking
  const trackedLinks = campaign.links.map(link => ({
    original: link.url,
    tracked: `https://max-loyalty.com/track/click?campaign=${campaign.id}&user=${guest.userId}&url=${encodeURIComponent(link.url)}`,
  }))
  
  const html = render(MarketingEmail({
    ...campaign.data,
    links: trackedLinks,
    trackingPixelUrl, // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü <body>
  }))
  
  await this.emailProvider.send({ to: guest.email, html })
}

// Tracking endpoints
@Get('/tracking/email/:campaignId/:userId/open.png')
async trackEmailOpen(@Param() params) {
  await this.prisma.emailOpenEvent.create({
    data: {
      campaignId: params.campaignId,
      userId: params.userId,
      openedAt: new Date(),
      userAgent: req.headers['user-agent'],
    },
  })
  
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º 1x1 transparent PNG
  return res.sendFile('tracking-pixel.png')
}

@Get('/track/click')
async trackLinkClick(@Query() query) {
  await this.prisma.emailClickEvent.create({
    data: {
      campaignId: query.campaign,
      userId: query.user,
      clickedUrl: query.url,
      clickedAt: new Date(),
    },
  })
  
  // Redirect –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π URL
  return res.redirect(query.url)
}
```

**Analytics:**

```typescript
// GET /api/v1/analytics/campaigns/:campaignId
{
  "sent": 1523,
  "delivered": 1498,
  "opened": 876, // 58.5% open rate
  "clicked": 312, // 20.8% click rate
  "unsubscribed": 8
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** Measure campaign effectiveness, A/B testing

***

### **6. Email Retry Logic \& Fallback**

**–í–û–ü–†–û–°:** –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å failed email deliveries?

- **A)** Retry 3 —Ä–∞–∑–∞ —Å exponential backoff (1min, 5min, 15min)
- **B)** Retry + fallback –Ω–∞ SMS (–¥–ª—è critical notifications)
- **C)** –ù–µ retry (mark as FAILED, –ø—É—Å—Ç—å Guest —Å–∞–º —Å–º–æ—Ç—Ä–∏—Ç –≤ history)
- **D)** Retry + DLQ (Dead Letter Queue) –¥–ª—è manual review

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Retry + SMS fallback (–¥–ª—è CRITICAL/HIGH)**

```typescript
// BullMQ Queue —Å retry
@Processor(QueueName.NOTIFICATIONS)
export class NotificationProcessor {
  @Process('send-email')
  async processEmail(job: Job<SendEmailDto>) {
    try {
      await this.emailProvider.send(job.data)
      
      // Update status
      await this.prisma.notification.update({
        where: { id: job.data.notificationId },
        data: { status: 'DELIVERED', sentAt: new Date() },
      })
    } catch (error) {
      // Log error
      this.logger.error(`Email failed: ${error.message}`, { jobId: job.id })
      
      // Retry logic (BullMQ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ retry)
      if (job.attemptsMade < 3) {
        throw error // BullMQ –ø–æ–≤—Ç–æ—Ä–∏—Ç —á–µ—Ä–µ–∑ backoff
      }
      
      // –ü–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫: fallback –Ω–∞ SMS (–µ—Å–ª–∏ CRITICAL/HIGH)
      if (job.data.priority === 'CRITICAL' || job.data.priority === 'HIGH') {
        await this.notificationQueue.add('send-sms', {
          phone: job.data.recipientPhone,
          message: job.data.fallbackSmsText,
          originalChannel: 'EMAIL',
        })
      }
      
      // Mark as FAILED
      await this.prisma.notification.update({
        where: { id: job.data.notificationId },
        data: { 
          status: 'FAILED', 
          errorMessage: error.message,
        },
      })
    }
  }
}

// BullMQ config
BullModule.registerQueue({
  name: QueueName.NOTIFICATIONS,
  defaultJobOptions: {
    attempts: 3, // 3 –ø–æ–ø—ã—Ç–∫–∏
    backoff: {
      type: 'exponential',
      delay: 60000, // 1 min ‚Üí 2 min ‚Üí 4 min
    },
    removeOnComplete: 1000, // Keep last 1000 completed jobs
    removeOnFail: 5000, // Keep last 5000 failed jobs for analysis
  },
})
```


***

## **üì± 2. SMS PROVIDER \& COST OPTIMIZATION (5 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **7. SMS Provider –≤—ã–±–æ—Ä**

**–í–û–ü–†–û–°:** –ö–∞–∫–æ–π SMS –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (–¥–ª—è –†–æ—Å—Å–∏–∏)?

- **A)** SMS.ru (RU-friendly, API, 1‚ÇΩ/SMS, –±–µ–∑ –ù–î–°)
- **B)** Twilio (–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π, –¥–æ—Ä–æ–≥–æ–π –¥–ª—è RU ~\$0.05/SMS ‚âà 4‚ÇΩ)
- **C)** SMSC.ru (–¥–µ—à—ë–≤—ã–π, –Ω–æ —Å—Ç–∞—Ä—ã–π API)
- **D)** Multi-provider (SMS.ru primary, SMSC.ru fallback)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Multi-provider (SMS.ru + SMSC fallback)**

```typescript
// libs/notifications/src/providers/sms/sms.provider.ts
interface SmsProviderStrategy {
  send(phone: string, message: string): Promise<void>
  getCost(phone: string): number // –°—Ç–æ–∏–º–æ—Å—Ç—å –≤ —Ä—É–±–ª—è—Ö
}

@Injectable()
export class SmsRuProvider implements SmsProviderStrategy {
  async send(phone: string, message: string) {
    const response = await axios.get('https://sms.ru/sms/send', {
      params: {
        api_id: process.env.SMSRU_API_KEY,
        to: phone,
        msg: message,
        json: 1,
      },
    })
    
    if (response.data.status !== 'OK') {
      throw new Error(`SMS.ru failed: ${response.data.status_text}`)
    }
  }
  
  getCost(phone: string) {
    return 1.0 // ‚ÇΩ1 –∑–∞ SMS
  }
}

@Injectable()
export class SmscProvider implements SmsProviderStrategy {
  async send(phone: string, message: string) {
    await axios.get('https://smsc.ru/sys/send.php', {
      params: {
        login: process.env.SMSC_LOGIN,
        psw: process.env.SMSC_PASSWORD,
        phones: phone,
        mes: message,
        charset: 'utf-8',
      },
    })
  }
  
  getCost(phone: string) {
    return 0.8 // ‚ÇΩ0.8 –∑–∞ SMS
  }
}

@Injectable()
export class SmsProvider {
  private providers = [
    new SmsRuProvider(),
    new SmscProvider(),
  ]
  
  async send(phone: string, message: string) {
    for (const provider of this.providers) {
      try {
        await provider.send(phone, message)
        
        // Track cost
        await this.trackSmsCost(phone, provider.getCost(phone))
        return
      } catch (error) {
        this.logger.warn(`Provider ${provider.constructor.name} failed, trying next...`)
      }
    }
    
    throw new Error('All SMS providers failed')
  }
}
```


***

### **8. SMS Length \& Cost Optimization**

**–í–û–ü–†–û–°:** –ö–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–ª–∏–Ω—É SMS (70 —Å–∏–º–≤–æ–ª–æ–≤ –∫–∏—Ä–∏–ª–ª–∏—Ü–∞ = 1 SMS, 67+ = 2 SMS)?

- **A)** –ñ—ë—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç: –≤—Å–µ SMS ‚â§ 70 —Å–∏–º–≤–æ–ª–æ–≤ (–æ–±—Ä–µ–∑–∞—Ç—å —Ç–µ–∫—Å—Ç)
- **B)** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π: –∫–æ—Ä–æ—Ç–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (CRITICAL) ‚â§ 70, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ
- **C)** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Latin —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—é (160 —Å–∏–º–≤–æ–ª–æ–≤ = 1 SMS –≤–º–µ—Å—Ç–æ 70)
- **D)** Shortened URLs (bit.ly) –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Å–∏–º–≤–æ–ª–æ–≤

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π + D) Short URLs**

```typescript
// libs/notifications/src/templates/sms/sms-templates.ts
interface SmsTemplate {
  generate(data: any): { text: string, estimatedCost: number }
}

class BallsEarnedSmsTemplate implements SmsTemplate {
  generate(data: { amount: number, balance: number, restaurant: string }) {
    // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç (90 —Å–∏–º–≤–æ–ª–æ–≤)
    const longText = `–ù–∞—á–∏—Å–ª–µ–Ω–æ ${data.amount} –±. –∑–∞ –≤–∏–∑–∏—Ç –≤ ${data.restaurant}. –ë–∞–ª–∞–Ω—Å: ${data.balance} –±.`
    
    // –ï—Å–ª–∏ > 70, —Å–æ–∫—Ä–∞—â–∞–µ–º
    if (longText.length > 70) {
      // Shorten URL (https://t.me/bot ‚Üí tme.to/bot = -10 chars)
      const shortText = `+${data.amount}–±. –ë–∞–ª–∞–Ω—Å: ${data.balance}–±. –î–µ—Ç–∞–ª–∏: tme.to/loyaltybot`
      return { text: shortText, estimatedCost: 1.0 }
    }
    
    return { text: longText, estimatedCost: 1.0 }
  }
}

class VerificationCodeSmsTemplate implements SmsTemplate {
  generate(data: { code: string }) {
    // CRITICAL: –≤—Å–µ–≥–¥–∞ –∫–æ—Ä–æ—Ç–∫–∏–π (35 —Å–∏–º–≤–æ–ª–æ–≤)
    return {
      text: `–í–∞—à –∫–æ–¥: ${data.code}`,
      estimatedCost: 1.0,
    }
  }
}

// Usage
const template = new BallsEarnedSmsTemplate()
const { text, estimatedCost } = template.generate({
  amount: 285,
  balance: 3185,
  restaurant: '–°—É—à–∏–ª–∫–∞',
})

await this.smsProvider.send(guest.phone, text)
await this.trackNotificationCost(guest.tenantId, estimatedCost)
```

**–ü—Ä–∞–≤–∏–ª–æ:** CRITICAL notifications (verification codes) ‚Äî –≤—Å–µ–≥–¥–∞ –∫–æ—Ä–æ—Ç–∫–∏–µ. LOW/NORMAL ‚Äî –º–æ–∂–µ–º —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å, –æ—Ç–ø—Ä–∞–≤–∏–≤ Telegram –≤–º–µ—Å—Ç–æ SMS.

***

### **9. SMS vs Telegram –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç**

**–í–û–ü–†–û–°:** –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å SMS, –∞ –∫–æ–≥–¥–∞ Telegram (—É—á–∏—Ç—ã–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å SMS ‚ÇΩ1 vs Telegram –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)?

- **A)** –í—Å–µ–≥–¥–∞ –ø—ã—Ç–∞—Ç—å—Å—è Telegram first, SMS fallback (–µ—Å–ª–∏ bot blocked)
- **B)** SMS —Ç–æ–ª—å–∫–æ –¥–ª—è CRITICAL (verification codes, password reset)
- **C)** Guest –≤—ã–±–∏—Ä–∞–µ—Ç (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏: "Prefer SMS" / "Prefer Telegram")
- **D)** Cost-based: –µ—Å–ª–∏ Guest –∞–∫—Ç–∏–≤–µ–Ω –≤ Telegram (last activity < 7 –¥–Ω–µ–π) ‚Üí Telegram, –∏–Ω–∞—á–µ SMS

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Cost-based strategy**

```typescript
async sendNotification(dto: SendNotificationDto) {
  const guest = await this.getGuest(dto.recipientId)
  const settings = await this.getNotificationSettings(guest.userId)
  
  // 1. CRITICAL ‚Üí –≤—Å–µ–≥–¥–∞ SMS (–Ω–∞–¥—ë–∂–Ω–µ–µ)
  if (dto.priority === 'CRITICAL') {
    return this.sendSms(guest.phone, dto.message)
  }
  
  // 2. Check if Telegram available
  const telegramUser = await this.prisma.telegramUser.findUnique({
    where: { userId: guest.userId },
  })
  
  if (telegramUser && !telegramUser.botBlocked) {
    // Guest –∞–∫—Ç–∏–≤–µ–Ω –≤ Telegram?
    const lastActivity = telegramUser.lastInteractionAt
    const isActive = lastActivity && differenceInDays(new Date(), lastActivity) < 7
    
    if (isActive) {
      // Telegram (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
      try {
        await this.telegramBot.sendMessage(telegramUser.telegramId, dto.message)
        await this.trackNotificationCost(tenant.id, 0) // Free
        return
      } catch (error) {
        // Fallback to SMS
      }
    }
  }
  
  // 3. HIGH priority + Telegram unavailable ‚Üí SMS
  if (dto.priority === 'HIGH') {
    await this.sendSms(guest.phone, dto.message)
    await this.trackNotificationCost(tenant.id, 1.0) // ‚ÇΩ1
    return
  }
  
  // 4. LOW priority + Telegram unavailable ‚Üí skip SMS (save money)
  // –ü—É—Å—Ç—å Guest —É–≤–∏–¥–∏—Ç –≤ notification history
  await this.prisma.notification.create({
    data: {
      ...dto,
      status: 'SKIPPED',
      skipReason: 'Cost optimization (LOW priority, Telegram unavailable)',
    },
  })
}
```

**Cost tracking:**

```sql
-- Analytics: Monthly notification costs per tenant
SELECT 
  tenant_id,
  DATE_TRUNC('month', created_at) AS month,
  COUNT(*) FILTER (WHERE channel = 'SMS') AS sms_count,
  SUM(cost) FILTER (WHERE channel = 'SMS') AS sms_cost_rub,
  COUNT(*) FILTER (WHERE channel = 'TELEGRAM') AS telegram_count,
  SUM(cost) AS total_cost
FROM notifications
GROUP BY tenant_id, month
ORDER BY month DESC
```


***

### **10. SMS Delivery Status (Webhook callbacks)**

**–í–û–ü–†–û–°:** –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ª–∏ delivery status SMS (–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ/–Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ)?

- **A)** –î–∞, —á–µ—Ä–µ–∑ webhook callbacks –æ—Ç SMS.ru (status_code: 100 = delivered, 101 = queued, 202 = failed)
- **B)** –î–∞, –Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è CRITICAL notifications
- **C)** –ù–µ—Ç (assume delivered, check via support –µ—Å–ª–∏ Guest –∂–∞–ª—É–µ—Ç—Å—è)
- **D)** Polling status API –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) Webhook callbacks**

```typescript
// SMS.ru callback setup
await axios.get('https://sms.ru/sms/send', {
  params: {
    api_id: process.env.SMSRU_API_KEY,
    to: phone,
    msg: message,
    json: 1,
    // Webhook URL –¥–ª—è status updates
    status_url: 'https://api.max-loyalty.com/webhooks/sms-status',
  },
})

// Webhook handler
@Controller('/webhooks')
export class WebhooksController {
  @Post('/sms-status')
  async handleSmsStatus(@Body() body: SmsStatusWebhook) {
    // SMS.ru callback format:
    // {
    //   "sms_id": "123-456",
    //   "phone": "79991234567",
    //   "status": "100", // 100 = delivered, 202 = failed, 103 = expired
    //   "status_text": "–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ",
    //   "cost": "1.00"
    // }
    
    await this.prisma.notification.update({
      where: { 
        externalId: body.sms_id, // –°–æ—Ö—Ä–∞–Ω—è–µ–º sms_id –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
      },
      data: {
        status: body.status === '100' ? 'DELIVERED' : 'FAILED',
        deliveredAt: body.status === '100' ? new Date() : null,
        errorMessage: body.status !== '100' ? body.status_text : null,
        actualCost: parseFloat(body.cost),
      },
    })
    
    // –ï—Å–ª–∏ FAILED + CRITICAL ‚Üí retry —á–µ—Ä–µ–∑ –¥—Ä—É–≥–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
    if (body.status !== '100') {
      const notification = await this.getNotification(body.sms_id)
      if (notification.priority === 'CRITICAL') {
        await this.notificationQueue.add('retry-sms-fallback', {
          phone: body.phone,
          message: notification.message,
          provider: 'SMSC', // Try fallback provider
        })
      }
    }
    
    return { ok: true }
  }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –¢–æ—á–Ω—ã–π tracking –¥–æ—Å—Ç–∞–≤–∫–∏, –º–æ–∂–µ–º –ø–æ–∫–∞–∑–∞—Ç—å Guest "SMS –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ ‚úì" –≤ –∏—Å—Ç–æ—Ä–∏–∏

***

### **11. SMS Rate Limiting (Anti-Spam)**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å SMS spam (Guest –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç verification code 100 —Ä–∞–∑)?

- **A)** Rate limit: 3 SMS/hour per phone number
- **B)** Rate limit + exponential cooldown (1min ‚Üí 5min ‚Üí 15min)
- **C)** CAPTCHA –ø–æ—Å–ª–µ 3 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
- **D)** –ö–æ–º–±–æ: B + C

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Exponential cooldown + CAPTCHA**

```typescript
// Redis-based rate limiting
async requestVerificationCode(phone: string, ip: string) {
  const rateLimitKey = `sms:ratelimit:${phone}`
  const attemptsKey = `sms:attempts:${phone}`
  
  // 1. Check cooldown
  const cooldownUntil = await this.redis.get(rateLimitKey)
  if (cooldownUntil) {
    const remainingSeconds = Math.ceil((parseInt(cooldownUntil) - Date.now()) / 1000)
    throw new HttpException(
      `–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ ${remainingSeconds} —Å–µ–∫.`,
      429
    )
  }
  
  // 2. Check attempts count
  const attempts = await this.redis.incr(attemptsKey)
  await this.redis.expire(attemptsKey, 3600) // Reset after 1 hour
  
  // 3. Exponential cooldown
  if (attempts > 3) {
    const cooldownSeconds = Math.min(60 * Math.pow(2, attempts - 3), 900) // Max 15 min
    await this.redis.setex(rateLimitKey, cooldownSeconds, Date.now() + cooldownSeconds * 1000)
    
    throw new HttpException(
      `–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ ${cooldownSeconds} —Å–µ–∫.`,
      429
    )
  }
  
  // 4. –ü–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫ ‚Äî —Ç—Ä–µ–±—É–µ–º CAPTCHA
  if (attempts >= 5) {
    const captchaVerified = await this.verifyCaptcha(body.captchaToken)
    if (!captchaVerified) {
      throw new HttpException('–ü—Ä–æ–π–¥–∏—Ç–µ CAPTCHA', 400)
    }
  }
  
  // 5. Send SMS
  const code = this.generate6DigitCode()
  await this.smsProvider.send(phone, `–í–∞—à –∫–æ–¥: ${code}`)
  
  // 6. Save code in Redis (TTL 10 min)
  await this.redis.setex(`verification:${phone}`, 600, code)
  
  return { message: '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à –Ω–æ–º–µ—Ä' }
}
```


***

## **üîî 3. TELEGRAM PUSH NOTIFICATIONS (4 –≤–æ–ø—Ä–æ—Å–∞)**

### **12. Telegram Message Formatting**

**–í–û–ü–†–û–°:** –ö–∞–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å Telegram messages (HTML, Markdown, plain text)?

- **A)** Markdown (bold, italic, code)
- **B)** HTML (–±–æ–ª—å—à–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π: links, inline buttons)
- **C)** Plain text (–ø—Ä–æ—Å—Ç–æ—Ç–∞, –Ω–æ —Å–∫—É—á–Ω–æ)
- **D)** –ê–¥–∞–ø—Ç–∏–≤–Ω–æ (HTML –¥–ª—è rich notifications, plain –¥–ª—è simple)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) HTML**

```typescript
// libs/notifications/src/templates/telegram/BallsEarnedMessage.ts
export function formatBallsEarnedMessage(data: BallsEarnedData): string {
  return `
üéâ <b>–ù–∞—á–∏—Å–ª–µ–Ω–æ ${data.amount} –±–∞–ª–ª–æ–≤!</b>

–ó–∞ —á–µ–∫ –Ω–∞ —Å—É–º–º—É <b>${data.checkAmount} ‚ÇΩ</b> –≤ ${data.restaurant.name} 
–≤–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ <b>${data.amount} –±–∞–ª–ª–æ–≤</b>.

üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: <code>${data.balance} –±–∞–ª–ª–æ–≤</code>

<a href="${data.viewBalanceUrl}">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π</a>
  `.trim()
}

// Send via Telegram Bot API
await this.bot.telegram.sendMessage(
  telegramUser.telegramId,
  formatBallsEarnedMessage(data),
  {
    parse_mode: 'HTML',
    reply_markup: {
      inline_keyboard: [
        [
          { text: 'üí≥ –ú–æ—è –∫–∞—Ä—Ç–∞', callback_data: 'view_card' },
          { text: 'üìä –ò—Å—Ç–æ—Ä–∏—è', callback_data: 'view_history' },
        ],
        [
          { text: 'üîï –û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', callback_data: 'disable_notifications' },
        ],
      ],
    },
  }
)
```

**HTML —Ç–µ–≥–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ Telegram:**

```
- `<b>bold</b>`, `<i>italic</i>`, `<u>underline</u>`
```

```
- `<code>monospace</code>`, `<pre>pre-formatted</pre>`
```

```
- `<a href="...">link</a>`
```

```
- `<emoji id="...">emoji</emoji>` (custom emoji)
```


***

### **13. Telegram Deep Links (–≤ Mini App)**

**–í–û–ü–†–û–°:** –ö–∞–∫ –≤–µ—Å—Ç–∏ Guest –∏–∑ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —ç–∫—Ä–∞–Ω Mini App?

- **A)** Deep links: `https://t.me/bot?start=view_balance`
- **B)** Web App links: `https://t.me/bot/app?startapp=balance`
- **C)** Inline keyboard buttons —Å `web_app` URL
- **D)** –ö–æ–º–±–æ: B + C

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) –ö–æ–º–±–æ (web_app buttons + startapp)**

```typescript
// Notification —Å deep link
await this.bot.telegram.sendMessage(
  telegramUser.telegramId,
  `üéâ –ù–∞—á–∏—Å–ª–µ–Ω–æ ${data.amount} –±–∞–ª–ª–æ–≤!`,
  {
    parse_mode: 'HTML',
    reply_markup: {
      inline_keyboard: [
        [
          {
            text: 'üí≥ –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É',
            web_app: { 
              url: `https://miniapp.max-loyalty.com/?startapp=balance&userId=${guest.userId}&token=${authToken}` 
            },
          },
        ],
        [
          {
            text: 'üìä –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π',
            web_app: { 
              url: `https://miniapp.max-loyalty.com/?startapp=transactions&userId=${guest.userId}` 
            },
          },
        ],
      ],
    },
  }
)
```

**Mini App routing (React):**

```tsx
// Mini App: pages/index.tsx
useEffect(() => {
  const urlParams = new URLSearchParams(window.location.search)
  const startapp = urlParams.get('startapp') // "balance", "transactions", etc.
  
  if (startapp === 'balance') {
    router.push('/balance')
  } else if (startapp === 'transactions') {
    router.push('/transactions')
  }
}, [])
```


***

### **14. Telegram Notification Reply Actions**

**–í–û–ü–†–û–°:** –†–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –ª–∏ –Ω–∞ –æ—Ç–≤–µ—Ç—ã Guest –Ω–∞ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–°–ø–∞—Å–∏–±–æ")?

- **A)** –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å (–±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ replies)
- **B)** –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç ("–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –Ω–µ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –Ω–µ–≥–æ")
- **C)** Natural language processing (Guest –ø–∏—à–µ—Ç "–û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É)
- **D)** Inline buttons –≤–º–µ—Å—Ç–æ replies (–ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –∫–Ω–æ–ø–∫–∞–º–∏)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Inline buttons (MVP), C) NLP (Phase 2)**

```typescript
// MVP: –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è –∫–Ω–æ–ø–∫–∞–º–∏ (–≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤)
await this.bot.telegram.sendMessage(
  telegramUser.telegramId,
  `üéâ –ù–∞—á–∏—Å–ª–µ–Ω–æ 285 –±–∞–ª–ª–æ–≤! –í–∞—à –±–∞–ª–∞–Ω—Å: 3,185 –±–∞–ª–ª–æ–≤`,
  {
    reply_markup: {
      inline_keyboard: [
        [
          { text: '‚úÖ –û–∫, —Å–ø–∞—Å–∏–±–æ', callback_data: 'acknowledge' },
          { text: 'üí≥ –ú–æ—è –∫–∞—Ä—Ç–∞', callback_data: 'view_card' },
        ],
        [
          { text: 'üîï –û—Ç–∫–ª—é—á–∏—Ç—å —Ç–∞–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', callback_data: 'disable_balls_earned' },
        ],
      ],
    },
  }
)

// Callback query handler
bot.on('callback_query', async (ctx) => {
  const action = ctx.callbackQuery.data
  
  if (action === 'acknowledge') {
    await ctx.answerCbQuery('üëç') // Toast notification
    await ctx.deleteMessage() // Optional: —É–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ ack
  } else if (action === 'disable_balls_earned') {
    await this.updateNotificationSettings(ctx.from.id, {
      'settings.balls.earned.telegram': false,
    })
    await ctx.answerCbQuery('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –±–∞–ª–ª–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω—ã')
  }
})

// Phase 2: NLP –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
bot.on('text', async (ctx) => {
  const text = ctx.message.text.toLowerCase()
  
  if (text.includes('–æ—Ç–∫–ª—é—á–∏—Ç—å') || text.includes('–Ω–µ —Ö–æ—á—É')) {
    await ctx.reply(
      '–•–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?',
      {
        reply_markup: {
          inline_keyboard: [
            [
              { text: '–î–∞, –æ—Ç–∫–ª—é—á–∏—Ç—å –≤—Å–µ', callback_data: 'disable_all' },
              { text: '–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', callback_data: 'settings' },
            ],
          ],
        },
      }
    )
  }
})
```


***

### **15. Telegram Notification Scheduling (Quiet Hours)**

**–í–û–ü–†–û–°:** –£—á–∏—Ç—ã–≤–∞—Ç—å –ª–∏ "—Ç–∏—Ö–∏–µ —á–∞—Å—ã" (–Ω–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å –Ω–æ—á—å—é)?

- **A)** –î–∞, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å 23:00 –¥–æ 09:00 (local timezone)
- **B)** –î–∞, –Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è LOW priority (HIGH/CRITICAL ‚Äî –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º)
- **C)** Guest –≤—ã–±–∏—Ä–∞–µ—Ç quiet hours –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
- **D)** –ù–µ—Ç (–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É, Telegram notification priority = silent)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Quiet hours –¥–ª—è LOW, instant –¥–ª—è HIGH/CRITICAL**

```typescript
async sendTelegramNotification(dto: SendNotificationDto) {
  const guest = await this.getGuest(dto.recipientId)
  const now = new Date()
  
  // 1. Get guest timezone (from GuestProfile.city or default)
  const timezone = guest.timezone || 'Europe/Moscow'
  const localTime = utcToZonedTime(now, timezone)
  const hour = localTime.getHours()
  
  // 2. Check quiet hours (23:00 - 09:00)
  const isQuietHours = hour >= 23 || hour < 9
  
  // 3. LOW priority + quiet hours ‚Üí schedule for 09:00
  if (dto.priority === 'LOW' && isQuietHours) {
    const scheduledFor = setHours(setMinutes(addDays(localTime, hour >= 23 ? 1 : 0), 0), 9)
    
    await this.notificationQueue.add(
      'send-telegram',
      dto,
      { delay: differenceInMilliseconds(scheduledFor, now) }
    )
    
    this.logger.log(`Notification scheduled for ${scheduledFor} (quiet hours)`)
    return
  }
  
  // 4. HIGH/CRITICAL ‚Üí send immediately (–Ω–æ —Å silent notification)
  await this.bot.telegram.sendMessage(
    telegramUser.telegramId,
    dto.message,
    {
      parse_mode: 'HTML',
      disable_notification: isQuietHours && dto.priority !== 'CRITICAL', // Silent –µ—Å–ª–∏ –Ω–æ—á—å
    }
  )
}
```

**Guest –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**

```json
// GET /api/v1/guests/me/notification-settings
{
  "quietHours": {
    "enabled": true,
    "from": "23:00",
    "to": "09:00",
    "timezone": "Europe/Moscow",
    "applyTo": ["LOW", "NORMAL"] // –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ CRITICAL
  }
}
```


***

## **üîÑ 4. NOTIFICATION DELIVERY \& RETRY (5 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **16. Multi-Channel Priority \& Fallback**

**–í–û–ü–†–û–°:** –í –∫–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ –ø—Ä–æ–±–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª—ã (Telegram, Email, SMS)?

- **A)** Sequential: Telegram ‚Üí Email ‚Üí SMS (–µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π failed)
- **B)** Parallel: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ channels —Å—Ä–∞–∑—É (–ø—É—Å—Ç—å Guest —Å–∞–º –≤—ã–±–µ—Ä–µ—Ç)
- **C)** Priority-based: Guest –≤—ã–±–∏—Ä–∞–µ—Ç preferred channel –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
- **D)** Cost-optimized: Telegram ‚Üí Email ‚Üí SMS (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **C) Priority-based + D) Cost fallback**

```typescript
// Guest notification settings
{
  "balls": {
    "earned": {
      "channels": ["TELEGRAM", "EMAIL"], // Ordered by preference
      "fallback": true // –ï—Å–ª–∏ Telegram failed ‚Üí –ø—Ä–æ–±—É–µ–º Email
    }
  }
}

async sendNotification(dto: SendNotificationDto) {
  const settings = await this.getNotificationSettings(dto.recipientId)
  const notifConfig = settings[dto.type] // e.g., settings.balls.earned
  
  // 1. Try preferred channels in order
  for (const channel of notifConfig.channels) {
    try {
      if (channel === 'TELEGRAM') {
        await this.sendTelegram(dto)
        await this.trackDelivery(dto.id, 'TELEGRAM', 'DELIVERED')
        return // Success
      } else if (channel === 'EMAIL') {
        await this.sendEmail(dto)
        await this.trackDelivery(dto.id, 'EMAIL', 'DELIVERED')
        return
      } else if (channel === 'SMS') {
        await this.sendSms(dto)
        await this.trackDelivery(dto.id, 'SMS', 'DELIVERED')
        return
      }
    } catch (error) {
      this.logger.warn(`Channel ${channel} failed for notification ${dto.id}`)
      
      // If fallback disabled ‚Üí stop here
      if (!notifConfig.fallback) {
        throw error
      }
      
      // Continue to next channel
      continue
    }
  }
  
  // 2. All channels failed
  throw new Error('All notification channels failed')
}
```


***

### **17. Notification Deduplication (–∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)**

**–í–û–ü–†–û–°:** –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2 —Ä–∞–∑–∞ "–ù–∞—á–∏—Å–ª–µ–Ω–æ 285 –±–∞–ª–ª–æ–≤")?

- **A)** Idempotency key (hash –æ—Ç type + recipientId + data)
- **B)** TTL-based deduplication (–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ 5 –º–∏–Ω—É—Ç)
- **C)** Database constraint (UNIQUE –Ω–∞ type + recipientId + createdAt::date)
- **D)** –ù–µ –Ω—É–∂–Ω–æ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) TTL-based deduplication (Redis)**

```typescript
async sendNotification(dto: SendNotificationDto) {
  // 1. Generate deduplication key
  const dedupKey = `notification:dedup:${dto.type}:${dto.recipientId}:${hash(dto.data)}`
  
  // 2. Check if already sent recently (TTL 5 min)
  const alreadySent = await this.redis.get(dedupKey)
  if (alreadySent) {
    this.logger.warn(`Duplicate notification detected: ${dto.type} for ${dto.recipientId}`)
    return // Skip sending
  }
  
  // 3. Send notification
  await this.sendViaChannel(dto)
  
  // 4. Mark as sent (TTL 5 min)
  await this.redis.setex(dedupKey, 300, '1')
}

// Hash function –¥–ª—è data
function hash(data: any): string {
  return createHash('md5').update(JSON.stringify(data)).digest('hex').substring(0, 8)
}
```

**–ü—Ä–∏–º–µ—Ä:** –ï—Å–ª–∏ Backend —Å–ª—É—á–∞–π–Ω–æ –≤—ã–∑–æ–≤–µ—Ç `sendNotification("BALLS_EARNED", { amount: 285 })` –¥–≤–∞–∂–¥—ã –∑–∞ 5 –º–∏–Ω—É—Ç ‚Üí –æ—Ç–ø—Ä–∞–≤–∏–º —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑.

***

### **18. Batch Notifications (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞)**

**–í–û–ü–†–û–°:** –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ª–∏ LOW priority —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±–∞—Ç—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–£ –≤–∞—Å 3 –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")?

- **A)** –î–∞, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ç–∏–ø—É (3x "–ù–∞—á–∏—Å–ª–µ–Ω–æ –±–∞–ª–ª–æ–≤" ‚Üí "–ù–∞—á–∏—Å–ª–µ–Ω–æ –±–∞–ª–ª–æ–≤ 3 —Ä–∞–∑–∞")
- **B)** –î–∞, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë (digest email —Ä–∞–∑ –≤ –¥–µ–Ω—å)
- **C)** –ù–µ—Ç (–∫–∞–∂–¥–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ)
- **D)** –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (Guest –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∏—Ç—å "Digest mode" –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ LOW priority (Telegram/Email)**

```typescript
// CRON job: –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
@Cron('0,30 * * * *') // Every 30 minutes
async sendBatchedNotifications() {
  // 1. –ù–∞–π—Ç–∏ –≤—Å–µ LOW priority notifications –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –º–∏–Ω—É—Ç
  const pendingNotifications = await this.prisma.notification.findMany({
    where: {
      priority: 'LOW',
      status: 'PENDING',
      createdAt: { gte: subMinutes(new Date(), 30) },
    },
    orderBy: { createdAt: 'asc' },
  })
  
  // 2. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ userId
  const grouped = groupBy(pendingNotifications, 'recipientId')
  
  for (const [userId, notifications] of Object.entries(grouped)) {
    // Skip –µ—Å–ª–∏ < 3 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ—Ç–ø—Ä–∞–≤–∏–º –ø–æ –æ–¥–Ω–æ–º—É)
    if (notifications.length < 3) continue
    
    // 3. –°–æ–∑–¥–∞—ë–º digest notification
    const digestMessage = this.formatDigest(notifications)
    
    await this.bot.telegram.sendMessage(
      userId,
      digestMessage,
      {
        parse_mode: 'HTML',
        reply_markup: {
          inline_keyboard: [
            [{ text: 'üì¨ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ', callback_data: 'view_notifications' }],
          ],
        },
      }
    )
    
    // 4. Mark notifications as DELIVERED
    await this.prisma.notification.updateMany({
      where: { id: { in: notifications.map(n => n.id) } },
      data: { status: 'DELIVERED', sentAt: new Date() },
    })
  }
}

function formatDigest(notifications: Notification[]): string {
  const summary = notifications.reduce((acc, n) => {
    acc[n.type] = (acc[n.type] || 0) + 1
    return acc
  }, {} as Record<string, number>)
  
  const lines = Object.entries(summary).map(([type, count]) => 
    `‚Ä¢ ${getNotificationTypeLabel(type)}: ${count} —à—Ç.`
  )
  
  return `
üì¨ <b>–£ –≤–∞—Å ${notifications.length} –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:</b>

${lines.join('\n')}

–ù–∞–∂–º–∏—Ç–µ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ" —á—Ç–æ–±—ã –ø—Ä–æ—á–∏—Ç–∞—Ç—å.
  `.trim()
}
```

**Guest –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**

```json
{
  "batchMode": {
    "enabled": true,
    "minBatchSize": 3, // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ >= 3 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    "batchInterval": 30 // –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å batch –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
  }
}
```


***

### **19. Retry Logic (–¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è)**

**–í–û–ü–†–û–°:** –î–µ—Ç–∞–ª—å–Ω–∞—è retry —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö failure types?

- **A)** Exponential backoff: 1min ‚Üí 2min ‚Üí 4min ‚Üí 8min
- **B)** Adaptive retry (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç error code: 500 ‚Üí retry, 400 ‚Üí no retry)
- **C)** Circuit breaker (–µ—Å–ª–∏ provider fails 10 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ ‚Üí –ø–∞—É–∑–∞ 10 –º–∏–Ω—É—Ç)
- **D)** –ö–æ–º–±–æ: B + C

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Adaptive retry + Circuit breaker**

```typescript
// BullMQ processor with adaptive retry
@Process('send-notification')
async processNotification(job: Job<SendNotificationDto>) {
  try {
    await this.sendViaChannel(job.data)
  } catch (error) {
    // 1. Categorize error
    const errorCategory = this.categorizeError(error)
    
    // 2. Decide if should retry
    if (errorCategory === 'CLIENT_ERROR') {
      // 4xx errors (invalid phone, bad request) ‚Üí no retry
      throw new UnrecoverableError(error.message)
    }
    
    if (errorCategory === 'SERVER_ERROR') {
      // 5xx errors (provider down, timeout) ‚Üí retry with backoff
      if (job.attemptsMade < 3) {
        throw error // BullMQ will retry with exponential backoff
      }
    }
    
    if (errorCategory === 'RATE_LIMIT') {
      // 429 Too Many Requests ‚Üí retry after delay
      const retryAfter = error.response?.headers['retry-after'] || 60
      throw new DelayedError(error.message, retryAfter * 1000)
    }
    
    // 3. All retries exhausted ‚Üí mark as FAILED
    await this.prisma.notification.update({
      where: { id: job.data.notificationId },
      data: { status: 'FAILED', errorMessage: error.message },
    })
  }
}

categorizeError(error: any): 'CLIENT_ERROR' | 'SERVER_ERROR' | 'RATE_LIMIT' | 'NETWORK_ERROR' {
  if (error.response) {
    const status = error.response.status
    if (status >= 400 && status < 500) return 'CLIENT_ERROR'
    if (status === 429) return 'RATE_LIMIT'
    if (status >= 500) return 'SERVER_ERROR'
  }
  return 'NETWORK_ERROR'
}

// Circuit breaker (Redis)
async checkCircuitBreaker(provider: string): Promise<boolean> {
  const failureKey = `circuit:${provider}:failures`
  const failures = await this.redis.get(failureKey)
  
  if (failures && parseInt(failures) >= 10) {
    // Circuit is OPEN (provider unavailable)
    const lockKey = `circuit:${provider}:lock`
    const lockExists = await this.redis.exists(lockKey)
    
    if (lockExists) {
      throw new Error(`Circuit breaker OPEN for ${provider} (cooling down)`)
    }
    
    // Reset after 10 minutes
    await this.redis.del(failureKey)
  }
  
  return true
}

// Track failures
async trackFailure(provider: string) {
  const failureKey = `circuit:${provider}:failures`
  await this.redis.incr(failureKey)
  await this.redis.expire(failureKey, 600) // 10 min window
  
  const failures = await this.redis.get(failureKey)
  
  if (parseInt(failures) >= 10) {
    // Open circuit for 10 minutes
    const lockKey = `circuit:${provider}:lock`
    await this.redis.setex(lockKey, 600, '1')
    
    this.logger.error(`Circuit breaker OPEN for ${provider} (10 failures in 10 min)`)
  }
}
```


***

### **20. Dead Letter Queue (DLQ) handling**

**–í–û–ü–†–û–°:** –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å failed notifications –ø–æ—Å–ª–µ –≤—Å–µ—Ö retries?

- **A)** Dead Letter Queue (DLQ) –¥–ª—è manual review (Admin –≤–∏–¥–∏—Ç failed notifications)
- **B)** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å fallback notification ("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ—Å—Ç–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ")
- **C)** –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤ Sentry + email alert –¥–ª—è DevOps
- **D)** –ö–æ–º–±–æ: A + C

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) DLQ + Monitoring**

```typescript
// BullMQ DLQ setup
BullModule.registerQueue({
  name: QueueName.NOTIFICATIONS,
  defaultJobOptions: {
    attempts: 3,
    backoff: { type: 'exponential', delay: 60000 },
    removeOnComplete: 1000,
    removeOnFail: false, // Keep failed jobs in queue
  },
})

// Failed job handler
@OnQueueFailed()
async handleFailedJob(job: Job, error: Error) {
  // 1. Move to DLQ
  await this.prisma.notificationDLQ.create({
    data: {
      notificationId: job.data.notificationId,
      recipientId: job.data.recipientId,
      type: job.data.type,
      channel: job.data.channel,
      payload: job.data,
      errorMessage: error.message,
      attempts: job.attemptsMade,
      failedAt: new Date(),
    },
  })
  
  // 2. Alert DevOps (Sentry)
  Sentry.captureException(error, {
    tags: {
      notificationType: job.data.type,
      channel: job.data.channel,
    },
    extra: {
      jobId: job.id,
      recipientId: job.data.recipientId,
    },
  })
  
  // 3. Alert Admin (if CRITICAL)
  if (job.data.priority === 'CRITICAL') {
    await this.sendAdminAlert({
      title: 'CRITICAL notification failed',
      description: `Failed to deliver ${job.data.type} to ${job.data.recipientId}`,
      severity: 'ERROR',
    })
  }
  
  // 4. Fallback: inform Guest (if possible)
  if (job.data.channel !== 'EMAIL') {
    try {
      await this.sendEmail({
        to: job.data.recipientEmail,
        subject: '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ—Å—Ç–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ',
        text: `–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º—ã –Ω–µ —Å–º–æ–≥–ª–∏ –¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${job.data.channel}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.`,
      })
    } catch (e) {
      // Email fallback failed too ‚Üí just log
    }
  }
}

// Admin UI: DLQ Dashboard
// GET /api/v1/admin/notifications/dlq
{
  "total": 24,
  "items": [
    {
      "id": "dlq-123",
      "notificationType": "BALLS_EARNED",
      "channel": "SMS",
      "recipientPhone": "+7999***4567",
      "errorMessage": "Provider timeout",
      "attempts": 3,
      "failedAt": "2026-02-10T14:30:00Z",
      "actions": {
        "retry": "/api/v1/admin/notifications/dlq/dlq-123/retry",
        "dismiss": "/api/v1/admin/notifications/dlq/dlq-123/dismiss"
      }
    }
  ]
}
```

**Admin Actions:**

- **Retry** ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (manual trigger)
- **Dismiss** ‚Üí —É–¥–∞–ª–∏—Ç—å –∏–∑ DLQ (–ø—Ä–∏–∑–Ω–∞—Ç—å –ø—Ä–æ–≤–∞–ª)
- **Change Channel** ‚Üí –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –∫–∞–Ω–∞–ª (SMS ‚Üí Email)

***

## **üìù 5. TEMPLATES \& LOCALIZATION (4 –≤–æ–ø—Ä–æ—Å–∞)**

### **21. Template Engine –≤—ã–±–æ—Ä**

**–í–û–ü–†–û–°:** –ö–∞–∫–æ–π template engine –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è dynamic content (–∏–º—è –≥–æ—Å—Ç—è, –±–∞–ª–ª—ã, etc.)?

- **A)** React Email (–¥–ª—è emails) + Template literals (–¥–ª—è SMS/Telegram)
- **B)** Handlebars (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π: `{{guestName}}`)
- **C)** Database-stored templates (Admin –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ UI)
- **D)** –ö–æ–º–±–æ: A) –¥–ª—è code, C) –¥–ª—è customization

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) React Email + DB-stored custom templates**

```typescript
// 1. Code-based templates (React Email)
// libs/notifications/src/templates/emails/BallsEarnedEmail.tsx
export default function BallsEarnedEmail(props: BallsEarnedEmailProps) {
  // ... React component (—Å–º. –≤–æ–ø—Ä–æ—Å #2)
}

// 2. DB-stored custom templates (–¥–ª—è Tenant customization)
model NotificationTemplate {
  id String @id @default(uuid())
  tenantId String
  type NotificationType // BALLS_EARNED, LEVEL_UPGRADED, etc.
  channel NotificationChannel // EMAIL, SMS, TELEGRAM
  locale String @default("ru") // ru, en
  
  // Custom template (nullable = use default code-based template)
  customSubject String?
  customBody String? // Handlebars template with {{variables}}
  
  // Variables metadata
  availableVariables Json // ["guestName", "amount", "balance", etc.]
  
  isActive Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([tenantId, type, channel, locale])
}

// Usage
async sendNotification(dto: SendNotificationDto) {
  // 1. Check if tenant has custom template
  const customTemplate = await this.prisma.notificationTemplate.findUnique({
    where: {
      tenantId_type_channel_locale: {
        tenantId: dto.tenantId,
        type: dto.type,
        channel: dto.channel,
        locale: dto.locale,
      },
    },
  })
  
  if (customTemplate && customTemplate.isActive) {
    // 2. Use custom template (Handlebars)
    const template = Handlebars.compile(customTemplate.customBody)
    const message = template(dto.data) // {{guestName}} ‚Üí –ò–≤–∞–Ω
    
    await this.sendViaChannel(dto.channel, message)
  } else {
    // 3. Use default code-based template
    const defaultMessage = this.getDefaultTemplate(dto.type, dto.data)
    await this.sendViaChannel(dto.channel, defaultMessage)
  }
}
```

**Admin UI: Template Editor**

```tsx
// Admin Panel: /settings/notifications/templates
<TemplateEditor
  type="BALLS_EARNED"
  channel="TELEGRAM"
  availableVariables={['guestName', 'amount', 'balance', 'checkAmount', 'restaurant']}
  defaultTemplate="üéâ –ù–∞—á–∏—Å–ª–µ–Ω–æ {{amount}} –±–∞–ª–ª–æ–≤! –í–∞—à –±–∞–ª–∞–Ω—Å: {{balance}} –±–∞–ª–ª–æ–≤"
  onSave={(customTemplate) => saveCustomTemplate(customTemplate)}
/>

{/* Live Preview */}
<TemplatePreview
  template={customTemplate}
  mockData={{ guestName: '–ò–≤–∞–Ω', amount: 285, balance: 3185 }}
/>
```


***

### **22. Localization (ru/en)**

**–í–û–ü–†–û–°:** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ª–∏ multi-language notifications?

- **A)** –î–∞, ru + en (Guest –≤—ã–±–∏—Ä–∞–µ—Ç —è–∑—ã–∫ –≤ –ø—Ä–æ—Ñ–∏–ª–µ)
- **B)** –¢–æ–ª—å–∫–æ ru (MVP)
- **C)** Auto-detect (–ø–æ GuestProfile.locale –∏–ª–∏ Accept-Language header)
- **D)** Phase 2 (–ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ ru)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Phase 2, –Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É**

```typescript
// Prisma schema
model GuestProfile {
  userId String @unique
  // ...
  locale String @default("ru") // ru, en, es, ...
}

// Notification templates structure (i18n-ready)
// libs/notifications/src/templates/i18n.ts
export const notificationTranslations = {
  ru: {
    BALLS_EARNED: {
      title: '–ù–∞—á–∏—Å–ª–µ–Ω–æ {{amount}} –±–∞–ª–ª–æ–≤!',
      message: '–ó–∞ —á–µ–∫ –Ω–∞ —Å—É–º–º—É {{checkAmount}} ‚ÇΩ –≤ {{restaurant}} –≤–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ {{amount}} –±–∞–ª–ª–æ–≤.',
    },
    LEVEL_UPGRADED: {
      title: '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: {{level}}',
      message: '–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —É—Ä–æ–≤–Ω—è {{level}}! –¢–µ–ø–µ—Ä—å –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ {{earnPercentage}}% –±–∞–ª–ª–æ–≤.',
    },
  },
  en: {
    BALLS_EARNED: {
      title: 'Earned {{amount}} points!',
      message: 'You earned {{amount}} points for a {{checkAmount}} ‚ÇΩ check at {{restaurant}}.',
    },
    LEVEL_UPGRADED: {
      title: 'Congratulations! New level: {{level}}',
      message: 'You reached {{level}} level! Now you earn {{earnPercentage}}% points.',
    },
  },
}

// Usage
function getLocalizedTemplate(type: NotificationType, locale: string, data: any): string {
  const template = notificationTranslations[locale]?.[type] || notificationTranslations['ru'][type]
  const compiled = Handlebars.compile(template.message)
  return compiled(data)
}
```

**MVP:** –¢–æ–ª—å–∫–æ `ru`, –Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è `en` –≤ Phase 2.

***

### **23. Dynamic Content (–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è)**

**–í–û–ü–†–û–°:** –ö–∞–∫—É—é –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é –¥–æ–±–∞–≤–ª—è—Ç—å –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?

- **A)** –ë–∞–∑–æ–≤–∞—è: –∏–º—è –≥–æ—Å—Ç—è, –±–∞–ª–ª—ã, —É—Ä–æ–≤–µ–Ω—å
- **B)** Recommendations: "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–æ–≤–æ–µ –±–ª—é–¥–æ –•" (ML-based)
- **C)** Gamification: "–í—ã –≤ —Ç–æ–ø-10% –≥–æ—Å—Ç–µ–π –ø–æ —á–∞—Å—Ç–æ—Ç–µ –≤–∏–∑–∏—Ç–æ–≤!"
- **D)** –ö–æ–º–±–æ: A (MVP), B+C (Phase 2)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) –ë–∞–∑–æ–≤–∞—è (MVP), Advanced (Phase 2)**

```typescript
// MVP: –ë–∞–∑–æ–≤–∞—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
interface NotificationData {
  guestName: string
  amount: number
  balance: number
  level: string
  restaurant: {
    name: string
    logo: string
  }
}

// Phase 2: Advanced –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
interface AdvancedNotificationData extends NotificationData {
  recommendations?: {
    dishes: Array<{ name: string, discount: number }>
    promos: Array<{ title: string, expiresAt: Date }>
  }
  gamification?: {
    rank: number // –í–∞—à–µ –º–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
    percentile: number // –¢–æ–ø 10%
    achievements: Array<{ title: string, unlockedAt: Date }>
  }
  nextLevelProgress?: {
    current: number
    target: number
    percentage: number
  }
}

// Example: Notification —Å recommendations
await this.sendNotification({
  type: 'BALLS_EARNED',
  recipientId: guest.userId,
  data: {
    guestName: guest.firstName,
    amount: 285,
    balance: 3185,
    recommendations: {
      dishes: [
        { name: '–¢–æ–º –Ø–º', discount: 10 }, // ML recommendation
      ],
      promos: [
        { title: '500 –±–æ–Ω—É—Å–æ–≤ –Ω–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π', expiresAt: addDays(guest.birthdate, 7) },
      ],
    },
    nextLevelProgress: {
      current: 152000,
      target: 400000,
      percentage: 38,
    },
  },
})
```

**Telegram message —Å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π:**

```
üéâ –ù–∞—á–∏—Å–ª–µ–Ω–æ 285 –±–∞–ª–ª–æ–≤!

–í–∞—à –±–∞–ª–∞–Ω—Å: 3,185 –±–∞–ª–ª–æ–≤
–£—Ä–æ–≤–µ–Ω—å: Silver

üìà –î–æ Gold –æ—Å—Ç–∞–ª–æ—Å—å 62% (248,000 ‚ÇΩ)

üçú –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:
‚Ä¢ –¢–æ–º –Ø–º (—Å–∫–∏–¥–∫–∞ 10% –±–∞–ª–ª–∞–º–∏)

üéÅ –°–∫–æ—Ä–æ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è! –ü–æ–ª—É—á–∏—Ç–µ 500 –±–æ–Ω—É—Å–æ–≤ —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π.
```


***

### **24. Template Variables Validation**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ custom templates —Å–æ–¥–µ—Ä–∂–∞—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ?

- **A)** –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ (–ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ `{{variables}}` —Å—É—â–µ—Å—Ç–≤—É—é—Ç)
- **B)** Preview —Å mock data (Admin –≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º)
- **C)** Runtime validation (–µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí fallback –Ω–∞ default)
- **D)** –ö–æ–º–±–æ: A + B + C

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) –ö–æ–º–±–æ**

```typescript
// Admin UI: Template Editor
async function validateTemplate(template: string, availableVariables: string[]) {
  // 1. Extract variables from template
  const regex = /\{\{(\w+)\}\}/g
  const usedVariables = [...template.matchAll(regex)].map(match => match[^4_1])
  
  // 2. Check if all used variables are available
  const invalidVariables = usedVariables.filter(v => !availableVariables.includes(v))
  
  if (invalidVariables.length > 0) {
    throw new ValidationError(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: ${invalidVariables.join(', ')}`)
  }
  
  // 3. Compile template (check syntax)
  try {
    Handlebars.compile(template)
  } catch (error) {
    throw new ValidationError(`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞: ${error.message}`)
  }
  
  return { valid: true }
}

// Preview with mock data
<TemplatePreview
  template={customTemplate}
  mockData={{
    guestName: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',
    amount: 285,
    balance: 3185,
    checkAmount: 2850,
    restaurant: '–°—É—à–∏–ª–∫–∞',
  }}
  onValidate={(isValid) => setIsValid(isValid)}
/>

// Runtime: fallback –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
function renderTemplate(template: string, data: any): string {
  const compiled = Handlebars.compile(template)
  
  // Provide defaults for missing variables
  const safeData = new Proxy(data, {
    get(target, prop) {
      return target[prop] ?? `[${String(prop)}]` // Fallback: [variableName]
    },
  })
  
  return compiled(safeData)
}
```


***

## **üìä 6. ANALYTICS \& MONITORING (4 –≤–æ–ø—Ä–æ—Å–∞)**

### **25. Notification Analytics (–º–µ—Ç—Ä–∏–∫–∏)**

**–í–û–ü–†–û–°:** –ö–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–∏—Ä–∞—Ç—å –¥–ª—è notification system?

- **A)** Delivery rate (sent / delivered / failed)
- **B)** Open rate (–¥–ª—è email/Telegram tracking pixel)
- **C)** Click rate (–¥–ª—è links –≤ notifications)
- **D)** Conversion rate (–ø–æ—Å–ª–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Guest —Å–¥–µ–ª–∞–ª –¥–µ–π—Å—Ç–≤–∏–µ)
- **E)** –í—Å–µ –≤—ã—à–µ

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **E) Comprehensive analytics**

```typescript
// Prisma schema
model NotificationAnalytics {
  id String @id @default(uuid())
  tenantId String
  notificationId String
  notification Notification @relation(...)
  
  // Delivery metrics
  sentAt DateTime?
  deliveredAt DateTime?
  failedAt DateTime?
  errorMessage String?
  
  // Engagement metrics (Email/Telegram)
  openedAt DateTime?
  clickedAt DateTime?
  clickedUrl String?
  
  // Conversion metrics
  convertedAt DateTime? // Guest –≤—ã–ø–æ–ª–Ω–∏–ª —Ü–µ–ª–µ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
  conversionType String? // "VIEW_BALANCE", "REDEEM_BALLS", "VISIT_RESTAURANT"
  conversionValue Decimal? // –°—É–º–º–∞ —á–µ–∫–∞ –ø–æ—Å–ª–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  
  // Metadata
  channel NotificationChannel
  priority NotificationPriority
  userAgent String?
  ipAddress String?
  
  createdAt DateTime @default(now())
  
  @@index([tenantId, createdAt])
  @@index([notificationId])
}

// Analytics API
@Get('/api/v1/analytics/notifications')
async getNotificationAnalytics(@Query() query: AnalyticsQueryDto) {
  const analytics = await this.prisma.notificationAnalytics.groupBy({
    by: ['channel', 'priority'],
    where: {
      tenantId: query.tenantId,
      createdAt: {
        gte: query.dateFrom,
        lte: query.dateTo,
      },
    },
    _count: {
      id: true, // Total sent
      deliveredAt: true, // Delivered
      openedAt: true, // Opened
      clickedAt: true, // Clicked
      convertedAt: true, // Converted
    },
  })
  
  return {
    byChannel: analytics.map(a => ({
      channel: a.channel,
      sent: a._count.id,
      delivered: a._count.deliveredAt,
      opened: a._count.openedAt,
      clicked: a._count.clickedAt,
      converted: a._count.convertedAt,
      deliveryRate: (a._count.deliveredAt / a._count.id) * 100,
      openRate: (a._count.openedAt / a._count.deliveredAt) * 100,
      clickRate: (a._count.clickedAt / a._count.openedAt) * 100,
      conversionRate: (a._count.convertedAt / a._count.id) * 100,
    })),
  }
}
```

**Dashboard:**

```
Notification Analytics (Last 30 Days)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Channel    Sent  Delivered  Opened  Clicked  Converted
Telegram   1,234   1,198     876      312       89
Email        567     534     298       87       23
SMS          234     229      ‚Äî        ‚Äî        12

Delivery Rate: 96.8%
Open Rate: 58.5% (Telegram), 55.8% (Email)
Click Rate: 35.6% (Telegram), 29.2% (Email)
Conversion Rate: 7.2% (Telegram), 4.1% (Email), 5.1% (SMS)
```


***

### **26. A/B Testing –¥–ª—è notifications**

**–í–û–ü–†–û–°:** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ª–∏ A/B —Ç–µ—Å—Ç—ã (—Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)?

- **A)** –î–∞, –≤–∞—Ä–∏–∞–Ω—Ç—ã A/B –¥–ª—è subject/message (50/50 split)
- **B)** –î–∞, –Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è marketing campaigns (–Ω–µ transactional)
- **C)** –ù–µ—Ç (MVP), Phase 2
- **D)** –î–∞, –Ω–æ manual setup (Admin –≤—ã–±–∏—Ä–∞–µ—Ç variant –≤—Ä—É—á–Ω—É—é)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **C) Phase 2, –Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É**

```typescript
// Phase 2: A/B Testing —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
model NotificationVariant {
  id String @id @default(uuid())
  campaignId String
  campaign NotificationCampaign @relation(...)
  
  name String // "Variant A", "Variant B"
  weight Int @default(50) // 50% traffic
  
  subject String? // Email subject
  message String // Notification body
  
  // Performance metrics
  sentCount Int @default(0)
  openedCount Int @default(0)
  clickedCount Int @default(0)
  convertedCount Int @default(0)
  
  isActive Boolean @default(true)
  createdAt DateTime @default(now())
}

// Usage
async sendCampaignNotification(campaign: NotificationCampaign, guest: Guest) {
  // 1. Select variant based on weight
  const variant = await this.selectVariant(campaign.variants)
  
  // 2. Send notification
  await this.sendNotification({
    recipientId: guest.userId,
    message: variant.message,
    metadata: {
      campaignId: campaign.id,
      variantId: variant.id,
    },
  })
  
  // 3. Track variant performance
  await this.prisma.notificationVariant.update({
    where: { id: variant.id },
    data: { sentCount: { increment: 1 } },
  })
}

// Winner selection (after 1000 sends)
async determineWinner(campaignId: string) {
  const variants = await this.prisma.notificationVariant.findMany({
    where: { campaignId },
  })
  
  const winner = variants.reduce((best, current) => {
    const bestRate = (best.convertedCount / best.sentCount) * 100
    const currentRate = (current.convertedCount / current.sentCount) * 100
    return currentRate > bestRate ? current : best
  })
  
  return winner
}
```


***

### **27. Cost Tracking \& Budget Alerts**

**–í–û–ü–†–û–°:** –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ª–∏ –±—é–¥–∂–µ—Ç –Ω–∞ notifications (SMS –¥–æ—Ä–æ–≥–∏–µ)?

- **A)** –î–∞, track cost per tenant per month
- **B)** –î–∞ + alert Admin –∫–æ–≥–¥–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, ‚ÇΩ5000/–º–µ—Å—è—Ü)
- **C)** –î–∞ + –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –Ω–∞ –¥–µ—à—ë–≤—ã–µ –∫–∞–Ω–∞–ª—ã (SMS ‚Üí Telegram)
- **D)** –ö–æ–º–±–æ: A + B + C

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Comprehensive cost management**

```typescript
// Cost tracking
model NotificationCost {
  id String @id @default(uuid())
  tenantId String
  month String // "2026-02"
  
  // Costs by channel
  smsCost Decimal @default(0) @db.Decimal(10, 2)
  emailCost Decimal @default(0) @db.Decimal(10, 2)
  telegramCost Decimal @default(0) @db.Decimal(10, 2) // Always 0
  
  // Counts
  smsCount Int @default(0)
  emailCount Int @default(0)
  telegramCount Int @default(0)
  
  totalCost Decimal @default(0) @db.Decimal(10, 2)
  
  @@unique([tenantId, month])
}

// Track cost after sending
async trackNotificationCost(tenantId: string, channel: string, cost: number) {
  const month = format(new Date(), 'yyyy-MM')
  
  await this.prisma.notificationCost.upsert({
    where: { tenantId_month: { tenantId, month } },
    create: {
      tenantId,
      month,
      [`${channel.toLowerCase()}Cost`]: cost,
      [`${channel.toLowerCase()}Count`]: 1,
      totalCost: cost,
    },
    update: {
      [`${channel.toLowerCase()}Cost`]: { increment: cost },
      [`${channel.toLowerCase()}Count`]: { increment: 1 },
      totalCost: { increment: cost },
    },
  })
  
  // Check budget limit
  const totalCost = await this.getTotalCost(tenantId, month)
  const budgetLimit = await this.getTenantBudgetLimit(tenantId) // e.g., ‚ÇΩ5000/month
  
  if (totalCost >= budgetLimit * 0.9) {
    // 90% of budget reached ‚Üí alert Admin
    await this.notificationService.sendAdminAlert({
      tenantId,
      title: 'Notification budget warning',
      message: `You have spent ${totalCost} out of ${budgetLimit} this month (90%)`,
      severity: 'WARNING',
    })
  }
  
  if (totalCost >= budgetLimit) {
    // Budget exceeded ‚Üí switch to cost-saving mode
    await this.enableCostSavingMode(tenantId)
  }
}

// Cost-saving mode (prefer Telegram over SMS)
async enableCostSavingMode(tenantId: string) {
  await this.prisma.tenant.update({
    where: { id: tenantId },
    data: {
      notificationSettings: {
        costSavingMode: true,
        preferredChannel: 'TELEGRAM', // Fallback to Email, avoid SMS
      },
    },
  })
  
  this.logger.warn(`Cost-saving mode enabled for tenant ${tenantId}`)
}
```

**Admin UI: Cost Dashboard**

```
Notification Costs (February 2026)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Channel     Count    Cost    Avg Cost
Telegram    1,234    ‚ÇΩ0      ‚ÇΩ0
Email         567    ‚ÇΩ28     ‚ÇΩ0.05
SMS           234    ‚ÇΩ234    ‚ÇΩ1.00

Total: ‚ÇΩ262 / ‚ÇΩ5,000 budget (5.2%)
```


***

### **28. Monitoring \& Alerting (Sentry, Prometheus)**

**–í–û–ü–†–û–°:** –ö–∞–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å notification system health?

- **A)** Sentry –¥–ª—è errors + exceptions
- **B)** Prometheus + Grafana –¥–ª—è –º–µ—Ç—Ä–∏–∫ (delivery rate, latency)
- **C)** Custom alerts (–µ—Å–ª–∏ delivery rate < 95% ‚Üí alert DevOps)
- **D)** –ö–æ–º–±–æ: A + B + C

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Comprehensive monitoring**

```typescript
// 1. Sentry –¥–ª—è errors
try {
  await this.emailProvider.send(dto)
} catch (error) {
  Sentry.captureException(error, {
    tags: {
      notificationType: dto.type,
      channel: dto.channel,
      tenantId: dto.tenantId,
    },
    extra: {
      recipientId: dto.recipientId,
    },
  })
  throw error
}

// 2. Prometheus metrics
import { Counter, Histogram } from 'prom-client'

const notificationsSentCounter = new Counter({
  name: 'notifications_sent_total',
  help: 'Total notifications sent',
  labelNames: ['channel', 'type', 'priority'],
})

const notificationsDeliveredCounter = new Counter({
  name: 'notifications_delivered_total',
  help: 'Total notifications delivered',
  labelNames: ['channel', 'type'],
})

const notificationLatencyHistogram = new Histogram({
  name: 'notification_latency_seconds',
  help: 'Notification delivery latency',
  labelNames: ['channel'],
  buckets: [0.1, 0.5, 1, 2, 5, 10],
})

// Track metrics
async sendNotification(dto: SendNotificationDto) {
  const start = Date.now()
  
  notificationsSentCounter.inc({ 
    channel: dto.channel, 
    type: dto.type, 
    priority: dto.priority 
  })
  
  try {
    await this.sendViaChannel(dto)
    
    notificationsDeliveredCounter.inc({ channel: dto.channel, type: dto.type })
    
    const latency = (Date.now() - start) / 1000
    notificationLatencyHistogram.observe({ channel: dto.channel }, latency)
  } catch (error) {
    // ...
  }
}

// 3. Custom alerts (Prometheus Alertmanager)
# alertmanager.yml
groups:
  - name: notifications
    interval: 1m
    rules:
      - alert: LowDeliveryRate
        expr: |
          (
            rate(notifications_delivered_total[5m]) 
            / rate(notifications_sent_total[5m])
          ) < 0.95
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Notification delivery rate below 95%"
          description: "{{ $labels.channel }} delivery rate is {{ $value }}%"
      
      - alert: HighNotificationLatency
        expr: |
          histogram_quantile(0.95, rate(notification_latency_seconds_bucket[5m])) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "95th percentile latency > 5 seconds"
          description: "{{ $labels.channel }} latency is {{ $value }}s"
```

**Grafana Dashboard:**

```
Notification System Health
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Delivery Rate (24h): 96.8% ‚úì
Average Latency: 0.8s ‚úì
Failed Notifications: 24 (1.2%)

By Channel:
- Telegram: 98.2% delivery, 0.3s latency
- Email: 95.1% delivery, 1.2s latency
- SMS: 97.9% delivery, 2.5s latency

Alerts:
- [WARNING] Email delivery rate < 95% (last 10 min)
```


***

## **üîí 7. SECURITY \& COMPLIANCE (4 –≤–æ–ø—Ä–æ—Å–∞)**

### **29. Notification Content Security (XSS, injection)**

**–í–û–ü–†–û–°:** –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å –æ—Ç XSS/injection –≤ notification content?

- **A)** Sanitize –≤—Å–µ user-generated content (DOMPurify –¥–ª—è HTML)

```
- **B)** Whitelist —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö HTML —Ç–µ–≥–æ–≤ (—Ç–æ–ª—å–∫–æ `<b>`, `<i>`, `<a>`)
```

- **C)** Escape –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ templates
- **D)** –ö–æ–º–±–æ: A + B + C

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Multi-layer security**

```typescript
import DOMPurify from 'isomorphic-dompurify'
import { escape } from 'lodash'

// 1. Sanitize HTML content (for emails)
function sanitizeHtml(html: string): string {
  return DOMPurify.sanitize(html, {
    ALLOWED_TAGS: ['b', 'i', 'u', 'a', 'br', 'p', 'strong', 'em'],
    ALLOWED_ATTR: ['href', 'target'],
  })
}

// 2. Escape variables in templates
function renderSafeTemplate(template: string, data: Record<string, any>): string {
  // Escape all variables before rendering
  const safeData = Object.entries(data).reduce((acc, [key, value]) => {
    acc[key] = typeof value === 'string' ? escape(value) : value
    return acc
  }, {} as Record<string, any>)
  
  const compiled = Handlebars.compile(template)
  return compiled(safeData)
}

// 3. Validate custom templates (–ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏)
async validateCustomTemplate(template: string) {
  // Check for dangerous patterns
  const dangerousPatterns = [
    /<script/i,
    /javascript:/i,
    /on\w+=/i, // onclick, onerror, etc.
    /data:text\/html/i,
  ]
  
  for (const pattern of dangerousPatterns) {
    if (pattern.test(template)) {
      throw new ValidationError('Template contains potentially dangerous content')
    }
  }
  
  return true
}

// 4. CSP headers –¥–ª—è email HTML
const emailHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' https:; style-src 'unsafe-inline'">
</head>
<body>
  ${sanitizeHtml(body)}
</body>
</html>
`
```


***

### **30. GDPR Compliance (data deletion, export)**

**–í–û–ü–†–û–°:** –ö–∞–∫ –æ–±–µ—Å–ø–µ—á–∏—Ç—å GDPR compliance –¥–ª—è notifications?

- **A)** –ü—Ä–∞–≤–æ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ (delete notification history –ø—Ä–∏ GDPR request)
- **B)** –ü—Ä–∞–≤–æ –Ω–∞ export (—Å–∫–∞—á–∞—Ç—å –≤—Å—é notification history)
- **C)** Opt-out –º–µ—Ö–∞–Ω–∏–∑–º (unsubscribe –æ—Ç marketing)
- **D)** –ö–æ–º–±–æ: A + B + C + data retention policy

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Full GDPR compliance**

```typescript
// 1. Data Deletion (Right to be forgotten)
@Post('/api/v1/guests/me/gdpr/delete-request')
async requestDataDeletion(@CurrentUser() user: User) {
  // 1. Create deletion request
  const request = await this.prisma.gdprDeletionRequest.create({
    data: {
      userId: user.id,
      requestedAt: new Date(),
      status: 'PENDING',
    },
  })
  
  // 2. Queue deletion job (30 days delay per GDPR)
  await this.gdprQueue.add(
    'delete-user-data',
    { userId: user.id, requestId: request.id },
    { delay: 30 * 24 * 60 * 60 * 1000 } // 30 days
  )
  
  // 3. Send confirmation email
  await this.emailProvider.send({
    to: user.email,
    subject: '–ó–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—É—á–µ–Ω',
    text: `–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π. –ï—Å–ª–∏ –≤—ã –ø–µ—Ä–µ–¥—É–º–∞–ª–∏, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç –∏ –æ—Ç–º–µ–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.`,
  })
  
  return { message: 'Deletion request submitted. Data will be deleted in 30 days.' }
}

// Delete all notification data
async deleteUserNotificationData(userId: string) {
  await this.prisma.$transaction([
    this.prisma.notification.deleteMany({ where: { recipientId: userId } }),
    this.prisma.notificationAnalytics.deleteMany({ where: { userId } }),
    this.prisma.guestNotificationSettings.delete({ where: { userId } }),
  ])
  
  this.logger.log(`Deleted notification data for user ${userId}`)
}

// 2. Data Export (Right to data portability)
@Get('/api/v1/guests/me/gdpr/export')
async exportMyData(@CurrentUser() user: User, @Res() res: Response) {
  // 1. Collect all notification data
  const notifications = await this.prisma.notification.findMany({
    where: { recipientId: user.id },
    include: { analytics: true },
  })
  
  const settings = await this.prisma.guestNotificationSettings.findUnique({
    where: { userId: user.id },
  })
  
  // 2. Generate JSON export
  const exportData = {
    exportedAt: new Date(),
    notifications,
    settings,
  }
  
  // 3. Send as downloadable JSON
  res.setHeader('Content-Type', 'application/json')
  res.setHeader('Content-Disposition', `attachment; filename="notification-data-${user.id}.json"`)
  res.send(JSON.stringify(exportData, null, 2))
}

// 3. Data Retention Policy (auto-delete old notifications)
@Cron('0 3 * * *') // Daily at 3 AM
async cleanupOldNotifications() {
  const retentionDays = 365 // 1 year
  const cutoffDate = subDays(new Date(), retentionDays)
  
  const deleted = await this.prisma.notification.deleteMany({
    where: {
      createdAt: { lt: cutoffDate },
      status: { in: ['DELIVERED', 'FAILED'] },
    },
  })
  
  this.logger.log(`Deleted ${deleted.count} old notifications (older than ${retentionDays} days)`)
}

// 4. Consent tracking
await this.prisma.notification.create({
  data: {
    // ...
    metadata: {
      consentGrantedAt: guest.marketingConsentGrantedAt,
      consentVersion: '2.0', // Track consent policy version
    },
  },
})
```


***

### **31. Notification Spam Prevention**

**–í–û–ü–†–û–°:** –ö–∞–∫ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å spam notifications (bug –≤ –∫–æ–¥–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç 1000 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)?

- **A)** Rate limiting per tenant (max 1000 notifications/hour)
- **B)** Deduplication (—Å–º. –≤–æ–ø—Ä–æ—Å \#17)
- **C)** Manual approval –¥–ª—è mass notifications (>100 recipients)
- **D)** –ö–æ–º–±–æ: A + B + C

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Multi-layer spam prevention**

```typescript
// 1. Tenant-level rate limiting (Redis)
async checkTenantRateLimit(tenantId: string): Promise<boolean> {
  const key = `notifications:ratelimit:${tenantId}:${format(new Date(), 'yyyy-MM-dd-HH')}`
  const count = await this.redis.incr(key)
  await this.redis.expire(key, 3600) // 1 hour window
  
  const limit = 1000 // Max 1000 notifications per hour
  
  if (count > limit) {
    this.logger.error(`Tenant ${tenantId} exceeded rate limit (${count}/${limit})`)
    
    // Alert Admin
    await this.sendAdminAlert({
      tenantId,
      severity: 'ERROR',
      title: 'Notification rate limit exceeded',
      message: `Tenant has sent ${count} notifications in the last hour (limit: ${limit})`,
    })
    
    return false
  }
  
  return true
}

// 2. Deduplication (idempotency)
// (—Å–º. –≤–æ–ø—Ä–æ—Å #17)

// 3. Manual approval for mass notifications
@Post('/api/v1/notifications/broadcast')
@Roles('ADMIN', 'MANAGER')
async broadcastNotification(@Body() dto: BroadcastNotificationDto) {
  const recipientCount = await this.countRecipients(dto.filters)
  
  // Require manual approval if > 100 recipients
  if (recipientCount > 100) {
    const approval = await this.prisma.notificationApproval.create({
      data: {
        tenantId: dto.tenantId,
        createdBy: dto.userId,
        recipientCount,
        message: dto.message,
        status: 'PENDING_APPROVAL',
      },
    })
    
    // Notify Owner for approval
    await this.notificationService.send({
      recipientId: tenant.ownerId,
      type: 'APPROVAL_REQUIRED',
      message: `Mass notification pending approval (${recipientCount} recipients)`,
      metadata: { approvalId: approval.id },
    })
    
    return {
      message: 'Mass notification requires approval',
      approvalId: approval.id,
      status: 'PENDING_APPROVAL',
    }
  }
  
  // Send immediately if < 100 recipients
  await this.sendBroadcast(dto)
}

// Owner approval
@Post('/api/v1/notifications/approvals/:id/approve')
@Roles('OWNER')
async approveNotification(@Param('id') approvalId: string) {
  const approval = await this.prisma.notificationApproval.update({
    where: { id: approvalId },
    data: { status: 'APPROVED', approvedAt: new Date() },
  })
  
  // Send broadcast
  await this.sendBroadcast(approval)
}
```


***

### **32. Notification Content Moderation**

**–í–û–ü–†–û–°:** –ú–æ–¥–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ª–∏ notification content (–ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ offensive content)?

- **A)** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è (blacklist —Å–ª–æ–≤)
- **B)** ML-based moderation (OpenAI Moderation API)
- **C)** Manual review –¥–ª—è custom templates
- **D)** –ö–æ–º–±–æ: A + C (MVP), B (Phase 2)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Blacklist (MVP) + ML (Phase 2)**

```typescript
// MVP: Blacklist-based moderation
const OFFENSIVE_WORDS_RU = [
  '—Å–ø–∞–º', '–∫–∞–∑–∏–Ω–æ', '–∑–∞—Ä–∞–±–æ—Ç–æ–∫', '—Ö–∞–ª—è–≤–∞', // Add more
]

function moderateContent(content: string): { approved: boolean, reason?: string } {
  const lowerContent = content.toLowerCase()
  
  // Check blacklist
  for (const word of OFFENSIVE_WORDS_RU) {
    if (lowerContent.includes(word)) {
      return {
        approved: false,
        reason: `Content contains blacklisted word: "${word}"`,
      }
    }
  }
  
  return { approved: true }
}

// Phase 2: OpenAI Moderation API
import OpenAI from 'openai'

async function moderateContentML(content: string) {
  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY })
  
  const moderation = await openai.moderations.create({
    input: content,
  })
  
  const result = moderation.results[^4_0]
  
  if (result.flagged) {
    return {
      approved: false,
      reason: `Content flagged by AI: ${Object.keys(result.categories).filter(k => result.categories[k]).join(', ')}`,
    }
  }
  
  return { approved: true }
}

// Usage –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ custom template
async saveCustomTemplate(dto: CreateTemplateDto) {
  // 1. Moderate content
  const moderation = await moderateContent(dto.body)
  
  if (!moderation.approved) {
    throw new BadRequestException(moderation.reason)
  }
  
  // 2. Save template
  return this.prisma.notificationTemplate.create({ data: dto })
}
```


***

## **‚úÖ –ò–¢–û–ì–û: 36 –í–û–ü–†–û–°–û–í –†–ï–®–ï–ù–û**

| **–ö–∞—Ç–µ–≥–æ—Ä–∏—è** | **–í–æ–ø—Ä–æ—Å–æ–≤** | **–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è** |
| :-- | :-- | :-- |
| **1. Email Provider** | 6 | Resend (transactional) + SendGrid (marketing), React Email templates, QR inline, Unsubscribe (RFC 8058), Tracking pixel, Retry + SMS fallback |
| **2. SMS Provider** | 5 | SMS.ru + SMSC fallback, Length optimization (70 chars), Cost-based routing (Telegram first), Webhook delivery tracking, Rate limiting + CAPTCHA |
| **3. Telegram Push** | 4 | HTML formatting, Deep links (web_app), Inline buttons (no replies), Quiet hours (23:00-09:00) |
| **4. Delivery \& Retry** | 5 | Multi-channel priority (Guest settings), TTL-based deduplication, Batching (LOW priority), Adaptive retry + Circuit breaker, DLQ + Monitoring |
| **5. Templates \& Localization** | 4 | React Email + DB-stored custom, i18n-ready (ru/en), Personalization (name, recommendations, gamification), Template validation (variables check) |
| **6. Analytics \& Monitoring** | 4 | Comprehensive metrics (delivery, open, click, conversion), A/B testing (Phase 2), Cost tracking + budget alerts, Sentry + Prometheus + Grafana |
| **7. Security \& Compliance** | 4 | XSS/injection prevention (DOMPurify, escape), GDPR (deletion, export, consent), Spam prevention (rate limit, deduplication, approval), Content moderation (blacklist + ML) |


***

## **üõ†Ô∏è TECH STACK FINAL**

```typescript
// package.json
{
  "dependencies": {
    // Email
    "resend": "^2.0.0",
    "@sendgrid/mail": "^7.7.0",
    "@react-email/components": "^0.0.11",
    "@react-email/render": "^0.0.11",
    
    // SMS
    "axios": "^1.6.0", // For SMS.ru/SMSC API
    
    // Telegram
    "telegraf": "^4.15.0",
    
    // Templates
    "handlebars": "^4.7.8",
    "lodash": "^4.17.21",
    
    // Security
    "isomorphic-dompurify": "^2.0.0",
    
    // Queue
    "@nestjs/bull": "^10.0.0",
    "bullmq": "^5.0.0",
    
    // Monitoring
    "@sentry/node": "^7.90.0",
    "prom-client": "^15.1.0",
    
    // Misc
    "qrcode": "^1.5.3",
    "date-fns": "^3.0.0",
    "date-fns-tz": "^2.0.0"
  }
}
```


***

## **üìÅ COMPONENT STRUCTURE**

```
libs/notifications/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ providers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email.provider.ts          # Resend + SendGrid
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ resend.provider.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sendgrid.provider.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sms/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sms.provider.ts            # SMS.ru + SMSC
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ smsru.provider.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ smsc.provider.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ telegram/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ telegram.provider.ts       # Telegraf bot
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ emails/                        # React Email components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BallsEarnedEmail.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LevelUpgradedEmail.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WelcomeEmail.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PasswordResetEmail.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sms/                           # SMS templates
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BallsEarnedSms.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ VerificationCodeSms.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram/                      # Telegram messages
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BallsEarnedMessage.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PromoAvailableMessage.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ i18n.ts                        # Localization strings
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification.service.ts        # Main service
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification-analytics.service.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification-settings.service.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ notification-cost.service.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ processors/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ notification.processor.ts      # BullMQ processor
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deduplication.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rate-limiting.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ moderation.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ template-renderer.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ notifications.module.ts
```


***

## **üéØ –ì–û–¢–û–í –ö –°–õ–ï–î–£–Æ–©–ï–ú–£ –ë–õ–û–ö–£!**

Notification System **–ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω**. –í—Å–µ 36 –≤–æ–ø—Ä–æ—Å–æ–≤ —Ä–µ—à–µ–Ω—ã —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ best practices.

**–ö–∞–∫–æ–π –±–ª–æ–∫ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–ª–µ–µ?**

1. **Database Schema Prisma** (–¥–µ—Ç–∞–ª–∏ –∏–Ω–¥–µ–∫—Å–æ–≤, –º–∏–≥—Ä–∞—Ü–∏–π, seed data)
2. **Infrastructure \& DevOps** (Docker, CI/CD, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –¥–µ–ø–ª–æ–π)
3. **Testing Strategy** (Unit, Integration, E2E, Load testing)
4. **Security \& Compliance** (OWASP, GDPR, PCI DSS)
5. **POS Integration (–¥–µ—Ç–∞–ª–∏)** (JSON-—Å—Ö–µ–º—ã webhooks iiko/R-Keeper, reconciliation)

**–°–∫–∞–∂–∏ –Ω–æ–º–µ—Ä –±–ª–æ–∫–∞ –∏–ª–∏ —Å–≤–æ—ë –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ!** üöÄ
<span style="display:none">[^4_2][^4_3][^4_4][^4_5]</span>

<div align="center">‚ÅÇ</div>

[^4_1]: Beseda-8.md

[^4_2]: Beseda-7.md

[^4_3]: Beseda-3.md

[^4_4]: Beseda-2.md

[^4_5]: Beseda-9.md


---

# üîî **NOTIFICATION SYSTEM - –§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï**

## **üìã –ü–†–ò–ù–Ø–¢–´–ï –†–ï–®–ï–ù–ò–Ø (–Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤)**

### **üü¢ –ü–û–õ–ù–û–°–¢–¨–Æ –ü–†–ò–ù–Ø–¢–´–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø (28/32)**

‚úÖ Email Provider: **Resend (transactional) + SendGrid (marketing)**
‚úÖ Email Templates: **React Email (JSX –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)**
‚úÖ Email Attachments: **Inline QR –≤ HTML (base64)**
‚úÖ Email Unsubscribe: **–ö–æ–º–±–æ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ + List-Unsubscribe header)**
‚úÖ Email Tracking: **Tracking —Ç–æ–ª—å–∫–æ –¥–ª—è marketing emails**
‚úÖ Email Retry: **Retry + SMS fallback –¥–ª—è CRITICAL/HIGH**
‚úÖ SMS Provider: **Multi-provider (SMS.ru primary, SMSC fallback)**
‚úÖ SMS Length: **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π + Short URLs**
‚úÖ SMS vs Telegram: **Cost-based strategy**
‚úÖ SMS Delivery Status: **Webhook callbacks –æ—Ç SMS.ru**
‚úÖ Telegram Formatting: **HTML (bold, links, inline buttons)**
‚úÖ Telegram Deep Links: **–ö–æ–º–±–æ (web_app buttons + startapp)**
‚úÖ Telegram Reply Actions: **Inline buttons (MVP), NLP (Phase 2)**
‚úÖ Multi-Channel Priority: **Cost-optimized (Telegram ‚Üí Email ‚Üí SMS)**
‚úÖ Batch Notifications: **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ LOW priority (Telegram/Email)**
‚úÖ Retry Logic: **Adaptive retry + Circuit breaker**
‚úÖ DLQ Handling: **DLQ + Monitoring (Sentry + Admin alerts)**
‚úÖ Template Engine: **React Email + DB-stored custom templates**
‚úÖ Localization: **Phase 2 (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è ru/en)**
‚úÖ Dynamic Content: **–ë–∞–∑–æ–≤–∞—è (MVP), Advanced (Phase 2)**
‚úÖ Template Validation: **–ö–æ–º–±–æ (validation + preview + runtime fallback)**
‚úÖ Analytics: **Comprehensive (delivery, open, click, conversion)**
‚úÖ A/B Testing: **Phase 2 (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞)**
‚úÖ Cost Tracking: **Comprehensive cost management + budget alerts**
‚úÖ Monitoring: **Sentry + Prometheus + Grafana**
‚úÖ Security: **XSS prevention (DOMPurify, escape)**
‚úÖ GDPR: **Full compliance (deletion, export, consent)**
‚úÖ Spam Prevention: **Multi-layer (rate limit, deduplication, approval)**
‚úÖ Content Moderation: **Blacklist (MVP) + ML (Phase 2)**

***

### **üîµ –ö–ê–°–¢–û–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –†–ï–®–ï–ù–ò–Ø (4/32)**

#### \#3. Telegram Message Formatting

**–í–´–ë–†–ê–ù–û:** **C) Plain text** (–≤–º–µ—Å—Ç–æ B) HTML)

**–†–ï–ê–õ–ò–ó–ê–¶–ò–Ø:**

```typescript
// libs/notifications/src/templates/telegram/BallsEarnedMessage.ts
export function formatBallsEarnedMessage(data: BallsEarnedData): string {
  // Plain text –±–µ–∑ HTML —Ç–µ–≥–æ–≤
  return `
üéâ –ù–∞—á–∏—Å–ª–µ–Ω–æ ${data.amount} –±–∞–ª–ª–æ–≤!

–ó–∞ —á–µ–∫ –Ω–∞ —Å—É–º–º—É ${data.checkAmount} ‚ÇΩ –≤ ${data.restaurant.name} 
–≤–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ ${data.amount} –±–∞–ª–ª–æ–≤.

üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: ${data.balance} –±–∞–ª–ª–æ–≤

–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é: ${data.viewBalanceUrl}
  `.trim()
}

// Send via Telegram Bot API (–ë–ï–ó parse_mode)
await this.bot.telegram.sendMessage(
  telegramUser.telegramId,
  formatBallsEarnedMessage(data),
  {
    // parse_mode: 'HTML', // ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º
    reply_markup: {
      inline_keyboard: [
        [
          { text: 'üí≥ –ú–æ—è –∫–∞—Ä—Ç–∞', callback_data: 'view_card' },
          { text: 'üìä –ò—Å—Ç–æ—Ä–∏—è', callback_data: 'view_history' },
        ],
      ],
    },
  }
)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ plain text:**

- –ü—Ä–æ—â–µ (–Ω–µ—Ç —Ä–∏—Å–∫–∞ broken HTML)
- –ë—ã—Å—Ç—Ä–µ–µ (–Ω–µ –Ω—É–∂–µ–Ω parsing)
- –†–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ (Telegram, SMS, push)

***

#### \#11. SMS Rate Limiting

**–í–´–ë–†–ê–ù–û:** **A) Rate limit: 3 SMS/hour per phone**

**–†–ï–ê–õ–ò–ó–ê–¶–ò–Ø:**

```typescript
// Simplified rate limiting (–±–µ–∑ exponential cooldown –∏ CAPTCHA)
async requestVerificationCode(phone: string) {
  const rateLimitKey = `sms:ratelimit:${phone}`
  
  // 1. Check attempts count (Redis)
  const attempts = await this.redis.incr(rateLimitKey)
  await this.redis.expire(rateLimitKey, 3600) // 1 hour window
  
  // 2. Hard limit: 3 SMS per hour
  if (attempts > 3) {
    const ttl = await this.redis.ttl(rateLimitKey)
    throw new HttpException(
      `–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ ${Math.ceil(ttl / 60)} –º–∏–Ω—É—Ç.`,
      429
    )
  }
  
  // 3. Send SMS
  const code = this.generate6DigitCode()
  await this.smsProvider.send(phone, `–í–∞—à –∫–æ–¥: ${code}`)
  
  // 4. Save code in Redis (TTL 10 min)
  await this.redis.setex(`verification:${phone}`, 600, code)
  
  return { message: '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', attemptsRemaining: 3 - attempts }
}
```

**–ü—Ä–æ—â–µ, —á–µ–º –º–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–±–µ–∑ exponential backoff –∏ CAPTCHA).**

***

#### \#15. Telegram Quiet Hours

**–í–´–ë–†–ê–ù–û:** **A) –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å 23:00 –¥–æ 09:00 (–≤—Å–µ–≥–¥–∞)**

**–†–ï–ê–õ–ò–ó–ê–¶–ò–Ø:**

```typescript
async sendTelegramNotification(dto: SendNotificationDto) {
  const guest = await this.getGuest(dto.recipientId)
  const now = new Date()
  
  // 1. Get guest timezone
  const timezone = guest.timezone || 'Europe/Moscow'
  const localTime = utcToZonedTime(now, timezone)
  const hour = localTime.getHours()
  
  // 2. Check quiet hours (23:00 - 09:00)
  const isQuietHours = hour >= 23 || hour < 9
  
  // 3. –ï—Å–ª–∏ –Ω–æ—á—å ‚Üí schedule for 09:00 (–¥–ª—è –í–°–ï–• —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
  if (isQuietHours) {
    const scheduledFor = setHours(
      setMinutes(addDays(localTime, hour >= 23 ? 1 : 0), 0), 
      9
    )
    
    await this.notificationQueue.add(
      'send-telegram',
      dto,
      { delay: differenceInMilliseconds(scheduledFor, now) }
    )
    
    this.logger.log(`Notification scheduled for ${scheduledFor} (quiet hours)`)
    return
  }
  
  // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É (–µ—Å–ª–∏ –Ω–µ –Ω–æ—á—å)
  await this.bot.telegram.sendMessage(
    telegramUser.telegramId,
    dto.message,
    {
      reply_markup: dto.replyMarkup,
    }
  )
}
```

**–û—Ç–ª–∏—á–∏–µ –æ—Ç –º–æ–µ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:** Quiet hours –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ –í–°–ï–ú —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º (–≤–∫–ª—é—á–∞—è CRITICAL), –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π. –ë–æ–ª–µ–µ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–º–µ–Ω—å—à–µ —Ä–∏—Å–∫–∞ —Ä–∞–∑–±—É–¥–∏—Ç—å –≥–æ—Å—Ç—è –Ω–æ—á—å—é).

***

#### \#16. Multi-Channel Priority

**–í–´–ë–†–ê–ù–û:** **D) Cost-optimized**

‚úÖ –°–æ–≤–ø–∞–¥–∞–µ—Ç —Å –º–æ–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–∂–µ –æ–ø–∏—Å–∞–Ω–∞ –≤—ã—à–µ (Telegram ‚Üí Email ‚Üí SMS, —Å —É—á—ë—Ç–æ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏).

***

#### \#17. Notification Deduplication

**–í–´–ë–†–ê–ù–û:** **B) TTL-based deduplication**

‚úÖ –°–æ–≤–ø–∞–¥–∞–µ—Ç —Å –º–æ–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–∂–µ –æ–ø–∏—Å–∞–Ω–∞ –≤—ã—à–µ (Redis —Å TTL 5 –º–∏–Ω—É—Ç).

***

## **üì¶ –ò–¢–û–ì–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    NOTIFICATION SYSTEM                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ   NotificationService (Central)   ‚îÇ
          ‚îÇ  ‚Ä¢ sendNotification()             ‚îÇ
          ‚îÇ  ‚Ä¢ sendBatch()                    ‚îÇ
          ‚îÇ  ‚Ä¢ sendCampaign()                 ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº                     ‚ñº                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Email Provider‚îÇ    ‚îÇ SMS Provider  ‚îÇ    ‚îÇTelegram Provider‚îÇ
‚îÇ ‚Ä¢ Resend      ‚îÇ    ‚îÇ ‚Ä¢ SMS.ru      ‚îÇ    ‚îÇ ‚Ä¢ Telegraf Bot ‚îÇ
‚îÇ ‚Ä¢ SendGrid    ‚îÇ    ‚îÇ ‚Ä¢ SMSC        ‚îÇ    ‚îÇ ‚Ä¢ Plain text   ‚îÇ
‚îÇ ‚Ä¢ React Email ‚îÇ    ‚îÇ ‚Ä¢ Webhooks    ‚îÇ    ‚îÇ ‚Ä¢ Inline btns  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                     ‚îÇ                     ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   BullMQ Queue   ‚îÇ
                    ‚îÇ ‚Ä¢ Retry logic    ‚îÇ
                    ‚îÇ ‚Ä¢ Priority queue ‚îÇ
                    ‚îÇ ‚Ä¢ Circuit breaker‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº                     ‚ñº                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Deduplication ‚îÇ    ‚îÇ Rate Limiting ‚îÇ    ‚îÇ Cost Tracking ‚îÇ
‚îÇ ‚Ä¢ Redis TTL   ‚îÇ    ‚îÇ ‚Ä¢ 3 SMS/hour  ‚îÇ    ‚îÇ ‚Ä¢ Budget alert‚îÇ
‚îÇ ‚Ä¢ 5 min cache ‚îÇ    ‚îÇ ‚Ä¢ Tenant limit‚îÇ    ‚îÇ ‚Ä¢ Analytics   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   Monitoring     ‚îÇ
                    ‚îÇ ‚Ä¢ Sentry (errors)‚îÇ
                    ‚îÇ ‚Ä¢ Prometheus     ‚îÇ
                    ‚îÇ ‚Ä¢ Grafana        ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## **üóÇÔ∏è DATABASE SCHEMA**

```prisma
// Notification –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
model Notification {
  id              String               @id @default(uuid())
  tenantId        String
  tenant          Tenant               @relation(...)
  
  // Recipient
  recipientId     String               // userId or guestCardId
  recipientType   String               @default("USER") // USER | GUEST
  
  // Notification details
  type            NotificationType     // BALLS_EARNED, LEVEL_UPGRADED, etc.
  title           String
  message         String               @db.Text
  
  // Delivery
  channel         NotificationChannel  // TELEGRAM | EMAIL | SMS
  priority        NotificationPriority @default("NORMAL") // CRITICAL | HIGH | NORMAL | LOW
  status          NotificationStatus   @default("PENDING") // PENDING | DELIVERED | FAILED | SKIPPED
  
  // Timing
  scheduledFor    DateTime?            // –î–ª—è quiet hours
  sentAt          DateTime?
  deliveredAt     DateTime?
  readAt          DateTime?
  
  // Error handling
  attempts        Int                  @default(0)
  errorMessage    String?
  
  // Cost tracking
  cost            Decimal              @default(0) @db.Decimal(10, 2)
  
  // Metadata
  metadata        Json?                // Campaign ID, variant ID, etc.
  
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  
  // Relations
  analytics       NotificationAnalytics?
  
  @@index([tenantId, status, createdAt(sort: Desc)])
  @@index([recipientId, createdAt(sort: Desc)])
  @@index([type, channel, status])
  @@index([scheduledFor]) // –î–ª—è CRON job (quiet hours)
}

// Guest notification settings
model GuestNotificationSettings {
  userId          String               @id
  user            User                 @relation(...)
  
  settings        Json                 // JSON structure:
  // {
  //   "balls": {
  //     "earned": { "telegram": true, "email": false, "sms": false },
  //     "expired": { "telegram": true, "email": true, "sms": false }
  //   },
  //   "promos": {
  //     "available": { "telegram": true, "email": false, "sms": false }
  //   },
  //   "marketing": {
  //     "enabled": false
  //   },
  //   "quietHours": {
  //     "enabled": true,
  //     "from": "23:00",
  //     "to": "09:00",
  //     "timezone": "Europe/Moscow"
  //   }
  // }
  
  updatedAt       DateTime             @updatedAt
}

// Notification analytics
model NotificationAnalytics {
  id              String               @id @default(uuid())
  notificationId  String               @unique
  notification    Notification         @relation(...)
  
  // Engagement metrics
  openedAt        DateTime?
  clickedAt       DateTime?
  clickedUrl      String?
  
  // Conversion metrics
  convertedAt     DateTime?
  conversionType  String?              // "VIEW_BALANCE", "REDEEM_BALLS", etc.
  conversionValue Decimal?             @db.Decimal(10, 2)
  
  // Metadata
  userAgent       String?
  ipAddress       String?
  
  createdAt       DateTime             @default(now())
  
  @@index([notificationId])
}

// Cost tracking per tenant
model NotificationCost {
  id              String               @id @default(uuid())
  tenantId        String
  tenant          Tenant               @relation(...)
  month           String               // "2026-02"
  
  // Costs by channel
  smsCost         Decimal              @default(0) @db.Decimal(10, 2)
  emailCost       Decimal              @default(0) @db.Decimal(10, 2)
  telegramCost    Decimal              @default(0) @db.Decimal(10, 2)
  
  // Counts
  smsCount        Int                  @default(0)
  emailCount      Int                  @default(0)
  telegramCount   Int                  @default(0)
  
  totalCost       Decimal              @default(0) @db.Decimal(10, 2)
  
  @@unique([tenantId, month])
}

// Custom templates (Admin UI)
model NotificationTemplate {
  id                  String               @id @default(uuid())
  tenantId            String
  tenant              Tenant               @relation(...)
  
  type                NotificationType
  channel             NotificationChannel
  locale              String               @default("ru")
  
  // Custom template (nullable = use default)
  customSubject       String?
  customBody          String?              @db.Text // Handlebars template
  
  // Variables metadata
  availableVariables  Json                 // ["guestName", "amount", "balance", etc.]
  
  isActive            Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  
  @@unique([tenantId, type, channel, locale])
}

// DLQ (Dead Letter Queue)
model NotificationDLQ {
  id              String               @id @default(uuid())
  notificationId  String
  
  recipientId     String
  type            NotificationType
  channel         NotificationChannel
  payload         Json
  
  errorMessage    String               @db.Text
  attempts        Int
  
  failedAt        DateTime             @default(now())
  
  // Admin actions
  status          String               @default("PENDING") // PENDING | RETRIED | DISMISSED
  resolvedAt      DateTime?
  resolvedBy      String?
  
  @@index([failedAt(sort: Desc)])
}

// ENUMS
enum NotificationType {
  // Loyalty
  BALLS_EARNED
  BALLS_REDEEMED
  BALLS_EXPIRED
  BALLS_EXPIRING_SOON
  LEVEL_UPGRADED
  
  // Promos
  PROMO_ACTIVATED
  PROMO_AVAILABLE
  BIRTHDAY_PROMO
  
  // Billing
  SUBSCRIPTION_EXPIRING
  PAYMENT_FAILED
  PAYMENT_SUCCESS
  
  // System
  WELCOME
  PASSWORD_RESET
  VERIFICATION_CODE
}

enum NotificationChannel {
  TELEGRAM
  EMAIL
  SMS
  PUSH // Phase 2
}

enum NotificationPriority {
  CRITICAL // Password reset, verification codes
  HIGH     // Payment failed, subscription expiring
  NORMAL   // Balls earned, level upgraded
  LOW      // Marketing, recommendations
}

enum NotificationStatus {
  PENDING
  DELIVERED
  FAILED
  SKIPPED // Cost optimization or quiet hours
}
```


***

## **üìù NOTIFICATION TEMPLATES**

### **1. Email Templates (React Email)**

```tsx
// libs/notifications/src/templates/emails/BallsEarnedEmail.tsx
import { 
  Html, Body, Container, Text, Button, Img 
} from '@react-email/components'

interface BallsEarnedEmailProps {
  guestName: string
  earnedPoints: number
  newBalance: number
  checkAmount: number
  restaurantName: string
  restaurantLogo: string
  qrCodeBase64: string
  viewBalanceUrl: string
}

export default function BallsEarnedEmail(props: BallsEarnedEmailProps) {
  return (
    <Html>
      <Body style={main}>
        <Container style={container}>
          <Img src={props.restaurantLogo} width="120" height="40" />
          
          <Text style={heading}>
            –ù–∞—á–∏—Å–ª–µ–Ω–æ {props.earnedPoints} –±–∞–ª–ª–æ–≤! üéâ
          </Text>
          
          <Text style={paragraph}>
            –ü—Ä–∏–≤–µ—Ç, {props.guestName}!
          </Text>
          
          <Text style={paragraph}>
            –ó–∞ —á–µ–∫ –Ω–∞ —Å—É–º–º—É <strong>{props.checkAmount} ‚ÇΩ</strong> –≤ {props.restaurantName} 
            –≤–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ <strong>{props.earnedPoints} –±–∞–ª–ª–æ–≤</strong>.
          </Text>
          
          <Text style={balanceBox}>
            –í–∞—à –±–∞–ª–∞–Ω—Å: {props.newBalance} –±–∞–ª–ª–æ–≤
          </Text>
          
          {/* QR Code inline */}
          <Img 
            src={props.qrCodeBase64} 
            width="200" 
            height="200" 
            style={{ margin: '20px auto', display: 'block' }}
          />
          
          <Button href={props.viewBalanceUrl} style={button}>
            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –±–∞–ª–∞–Ω—Å
          </Button>
          
          <Text style={footer}>
            –ù–µ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —Ç–∞–∫–∏–µ –ø–∏—Å—å–º–∞? 
            <Link href={unsubscribeUrl}>–û—Ç–ø–∏—Å–∞—Ç—å—Å—è</Link>
          </Text>
        </Container>
      </Body>
    </Html>
  )
}

const main = { backgroundColor: '#f6f9fc', fontFamily: 'Arial, sans-serif' }
const container = { margin: '0 auto', padding: '40px', maxWidth: '600px', backgroundColor: '#fff' }
const heading = { fontSize: '24px', fontWeight: 'bold', marginBottom: '20px' }
const paragraph = { fontSize: '16px', lineHeight: '24px', marginBottom: '16px' }
const balanceBox = { 
  fontSize: '20px', 
  fontWeight: 'bold', 
  backgroundColor: '#f0f9ff', 
  padding: '16px', 
  borderRadius: '8px',
  textAlign: 'center',
  margin: '24px 0'
}
const button = {
  backgroundColor: '#0070f3',
  color: '#fff',
  padding: '12px 24px',
  borderRadius: '6px',
  textDecoration: 'none',
  display: 'inline-block',
  fontWeight: 'bold'
}
const footer = { fontSize: '12px', color: '#999', marginTop: '40px' }
```


### **2. SMS Templates**

```typescript
// libs/notifications/src/templates/sms/templates.ts
export const smsTemplates = {
  BALLS_EARNED: (data: { amount: number, balance: number }) => 
    `+${data.amount}–±. –ë–∞–ª–∞–Ω—Å: ${data.balance}–±.`, // 30 —Å–∏–º–≤–æ–ª–æ–≤
  
  VERIFICATION_CODE: (data: { code: string }) => 
    `–í–∞—à –∫–æ–¥: ${data.code}`, // 15 —Å–∏–º–≤–æ–ª–æ–≤
  
  LEVEL_UPGRADED: (data: { level: string, earnPercent: number }) => 
    `–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –£—Ä–æ–≤–µ–Ω—å: ${data.level}. +${data.earnPercent}% –±–∞–ª–ª–æ–≤`, // ~40 —Å–∏–º–≤–æ–ª–æ–≤
  
  BALLS_EXPIRING: (data: { amount: number, daysLeft: number }) => 
    `–°–≥–æ—Ä–∞—é—Ç ${data.amount}–± —á–µ—Ä–µ–∑ ${data.daysLeft}–¥. –£—Å–ø–µ–π—Ç–µ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å!`, // ~50 —Å–∏–º–≤–æ–ª–æ–≤
}
```


### **3. Telegram Templates (Plain Text)**

```typescript
// libs/notifications/src/templates/telegram/templates.ts
export const telegramTemplates = {
  BALLS_EARNED: (data: BallsEarnedData) => `
üéâ –ù–∞—á–∏—Å–ª–µ–Ω–æ ${data.amount} –±–∞–ª–ª–æ–≤!

–ó–∞ —á–µ–∫ –Ω–∞ —Å—É–º–º—É ${data.checkAmount} ‚ÇΩ –≤ ${data.restaurant.name}
–≤–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ ${data.amount} –±–∞–ª–ª–æ–≤.

üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: ${data.balance} –±–∞–ª–ª–æ–≤
  `.trim(),
  
  LEVEL_UPGRADED: (data: LevelUpgradedData) => `
üéä –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: ${data.level}

–¢–µ–ø–µ—Ä—å –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ ${data.earnPercentage}% –±–∞–ª–ª–æ–≤ –∑–∞ –∫–∞–∂–¥—ã–π –≤–∏–∑–∏—Ç.

–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è (${data.nextLevel}): ${data.amountToNext} ‚ÇΩ
  `.trim(),
  
  PROMO_AVAILABLE: (data: PromoData) => `
üéÅ –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!

${data.title}

${data.description}

–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ ${format(data.expiresAt, 'dd.MM.yyyy')}
  `.trim(),
}
```


***

## **üîß CORE SERVICES**

### **NotificationService (Main)**

```typescript
// libs/notifications/src/services/notification.service.ts
@Injectable()
export class NotificationService {
  constructor(
    private prisma: PrismaService,
    private emailProvider: EmailProvider,
    private smsProvider: SmsProvider,
    private telegramProvider: TelegramProvider,
    private notificationQueue: Queue,
    private redis: Redis,
    private costService: NotificationCostService,
    private analyticsService: NotificationAnalyticsService,
  ) {}
  
  async send(dto: SendNotificationDto): Promise<void> {
    // 1. Get notification settings
    const settings = await this.getSettings(dto.recipientId)
    
    // 2. Check if notification is enabled
    if (!this.isNotificationEnabled(settings, dto.type, dto.channel)) {
      return // Skip
    }
    
    // 3. Deduplication check (TTL 5 min)
    if (await this.isDuplicate(dto)) {
      this.logger.warn(`Duplicate notification: ${dto.type} for ${dto.recipientId}`)
      return
    }
    
    // 4. Create notification record
    const notification = await this.prisma.notification.create({
      data: {
        tenantId: dto.tenantId,
        recipientId: dto.recipientId,
        recipientType: dto.recipientType || 'USER',
        type: dto.type,
        title: dto.title,
        message: dto.message,
        channel: dto.channel,
        priority: dto.priority || 'NORMAL',
        status: 'PENDING',
        metadata: dto.metadata,
      },
    })
    
    // 5. Check quiet hours (–¥–ª—è Telegram)
    if (dto.channel === 'TELEGRAM' && this.isQuietHours(settings)) {
      const scheduledFor = this.getNextAvailableTime(settings)
      
      await this.notificationQueue.add(
        'send-notification',
        { ...dto, notificationId: notification.id },
        { delay: differenceInMilliseconds(scheduledFor, new Date()) }
      )
      
      await this.prisma.notification.update({
        where: { id: notification.id },
        data: { scheduledFor, status: 'SCHEDULED' },
      })
      
      return
    }
    
    // 6. Send via BullMQ queue
    await this.notificationQueue.add('send-notification', {
      ...dto,
      notificationId: notification.id,
    })
  }
  
  private async isDuplicate(dto: SendNotificationDto): Promise<boolean> {
    const dedupKey = `notification:dedup:${dto.type}:${dto.recipientId}:${this.hash(dto.data)}`
    const exists = await this.redis.exists(dedupKey)
    
    if (!exists) {
      await this.redis.setex(dedupKey, 300, '1') // 5 min TTL
    }
    
    return exists === 1
  }
  
  private isQuietHours(settings: GuestNotificationSettings): boolean {
    if (!settings.settings.quietHours?.enabled) return false
    
    const timezone = settings.settings.quietHours.timezone || 'Europe/Moscow'
    const localTime = utcToZonedTime(new Date(), timezone)
    const hour = localTime.getHours()
    
    // 23:00 - 09:00
    return hour >= 23 || hour < 9
  }
  
  private getNextAvailableTime(settings: GuestNotificationSettings): Date {
    const timezone = settings.settings.quietHours.timezone || 'Europe/Moscow'
    const localTime = utcToZonedTime(new Date(), timezone)
    const hour = localTime.getHours()
    
    // Schedule for 09:00 today or tomorrow
    return setHours(
      setMinutes(addDays(localTime, hour >= 23 ? 1 : 0), 0),
      9
    )
  }
}
```


### **NotificationProcessor (BullMQ)**

```typescript
// libs/notifications/src/processors/notification.processor.ts
@Processor('notifications')
export class NotificationProcessor {
  constructor(
    private prisma: PrismaService,
    private emailProvider: EmailProvider,
    private smsProvider: SmsProvider,
    private telegramProvider: TelegramProvider,
    private costService: NotificationCostService,
  ) {}
  
  @Process('send-notification')
  async processNotification(job: Job<SendNotificationDto>) {
    const { notificationId, channel, recipientId, message } = job.data
    
    try {
      let cost = 0
      
      // Send via appropriate channel
      if (channel === 'EMAIL') {
        await this.emailProvider.send(job.data)
        cost = 0.05 // ‚ÇΩ0.05 per email (Resend pricing)
      } else if (channel === 'SMS') {
        await this.smsProvider.send(job.data)
        cost = 1.0 // ‚ÇΩ1 per SMS (SMS.ru)
      } else if (channel === 'TELEGRAM') {
        await this.telegramProvider.send(job.data)
        cost = 0 // Free
      }
      
      // Update notification status
      await this.prisma.notification.update({
        where: { id: notificationId },
        data: {
          status: 'DELIVERED',
          sentAt: new Date(),
          cost,
        },
      })
      
      // Track cost
      await this.costService.track(job.data.tenantId, channel, cost)
      
    } catch (error) {
      // Categorize error
      const errorCategory = this.categorizeError(error)
      
      // Retry logic
      if (errorCategory === 'SERVER_ERROR' && job.attemptsMade < 3) {
        throw error // BullMQ will retry
      }
      
      // Mark as FAILED
      await this.prisma.notification.update({
        where: { id: notificationId },
        data: {
          status: 'FAILED',
          errorMessage: error.message,
          attempts: job.attemptsMade,
        },
      })
      
      // Move to DLQ
      await this.moveToDeadLetterQueue(job, error)
    }
  }
  
  private categorizeError(error: any): 'CLIENT_ERROR' | 'SERVER_ERROR' | 'RATE_LIMIT' {
    if (error.response) {
      const status = error.response.status
      if (status >= 400 && status < 500) return 'CLIENT_ERROR'
      if (status === 429) return 'RATE_LIMIT'
      if (status >= 500) return 'SERVER_ERROR'
    }
    return 'SERVER_ERROR'
  }
  
  private async moveToDeadLetterQueue(job: Job, error: Error) {
    await this.prisma.notificationDLQ.create({
      data: {
        notificationId: job.data.notificationId,
        recipientId: job.data.recipientId,
        type: job.data.type,
        channel: job.data.channel,
        payload: job.data,
        errorMessage: error.message,
        attempts: job.attemptsMade,
      },
    })
  }
}
```


***

## **üìä KEY METRICS \& KPIs**

```typescript
// GET /api/v1/analytics/notifications
{
  "period": {
    "from": "2026-01-11T00:00:00Z",
    "to": "2026-02-10T23:59:59Z"
  },
  "summary": {
    "totalSent": 5420,
    "totalDelivered": 5248,
    "totalFailed": 172,
    "deliveryRate": 96.8, // %
    "totalCost": 524.10 // ‚ÇΩ
  },
  "byChannel": [
    {
      "channel": "TELEGRAM",
      "sent": 3234,
      "delivered": 3198,
      "failed": 36,
      "deliveryRate": 98.9,
      "cost": 0,
      "avgLatency": 0.3 // seconds
    },
    {
      "channel": "EMAIL",
      "sent": 1856,
      "delivered": 1764,
      "failed": 92,
      "deliveryRate": 95.0,
      "cost": 92.80,
      "openRate": 58.5,
      "clickRate": 29.2
    },
    {
      "channel": "SMS",
      "sent": 330,
      "delivered": 286,
      "failed": 44,
      "deliveryRate": 86.7,
      "cost": 431.30
    }
  ],
  "byType": [
    {
      "type": "BALLS_EARNED",
      "sent": 2456,
      "conversionRate": 7.2 // Guest –≤—ã–ø–æ–ª–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ—Å–ª–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    },
    {
      "type": "LEVEL_UPGRADED",
      "sent": 234,
      "conversionRate": 18.5
    }
    // ...
  ]
}
```


***

## **üí∞ COST ESTIMATION**

### **Monthly Cost per Tenant (1000 active guests)**

| Channel | Avg Notifications/Guest/Month | Total Notifications | Unit Cost | **Monthly Cost** |
| :-- | :-- | :-- | :-- | :-- |
| **Telegram** | 8 | 8,000 | ‚ÇΩ0 | **‚ÇΩ0** |
| **Email** | 3 | 3,000 | ‚ÇΩ0.05 | **‚ÇΩ150** |
| **SMS** | 0.5 | 500 | ‚ÇΩ1.00 | **‚ÇΩ500** |
| **TOTAL** |  | **11,500** |  | **‚ÇΩ650/month** |

**Cost Optimization Strategy:**

- 70% —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ Telegram (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
- 26% —á–µ—Ä–µ–∑ Email (‚ÇΩ150)
- 4% —á–µ—Ä–µ–∑ SMS (‚ÇΩ500) - —Ç–æ–ª—å–∫–æ CRITICAL

**Expected savings vs SMS-only:** **‚ÇΩ10,850/month** (95% cheaper)

***

## **‚úÖ –ì–û–¢–û–í–û –ö –†–ï–ê–õ–ò–ó–ê–¶–ò–ò**

### **Phase 1 (MVP) - 2 –Ω–µ–¥–µ–ª–∏**

- ‚úÖ Email provider (Resend)
- ‚úÖ SMS provider (SMS.ru + fallback)
- ‚úÖ Telegram provider (Telegraf)
- ‚úÖ React Email templates (5 –æ—Å–Ω–æ–≤–Ω—ã—Ö)
- ‚úÖ Plain text templates (SMS, Telegram)
- ‚úÖ BullMQ queue —Å retry logic
- ‚úÖ Rate limiting (3 SMS/hour)
- ‚úÖ Deduplication (TTL 5 min)
- ‚úÖ Quiet hours (23:00-09:00)
- ‚úÖ Cost tracking
- ‚úÖ Basic analytics (delivery rate)


### **Phase 2 (Advanced) - 3 –Ω–µ–¥–µ–ª–∏**

- üîú SendGrid marketing campaigns
- üîú Email tracking (open/click rate)
- üîú A/B testing
- üîú Advanced personalization (recommendations, gamification)
- üîú ML-based content moderation
- üîú Multi-language (en, es)
- üîú Push notifications (FCM, WebPush)
- üîú Advanced analytics (conversion tracking)
- üîú Grafana dashboards

***

## **üìÅ FILE STRUCTURE (Final)**

```
apps/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îî‚îÄ‚îÄ modules/
‚îÇ           ‚îî‚îÄ‚îÄ notifications/
‚îÇ               ‚îú‚îÄ‚îÄ controllers/
‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ notification.controller.ts
‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ notification-settings.controller.ts
‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ notification-admin.controller.ts
‚îÇ               ‚îú‚îÄ‚îÄ services/
‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ notification.service.ts
‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ notification-cost.service.ts
‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ notification-analytics.service.ts
‚îÇ               ‚îú‚îÄ‚îÄ processors/
‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ notification.processor.ts
‚îÇ               ‚îî‚îÄ‚îÄ notifications.module.ts

libs/
‚îî‚îÄ‚îÄ notifications/
    ‚îú‚îÄ‚îÄ src/
    ‚îÇ   ‚îú‚îÄ‚îÄ providers/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email/
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email.provider.ts
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ resend.provider.ts
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sendgrid.provider.ts
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sms/
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sms.provider.ts
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ smsru.provider.ts
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ smsc.provider.ts
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ telegram/
    ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ telegram.provider.ts
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ templates/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ emails/                    # React Email
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BallsEarnedEmail.tsx
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LevelUpgradedEmail.tsx
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WelcomeEmail.tsx
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PasswordResetEmail.tsx
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PromoAvailableEmail.tsx
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sms/
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ templates.ts           # Plain text
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram/
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ templates.ts           # Plain text
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ i18n.ts
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ utils/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deduplication.ts
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rate-limiting.ts
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ moderation.ts
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ template-renderer.ts
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ quiet-hours.ts
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ notifications.module.ts
    ‚îÇ
    ‚îî‚îÄ‚îÄ package.json
```


***

## **üéØ –ì–û–¢–û–í –ö –°–õ–ï–î–£–Æ–©–ï–ú–£ –ë–õ–û–ö–£!**

Notification System **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω** —Å —É—á—ë—Ç–æ–º –≤–∞—à–∏—Ö —Ä–µ—à–µ–Ω–∏–π:

- ‚úÖ 28 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø—Ä–∏–Ω—è—Ç—ã –∫–∞–∫ –µ—Å—Ç—å
- ‚úÖ 4 –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—é
- ‚úÖ Database schema –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
- ‚úÖ Cost estimation: **‚ÇΩ650/–º–µ—Å—è—Ü** –Ω–∞ 1000 –≥–æ—Å—Ç–µ–π

***

## **üìå –°–õ–ï–î–£–Æ–©–ò–ô –ë–õ–û–ö - –ß–¢–û –î–ï–¢–ê–õ–ò–ó–ò–†–£–ï–ú?**

1. **POS Integration (–¥–µ—Ç–∞–ª–∏)** - JSON-—Å—Ö–µ–º—ã webhooks iiko/R-Keeper, reconciliation logic, error handling
2. **Database Schema Prisma** - –ò–Ω–¥–µ–∫—Å—ã, –º–∏–≥—Ä–∞—Ü–∏–∏, constraints, performance optimization
3. **Infrastructure \& DevOps** - Docker, CI/CD, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
4. **Testing Strategy** - Unit, Integration, E2E, Load testing –¥–ª—è –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã
5. **Security \& Compliance** - OWASP, GDPR, PCI DSS, penetration testing

**–í—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä –±–ª–æ–∫–∞ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–≤–æ–π!** üöÄ

---

# POS Integration (–¥–µ—Ç–∞–ª–∏) - JSON-—Å—Ö–µ–º—ã webhooks iiko/R-Keeper, reconciliation logic, error handling, –¥–µ–ª–∞–µ–º.

–ó–∞–¥–∞–π 30+ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ + —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ —Ç–≤–æ–µ–º—É –ª—É—á—à–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ –¥–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö. –ü–µ—Ä–µ–¥ –∑–∞–¥–∞–≤–∞–Ω–∏–µ–º –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–≤–µ—Ä—å—Å—è —Å —Ñ–∞–π–ª–∞–º–∏, –º–æ–∂–µ—Ç –æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ –∏–ª–∏ –æ—Ç–≤–µ—Ç —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å.

–û—Ç–ª–∏—á–Ω–æ! –°–≤–µ—Ä–∏–ª—Å—è —Å —Ñ–∞–π–ª–∞–º–∏. –í–æ—Ç —á—Ç–æ **—É–∂–µ —Ä–µ—à–µ–Ω–æ** –æ POS Integration:

‚úÖ **HYBRID PUSH/PULL** (webhooks + PULL –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω)
‚úÖ **POS Systems**: iiko, R-Keeper, Poster
‚úÖ **HMAC-SHA256** –¥–ª—è webhooks
‚úÖ **Idempotency**: `tenantId + posSystem + posCheckId` UNIQUE
‚úÖ **Auto-create guest** –ø—Ä–∏ webhook (–µ—Å–ª–∏ `autocreateguestonposwebhook = true`)
‚úÖ **Reconciliation CRON** (–∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç missing webhooks + balance mismatches)
‚úÖ **Database models**: `POSIntegration`, `POSTransaction`, `POSSync`, `BallReconciliation`
‚úÖ **Sandbox mode** –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

***

**‚ùå –ù–ï –†–ï–®–ï–ù–û (–±—É–¥—É —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å):**

- –¢–æ—á–Ω—ã–µ JSON-—Å—Ö–µ–º—ã webhooks (iiko vs R-Keeper)
- Guest identification priority (phone vs posGuestId)
- Item categories mapping
- Payment methods –≤–ª–∏—è–Ω–∏–µ
- Error codes \& retry strategies
- Multi-location specifics
- Transaction cancellation/refund
- Initial bulk sync
- Monitoring \& Admin UI

***

# üîå **POS INTEGRATION: 36 –î–ï–¢–ê–õ–¨–ù–´–• –í–û–ü–†–û–°–û–í**

## **üì° 1. WEBHOOK JSON SCHEMAS (8 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **1. iiko Webhook Schema: –∫–∞–∫–∞—è –≤–µ—Ä—Å–∏—è API, –∫–∞–∫–∏–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã?**

**–í–û–ü–†–û–°:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å iiko Cloud API (–≤–µ—Ä—Å–∏—è 2.0) –∏–ª–∏ —Å—Ç–∞—Ä—ã–π iiko Server API (–≤–µ—Ä—Å–∏—è 1.0)?

- **A)** iiko Cloud API 2.0 (OAuth2, JSON, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤)
- **B)** iiko Server API 1.0 (HTTP Basic Auth, XML/JSON, legacy, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ–º)
- **C)** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –æ–±–∞ (detect by webhook payload structure)
- **D)** –¢–æ–ª—å–∫–æ iiko Cloud API 2.0 (–∑–∞—Å—Ç–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **C) –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –æ–±–∞ + –∞–¥–∞–ø—Ç–µ—Ä pattern**

```typescript
// libs/pos-integration/src/adapters/iiko/iiko-webhook.adapter.ts
interface IikoWebhookPayload {
  version: '1.0' | '2.0' // Detect version
  organizationId: string
  orderId: string // posCheckId
  orderDate: string // ISO 8601
  orderSum: number
  
  // Guest identification
  guestPhone?: string // Preferred
  guestCardNumber?: string // Loyalty card from iiko
  guestId?: string // iiko internal guest ID
  
  // Items
  items: Array<{
    productId: string // UUID
    productName: string
    categoryId?: string
    categoryName?: string
    price: number
    quantity: number
    sum: number
  }>
  
  // Payments
  payments: Array<{
    paymentType: string // CASH, CARD, ONLINE, etc.
    sum: number
  }>
  
  // Metadata
  restaurantId?: string // iiko terminal/section ID
  restaurantName?: string
  waiterName?: string
  tableNumber?: string
  
  // Timestamps
  createdAt: string // ISO 8601
  closedAt?: string // Order closed timestamp
}

@Injectable()
export class IikoWebhookAdapter {
  async parseWebhook(rawPayload: any): Promise<StandardizedPOSTransaction> {
    // 1. Detect version
    const version = this.detectVersion(rawPayload)
    
    // 2. Parse based on version
    if (version === '2.0') {
      return this.parseV2(rawPayload)
    } else {
      return this.parseV1(rawPayload)
    }
  }
  
  private detectVersion(payload: any): '1.0' | '2.0' {
    // iiko Cloud API 2.0 has `correlationId` field
    return payload.correlationId ? '2.0' : '1.0'
  }
  
  private async parseV2(payload: IikoCloudWebhook): Promise<StandardizedPOSTransaction> {
    return {
      posSystem: 'IIKO_CLOUD',
      posCheckId: payload.orderId,
      checkAmount: payload.orderSum,
      guestIdentifier: payload.customer?.phone || payload.customer?.cardNumber,
      items: payload.items.map(item => ({
        name: item.productName,
        category: item.categoryName,
        price: item.price,
        quantity: item.quantity,
      })),
      paymentMethods: payload.payments.map(p => p.paymentType),
      metadata: {
        restaurantId: payload.terminalGroupId,
        tableNumber: payload.order?.table?.number,
        waiterName: payload.order?.waiter?.name,
      },
      timestamp: new Date(payload.createdAt),
    }
  }
  
  private async parseV1(payload: IikoServerWebhook): Promise<StandardizedPOSTransaction> {
    // Similar parsing for v1
  }
}

// Standardized format (–Ω–∞—à –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç)
interface StandardizedPOSTransaction {
  posSystem: POSSystem // IIKO_CLOUD | IIKO_SERVER | RKEEPER | POSTER
  posCheckId: string
  checkAmount: number
  guestIdentifier?: string // phone or posGuestId
  items: Array<{
    name: string
    category?: string
    price: number
    quantity: number
  }>
  paymentMethods: string[]
  metadata: {
    restaurantId?: string
    tableNumber?: string
    waiterName?: string
    tips?: number
  }
  timestamp: Date
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- **Backward compatibility** (—Å—Ç–∞—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç)
- **Future-proof** (–≥–æ—Ç–æ–≤—ã –∫ iiko Cloud API 2.0)
- **–ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç** –≤–Ω—É—Ç—Ä–∏ –Ω–∞—à–µ–π —Å–∏—Å—Ç–µ–º—ã

***

### **2. R-Keeper Webhook Schema: XML –∏–ª–∏ JSON?**

**–í–û–ü–†–û–°:** R-Keeper –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç XML. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å XML webhooks?

- **A)** –¢–æ–ª—å–∫–æ JSON (—Ç—Ä–µ–±–æ–≤–∞—Ç—å –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å R-Keeper –Ω–∞ JSON export)
- **B)** XML + JSON (–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ `Content-Type: application/xml` vs `application/json`)
- **C)** XML ‚Üí –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ JSON —á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É (xml2js)
- **D)** –¢–æ–ª—å–∫–æ XML (JSON –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è R-Keeper –±–µ–∑ –∫–∞—Å—Ç–æ–º–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) XML + JSON (auto-detect)**

```typescript
// libs/pos-integration/src/adapters/rkeeper/rkeeper-webhook.adapter.ts
@Injectable()
export class RKeeperWebhookAdapter {
  constructor(private xmlParser: XMLParser) {}
  
  async parseWebhook(
    rawPayload: string | object,
    contentType: string
  ): Promise<StandardizedPOSTransaction> {
    let payload: RKeeperWebhookPayload
    
    // 1. Auto-detect format
    if (contentType.includes('application/xml') || typeof rawPayload === 'string') {
      // XML format
      payload = await this.xmlParser.parse(rawPayload as string)
    } else {
      // JSON format
      payload = rawPayload as RKeeperWebhookPayload
    }
    
    // 2. Standardize
    return this.standardize(payload)
  }
  
  private standardize(payload: RKeeperWebhookPayload): StandardizedPOSTransaction {
    return {
      posSystem: 'RKEEPER',
      posCheckId: payload.Order?.Id || payload.Order?.CheckNumber,
      checkAmount: parseFloat(payload.Order?.TotalSum || '0'),
      guestIdentifier: payload.Order?.Guest?.Phone || payload.Order?.Guest?.CardNumber,
      items: (payload.Order?.Items?.Item || []).map(item => ({
        name: item.Name,
        category: item.Category,
        price: parseFloat(item.Price),
        quantity: parseInt(item.Quantity, 10),
      })),
      paymentMethods: (payload.Order?.Payments?.Payment || []).map(p => p.Type),
      metadata: {
        restaurantId: payload.Order?.Terminal?.Id,
        tableNumber: payload.Order?.Table?.Number,
        waiterName: payload.Order?.Waiter?.Name,
      },
      timestamp: new Date(payload.Order?.DateTime),
    }
  }
}

// R-Keeper XML payload example
/*
<?xml version="1.0" encoding="UTF-8"?>
<Order>
  <Id>123456</Id>
  <DateTime>2026-02-11T12:30:00</DateTime>
  <TotalSum>2850.00</TotalSum>
  <Guest>
    <Phone>79991234567</Phone>
    <CardNumber>1234567890123</CardNumber>
  </Guest>
  <Items>
    <Item>
      <Name>–¢–æ–º –Ø–º</Name>
      <Category>–°—É–ø—ã</Category>
      <Price>650.00</Price>
      <Quantity>1</Quantity>
    </Item>
  </Items>
  <Payments>
    <Payment>
      <Type>CARD</Type>
      <Sum>2850.00</Sum>
    </Payment>
  </Payments>
  <Terminal>
    <Id>TERM-01</Id>
  </Terminal>
  <Table>
    <Number>12</Number>
  </Table>
  <Waiter>
    <Name>–ò–≤–∞–Ω–æ–≤ –ò.–ò.</Name>
  </Waiter>
</Order>
*/
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- **Flexibility** (—Ä–∞–±–æ—Ç–∞–µ–º —Å –æ–±–æ–∏–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏)
- **–ï–¥–∏–Ω—ã–π –∞–¥–∞–ø—Ç–µ—Ä** (–≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –Ω–∞—à `StandardizedPOSTransaction`)

***

### **3. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ vs –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ webhook**

**–í–û–ü–†–û–°:** –ö–∞–∫–∏–µ –ø–æ–ª—è webhook —Å—á–∏—Ç–∞—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ (reject –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç)?

- **A)** Strict validation: `posCheckId`, `checkAmount`, `timestamp` –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
- **B)** Relaxed: —Ç–æ–ª—å–∫–æ `posCheckId` –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, –æ—Å—Ç–∞–ª—å–Ω–æ–µ optional (default values)
- **C)** Configurable: Admin –≤—ã–±–∏—Ä–∞–µ—Ç required fields –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **D)** Adaptive: –µ—Å–ª–∏ `guestIdentifier` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí skip loyalty (–ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) Strict validation + D) Adaptive guest handling**

```typescript
// Validation schema (class-validator)
class WebhookTransactionDto {
  @IsString()
  @IsNotEmpty()
  posCheckId: string // REQUIRED
  
  @IsNumber()
  @Min(0)
  checkAmount: number // REQUIRED
  
  @IsDateString()
  timestamp: string // REQUIRED
  
  // OPTIONAL (–Ω–æ –∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è loyalty)
  @IsOptional()
  @IsString()
  guestPhone?: string
  
  @IsOptional()
  @IsString()
  posGuestId?: string
  
  @IsOptional()
  @IsArray()
  @ValidateNested({ each: true })
  @Type(() => OrderItemDto)
  items?: OrderItemDto[]
  
  @IsOptional()
  @IsArray()
  paymentMethods?: string[]
}

// Processing logic
async processWebhook(dto: WebhookTransactionDto) {
  // 1. Mandatory validation passed (posCheckId, checkAmount, timestamp exist)
  
  // 2. Try to identify guest
  const guestCard = await this.identifyGuest(dto.guestPhone, dto.posGuestId, dto.tenantId)
  
  if (!guestCard) {
    // Guest not identified ‚Üí log transaction but skip loyalty
    await this.prisma.posTransaction.create({
      data: {
        ...dto,
        guestIdentifier: dto.guestPhone || dto.posGuestId,
        syncStatus: 'GUEST_NOT_IDENTIFIED',
      },
    })
    
    this.logger.warn(`Transaction ${dto.posCheckId}: Guest not identified, loyalty skipped`)
    return { success: true, loyaltyProcessed: false }
  }
  
  // 3. Process loyalty
  await this.loyaltyService.processTransaction({
    guestCardId: guestCard.id,
    checkAmount: dto.checkAmount,
    items: dto.items,
    posCheckId: dto.posCheckId,
  })
  
  return { success: true, loyaltyProcessed: true }
}
```

**–õ–æ–≥–∏–∫–∞:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (idempotency, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ), –Ω–æ –≥–∏–±–∫–æ—Å—Ç—å –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≥–æ—Å—Ç–µ–π.

***

### **4. Webhook Authentication: HMAC signature –∏–ª–∏ API key?**

**–í–û–ü–†–û–°:** –ö–∞–∫ POS —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç webhook?

- **A)** HMAC-SHA256 signature (header `X-Signature`) + timestamp –¥–ª—è replay attack protection
- **B)** API Key (header `X-API-Key`) ‚Äî –ø—Ä–æ—â–µ, –Ω–æ –º–µ–Ω–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ
- **C)** Basic Auth (username/password)
- **D)** IP Whitelist —Ç–æ–ª—å–∫–æ (–±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) HMAC + timestamp (replay protection)**

```typescript
// Webhook signature verification middleware
@Injectable()
export class WebhookSignatureGuard implements CanActivate {
  constructor(private prisma: PrismaService) {}
  
  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest()
    const signature = request.headers['x-signature']
    const timestamp = request.headers['x-timestamp']
    const rawBody = request.rawBody // Raw string –¥–ª—è HMAC
    
    // 1. Check timestamp (prevent replay attacks)
    const requestTime = new Date(timestamp)
    const now = new Date()
    const diff = Math.abs(now.getTime() - requestTime.getTime()) / 1000 // seconds
    
    if (diff > 300) {
      // 5 minutes window
      throw new UnauthorizedException('Webhook timestamp expired (5 min window)')
    }
    
    // 2. Get POS integration config (webhook secret)
    const posIntegration = await this.prisma.posIntegration.findFirst({
      where: {
        restaurantId: request.body.restaurantId,
        isActive: true,
      },
    })
    
    if (!posIntegration) {
      throw new UnauthorizedException('POS integration not found')
    }
    
    // 3. Calculate expected signature
    const expectedSignature = this.calculateHMAC(
      rawBody,
      timestamp,
      posIntegration.webhookSecret
    )
    
    // 4. Compare signatures (constant-time comparison to prevent timing attacks)
    if (!crypto.timingSafeEqual(Buffer.from(signature), Buffer.from(expectedSignature))) {
      throw new UnauthorizedException('Invalid webhook signature')
    }
    
    return true
  }
  
  private calculateHMAC(body: string, timestamp: string, secret: string): string {
    const payload = `${timestamp}.${body}`
    return crypto
      .createHmac('sha256', secret)
      .update(payload)
      .digest('hex')
  }
}

// Controller
@Controller('/api/v1/pos/webhooks')
@UseGuards(WebhookSignatureGuard)
export class POSWebhookController {
  @Post('/transaction')
  async handleTransaction(@Body() dto: WebhookTransactionDto) {
    // Signature verified by guard
    return this.posService.processWebhook(dto)
  }
}
```

**POS-—Å—Ç–æ—Ä–æ–Ω–∞ (iiko/R-Keeper –Ω–∞—Å—Ç—Ä–æ–π–∫–∞):**

```bash
# Webhook URL configuration in POS admin panel
POST https://api.max-loyalty.com/api/v1/pos/webhooks/transaction
Headers:
  X-Signature: <HMAC-SHA256(timestamp.body, secret)>
  X-Timestamp: 2026-02-11T12:30:00Z
  Content-Type: application/json

Body:
{
  "posCheckId": "CHK-123456",
  "checkAmount": 2850,
  "guestPhone": "79991234567",
  ...
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- **Secure** (–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å –±–µ–∑ secret)
- **Replay protection** (timestamp window 5 –º–∏–Ω—É—Ç)
- **Industry standard** (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Stripe, GitHub webhooks)

***

### **5. Transaction Cancellation/Refund webhook**

**–í–û–ü–†–û–°:** –ö–∞–∫ POS –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–º–µ–Ω—É/–≤–æ–∑–≤—Ä–∞—Ç —á–µ–∫–∞?

- **A)** –û—Ç–¥–µ–ª—å–Ω—ã–π endpoint `/webhooks/refund` —Å `originalPosCheckId`
- **B)** –¢–æ—Ç –∂–µ endpoint `/webhooks/transaction` —Å `type: 'REFUND'` –ø–æ–ª–µ–º
- **C)** Negative checkAmount (–Ω–∞–ø—Ä–∏–º–µ—Ä, `-2850` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞)
- **D)** –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –≤–æ–∑–≤—Ä–∞—Ç—ã (MVP), —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) –¢–æ—Ç –∂–µ endpoint + type field**

```typescript
interface WebhookTransactionDto {
  posCheckId: string
  type: 'SALE' | 'REFUND' | 'CANCEL' // Transaction type
  originalPosCheckId?: string // –î–ª—è REFUND/CANCEL
  checkAmount: number // –í—Å–µ–≥–¥–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π (–¥–∞–∂–µ –¥–ª—è refund)
  refundAmount?: number // Partial refund
  // ...
}

async processWebhook(dto: WebhookTransactionDto) {
  if (dto.type === 'REFUND') {
    return this.processRefund(dto)
  } else if (dto.type === 'CANCEL') {
    return this.processCancel(dto)
  } else {
    return this.processSale(dto)
  }
}

async processRefund(dto: WebhookTransactionDto) {
  // 1. –ù–∞–π—Ç–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
  const originalTransaction = await this.prisma.posTransaction.findUnique({
    where: {
      tenantId_posSystem_posCheckId: {
        tenantId: dto.tenantId,
        posSystem: dto.posSystem,
        posCheckId: dto.originalPosCheckId,
      },
    },
    include: { ballTransactions: true },
  })
  
  if (!originalTransaction) {
    throw new NotFoundException(`Original transaction ${dto.originalPosCheckId} not found`)
  }
  
  // 2. Reverse loyalty transactions
  const refundRatio = dto.refundAmount 
    ? dto.refundAmount / originalTransaction.checkAmount 
    : 1.0 // Full refund
  
  for (const ballTx of originalTransaction.ballTransactions) {
    const refundAmount = Math.floor(ballTx.amount * refundRatio)
    
    await this.prisma.ballTransaction.create({
      data: {
        guestCardId: ballTx.guestCardId,
        type: ballTx.type === 'EARN' ? 'REFUND_EARN' : 'REFUND_REDEEM',
        amount: -refundAmount, // Negative amount
        balanceType: ballTx.balanceType,
        balanceBefore: guestCard.totalBalance,
        balanceAfter: guestCard.totalBalance - refundAmount,
        posTransactionId: refundTransaction.id,
        reason: `Refund of transaction ${dto.originalPosCheckId}`,
      },
    })
    
    // Update guest card balance
    await this.prisma.guestCard.update({
      where: { id: ballTx.guestCardId },
      data: {
        totalBalance: { decrement: refundAmount },
        regularBalance: ballTx.balanceType === 'REGULAR' 
          ? { decrement: refundAmount } 
          : undefined,
        promoBalance: ballTx.balanceType === 'PROMO' 
          ? { decrement: refundAmount } 
          : undefined,
      },
    })
  }
  
  // 3. Create refund POS transaction
  const refundTransaction = await this.prisma.posTransaction.create({
    data: {
      ...dto,
      transactionType: 'REFUND',
      originalPosCheckId: dto.originalPosCheckId,
      syncStatus: 'COMPLETED',
    },
  })
  
  // 4. Notify guest
  await this.notificationService.send({
    recipientId: guestCard.userId,
    type: 'BALLS_REFUNDED',
    message: `–í–æ–∑–≤—Ä–∞—Ç —á–µ–∫–∞ –Ω–∞ ${dto.checkAmount} ‚ÇΩ. –°–ø–∏—Å–∞–Ω–æ ${totalRefundedBalls} –±–∞–ª–ª–æ–≤.`,
  })
  
  return { success: true, refunded: true }
}
```

**Partial refund example:**

```json
{
  "posCheckId": "CHK-123456-REFUND",
  "type": "REFUND",
  "originalPosCheckId": "CHK-123456",
  "checkAmount": 2850,
  "refundAmount": 1500, // Partial refund (1500 –∏–∑ 2850)
  "timestamp": "2026-02-11T14:00:00Z"
}
```

**–õ–æ–≥–∏–∫–∞:**

- Full refund ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ –±–∞–ª–ª—ã
- Partial refund ‚Üí –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (1500/2850 = 52.6%)

***

### **6. Items array: –Ω—É–∂–Ω—ã –ª–∏ –¥–ª—è –±–∞–∑–æ–≤–æ–π loyalty?**

**–í–û–ü–†–û–°:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–∞—Å—Å–∏–≤ `items` (–±–ª—é–¥–∞) –¥–ª—è item-level loyalty rules?

- **A)** MVP: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º items, —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ `checkAmount`
- **B)** Phase 1: –ø–∞—Ä—Å–∏–º items, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º (–≥–æ—Ç–æ–≤–∏–º—Å—è –∫ item-level rules)
- **C)** Phase 1: –∏—Å–ø–æ–ª—å–∑—É–µ–º items –¥–ª—è category-based rules (10% –∑–∞ –ø–∏—Ü—Ü—É, 5% –∑–∞ –æ—Å—Ç–∞–ª—å–Ω–æ–µ)
- **D)** Phase 2: item-level rules (–±—É–¥–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ–∑–∂–µ)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **C) Category-based rules –≤ Phase 1**

```typescript
// Webhook payload with items
{
  "posCheckId": "CHK-123456",
  "checkAmount": 2850,
  "items": [
    {
      "productId": "prod-1",
      "name": "–¢–æ–º –Ø–º",
      "category": "–°—É–ø—ã",
      "price": 650,
      "quantity": 1
    },
    {
      "productId": "prod-2",
      "name": "–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è",
      "category": "–†–æ–ª–ª—ã",
      "price": 850,
      "quantity": 2
    },
    {
      "productId": "prod-3",
      "name": "Coca-Cola",
      "category": "–ù–∞–ø–∏—Ç–∫–∏",
      "price": 250,
      "quantity": 2
    }
  ]
}

// Loyalty rule with category conditions
{
  "name": "Bonus –∑–∞ —Ä–æ–ª–ª—ã 15%",
  "earnPercent": 15,
  "conditions": {
    "categories": ["–†–æ–ª–ª—ã"] // Apply only to rolls
  }
}

// Calculate loyalty
async calculateEarnPoints(dto: CalculateDto): Promise<number> {
  const rules = await this.getActiveLoyaltyRules(dto.tenantId)
  let totalEarn = 0
  
  for (const rule of rules) {
    if (rule.conditions?.categories) {
      // Category-based rule
      const categorySum = dto.items
        .filter(item => rule.conditions.categories.includes(item.category))
        .reduce((sum, item) => sum + item.price * item.quantity, 0)
      
      totalEarn += Math.floor(categorySum * (rule.earnPercent / 100))
    } else {
      // Global rule (all items)
      totalEarn += Math.floor(dto.checkAmount * (rule.earnPercent / 100))
    }
  }
  
  return totalEarn
}
```

**Example:**

- Check: 2850 ‚ÇΩ (–¢–æ–º –Ø–º 650 + –†–æ–ª–ª—ã 1700 + Coca-Cola 500)
- Rule 1: 15% –∑–∞ "–†–æ–ª–ª—ã" ‚Üí 1700 * 15% = 255 –±–∞–ª–ª–æ–≤
- Rule 2: 5% –∑–∞ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí 1150 * 5% = 57 –±–∞–ª–ª–æ–≤
- **Total: 312 –±–∞–ª–ª–æ–≤**

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** –ì–∏–±–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∞–ª–∫–æ–≥–æ–ª—å 0%, –µ–¥–∞ 10%, –¥–µ—Å–µ—Ä—Ç—ã 15%)

***

### **7. Payment methods: –≤–ª–∏—è—é—Ç –Ω–∞ loyalty?**

**–í–û–ü–†–û–°:** –£—á–∏—Ç—ã–≤–∞—Ç—å –ª–∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–Ω–∞–ª–∏—á–∫–∞, –∫–∞—Ä—Ç–∞, –æ–Ω–ª–∞–π–Ω) –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –±–∞–ª–ª–æ–≤?

- **A)** –ù–µ—Ç, —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –Ω–µ –≤–ª–∏—è–µ—Ç (loyalty –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è)
- **B)** –î–∞, —Ä–∞–∑–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ (–Ω–∞–ª–∏—á–∫–∞ 5%, –∫–∞—Ä—Ç–∞ 10%)
- **C)** –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (Admin –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∏—Ç—å payment-based rules)
- **D)** –¢–æ–ª—å–∫–æ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ, –Ω–æ —Ç—Ä–µ–∫–∞–µ–º)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **C) –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ + D) –ê–Ω–∞–ª–∏—Ç–∏–∫–∞**

```typescript
// Webhook payload with payment methods
{
  "posCheckId": "CHK-123456",
  "checkAmount": 2850,
  "payments": [
    {
      "type": "CARD", // CASH, CARD, ONLINE, APPLE_PAY, GOOGLE_PAY, SBP
      "sum": 2850
    }
  ]
}

// Loyalty rule with payment method condition (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
{
  "name": "Cashback 15% –∑–∞ –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç—É",
  "earnPercent": 15,
  "conditions": {
    "paymentMethods": ["ONLINE", "APPLE_PAY", "GOOGLE_PAY"]
  }
}

// Calculate loyalty with payment method filter
async calculateEarnPoints(dto: CalculateDto): Promise<number> {
  const rules = await this.getActiveLoyaltyRules(dto.tenantId)
  let totalEarn = 0
  
  for (const rule of rules) {
    if (rule.conditions?.paymentMethods) {
      // Payment-specific rule
      const applicablePayments = dto.payments.filter(p => 
        rule.conditions.paymentMethods.includes(p.type)
      )
      
      if (applicablePayments.length === 0) {
        continue // Skip rule if payment method doesn't match
      }
      
      const paymentSum = applicablePayments.reduce((sum, p) => sum + p.sum, 0)
      totalEarn += Math.floor(paymentSum * (rule.earnPercent / 100))
    } else {
      // Global rule
      totalEarn += Math.floor(dto.checkAmount * (rule.earnPercent / 100))
    }
  }
  
  return totalEarn
}

// Analytics tracking (–≤—Å–µ–≥–¥–∞)
await this.prisma.posTransaction.create({
  data: {
    ...dto,
    paymentMethods: dto.payments.map(p => p.type), // Store for analytics
  },
})

// Analytics query: payment methods distribution
const paymentStats = await this.prisma.posTransaction.groupBy({
  by: ['paymentMethods'],
  _count: true,
  _sum: { checkAmount: true },
})
// Result: { CARD: 856 checks (67%), CASH: 324 checks (25%), ONLINE: 102 checks (8%) }
```

**Use case:** –†–µ—Å—Ç–æ—Ä–∞–Ω —Ö–æ—á–µ—Ç —Å—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑–Ω–∞–ª–∏—á–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ ‚Üí –¥–∞—é—Ç 15% –±–∞–ª–ª–æ–≤ –∑–∞ –∫–∞—Ä—Ç—É, 10% –∑–∞ –Ω–∞–ª–∏—á–∫—É.

***

### **8. Webhook idempotency: –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã?**

**–í–û–ü–†–û–°:** –ï—Å–ª–∏ POS –æ—Ç–ø—Ä–∞–≤–∏–ª webhook –¥–≤–∞–∂–¥—ã (network retry), –∫–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è?

- **A)** Database UNIQUE constraint (`tenantId + posSystem + posCheckId`)
- **B)** Redis cache (TTL 24 —á–∞—Å–∞) + DB constraint
- **C)** `Idempotency-Key` header (POS –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç, –º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º)
- **D)** –ö–æ–º–±–æ: B + A (Redis –¥–ª—è fast reject, DB –¥–ª—è persistence)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Redis + DB (–¥–≤–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞)**

```typescript
async processWebhook(dto: WebhookTransactionDto): Promise<ProcessResult> {
  const idempotencyKey = `webhook:${dto.tenantId}:${dto.posSystem}:${dto.posCheckId}`
  
  // 1. Check Redis cache (fast path)
  const cached = await this.redis.get(idempotencyKey)
  if (cached) {
    this.logger.warn(`Duplicate webhook detected (cached): ${dto.posCheckId}`)
    return JSON.parse(cached) // Return cached result
  }
  
  // 2. Try to create POS transaction (DB unique constraint)
  try {
    const posTransaction = await this.prisma.posTransaction.create({
      data: {
        tenantId: dto.tenantId,
        posSystem: dto.posSystem,
        posCheckId: dto.posCheckId,
        checkAmount: dto.checkAmount,
        // ...
      },
    })
    
    // 3. Process loyalty
    const result = await this.loyaltyService.processTransaction({
      posTransactionId: posTransaction.id,
      guestCardId: guestCard.id,
      checkAmount: dto.checkAmount,
    })
    
    // 4. Cache result (TTL 24 hours)
    await this.redis.setex(
      idempotencyKey,
      86400, // 24 hours
      JSON.stringify(result)
    )
    
    return result
    
  } catch (error) {
    if (error.code === 'P2002') {
      // Unique constraint violation ‚Üí duplicate
      this.logger.warn(`Duplicate webhook detected (DB): ${dto.posCheckId}`)
      
      // Return existing transaction result
      const existing = await this.prisma.posTransaction.findUnique({
        where: {
          tenantId_posSystem_posCheckId: {
            tenantId: dto.tenantId,
            posSystem: dto.posSystem,
            posCheckId: dto.posCheckId,
          },
        },
        include: { ballTransactions: true },
      })
      
      return { success: true, alreadyProcessed: true, transaction: existing }
    }
    
    throw error
  }
}

// Prisma schema
model POSTransaction {
  id              String @id @default(uuid())
  tenantId        String
  posSystem       POSSystem
  posCheckId      String
  
  // ... other fields
  
  @@unique([tenantId, posSystem, posCheckId]) // Idempotency constraint
}
```

**Flow:**

1. Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–π —Ä–∞–∑ ‚Üí Redis –ø—É—Å—Ç–æ, DB —Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
2. Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ ‚Üí Redis –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç cached result (200ms)
3. –ï—Å–ª–∏ Redis expired ‚Üí DB unique constraint reject ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º existing result

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- **Fast rejection** (Redis –±–µ–∑ DB query)
- **Reliable** (–¥–∞–∂–µ –µ—Å–ª–∏ Redis down, DB constraint –∑–∞—â–∏—Ç–∏—Ç)

***

## **üë§ 2. GUEST IDENTIFICATION (4 –≤–æ–ø—Ä–æ—Å–∞)**

### **9. Guest identification priority: phone vs posGuestId**

**–í–û–ü–†–û–°:** –ï—Å–ª–∏ webhook —Å–æ–¥–µ—Ä–∂–∏—Ç –∏ `guestPhone`, –∏ `posGuestId` (internal POS guest ID), –∫–∞–∫–æ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?

- **A)** Priority: phone > posGuestId (phone –Ω–∞–¥—ë–∂–Ω–µ–µ)
- **B)** Priority: posGuestId > phone (POS –∑–Ω–∞–µ—Ç –ª—É—á—à–µ)
- **C)** Configurable (Admin –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
- **D)** Try both: —Å–Ω–∞—á–∞–ª–∞ phone, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí posGuestId

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Try both (phone first)**

```typescript
async identifyGuest(
  phone: string | undefined,
  posGuestId: string | undefined,
  tenantId: string,
  restaurantId: string,
  posSystem: POSSystem
): Promise<GuestCard | null> {
  // 1. Try phone first (most reliable)
  if (phone) {
    const normalizedPhone = this.normalizePhone(phone) // +79991234567 ‚Üí 79991234567
    
    const guestCard = await this.prisma.guestCard.findFirst({
      where: {
        tenantId,
        restaurantId, // SEPARATE mode: filter by restaurant
        user: {
          phone: normalizedPhone,
        },
        status: { in: ['ACTIVE', 'MIGRATED'] },
      },
      include: { user: true },
    })
    
    if (guestCard) {
      // Update POSGuestLink (–¥–ª—è future lookups)
      await this.updatePOSGuestLink(guestCard.id, posGuestId, posSystem)
      return guestCard
    }
  }
  
  // 2. Try posGuestId fallback
  if (posGuestId) {
    const posLink = await this.prisma.posGuestLink.findUnique({
      where: {
        posSystem_posGuestId_tenantId: {
          posSystem,
          posGuestId,
          tenantId,
        },
      },
      include: { guestCard: { include: { user: true } } },
    })
    
    if (posLink) {
      return posLink.guestCard
    }
  }
  
  // 3. Not found ‚Üí check auto-create setting
  const posIntegration = await this.getPOSIntegration(tenantId, restaurantId)
  
  if (posIntegration.autoCreateGuestOnWebhook && phone) {
    return this.autoCreateGuest(phone, posGuestId, tenantId, restaurantId, posSystem)
  }
  
  return null // Guest not identified
}

// POSGuestLink table (many-to-many: GuestCard ‚Üî POS guests)
model POSGuestLink {
  id          String    @id @default(uuid())
  guestCardId String
  guestCard   GuestCard @relation(...)
  
  posSystem   POSSystem // IIKO_CLOUD | RKEEPER
  posGuestId  String    // POS internal guest ID
  tenantId    String
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([posSystem, posGuestId, tenantId])
}
```

**Logic:**

1. **Phone** ‚Üí –Ω–∞—à primary identifier (–≥–æ—Å—Ç—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å phone –≤ Telegram, Web)
2. **posGuestId** ‚Üí fallback (–µ—Å–ª–∏ –≥–æ—Å—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Ç–æ–ª—å–∫–æ –≤ POS)
3. **POSGuestLink** ‚Üí —Å–≤—è–∑—ã–≤–∞–µ–º –Ω–∞—à–∏ –∫–∞—Ä—Ç—ã —Å POS guest IDs (–¥–ª—è reconciliation)

***

### **10. Auto-create guest: –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã?**

**–í–û–ü–†–û–°:** –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω `autoCreateGuestOnWebhook = true`, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–æ—Å—Ç—è?

- **A)** –¢–æ–ª—å–∫–æ phone (–º–∏–Ω–∏–º—É–º)
- **B)** Phone + firstName (–∏–∑ POS, –µ—Å–ª–∏ –µ—Å—Ç—å)
- **C)** Phone + firstName + email (–µ—Å–ª–∏ POS –ø–µ—Ä–µ–¥–∞—ë—Ç)
- **D)** –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —è–≤–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Phone + firstName (optional)**

```typescript
async autoCreateGuest(
  phone: string,
  posGuestId: string | undefined,
  tenantId: string,
  restaurantId: string,
  posSystem: POSSystem,
  posGuestData?: {
    firstName?: string
    lastName?: string
    email?: string
    birthdate?: string
  }
): Promise<GuestCard> {
  return this.prisma.$transaction(async (tx) => {
    // 1. Create User
    const user = await tx.user.create({
      data: {
        phone: this.normalizePhone(phone),
        email: posGuestData?.email,
        role: 'GUEST',
        phoneVerified: false, // POS –Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç phone
        passwordHash: null, // No password yet (can set via Telegram/Web later)
      },
    })
    
    // 2. Create GuestProfile
    await tx.guestProfile.create({
      data: {
        userId: user.id,
        firstName: posGuestData?.firstName || '–ì–æ—Å—Ç—å',
        lastName: posGuestData?.lastName,
        birthdate: posGuestData?.birthdate ? new Date(posGuestData.birthdate) : null,
        privacyPolicyAccepted: false, // Will ask in Telegram/Web
        marketingAccepted: false,
      },
    })
    
    // 3. Get initial loyalty level (Bronze)
    const loyaltySystem = await this.getLoyaltySystem(tenantId, restaurantId, tx)
    const initialLevel = await tx.loyaltyLevel.findFirst({
      where: { loyaltySystemId: loyaltySystem.id },
      orderBy: { threshold: 'asc' },
    })
    
    // 4. Create GuestCard
    const guestCard = await tx.guestCard.create({
      data: {
        userId: user.id,
        tenantId,
        restaurantId, // SEPARATE mode
        qrCode: this.generateQRCode(),
        code6Digit: this.generate6DigitCode(),
        regularBalance: 0,
        promoBalance: 0,
        totalBalance: 0,
        lifetimeSpent: 0,
        totalVisits: 0,
        loyaltyLevelId: initialLevel?.id,
        status: 'ACTIVE',
        registrationSource: 'POS_AUTO',
        lastActivityAt: new Date(),
      },
      include: { user: true, loyaltyLevel: true },
    })
    
    // 5. Link POS guest ID
    if (posGuestId) {
      await tx.posGuestLink.create({
        data: {
          guestCardId: guestCard.id,
          posSystem,
          posGuestId,
          tenantId,
        },
      })
    }
    
    // 6. Log activity
    await this.activityLogService.log({
      tenantId,
      actionType: 'CREATE_GUEST',
      entityType: 'GUESTCARD',
      entityId: guestCard.id,
      description: `Auto-created from POS webhook (${posSystem})`,
      metadata: { posGuestId, phone },
    }, tx)
    
    // 7. Send welcome notification (if Telegram linked later)
    // (skip for now, will send when guest opens Telegram bot)
    
    return guestCard
  })
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** Auto-created guests –∏–º–µ—é—Ç `phoneVerified = false` ‚Üí –ø–æ–∑–∂–µ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ Telegram/Web –ø–æ–ø—Ä–æ—Å–∏–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å phone —á–µ—Ä–µ–∑ SMS.

***

### **11. Guest merging: –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ 2+ –∫–∞—Ä—Ç—ã —Å –æ–¥–Ω–∏–º phone**

**–í–û–ü–†–û–°:** –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ phone –Ω–∞–π–¥–µ–Ω –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–∞—Ä—Ç–∞—Ö (UNIFIED ‚Üí SEPARATE migration, –¥—É–±–ª–∏–∫–∞—Ç—ã)?

- **A)** –í–∑—è—Ç—å –ø–µ—Ä–≤—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é –∫–∞—Ä—Ç—É (–ø–æ `createdAt`)
- **B)** –í–∑—è—Ç—å –∫–∞—Ä—Ç—É —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º
- **C)** –í–∑—è—Ç—å –∫–∞—Ä—Ç—É –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ `restaurantId` (SEPARATE mode)
- **D)** Merge –∫–∞—Ä—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Å—É–º–º–∏—Ä—É–µ–º –±–∞–ª–∞–Ω—Å—ã)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **C) –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è restaurantId (SEPARATE)**

```typescript
async identifyGuest(
  phone: string,
  tenantId: string,
  restaurantId: string
): Promise<GuestCard | null> {
  const normalizedPhone = this.normalizePhone(phone)
  
  // 1. Try exact match (restaurantId + phone)
  const exactMatch = await this.prisma.guestCard.findFirst({
    where: {
      tenantId,
      restaurantId, // SEPARATE mode
      user: { phone: normalizedPhone },
      status: { in: ['ACTIVE', 'MIGRATED'] },
    },
  })
  
  if (exactMatch) {
    return exactMatch
  }
  
  // 2. Fallback: find any card for this phone (UNIFIED mode or other restaurants)
  const anyCard = await this.prisma.guestCard.findFirst({
    where: {
      tenantId,
      user: { phone: normalizedPhone },
      status: { in: ['ACTIVE', 'MIGRATED'] },
    },
    orderBy: [
      { totalBalance: 'desc' }, // Prefer card with max balance
      { createdAt: 'asc' }, // Then prefer oldest card
    ],
  })
  
  if (anyCard) {
    this.logger.warn(
      `Guest ${phone} found in different restaurant (${anyCard.restaurantId}), using it for ${restaurantId}`
    )
    
    // Option: prompt Admin to merge cards
    await this.flagForMerge(anyCard.id, restaurantId)
  }
  
  return anyCard
}

// Admin UI: merge cards manually
async mergeGuestCards(
  sourceCardId: string,
  targetCardId: string,
  adminUserId: string
): Promise<GuestCard> {
  return this.prisma.$transaction(async (tx) => {
    const sourceCard = await tx.guestCard.findUnique({ where: { id: sourceCardId } })
    const targetCard = await tx.guestCard.findUnique({ where: { id: targetCardId } })
    
    // 1. Transfer balances
    await tx.guestCard.update({
      where: { id: targetCardId },
      data: {
        regularBalance: { increment: sourceCard.regularBalance },
        promoBalance: { increment: sourceCard.promoBalance },
        totalBalance: { increment: sourceCard.totalBalance },
        lifetimeSpent: { increment: sourceCard.lifetimeSpent },
        totalVisits: { increment: sourceCard.totalVisits },
      },
    })
    
    // 2. Move ball transactions
    await tx.ballTransaction.updateMany({
      where: { guestCardId: sourceCardId },
      data: { guestCardId: targetCardId },
    })
    
    // 3. Soft delete source card
    await tx.guestCard.update({
      where: { id: sourceCardId },
      data: {
        status: 'MERGED',
        deletedAt: new Date(),
      },
    })
    
    // 4. Log activity
    await this.activityLogService.log({
      actionType: 'MERGE_GUESTCARDS',
      entityType: 'GUESTCARD',
      entityId: targetCardId,
      performedBy: adminUserId,
      metadata: {
        sourceCardId,
        mergedBalance: sourceCard.totalBalance,
      },
    }, tx)
    
    return tx.guestCard.findUnique({ where: { id: targetCardId } })
  })
}
```

**Admin UI notification:**

```
‚ö†Ô∏è Duplicate guest cards detected
Phone: +7 999 123-45-67
Cards:
  1. Restaurant "–°—É—à–∏–ª–∫–∞" ‚Äî 2,850 –±–∞–ª–ª–æ–≤ (created 2025-01-15)
  2. Restaurant "–ü–∏—Ü—Ü–µ—Ä–∏—è" ‚Äî 1,200 –±–∞–ª–ª–æ–≤ (created 2025-06-20)

[Merge Cards] [Ignore]
```


***

### **12. Phone normalization: +7 vs 8 vs 79991234567**

**–í–û–ü–†–û–°:** POS –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å phone –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö. –ö–∞–∫ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å?

- **A)** –í—Å–µ–≥–¥–∞ —Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ `79991234567` (–±–µ–∑ + –∏ –ø—Ä–æ–±–µ–ª–æ–≤)
- **B)** –•—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–∏–ª POS (–±–µ–∑ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏)
- **C)** –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç E.164: `+79991234567`
- **D)** Configurable (Admin –≤—ã–±–∏—Ä–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç per tenant)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ `79991234567`**

```typescript
function normalizePhone(phone: string): string {
  // 1. Remove all non-digits
  let digits = phone.replace(/\D/g, '')
  
  // 2. Handle Russian phone formats
  if (digits.startsWith('8') && digits.length === 11) {
    // 89991234567 ‚Üí 79991234567
    digits = '7' + digits.slice(1)
  } else if (digits.startsWith('7') && digits.length === 11) {
    // 79991234567 ‚Üí ok
  } else if (digits.length === 10) {
    // 9991234567 ‚Üí 79991234567
    digits = '7' + digits
  } else {
    // International format or invalid
    throw new BadRequestException(`Invalid phone format: ${phone}`)
  }
  
  return digits // Always 11 digits: 79991234567
}

// Examples:
normalizePhone('+7 (999) 123-45-67') // ‚Üí '79991234567'
normalizePhone('8 999 123 45 67')    // ‚Üí '79991234567'
normalizePhone('9991234567')         // ‚Üí '79991234567'
normalizePhone('+79991234567')       // ‚Üí '79991234567'
```

**Database:**

```prisma
model User {
  phone String @unique // Always stored as '79991234567'
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- **Consistent lookups** (–Ω–µ –∑–∞–≤–∏—Å–∏–º –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞ POS)
- **Unique constraint** —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

***

## **üó∫Ô∏è 3. DATA MAPPING \& CATEGORIES (4 –≤–æ–ø—Ä–æ—Å–∞)**

### **13. Category mapping: POS category ‚Üí –Ω–∞—à–∏ category**

**–í–û–ü–†–û–°:** POS categories –º–æ–≥—É—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è –ø–æ-—Ä–∞–∑–Ω–æ–º—É ("–°—É–ø—ã" vs "Soups" vs "hot-dishes"). –ö–∞–∫ –º–∞–ø–∏—Ç—å?

- **A)** Admin —Å–æ–∑–¥–∞—ë—Ç manual mapping table (POS category ‚Üí Loyalty category)
- **B)** Fuzzy matching (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏–º –ø–æ—Ö–æ–∂–∏–µ: "–°—É–ø" ‚Üí "–°—É–ø—ã")
- **C)** Ignore (–ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—ë–º POS category name –≤ loyalty rules)
- **D)** –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ + manual mapping

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) Manual mapping table + D) Presets**

```typescript
// Database schema
model CategoryMapping {
  id                String @id @default(uuid())
  tenantId          String
  restaurantId      String?
  posSystem         POSSystem
  
  // POS category
  posCategoryId     String
  posCategoryName   String
  
  // Our standard category
  loyaltyCategoryId String
  loyaltyCategory   LoyaltyCategory @relation(...)
  
  createdAt         DateTime @default(now())
  
  @@unique([tenantId, posSystem, posCategoryId])
}

model LoyaltyCategory {
  id          String @id @default(uuid())
  tenantId    String
  name        String // "–°—É–ø—ã", "–†–æ–ª–ª—ã", "–ù–∞–ø–∏—Ç–∫–∏", etc.
  slug        String // "soups", "rolls", "drinks"
  icon        String?
  
  // For loyalty rules
  rules       LoyaltyRule[]
  
  @@unique([tenantId, slug])
}

// Admin UI: Category Mapping
// POS Category      ‚Üí  Loyalty Category
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –°—É–ø—ã (iiko)       ‚Üí  –°—É–ø—ã ‚úì
// –†–æ–ª–ª—ã (iiko)      ‚Üí  –†–æ–ª–ª—ã ‚úì
// Hot Dishes        ‚Üí  [Select category ‚ñº]
// Beverages         ‚Üí  –ù–∞–ø–∏—Ç–∫–∏ ‚úì

// Service: map category
async mapCategory(
  posSystem: POSSystem,
  posCategoryId: string,
  posCategoryName: string,
  tenantId: string
): Promise<string | null> {
  // 1. Check mapping table
  const mapping = await this.prisma.categoryMapping.findUnique({
    where: {
      tenantId_posSystem_posCategoryId: {
        tenantId,
        posSystem,
        posCategoryId,
      },
    },
  })
  
  if (mapping) {
    return mapping.loyaltyCategoryId
  }
  
  // 2. Auto-create mapping if category name matches exactly
  const exactMatch = await this.prisma.loyaltyCategory.findFirst({
    where: {
      tenantId,
      name: posCategoryName, // Exact match
    },
  })
  
  if (exactMatch) {
    // Auto-create mapping
    await this.prisma.categoryMapping.create({
      data: {
        tenantId,
        posSystem,
        posCategoryId,
        posCategoryName,
        loyaltyCategoryId: exactMatch.id,
      },
    })
    
    return exactMatch.id
  }
  
  // 3. Not mapped ‚Üí use POS category name as-is (fallback)
  return null
}

// Calculate loyalty with mapped categories
async calculateEarnPoints(dto: CalculateDto): Promise<number> {
  const rules = await this.getActiveLoyaltyRules(dto.tenantId)
  let totalEarn = 0
  
  for (const rule of rules) {
    if (rule.conditions?.categories) {
      // Map POS categories to loyalty categories
      const mappedItems = await Promise.all(
        dto.items.map(async (item) => {
          const loyaltyCategoryId = await this.mapCategory(
            dto.posSystem,
            item.categoryId,
            item.category,
            dto.tenantId
          )
          
          return { ...item, loyaltyCategoryId }
        })
      )
      
      // Filter items matching rule categories
      const matchingItems = mappedItems.filter(item =>
        rule.conditions.categories.includes(item.loyaltyCategoryId)
      )
      
      const categorySum = matchingItems.reduce((sum, item) => 
        sum + item.price * item.quantity, 0
      )
      
      totalEarn += Math.floor(categorySum * (rule.earnPercent / 100))
    }
  }
  
  return totalEarn
}
```

**Preset categories (–ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ tenant):**

```typescript
const PRESET_CATEGORIES = [
  { name: '–°—É–ø—ã', slug: 'soups', icon: 'üçú' },
  { name: '–†–æ–ª–ª—ã', slug: 'rolls', icon: 'üç£' },
  { name: '–ü–∏—Ü—Ü–∞', slug: 'pizza', icon: 'üçï' },
  { name: '–ù–∞–ø–∏—Ç–∫–∏', slug: 'drinks', icon: 'ü•§' },
  { name: '–î–µ—Å–µ—Ä—Ç—ã', slug: 'desserts', icon: 'üç∞' },
  { name: '–ê–ª–∫–æ–≥–æ–ª—å', slug: 'alcohol', icon: 'üç∑' },
  { name: '–°–∞–ª–∞—Ç—ã', slug: 'salads', icon: 'ü•ó' },
]
```


***

### **14. Item-level exclusions: –∞–ª–∫–æ–≥–æ–ª—å –±–µ–∑ –±–∞–ª–ª–æ–≤**

**–í–û–ü–†–û–°:** –ï—Å–ª–∏ Admin —Ö–æ—á–µ—Ç –∏—Å–∫–ª—é—á–∏—Ç—å –∞–ª–∫–æ–≥–æ–ª—å –∏–∑ loyalty, –∫–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å?

- **A)** Category-based exclusion (—Å–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ "–ê–ª–∫–æ–≥–æ–ª—å 0%")
- **B)** Blacklist categories (checkbox "–ù–µ –Ω–∞—á–∏—Å–ª—è—Ç—å –±–∞–ª–ª—ã –∑–∞ –∞–ª–∫–æ–≥–æ–ª—å")
- **C)** Item-level blacklist (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ productId excluded)
- **D)** –ö–æ–º–±–æ: B + C (categories + specific items)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Blacklist categories + items**

```typescript
// Loyalty System settings
model LoyaltySystem {
  // ...
  excludedCategoryIds String[] // ["alcohol-cat-id", "tobacco-cat-id"]
  excludedProductIds  String[] // ["vodka-prod-id", "whiskey-prod-id"]
}

// Calculate loyalty with exclusions
async calculateEarnPoints(dto: CalculateDto): Promise<number> {
  const loyaltySystem = await this.getLoyaltySystem(dto.tenantId)
  
  // 1. Filter excluded items
  const eligibleItems = dto.items.filter(item => {
    // Map POS category
    const loyaltyCategoryId = this.mapCategory(item.categoryId, item.category)
    
    // Check category blacklist
    if (loyaltySystem.excludedCategoryIds.includes(loyaltyCategoryId)) {
      return false
    }
    
    // Check product blacklist
    if (loyaltySystem.excludedProductIds.includes(item.productId)) {
      return false
    }
    
    return true
  })
  
  // 2. Calculate only on eligible items
  const eligibleSum = eligibleItems.reduce((sum, item) => 
    sum + item.price * item.quantity, 0
  )
  
  const rules = await this.getActiveLoyaltyRules(dto.tenantId)
  let totalEarn = 0
  
  for (const rule of rules) {
    totalEarn += Math.floor(eligibleSum * (rule.earnPercent / 100))
  }
  
  return totalEarn
}
```

**Admin UI:**

```tsx
<FormField label="Exclude categories from loyalty">
  <MultiSelect
    options={categories}
    value={excludedCategoryIds}
    onChange={setExcludedCategoryIds}
  />
</FormField>

<Checkbox label="Exclude alcohol" checked={excludeAlcohol} />
<Checkbox label="Exclude tobacco" checked={excludeTobacco} />
```

**Example:**

- Check: 3000 ‚ÇΩ (–ü–∏—Ü—Ü–∞ 1500 ‚ÇΩ + –í–∏–Ω–æ 1500 ‚ÇΩ)
- Excluded: –ê–ª–∫–æ–≥–æ–ª—å
- **Loyalty: —Ç–æ–ª—å–∫–æ –Ω–∞ 1500 ‚ÇΩ (–ø–∏—Ü—Ü–∞)** ‚Üí 150 –±–∞–ª–ª–æ–≤ (10%)

***

### **15. Tips handling: –≤–∫–ª—é—á–∞—Ç—å –ª–∏ —á–∞–µ–≤—ã–µ –≤ checkAmount?**

**–í–û–ü–†–û–°:** –ï—Å–ª–∏ —á–µ–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç tips (—á–∞–µ–≤—ã–µ), –Ω–∞—á–∏—Å–ª—è—Ç—å –ª–∏ –Ω–∞ –Ω–∏—Ö –±–∞–ª–ª—ã?

- **A)** –î–∞, tips –≤–∫–ª—é—á–µ–Ω—ã –≤ `checkAmount` (–Ω–∞—á–∏—Å–ª—è–µ–º –Ω–∞ –≤—Å—ë)
- **B)** –ù–µ—Ç, –≤—ã—á–∏—Ç–∞–µ–º tips –∏–∑ `checkAmount`
- **C)** Configurable (Admin –≤—ã–±–∏—Ä–∞–µ—Ç "Include tips in loyalty")
- **D)** Separate field `tipsAmount`, Admin –≤—ã–±–∏—Ä–∞–µ—Ç

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **C) Configurable**

```typescript
// Loyalty System settings
model LoyaltySystem {
  // ...
  includeTipsInLoyalty Boolean @default(false) // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ù–ï –≤–∫–ª—é—á–∞–µ–º
}

// Webhook payload with tips
{
  "posCheckId": "CHK-123456",
  "checkAmount": 2850,
  "tipsAmount": 250, // Separate field
  "items": [...],
  "timestamp": "2026-02-11T12:30:00Z"
}

// Calculate loyalty
async calculateEarnPoints(dto: CalculateDto): Promise<number> {
  const loyaltySystem = await this.getLoyaltySystem(dto.tenantId)
  
  // 1. Determine base amount for loyalty
  let baseAmount = dto.checkAmount
  
  if (!loyaltySystem.includeTipsInLoyalty && dto.tipsAmount) {
    baseAmount -= dto.tipsAmount
  }
  
  // 2. Calculate loyalty on base amount
  const rules = await this.getActiveLoyaltyRules(dto.tenantId)
  let totalEarn = 0
  
  for (const rule of rules) {
    totalEarn += Math.floor(baseAmount * (rule.earnPercent / 100))
  }
  
  return totalEarn
}
```

**Use case:**

- Check: 2850 ‚ÇΩ (–µ–¥–∞ 2600 ‚ÇΩ + tips 250 ‚ÇΩ)
- `includeTipsInLoyalty = false`
- **Loyalty: 2600 * 10% = 260 –±–∞–ª–ª–æ–≤** (–±–µ–∑ —á–∞–µ–≤—ã—Ö)

***

### **16. Split bills: –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–ª–∞—Ç–µ–∂–µ–π –Ω–∞ –æ–¥–∏–Ω —á–µ–∫**

**–í–û–ü–†–û–°:** –ï—Å–ª–∏ –æ–¥–∏–Ω —á–µ–∫ (posCheckId) —Ä–∞–∑–¥–µ–ª–µ–Ω –Ω–∞ 2+ –ø–ª–∞—Ç–µ–∂–∞ (split bill), –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å?

- **A)** –û–¥–∏–Ω webhook –Ω–∞ –≤–µ—Å—å —á–µ–∫ (POS –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç)
- **B)** –ù–µ—Å–∫–æ–ª—å–∫–æ webhooks —Å –æ–¥–Ω–∏–º `posCheckId` (idempotency protection)
- **C)** –†–∞–∑–Ω—ã–µ `posCheckId` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ (`posCheckId-1`, `posCheckId-2`)
- **D)** –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º split bills (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π payment)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Multiple webhooks + idempotency**

```typescript
// Scenario: Split bill (2 guests, 1 check)
// Guest 1 pays 1500‚ÇΩ
// Guest 2 pays 1350‚ÇΩ
// Total check: 2850‚ÇΩ

// Webhook 1 (Guest 1)
{
  "posCheckId": "CHK-123456",
  "checkAmount": 2850, // Full check amount
  "guestPhone": "79991234567",
  "paymentAmount": 1500, // This guest's portion
  "splitPaymentIndex": 1,
  "totalSplitPayments": 2,
  "timestamp": "2026-02-11T12:30:00Z"
}

// Webhook 2 (Guest 2)
{
  "posCheckId": "CHK-123456", // Same check ID
  "checkAmount": 2850,
  "guestPhone": "79997654321",
  "paymentAmount": 1350,
  "splitPaymentIndex": 2,
  "totalSplitPayments": 2,
  "timestamp": "2026-02-11T12:30:15Z"
}

// Processing
async processWebhook(dto: WebhookTransactionDto) {
  // 1. Check if split bill
  if (dto.splitPaymentIndex && dto.totalSplitPayments > 1) {
    return this.processSplitBill(dto)
  }
  
  // 2. Regular transaction
  return this.processRegularTransaction(dto)
}

async processSplitBill(dto: WebhookTransactionDto) {
  const idempotencyKey = `webhook:${dto.tenantId}:${dto.posSystem}:${dto.posCheckId}:split-${dto.splitPaymentIndex}`
  
  // 1. Deduplication (per split payment)
  const cached = await this.redis.get(idempotencyKey)
  if (cached) {
    return JSON.parse(cached)
  }
  
  // 2. Identify guest
  const guestCard = await this.identifyGuest(dto.guestPhone, dto.tenantId)
  
  if (!guestCard) {
    return { success: false, reason: 'GUEST_NOT_IDENTIFIED' }
  }
  
  // 3. Calculate loyalty on THIS guest's payment portion
  const earnPoints = await this.calculateEarnPoints({
    ...dto,
    checkAmount: dto.paymentAmount, // Only this guest's portion
  })
  
  // 4. Create transaction
  const result = await this.loyaltyService.processTransaction({
    guestCardId: guestCard.id,
    checkAmount: dto.paymentAmount,
    earnedPoints: earnPoints,
    posCheckId: `${dto.posCheckId}-SPLIT-${dto.splitPaymentIndex}`,
    metadata: {
      splitBill: true,
      fullCheckAmount: dto.checkAmount,
      splitIndex: dto.splitPaymentIndex,
      totalSplits: dto.totalSplitPayments,
    },
  })
  
  // 5. Cache result
  await this.redis.setex(idempotencyKey, 86400, JSON.stringify(result))
  
  return result
}
```

**–õ–æ–≥–∏–∫–∞:** –ö–∞–∂–¥—ã–π –≥–æ—Å—Ç—å –ø–æ–ª—É—á–∞–µ—Ç –±–∞–ª–ª—ã —Ç–æ–ª—å–∫–æ –∑–∞ **—Å–≤–æ—é —á–∞—Å—Ç—å** –ø–ª–∞—Ç–µ–∂–∞.

***

## **‚ö†Ô∏è 4. ERROR HANDLING \& RETRY (5 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **17. POS down: fallback strategy**

**–í–û–ü–†–û–°:** –ï—Å–ª–∏ POS API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω 24+ —á–∞—Å–∞ (PULL —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç), —á—Ç–æ –¥–µ–ª–∞—Ç—å?

- **A)** Alert Admin + manual intervention
- **B)** Exponential backoff (retry —á–µ—Ä–µ–∑ 1h ‚Üí 2h ‚Üí 4h ‚Üí 8h ‚Üí 24h)
- **C)** Graceful degradation (loyalty —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ POS sync, reconciliation –ø–æ–∑–∂–µ)
- **D)** –ö–æ–º–±–æ: B + C (retry + –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Retry + Graceful degradation**

```typescript
// PULL sync job (CRON every 30 minutes)
@Cron('*/30 * * * *')
async pullSyncJob() {
  const integrations = await this.prisma.posIntegration.findMany({
    where: { isActive: true },
  })
  
  for (const integration of integrations) {
    try {
      await this.pullPOSTransactions(integration)
      
      // Reset failure count on success
      await this.prisma.posIntegration.update({
        where: { id: integration.id },
        data: {
          lastSyncStatus: 'SUCCESS',
          lastSyncAt: new Date(),
          consecutiveFailures: 0,
        },
      })
      
    } catch (error) {
      const failures = integration.consecutiveFailures + 1
      
      await this.prisma.posIntegration.update({
        where: { id: integration.id },
        data: {
          lastSyncStatus: 'FAILED',
          lastSyncAt: new Date(),
          lastError: error.message,
          consecutiveFailures: failures,
        },
      })
      
      // Alert Admin after 3 consecutive failures (1.5 hours)
      if (failures === 3) {
        await this.notificationService.sendAdminAlert({
          tenantId: integration.tenantId,
          severity: 'WARNING',
          title: 'POS sync failing',
          message: `POS integration for ${integration.restaurantId} failed 3 times in a row`,
        })
      }
      
      // Critical alert after 48 failures (24 hours)
      if (failures === 48) {
        await this.notificationService.sendAdminAlert({
          tenantId: integration.tenantId,
          severity: 'CRITICAL',
          title: 'POS sync down for 24 hours',
          message: `POS integration unavailable. Manual intervention required.`,
        })
      }
      
      this.logger.error(`POS sync failed for ${integration.id}: ${error.message}`)
    }
  }
}

// Graceful degradation: loyalty works even if POS down
// (guests can still earn/redeem via Telegram Mini App manual input)
```

**Admin UI: POS Integration Status**

```
POS Integration Status
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Restaurant: –°—É—à–∏–ª–∫–∞
POS System: iiko Cloud
Status: ‚ö†Ô∏è WARNING (3 consecutive failures)
Last Success: 2026-02-10 12:00:00
Last Failure: 2026-02-11 01:30:00
Error: "Connection timeout to iiko API"

[Manual Sync] [Disable Integration] [Retry Now]
```


***

### **18. Invalid webhook data: –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å?**

**–í–û–ü–†–û–°:** –ï—Å–ª–∏ webhook —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (negative checkAmount, invalid timestamp), —á—Ç–æ –¥–µ–ª–∞—Ç—å?

- **A)** Reject —Å HTTP 400 Bad Request (POS —É–≤–∏–¥–∏—Ç –æ—à–∏–±–∫—É)
- **B)** Accept + log as FAILED (HTTP 200, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º)
- **C)** Auto-fix –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ (negative ‚Üí positive, invalid timestamp ‚Üí now())
- **D)** –ö–æ–º–±–æ: A –¥–ª—è critical errors, C –¥–ª—è minor issues

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Reject critical, fix minor**

```typescript
// Validation pipe
@Injectable()
export class WebhookValidationPipe implements PipeTransform {
  transform(value: any): WebhookTransactionDto {
    const errors: string[] = []
    
    // 1. Critical validations (REJECT)
    if (!value.posCheckId) {
      errors.push('posCheckId is required')
    }
    
    if (value.checkAmount === undefined || value.checkAmount === null) {
      errors.push('checkAmount is required')
    }
    
    if (value.checkAmount < 0) {
      errors.push('checkAmount cannot be negative')
    }
    
    if (value.checkAmount > 1000000) {
      errors.push('checkAmount too large (max 1,000,000)')
    }
    
    if (errors.length > 0) {
      throw new BadRequestException({
        errorCode: 'INVALID_WEBHOOK_DATA',
        message: 'Webhook validation failed',
        details: errors,
      })
    }
    
    // 2. Minor fixes (AUTO-FIX)
    
    // Fix timestamp (if missing or invalid ‚Üí use now())
    if (!value.timestamp || isNaN(new Date(value.timestamp).getTime())) {
      value.timestamp = new Date().toISOString()
    }
    
    // Fix negative items (clamp to 0)
    if (value.items) {
      value.items = value.items.map(item => ({
        ...item,
        price: Math.max(0, item.price),
        quantity: Math.max(0, item.quantity),
      }))
    }
    
    // Normalize phone
    if (value.guestPhone) {
      try {
        value.guestPhone = this.normalizePhone(value.guestPhone)
      } catch (e) {
        // Invalid phone ‚Üí set to null (will skip guest identification)
        value.guestPhone = null
      }
    }
    
    return value
  }
}

// Controller with validation
@Post('/webhooks/transaction')
@UsePipes(new WebhookValidationPipe())
async handleTransaction(@Body() dto: WebhookTransactionDto) {
  return this.posService.processWebhook(dto)
}
```

**Error response (HTTP 400):**

```json
{
  "success": false,
  "error": {
    "code": "INVALID_WEBHOOK_DATA",
    "message": "Webhook validation failed",
    "details": [
      "posCheckId is required",
      "checkAmount cannot be negative"
    ]
  },
  "timestamp": "2026-02-11T01:30:00Z"
}
```


***

### **19. Webhook rate limiting: –∑–∞—â–∏—Ç–∞ –æ—Ç spam**

**–í–û–ü–†–û–°:** –ï—Å–ª–∏ POS –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç 1000 webhooks –≤ —Å–µ–∫—É–Ω–¥—É (bug –∏–ª–∏ DDoS), –∫–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è?

- **A)** Rate limit: 10 webhooks/second per restaurantId
- **B)** Rate limit: 100 webhooks/minute per tenantId
- **C)** Queue-based (BullMQ) –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (accept –≤—Å–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º async)
- **D)** –ö–æ–º–±–æ: A + C (rate limit + queue)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Rate limit + Queue**

```typescript
// Rate limiting guard (Redis)
@Injectable()
export class POSWebhookRateLimitGuard implements CanActivate {
  constructor(private redis: Redis) {}
  
  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest()
    const restaurantId = request.body.restaurantId || 'unknown'
    
    // Rate limit: 20 webhooks per 10 seconds per restaurant
    const key = `webhook:ratelimit:${restaurantId}:${Math.floor(Date.now() / 10000)}`
    const count = await this.redis.incr(key)
    await this.redis.expire(key, 10)
    
    if (count > 20) {
      throw new HttpException(
        {
          errorCode: 'RATE_LIMIT_EXCEEDED',
          message: 'Too many webhooks. Max 20 per 10 seconds.',
          retryAfter: 10,
        },
        429
      )
    }
    
    return true
  }
}

// Controller —Å rate limit + queue
@Controller('/api/v1/pos/webhooks')
@UseGuards(WebhookSignatureGuard, POSWebhookRateLimitGuard)
export class POSWebhookController {
  constructor(
    private posQueue: Queue, // BullMQ
  ) {}
  
  @Post('/transaction')
  async handleTransaction(@Body() dto: WebhookTransactionDto) {
    // 1. Accept webhook immediately (HTTP 202 Accepted)
    // 2. Queue for async processing
    await this.posQueue.add('process-webhook', dto, {
      attempts: 3,
      backoff: {
        type: 'exponential',
        delay: 1000,
      },
      removeOnComplete: 1000,
    })
    
    return {
      success: true,
      status: 'QUEUED',
      message: 'Webhook received and queued for processing',
    }
  }
}

// Worker (async processing)
@Processor('pos-webhooks')
export class POSWebhookProcessor {
  @Process('process-webhook')
  async processWebhook(job: Job<WebhookTransactionDto>) {
    const dto = job.data
    
    try {
      await this.posService.processWebhook(dto)
      
      await this.prisma.posTransaction.update({
        where: { id: dto.posCheckId },
        data: { syncStatus: 'COMPLETED' },
      })
      
    } catch (error) {
      this.logger.error(`Webhook processing failed: ${error.message}`)
      
      await this.prisma.posTransaction.update({
        where: { id: dto.posCheckId },
        data: {
          syncStatus: 'FAILED',
          lastError: error.message,
        },
      })
      
      throw error // BullMQ will retry
    }
  }
}
```

**Flow:**

1. Webhook ‚Üí Rate limit check (20/10sec)
2. Pass ‚Üí Queue to BullMQ ‚Üí HTTP 202 Accepted (instant)
3. Worker processes async ‚Üí Retry on failure

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- **Fast response** (< 50ms, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º POS)
- **Protection** (rate limit prevents spam)
- **Reliability** (queue + retry)

***

### **20. Reconciliation conflict resolution**

**–í–û–ü–†–û–°:** –ï—Å–ª–∏ reconciliation job –Ω–∞—à—ë–ª —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ (–Ω–∞—à –±–∞–ª–∞–Ω—Å 2850, POS –±–∞–ª–∞–Ω—Å 2900), –∫–∞–∫ —Ä–µ–∑–æ–ª–≤–∏—Ç—å?

- **A)** Trust POS (sync –Ω–∞—à –±–∞–ª–∞–Ω—Å –∫ POS –±–∞–ª–∞–Ω—Å—É)
- **B)** Trust our system (POS incorrect)
- **C)** Manual review (Admin —Ä–µ—à–∞–µ—Ç)
- **D)** –ö–æ–º–±–æ: auto-fix small diffs (<100), manual –¥–ª—è –±–æ–ª—å—à–∏—Ö

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Auto-fix small, manual –¥–ª—è –±–æ–ª—å—à–∏—Ö**

```typescript
// Reconciliation job
@Cron('0 */3 * * *') // Every 3 hours
async reconciliationJob() {
  const integrations = await this.prisma.posIntegration.findMany({
    where: { isActive: true },
  })
  
  for (const integration of integrations) {
    const guestCards = await this.prisma.guestCard.findMany({
      where: { restaurantId: integration.restaurantId },
    })
    
    for (const guestCard of guestCards) {
      try {
        // 1. Fetch balance from POS
        const posBalance = await this.posAdapter.getGuestBalance(
          integration.posSystem,
          guestCard.posGuestId
        )
        
        // 2. Compare with our balance
        const ourBalance = guestCard.totalBalance
        const diff = Math.abs(ourBalance - posBalance)
        
        if (diff === 0) {
          continue // Match ‚úì
        }
        
        // 3. Small difference (<100 balls) ‚Üí auto-fix
        if (diff < 100) {
          await this.autoFixBalance(guestCard, posBalance, diff)
          continue
        }
        
        // 4. Large difference ‚Üí flag for manual review
        await this.prisma.ballReconciliation.create({
          data: {
            guestCardId: guestCard.id,
            expectedBalance: ourBalance,
            actualBalance: posBalance,
            difference: diff,
            status: 'PENDING_REVIEW',
            createdAt: new Date(),
          },
        })
        
        // 5. Alert Admin
        await this.notificationService.sendAdminAlert({
          tenantId: integration.tenantId,
          severity: 'WARNING',
          title: 'Balance mismatch detected',
          message: `Guest ${guestCard.user.phone}: Our balance ${ourBalance}, POS balance ${posBalance} (diff ${diff})`,
        })
        
      } catch (error) {
        this.logger.error(`Reconciliation failed for ${guestCard.id}: ${error.message}`)
      }
    }
  }
}

async autoFixBalance(
  guestCard: GuestCard,
  posBalance: number,
  diff: number
) {
  // Create adjustment transaction
  await this.prisma.ballTransaction.create({
    data: {
      guestCardId: guestCard.id,
      type: 'MANUAL_ADJUST',
      amount: posBalance - guestCard.totalBalance, // Can be negative
      balanceType: 'REGULAR',
      balanceBefore: guestCard.totalBalance,
      balanceAfter: posBalance,
      reason: `Auto-adjustment from reconciliation (diff ${diff})`,
      metadata: {
        reconciliation: true,
        posBalance,
        ourBalance: guestCard.totalBalance,
      },
    },
  })
  
  // Update guest card
  await this.prisma.guestCard.update({
    where: { id: guestCard.id },
    data: {
      totalBalance: posBalance,
      regularBalance: posBalance,
    },
  })
  
  this.logger.log(`Auto-fixed balance for ${guestCard.id}: ${guestCard.totalBalance} ‚Üí ${posBalance}`)
}
```

**Admin UI: Reconciliation Dashboard**

```
Balance Reconciliation
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Status: 3 mismatches found

Guest: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ (+7 999 123-45-67)
Our Balance: 2,850 –±–∞–ª–ª–æ–≤
POS Balance: 2,900 –±–∞–ª–ª–æ–≤
Difference: +50 –±–∞–ª–ª–æ–≤
Actions: [Trust POS] [Trust Ours] [Manual Adjust] [Ignore]

Guest: –ê–Ω–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞ (+7 888 777-66-55)
Our Balance: 1,200 –±–∞–ª–ª–æ–≤
POS Balance: 500 –±–∞–ª–ª–æ–≤
Difference: -700 –±–∞–ª–ª–æ–≤ ‚ö†Ô∏è
Actions: [Trust POS] [Trust Ours] [Manual Adjust] [Ignore]
```


***

### **21. Error codes taxonomy**

**–í–û–ü–†–û–°:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å error codes –¥–ª—è POS integration?

- **A)** HTTP status codes –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ (400, 401, 500)
- **B)** Custom error codes (POS_001, POS_002, etc.)
- **C)** Semantic codes (GUEST_NOT_FOUND, INVALID_SIGNATURE, etc.)
- **D)** –ö–æ–º–±–æ: HTTP status + semantic code

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) HTTP + Semantic**

```typescript
// Error codes enum
export enum POSIntegrationErrorCode {
  // Webhook errors (4xx)
  INVALID_SIGNATURE = 'INVALID_SIGNATURE',
  TIMESTAMP_EXPIRED = 'TIMESTAMP_EXPIRED',
  INVALID_WEBHOOK_DATA = 'INVALID_WEBHOOK_DATA',
  DUPLICATE_TRANSACTION = 'DUPLICATE_TRANSACTION',
  GUEST_NOT_IDENTIFIED = 'GUEST_NOT_IDENTIFIED',
  INSUFFICIENT_BALANCE = 'INSUFFICIENT_BALANCE',
  RATE_LIMIT_EXCEEDED = 'RATE_LIMIT_EXCEEDED',
  
  // POS API errors (5xx)
  POS_API_UNAVAILABLE = 'POS_API_UNAVAILABLE',
  POS_API_TIMEOUT = 'POS_API_TIMEOUT',
  POS_AUTH_FAILED = 'POS_AUTH_FAILED',
  POS_INVALID_RESPONSE = 'POS_INVALID_RESPONSE',
  
  // Reconciliation errors
  BALANCE_MISMATCH = 'BALANCE_MISMATCH',
  MISSING_WEBHOOK = 'MISSING_WEBHOOK',
  
  // Internal errors
  INTERNAL_ERROR = 'INTERNAL_ERROR',
}

// Error response format
interface ErrorResponse {
  success: false
  error: {
    code: POSIntegrationErrorCode
    message: string
    details?: any
    retryable?: boolean // –ú–æ–∂–Ω–æ –ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å
  }
  timestamp: string
  requestId: string
}

// Example error responses
// 400 Bad Request
{
  "success": false,
  "error": {
    "code": "INVALID_SIGNATURE",
    "message": "Webhook signature verification failed",
    "details": {
      "expectedSignature": "abc123...",
      "receivedSignature": "def456..."
    },
    "retryable": false
  },
  "timestamp": "2026-02-11T01:30:00Z",
  "requestId": "req-uuid-123"
}

// 429 Too Many Requests
{
  "success": false,
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "Too many webhooks. Max 20 per 10 seconds.",
    "details": {
      "limit": 20,
      "window": "10 seconds",
      "retryAfter": 10
    },
    "retryable": true
  },
  "timestamp": "2026-02-11T01:30:00Z",
  "requestId": "req-uuid-456"
}

// 503 Service Unavailable
{
  "success": false,
  "error": {
    "code": "POS_API_UNAVAILABLE",
    "message": "POS API is currently unavailable",
    "details": {
      "posSystem": "IIKO_CLOUD",
      "lastSuccessfulSync": "2026-02-10T12:00:00Z"
    },
    "retryable": true
  },
  "timestamp": "2026-02-11T01:30:00Z",
  "requestId": "req-uuid-789"
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- **–ú–∞—à–∏–Ω–Ω–æ-—á–∏—Ç–∞–µ–º—ã–µ** (POS –º–æ–∂–µ—Ç –ø–∞—Ä—Å–∏—Ç—å `error.code`)
- **Human-readable** (Admin –≤–∏–¥–∏—Ç `error.message`)
- **Retryable flag** (POS –∑–Ω–∞–µ—Ç, —Å—Ç–æ–∏—Ç –ª–∏ –ø–æ–≤—Ç–æ—Ä—è—Ç—å)

***

## **üìä 5. MONITORING \& ADMIN UI (4 –≤–æ–ø—Ä–æ—Å–∞)**

### **22. POS Integration Dashboard: –∫–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å?**

**–í–û–ü–†–û–°:** –ß—Ç–æ Admin –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –Ω–∞ dashboard?

- **A)** Status only (Active/Inactive, Last sync)
- **B)** Basic metrics (Total transactions, Success rate, Last error)
- **C)** Advanced metrics (Latency p95, Missed webhooks, Balance mismatches)
- **D)** –ö–æ–º–±–æ: B + C + Real-time alerts

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Comprehensive dashboard**

```typescript
// GET /api/v1/admin/pos/dashboard
{
  "overview": {
    "totalIntegrations": 5,
    "active": 4,
    "inactive": 1,
    "healthStatus": "WARNING", // OK | WARNING | CRITICAL
    "lastSyncAt": "2026-02-11T01:00:00Z"
  },
  "integrations": [
    {
      "id": "pos-int-1",
      "restaurantName": "–°—É—à–∏–ª–∫–∞",
      "posSystem": "IIKO_CLOUD",
      "status": "ACTIVE",
      "health": "OK",
      
      // Sync metrics
      "lastSyncAt": "2026-02-11T01:00:00Z",
      "lastSyncStatus": "SUCCESS",
      "nextSyncAt": "2026-02-11T01:30:00Z",
      "consecutiveFailures": 0,
      
      // Transaction metrics (last 24h)
      "metrics": {
        "totalTransactions": 156,
        "successfulTransactions": 154,
        "failedTransactions": 2,
        "successRate": 98.7, // %
        "avgProcessingTime": 245, // ms
        "p95Latency": 480, // ms
        "missedWebhooks": 2, // Found via PULL sync
      },
      
      // Reconciliation
      "reconciliation": {
        "lastRunAt": "2026-02-11T00:00:00Z",
        "balanceMismatches": 0,
        "pendingReview": 0,
      },
      
      // Errors (last 24h)
      "recentErrors": [
        {
          "timestamp": "2026-02-10T23:45:00Z",
          "errorCode": "GUEST_NOT_IDENTIFIED",
          "posCheckId": "CHK-789",
          "message": "Guest phone not found"
        }
      ],
      
      "actions": {
        "manualSync": "/api/v1/admin/pos/pos-int-1/sync",
        "testConnection": "/api/v1/admin/pos/pos-int-1/test",
        "disable": "/api/v1/admin/pos/pos-int-1/disable"
      }
    }
  ],
  
  // System-wide alerts
  "alerts": [
    {
      "severity": "WARNING",
      "title": "–°—É—à–∏–ª–∫–∞: 3 consecutive sync failures",
      "timestamp": "2026-02-11T01:15:00Z",
      "integrationId": "pos-int-2"
    }
  ]
}
```

**Admin UI (React):**

```tsx
<POSIntegrationDashboard>
  <OverviewCards>
    <Card title="Active Integrations" value="4/5" status="ok" />
    <Card title="Success Rate (24h)" value="98.7%" status="ok" />
    <Card title="Missed Webhooks" value="2" status="warning" />
    <Card title="Balance Mismatches" value="0" status="ok" />
  </OverviewCards>
  
  <IntegrationsTable>
    {integrations.map(int => (
      <IntegrationRow key={int.id}>
        <StatusBadge status={int.health} />
        <RestaurantName>{int.restaurantName}</RestaurantName>
        <POSSystem>{int.posSystem}</POSSystem>
        <LastSync>{int.lastSyncAt}</LastSync>
        <SuccessRate>{int.metrics.successRate}%</SuccessRate>
        <Actions>
          <Button onClick={() => manualSync(int.id)}>Sync Now</Button>
          <Button onClick={() => testConnection(int.id)}>Test</Button>
        </Actions>
      </IntegrationRow>
    ))}
  </IntegrationsTable>
  
  <AlertsList>
    {alerts.map(alert => (
      <Alert severity={alert.severity}>
        {alert.title}
      </Alert>
    ))}
  </AlertsList>
</POSIntegrationDashboard>
```


***

### **23. Manual sync trigger**

**–í–û–ü–†–û–°:** –†–∞–∑—Ä–µ—à–∏—Ç—å Admin –∑–∞–ø—É—Å—Ç–∏—Ç—å manual sync (PULL)?

- **A)** –î–∞, –∫–Ω–æ–ø–∫–∞ "Sync Now" (–ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è last 24h)
- **B)** –î–∞, —Å –≤—ã–±–æ—Ä–æ–º –ø–µ—Ä–∏–æ–¥–∞ (Admin –≤—ã–±–∏—Ä–∞–µ—Ç from/to dates)
- **C)** –ù–µ—Ç (—Ç–æ–ª—å–∫–æ CRON –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π)
- **D)** –î–∞, –Ω–æ rate limit (1 manual sync per 10 minutes)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) + D) Manual sync —Å rate limit**

```typescript
// Admin API endpoint
@Post('/api/v1/admin/pos/:integrationId/sync')
@Roles('ADMIN', 'OWNER')
async manualSync(
  @Param('integrationId') integrationId: string,
  @CurrentUser() user: User
) {
  // 1. Check rate limit (1 sync per 10 minutes)
  const rateLimitKey = `manual-sync:${integrationId}`
  const lastSync = await this.redis.get(rateLimitKey)
  
  if (lastSync) {
    throw new HttpException(
      'Manual sync already triggered recently. Please wait 10 minutes.',
      429
    )
  }
  
  // 2. Trigger sync job
  const integration = await this.prisma.posIntegration.findUnique({
    where: { id: integrationId },
  })
  
  if (!integration) {
    throw new NotFoundException('POS integration not found')
  }
  
  // 3. Queue sync job
  await this.posQueue.add('manual-sync', {
    integrationId,
    triggeredBy: user.id,
    syncPeriod: {
      from: subDays(new Date(), 1), // Last 24 hours
      to: new Date(),
    },
  }, {
    priority: 1, // High priority
  })
  
  // 4. Set rate limit
  await this.redis.setex(rateLimitKey, 600, '1') // 10 minutes
  
  // 5. Log activity
  await this.activityLogService.log({
    tenantId: integration.tenantId,
    actionType: 'POS_MANUAL_SYNC',
    entityType: 'POSINTEGRATION',
    entityId: integrationId,
    performedBy: user.id,
    metadata: { triggeredAt: new Date() },
  })
  
  return {
    success: true,
    message: 'Manual sync triggered',
    estimatedTime: '1-5 minutes',
  }
}

// Worker: process manual sync
@Process('manual-sync')
async processManualSync(job: Job) {
  const { integrationId, syncPeriod } = job.data
  
  try {
    // 1. Fetch transactions from POS
    const posTransactions = await this.posAdapter.fetchTransactions(
      integration.posSystem,
      integration.restaurantId,
      syncPeriod.from,
      syncPeriod.to
    )
    
    // 2. Process each transaction
    let processedCount = 0
    let skippedCount = 0
    
    for (const posTx of posTransactions) {
      const existing = await this.prisma.posTransaction.findUnique({
        where: {
          tenantId_posSystem_posCheckId: {
            tenantId: integration.tenantId,
            posSystem: integration.posSystem,
            posCheckId: posTx.id,
          },
        },
      })
      
      if (existing) {
        skippedCount++
        continue // Already processed
      }
      
      // Process new transaction
      await this.processWebhook({
        ...posTx,
        source: 'MANUAL_SYNC',
      })
      
      processedCount++
    }
    
    // 3. Update integration status
    await this.prisma.posIntegration.update({
      where: { id: integrationId },
      data: {
        lastSyncAt: new Date(),
        lastSyncStatus: 'SUCCESS',
      },
    })
    
    // 4. Notify Admin
    await this.notificationService.sendAdminNotification({
      title: 'Manual sync completed',
      message: `Processed ${processedCount} new transactions, skipped ${skippedCount} existing`,
    })
    
    return { processedCount, skippedCount }
    
  } catch (error) {
    this.logger.error(`Manual sync failed: ${error.message}`)
    throw error
  }
}
```

**Admin UI feedback:**

```
Manual Sync Triggered ‚úì
Processing... (estimated 1-5 minutes)

[Progress: 45/156 transactions]
```


***

### **24. Webhook replay (–¥–ª—è debugging)**

**–í–û–ü–†–û–°:** –†–∞–∑—Ä–µ—à–∏—Ç—å Admin –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å webhook (–¥–ª—è testing/debugging)?

- **A)** –î–∞, "Replay Webhook" button (—Å override idempotency)
- **B)** –ù–µ—Ç (–æ–ø–∞—Å–Ω–æ, –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã)
- **C)** –î–∞, –Ω–æ —Ç–æ–ª—å–∫–æ –≤ sandbox mode
- **D)** –î–∞, —Å confirmation + dry-run mode

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Replay —Å dry-run**

```typescript
// Admin API
@Post('/api/v1/admin/pos/transactions/:posCheckId/replay')
@Roles('ADMIN', 'OWNER')
async replayWebhook(
  @Param('posCheckId') posCheckId: string,
  @Body() body: { dryRun?: boolean, overrideIdempotency?: boolean },
  @CurrentUser() user: User
) {
  // 1. Find original transaction
  const originalTx = await this.prisma.posTransaction.findFirst({
    where: { posCheckId },
  })
  
  if (!originalTx) {
    throw new NotFoundException(`Transaction ${posCheckId} not found`)
  }
  
  // 2. Dry-run mode (simulate without changing DB)
  if (body.dryRun) {
    const simulation = await this.simulateWebhookProcessing(originalTx)
    return {
      success: true,
      dryRun: true,
      simulation,
    }
  }
  
  // 3. Override idempotency (DANGEROUS)
  if (body.overrideIdempotency) {
    // Delete Redis cache
    const idempotencyKey = `webhook:${originalTx.tenantId}:${originalTx.posSystem}:${originalTx.posCheckId}`
    await this.redis.del(idempotencyKey)
    
    // Reprocess
    const result = await this.processWebhook({
      ...originalTx,
      source: 'ADMIN_REPLAY',
    })
    
    // Log activity
    await this.activityLogService.log({
      tenantId: originalTx.tenantId,
      actionType: 'POS_WEBHOOK_REPLAY',
      entityType: 'POSTRANSACTION',
      entityId: originalTx.id,
      performedBy: user.id,
      metadata: {
        originalCheckId: posCheckId,
        overrideIdempotency: true,
      },
    })
    
    return {
      success: true,
      replayed: true,
      result,
    }
  }
  
  // 4. Normal replay (will hit idempotency protection)
  return this.processWebhook(originalTx)
}

async simulateWebhookProcessing(tx: POSTransaction) {
  // Calculate what WOULD happen (without DB changes)
  const guestCard = await this.identifyGuest(tx.guestIdentifier, tx.tenantId)
  
  if (!guestCard) {
    return {
      status: 'GUEST_NOT_IDENTIFIED',
      wouldProcess: false,
    }
  }
  
  const earnPoints = await this.calculateEarnPoints({
    checkAmount: tx.checkAmount,
    items: tx.items,
    tenantId: tx.tenantId,
  })
  
  return {
    status: 'SUCCESS',
    wouldProcess: true,
    guestCard: {
      id: guestCard.id,
      currentBalance: guestCard.totalBalance,
      balanceAfter: guestCard.totalBalance + earnPoints,
    },
    earnPoints,
  }
}
```

**Admin UI:**

```tsx
<TransactionDetails transactionId="CHK-123456">
  <Button onClick={() => replayWebhook(posCheckId, { dryRun: true })}>
    üîç Dry-Run (Simulate)
  </Button>
  
  <Button 
    variant="danger"
    onClick={() => {
      if (confirm('Are you sure? This will create duplicate balls!')) {
        replayWebhook(posCheckId, { overrideIdempotency: true })
      }
    }}
  >
    ‚ö†Ô∏è Replay (Override Idempotency)
  </Button>
</TransactionDetails>
```


***

### **25. Test connection: verify POS API credentials**

**–í–û–ü–†–û–°:** –ö–∞–∫ Admin –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ POS credentials –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã?

- **A)** "Test Connection" button ‚Üí ping POS API
- **B)** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ credentials
- **C)** Sandbox mode (test webhooks –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
- **D)** –ö–æ–º–±–æ: A + B + C

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç**

```typescript
// Admin API
@Post('/api/v1/admin/pos/:integrationId/test')
@Roles('ADMIN', 'OWNER')
async testConnection(@Param('integrationId') integrationId: string) {
  const integration = await this.prisma.posIntegration.findUnique({
    where: { id: integrationId },
  })
  
  const results = []
  
  try {
    // 1. Test authentication
    results.push({
      test: 'Authentication',
      status: 'TESTING',
    })
    
    await this.posAdapter.authenticate(
      integration.posSystem,
      integration.config // credentials
    )
    
    results[^6_0].status = 'PASS'
    results[^6_0].message = 'Authentication successful'
    
  } catch (error) {
    results[^6_0].status = 'FAIL'
    results[^6_0].message = error.message
    return { success: false, results }
  }
  
  try {
    // 2. Test API availability
    results.push({
      test: 'API Availability',
      status: 'TESTING',
    })
    
    const healthCheck = await this.posAdapter.healthCheck(integration.posSystem)
    
    results[^6_1].status = healthCheck.ok ? 'PASS' : 'FAIL'
    results[^6_1].message = healthCheck.message
    
  } catch (error) {
    results[^6_1].status = 'FAIL'
    results[^6_1].message = error.message
  }
  
  try {
    // 3. Test fetching transactions (last 1 hour)
    results.push({
      test: 'Fetch Transactions',
      status: 'TESTING',
    })
    
    const transactions = await this.posAdapter.fetchTransactions(
      integration.posSystem,
      integration.restaurantId,
      subHours(new Date(), 1),
      new Date()
    )
    
    results[^6_2].status = 'PASS'
    results[^6_2].message = `Fetched ${transactions.length} transactions`
    results[^6_2].details = { transactionCount: transactions.length }
    
  } catch (error) {
    results[^6_2].status = 'FAIL'
    results[^6_2].message = error.message
  }
  
  try {
    // 4. Test webhook signature generation
    results.push({
      test: 'Webhook Signature',
      status: 'TESTING',
    })
    
    const testPayload = { test: true }
    const signature = this.calculateHMAC(
      JSON.stringify(testPayload),
      new Date().toISOString(),
      integration.webhookSecret
    )
    
    results[^6_3].status = 'PASS'
    results[^6_3].message = 'Signature generated successfully'
    results[^6_3].details = { signature: signature.substring(0, 16) + '...' }
    
  } catch (error) {
    results[^6_3].status = 'FAIL'
    results[^6_3].message = error.message
  }
  
  // 5. Overall result
  const allPassed = results.every(r => r.status === 'PASS')
  
  return {
    success: allPassed,
    results,
    timestamp: new Date().toISOString(),
  }
}
```

**Admin UI:**

```tsx
<TestConnectionResults>
  ‚úÖ Authentication - PASS
  ‚úÖ API Availability - PASS
  ‚úÖ Fetch Transactions - PASS (23 transactions found)
  ‚úÖ Webhook Signature - PASS

  Overall: All tests passed ‚úì
</TestConnectionResults>
```


***

## **üîß 6. ADVANCED FEATURES (4 –≤–æ–ø—Ä–æ—Å–∞)**

### **26. Initial bulk sync: –ø–µ—Ä–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ POS**

**–í–û–ü–†–û–°:** –ö–æ–≥–¥–∞ Admin –ø–æ–¥–∫–ª—é—á–∞–µ—Ç POS –ø–µ—Ä–≤—ã–π —Ä–∞–∑, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–∏ –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π?

- **A)** –î–∞, sync last 30 days (—Å–æ–∑–¥–∞—Ç—å guest cards + ball transactions)
- **B)** –î–∞, –Ω–æ —Ç–æ–ª—å–∫–æ guest cards (–±–µ–∑ ball transactions)
- **C)** –ù–µ—Ç, –Ω–∞—á–∏–Ω–∞–µ–º —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (forward-only)
- **D)** –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (Admin –≤—ã–±–∏—Ä–∞–µ—Ç sync period: 7/30/90 days)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ + Background job**

```typescript
// Admin UI: Setup POS Integration wizard
<Step title="Initial Sync">
  <Select label="Sync historical transactions?" value={syncPeriod}>
    <Option value="NONE">No (start from now)</Option>
    <Option value="7_DAYS">Last 7 days</Option>
    <Option value="30_DAYS">Last 30 days</Option>
    <Option value="90_DAYS">Last 90 days</Option>
  </Select>
  
  {syncPeriod !== 'NONE' && (
    <Alert type="info">
      Estimated time: ~10 minutes for 1000 transactions
      This will run in the background.
    </Alert>
  )}
</Step>

// Backend: trigger initial sync
@Post('/api/v1/admin/pos')
@Roles('ADMIN')
async createPOSIntegration(@Body() dto: CreatePOSIntegrationDto) {
  // 1. Create integration
  const integration = await this.prisma.posIntegration.create({
    data: {
      tenantId: dto.tenantId,
      restaurantId: dto.restaurantId,
      posSystem: dto.posSystem,
      config: this.encryptConfig(dto.config),
      webhookSecret: this.generateWebhookSecret(),
      isActive: true,
    },
  })
  
  // 2. Trigger initial sync (if requested)
  if (dto.initialSyncPeriod && dto.initialSyncPeriod !== 'NONE') {
    const syncDays = {
      '7_DAYS': 7,
      '30_DAYS': 30,
      '90_DAYS': 90,
    }[dto.initialSyncPeriod]
    
    await this.posQueue.add('initial-bulk-sync', {
      integrationId: integration.id,
      syncFrom: subDays(new Date(), syncDays),
      syncTo: new Date(),
    }, {
      priority: 2, // Lower priority than real-time webhooks
    })
  }
  
  return integration
}

// Worker: process initial bulk sync
@Process('initial-bulk-sync')
async processInitialBulkSync(job: Job) {
  const { integrationId, syncFrom, syncTo } = job.data
  
  const integration = await this.prisma.posIntegration.findUnique({
    where: { id: integrationId },
  })
  
  try {
    // 1. Fetch all transactions from POS
    const transactions = await this.posAdapter.fetchTransactions(
      integration.posSystem,
      integration.restaurantId,
      syncFrom,
      syncTo
    )
    
    this.logger.log(`Initial sync: fetched ${transactions.length} transactions`)
    
    // 2. Process in batches (100 at a time)
    const BATCH_SIZE = 100
    let processedCount = 0
    let skippedCount = 0
    let guestsCreated = 0
    
    for (let i = 0; i < transactions.length; i += BATCH_SIZE) {
      const batch = transactions.slice(i, i + BATCH_SIZE)
      
      for (const tx of batch) {
        try {
          const result = await this.processWebhook({
            ...tx,
            source: 'INITIAL_SYNC',
          })
          
          if (result.guestCreated) {
            guestsCreated++
          }
          
          processedCount++
          
          // Update progress
          await job.progress((i / transactions.length) * 100)
          
        } catch (error) {
          if (error.code === 'P2002') {
            // Duplicate ‚Üí skip
            skippedCount++
          } else {
            this.logger.error(`Failed to process tx ${tx.posCheckId}: ${error.message}`)
          }
        }
      }
      
      // Throttle (avoid overloading DB)
      await new Promise(resolve => setTimeout(resolve, 100))
    }
    
    // 3. Update integration status
    await this.prisma.posIntegration.update({
      where: { id: integrationId },
      data: {
        lastSyncAt: new Date(),
        lastSyncStatus: 'SUCCESS',
      },
    })
    
    // 4. Notify Admin
    await this.notificationService.sendAdminNotification({
      tenantId: integration.tenantId,
      title: 'Initial POS sync completed',
      message: `
        Processed: ${processedCount} transactions
        Skipped: ${skippedCount} duplicates
        Guests created: ${guestsCreated}
      `,
    })
    
    return { processedCount, skippedCount, guestsCreated }
    
  } catch (error) {
    this.logger.error(`Initial sync
<span style="display:none">[^6_4]</span>

<div align="center">‚ÅÇ</div>

[^6_1]: Beseda-2.md
[^6_2]: Beseda-8.md
[^6_3]: Beseda-7.md
[^6_4]: Beseda-9.md

---

# –¢—ã –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª, –ø—Ä–æ–¥–æ–ª–∂–∏

–ü—Ä–æ–¥–æ–ª–∂–∞—é:

```typescript
  } catch (error) {
    this.logger.error(`Initial sync failed: ${error.message}`)
    
    await this.prisma.posIntegration.update({
      where: { id: integrationId },
      data: {
        lastSyncStatus: 'FAILED',
        lastError: error.message,
      },
    })
    
    throw error
  }
}
```

**Admin UI: Initial Sync Progress**

```tsx
<InitialSyncProgress>
  <ProgressBar value={45} />
  <Text>Processing: 450/1000 transactions</Text>
  <Stats>
    Processed: 445
    Skipped: 5 (duplicates)
    Guests created: 234
  </Stats>
  <EstimatedTime>~5 minutes remaining</EstimatedTime>
</InitialSyncProgress>
```


***

### **27. Multi-location support: –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –æ–¥–Ω–∞ POS**

**–í–û–ü–†–û–°:** –ï—Å–ª–∏ tenant –∏–º–µ–µ—Ç 3 —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ —Å –æ–¥–Ω–æ–π POS —Å–∏—Å—Ç–µ–º–æ–π (iiko Cloud), –∫–∞–∫ —Ä–∞–∑–ª–∏—á–∞—Ç—å?

- **A)** –û–¥–∏–Ω POSIntegration –Ω–∞ –≤—Å–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã (webhook –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç restaurantId –ø–æ `terminalId`)
- **B)** –û—Ç–¥–µ–ª—å–Ω—ã–π POSIntegration –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ (—Ä–∞–∑–Ω—ã–µ webhook URLs)
- **C)** –û–¥–∏–Ω POSIntegration + mapping table (terminalId ‚Üí restaurantId)
- **D)** –ö–æ–º–±–æ: C + –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–æ–≤ (single/multi)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **C) Mapping table**

```typescript
// Database schema
model POSIntegration {
  id              String @id @default(uuid())
  tenantId        String
  tenant          Tenant @relation(...)
  
  // Multi-location: if restaurantId = null ‚Üí shared integration
  restaurantId    String? // Null = multiple restaurants
  
  posSystem       POSSystem
  config          Json // Encrypted credentials
  webhookSecret   String
  
  // Mapping for multi-location
  locationMappings POSLocationMapping[]
  
  isActive        Boolean @default(true)
  createdAt       DateTime @default(now())
  
  @@index([tenantId, isActive])
}

model POSLocationMapping {
  id                String @id @default(uuid())
  posIntegrationId  String
  posIntegration    POSIntegration @relation(...)
  
  // POS location identifier (terminal, section, organizationId, etc.)
  posLocationId     String // e.g. "TERMINAL-01", "ORG-123"
  posLocationName   String // e.g. "–°—É—à–∏–ª–∫–∞ –¶–µ–Ω—Ç—Ä"
  
  // Our restaurant
  restaurantId      String
  restaurant        Restaurant @relation(...)
  
  createdAt         DateTime @default(now())
  
  @@unique([posIntegrationId, posLocationId])
}

// Admin UI: Setup multi-location mapping
<LocationMapping>
  <Table>
    <Row>
      <Cell>POS Location</Cell>
      <Cell>Restaurant</Cell>
      <Cell>Actions</Cell>
    </Row>
    <Row>
      ```
      <Cell>TERMINAL-01 (iiko)</Cell>
      ```
      <Cell>
        <Select>
          ```
          <Option value="rest-1">–°—É—à–∏–ª–∫–∞ –¶–µ–Ω—Ç—Ä</Option>
          ```
          ```
          <Option value="rest-2">–°—É—à–∏–ª–∫–∞ –°–µ–≤–µ—Ä</Option>
          ```
        </Select>
      </Cell>
      <Cell><Button>Save</Button></Cell>
    </Row>
  </Table>
</LocationMapping>

// Webhook processing with location mapping
async processWebhook(dto: WebhookTransactionDto) {
  // 1. Find POS integration
  const integration = await this.prisma.posIntegration.findFirst({
    where: {
      tenantId: dto.tenantId,
      posSystem: dto.posSystem,
      isActive: true,
    },
    include: { locationMappings: true },
  })
  
  // 2. Determine restaurantId
  let restaurantId = integration.restaurantId // Single-location mode
  
  if (!restaurantId && dto.posLocationId) {
    // Multi-location mode ‚Üí lookup mapping
    const mapping = integration.locationMappings.find(
      m => m.posLocationId === dto.posLocationId
    )
    
    if (mapping) {
      restaurantId = mapping.restaurantId
    } else {
      // Unmapped location ‚Üí alert Admin
      await this.notificationService.sendAdminAlert({
        tenantId: dto.tenantId,
        severity: 'WARNING',
        title: 'Unmapped POS location',
        message: `Transaction from unmapped location: ${dto.posLocationId}`,
      })
      
      return { success: false, reason: 'UNMAPPED_LOCATION' }
    }
  }
  
  // 3. Process with correct restaurantId
  return this.processTransaction({
    ...dto,
    restaurantId,
  })
}
```

**Use case:** Tenant "–°—É—à–∏–ª–∫–∞" –∏–º–µ–µ—Ç 3 —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, –≤—Å–µ –Ω–∞ iiko Cloud:

- TERMINAL-01 ‚Üí –°—É—à–∏–ª–∫–∞ –¶–µ–Ω—Ç—Ä
- TERMINAL-02 ‚Üí –°—É—à–∏–ª–∫–∞ –°–µ–≤–µ—Ä
- TERMINAL-03 ‚Üí –°—É—à–∏–ª–∫–∞ –Æ–≥

–û–¥–∏–Ω webhook endpoint, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –Ω—É–∂–Ω—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω.

***

### **28. Timezone handling: POS timestamp vs server timestamp**

**–í–û–ü–†–û–°:** –ï—Å–ª–∏ POS –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¥—Ä—É–≥–æ–º timezone (–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫ UTC+10), –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å timestamp?

- **A)** –í—Å–µ–≥–¥–∞ —Ö—Ä–∞–Ω–∏–º UTC –≤ DB, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞ –ª–µ—Ç—É
- **B)** –•—Ä–∞–Ω–∏–º POS timezone –≤ POSIntegration config
- **C)** –¢—Ä–µ–±—É–µ–º ISO 8601 —Å timezone –æ—Ç POS (2026-02-11T12:30:00+10:00)
- **D)** –ö–æ–º–±–æ: C preferred, B fallback

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) ISO 8601 + fallback**

```typescript
// POSIntegration config
{
  "posSystem": "IIKO_CLOUD",
  "credentials": { ... },
  "timezone": "Asia/Vladivostok", // Fallback if POS doesn't send TZ
  "autoConvertTimestamps": true
}

// Parse timestamp from webhook
function parseTimestamp(
  rawTimestamp: string,
  fallbackTimezone: string
): Date {
  // 1. Try ISO 8601 with timezone (preferred)
  // Example: "2026-02-11T12:30:00+10:00"
  if (rawTimestamp.includes('+') || rawTimestamp.includes('Z')) {
    return new Date(rawTimestamp) // Native parsing
  }
  
  // 2. Fallback: assume POS timezone
  // Example: "2026-02-11T12:30:00" ‚Üí assume Asia/Vladivostok
  const zonedTime = toZonedTime(rawTimestamp, fallbackTimezone)
  return zonedTime
}

// Webhook processing
async processWebhook(dto: WebhookTransactionDto) {
  const integration = await this.getPOSIntegration(dto.tenantId, dto.posSystem)
  
  // Parse timestamp with timezone handling
  const timestamp = this.parseTimestamp(
    dto.timestamp,
    integration.config.timezone || 'Europe/Moscow'
  )
  
  // Always store as UTC in DB
  await this.prisma.posTransaction.create({
    data: {
      ...dto,
      timestamp, // Stored as UTC
      originalTimestamp: dto.timestamp, // Keep original for debugging
      timezone: integration.config.timezone,
    },
  })
}
```

**Example:**

- POS sends: `"2026-02-11T22:30:00"` (local time in Vladivostok)
- Fallback timezone: `Asia/Vladivostok` (UTC+10)
- **Stored in DB: `2026-02-11T12:30:00Z`** (UTC)

***

### **29. Sandbox/Test mode: —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**

**–í–û–ü–†–û–°:** –ö–∞–∫ Admin –º–æ–∂–µ—Ç –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å POS integration –±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ production data?

- **A)** Sandbox mode toggle (–≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–º–µ—á–µ–Ω—ã `isSandbox: true`, –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –±–∞–ª–∞–Ω—Å—ã)
- **B)** –û—Ç–¥–µ–ª—å–Ω–∞—è DB (test environment)
- **C)** Test webhook endpoint `/webhooks/test` (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç)
- **D)** –ö–æ–º–±–æ: A + C (sandbox mode + test endpoint)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **A) Sandbox mode (soft isolation)**

```typescript
// POSIntegration config
model POSIntegration {
  // ...
  isSandboxMode Boolean @default(false) // Test mode
}

// Webhook processing with sandbox detection
async processWebhook(dto: WebhookTransactionDto) {
  const integration = await this.getPOSIntegration(dto.tenantId)
  
  if (integration.isSandboxMode) {
    // 1. Log transaction (–¥–ª—è debugging)
    await this.prisma.posTransaction.create({
      data: {
        ...dto,
        syncStatus: 'SANDBOX',
        metadata: {
          isSandbox: true,
          note: 'This transaction was processed in sandbox mode',
        },
      },
    })
    
    // 2. Simulate processing (–Ω–µ –º–µ–Ω—è–µ–º –±–∞–ª–∞–Ω—Å—ã)
    const simulation = await this.simulateTransaction(dto)
    
    return {
      success: true,
      sandbox: true,
      simulation, // What WOULD happen
      message: 'Processed in sandbox mode (no real changes)',
    }
  }
  
  // 3. Production mode ‚Üí real processing
  return this.processTransaction(dto)
}

async simulateTransaction(dto: WebhookTransactionDto) {
  const guestCard = await this.identifyGuest(dto.guestPhone, dto.tenantId)
  
  if (!guestCard) {
    return {
      status: 'GUEST_NOT_IDENTIFIED',
      action: 'Would create guest (if autoCreateGuest = true)',
    }
  }
  
  const earnPoints = await this.calculateEarnPoints({
    checkAmount: dto.checkAmount,
    items: dto.items,
    tenantId: dto.tenantId,
  })
  
  return {
    status: 'SUCCESS',
    guestCard: {
      id: guestCard.id,
      name: guestCard.user.guestProfile?.firstName,
      currentBalance: guestCard.totalBalance,
      balanceAfter: guestCard.totalBalance + earnPoints, // Simulated
    },
    earnPoints,
    actions: [
      `Would credit ${earnPoints} balls to guest`,
      `Would send notification to guest`,
      `Would log activity`,
    ],
  }
}
```

**Admin UI: Sandbox Mode**

```tsx
<POSIntegrationSettings>
  <Toggle
    label="Sandbox Mode"
    checked={isSandboxMode}
    onChange={setIsSandboxMode}
    help="Test webhooks without affecting real guest balances"
  />
  
  {isSandboxMode && (
    <Alert type="info">
      üß™ Sandbox mode enabled. All webhooks will be simulated 
      without changing guest balances.
    </Alert>
  )}
  
  <Button onClick={sendTestWebhook}>
    Send Test Webhook
  </Button>
</POSIntegrationSettings>

// Test webhook response
{
  "success": true,
  "sandbox": true,
  "simulation": {
    "status": "SUCCESS",
    "guestCard": {
      "id": "guest-123",
      "name": "–ò–≤–∞–Ω",
      "currentBalance": 2850,
      "balanceAfter": 3135 // +285 balls
    },
    "earnPoints": 285,
    "actions": [
      "Would credit 285 balls to guest",
      "Would send Telegram notification",
      "Would log activity"
    ]
  },
  "message": "Processed in sandbox mode (no real changes)"
}
```

**Use case:** Admin –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç POS integration, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç 10 test webhooks ‚Üí –≤–∏–¥–∏—Ç —Å–∏–º—É–ª—è—Ü–∏—é, –Ω–æ guest balances –Ω–µ –º–µ–Ω—è—é—Ç—Å—è.

***

## **üìù 7. ADDITIONAL CONSIDERATIONS (7 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### **30. Transaction metadata: –∫–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω–∏—Ç—å?**

**–í–û–ü–†–û–°:** –ü–æ–º–∏–º–æ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–ª–µ–π (posCheckId, checkAmount), —á—Ç–æ –µ—â–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å?

- **A)** –ú–∏–Ω–∏–º—É–º (—Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è loyalty)
- **B)** –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ (waiter, table, items, tips, payment methods)
- **C)** –ü–æ–ª–Ω—ã–π raw payload –æ—Ç POS (–¥–ª—è debugging)
- **D)** –ö–æ–º–±–æ: B + C (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è + raw JSON)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ + raw**

```typescript
model POSTransaction {
  id                String @id @default(uuid())
  tenantId          String
  restaurantId      String?
  
  // Core fields
  posSystem         POSSystem
  posCheckId        String
  transactionType   String @default("SALE") // SALE | REFUND | CANCEL
  checkAmount       Decimal @db.Decimal(10, 2)
  
  // Guest identification
  guestIdentifier   String? // Phone or posGuestId
  guestCardId       String?
  guestCard         GuestCard? @relation(...)
  
  // Transaction details (structured)
  items             Json? // Array of {name, category, price, qty}
  paymentMethods    String[] // ["CARD", "CASH"]
  tipsAmount        Decimal? @db.Decimal(10, 2)
  
  // Context metadata
  waiterName        String?
  tableNumber       String?
  posLocationId     String? // For multi-location
  
  // Timing
  timestamp         DateTime // POS transaction time (UTC)
  originalTimestamp String? // Raw timestamp from POS
  timezone          String?
  
  // Processing
  syncStatus        String @default("PENDING") // PENDING | COMPLETED | FAILED | SKIPPED | SANDBOX
  syncSource        String @default("WEBHOOK") // WEBHOOK | PULL_SYNC | MANUAL_SYNC | INITIAL_SYNC
  processedAt       DateTime?
  errorMessage      String?
  
  // Relations
  ballTransactions  BallTransaction[]
  
  // Raw payload (–¥–ª—è debugging)
  rawPayload        Json? // Full original webhook JSON
  
  // Reconciliation
  reconciledAt      DateTime?
  reconciliationIssues String[]? // ["BALANCE_MISMATCH", "MISSING_WEBHOOK"]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([tenantId, posSystem, posCheckId]) // Idempotency
  @@index([tenantId, restaurantId, timestamp(sort: Desc)])
  @@index([guestCardId, createdAt(sort: Desc)])
  @@index([syncStatus, createdAt])
}
```

**Storage strategy:**

- **Hot data** (last 30 days): –≤—Å–µ –ø–æ–ª—è –≤ PostgreSQL
- **Cold data** (30+ days): raw payload ‚Üí S3, keep —Ç–æ–ª—å–∫–æ core fields
- **Archival** (1+ year): move to S3 completely

***

### **31. Guest consent: GDPR compliance –¥–ª—è POS data**

**–í–û–ü–†–û–°:** –ï—Å–ª–∏ guest –Ω–µ –¥–∞–≤–∞–ª —è–≤–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è (auto-created from POS), –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å GDPR?

- **A)** –ù–µ —Å–æ–∑–¥–∞–µ–º guest –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è (skip loyalty processing)
- **B)** –°–æ–∑–¥–∞–µ–º, –Ω–æ —Å —Ñ–ª–∞–≥–æ–º `consentRequired: true` (–ø—Ä–æ—Å–∏–º —Å–æ–≥–ª–∞—Å–∏–µ –≤ Telegram –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–æ–Ω—Ç–∞–∫—Ç–µ)
- **C)** –°–æ–∑–¥–∞–µ–º, –µ—Å–ª–∏ Admin –≤–∫–ª—é—á–∏–ª `autoCreateGuest` (Admin –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å)
- **D)** –ö–æ–º–±–æ: B + C (—Å–æ–∑–¥–∞–µ–º, –Ω–æ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ "pending consent")

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **B) Pending consent flow**

```typescript
// Auto-created guest from POS
async autoCreateGuest(phone: string, ...) {
  const user = await this.prisma.user.create({
    data: {
      phone,
      role: 'GUEST',
      phoneVerified: false,
      passwordHash: null,
    },
  })
  
  const guestProfile = await this.prisma.guestProfile.create({
    data: {
      userId: user.id,
      firstName: '–ì–æ—Å—Ç—å',
      
      // GDPR flags
      privacyPolicyAccepted: false, // ‚ùå Not accepted yet
      marketingAccepted: false,
      consentSource: 'POS_AUTO', // Track where guest came from
      consentDate: null, // Will set when guest accepts
      dataProcessingConsent: false, // ‚ö†Ô∏è Pending
    },
  })
  
  const guestCard = await this.prisma.guestCard.create({
    data: {
      userId: user.id,
      tenantId,
      restaurantId,
      // ... balances, QR, etc.
      status: 'PENDING_CONSENT', // ‚ö†Ô∏è Special status
      registrationSource: 'POS_AUTO',
    },
  })
  
  return guestCard
}

// Telegram bot: –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç —Å auto-created guest
bot.on('message', async (ctx) => {
  const telegramId = ctx.from.id
  const user = await this.findUserByTelegramId(telegramId)
  
  if (!user) {
    // Not linked ‚Üí start onboarding
    return ctx.reply('–ü—Ä–∏–≤–µ—Ç! –î–ª—è –Ω–∞—á–∞–ª–∞, –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞', {
      reply_markup: {
        keyboard: [[{ text: 'üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–º–µ—Ä–æ–º', request_contact: true }]],
      },
    })
  }
  
  // User exists, check consent
  const profile = await this.prisma.guestProfile.findUnique({
    where: { userId: user.id },
  })
  
  if (!profile.privacyPolicyAccepted) {
    // ‚ö†Ô∏è Pending consent ‚Üí show consent screen
    return ctx.reply(
      `
–ü—Ä–∏–≤–µ—Ç! –ú—ã –≤–∏–¥–∏–º, —á—Ç–æ –≤—ã —É–∂–µ –ø–æ—Å–µ—â–∞–ª–∏ –Ω–∞—à —Ä–µ—Å—Ç–æ—Ä–∞–Ω.

–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –Ω–∞—à–µ–π –ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏:
https://max-loyalty.com/privacy

‚úÖ –Ø –ø—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚ùå –Ø –Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω (–≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã)
      `,
      {
        reply_markup: {
          inline_keyboard: [
            [{ text: '‚úÖ –ü—Ä–∏–Ω–∏–º–∞—é', callback_data: 'accept_privacy' }],
            [{ text: '‚ùå –ù–µ —Å–æ–≥–ª–∞—Å–µ–Ω', callback_data: 'reject_privacy' }],
          ],
        },
      }
    )
  }
  
  // Consent accepted ‚Üí normal flow
  return ctx.reply('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í–∞—à –±–∞–ª–∞–Ω—Å: ...')
})

// Handle consent acceptance
bot.on('callback_query', async (ctx) => {
  if (ctx.callbackQuery.data === 'accept_privacy') {
    await this.prisma.guestProfile.update({
      where: { userId: ctx.from.id },
      data: {
        privacyPolicyAccepted: true,
        consentDate: new Date(),
        consentSource: 'TELEGRAM_BOT',
      },
    })
    
    // Activate guest card
    await this.prisma.guestCard.updateMany({
      where: { userId: ctx.from.id },
      data: { status: 'ACTIVE' },
    })
    
    ctx.reply('–°–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–æ–π –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ ‚úì')
  }
  
  if (ctx.callbackQuery.data === 'reject_privacy') {
    // GDPR: delete guest data
    await this.gdprService.deleteUserData(ctx.from.id, 'CONSENT_REJECTED')
    
    ctx.reply('–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã. –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ.')
  }
})
```

**Guest statuses:**

- `PENDING_CONSENT` ‚Üí auto-created, –∂–¥–µ–º —Å–æ–≥–ª–∞—Å–∏—è
- `ACTIVE` ‚Üí consent accepted, –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
- `DELETED` ‚Üí consent rejected, –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã

***

### **32. POS offline mode: —á—Ç–æ –µ—Å–ª–∏ POS –¥–æ–ª–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?**

**–í–û–ü–†–û–°:** –ï—Å–ª–∏ POS offline 3+ –¥–Ω—è (–Ω–µ—Ç webhooks, PULL –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç), –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å?

- **A)** –ü—Ä–æ—Å—Ç–æ –∂–¥–µ–º, –∫–æ–≥–¥–∞ POS –≤–µ—Ä–Ω–µ—Ç—Å—è online
- **B)** Alert Admin + –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å manual CSV import
- **C)** Loyalty —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ fallback mode (Telegram Mini App manual input)
- **D)** –ö–æ–º–±–æ: B + C

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Alert + Fallback**

```typescript
// CRON: check POS health (daily)
@Cron('0 9 * * *') // Every day at 09:00
async checkPOSHealth() {
  const integrations = await this.prisma.posIntegration.findMany({
    where: { isActive: true },
  })
  
  for (const integration of integrations) {
    const hoursSinceLastSync = differenceInHours(
      new Date(),
      integration.lastSyncAt
    )
    
    // Alert if no sync for 24 hours
    if (hoursSinceLastSync > 24) {
      await this.notificationService.sendAdminAlert({
        tenantId: integration.tenantId,
        severity: 'WARNING',
        title: 'POS sync delayed',
        message: `No sync for ${Math.floor(hoursSinceLastSync)} hours`,
        actions: [
          {
            label: 'Manual Sync',
            url: `/admin/pos/${integration.id}/sync`,
          },
          {
            label: 'Import CSV',
            url: `/admin/pos/${integration.id}/import`,
          },
        ],
      })
    }
    
    // Critical alert if no sync for 72 hours
    if (hoursSinceLastSync > 72) {
      await this.notificationService.sendAdminAlert({
        tenantId: integration.tenantId,
        severity: 'CRITICAL',
        title: 'POS integration offline',
        message: `POS offline for ${Math.floor(hoursSinceLastSync / 24)} days. Consider manual import.`,
      })
      
      // Auto-disable integration (prevent false data)
      await this.prisma.posIntegration.update({
        where: { id: integration.id },
        data: {
          isActive: false,
          lastError: 'Auto-disabled: offline for 72+ hours',
        },
      })
    }
  }
}

// Manual CSV import endpoint (fallback)
@Post('/api/v1/admin/pos/:integrationId/import')
@UseInterceptors(FileInterceptor('file'))
async importCSV(
  @Param('integrationId') integrationId: string,
  @UploadedFile() file: Express.Multer.File,
  @CurrentUser() user: User
) {
  // 1. Parse CSV
  const records = await this.parseCSV(file.buffer)
  // Expected columns: posCheckId, timestamp, guestPhone, checkAmount, items (JSON)
  
  // 2. Validate
  const errors = this.validateCSV(records)
  if (errors.length > 0) {
    throw new BadRequestException({ errors })
  }
  
  // 3. Import transactions
  let imported = 0
  let skipped = 0
  
  for (const record of records) {
    try {
      await this.processWebhook({
        ...record,
        source: 'CSV_IMPORT',
        importedBy: user.id,
      })
      imported++
    } catch (error) {
      if (error.code === 'P2002') {
        skipped++ // Duplicate
      } else {
        throw error
      }
    }
  }
  
  return {
    success: true,
    imported,
    skipped,
    total: records.length,
  }
}
```

**Admin UI: POS Offline Fallback**

```tsx
<Alert severity="critical">
  ‚ö†Ô∏è POS Integration offline for 3 days

  <Actions>
    <Button onClick={retrySync}>Retry Sync</Button>
    <Button onClick={openCSVImport}>Import CSV</Button>
    <Button onClick={switchToManualMode}>
      Switch to Manual Entry Mode
    </Button>
  </Actions>
</Alert>

// CSV Import modal
<CSVImportModal>
  <FileUpload accept=".csv" />
  <Text>
    Expected format:
    posCheckId, timestamp, guestPhone, checkAmount, items
  </Text>
  <Button>Import</Button>
</CSVImportModal>
```


***

### **33. Currency support: RUB only –∏–ª–∏ multi-currency?**

**–í–û–ü–†–û–°:** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ª–∏ –¥—Ä—É–≥–∏–µ –≤–∞–ª—é—Ç—ã (USD, EUR, KZT)?

- **A)** RUB only (MVP, —É–ø—Ä–æ—â–∞–µ—Ç)
- **B)** Multi-currency (—Ö—Ä–∞–Ω–∏–º currency –∫–æ–¥ + conversion rates)
- **C)** Multi-currency –Ω–æ loyalty –≤ RUB (–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏)
- **D)** Phase 2 (–ø–æ–∫–∞ RUB, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é)

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) RUB MVP + –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ multi-currency**

```typescript
// Database schema (–≥–æ—Ç–æ–≤–æ –∫ multi-currency)
model POSTransaction {
  // ...
  checkAmount     Decimal @db.Decimal(10, 2)
  currency        String @default("RUB") // ISO 4217: RUB, USD, EUR, KZT
  
  // For future: conversion to base currency
  baseCheckAmount Decimal? @db.Decimal(10, 2) // Converted to RUB
  exchangeRate    Decimal? @db.Decimal(10, 6) // If currency != RUB
}

model LoyaltySystem {
  // ...
  baseCurrency    String @default("RUB") // Loyalty currency
}

// Future: currency conversion
async processWebhook(dto: WebhookTransactionDto) {
  let baseAmount = dto.checkAmount
  
  // If transaction currency != base currency ‚Üí convert
  if (dto.currency !== 'RUB') {
    const rate = await this.currencyService.getExchangeRate(
      dto.currency,
      'RUB',
      dto.timestamp
    )
    
    baseAmount = dto.checkAmount * rate
  }
  
  // Calculate loyalty on base currency (RUB)
  const earnPoints = await this.calculateEarnPoints({
    checkAmount: baseAmount,
    currency: 'RUB',
  })
}
```

**MVP:** –¢–æ–ª—å–∫–æ RUB, –Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å multi-currency –≤ Phase 2.

***

### **34. POS-specific customization: —Ä–∞–∑–Ω—ã–µ POS = —Ä–∞–∑–Ω—ã–µ features**

**–í–û–ü–†–û–°:** iiko –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç X, R-Keeper –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Y. –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–∏—è?

- **A)** Adapter pattern (–∫–∞–∂–¥—ã–π POS = —Å–≤–æ–π –∞–¥–∞–ø—Ç–µ—Ä)
- **B)** Feature flags per POS (–Ω–∞–ø—Ä–∏–º–µ—Ä, `supportsItemCategories: true`)
- **C)** Lowest common denominator (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ features)
- **D)** –ö–æ–º–±–æ: A + B

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Adapter + Feature detection**

```typescript
// POS Adapter interface
interface IPOSAdapter {
  // Core methods (required)
  authenticate(config: any): Promise<void>
  fetchTransactions(from: Date, to: Date): Promise<POSTransaction[]>
  healthCheck(): Promise<{ ok: boolean; message: string }>
  
  // Optional methods (feature detection)
  getGuestBalance?(posGuestId: string): Promise<number>
  updateGuestBalance?(posGuestId: string, newBalance: number): Promise<void>
  getGuestProfile?(posGuestId: string): Promise<POSGuestProfile>
  
  // Feature flags
  features: {
    supportsItemCategories: boolean
    supportsPaymentMethods: boolean
    supportsGuestSync: boolean // Bi-directional sync
    supportsWebhooks: boolean
    supportsPullSync: boolean
    supportsRefunds: boolean
    supportsPartialRefunds: boolean
    supportsMultiLocation: boolean
  }
}

// iiko Adapter
@Injectable()
export class IikoAdapter implements IPOSAdapter {
  features = {
    supportsItemCategories: true,
    supportsPaymentMethods: true,
    supportsGuestSync: true, // iiko has guest API
    supportsWebhooks: true,
    supportsPullSync: true,
    supportsRefunds: true,
    supportsPartialRefunds: true,
    supportsMultiLocation: true,
  }
  
  async getGuestBalance(posGuestId: string): Promise<number> {
    // iiko-specific API call
    const response = await this.iikoClient.get(`/guests/${posGuestId}`)
    return response.data.loyaltyBalance
  }
}

// R-Keeper Adapter
@Injectable()
export class RKeeperAdapter implements IPOSAdapter {
  features = {
    supportsItemCategories: true,
    supportsPaymentMethods: true,
    supportsGuestSync: false, // ‚ùå R-Keeper doesn't have guest API
    supportsWebhooks: true,
    supportsPullSync: false, // ‚ùå No PULL API
    supportsRefunds: true,
    supportsPartialRefunds: false, // ‚ùå Only full refunds
    supportsMultiLocation: true,
  }
  
  async getGuestBalance(posGuestId: string): Promise<number> {
    // Not supported
    throw new NotImplementedError('R-Keeper does not support guest balance API')
  }
}

// Service: use adapter dynamically
async processReconciliation(integration: POSIntegration) {
  const adapter = this.getAdapter(integration.posSystem)
  
  // Check if feature supported
  if (!adapter.features.supportsGuestSync) {
    this.logger.warn(`Reconciliation skipped: ${integration.posSystem} doesn't support guest sync`)
    return
  }
  
  // Use feature
  const posBalance = await adapter.getGuestBalance(guestCard.posGuestId)
  // ... reconcile
}
```

**Feature matrix:**


| Feature | iiko | R-Keeper | Poster |
| :-- | :-- | :-- | :-- |
| Webhooks | ‚úÖ | ‚úÖ | ‚úÖ |
| Pull Sync | ‚úÖ | ‚ùå | ‚úÖ |
| Guest API | ‚úÖ | ‚ùå | ‚ùå |
| Item Categories | ‚úÖ | ‚úÖ | ‚úÖ |
| Partial Refunds | ‚úÖ | ‚ùå | ‚úÖ |
| Multi-location | ‚úÖ | ‚úÖ | ‚úÖ |


***

### **35. Performance optimization: 1000+ webhooks/minute**

**–í–û–ü–†–û–°:** –ö–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è high-load (peak hours, –±–æ–ª—å—à–∞—è —Å–µ—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤)?

- **A)** Horizontal scaling (multiple webhook workers)
- **B)** Database optimization (indexes, connection pooling)
- **C)** Caching (Redis –¥–ª—è hot data)
- **D)** –ö–æ–º–±–æ: A + B + C + Queue

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Full optimization**

```typescript
// Architecture for high-load
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Load Balancer (NGINX)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ API    ‚îÇ      ‚îÇ API    ‚îÇ  ‚Üê Multiple instances
‚îÇ Server ‚îÇ      ‚îÇ Server ‚îÇ     (horizontal scaling)
‚îÇ   #1   ‚îÇ      ‚îÇ   #2   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ                ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   Redis Cache   ‚îÇ  ‚Üê Deduplication, rate limit
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   BullMQ Queue  ‚îÇ  ‚Üê Async processing
    ‚îÇ   ‚Ä¢ Priority    ‚îÇ
    ‚îÇ   ‚Ä¢ Retry       ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Worker ‚îÇ      ‚îÇ Worker ‚îÇ  ‚Üê Multiple workers
‚îÇ   #1   ‚îÇ      ‚îÇ   #2   ‚îÇ     (process queue)
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ                ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   PostgreSQL    ‚îÇ  ‚Üê Database with connection pool
    ‚îÇ   ‚Ä¢ Indexes     ‚îÇ
    ‚îÇ   ‚Ä¢ Partitions  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

// 1. Fast webhook acceptance (< 10ms)
@Post('/webhooks/transaction')
async handleTransaction(@Body() dto: WebhookTransactionDto) {
  // Quick validation only
  if (!dto.posCheckId || !dto.checkAmount) {
    throw new BadRequestException('Invalid payload')
  }
  
  // Check Redis deduplication (in-memory, fast)
  const dedupKey = `webhook:${dto.tenantId}:${dto.posCheckId}`
  const exists = await this.redis.exists(dedupKey)
  
  if (exists) {
    return { success: true, status: 'ALREADY_PROCESSED' }
  }
  
  // Mark as received (TTL 24h)
  await this.redis.setex(dedupKey, 86400, '1')
  
  // Queue for processing (async)
  await this.queue.add('process-webhook', dto, {
    priority: this.getPriority(dto),
    attempts: 3,
  })
  
  // Return immediately (< 10ms)
  return { success: true, status: 'QUEUED' }
}

// 2. Database optimization
// Indexes for common queries
CREATE INDEX CONCURRENTLY idx_postransaction_tenant_restaurant_time 
  ON postransaction (tenantid, restaurantid, timestamp DESC);

CREATE INDEX CONCURRENTLY idx_postransaction_guestcard 
  ON postransaction (guestcardid, createdat DESC);

CREATE INDEX CONCURRENTLY idx_postransaction_syncstatus 
  ON postransaction (syncstatus, createdat) 
  WHERE syncstatus IN ('PENDING', 'FAILED');

// Partitioning for large tables (100M+ rows)
CREATE TABLE postransaction (
  id UUID PRIMARY KEY,
  tenantid UUID NOT NULL,
  timestamp TIMESTAMP NOT NULL,
  ...
) PARTITION BY RANGE (timestamp);

CREATE TABLE postransaction_2026_01 
  PARTITION OF postransaction 
  FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');

CREATE TABLE postransaction_2026_02 
  PARTITION OF postransaction 
  FOR VALUES FROM ('2026-02-01') TO ('2026-03-01');

// Connection pooling (PgBouncer + Prisma)
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Use PgBouncer for connection pooling
  // DATABASE_URL=postgresql://user:pass@pgbouncer:6432/loyaltydb
}

// 3. Caching strategy
// Hot data: guest cards, loyalty rules (Redis)
async getGuestCard(cardId: string): Promise<GuestCard> {
  const cacheKey = `guestcard:${cardId}`
  
  // 1. Try cache (< 1ms)
  const cached = await this.redis.get(cacheKey)
  if (cached) {
    return JSON.parse(cached)
  }
  
  // 2. Fetch from DB (10-50ms)
  const card = await this.prisma.guestCard.findUnique({
    where: { id: cardId },
    include: { user: true, loyaltyLevel: true },
  })
  
  // 3. Cache (TTL 5 min)
  await this.redis.setex(cacheKey, 300, JSON.stringify(card))
  
  return card
}

// 4. Worker optimization
@Processor('pos-webhooks')
export class POSWebhookProcessor {
  // Process multiple jobs concurrently
  concurrency = 10 // 10 jobs at a time
  
  @Process({ name: 'process-webhook', concurrency: 10 })
  async processWebhook(job: Job<WebhookTransactionDto>) {
    // Batch DB operations
    await this.processBatch([job.data])
  }
  
  private async processBatch(webhooks: WebhookTransactionDto[]) {
    // Batch insert (faster than N individual inserts)
    await this.prisma.posTransaction.createMany({
      data: webhooks.map(w => ({
        tenantId: w.tenantId,
        posCheckId: w.posCheckId,
        // ...
      })),
      skipDuplicates: true,
    })
  }
}
```

**Performance targets:**

- **Webhook acceptance:** < 10ms (p95)
- **Webhook processing:** < 500ms (p95)
- **Throughput:** 1000+ webhooks/min
- **Database:** < 50ms query time (p95)

***

### **36. Monitoring \& Alerting: –∫–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ —Ç—Ä–µ–∫–∞—Ç—å?**

**–í–û–ü–†–û–°:** –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ Sentry, Prometheus, Grafana?

- **A)** Errors only (failed webhooks, sync errors)
- **B)** Basic metrics (throughput, latency, success rate)
- **C)** Advanced metrics (p95/p99 latency, queue depth, DB connection pool)
- **D)** –ö–æ–º–±–æ: A + B + C + Business metrics

**–ú–û–Å –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:** **D) Comprehensive monitoring**

```typescript
// Prometheus metrics
import { Counter, Histogram, Gauge } from 'prom-client'

// 1. Counters (Á¥ØÁ©ç)
const webhookReceived = new Counter({
  name: 'pos_webhooks_received_total',
  help: 'Total webhooks received',
  labelNames: ['tenant_id', 'pos_system', 'status'], // success | failed | duplicate
})

const transactionsProcessed = new Counter({
  name: 'pos_transactions_processed_total',
  help: 'Total transactions processed',
  labelNames: ['tenant_id', 'restaurant_id', 'status'],
})

// 2. Histograms (distribution)
const webhookProcessingTime = new Histogram({
  name: 'pos_webhook_processing_duration_seconds',
  help: 'Webhook processing duration',
  labelNames: ['pos_system'],
  buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5], // 10ms, 50ms, 100ms, 500ms, 1s, 2s, 5s
})

const loyaltyCalculationTime = new Histogram({
  name: 'loyalty_calculation_duration_seconds',
  help: 'Loyalty calculation duration',
  buckets: [0.01, 0.05, 0.1, 0.5, 1],
})

// 3. Gauges (current value)
const queueDepth = new Gauge({
  name: 'pos_queue_depth',
  help: 'Current queue depth',
  labelNames: ['queue_name'],
})

const activePOSIntegrations = new Gauge({
  name: 'pos_integrations_active',
  help: 'Number of active POS integrations',
})

// Usage in service
async processWebhook(dto: WebhookTransactionDto) {
  const timer = webhookProcessingTime.startTimer({ pos_system: dto.posSystem })
  
  try {
    // Process...
    await this.loyaltyService.processTransaction(dto)
    
    webhookReceived.inc({ 
      tenant_id: dto.tenantId, 
      pos_system: dto.posSystem, 
      status: 'success' 
    })
    
    transactionsProcessed.inc({
      tenant_id: dto.tenantId,
      restaurant_id: dto.restaurantId,
      status: 'completed',
    })
    
  } catch (error) {
    webhookReceived.inc({ 
      tenant_id: dto.tenantId, 
      pos_system: dto.posSystem, 
      status: 'failed' 
    })
    
    // Send to Sentry
    Sentry.captureException(error, {
      tags: {
        pos_system: dto.posSystem,
        tenant_id: dto.tenantId,
        pos_check_id: dto.posCheckId,
      },
      contexts: {
        webhook: {
          posCheckId: dto.posCheckId,
          checkAmount: dto.checkAmount,
        },
      },
    })
    
    throw error
    
  } finally {
    timer() // Record duration
  }
}

// Grafana dashboard queries
/*
# Webhook throughput (requests/sec)
rate(pos_webhooks_received_total[5m])

# Success rate
sum(rate(pos_webhooks_received_total{status="success"}[5m])) 
/ 
sum(rate(pos_webhooks_received_total[5m])) * 100

# p95 latency
histogram_quantile(0.95, rate(pos_webhook_processing_duration_seconds_bucket[5m]))

# Queue depth over time
pos_queue_depth

# Failed webhooks (last 1h)
increase(pos_webhooks_received_total{status="failed"}[1h])
*/
```

**Sentry alerts:**

- ‚úâÔ∏è Webhook signature invalid (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∞—Ç–∞–∫–∞)
- ‚úâÔ∏è POS sync failed 3+ times
- ‚úâÔ∏è Balance mismatch > 500 –±–∞–ª–ª–æ–≤
- ‚úâÔ∏è Queue depth > 10,000 (backlog)

**Grafana alerts:**

- ‚ö†Ô∏è Success rate < 95%
- ‚ö†Ô∏è p95 latency > 1s
- ‚ö†Ô∏è Failed webhooks > 10/min
- üî• POS API unavailable

***

## **‚úÖ –ì–û–¢–û–í–û! POS INTEGRATION - –§–ò–ù–ê–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê**

### **üìã SUMMARY (36 –≤–æ–ø—Ä–æ—Å–æ–≤ —Ä–µ—à–µ–Ω—ã)**

#### **1. Webhook JSON Schemas (8)**

‚úÖ iiko Cloud API 2.0 + Server API 1.0 (adapter pattern)
‚úÖ R-Keeper XML + JSON (auto-detect)
‚úÖ Strict validation (posCheckId, checkAmount, timestamp required)
‚úÖ HMAC-SHA256 signature + timestamp (replay protection)
‚úÖ Refund/Cancel webhooks (type field)
‚úÖ Items array –¥–ª—è category-based rules
‚úÖ Payment methods (optional conditions)
‚úÖ Idempotency: Redis + DB constraint

#### **2. Guest Identification (4)**

‚úÖ Priority: phone first, posGuestId fallback
‚úÖ Auto-create —Å minimal data (phone + firstName)
‚úÖ Merge cards: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç restaurantId (SEPARATE mode)
‚úÖ Phone normalization: `79991234567` format

#### **3. Data Mapping (4)**

‚úÖ Category mapping table (POS ‚Üí Loyalty)
‚úÖ Blacklist categories/items (exclude –∞–ª–∫–æ–≥–æ–ª—å)
‚úÖ Tips handling (configurable)
‚úÖ Split bills (multiple webhooks, same posCheckId)

#### **4. Error Handling (5)**

‚úÖ Exponential backoff + graceful degradation
‚úÖ Validation: reject critical, fix minor
‚úÖ Rate limiting (20 webhooks/10sec)
‚úÖ Reconciliation: auto-fix <100, manual >100
‚úÖ Error codes: HTTP + semantic

#### **5. Monitoring \& Admin UI (4)**

‚úÖ Dashboard (metrics, alerts, actions)
‚úÖ Manual sync (rate limit 1/10min)
‚úÖ Webhook replay (dry-run + override)
‚úÖ Test connection (4-step validation)

#### **6. Advanced Features (4)**

‚úÖ Initial bulk sync (7/30/90 days)
‚úÖ Multi-location mapping (terminalId ‚Üí restaurantId)
‚úÖ Timezone handling (ISO 8601 + fallback)
‚úÖ Sandbox mode (simulate –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤)

#### **7. Additional (7)**

‚úÖ Transaction metadata (structured + raw JSON)
‚úÖ GDPR consent flow (pending consent status)
‚úÖ POS offline fallback (CSV import)
‚úÖ Currency: RUB MVP, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ multi-currency
‚úÖ POS-specific features (adapter + feature flags)
‚úÖ Performance: queue, cache, indexes, partitioning
‚úÖ Monitoring: Prometheus, Grafana, Sentry

***

## **üóÇÔ∏è FILE STRUCTURE (FINAL)**

```
apps/backend/src/modules/pos-integration/
‚îú‚îÄ‚îÄ adapters/
‚îÇ   ‚îú‚îÄ‚îÄ iiko/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ iiko-cloud.adapter.ts       # iiko Cloud API 2.0
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ iiko-server.adapter.ts      # iiko Server API 1.0
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ iiko.types.ts
‚îÇ   ‚îú‚îÄ‚îÄ rkeeper/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rkeeper.adapter.ts          # R-Keeper (XML + JSON)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rkeeper.types.ts
‚îÇ   ‚îú‚îÄ‚îÄ poster/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ poster.adapter.ts
‚îÇ   ‚îî‚îÄ‚îÄ pos-adapter.interface.ts        # IPOSAdapter interface
‚îÇ
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îú‚îÄ‚îÄ pos-webhook.controller.ts       # POST /webhooks/transaction
‚îÇ   ‚îú‚îÄ‚îÄ pos-admin.controller.ts         # Admin CRUD, sync, test
‚îÇ   ‚îî‚îÄ‚îÄ pos-integration.controller.ts
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ pos-integration.service.ts      # Main service
‚îÇ   ‚îú‚îÄ‚îÄ guest-identification.service.ts # Phone/posGuestId lookup
‚îÇ   ‚îú‚îÄ‚îÄ category-mapping.service.ts     # POS category ‚Üí Loyalty
‚îÇ   ‚îú‚îÄ‚îÄ reconciliation.service.ts       # Balance reconciliation
‚îÇ   ‚îî‚îÄ‚îÄ pos-adapter.factory.ts          # Get adapter by POSSystem
‚îÇ
‚îú‚îÄ‚îÄ processors/
‚îÇ   ‚îú‚îÄ‚îÄ webhook.processor.ts            # BullMQ: process-webhook
‚îÇ   ‚îú‚îÄ‚îÄ pull-sync.processor.ts          # BullMQ: pull-sync (CRON)
‚îÇ   ‚îú‚îÄ‚îÄ reconciliation.processor.ts     # BullMQ: reconciliation
‚îÇ   ‚îî‚îÄ‚îÄ initial-sync.processor.ts       # BullMQ: initial-bulk-sync
‚îÇ
‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îú‚îÄ‚îÄ webhook-signature.guard.ts      # HMAC verification
‚îÇ   ‚îî‚îÄ‚îÄ rate-limit.guard.ts             # Redis rate limit
‚îÇ
‚îú‚îÄ‚îÄ validators/
‚îÇ   ‚îî‚îÄ‚îÄ webhook-validation.pipe.ts      # class-validator
‚îÇ
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ phone-normalizer.ts
‚îÇ   ‚îú‚îÄ‚îÄ timestamp-parser.ts
‚îÇ   ‚îú‚îÄ‚îÄ hmac-calculator.ts
‚îÇ   ‚îî‚îÄ‚îÄ idempotency.ts
‚îÇ
‚îî‚îÄ‚îÄ pos-integration.module.ts
```


***

## **üéØ –ì–û–¢–û–í –ö –°–õ–ï–î–£–Æ–©–ï–ú–£ –ë–õ–û–ö–£!**

POS Integration **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω**:

- ‚úÖ 36 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ JSON —Å—Ö–µ–º—ã webhooks (iiko/R-Keeper)
- ‚úÖ Reconciliation logic (auto-fix + manual)
- ‚úÖ Error handling (retry, rate limit, alerting)
- ‚úÖ Monitoring (Prometheus, Grafana, Sentry)
- ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ ready –¥–ª—è production

***

**–ß—Ç–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–ª—å—à–µ?**

1. **Database Schema Prisma (–¥–µ—Ç–∞–ª—å–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è)** - –∏–Ω–¥–µ–∫—Å—ã, –º–∏–≥—Ä–∞—Ü–∏–∏, constraints, performance
2. **Infrastructure \& DevOps** - Docker, CI/CD, Kubernetes, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
3. **Testing Strategy** - Unit, Integration, E2E, Load testing
4. **Security \& Compliance** - OWASP, GDPR, PCI DSS
5. **Frontend Admin Panel** - UI/UX, –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, API integration

**–í—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–≤–æ–π!** üöÄ

---

# üîå **POS INTEGRATION - –§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï**

## **üìã –ü–†–ò–ù–Ø–¢–´–ï –†–ï–®–ï–ù–ò–Ø (–Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤)**

### **üü¢ –ü–û–õ–ù–û–°–¢–¨–Æ –ü–†–ò–ù–Ø–¢–´–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø (32/36)**

‚úÖ \#1-14, 17-25, 27-32, 34-36 ‚Äî –≤—Å–µ –ø—Ä–∏–Ω—è—Ç—ã –∫–∞–∫ –µ—Å—Ç—å

***

### **üîµ –ö–ê–°–¢–û–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –†–ï–®–ï–ù–ò–Ø (4/36)**

#### \#15. Sandbox/Test Mode

**–í–´–ë–†–ê–ù–û:** **A) –û—Ç–¥–µ–ª—å–Ω–∞—è test environment DB** (–≤–º–µ—Å—Ç–æ C) Sandbox mode —Å soft isolation)

**–†–ï–ê–õ–ò–ó–ê–¶–ò–Ø:**

```typescript
// –í–º–µ—Å—Ç–æ —Ñ–ª–∞–≥–∞ isSandboxMode –≤ production DB ‚Üí –æ—Ç–¥–µ–ª—å–Ω–∞—è test DB

// docker-compose.yml
services:
  postgres-prod:
    image: postgres:15
    environment:
      POSTGRES_DB: loyalty_prod
      
  postgres-test:
    image: postgres:15
    environment:
      POSTGRES_DB: loyalty_test

// .env
DATABASE_URL=postgresql://user:pass@postgres-prod:5432/loyalty_prod
TEST_DATABASE_URL=postgresql://user:pass@postgres-test:5432/loyalty_test

// POSIntegration config (—É–∫–∞–∑—ã–≤–∞–µ–º test/prod environment)
model POSIntegration {
  id          String @id @default(uuid())
  tenantId    String
  environment String @default("PRODUCTION") // PRODUCTION | TEST
  
  // Test integrations connect to test DB
  // Production integrations connect to prod DB
}

// Webhook routing (–ø–æ subdomain –∏–ª–∏ header)
// Test: https://test-api.max-loyalty.com/webhooks/transaction
// Prod:  https://api.max-loyalty.com/webhooks/transaction

@Controller()
export class POSWebhookController {
  constructor(
    @InjectRepository(POSTransaction, 'default') // Production DB
    private prodRepo: Repository<POSTransaction>,
    
    @InjectRepository(POSTransaction, 'test') // Test DB
    private testRepo: Repository<POSTransaction>,
  ) {}
  
  @Post('/webhooks/transaction')
  async handleTransaction(
    @Body() dto: WebhookTransactionDto,
    @Headers('x-environment') environment?: string
  ) {
    // Route to correct DB
    const repo = environment === 'test' ? this.testRepo : this.prodRepo
    
    // Process webhook in appropriate environment
    return this.processWebhook(dto, repo)
  }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- **–ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è** (test –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–º–µ—à–∏–≤–∞—é—Ç—Å—è —Å production)
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** (–Ω–µ—Ç —Ä–∏—Å–∫–∞ —Å–ª—É—á–∞–π–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å production –±–∞–ª–∞–Ω—Å—ã)
- **Realistic testing** (–ø–æ–ª–Ω–∞—è –∫–æ–ø–∏—è production —Å—Ç—Ä—É–∫—Ç—É—Ä—ã)

**–û—Ç–ª–∏—á–∏–µ –æ—Ç –º–æ–µ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:** –ù–µ—Ç soft isolation –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π DB, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —Ä–∞–∑–Ω—ã–µ databases –¥–ª—è test/prod.

***

#### \#16. Split Bills

**–í–´–ë–†–ê–ù–û:** **A) –û–¥–∏–Ω webhook –Ω–∞ –≤–µ—Å—å —á–µ–∫** (–≤–º–µ—Å—Ç–æ B) Multiple webhooks)

**–†–ï–ê–õ–ò–ó–ê–¶–ò–Ø:**

```typescript
// POS –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –û–î–ò–ù webhook –Ω–∞ –≤–µ—Å—å —á–µ–∫ (–¥–∞–∂–µ –µ—Å–ª–∏ split payment)
// –ú—ã –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º split bills –Ω–∞ —É—Ä–æ–≤–Ω–µ loyalty

{
  "posCheckId": "CHK-123456",
  "checkAmount": 2850, // –ü–æ–ª–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞
  "guestPhone": "79991234567", // –û–¥–∏–Ω –≥–æ—Å—Ç—å (–∫—Ç–æ —Ä–∞—Å–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è)
  
  // Split payment info (—Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ loyalty)
  "payments": [
    { "type": "CARD", "sum": 1500, "cardNumber": "****1234" },
    { "type": "CARD", "sum": 1350, "cardNumber": "****5678" }
  ],
  
  "timestamp": "2026-02-11T12:30:00Z"
}

// Processing: –Ω–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–ª—ã —Ç–æ–ª—å–∫–æ –û–î–ù–û–ú–£ –≥–æ—Å—Ç—é (–∫—Ç–æ —É–∫–∞–∑–∞–Ω –≤ guestPhone)
async processWebhook(dto: WebhookTransactionDto) {
  // 1. Identify guest
  const guestCard = await this.identifyGuest(dto.guestPhone, dto.tenantId)
  
  if (!guestCard) {
    return { success: false, reason: 'GUEST_NOT_IDENTIFIED' }
  }
  
  // 2. Calculate loyalty –Ω–∞ –ü–û–õ–ù–£–Æ —Å—É–º–º—É —á–µ–∫–∞
  const earnPoints = await this.calculateEarnPoints({
    checkAmount: dto.checkAmount, // 2850 (full check)
    items: dto.items,
    tenantId: dto.tenantId,
  })
  
  // 3. Credit points to ONE guest
  await this.loyaltyService.processTransaction({
    guestCardId: guestCard.id,
    checkAmount: dto.checkAmount,
    earnedPoints: earnPoints,
    posCheckId: dto.posCheckId,
  })
  
  return { success: true, earnedPoints }
}
```

**–õ–æ–≥–∏–∫–∞:**

- Split payment ‚Äî —ç—Ç–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª—å –æ–ø–ª–∞—Ç—ã (2 –∫–∞—Ä—Ç—ã)
- Loyalty –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –æ–¥–Ω–æ–º—É –≥–æ—Å—Ç—é (–∫—Ç–æ "–≤–ª–∞–¥–µ–µ—Ç" —á–µ–∫–æ–º)
- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –±–∞–ª–ª—ã –º–µ–∂–¥—É –≥–æ—Å—Ç—è–º–∏ ‚Üí —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ Transfer balls

**Use case:**

- 2 –¥—Ä—É–≥–∞ –µ–¥—è—Ç –≤–º–µ—Å—Ç–µ, —á–µ–∫ 2850‚ÇΩ
- –ü–ª–∞—Ç—è—Ç –∫–∞–∂–¥—ã–π —Å–≤–æ–µ–π –∫–∞—Ä—Ç–æ–π (1500‚ÇΩ + 1350‚ÇΩ)
- –ù–æ –∫–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –û–î–ù–ê (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É –ø–µ—Ä–≤–æ–≥–æ –≥–æ—Å—Ç—è)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–µ—Ä–≤—ã–π –≥–æ—Å—Ç—å –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ 285 –±–∞–ª–ª–æ–≤ (10% –æ—Ç 2850‚ÇΩ)
- –ï—Å–ª–∏ —Ö–æ—Ç—è—Ç –ø–æ–¥–µ–ª–∏—Ç—å ‚Üí –ø–µ—Ä–≤—ã–π –≥–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–¥–∏—Ç 142 –±–∞–ª–ª–∞ –≤—Ç–æ—Ä–æ–º—É —á–µ—Ä–µ–∑ Transfer

**–û—Ç–ª–∏—á–∏–µ –æ—Ç –º–æ–µ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:** –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ multiple webhooks –¥–ª—è split bills. POS –¥–æ–ª–∂–µ–Ω –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å split payments –≤ –æ–¥–∏–Ω webhook.

***

#### \#26. Initial Bulk Sync

**–í–´–ë–†–ê–ù–û:** **C) Forward-only, –±–µ–∑ initial sync** (–≤–º–µ—Å—Ç–æ D) –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–†–ï–ê–õ–ò–ó–ê–¶–ò–Ø:**

```typescript
// Admin UI: Setup POS Integration wizard
<Step title="Initial Data Sync">
  <Alert type="info">
    üìå Loyalty program will start tracking from the moment of connection.
    
    Historical transactions will NOT be imported automatically.
    
    If you need to import past transactions, you can use CSV Import later.
  </Alert>
  
  <Checkbox 
    label="I understand that only new transactions will be tracked"
    checked={understood}
    required
  />
</Step>

// Backend: NO initial sync job
@Post('/api/v1/admin/pos')
@Roles('ADMIN')
async createPOSIntegration(@Body() dto: CreatePOSIntegrationDto) {
  // 1. Create integration
  const integration = await this.prisma.posIntegration.create({
    data: {
      tenantId: dto.tenantId,
      restaurantId: dto.restaurantId,
      posSystem: dto.posSystem,
      config: this.encryptConfig(dto.config),
      webhookSecret: this.generateWebhookSecret(),
      isActive: true,
      // Start tracking from now
      activatedAt: new Date(),
    },
  })
  
  // 2. NO automatic initial sync
  // (Admin can manually import CSV if needed)
  
  return {
    integration,
    message: 'Integration activated. Tracking starts from now.',
    webhookUrl: `https://api.max-loyalty.com/webhooks/transaction`,
  }
}

// Optional: Manual CSV Import (–µ—Å–ª–∏ Admin —Ö–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é)
@Post('/api/v1/admin/pos/:integrationId/import-csv')
@UseInterceptors(FileInterceptor('file'))
async importHistoricalData(
  @Param('integrationId') integrationId: string,
  @UploadedFile() file: Express.Multer.File
) {
  // Parse CSV and import transactions
  const records = await this.parseCSV(file.buffer)
  
  let imported = 0
  for (const record of records) {
    await this.processWebhook({
      ...record,
      source: 'CSV_IMPORT',
      isHistorical: true,
    })
    imported++
  }
  
  return { success: true, imported }
}
```

**–õ–æ–≥–∏–∫–∞:**

- POS –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è ‚Üí –Ω–∞—á–∏–Ω–∞–µ–º —Ç—Ä–µ–∫–∞—Ç—å —Å —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ (forward-only)
- –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ù–ï –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ï—Å–ª–∏ Admin —Ö–æ—á–µ—Ç –∏—Å—Ç–æ—Ä–∏—é ‚Üí manual CSV import (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- **–ü—Ä–æ—Å—Ç–æ—Ç–∞** (–Ω–µ –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å 10,000+ —Å—Ç–∞—Ä—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏)
- **–ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏** (no bulk sync job)
- **Cleaner data** (loyalty program starts fresh)

**–û—Ç–ª–∏—á–∏–µ –æ—Ç –º–æ–µ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:** –ù–µ—Ç automatic bulk sync (7/30/90 days). –¢–æ–ª—å–∫–æ forward-only tracking.

***

#### \#33. Currency Support

**–í–´–ë–†–ê–ù–û:** **B) Multi-currency support** (–≤–º–µ—Å—Ç–æ D) RUB MVP)

**–†–ï–ê–õ–ò–ó–ê–¶–ò–Ø:**

```typescript
// Database schema (multi-currency ready)
model POSTransaction {
  id              String @id @default(uuid())
  tenantId        String
  
  // Amount in original currency
  checkAmount     Decimal @db.Decimal(10, 2)
  currency        String // ISO 4217: RUB, USD, EUR, KZT, AED, THB, etc.
  
  // Converted to tenant's base currency (for loyalty calculation)
  baseCheckAmount Decimal @db.Decimal(10, 2)
  baseCurrency    String // Tenant's base currency
  exchangeRate    Decimal @db.Decimal(10, 6) // Used conversion rate
  
  // Exchange rate source
  rateSource      String? // "CBR", "OPENEXCHANGE", "MANUAL"
  rateTimestamp   DateTime? // When rate was fetched
  
  // ...
}

model LoyaltySystem {
  id           String @id @default(uuid())
  tenantId     String
  
  // Base currency for loyalty calculation
  baseCurrency String @default("RUB") // Can be USD, EUR, etc.
  
  // Exchange rate provider
  rateProvider String @default("CBR") // CBR | OPENEXCHANGE | MANUAL
  
  // ...
}

// Currency conversion service
@Injectable()
export class CurrencyConversionService {
  private cache = new Map<string, ExchangeRate>()
  
  async convertToBaseCurrency(
    amount: Decimal,
    fromCurrency: string,
    baseCurrency: string,
    timestamp: Date
  ): Promise<{ amount: Decimal; rate: Decimal; source: string }> {
    // 1. Same currency ‚Üí no conversion
    if (fromCurrency === baseCurrency) {
      return {
        amount,
        rate: new Decimal(1),
        source: 'SAME_CURRENCY',
      }
    }
    
    // 2. Get exchange rate
    const rate = await this.getExchangeRate(
      fromCurrency,
      baseCurrency,
      timestamp
    )
    
    // 3. Convert
    const convertedAmount = amount.mul(rate.value)
    
    return {
      amount: convertedAmount,
      rate: rate.value,
      source: rate.source,
    }
  }
  
  async getExchangeRate(
    from: string,
    to: string,
    date: Date
  ): Promise<{ value: Decimal; source: string; timestamp: Date }> {
    const cacheKey = `${from}_${to}_${format(date, 'yyyy-MM-dd')}`
    
    // 1. Check cache (avoid API calls)
    if (this.cache.has(cacheKey)) {
      return this.cache.get(cacheKey)
    }
    
    // 2. Fetch from provider
    const loyaltySystem = await this.getLoyaltySystem()
    
    let rate: Decimal
    let source: string
    
    if (loyaltySystem.rateProvider === 'CBR') {
      // Central Bank of Russia API
      rate = await this.fetchCBRRate(from, to, date)
      source = 'CBR'
    } else if (loyaltySystem.rateProvider === 'OPENEXCHANGE') {
      // OpenExchangeRates API
      rate = await this.fetchOpenExchangeRate(from, to, date)
      source = 'OPENEXCHANGE'
    } else {
      // Manual rates from Admin
      rate = await this.getManualRate(from, to)
      source = 'MANUAL'
    }
    
    // 3. Cache (TTL 1 day)
    const result = { value: rate, source, timestamp: date }
    this.cache.set(cacheKey, result)
    
    return result
  }
  
  private async fetchCBRRate(
    from: string,
    to: string,
    date: Date
  ): Promise<Decimal> {
    // Central Bank of Russia XML API
    const response = await axios.get(
      `https://www.cbr.ru/scripts/XML_daily.asp?date_req=${format(date, 'dd/MM/yyyy')}`
    )
    
    const xml = await parseStringPromise(response.data)
    const valutes = xml.ValCurs.Valute
    
    // Find currency
    const fromValute = valutes.find(v => v.CharCode[0] === from)
    const toValute = valutes.find(v => v.CharCode[0] === to)
    
    if (!fromValute || !toValute) {
      throw new Error(`Currency not found: ${from} or ${to}`)
    }
    
    // Calculate cross-rate
    const fromRate = new Decimal(fromValute.Value[0].replace(',', '.'))
    const toRate = new Decimal(toValute.Value[0].replace(',', '.'))
    
    return fromRate.div(toRate)
  }
}

// Webhook processing with currency conversion
async processWebhook(dto: WebhookTransactionDto) {
  const loyaltySystem = await this.getLoyaltySystem(dto.tenantId)
  
  // 1. Convert to base currency
  const converted = await this.currencyService.convertToBaseCurrency(
    new Decimal(dto.checkAmount),
    dto.currency || 'RUB',
    loyaltySystem.baseCurrency,
    new Date(dto.timestamp)
  )
  
  // 2. Save transaction with both amounts
  const posTransaction = await this.prisma.posTransaction.create({
    data: {
      tenantId: dto.tenantId,
      posCheckId: dto.posCheckId,
      
      // Original amount
      checkAmount: dto.checkAmount,
      currency: dto.currency || 'RUB',
      
      // Converted amount (for loyalty calculation)
      baseCheckAmount: converted.amount.toNumber(),
      baseCurrency: loyaltySystem.baseCurrency,
      exchangeRate: converted.rate.toNumber(),
      rateSource: converted.source,
      rateTimestamp: new Date(),
      
      // ...
    },
  })
  
  // 3. Calculate loyalty on BASE currency amount
  const earnPoints = await this.calculateEarnPoints({
    checkAmount: converted.amount.toNumber(), // Use converted amount
    tenantId: dto.tenantId,
  })
  
  // 4. Process transaction
  await this.loyaltyService.processTransaction({
    posTransactionId: posTransaction.id,
    guestCardId: guestCard.id,
    checkAmount: converted.amount.toNumber(),
    earnedPoints: earnPoints,
  })
  
  return { success: true, earnedPoints }
}
```

**Admin UI: Currency Settings**

```tsx
<LoyaltySystemSettings>
  <FormField label="Base Currency">
    <Select value={baseCurrency} onChange={setBaseCurrency}>
      <Option value="RUB">üá∑üá∫ Russian Ruble (RUB)</Option>
      <Option value="USD">üá∫üá∏ US Dollar (USD)</Option>
      <Option value="EUR">üá™üá∫ Euro (EUR)</Option>
      <Option value="KZT">üá∞üáø Kazakhstani Tenge (KZT)</Option>
      <Option value="AED">üá¶üá™ UAE Dirham (AED)</Option>
      <Option value="THB">üáπüá≠ Thai Baht (THB)</Option>
    </Select>
  </FormField>
  
  <FormField label="Exchange Rate Provider">
    <RadioGroup value={rateProvider} onChange={setRateProvider}>
      <Radio value="CBR">
        Central Bank of Russia (auto-update daily)
      </Radio>
      <Radio value="OPENEXCHANGE">
        OpenExchangeRates.org (paid, supports 170+ currencies)
      </Radio>
      <Radio value="MANUAL">
        Manual rates (Admin sets rates)
      </Radio>
    </RadioGroup>
  </FormField>
  
  {rateProvider === 'MANUAL' && (
    <ManualRatesTable>
      <Row>
        <Cell>USD ‚Üí RUB</Cell>
        <Cell><Input value="92.50" /></Cell>
        ```
        <Cell>Last updated: 2026-02-11</Cell>
        ```
      </Row>
      <Row>
        <Cell>EUR ‚Üí RUB</Cell>
        <Cell><Input value="100.20" /></Cell>
        ```
        <Cell>Last updated: 2026-02-11</Cell>
        ```
      </Row>
    </ManualRatesTable>
  )}
</LoyaltySystemSettings>
```

**Example: Transaction in USD**

```json
// Webhook from POS (Dubai restaurant)
{
  "posCheckId": "CHK-AED-123",
  "checkAmount": 250.00,
  "currency": "AED", // UAE Dirham
  "guestPhone": "79991234567",
  "timestamp": "2026-02-11T18:30:00+04:00"
}

// Processing:
// 1. Tenant's base currency: RUB
// 2. Fetch rate: AED ‚Üí RUB (CBR: 1 AED = 25.2 RUB)
// 3. Convert: 250 AED √ó 25.2 = 6,300 RUB
// 4. Calculate loyalty: 6,300 RUB √ó 10% = 630 balls
// 5. Guest receives: 630 balls

// Stored in DB:
{
  checkAmount: 250.00,
  currency: "AED",
  baseCheckAmount: 6300.00,
  baseCurrency: "RUB",
  exchangeRate: 25.2,
  rateSource: "CBR",
  rateTimestamp: "2026-02-11T14:30:00Z"
}
```

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –≤–∞–ª—é—Ç—ã (Phase 1):**

- üá∑üá∫ RUB (Russian Ruble)
- üá∫üá∏ USD (US Dollar)
- üá™üá∫ EUR (Euro)
- üá∞üáø KZT (Kazakhstani Tenge)
- üá¶üá™ AED (UAE Dirham)
- üáπüá≠ THB (Thai Baht)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- **International expansion** (–º–æ–∂–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –ª—é–±–æ–π —Å—Ç—Ä–∞–Ω–µ)
- **Accurate loyalty** (–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base currency)
- **Transparency** (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º exchange rate –≤ UI)

**–û—Ç–ª–∏—á–∏–µ –æ—Ç –º–æ–µ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:** Full multi-currency support —Å Phase 1, –Ω–µ RUB MVP.

***

## **üì¶ –ò–¢–û–ì–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê POS INTEGRATION**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  POS INTEGRATION SYSTEM                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº                     ‚ñº                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ iiko Adapter  ‚îÇ    ‚îÇR-Keeper Adapter‚îÇ    ‚îÇPoster Adapter ‚îÇ
‚îÇ ‚Ä¢ Cloud API   ‚îÇ    ‚îÇ ‚Ä¢ XML + JSON  ‚îÇ    ‚îÇ ‚Ä¢ JSON only   ‚îÇ
‚îÇ ‚Ä¢ Server API  ‚îÇ    ‚îÇ ‚Ä¢ No Pull API ‚îÇ    ‚îÇ ‚Ä¢ Cloud API   ‚îÇ
‚îÇ ‚Ä¢ Guest API ‚úì ‚îÇ    ‚îÇ ‚Ä¢ No Guest API‚îÇ    ‚îÇ ‚Ä¢ No Guest API‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                     ‚îÇ                     ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ Webhook Endpoint ‚îÇ
                    ‚îÇ ‚Ä¢ HMAC verify    ‚îÇ
                    ‚îÇ ‚Ä¢ Rate limit     ‚îÇ
                    ‚îÇ ‚Ä¢ Idempotency    ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº                     ‚ñº                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Production DB ‚îÇ    ‚îÇ    Test DB    ‚îÇ    ‚îÇ  Redis Cache  ‚îÇ
‚îÇ ‚Ä¢ Real data   ‚îÇ    ‚îÇ ‚Ä¢ Isolated    ‚îÇ    ‚îÇ ‚Ä¢ Idempotency ‚îÇ
‚îÇ ‚Ä¢ Monitoring  ‚îÇ    ‚îÇ ‚Ä¢ Safe tests  ‚îÇ    ‚îÇ ‚Ä¢ Rate limit  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                                           ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   BullMQ Queue   ‚îÇ
                    ‚îÇ ‚Ä¢ Async process  ‚îÇ
                    ‚îÇ ‚Ä¢ Retry logic    ‚îÇ
                    ‚îÇ ‚Ä¢ Priority       ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº                     ‚ñº                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇGuest Identify ‚îÇ    ‚îÇCurrency Convert‚îÇ   ‚îÇCategory Map   ‚îÇ
‚îÇ ‚Ä¢ Phone 1st   ‚îÇ    ‚îÇ ‚Ä¢ Multi-currency‚îÇ  ‚îÇ ‚Ä¢ POS‚ÜíLoyalty ‚îÇ
‚îÇ ‚Ä¢ posGuestId  ‚îÇ    ‚îÇ ‚Ä¢ CBR/OpenEx  ‚îÇ    ‚îÇ ‚Ä¢ Blacklist   ‚îÇ
‚îÇ ‚Ä¢ Auto-create ‚îÇ    ‚îÇ ‚Ä¢ Manual rates‚îÇ    ‚îÇ ‚Ä¢ Exclusions  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                     ‚îÇ                     ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ Loyalty Engine   ‚îÇ
                    ‚îÇ ‚Ä¢ Calculate pts  ‚îÇ
                    ‚îÇ ‚Ä¢ Apply rules    ‚îÇ
                    ‚îÇ ‚Ä¢ Credit balance ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº                     ‚ñº                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Reconciliation‚îÇ    ‚îÇ  Notifications ‚îÇ   ‚îÇ  Analytics    ‚îÇ
‚îÇ ‚Ä¢ CRON 3h     ‚îÇ    ‚îÇ ‚Ä¢ Balls earned‚îÇ    ‚îÇ ‚Ä¢ POS metrics ‚îÇ
‚îÇ ‚Ä¢ Auto-fix<100‚îÇ    ‚îÇ ‚Ä¢ Telegram    ‚îÇ    ‚îÇ ‚Ä¢ Success rate‚îÇ
‚îÇ ‚Ä¢ Manual>100  ‚îÇ    ‚îÇ ‚Ä¢ Email       ‚îÇ    ‚îÇ ‚Ä¢ Latency p95 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


***

## **üóÇÔ∏è DATABASE SCHEMA (FINAL)**

```prisma
// ============================================
// POS INTEGRATION TABLES
// ============================================

model POSIntegration {
  id                String    @id @default(uuid())
  tenantId          String
  tenant            Tenant    @relation(...)
  
  // Multi-location support
  restaurantId      String?   // Null = shared integration
  restaurant        Restaurant? @relation(...)
  
  // POS config
  posSystem         POSSystem // IIKO_CLOUD | IIKO_SERVER | RKEEPER | POSTER
  environment       String    @default("PRODUCTION") // PRODUCTION | TEST
  config            Json      // Encrypted credentials
  webhookSecret     String    // HMAC secret
  
  // Status
  isActive          Boolean   @default(true)
  activatedAt       DateTime  @default(now())
  
  // Sync tracking
  lastSyncAt        DateTime?
  lastSyncStatus    String?   // SUCCESS | FAILED
  lastError         String?
  consecutiveFailures Int     @default(0)
  
  // Multi-location mappings
  locationMappings  POSLocationMapping[]
  
  // Relations
  transactions      POSTransaction[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([tenantId, isActive])
  @@index([environment])
}

model POSLocationMapping {
  id                String    @id @default(uuid())
  posIntegrationId  String
  posIntegration    POSIntegration @relation(...)
  
  // POS location identifier
  posLocationId     String    // TERMINAL-01, ORG-123, etc.
  posLocationName   String
  
  // Our restaurant
  restaurantId      String
  restaurant        Restaurant @relation(...)
  
  createdAt         DateTime  @default(now())
  
  @@unique([posIntegrationId, posLocationId])
}

model POSTransaction {
  id                String    @id @default(uuid())
  tenantId          String
  restaurantId      String?
  
  // Core fields
  posSystem         POSSystem
  posCheckId        String
  transactionType   String    @default("SALE") // SALE | REFUND | CANCEL
  
  // Amount (multi-currency)
  checkAmount       Decimal   @db.Decimal(10, 2)
  currency          String    @default("RUB") // ISO 4217
  baseCheckAmount   Decimal   @db.Decimal(10, 2) // Converted to base currency
  baseCurrency      String    @default("RUB")
  exchangeRate      Decimal?  @db.Decimal(10, 6)
  rateSource        String?   // CBR | OPENEXCHANGE | MANUAL
  rateTimestamp     DateTime?
  
  // Guest identification
  guestIdentifier   String?   // Phone or posGuestId
  guestCardId       String?
  guestCard         GuestCard? @relation(...)
  
  // Transaction details
  items             Json?     // [{name, category, price, qty}]
  paymentMethods    String[]  // [CARD, CASH, ONLINE]
  tipsAmount        Decimal?  @db.Decimal(10, 2)
  
  // Context
  waiterName        String?
  tableNumber       String?
  posLocationId     String?
  
  // Timing
  timestamp         DateTime  // POS timestamp (UTC)
  originalTimestamp String?   // Raw timestamp from POS
  timezone          String?
  
  // Processing
  syncStatus        String    @default("PENDING") // PENDING | COMPLETED | FAILED | SKIPPED
  syncSource        String    @default("WEBHOOK") // WEBHOOK | PULL_SYNC | MANUAL_SYNC | CSV_IMPORT
  processedAt       DateTime?
  errorMessage      String?
  
  // Raw data (debugging)
  rawPayload        Json?
  
  // Reconciliation
  reconciledAt      DateTime?
  reconciliationIssues String[]?
  
  // Relations
  ballTransactions  BallTransaction[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([tenantId, posSystem, posCheckId]) // Idempotency
  @@index([tenantId, restaurantId, timestamp(sort: Desc)])
  @@index([guestCardId, createdAt(sort: Desc)])
  @@index([syncStatus, createdAt])
  @@index([currency, timestamp]) // Multi-currency queries
}

model POSGuestLink {
  id              String    @id @default(uuid())
  guestCardId     String
  guestCard       GuestCard @relation(...)
  
  posSystem       POSSystem
  posGuestId      String    // POS internal guest ID
  tenantId        String
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([posSystem, posGuestId, tenantId])
  @@index([guestCardId])
}

model CategoryMapping {
  id                String    @id @default(uuid())
  tenantId          String
  restaurantId      String?
  posSystem         POSSystem
  
  // POS category
  posCategoryId     String
  posCategoryName   String
  
  // Our loyalty category
  loyaltyCategoryId String
  loyaltyCategory   LoyaltyCategory @relation(...)
  
  createdAt         DateTime  @default(now())
  
  @@unique([tenantId, posSystem, posCategoryId])
}

model LoyaltyCategory {
  id          String    @id @default(uuid())
  tenantId    String
  name        String    // "–°—É–ø—ã", "–†–æ–ª–ª—ã", etc.
  slug        String    // "soups", "rolls"
  icon        String?
  
  // Relations
  rules       LoyaltyRule[]
  mappings    CategoryMapping[]
  
  @@unique([tenantId, slug])
}

model BallReconciliation {
  id              String    @id @default(uuid())
  guestCardId     String
  guestCard       GuestCard @relation(...)
  
  expectedBalance Int       // Our balance
  actualBalance   Int       // POS balance
  difference      Int       // abs(expected - actual)
  
  status          String    @default("PENDING_REVIEW") // PENDING_REVIEW | AUTO_FIXED | MANUAL_FIXED | IGNORED
  resolvedAt      DateTime?
  resolvedBy      String?   // Admin userId
  resolution      String?   // How it was resolved
  
  createdAt       DateTime  @default(now())
  
  @@index([status, createdAt])
  @@index([guestCardId])
}

// ENUMS
enum POSSystem {
  IIKO_CLOUD
  IIKO_SERVER
  RKEEPER
  POSTER
}
```


***

## **üîß KEY SERVICES (FINAL)**

### **1. POSIntegrationService**

```typescript
@Injectable()
export class POSIntegrationService {
  constructor(
    private prisma: PrismaService,
    private adapterFactory: POSAdapterFactory,
    private guestIdentificationService: GuestIdentificationService,
    private categoryMappingService: CategoryMappingService,
    private currencyService: CurrencyConversionService,
    private loyaltyService: LoyaltyService,
    private queue: Queue,
    private redis: Redis,
  ) {}
  
  async processWebhook(dto: WebhookTransactionDto): Promise<ProcessResult> {
    // 1. Idempotency check (Redis)
    const idempotencyKey = `webhook:${dto.tenantId}:${dto.posSystem}:${dto.posCheckId}`
    const cached = await this.redis.get(idempotencyKey)
    if (cached) {
      return JSON.parse(cached)
    }
    
    // 2. Currency conversion
    const converted = await this.currencyService.convertToBaseCurrency(
      new Decimal(dto.checkAmount),
      dto.currency || 'RUB',
      dto.baseCurrency,
      new Date(dto.timestamp)
    )
    
    // 3. Create POS transaction
    const posTransaction = await this.prisma.posTransaction.create({
      data: {
        tenantId: dto.tenantId,
        posSystem: dto.posSystem,
        posCheckId: dto.posCheckId,
        transactionType: dto.type || 'SALE',
        
        // Original amount
        checkAmount: dto.checkAmount,
        currency: dto.currency || 'RUB',
        
        // Converted amount
        baseCheckAmount: converted.amount.toNumber(),
        baseCurrency: dto.baseCurrency,
        exchangeRate: converted.rate.toNumber(),
        rateSource: converted.source,
        
        guestIdentifier: dto.guestPhone || dto.posGuestId,
        items: dto.items,
        paymentMethods: dto.paymentMethods,
        timestamp: new Date(dto.timestamp),
        rawPayload: dto,
        syncStatus: 'PENDING',
        syncSource: 'WEBHOOK',
      },
    })
    
    // 4. Identify guest
    const guestCard = await this.guestIdentificationService.identify({
      phone: dto.guestPhone,
      posGuestId: dto.posGuestId,
      tenantId: dto.tenantId,
      restaurantId: dto.restaurantId,
      posSystem: dto.posSystem,
    })
    
    if (!guestCard) {
      await this.prisma.posTransaction.update({
        where: { id: posTransaction.id },
        data: { syncStatus: 'GUEST_NOT_IDENTIFIED' },
      })
      
      return { success: false, reason: 'GUEST_NOT_IDENTIFIED' }
    }
    
    // 5. Process loyalty (on BASE currency amount)
    const result = await this.loyaltyService.processTransaction({
      posTransactionId: posTransaction.id,
      guestCardId: guestCard.id,
      checkAmount: converted.amount.toNumber(), // Use converted amount
      items: dto.items,
      posCheckId: dto.posCheckId,
    })
    
    // 6. Update status
    await this.prisma.posTransaction.update({
      where: { id: posTransaction.id },
      data: {
        guestCardId: guestCard.id,
        syncStatus: 'COMPLETED',
        processedAt: new Date(),
      },
    })
    
    // 7. Cache result
    await this.redis.setex(idempotencyKey, 86400, JSON.stringify(result))
    
    return result
  }
}
```


***

## **üìä MONITORING METRICS (FINAL)**

```typescript
// Prometheus metrics
const webhookReceived = new Counter({
  name: 'pos_webhooks_received_total',
  labelNames: ['tenant_id', 'pos_system', 'status', 'currency'],
})

const currencyConversions = new Counter({
  name: 'pos_currency_conversions_total',
  labelNames: ['from_currency', 'to_currency', 'source'],
})

const reconciliationIssues = new Gauge({
  name: 'pos_reconciliation_issues',
  help: 'Number of unresolved balance mismatches',
  labelNames: ['severity'], // auto_fixed | pending_review | critical
})

// Grafana dashboard queries
/*
# Multi-currency transactions breakdown
sum by (currency) (rate(pos_webhooks_received_total[5m]))

# Currency conversion rate
rate(pos_currency_conversions_total[5m])

# Reconciliation issues over time
pos_reconciliation_issues{severity="pending_review"}

# Average exchange rate used
avg(pos_transaction_exchange_rate{currency!="RUB"})
*/
```


***

## **üí∞ COST ESTIMATION (with Multi-Currency)**

### **Single Restaurant (Russia)**

| Metric | Volume | Cost |
| :-- | :-- | :-- |
| Transactions/month | 1,500 | Free (webhooks) |
| Currency | RUB only | No conversion cost |
| **Total** |  | **‚ÇΩ0/month** |

### **International Chain (3 countries)**

| Metric | Volume | Cost |
| :-- | :-- | :-- |
| Transactions/month | 15,000 | Free (webhooks) |
| Currency conversions | 10,000 (non-RUB) | ‚ÇΩ300 (OpenExchange API: \$0.003/request) |
| **Total** |  | **‚ÇΩ300/month** |


***

## **‚úÖ –ò–¢–û–ì–û: POS INTEGRATION –ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í**

### **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**

‚úÖ **Webhook schemas** (iiko Cloud/Server + R-Keeper XML/JSON)
‚úÖ **HMAC authentication** + replay protection
‚úÖ **Idempotency** (Redis + DB constraint)
‚úÖ **Guest identification** (phone priority, auto-create)
‚úÖ **Multi-currency** (6+ currencies, CBR/OpenExchange rates)
‚úÖ **Category mapping** (POS ‚Üí Loyalty, blacklist)
‚úÖ **Error handling** (retry, rate limit, alerting)
‚úÖ **Reconciliation** (auto-fix <100, manual >100)
‚úÖ **Multi-location** (location mapping table)
‚úÖ **Test environment** (separate test DB)
‚úÖ **Forward-only tracking** (no automatic bulk sync)
‚úÖ **Monitoring** (Prometheus, Grafana, Sentry)

### **–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏:**

üîµ **Sandbox mode:** –û—Ç–¥–µ–ª—å–Ω–∞—è test DB (–Ω–µ soft isolation)
üîµ **Split bills:** –û–¥–∏–Ω webhook –Ω–∞ —á–µ–∫ (–Ω–µ multiple webhooks)
üîµ **Initial sync:** Forward-only (no automatic bulk sync)
üîµ **Currency:** Multi-currency —Å Phase 1 (–Ω–µ RUB MVP)

***
