# LOYALTY SYSTEM. –ó–∞–¥–∞–π 20+ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ + —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ —Ç–≤–æ–µ–º—É –ª—É—á—à–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ –¥–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö. –ü–µ—Ä–µ–¥ –∑–∞–¥–∞–≤–∞–Ω–∏–µ–º –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–≤–µ—Ä—å—Å—è —Å —Ñ–∞–π–ª–∞–º–∏, –º–æ–∂–µ—Ç –æ–Ω–∏ —É–∂–µ –±—ã–ª–∏

–ò–¥–µ–∞–ª—å–Ω–æ! –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–∞–π–ª–∞–º–∏:

***

## üéØ **–ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–ï–ù - 23 –í–û–ü–†–û–°–ê + –†–ï–®–ï–ù–ò–Ø**

***

# üéØ **23 –í–û–ü–†–û–°–ê –î–õ–Ø LOYALTY SYSTEM + –ú–û–ò –†–ï–®–ï–ù–ò–Ø**

–Ø –≤—ã–≤–æ–¥—É —Å—é–¥–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã —Å –º–æ–∏–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è.

***

## üìã **–ë–õ–û–ö 1: –í–ï–†–°–ò–û–ù–ò–†–û–í–ê–ù–ò–ï –ò –û–¢–ö–ê–¢ –ü–†–ê–í–ò–õ (10 –≤–æ–ø—Ä–æ—Å–æ–≤)**

### 1Ô∏è‚É£ **–í–ï–†–°–ò–û–ù–ò–†–û–í–ê–ù–ò–ï –ü–†–ê–í–ò–õ**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É—Å—Ç–∞–Ω–æ–≤–∏–ª 5% –±–∞–ª–ª–æ–≤ –¥–ª—è Bronze –Ω–∞ –Ω–∞—á–∞–ª–æ –º–µ—Å—è—Ü–∞. –ù–∞ 15-–π –¥–µ–Ω—å –∏–∑–º–µ–Ω–∏–ª –Ω–∞ 10%. –ö–∞–∫ —Å—á–∏—Ç–∞—é—Ç—Å—è –±–∞–ª–ª—ã –¥–ª—è –≥–æ—Å—Ç–µ–π Bronze –∑–∞ –≤–µ—Å—å –º–µ—Å—è—Ü?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- A) –ü–µ—Ä–µ—Å—á–µ—Ç - –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —á–µ–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å –Ω–æ–≤—ã–º–∏ 10% (–¥–æ—Ä–æ–≥–æ –≤ –ë–î)
- B) –ù–µ—Ç –ø–µ—Ä–µ—Å—á–µ—Ç–∞ - –∫–∞–∂–¥—ã–π —á–µ–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –Ω–∞ –º–æ–º–µ–Ω—Ç —á–µ–∫–∞
- C) –ì–∏–±—Ä–∏–¥–Ω—ã–π - —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –±–∞–ª–ª—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ –Ω–æ–≤–æ–º—É

**‚úÖ –ú–û–ô –í–´–ë–û–†: –í–∞—Ä–∏–∞–Ω—Ç B (–ù–µ—Ç –ø–µ—Ä–µ—Å—á–µ—Ç–∞)**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ (—á–µ—Å—Ç–Ω–æ —Å—á–∏—Ç–∞–µ–º –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –Ω–∞ –º–æ–º–µ–Ω—Ç —á–µ–∫–∞)
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ (–Ω–µ –Ω—É–∂–Ω–∞ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤—Å–µ–π –ë–î)
- ‚úÖ –ß–µ—Å—Ç–Ω–æ –¥–ª—è –≥–æ—Å—Ç–µ–π (–Ω–µ –º–µ–Ω—è—é—Ç—Å—è –∏—Ö –±–∞–ª–ª—ã –∑–∞–¥–Ω–∏–º —á–∏—Å–ª–æ–º)
- ‚úÖ –ü—Ä–æ—Å—Ç–æ–π –æ—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ

**üíª –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:**

```javascript
// BallTransaction —Å–æ–¥–µ—Ä–∂–∏—Ç –°–ù–ò–ú–û–ö –ø—Ä–∞–≤–∏–ª–∞
{
  id: 'uuid-1',
  guest_card_id: 'card-123',
  amount: 100,
  loyalty_rule_version_id: 'version-1', // –°–°–´–õ–ö–ê –Ω–∞ –≤–µ—Ä—Å–∏—é
  rule_snapshot: {  // –ü–û–õ–ù–ê–Ø –ö–û–ü–ò–Ø –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç —á–µ–∫–∞
    type: 'POINTS',
    percentage: 5,
    level: 'BRONZE'
  },
  post_transaction_id: 'pos-123',
  created_at: '2024-01-10T10:00:00Z'
}

// LoyaltyRuleVersion - –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
{
  id: 'version-1',
  loyalty_rule_id: 'rule-bronze',
  version_number: 1,
  rule_snapshot: { percentage: 5 },
  active_from: '2024-01-01',
  active_to: '2024-01-14',
  created_by: 'admin-1'
}

{
  id: 'version-2',
  loyalty_rule_id: 'rule-bronze',
  version_number: 2,
  rule_snapshot: { percentage: 10 },
  active_from: '2024-01-15',
  active_to: null,
  created_by: 'admin-1'
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- 01.01 - 14.01: —á–µ–∫–∏ —Å—á–∏—Ç–∞–Ω—ã —Å 5% (rule_snapshot —Å–æ–¥–µ—Ä–∂–∏—Ç 5)
- 15.01 - 31.01: —á–µ–∫–∏ —Å—á–∏—Ç–∞–Ω—ã —Å 10% (rule_snapshot —Å–æ–¥–µ—Ä–∂–∏—Ç 10)
- –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, –º–æ–∂–Ω–æ –≤–∏–¥–µ—Ç—å —á—Ç–æ –º–µ–Ω—è–ª–æ—Å—å –∫–æ–≥–¥–∞

***

### 2Ô∏è‚É£ **–û–¢–ö–ê–¢ –û–®–ò–ë–û–ß–ù–û–ì–û –ü–†–ê–í–ò–õ–ê**

**‚ùì –í–æ–ø—Ä–æ—Å:**
Admin —É—Å—Ç–∞–Ω–æ–≤–∏–ª –ø—Ä–∞–≤–∏–ª–æ "Bronze +50% –±–∞–ª–ª–æ–≤" —Å–ª—É—á–∞–π–Ω–æ. –ù—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –Ω–∞–∑–∞–¥ –Ω–∞ "+5%". –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –±–∞–ª–ª–∞–º–∏ –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ø–æ–¥–∞—Ä–∏–ª?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- A) –ü—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—É—é
- B) –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Å –∫–æ–ø–∏–µ–π —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é)
- C) –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ –±–∞–ª–ª—ã –Ω–∞–∑–∞–¥?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –í–∞—Ä–∏–∞–Ω—Ç B (–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å –∫–æ–ø–∏–µ–π)**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è (audit trail)
- ‚úÖ –ë–∞–ª–ª—ã —Å—á–∏—Ç–∞–≤—à–∏–µ—Å—è –ø–æ –Ω–æ–≤–æ–º—É –ø—Ä–∞–≤–∏–ª—É –ù–ï –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è (–æ–Ω–∏ –æ—Å—Ç–∞—é—Ç—Å—è)
- ‚úÖ –ù–æ–≤—ã–µ –±–∞–ª–ª—ã –±—É–¥—É—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –ø–æ —Å—Ç–∞—Ä–æ–º—É –ø—Ä–∞–≤–∏–ª—É
- ‚úÖ –ß–µ—Å—Ç–Ω–æ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ

**üíª –ê–ª–≥–æ—Ä–∏—Ç–º –æ—Ç–∫–∞—Ç–æ–≤:**

```javascript
// –°—Ü–µ–Ω–∞—Ä–∏–π:
// version-1: 5% (01.01 - 14.01)
// version-2: 50% (15.01 - 16.01) - –û–®–ò–ë–ö–ê
// Admin –Ω–∞–∂–∏–º–∞–µ—Ç "–û—Ç–∫–∞—Ç–∏—Ç—å –Ω–∞ –≤–µ—Ä—Å–∏—é 1"

async function rollbackLoyaltyRule(ruleId, targetVersion) {
  // 1. –ù–∞—Ö–æ–¥–∏–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é
  const oldVersion = await db.LoyaltyRuleVersion.findById(targetVersion);
  
  // 2. –ö–æ–ø–∏—Ä—É–µ–º –µ—ë –∫–æ–Ω—Ñ–∏–≥
  const rollbackConfig = oldVersion.rule_snapshot;
  
  // 3. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é (–≤–µ—Ä—Å–∏—è 3)
  const newVersion = await db.LoyaltyRuleVersion.create({
    loyalty_rule_id: ruleId,
    version_number: 3,
    rule_snapshot: rollbackConfig, // –∫–æ–ø–∏—è –≤–µ—Ä—Å–∏–∏ 1
    active_from: new Date(),
    created_by: 'admin-1',
    reason: 'ROLLBACK_FROM_VERSION_2'
  });
  
  // 4. –õ–æ–≥–∏—Ä—É–µ–º
  await db.ActivityLog.create({
    action: 'RULE_ROLLBACK',
    details: {
      from_version: 2,
      to_version: 1,
      new_version: 3
    }
  });
  
  return newVersion;
}

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
// version-1: 5% (01.01 - 14.01)
// version-2: 50% (15.01 - 16.01) - –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
// version-3: 5% (17.01 - ...) - –Ω–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è

// –ë–∞–ª–ª—ã –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –ø–æ version-2 –û–°–¢–ê–Æ–¢–°–Ø (–Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è)
// –ù–æ–≤—ã–µ –±–∞–ª–ª—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ version-3 (–∫–æ—Ç–æ—Ä–∞—è = version-1)
```


***

### 3Ô∏è‚É£ **–ü–ï–†–ï–°–ß–ï–¢ –ë–ê–õ–õ–û–í –í–†–£–ß–ù–£–Æ (–¢–û–õ–¨–ö–û –î–õ–Ø EMERGENCY)**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ë—ã–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä —Å—á–∏—Ç–∞–ª–∏—Å—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –±–∞–ª–ª—ã). –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ –±–∞–ª–ª—ã –∑–∞ –ø–µ—Ä–∏–æ–¥. –ö–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- A) Background job (–±–µ–∑–æ–ø–∞—Å–Ω–æ, –¥–æ–ª–≥–æ, –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å)
- B) –ü—Ä—è–º–æ –≤ Admin –ø–∞–Ω–µ–ª–∏ (–±—ã—Å—Ç—Ä–æ –Ω–æ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω–æ)
- C) –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –≤–æ–æ–±—â–µ

**‚úÖ –ú–û–ô –í–´–ë–û–†: –í–∞—Ä–∏–∞–Ω—Ç A (Background job)**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ (–º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å)
- ‚úÖ –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI
- ‚úÖ –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫
- ‚úÖ –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Admin –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏

**üíª –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞:**

```javascript
// Admin –Ω–∞–∂–∏–º–∞–µ—Ç: "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–ª—ã"
{
  recalculation_id: 'uuid',
  period_from: '2024-01-01',
  period_to: '2024-01-31',
  loyalty_level: 'BRONZE', // –∏–ª–∏ null = –≤—Å–µ —É—Ä–æ–≤–Ω–∏
  restaurant_id: 'rest-1', // –∏–ª–∏ null = –≤—Å–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã
  recalculation_type: 'RECALCULATE', // –∏–ª–∏ 'ADJUST', 'NOTIFY_ONLY'
  status: 'PENDING', // PENDING ‚Üí IN_PROGRESS ‚Üí COMPLETED/FAILED
  started_at: null,
  completed_at: null,
  guests_affected: null,
  balls_adjusted: null
}

// NOTIFY_ONLY —Ä–µ–∂–∏–º:
// - –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
// - –ù–æ –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ–º
// - Admin –≤–∏–¥–∏—Ç: "5000 –≥–æ—Å—Ç–µ–π –ø–æ–ª—É—á–∞—Ç +50 –±–∞–ª–ª–æ–≤ –≤ —Å—Ä–µ–¥–Ω–µ–º"

// RECALCULATE —Ä–µ–∂–∏–º:
// - –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –±–∞–ª–ª—ã –∑–∞ –ø–µ—Ä–∏–æ–¥
// - –î–æ–±–∞–≤–ª—è–µ–º BallAdjustment –∑–∞–ø–∏—Å–∏
// - –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –≤ ActivityLog

// ADJUST —Ä–µ–∂–∏–º:
// - –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É (–Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º, –∞ –¥–æ–±–∞–≤–ª—è–µ–º)
// - –ú–µ–Ω–µ–µ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
```


***

### 4Ô∏è‚É£ **–í–ï–†–°–ò–û–ù–ò–†–û–í–ê–ù–ò–ï –ü–†–û–ú–û-–ê–ö–¶–ò–ô**

**‚ùì –í–æ–ø—Ä–æ—Å:**
Admin —Å–æ–∑–¥–∞–ª –ø—Ä–æ–º–æ "–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è +1000 –±–∞–ª–ª–æ–≤, 7 –¥–Ω–µ–π". –ü–æ–∑–∂–µ –ø–æ–Ω—è–ª —á—Ç–æ –Ω—É–∂–Ω–æ "+500 –±–∞–ª–ª–æ–≤". –ß—Ç–æ —Å –≥–æ—Å—Ç—è–º–∏ –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ +1000?

**‚úÖ –ú–û–ô –í–´–ë–û–†:**

- –°—Ç–∞—Ä—ã–µ –±–∞–ª–ª—ã –û–°–¢–ê–Æ–¢–°–Ø (+1000 –¥–ª—è —Ç–µ—Ö –∫—Ç–æ –ø–æ–ª—É—á–∏–ª)
- –ù–æ–≤—ã–µ –≥–æ—Å—Ç–∏ –ü–û–õ–£–ß–ê–¢ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (+500)
- –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è

***

### 5Ô∏è‚É£ **–ó–ê–ü–†–ï–¢ –ù–ê –°–û–ó–î–ê–ù–ò–ï –ö–û–ù–§–õ–ò–ö–¢–£–Æ–©–ò–• –í–ï–†–°–ò–ô**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ú–æ–∂–µ—Ç –ª–∏ –±—ã—Ç—å –¥–≤–µ –ê–ö–¢–ò–í–ù–´–ï –≤–µ—Ä—Å–∏–∏ –ø—Ä–∞–≤–∏–ª–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ? (–ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤)

**‚úÖ –ú–û–ô –í–´–ë–û–†: –ù–ï–¢, –∑–∞–ø—Ä–µ—Ç–∏—Ç—å!**

```javascript
// CONSTRAINT –≤ –ë–î:
CREATE UNIQUE INDEX idx_loyalty_rule_active_period ON loyalty_rule_versions(
  loyalty_rule_id, 
  active_from 
) 
WHERE active_to IS NULL; // —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ "—Ç–µ–∫—É—â–∞—è" –≤–µ—Ä—Å–∏—è

// –õ–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –µ—Å—Ç—å –≤–µ—Ä—Å–∏—è 1 (active_from=01.01, active_to=NULL)
// –¢–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–µ—Ä—Å–∏–∏ 2 –ù–£–ñ–ù–û —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å active_to=–≤–µ—Ä—Å–∏–∏1=—Ç–µ–∫—É—â–∞—è_–¥–∞—Ç–∞
```


***

### 6Ô∏è‚É£ **–°–ù–ò–ú–û–ö –ü–†–ê–í–ò–õ–ê –í –ö–ê–ñ–î–û–ô –ü–†–û–ú–û-–ê–ö–¶–ò–ò**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ï—Å–ª–∏ –∞–¥–º–∏–Ω –º–µ–Ω—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞, –ø—Ä–æ–º–æ-–∞–∫—Ü–∏–∏ —Ç–æ–∂–µ –º–µ–Ω—è—é—Ç—Å—è –∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Å—Ç–∞—Ä—ã–µ?

**‚úÖ –ú–û–ô –í–´–ë–û–†:**

- PromoBallGranted —Ç–∞–±–ª–∏—Ü–∞ —Ö—Ä–∞–Ω–∏—Ç –°–ù–ò–ú–û–ö –ø—Ä–∞–≤–∏–ª–∞
- –ï—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å - –ø—Ä–æ–º–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ —Å–Ω–∏–º–∫—É
- –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

```javascript
{
  id: 'promo-grant-1',
  guest_card_id: 'card-1',
  promo_id: 'birthday-promo-1',
  amount: 1000,
  loyalty_rule_version_id: 'version-1', // —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–µ—Ä—Å–∏—é –ø—Ä–∞–≤–∏–ª–∞
  rule_snapshot: {
    type: 'BIRTHDAY_PROMO',
    base_amount: 1000,
    expiration_days: 7
  },
  created_at: '2024-01-15'
}
```


***

### 7Ô∏è‚É£ **–í–ï–†–°–ò–û–ù–ò–†–û–í–ê–ù–ò–ï –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò –£–†–û–í–ù–ï–ô**

**‚ùì –í–æ–ø—Ä–æ—Å:**
Admin –º–µ–Ω—è–µ—Ç –ø–æ—Ä–æ–≥–∏ —É—Ä–æ–≤–Ω–µ–π: Bronze 0-50k ‚Üí 0-100k. –ì–æ—Å—Ç–∏ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –≤ –¥—Ä—É–≥–∏–µ —É—Ä–æ–≤–Ω–∏?

**‚úÖ –ú–û–ô –í–´–ë–û–†:**

- –ù–æ–≤—ã–µ –ø–æ—Ä–æ–≥–∏ –¥–µ–π—Å—Ç–≤—É—é—Ç –ø—Ä–∏ –°–õ–ï–î–£–Æ–©–ï–ú –ø–µ—Ä–µ—Å—á–µ—Ç–µ (–≤ 00:00)
- –°—Ç–∞—Ä—ã–µ –ø–æ—Ä–æ–≥–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
- –ü–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

***

### 8Ô∏è‚É£ **–û–¢–ö–ê–¢ –ö –û–ü–†–ï–î–ï–õ–ï–ù–ù–û–ô –í–ï–†–°–ò–ò –£–†–û–í–ù–ï–ô**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ê–¥–º–∏–Ω —Å–ª—É—á–∞–π–Ω–æ –∏–∑–º–µ–Ω–∏–ª –ø–æ—Ä–æ–≥–∏, –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∫ –≤–µ—Ä—Å–∏–∏ –æ—Ç –Ω–µ–¥–µ–ª—é –Ω–∞–∑–∞–¥?

**‚úÖ –ú–û–ô –í–´–ë–û–†:**

- LoyaltyLevelVersion —Ç–∞–±–ª–∏—Ü–∞ —Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é
- Admin –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—É—é –≤–µ—Ä—Å–∏—é
- –ù–æ–≤—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º–∏ –ø–æ—Ä–æ–≥–∞–º–∏

***

### 9Ô∏è‚É£ **–í–ï–†–°–ò–û–ù–ò–†–û–í–ê–ù–ò–ï –ü–ï–†–ï–ü–†–û–¶–ï–ù–¢–û–í–û–ö**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ü—Ä–∞–≤–∏–ª–æ: "–î–Ω–∏ 11-15 - extra +50%". –ï—Å–ª–∏ admin –∏–∑–º–µ–Ω–∏—Ç –Ω–∞ "–î–Ω–∏ 10-20 - extra +30%", –∫–∞–∫ —Å—á–∏—Ç–∞—é—Ç—Å—è –±–∞–ª–ª—ã?

**‚úÖ –ú–û–ô –í–´–ë–û–†:**

- –ö–∞–∂–¥—ã–π BallTransaction —Ö—Ä–∞–Ω–∏—Ç –ø–æ–ª–Ω—ã–π rule_snapshot
- –î–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–æ –º–µ–Ω—è–µ—Ç—Å—è - –±–∞–ª–ª—ã —Å—á–∏—Ç–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª–Ω–∞—è

***

### üîü **–ó–ê–ü–†–û–° –ò–°–¢–û–†–ò–ò –í–ï–†–°–ò–ô**

**‚ùì –í–æ–ø—Ä–æ—Å:**
Admin —Ö–æ—á–µ—Ç –≤–∏–¥–µ—Ç—å: "–ö–∞–∫–∏–µ –≤–µ—Ä—Å–∏–∏ –ø—Ä–∞–≤–∏–ª–∞ –±—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã –≤ –ø–µ—Ä–∏–æ–¥–µ 01.01-31.01?"

**‚úÖ –ú–û–ô –í–´–ë–û–†:**

- API endpoint: GET /loyalty-rules/{id}/versions?from=2024-01-01\&to=2024-01-31
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –≤–µ—Ä—Å–∏–∏ –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã –≤ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥

***

## üîÑ **–ë–õ–û–ö 2: –ú–ò–ì–†–ê–¶–ò–Ø –ú–ï–ñ–î–£ –¢–ò–ü–ê–ú–ò –°–ò–°–¢–ï–ú (2 –≤–æ–ø—Ä–æ—Å–∞)**

### 1Ô∏è‚É£1Ô∏è‚É£ **–ú–ò–ì–†–ê–¶–ò–Ø UNIFIED ‚Üí SEPARATE**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–†–µ—Å—Ç–æ—Ä–∞–Ω —Ä–∞–±–æ—Ç–∞–ª —Å UNIFIED (–æ–¥–Ω–∞ –∫–∞—Ä—Ç–∞ –Ω–∞ –≤—Å—é —Å–µ—Ç—å –∏–∑ 3 —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤). –†–µ—à–∏–ª –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ SEPARATE (–æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–∞—Ä—Ç—ã). –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- A) –ì–æ—Å—Ç—å –≤–∏–¥–∏—Ç TWO –∫–∞—Ä—Ç—ã (—Å—Ç–∞—Ä—É—é UNIFIED + –Ω–æ–≤—É—é SEPARATE)
- B) –ö–∞—Ä—Ç–∞ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω (–≥–æ—Å—Ç—å –≤–∏–¥–∏—Ç 3 –∫–∞—Ä—Ç—ã)
- C) –ë–∞–ª–ª—ã –¥–µ–ª—è—Ç—Å—è –ø–æ—Ä–æ–≤–Ω—É –º–µ–∂–¥—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º–∏
- D) –ì–æ—Å—Ç—å –≤—ã–±–∏—Ä–∞–µ—Ç –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –±–∞–ª–ª—ã

**‚úÖ –ú–û–ô –í–´–ë–û–†: –í–∞—Ä–∏–∞–Ω—Ç B (–ö–∞—Ä—Ç–∞ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω)**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ –ì–æ—Å—Ç—å –≤–∏–¥–∏—Ç –≤—Å–µ —Å–≤–æ–∏ –±–∞–ª–ª—ã –≤–µ–∑–¥–µ (–æ–Ω –∏—Ö –Ω–∞–∫–æ–ø–∏–ª!)
- ‚úÖ –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ (–Ω–µ —Ç–µ—Ä—è–µ—Ç –±–∞–ª–ª—ã)
- ‚úÖ –ú–æ–∂–Ω–æ –ª–µ–≥–∫–æ –æ—Ç–∫–∞—Ç–∏—Ç—å (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å UNIFIED)
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –∫–∞—Ä—Ç–∞–º–∏ –≤ Telegram

**üíª –ê–ª–≥–æ—Ä–∏—Ç–º –º–∏–≥—Ä–∞—Ü–∏–∏:**

```javascript
async function migrateUnifiedToSeparate(loyaltySystemId) {
  // 1. –°–æ–∑–¥–∞–µ–º Migration –∑–∞–ø–∏—Å—å
  const migration = await db.LoyaltyMigration.create({
    loyalty_system_id: loyaltySystemId,
    migration_type: 'UNIFIED_TO_SEPARATE',
    migration_status: 'IN_PROGRESS',
    started_at: new Date()
  });
  
  // 2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Å—Ç—è –≤ UNIFIED —Å–∏—Å—Ç–µ–º–µ
  const guests = await db.GuestCard.findAll({
    where: { loyalty_system_id: loyaltySystemId }
  });
  
  for (const oldCard of guests) {
    // 3. –ö–æ–ø–∏—Ä—É–µ–º –≤ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω
    for (const restaurant of loyaltySystem.restaurants) {
      const newCard = await db.GuestCard.create({
        user_id: oldCard.user_id,
        tenant_id: oldCard.tenant_id,
        restaurant_id: restaurant.id, // DIFFERENCE: —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å restaurant_id
        balance: oldCard.balance, // –ö–û–ü–ò–†–£–ï–ú –±–∞–ª–ª—ã!
        loyalty_level_id: oldCard.loyalty_level_id, // –ö–û–ü–ò–†–£–ï–ú —É—Ä–æ–≤–µ–Ω—å
        qrcode: generateNewQR(),
        code6digit: generateNew6Digit(),
        status: 'ACTIVE',
        registration_source: 'MIGRATION',
        migration_id: migration.id
      });
      
      // 4. –ö–æ–ø–∏—Ä—É–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –±–∞–ª–ª–æ–≤
      const transactions = await db.BallTransaction.findAll({
        where: { guest_card_id: oldCard.id }
      });
      
      for (const tx of transactions) {
        await db.BallTransaction.create({
          ...tx,
          guest_card_id: newCard.id,
          migration_id: migration.id
        });
      }
    }
  }
  
  // 5. –û–±–Ω–æ–≤–ª—è–µ–º LoyaltySystem
  await db.LoyaltySystem.update(
    { id: loyaltySystemId },
    { 
      system_type: 'SEPARATE',
      migrated_at: new Date(),
      migration_id: migration.id
    }
  );
  
  // 6. –ó–∞–≤–µ—Ä—à–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é
  await migration.update({
    migration_status: 'COMPLETED',
    completed_at: new Date(),
    guests_affected: guests.length,
    balls_migrated: guests.reduce((sum, g) => sum + g.balance, 0)
  });
  
  // 7. –õ–æ–≥–∏—Ä—É–µ–º
  await db.ActivityLog.create({
    action: 'SYSTEM_MIGRATION',
    entity_type: 'LOYALTY_SYSTEM',
    details: {
      from: 'UNIFIED',
      to: 'SEPARATE',
      guests_migrated: guests.length
    }
  });
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- –ì–æ—Å—Ç —Å 2000 –±–∞–ª–ª–æ–≤ ‚Üí –≤–∏–¥–∏—Ç 3 –∫–∞—Ä—Ç—ã –ø–æ 2000 –±–∞–ª–ª–æ–≤ (UNIFIED + Restaurant1 + Restaurant2)
- –í—Å–µ –∫–∞—Ä—Ç—ã –∏–º–µ—é—Ç –Ω–æ–≤—ã–µ QR –∫–æ–¥—ã
- Telegram –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ 4 –∫–∞—Ä—Ç—ã –¥–ª—è –≤—ã–±–æ—Ä–∞
- –°—Ç–∞—Ä–∞—è UNIFIED –∫–∞—Ä—Ç–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ MIGRATED

**–û—Ç–∫–∞—Ç:**

```javascript
// –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
async function rollbackMigration(migrationId) {
  // 1. –£–¥–∞–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç—ã
  await db.GuestCard.deleteMany({
    where: { migration_id: migrationId }
  });
  
  // 2. –£–¥–∞–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  await db.BallTransaction.deleteMany({
    where: { migration_id: migrationId }
  });
  
  // 3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏—Å—Ç–µ–º—É –Ω–∞ UNIFIED
  // 4. –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–∫–∞—Ç
}
```


***

### 1Ô∏è‚É£2Ô∏è‚É£ **–ú–ò–ì–†–ê–¶–ò–Ø SEPARATE ‚Üí UNIFIED**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–†–µ—Å—Ç–æ—Ä–∞–Ω —Ä–∞–±–æ—Ç–∞–ª —Å 3 SEPARATE –∫–∞—Ä—Ç–∞–º–∏. –†–µ—à–∏–ª –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤ –æ–¥–Ω—É UNIFIED. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –±–∞–ª–ª–∞–º–∏?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- A) –ë–∞–ª–ª—ã –°–£–ú–ú–ò–†–£–Æ–¢–°–Ø (3x2000 = 6000)
- B) –ë–µ—Ä—É—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
- C) –ë–∞–ª–ª—ã –¥–µ–ª—è—Ç—Å—è –ø–æ—Ä–æ–≤–Ω—É
- D) –ì–æ—Å—Ç –≤—ã–±–∏—Ä–∞–µ—Ç

**‚úÖ –ú–û–ô –í–´–ë–û–†: –í–∞—Ä–∏–∞–Ω—Ç A (–ë–∞–ª–ª—ã –°–£–ú–ú–ò–†–£–Æ–¢–°–Ø)**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ (–≥–æ—Å—Ç –Ω–∞–∫–æ–ø–∏–ª –±–∞–ª–ª—ã –≤–µ–∑–¥–µ!)
- ‚úÖ –ß–µ—Å—Ç–Ω–æ (–ø–æ—á–µ–º—É —Ç–µ—Ä—è—Ç—å –µ–≥–æ –±–∞–ª–ª—ã?)
- ‚úÖ –§–∏–Ω–∞–Ω—Å–æ–≤–æ –≤—ã–≥–æ–¥–Ω–æ (–≥–æ—Å—Ç —Å—á–∞—Å—Ç–ª–∏–≤–µ–µ, –ø–æ—Ç—Ä–∞—Ç–∏—Ç –±–æ–ª—å—à–µ)
- ‚úÖ –£—Ä–æ–≤–µ–Ω—å = –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–∑ –≤—Å–µ—Ö

**üíª –ê–ª–≥–æ—Ä–∏—Ç–º:**

```javascript
async function migrateSeparateToUnified(loyaltySystemId) {
  const migration = await db.LoyaltyMigration.create({
    loyalty_system_id: loyaltySystemId,
    migration_type: 'SEPARATE_TO_UNIFIED',
    migration_status: 'IN_PROGRESS'
  });
  
  // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ SEPARATE –∫–∞—Ä—Ç—ã –∫–∞–∂–¥–æ–≥–æ –≥–æ—Å—Ç—è
  const unifiedGuests = await db.GuestCard.findAll({
    where: { loyalty_system_id: loyaltySystemId },
    include: ['user']
  });
  
  const guestsByUser = {};
  for (const card of unifiedGuests) {
    if (!guestsByUser[card.user_id]) {
      guestsByUser[card.user_id] = [];
    }
    guestsByUser[card.user_id].push(card);
  }
  
  // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Å—Ç—è
  for (const [userId, cards] of Object.entries(guestsByUser)) {
    // –°–£–ú–ú–ò–†–£–ï–ú –±–∞–ª–ª—ã
    const totalBalance = cards.reduce((sum, c) => sum + c.balance, 0);
    
    // –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô —É—Ä–æ–≤–µ–Ω—å
    const maxLevel = cards.reduce((max, c) => {
      const currentLevelValue = c.loyalty_level?.rank || 0;
      const maxValue = max?.rank || 0;
      return currentLevelValue > maxValue ? c.loyalty_level : max;
    }, null);
    
    // –°–æ–∑–¥–∞–µ–º UNIFIED –∫–∞—Ä—Ç—É
    const unifiedCard = await db.GuestCard.create({
      user_id: userId,
      tenant_id: cards[^4_0].tenant_id,
      restaurant_id: null, // NULL = UNIFIED
      balance: totalBalance,
      loyalty_level_id: maxLevel?.id,
      qrcode: generateNewQR(),
      code6digit: generateNew6Digit(),
      status: 'ACTIVE',
      migration_id: migration.id
    });
    
    // –ö–æ–ø–∏—Ä—É–µ–º –í–°–ï —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ –≤—Å–µ—Ö –∫–∞—Ä—Ç
    for (const oldCard of cards) {
      const transactions = await db.BallTransaction.findAll({
        where: { guest_card_id: oldCard.id }
      });
      
      for (const tx of transactions) {
        await db.BallTransaction.create({
          ...tx,
          guest_card_id: unifiedCard.id
        });
      }
      
      // –ü–æ–º–µ—á–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç—É –∫–∞–∫ MIGRATED
      await oldCard.update({
        status: 'MIGRATED',
        migrated_to_card_id: unifiedCard.id
      });
    }
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É
  await db.LoyaltySystem.update(
    { id: loyaltySystemId },
    { system_type: 'UNIFIED' }
  );
}

// –†–ï–ó–£–õ–¨–¢–ê–¢:
// Restaurant 1 –∫–∞—Ä—Ç–∞: 2000 –±–∞–ª–ª–æ–≤, Bronze ‚Üí MIGRATED
// Restaurant 2 –∫–∞—Ä—Ç–∞: 1500 –±–∞–ª–ª–æ–≤, Silver ‚Üí MIGRATED
// Restaurant 3 –∫–∞—Ä—Ç–∞: 3000 –±–∞–ª–ª–æ–≤, Gold ‚Üí MIGRATED
// UNIFIED –∫–∞—Ä—Ç–∞: 6500 –±–∞–ª–ª–æ–≤, Gold (–º–∞–∫—Å–∏–º—É–º!)
```


***

## ‚öîÔ∏è **–ë–õ–û–ö 3: –ö–û–ù–§–õ–ò–ö–¢–´ –ü–†–û–ú–û-–ê–ö–¶–ò–ô (3 –≤–æ–ø—Ä–æ—Å–∞)**

### 1Ô∏è‚É£3Ô∏è‚É£ **–î–í–ï –ü–†–û–ú–û –°–†–ê–ë–ê–¢–´–í–ê–Æ–¢ –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ì–æ—Å—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç 15 —è–Ω–≤–∞—Ä—è (–µ–≥–æ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è) AND —Ä–µ—Å—Ç–æ—Ä–∞–Ω –ø—Ä–æ–≤–æ–¥–∏—Ç "–°—Ä–µ–¥–∞ - +500 –±–∞–ª–ª–æ–≤" AND —ç—Ç–æ –µ–≥–æ –ø–µ—Ä–≤—ã–π —á–µ–∫ (–ø–µ—Ä–≤–∞—è –ø—Ä–æ–º–æ +1000). –°—Ä–∞–±–æ—Ç–∞—é—Ç –í–°–ï –¢–†–ò?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- A) –í—Å–µ —Ç—Ä–∏ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è (1000+500+1000=2500)
- B) –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç - —Ç–æ–ª—å–∫–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è (1000)
- C) –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ Admin
- D) –ì–æ—Å—Ç –≤—ã–±–∏—Ä–∞–µ—Ç

**‚úÖ –ú–û–ô –í–´–ë–û–†: –í–∞—Ä–∏–∞–Ω—Ç C (Admin –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç)**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
- ‚úÖ –ú–æ–∂–Ω–æ –ø—Ä–æ–±–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- ‚úÖ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**üíª –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤:**

```javascript
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ LoyaltySystem
{
  id: 'loyalty-sys-1',
  conflict_resolution_strategy: 'COMBINE_ALL', // –∏–ª–∏ MAX_ONLY, FIRST_ONLY
  
  // –ü—Ä–∞–≤–∏–ª–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (–∫–∞—Å—Ç–æ–º–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã –ø—Ä–æ–º–æ)
  conflictRules: [
    {
      promo_id_1: 'birthday-promo',
      promo_id_2: 'wednesday-promo',
      resolution: 'COMBINE_ALL' // —ç—Ç–∏ –¥–≤–∞ —Å–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è
    },
    {
      promo_id_1: 'first-check-promo',
      promo_id_2: 'birthday-promo',
      resolution: 'MAX_ONLY' // –±–µ—Ä–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é
    }
  ]
}

// ENUM ConflictResolutionStrategy:
// - COMBINE_ALL: —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –ø—Ä–æ–º–æ (1000+500+1000=2500)
// - MAX_ONLY: –±–µ—Ä–µ—Ç—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è (MAX(1000,500,1000)=1000)
// - FIRST_ONLY: —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–∞—è –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (–µ—Å–ª–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç birthday=100, wednesday=50, first=80 ‚Üí birthday=1000)
// - RANDOM_CHOICE: —Å–ª—É—á–∞–π–Ω–∞—è –æ–¥–Ω–∞

// –ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –±–∞–ª–ª–æ–≤:
async function calculateBallsWithPromos(guest, checkAmount) {
  // 1. –ë–∞–∑–æ–≤—ã–µ –±–∞–ª–ª—ã
  let baseAmount = calculateBasePoints(guest, checkAmount);
  
  // 2. –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–æ
  const activePromos = await findActivePromos(guest, checkAmount);
  // –†–µ–∑—É–ª—å—Ç–∞—Ç: [birthday, wednesday, firstCheck]
  
  // 3. –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
  const strategy = loyaltySystem.conflict_resolution_strategy;
  let promoBallAmount = 0;
  
  if (strategy === 'COMBINE_ALL') {
    promoBallAmount = activePromos.reduce((sum, p) => sum + p.amount, 0);
    // 1000 + 500 + 1000 = 2500
  } else if (strategy === 'MAX_ONLY') {
    promoBallAmount = Math.max(...activePromos.map(p => p.amount));
    // MAX(1000, 500, 1000) = 1000
  } else if (strategy === 'FIRST_ONLY') {
    const sorted = activePromos.sort((a, b) => b.priority - a.priority);
    promoBallAmount = sorted[^4_0].amount;
    // birthday priority 100 ‚Üí 1000
  }
  
  // 4. –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç
  await db.PromoBallGranted.create({
    guest_card_id: guest.id,
    activePromoIds: activePromos.map(p => p.id),
    conflictResolutionStrategy: strategy,
    ballsPerPromo: activePromos.map(p => ({ id: p.id, amount: p.amount })),
    finalAmount: promoBallAmount,
    conflictingPromoIds: activePromos.length > 1 ? activePromos.map(p => p.id) : []
  });
  
  return baseAmount + promoBallAmount;
}
```


***

### 1Ô∏è‚É£4Ô∏è‚É£ **–ü–†–ò–û–†–ò–¢–ï–¢ –ü–†–û–ú–û-–ê–ö–¶–ò–ô**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–º–æ —Å—Ä–∞–±–æ—Ç–∞–ª–∏, –≤ –∫–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ –∏—Ö –ø—Ä–∏–º–µ–Ω—è—Ç—å?

**‚úÖ –ú–û–ô –í–´–ë–û–†:**

- Admin –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã (0-1000, –±–æ–ª—å—à–µ = –≤—ã—à–µ)
- –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:
    - Birthday: 1000 (—Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è)
    - FirstCheck: 800
    - Inactivity: 600
    - Weekday/Time based: 400
    - Custom: 500

```javascript
// LoyaltyPromo —Ç–∞–±–ª–∏—Ü–∞
{
  id: 'promo-1',
  name: 'Birthday Promo',
  amount: 1000,
  priority: 1000, // ADMIN –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å
  conflict_strategy_override: null // –µ—Å–ª–∏ null —Ç–æ –±–µ—Ä–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—É—é
}

// API –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
PUT /api/loyalty-promos/{id}
{
  priority: 1000 ‚Üí 100 // —É–º–µ–Ω—å—à–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
}
```


***

### 1Ô∏è‚É£5Ô∏è‚É£ **–õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ö–û–ù–§–õ–ò–ö–¢–û–í**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ê–¥–º–∏–Ω —Ö–æ—á–µ—Ç –≤–∏–¥–µ—Ç—å: "–°–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –±—ã–ª–æ –∏ –∫–∞–∫ –æ–Ω–∏ —Ä–∞–∑—Ä–µ—à–∞–ª–∏—Å—å?"

**‚úÖ –ú–û–ô –í–´–ë–û–†:**

- PromoBallGranted —Ç–∞–±–ª–∏—Ü–∞ –ª–æ–≥–∏—Ä—É–µ—Ç –í–°–ï –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
- Analytics –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

```javascript
// PromoBallGranted —Ç–∞–±–ª–∏—Ü–∞
{
  id: 'grant-1',
  guest_card_id: 'card-1',
  post_transaction_id: 'pos-123', // –∏–∑ –∫–∞–∫–æ–≥–æ —á–µ–∫–∞
  active_promos: ['birthday', 'wednesday', 'first-check'], // –∫–∞–∫–∏–µ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–ª–∏
  conflict_count: 3, // —Å–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö –ø—Ä–æ–º–æ
  resolution_strategy: 'COMBINE_ALL',
  amounts_per_promo: {
    birthday: 1000,
    wednesday: 500,
    first_check: 1000
  },
  final_amount: 2500, // –∏—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ –±–∞–ª–ª–æ–≤
  created_at: '2024-01-15T10:00:00Z'
}

// Analytics Report
GET /api/analytics/promo-conflicts?period=month
{
  total_grants: 15000,
  conflicts_count: 2500, // 16.7% —á–µ–∫–æ–≤ –∏–º–µ–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
  resolution_breakdown: {
    COMBINE_ALL: 1500,
    MAX_ONLY: 800,
    FIRST_ONLY: 200
  },
  average_promo_per_transaction: 1.2 // –≤ —Å—Ä–µ–¥–Ω–µ–º 1.2 –ø—Ä–æ–º–æ –Ω–∞ —á–µ–∫
}
```


***

## üí• **–ë–õ–û–ö 4: –°–ì–û–†–ê–ù–ò–ï –ë–ê–õ–õ–û–í –ò –£–†–û–í–ù–ò (4 –≤–æ–ø—Ä–æ—Å–∞)**

### 1Ô∏è‚É£6Ô∏è‚É£ **–†–ê–ó–ù–´–ï –°–†–û–ö–ò –°–ì–û–†–ê–ù–ò–Ø –ë–ê–õ–õ–û–í**

**‚ùì –í–æ–ø—Ä–æ—Å:**

- –ë–∞–ª–ª—ã –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ —á–µ–∫–∞: 90 –¥–Ω–µ–π
- –ë–∞–ª–ª—ã –æ—Ç –ø—Ä–æ–º–æ (–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è): 7 –¥–Ω–µ–π
- –ë–∞–ª–ª—ã –ø–æ–¥–∞—Ä–æ–∫: 180 –¥–Ω–µ–π

–ö–∞–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —á—Ç–æ —Å–≥–æ—Ä–∞–µ—Ç?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- A) –ö–∞–∂–¥—ã–π BallTransaction —Å–æ–¥–µ—Ä–∂–∏—Ç expiration_date
- B) FIFO –ø–æ—Ä—è–¥–æ–∫ (–ø–µ—Ä–≤—ã–µ –ø—Ä–∏—à–µ–¥—à–∏–µ - –ø–µ—Ä–≤—ã–µ —É—Ö–æ–¥—è—Ç)
- C) –û—Ç–¥–µ–ª—å–Ω—ã–µ ¬´–ø–æ–¥–∫–æ—à–µ–ª—å–∫–∏¬ª –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞

**‚úÖ –ú–û–ô –í–´–ë–û–†: –í–∞—Ä–∏–∞–Ω—Ç A + B (–ì–∏–±—Ä–∏–¥–Ω—ã–π)**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ –ö–∞–∂–¥—ã–π –ø–∞–∫–µ—Ç –±–∞–ª–ª–æ–≤ –∏–º–µ–µ—Ç —Å–≤–æ—é –¥–∞—Ç—É —Å–≥–æ—Ä–∞–Ω–∏—è (—á–µ—Å—Ç–Ω–æ)
- ‚úÖ FIFO –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –ø–µ—Ä–≤—ã–µ —É—Ö–æ–¥—è—Ç (—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ)
- ‚úÖ –ú–æ–∂–Ω–æ –≤–∏–¥–µ—Ç—å —Å—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞–∫–µ—Ç–∞

**üíª –°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```javascript
// BallTransaction —Ç–∞–±–ª–∏—Ü–∞
{
  id: 'tx-1',
  guest_card_id: 'card-1',
  type: 'EARN', // –∏–ª–∏ REDEEM, PROMO_ADD, GIFT_ADD, CANCEL
  amount: 100,
  source_type: 'REGULAR_CHECK', // –∏–ª–∏ BIRTHDAY_PROMO, GIFT
  expires_at: '2024-04-10', // —Å–≥–æ—Ä–∞–µ—Ç –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å (90 –¥–Ω–µ–π –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è)
  created_at: '2024-01-10',
  status: 'ACTIVE' // ACTIVE, EXPIRED, REDEEMED, CANCELLED
}

// –ü—Ä–∞–≤–∏–ª–∞ —Å–≥–æ—Ä–∞–Ω–∏—è (–≤ LoyaltySystem)
{
  expiration_rules: {
    REGULAR_CHECK: 90, // –¥–Ω–∏
    BIRTHDAY_PROMO: 7,
    INACTIVITY_PROMO: 30,
    GIFT_ADD: 180,
    MANUAL_ADD: 365 // –ø–æ–¥–∞—Ä–æ–∫ –æ—Ç –∞–¥–º–∏–Ω–∞
  }
}

// –õ–æ–≥–∏–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
async function createBallTransaction(guestId, amount, sourceType) {
  const expirationRule = loyaltySystem.expiration_rules[sourceType];
  const expiresAt = new Date();
  expiresAt.setDate(expiresAt.getDate() + expirationRule);
  
  return db.BallTransaction.create({
    guest_card_id: guestId,
    amount: amount,
    source_type: sourceType,
    expires_at: expiresAt,
    created_at: new Date(),
    status: 'ACTIVE'
  });
}

// FIFO —Å–≥–æ—Ä–∞–Ω–∏–µ
// –ì–æ—Å—Ç –≤–∏–¥–∏—Ç –±–∞–ª–∞–Ω—Å 2500 –±–∞–ª–ª–æ–≤:
// - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 1: 1000 –±–∞–ª–ª–æ–≤, expires 01.02 ‚Üê –°–ì–û–†–ò–¢ –ü–ï–†–í–ê–Ø
// - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 2: 500 –±–∞–ª–ª–æ–≤, expires 15.02
// - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 3: 1000 –±–∞–ª–ª–æ–≤, expires 01.03

// 01.02 ‚Üí CRON —Å–≥–æ—Ä–∞–Ω–∏—è:
// –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—É—é (–ø–æ created_at) ACTIVE —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≥–¥–µ expires_at < NOW
SELECT * FROM BallTransaction 
WHERE guest_card_id = X 
  AND status = 'ACTIVE'
  AND expires_at < NOW()
ORDER BY created_at ASC
LIMIT 1

// –û–±–Ω–æ–≤–ª—è–µ–º:
UPDATE BallTransaction SET status = 'EXPIRED' WHERE id = ...
UPDATE GuestCard SET balance = balance - 1000 WHERE id = ...

// –†–µ–∑—É–ª—å—Ç–∞—Ç: –≥–æ—Å—Ç —Ç–µ–ø–µ—Ä—å –≤–∏–¥–∏—Ç 1500 –±–∞–ª–ª–æ–≤
```


***

### 1Ô∏è‚É£7Ô∏è‚É£ **–£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –û –°–ì–û–†–ê–ù–ò–ò –ë–ê–õ–õ–û–í**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ì–æ—Å—Ç –≤–∏–¥–∏—Ç —á—Ç–æ –µ–≥–æ –±–∞–ª–ª—ã —Å–≥–æ—Ä—è—Ç? –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?

**‚úÖ –ú–û–ô –í–´–ë–û–†:**

- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ 3, 7, 14 –¥–Ω–µ–π –¥–æ —Å–≥–æ—Ä–∞–Ω–∏—è
- –ö–∞–Ω–∞–ª—ã: Telegram, Email (Admin –≤—ã–±–∏—Ä–∞–µ—Ç)
- CRON job –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 23:00

```javascript
// CRON job
async function notifyAboutExpiringBalls() {
  // –ù–∞—Ö–æ–¥–∏–º –±–∞–ª–ª—ã –∫–æ—Ç–æ—Ä—ã–µ —Å–≥–æ—Ä—è—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 1-14 –¥–Ω–µ–π
  const expiringBalls = await db.BallTransaction.findAll({
    where: {
      status: 'ACTIVE',
      expires_at: {
        $gt: new Date(),
        $lt: new Date(Date.now() + 14*24*60*60*1000) // 14 –¥–Ω–µ–π
      }
    }
  });
  
  for (const ball of expiringBalls) {
    const daysUntilExpire = daysBetween(new Date(), ball.expires_at);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (daysUntilExpire === 14 || daysUntilExpire === 7 || daysUntilExpire === 3 || daysUntilExpire === 1) {
      const guest = await ball.guestCard.user;
      
      // Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      if (loyaltySystem.notify_telegram) {
        await telegramBot.sendMessage(guest.telegram_id, 
          `–í–∞—à–∏ ${ball.amount} –±–∞–ª–ª–æ–≤ —Å–≥–æ—Ä—è—Ç —á–µ—Ä–µ–∑ ${daysUntilExpire} –¥–Ω–µ–π!`
        );
      }
      
      // Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      if (loyaltySystem.notify_email) {
        await sendEmail(guest.email,
          `–í–Ω–∏–º–∞–Ω–∏–µ: –±–∞–ª–ª—ã —Å–≥–æ—Ä—è—Ç —á–µ—Ä–µ–∑ ${daysUntilExpire} –¥–Ω–µ–π`,
          `–£ –≤–∞—Å –µ—Å—Ç—å ${ball.amount} –±–∞–ª–ª–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ —Å–≥–æ—Ä—è—Ç ${ball.expires_at}`
        );
      }
      
      // –õ–æ–≥–∏—Ä—É–µ–º
      await db.ActivityLog.create({
        action: 'EXPIRATION_NOTIFICATION_SENT',
        guest_card_id: ball.guest_card_id,
        details: { days_left: daysUntilExpire }
      });
    }
  }
}
```


***

### 1Ô∏è‚É£8Ô∏è‚É£ **–ü–ï–†–ï–°–ß–ï–¢ –£–†–û–í–ù–ï–ô –õ–û–Ø–õ–¨–ù–û–°–¢–ò**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ì–æ—Å—Ç –Ω–∞–∫–æ–ø–∏–ª 149,000 —Ä—É–±–ª–µ–π (Silver: 50k-150k). –ü–æ—Ç—Ä–∞—Ç–∏–ª 2000, —Å—Ç–∞–ª 151,000. –ö–æ–≥–¥–∞ –ø–µ—Ä–µ–π–¥–µ—Ç –≤ Gold?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- A) Real-time (—Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —á–µ–∫–∞)
- B) –ù–æ—á—å (CRON –≤ 00:00)
- C) –í—Ä—É—á–Ω—É—é (Manager –∫–Ω–æ–ø–∫–∞)

**‚úÖ –ú–û–ô –í–´–ë–û–†: –í–∞—Ä–∏–∞–Ω—Ç B (CRON –≤ 00:00)**

**üéØ –ü–æ—á–µ–º—É:**

- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ (–Ω–µ –Ω—É–∂–µ–Ω realtime —Ä–∞—Å—á–µ—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —á–µ–∫–∞)
- ‚úÖ –õ–µ–≥–∫–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å
- ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ off-peak —á–∞—Å—ã (–Ω–æ—á—å)
- ‚úÖ –ü–∞–∫–µ—Ç–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)

**üíª –ê–ª–≥–æ—Ä–∏—Ç–º:**

```javascript
// CRON job –≤ 00:00 UTC
async function recalculateLoyaltyLevels() {
  // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ ACTIVE –∫–∞—Ä—Ç—ã
  const guestCards = await db.GuestCard.findAll({
    where: { status: 'ACTIVE' }
  });
  
  for (const card of guestCards) {
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º lifetime_spent
    const totalSpent = await db.BallTransaction.sum('checkAmount', {
      where: { guest_card_id: card.id, type: ['EARN', 'REDEEM'] }
    });
    
    // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å
    const newLevel = findLevelBySpent(totalSpent, loyaltySystem.levels);
    
    // –ï—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å –∏–∑–º–µ–Ω–∏–ª—Å—è
    if (newLevel.id !== card.loyalty_level_id) {
      const oldLevel = card.loyalty_level;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º
      await card.update({
        loyalty_level_id: newLevel.id,
        last_level_update: new Date()
      });
      
      // –õ–æ–≥–∏—Ä—É–µ–º
      await db.GuestLevelHistory.create({
        guest_card_id: card.id,
        old_level: oldLevel.name,
        new_level: newLevel.name,
        total_spent: totalSpent,
        reason: 'AUTOMATIC_RECALCULATION',
        changed_at: new Date()
      });
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      if (oldLevel.rank < newLevel.rank) { // UPGRADE
        await telegramBot.sendMessage(card.user.telegram_id,
          `üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —É—Ä–æ–≤–Ω—è ${newLevel.name}!`
        );
      } else if (oldLevel.rank > newLevel.rank) { // DOWNGRADE (–µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω)
        if (loyaltySystem.allow_downgrade) {
          await telegramBot.sendMessage(card.user.telegram_id,
            `–í–∞—à —É—Ä–æ–≤–µ–Ω—å –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ ${newLevel.name}`
          );
        }
      }
      
      // –õ–æ–≥–∏—Ä—É–µ–º –≤ ActivityLog
      await db.ActivityLog.create({
        action: 'LEVEL_CHANGE',
        guest_card_id: card.id,
        details: { from: oldLevel.name, to: newLevel.name }
      });
    }
  }
}

// –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ —É—Ä–æ–≤–Ω—è
function findLevelBySpent(totalSpent, levels) {
  // LoyaltyLevel: [
  //   { name: 'Bronze', min: 0, max: 50000 },
  //   { name: 'Silver', min: 50000, max: 150000 },
  //   { name: 'Gold', min: 150000, max: null }
  // ]
  
  return levels.find(level => 
    totalSpent >= level.min && (level.max === null || totalSpent < level.max)
  );
}
```


***

### 1Ô∏è‚É£9Ô∏è‚É£ **DOWNGRADE –£–†–û–í–ù–ï–ô**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ì–æ—Å—Ç –±—ã–ª Gold (150k+), –Ω–æ 90 –¥–Ω–µ–π –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω. Downgrade –Ω–∞ Silver?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- A) –ù–µ—Ç downgrade (–æ–¥–∏–Ω —Ä–∞–∑ Gold - –Ω–∞–≤—Å–µ–≥–¥–∞ Gold)
- B) –î–∞, downgrade –µ—Å–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω (180 –¥–Ω–µ–π)
- C) –ê–¥–º–∏–Ω –≤—ã–±–∏—Ä–∞–µ—Ç

**‚úÖ –ú–û–ô –í–´–ë–û–†: –í–∞—Ä–∏–∞–Ω—Ç C (Admin –≤—ã–±–∏—Ä–∞–µ—Ç)**

```javascript
// LoyaltySystem –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
{
  allow_downgrade: true, // default false
  downgrade_after_days: 180, // –µ—Å–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω 180 –¥–Ω–µ–π
  downgrade_threshold: 0.8, // downgrade –µ—Å–ª–∏ –ø–æ—Ç—Ä–∞—Ç–∏—Ç < 80% –æ—Ç –ø–æ—Ä–æ–≥–∞
}

// –ü—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ: –µ—Å–ª–∏ allow_downgrade = true
if (loyaltySystem.allow_downgrade && card.last_activity_at < 180 –¥–Ω–µ–π –Ω–∞–∑–∞–¥) {
  // Downgrade
}
```


***

## üéØ **–ë–õ–û–ö 5: –õ–ò–ú–ò–¢–´ –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê (4 –≤–æ–ø—Ä–æ—Å–∞)**

### 2Ô∏è‚É£0Ô∏è‚É£ **–ú–ê–ö–°–ò–ú–£–ú –ë–ê–õ–õ–û–í –ù–ê –ö–ê–†–¢–ï**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ì–æ—Å—Ç –Ω–∞–∫–æ–ø–∏–ª 100,000 –±–∞–ª–ª–æ–≤. –ú–æ–∂–Ω–æ –ª–∏ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –º–∞–∫—Å–∏–º—É–º?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- A) –ù–µ—Ç –ª–∏–º–∏—Ç–∞ (–±–µ–∑–ª–∏–º–∏—Ç)
- B) –ï—Å—Ç—å –ª–∏–º–∏—Ç (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è Admin)
- C) –†–∞–∑–Ω—ã–µ –ª–∏–º–∏—Ç—ã –ø–æ —É—Ä–æ–≤–Ω—è–º

**‚úÖ –ú–û–ô –í–´–ë–û–†: –í–∞—Ä–∏–∞–Ω—Ç B (Admin –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç)**

```javascript
// LoyaltySystem –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
{
  max_balls_per_guest: 100000, // –º–∞–∫—Å–∏–º—É–º –±–∞–ª–ª–æ–≤
  max_balls_behavior: 'CAP', // –∏–ª–∏ IGNORE, EXPIRE_OLDEST
  
  // max_balls_behavior:
  // - IGNORE: –µ—Å–ª–∏ –±–∞–ª–∞–Ω—Å > max, –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ –±–∞–ª–ª—ã
  // - CAP: –æ–±—Ä–µ–∑–∞–µ–º –¥–æ max (50000 + 1000 = 50000)
  // - EXPIRE_OLDEST: —Å–≥–æ—Ä–∞—é—Ç —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ –±–∞–ª–ª—ã
}

// –õ–æ–≥–∏–∫–∞
function calculateBalls(guest, checkAmount) {
  let balls = checkAmount * percentage / 100;
  
  if (guest.balance + balls > loyaltySystem.max_balls_per_guest) {
    if (loyaltySystem.max_balls_behavior === 'IGNORE') {
      return 0; // –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ–º
    } else if (loyaltySystem.max_balls_behavior === 'CAP') {
      balls = loyaltySystem.max_balls_per_guest - guest.balance;
    } else if (loyaltySystem.max_balls_behavior === 'EXPIRE_OLDEST') {
      // –ù–∞–π—Ç–∏ —Å–≥–æ—Ä–∞–µ–º—ã–µ –±–∞–ª–ª—ã –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å
    }
  }
  
  return balls;
}
```


***

### 2Ô∏è‚É£1Ô∏è‚É£ **–ú–ò–ù–ò–ú–£–ú –ë–ê–õ–õ–û–í –î–õ–Ø –°–ü–ò–°–ê–ù–ò–Ø**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ì–æ—Å—Ç –ø—ã—Ç–∞–µ—Ç—Å—è —Å–ø–∏—Å–∞—Ç—å 1 –±–∞–ª–ª (—Å–º–µ—à–Ω–æ). –ò–ª–∏ 100,000 –±–∞–ª–ª–æ–≤ (–Ω–∞ –≤–µ—Å—å —á–µ–∫).

**‚úÖ –ú–û–ô –í–´–ë–û–†:**

- –ú–∏–Ω–∏–º—É–º: 10 –±–∞–ª–ª–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- –ú–∞–∫—Å–∏–º—É–º: 50% –æ—Ç —Å—É–º–º—ã —á–µ–∫–∞
- –ú–∏–Ω–∏–º—É–º —á–µ–∫–∞: 100 —Ä—É–±–ª–µ–π

```javascript
{
  min_balls_to_redeem: 10,
  max_percent_to_redeem: 50, // –º–∞–∫—Å–∏–º—É–º 50% —á–µ–∫–∞ –±–∞–ª–ª–∞–º–∏
  min_check_amount: 100 // –º–∏–Ω–∏–º—É–º —á–µ–∫ 100 —Ä—É–±–ª–µ–π
}

// –õ–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
function validateBallsRedemption(checkAmount, ballsToRedeem, guest) {
  // –í–∞–ª–∏–¥–∞—Ü–∏—è 1: –º–∏–Ω–∏–º—É–º —á–µ–∫–∞
  if (checkAmount < loyaltySystem.min_check_amount) {
    throw new Error('–ß–µ–∫ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π');
  }
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è 2: –º–∏–Ω–∏–º—É–º –±–∞–ª–ª–æ–≤
  if (ballsToRedeem < loyaltySystem.min_balls_to_redeem) {
    throw new Error('–ú–∏–Ω–∏–º—É–º –±–∞–ª–ª–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è: ' + loyaltySystem.min_balls_to_redeem);
  }
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è 3: –º–∞–∫—Å–∏–º—É–º –ø—Ä–æ—Ü–µ–Ω—Ç
  const maxBalls = checkAmount * loyaltySystem.max_percent_to_redeem / 100;
  if (ballsToRedeem > maxBalls) {
    throw new Error(`–ú–∞–∫—Å–∏–º—É–º ${Math.floor(maxBalls)} –±–∞–ª–ª–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —á–µ–∫–∞`);
  }
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è 4: –±–∞–ª–∞–Ω—Å –≥–æ—Å—Ç—è
  if (ballsToRedeem > guest.balance) {
    throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤');
  }
  
  return true;
}
```


***

### 2Ô∏è‚É£2Ô∏è‚É£ **ROI –ü–†–û–ú–û-–ê–ö–¶–ò–ô**

**‚ùì –í–æ–ø—Ä–æ—Å:**
Birthday –ø—Ä–æ–º–æ –¥–∞–ª–∞ 1000 –±–∞–ª–ª–æ–≤ = 500 —Ä—É–±–ª–µ–π —Å–∫–∏–¥–∫–∏. –ì–æ—Å—Ç –ø–æ—Ç—Ä–∞—Ç–∏–ª –ø–æ—Ç–æ–º –µ—â–µ 5000 —Ä—É–±–ª–µ–π. ROI?

**‚úÖ –ú–û–ô –í–´–ë–û–†:**

- ROI = (Revenue –ø–æ—Å–ª–µ –ø—Ä–æ–º–æ - Cost –ø—Ä–æ–º–æ) / Cost –ø—Ä–æ–º–æ
- = (5000 - 500) / 500 = 900% (–æ—Ç–ª–∏—á–Ω–æ–µ!)

```javascript
// PromoBallGranted —Ç–∞–±–ª–∏—Ü–∞
{
  id: 'grant-1',
  promo_id: 'birthday-promo',
  guest_card_id: 'card-1',
  amount: 1000, // –±–∞–ª–ª–æ–≤ –≤—ã–¥–∞–Ω–Ω—ã—Ö
  estimated_cost: 500, // 1000 –±–∞–ª–ª–æ–≤ * 50% = 500 —Ä—É–±–ª–µ–π –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
  balls_redeemed: 800, // –∏–∑ 1000 –ø–æ—Ç—Ä–∞—Ç–∏–ª 800
  revenue_after_promo: 5000, // –ø–æ—Ç—Ä–∞—Ç–∏–ª –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π –ø–æ—Å–ª–µ
  roi: 900 // (5000 - 500) / 500
}

// Analytics –∑–∞–ø—Ä–æ—Å
GET /api/analytics/promo-roi?promo_id=birthday&period=month
{
  total_granted: 5000, // 5000 –≥–æ—Å—Ç–µ–π –ø–æ–ª—É—á–∏–ª–∏
  total_cost: 2_500_000, // –≤—Å–µ–≥–æ 2.5M —Ä—É–±–ª–µ–π —Å–∫–∏–¥–æ–∫
  total_revenue: 25_000_000, // –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ 25M
  average_roi: 900,
  roi_distribution: {
    negative: 100, // 100 –≥–æ—Å—Ç–µ–π –≤–æ–æ–±—â–µ –Ω–µ –ø—Ä–∏—à–ª–∏
    0_100: 500, // 500 –≥–æ—Å—Ç–µ–π –≤–æ–æ–±—â–µ –Ω–µ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏
    100_500: 2000, // ROI 100-500%
    500_1000: 1500, // ROI 500-1000%
    1000_plus: 900 // ROI 1000%+
  }
}
```


***

### 2Ô∏è‚É£3Ô∏è‚É£ **–ê–ù–ê–õ–ò–¢–ò–ö–ê –î–õ–Ø –ö–ê–ñ–î–û–ô –†–û–õ–ò**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ß—Ç–æ –≤–∏–¥–∏—Ç –∫–∞–∂–¥–∞—è —Ä–æ–ª—å –≤ Analytics?

**‚úÖ –ú–û–ô –í–´–ë–û–†:**


| –†–æ–ª—å | –í–∏–¥–∏—Ç |
| :-- | :-- |
| **OWNER** | –í—Å–µ –ø—Ä–æ–º–æ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ, ROI –∫–∞–∂–¥–æ–π, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, —Ç—Ä–µ–Ω–¥—ã |
| **RESTAURANT ADMIN** | –ü—Ä–æ–º–æ –≤ –µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ(–∞—Ö), ROI, –∫–∞–∫–∏–µ –≥–æ—Å—Ç–∏ –ø–æ–ª—É—á–∏–ª–∏, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ |
| **MANAGER** | –¢–æ–ª—å–∫–æ –ø–æ —Å–≤–æ–µ–º—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É, –∫–∞–∫–∏–µ –≥–æ—Å—Ç–∏ –ø–æ–ª—É—á–∏–ª–∏, —Å–∫–æ–ª—å–∫–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ |
| **CASHIER** | –ù–∏—á–µ–≥–æ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏) |
| **GUEST** | –°–≤–æ–∏ –±–∞–ª–ª—ã, –∏—Å—Ç–æ—Ä–∏—é, –∫–æ–≥–¥–∞ —Å–≥–æ—Ä—è—Ç |


***

## ‚ö° **–ë–õ–û–ö 6: –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–ï (2 –≤–æ–ø—Ä–æ—Å–∞)**

### 2Ô∏è‚É£4Ô∏è‚É£ **–ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨ –ü–†–ò 100K+ –ì–û–°–¢–ï–ô**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ü—Ä–∏ 100k+ –≥–æ—Å—Ç–µ–π –∫–∞–∫ –±—ã—Å—Ç—Ä–æ —Å—á–∏—Ç–∞—é—Ç—Å—è –±–∞–ª–ª—ã?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**

```javascript
// Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
const redis = new Redis();

// 1. –ö–µ—à –±–∞–ª–∞–Ω—Å–∞ –≥–æ—Å—Ç—è
cache_key: `guest_balance:{guest_card_id}`
ttl: 5 –º–∏–Ω—É—Ç

// 2. –ö–µ—à —É—Ä–æ–≤–Ω—è
cache_key: `guest_level:{guest_card_id}`
ttl: 24 —á–∞—Å–∞

// 3. –ö–µ—à –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–æ
cache_key: `active_promos:{restaurant_id}`
ttl: 1 —á–∞—Å

// 4. –ö–µ—à –ø—Ä–∞–≤–∏–ª
cache_key: `rules:{loyalty_system_id}:v{version}`
ttl: 24 —á–∞—Å–∞

// –ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–∏ —á–µ–∫–µ
async function calculateBalls(guest, checkAmount) {
  // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º Redis
  let level = await redis.get(`guest_level:{guest.id}`);
  
  if (!level) {
    // 2. –ï—Å–ª–∏ –Ω–µ –≤ –∫–µ—à–µ - —á–∏—Ç–∞–µ–º –∏–∑ –ë–î
    level = await db.GuestCard.findById(guest.id).loyaltyLevel;
    // 3. –ö–µ—à–∏—Ä—É–µ–º
    await redis.setex(`guest_level:{guest.id}`, 86400, level.id); // 24h
  }
  
  // 4. –ë–µ—Ä–µ–º –ø—Ä–∞–≤–∏–ª–∞
  let rules = await redis.get(`rules:{system.id}:v{version}`);
  if (!rules) {
    rules = await db.LoyaltyRuleVersion.getCurrent(system.id);
    await redis.setex(`rules:{system.id}:v{version}`, 86400, JSON.stringify(rules));
  }
  
  // 5. –°—á–∏—Ç–∞–µ–º –±–∞–ª–ª—ã (10-15 –º—Å)
  let balls = calculateBalls(level, rules, checkAmount);
  
  // 6. –õ–æ–≥–∏—Ä—É–µ–º –≤ –ë–î (50-70 –º—Å)
  await db.BallTransaction.create({ ... });
  
  // 7. –û–±–Ω–æ–≤–ª—è–µ–º Redis
  await redis.incr(`guest_balance:{guest.id}`, balls);
  
  return balls;
  // –í–°–ï–ì–û: ~150 –º—Å ‚úÖ
}

// –ò–Ω–¥–µ–∫—Å—ã –ë–î
CREATE INDEX idx_ball_transaction_guest_date 
  ON BallTransaction(guest_card_id, created_at DESC);
  
CREATE INDEX idx_ball_transaction_restaurant
  ON BallTransaction(restaurant_id, created_at DESC);
  
CREATE INDEX idx_loyalty_promo_active
  ON LoyaltyPromo(restaurant_id, is_active);
  
CREATE INDEX idx_guest_level
  ON GuestCard(loyalty_level_id);
```


***

### 2Ô∏è‚É£5Ô∏è‚É£ **–°–ö–û–†–û–°–¢–¨ –†–ê–°–ß–ï–¢–ê –ë–ê–õ–õ–û–í**

**‚ùì –í–æ–ø—Ä–æ—Å:**
100 —á–µ–∫–æ–≤ –≤ –º–∏–Ω—É—Ç—É. –ù—É–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–ª—ã < X –º—Å.

**‚úÖ –ú–û–ô –í–´–ë–û–†: < 200 –º—Å –Ω–∞ –æ–¥–∏–Ω —á–µ–∫**

```javascript
// Target: < 200 –º—Å
// 100 —á–µ–∫–æ–≤/–º–∏–Ω = 1.67 —á–µ–∫–∞/—Å–µ–∫
// 1000 —á–µ–∫–æ–≤/–º–∏–Ω = 16.7 —á–µ–∫–∞/—Å–µ–∫ (–ª–µ–≥–∫–æ!)

// Breakdown –≤—Ä–µ–º–µ–Ω–∏:
// 1. Redis GET (–±–∞–ª–∞–Ω—Å, —É—Ä–æ–≤–µ–Ω—å): 5 –º—Å
// 2. Redis GET (–ø—Ä–æ–º–æ, –ø—Ä–∞–≤–∏–ª–∞): 5 –º—Å
// 3. –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤: 10-15 –º—Å
// 4. –ë–î INSERT (BallTransaction): 50-70 –º—Å
// 5. Redis UPDATE (–±–∞–ª–∞–Ω—Å): 5 –º—Å
// 6. –°–µ—Ç–µ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 20-30 –º—Å
// ‚Äî‚Äî‚Äî
// –ò–¢–û–ì–û: ~150 –º—Å ‚úÖ

// –ù–∞ –ø–∏–∫–µ (1000 —á–µ–∫–æ–≤/–º–∏–Ω):
// 1000 —á–µ–∫–æ–≤ * 150 –º—Å = 150 —Å–µ–∫—É–Ω–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏
// –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ (–µ—Å—Ç—å buffer!)
```


***

## üîê **–ë–õ–û–ö 7: –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ò EDGE CASES (4 –≤–æ–ø—Ä–æ—Å–∞)**

### 2Ô∏è‚É£6Ô∏è‚É£ **GDPR –ò –£–î–ê–õ–ï–ù–ò–ï –î–ê–ù–ù–´–•**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ì–æ—Å—Ç –∑–∞–ø—Ä–æ—Å–∏–ª —É–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞—É–¥–∏—Ç?

**‚úÖ –ú–û–ô –í–´–ë–û–†: –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (soft delete)**

```javascript
// GuestProfile –∏ GuestCard —Å—Ç–∞—Ç—É—Å—ã
status ENUM: ACTIVE, FROZEN, BLOCKED, DELETED

// –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥–æ—Å—Ç—è
async function deleteGuest(guestId) {
  // 1. –®–∏—Ñ—Ä—É–µ–º –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  const encrypted = encrypt({
    name: guest.name,
    phone: guest.phone,
    email: guest.email,
    birth_date: guest.birth_date
  });
  
  // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
  await db.GuestProfile.update(
    { id: guestId },
    {
      status: 'DELETED',
      name: '[DELETED]',
      phone: '[DELETED]',
      email: '[DELETED]',
      encrypted_data: encrypted,
      deleted_at: new Date(),
      gdpr_deletion_id: generateId()
    }
  );
  
  // 3. –ò—Å—Ç–æ—Ä–∏—è –°–û–•–†–ê–ù–Ø–ï–¢–°–Ø (–¥–ª—è –∞—É–¥–∏—Ç–∞)
  // BallTransaction –æ—Å—Ç–∞–µ—Ç—Å—è
  // GuestCard –æ—Å—Ç–∞–µ—Ç—Å—è —Å balance –Ω–æ —Å—Ç–∞—Ç—É—Å DELETED
  
  // 4. –õ–æ–≥–∏—Ä—É–µ–º
  await db.ActivityLog.create({
    action: 'GUEST_DELETED_GDPR',
    guest_id: guestId,
    reason: 'GDPR_REQUEST'
  });
}

// –ì–æ—Å—Ç –≤–∏–¥–∏—Ç: —Ç–æ–ª—å–∫–æ —Å—É–º–º—É –ø–æ—Ç—Ä–∞—á–µ–Ω–æ (–Ω–µ –∏–º—è, –Ω–µ –±–∞–ª–ª—ã)
```


***

### 2Ô∏è‚É£7Ô∏è‚É£ **ORPHANED –ë–ê–õ–õ–´**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ì–æ—Å—Ç —É–¥–∞–ª–µ–Ω –Ω–æ –Ω–∞ –µ–≥–æ –∫–∞—Ä—Ç–µ 500 –±–∞–ª–ª–æ–≤. –ß—Ç–æ —Å –Ω–∏–º–∏?

**‚úÖ –ú–û–ô –í–´–ë–û–†: Monthly report**

```javascript
// Monthly job (1-–≥–æ —á–∏—Å–ª–∞)
async function generateOrphanedBallsReport() {
  // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º DELETED –Ω–æ balance > 0
  const orphanedCards = await db.GuestCard.findAll({
    where: { 
      status: 'DELETED', 
      balance: { $gt: 0 }
    }
  });
  
  const report = {
    total_cards: orphanedCards.length,
    total_balls: orphanedCards.reduce((sum, c) => sum + c.balance, 0),
    cards_and_balances: orphanedCards.map(c => ({
      card_id: c.id,
      balance: c.balance,
      deleted_at: c.deleted_at
    }))
  };
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Owner
  await sendReportToOwner(report);
  
  // –õ–æ–≥–∏—Ä—É–µ–º
  await db.ActivityLog.create({
    action: 'ORPHANED_BALLS_REPORT',
    details: report
  });
}

// Owner –º–æ–∂–µ—Ç —Ä–µ—à–∏—Ç—å:
// - –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –æ–±—â–∏–π —Ñ–æ–Ω–¥ (–ø–æ—Ç–µ—Ä—è)
// - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–º–æ
// - –û—Ç–¥–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–º –≥–æ—Å—Ç—è–º
```


***

### 2Ô∏è‚É£8Ô∏è‚É£ **–†–ê–°–°–ß–ï–¢ –ë–ê–õ–õ–û–í –ù–ï –°–û–í–ü–ê–î–ê–ï–¢**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ü–û–° —Ä–∞—Å—Å—á–∏—Ç–∞–ª 100 –±–∞–ª–ª–æ–≤, Backend —Ä–∞—Å—Å—á–∏—Ç–∞–ª 95. –ß—Ç–æ –¥–µ–ª–∞—Ç—å?

**‚úÖ –ú–û–ô –í–´–ë–û–†: Reconciliation job + alert Admin**

```javascript
// –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π Reconciliation job
async function reconcileBallsWithPOS() {
  // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —á–µ–∫–∞ –∑–∞ –¥–µ–Ω—å
  const transactions = await db.POSTransaction.findAll({
    created_at: { $gte: yesterday, $lt: today }
  });
  
  for (const posTx of transactions) {
    // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π BallTransaction
    const ballTx = await db.BallTransaction.findOne({
      post_transaction_id: posTx.id
    });
    
    if (ballTx) {
      const difference = Math.abs(posTx.balls - ballTx.amount);
      const percentDiff = difference / posTx.balls * 100;
      
      if (percentDiff > 1) { // –±–æ–ª–µ–µ 1% —Ä–∞–∑–Ω–∏—Ü–∞
        // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        await db.BallReconciliation.create({
          pos_transaction_id: posTx.id,
          expected_balls: ballTx.amount,
          actual_balls: posTx.balls,
          difference: difference,
          percent_diff: percentDiff,
          status: 'PENDING', // —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è
          resolved: false
        });
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º alert Admin
        await alertAdmin({
          type: 'BALL_CALCULATION_MISMATCH',
          details: {
            pos_tx: posTx.id,
            expected: ballTx.amount,
            actual: posTx.balls,
            restaurant: posTx.restaurant_id
          }
        });
      }
    }
  }
}

// Admin –º–æ–∂–µ—Ç:
// - –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–Ω–∏—Ü—É
// - –í—Ä—É—á–Ω—É—é –æ—Ç—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞—Ç—å
// - –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ RESOLVED
```


***

### 2Ô∏è‚É£9Ô∏è‚É£ **–î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï –ü–†–ê–í–ò–õ**

**‚ùì –í–æ–ø—Ä–æ—Å:**
–ú–æ–∂–µ—Ç –ª–∏ –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å—Å—è –∫ –æ–¥–Ω–æ–º—É —á–µ–∫—É –¥–≤–∞–∂–¥—ã?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

- A) –î–∞ (–±–∞–≥!)
- B) –ù–µ—Ç (unique constraint)
- C) –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**‚úÖ –ú–û–ô –í–´–ë–û–†: –í–∞—Ä–∏–∞–Ω—Ç B (Unique constraint)**

```javascript
// UNIQUE constraint –≤ –ë–î
CREATE UNIQUE INDEX idx_rule_application_unique ON ball_transactions(
  post_transaction_id, 
  loyalty_rule_id
);

// –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –æ–¥–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –º–∞–∫—Å–∏–º—É–º –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –æ–¥–∏–Ω —á–µ–∫!

// –ï—Å–ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –¥–≤–∞–∂–¥—ã:
// INSERT INTO ball_transactions (..., post_transaction_id, loyalty_rule_id)
// VALUES ('pos-123', 'rule-1', ...)
// INSERT INTO ball_transactions (..., post_transaction_id, loyalty_rule_id)
// VALUES ('pos-123', 'rule-1', ...) // ERROR: UNIQUE constraint violated!
```

---

# –û—Ç–≤–µ—á–∞—é –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã :

–ë–ª–æ–∫ 1:
1.B
2.B
3.A
4. –°—Ç–∞—Ä—ã–µ –±–∞–ª–ª—ã –û–°–¢–ê–Æ–¢–°–Ø (+1000 –¥–ª—è —Ç–µ—Ö –∫—Ç–æ –ø–æ–ª—É—á–∏–ª).
–ù–æ–≤—ã–µ –≥–æ—Å—Ç–∏ –ü–û–õ–£–ß–ê–¢ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (+500).
–ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è.     4.
5. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –≤—ã–±–æ—Ä, –∑–∞–ø—Ä–µ—Ç–∏—Ç—å.
6.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –≤—ã–±–æ—Ä.
7.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –≤—ã–±–æ—Ä, –Ω–æ —É—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ –≥–æ—Å—Ç–∏ –Ω–∏–∫–æ–≥–¥–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ –Ω–µ —Ç–µ—Ä—è—é—Ç —Å–≤–æ–π —É—Ä–æ–≤–µ–Ω—å(–ø—Ä–∏–º–µ—Ä: –µ—Å–ª–∏ –≥–æ—Å—Ç—å –±—ã–ª –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–∏–ª—å–≤–µ—Ä, –ø—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ –¥–æ–ª–∂–µ–Ω –±—ã–ª —É–ø–∞—Å—Ç—å –¥–æ –±—Ä–æ–Ω–∑, —Ç–æ –æ–Ω –≤—Å–µ —Ä–∞–≤–Ω–æ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–∏–ª—å–≤–µ—Ä —Å 0 —à–∫–∞–ª–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è. –ò —Ç–∞–∫ —Å –ª—é–±—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏ - –∏—Å–∫–ª—é—á–µ–Ω–∏–µ "Admin —É–¥–∞–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å –≤ —Ü–µ–ª–æ–º. –¢–æ–≥–¥–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–Ω –≤—ã–±–∏—Ä–∞–µ—Ç 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞," –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≥–æ—Å—Ç–µ–π –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –Ω–∏–∂–µ" –∏–ª–∏" –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≥–æ—Å—Ç–µ–π –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ", –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞, –≥–æ—Å—Ç–∏ —Å —É—Ä–æ–≤–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–º–µ—â–∞—é—Ç—Å—è, –∏ —É—Ä–æ–≤–µ–Ω—å –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å).
8.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –≤—ã–±–æ—Ä.
9.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –≤—ã–±–æ—Ä.
10.–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –≤—ã–±–æ—Ä.
–ë–ª–æ–∫ 2:
11.B
12.A
–ë–ª–æ–∫ 3:
13. C
14. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –≤—ã–±–æ—Ä.
15. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –≤—ã–±–æ—Ä.
–ë–ª–æ–∫ 4:
16. A. –ù–æ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∞–∫—Ü–∏–π —Å–≥–æ—Ä–∞–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø–æ —Å–≤–æ–µ–º—É. (–ö–∞–∫ –ø—Ä–∏–º–µ—Ä: Castom –∞–∫—Ü–∏—è "–î–∞—Ä–∏–º 500 –±–∞–ª–ª–æ–≤ –Ω–∞ –¥–µ–Ω—å –°–≤—è—Ç–æ–≥–æ –í–∞–ª–µ–Ω—Ç–∏–Ω–∞", admin –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ç–∞–∫, —á—Ç–æ 500 –±–∞–ª–ª–æ–≤ –≤—ã–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–∞–º—É –¥–∞—Ç—É –ø—Ä–∞–∑–¥–Ω–∏–∫–∞ –∏ –¥–µ–Ω—å –ø–æ—Å–ª–µ. –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –±–∞–ª–ª—ã –Ω–∞ –î–µ–Ω—å —Å–≤—è—Ç–æ–≥–æ –í–∞–ª–µ–Ω—Ç–∏–Ω–∞ —Å–≥–æ—Ä—è—Ç  –≤ –∫–æ–Ω—Ü–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è –ø—Ä–∞–∑–¥–Ω–∏–∫–∞, –∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–∞–ª–ª—ã –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ –≥–æ—Å—Ç—è, –∫–∞–∫ –ø–æ–ª–∞–≥–∞–µ—Ç—Å—è (–µ—Å–ª–∏ –∞–¥–º–∏–Ω –Ω–∞—Å—Ç—Ä–æ–∏–ª –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫), —á–µ—Ä–µ–∑ 90 –¥–Ω–µ–π —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã).
17. –í–∞–∂–Ω–æ! –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∏—Ö –ø–µ—Ä–∏–æ–¥—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏ –∫–∞–Ω–∞–ª—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç admin (–æ–Ω –º–æ–∂–µ—Ç –≤–æ–æ–±—â–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–≥–æ—Ä–∞–Ω–∏–∏ –Ω–µ –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤–æ–æ–±—â–µ, –∏–ª–∏ —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ —Å–≥–æ—Ä–∞–Ω–∏–∏ "–æ—Å–Ω–æ–≤–Ω—ã—Ö –±–∞–ª–ª–æ–≤"(–±–∞–ª–ª—ã –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –ø—É—Ç–µ–º –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–æ–π, –∞ –Ω–µ –∞–∫—Ü–∏—è–º–∏), –∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–≥–æ—Ä–∞–Ω–∏–∏ "–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤" –æ—Ç–º–µ–Ω–∏—Ç—å –∏ —Ç–¥.
CRON job –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 10:00.
18. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –≤—ã–±–æ—Ä.
19. A
–ë–ª–æ–∫ 5:
20. A
21. –ú–∏–Ω–∏–º—É–º: 1 –±–∞–ª–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é),
–ú–∞–∫—Å–∏–º—É–º: –î–µ—Ñ–æ–ª—Ç–Ω–æ - 20% –æ—Ç —Å—É–º–º—ã —á–µ–∫–∞, Admin –º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å (–æ—Ç 10 –¥–æ 100%).
–ú–∏–Ω–∏–º—É–º —á–µ–∫–∞: 50 —Ä—É–±–ª–µ–π, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥—Ä—É–≥—É—é —Å—É–º–º—É –Ω–µ–ª—å–∑—è.
22. –í–æ –ø–µ—Ä–≤—ã—Ö, 1 –±–∞–ª–ª –í–°–ï–ì–î–ê = 1 —Ä—É–±–ª—é (–≥–ª–æ–±–∞–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –∏ –æ–Ω–æ –Ω–µ–∏–∑–º–µ–Ω–Ω–æ) . –í–æ –≤—Ç–æ—Ä—ã—Ö. –ü–æ–∫–∞ –±–∞–ª–ª—ã –Ω–µ —Å–≥–æ—Ä–µ–ª–∏, –≥–æ—Å—Ç—å –º–æ–∂–µ—Ç –∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è. –í –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–ª—å, –í–°–ï–ì–î–ê, –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –±–∞–ª–ª–æ–≤ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ/–Ω–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –±–∞–ª–ª—ã, –∞ —É–∂–µ –ø–æ—Å–ª–µ, "–æ—Å–Ω–æ–≤–Ω—ã–µ" (–ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–Ω—ã–µ –ø—É—Ç–µ–º –ø–æ–∫—É–ø–æ–∫ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ/–Ω–∞—Ö) –±–∞–ª–ª—ã –∫–∞—Ä—Ç—ã (–ø—Ä–∏–º–µ—Ä: "—É –≥–æ—Å—Ç—è –∫–∞—Ä—Ç–∞ silver —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∫–µ—à–±–µ–∫ 10% –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ. –ù–∞ –∫–∞—Ä—Ç–µ 5000 "–æ—Å–Ω–æ–≤–Ω—ã—Ö" –±–∞–ª–ª–æ–≤, –Ω–∞ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –µ–º—É –ø—Ä–∏—à–ª–æ 1000 –±–∞–ª–ª–æ–≤, –µ–≥–æ —á–µ–∫ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å 10000 —Ä—É–±. –ì–æ—Å—Ç—å –∑–∞—Ö–æ—Ç–µ–ª —Å–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã, –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –æ–Ω –º–æ–∂–µ—Ç —Å–ø–∏—Å–∞—Ç—å 20% –æ—Ç —Å—É–º–º—ã —á–µ–∫–∞ –±–∞–ª–ª–∞–º–∏ = 2000 –±–∞–ª–ª–æ–≤. –ü—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Å –∫–∞—Ä—Ç—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Å–ø–∏—à—É—Ç—å—Å—è 1000" –∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö" –±–∞–ª–ª–æ–≤ –∏ 1000" "–æ—Å–Ω–æ–≤–Ω—ã—Ö" –±–∞–ª–ª–æ–≤ –∏,—Ç–∞–∫–∂–µ, –Ω–∞–∫–æ–ø—è—Ç—Å—è —Å —ç—Ç–æ–≥–æ —á–µ–∫–∞ 1000 –±–∞–ª–ª–æ–≤".–ü—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ –±–∞–ª–ª—ã –∏ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∏ –∫–æ–ø—è—Ç—Å—è –æ—Ç —á–µ–∫–∞, –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –∫–æ–ø—è—Ç—Å—è.
23. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –≤—ã–±–æ—Ä.
–ë–ª–æ–∫ 6:
24. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –≤—ã–±–æ—Ä. –ó–∞–¥–µ—Ä–∂–µ–∫ –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ.
25. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –≤—ã–±–æ—Ä.
–ë–ª–æ–∫ 7:
26. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –≤—ã–±–æ—Ä.
27. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –≤—ã–±–æ—Ä.
28. Reconciliation job + –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥ –¥–∞–Ω–Ω—ã–µ Pos. –£ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ —Å –∫–∞—Å—Å–æ–π –ø—Ä–æ–±–ª–µ–º –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ.
29.B

–£—á–∏—Ç—ã–≤–∞—è –æ—Ç–≤–µ—Ç—ã, –≤—ã–≤–µ–¥–∏ —Å—é–¥–∞ –≤ —á–∞—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ—Å–ª–µ –ø—Ä–∏—Å—Ç—É–ø–∏–º –∫ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–ª–æ–∫–∞

–ù–∏–∂–µ —Å–≤—ë–ª –≤—Å–µ —Ç–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã + –º–æ–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤ –µ–¥–∏–Ω—ã–π, —É–∂–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω Loyalty System.

***

## –ë–ª–æ–∫ 1. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—Ä–æ–≤–Ω–∏

### 1. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤

**–û—Ç–≤–µ—Ç:** B ‚Äî –±–∞–ª–ª—ã –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º, –∫–∞–∂–¥—ã–π —á–µ–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º, –¥–µ–π—Å—Ç–≤–æ–≤–∞–≤—à–∏–º –≤ –º–æ–º–µ–Ω—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏.
**–ò—Ç–æ–≥:**

- –í `BallTransaction` —Ö—Ä–∞–Ω–∏–º —Å—Å—ã–ª–∫—É –Ω–∞ `LoyaltyRuleVersion` –∏ `rule_snapshot`.
- –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, —Å—Ç–∞—Ä—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∏–∑–º–µ–Ω—è—é—Ç—Å—è.[^5_1]


### 2. –û—Ç–∫–∞—Ç –æ—à–∏–±–æ—á–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞

**–û—Ç–≤–µ—Ç:** B ‚Äî –æ—Ç–∫–∞—Ç = —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ —Å –∫–æ–ø–∏–µ–π —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞.
**–ò—Ç–æ–≥:**

- –ü—Ä–∏ –æ—Ç–∫–∞—Ç–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è, –∞–∫—Ç–∏–≤–Ω–∞—è ‚Äú—Å–µ–π—á–∞—Å‚Äù, —Å–æ —Å–Ω–∏–º–∫–æ–º —Å—Ç–∞—Ä–æ–π.
- –ë–∞–ª–ª—ã, –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –ø–æ –æ—à–∏–±–æ—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏, –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ–≤—ã–µ —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ –æ—Ç–∫–∞—Ç–∏–≤—à–µ–π—Å—è –≤–µ—Ä—Å–∏–∏.


### 3. –ü–µ—Ä–µ—Å—á—ë—Ç –±–∞–ª–ª–æ–≤ (emergency)

**–û—Ç–≤–µ—Ç:** A ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ background job.
**–ò—Ç–æ–≥:**

- –ï—Å—Ç—å —Å—É—â–Ω–æ—Å—Ç—å `RecalculationJob` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: –ø–µ—Ä–∏–æ–¥, —Å–µ–≥–º–µ–Ω—Ç –≥–æ—Å—Ç–µ–π, —Ä–µ–∂–∏–º (`RECALCULATE`, `ADJUST`, `NOTIFY_ONLY`).
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –ª–æ–≥–∏—Ä—É–µ—Ç –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –≥–æ—Å—Ç–µ–π –∏ –¥–µ–ª—å—Ç—É –ø–æ –±–∞–ª–ª–∞–º.


### 4. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞)

**–û—Ç–≤–µ—Ç:**

- –°—Ç–∞—Ä—ã–µ –ø—Ä–æ–º–æ-–±–∞–ª–ª—ã –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –≤—ã–¥–∞–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, +1000).
- –ù–æ–≤—ã–µ –≥–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—É—á–∞—é—Ç —É–∂–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, +500).
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è.
**–ò—Ç–æ–≥:**
- –í `PromoBallGranted` —Ç–æ–∂–µ —Ö—Ä–∞–Ω–∏–º `promo_rule_snapshot`, –∫–∞–∫ –∏ –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö.


### 5. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞

**–û—Ç–≤–µ—Ç:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–π –≤—ã–±–æ—Ä ‚Äî –∑–∞–ø—Ä–µ—Ç–∏—Ç—å.
**–ò—Ç–æ–≥:**

- –ù–∞ –æ–¥–∏–Ω `LoyaltyRule` –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ ‚Äú—Ç–µ–∫—É—â–∞—è‚Äù –≤–µ—Ä—Å–∏—è (–∞–∫—Ç–∏–≤–Ω–∞—è).
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è `active_to`.


### 6. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω–µ–π

**–û—Ç–≤–µ—Ç:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–π –≤—ã–±–æ—Ä.
**–ò—Ç–æ–≥:**

- –£—Ä–æ–≤–Ω–∏ (Bronze/Silver/Gold –∏ –∏—Ö –ø–æ—Ä–æ–≥–∏) –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `LoyaltyLevelVersion`.
- –ö–∞–∂–¥—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –≤–µ—Ä—Å–∏—é —É—Ä–æ–≤–Ω–µ–π –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–µ—Ä–µ—Å—á—ë—Ç–∞.


### 7. –ü–æ–≤–µ–¥–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ (–≤–∞–∂–Ω–æ–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ)

**–û—Ç–≤–µ—Ç:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–π –≤—ã–±–æ—Ä (–Ω–æ—á–Ω–æ–π –ø–µ—Ä–µ—Å—á—ë—Ç), –Ω–æ:

- –ì–æ—Å—Ç—å **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ç–µ—Ä—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ**.
- –ü—Ä–∏–º–µ—Ä: –±—ã–ª Silver, –ø–æ –Ω–æ–≤—ã–º –ø—Ä–∞–≤–∏–ª–∞–º –¥–æ–ª–∂–µ–Ω —É–ø–∞—Å—Ç—å –¥–æ Bronze ‚Äî **–æ—Å—Ç–∞—ë—Ç—Å—è Silver**, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ 0.
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: **Admin —É–¥–∞–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å**. –¢–æ–≥–¥–∞ –æ–Ω –¥–æ–ª–∂–µ–Ω –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:
    - ¬´–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≥–æ—Å—Ç–µ–π –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –Ω–∏–∂–µ¬ª, –∏–ª–∏
    - ¬´–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≥–æ—Å—Ç–µ–π –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ¬ª.
- –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –≤—Å–µ –≥–æ—Å—Ç–∏ —Å —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∏–≥—Ä–∏—Ä—É—é—Ç, –∏ —É—Ä–æ–≤–µ–Ω—å –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å.
**–ò—Ç–æ–≥:**
- `allow_downgrade = false` –∫–∞–∫ –∂—ë—Å—Ç–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á—ë—Ç–∞.
- –£–º–µ–Ω—å—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º –¥–µ–π—Å—Ç–≤–∏–∏ –∞–¥–º–∏–Ω–∞ ‚Äú—É–¥–∞–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å —Å –≤—ã–±–æ—Ä–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏‚Äù.[^5_2]


### 8. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –∏ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª

**–û—Ç–≤–µ—Ç:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–π –≤—ã–±–æ—Ä.
**–ò—Ç–æ–≥:**

- –õ—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–ø—Ä–æ—Ü–µ–Ω—Ç, —É—Å–ª–æ–≤–∏—è, —Å–µ–≥–º–µ–Ω—Ç—ã) –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤—É—é `LoyaltyRuleVersion`.


### 9. –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ –≤–µ—Ä—Å–∏–π

**–û—Ç–≤–µ—Ç:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–π –≤—ã–±–æ—Ä.
**–ò—Ç–æ–≥:**

- API: –º–æ–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –ø—Ä–∞–≤–∏–ª–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥; UI ‚Äî —Ç–∞–π–º–ª–∞–π–Ω –∏–∑–º–µ–Ω–µ–Ω–∏–π.


### 10. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤—Å–µ–π Loyalty System

**–û—Ç–≤–µ—Ç:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–π –≤—ã–±–æ—Ä.
**–ò—Ç–æ–≥:**

- –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ª–∏–º–∏—Ç—ã, —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤, –ø–æ–≤–µ–¥–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –∏ —Ç.–¥.) —Ç–æ–∂–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä—É—é—Ç—Å—è, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

***

## –ë–ª–æ–∫ 2. –ú–∏–≥—Ä–∞—Ü–∏—è UNIFIED / SEPARATE

### 11. –ú–∏–≥—Ä–∞—Ü–∏—è UNIFIED ‚Üí SEPARATE

**–û—Ç–≤–µ—Ç:** B ‚Äî –∫–∞—Ä—Ç–∞ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω (–±–∞–ª–ª—ã –Ω–µ –¥–µ–ª—è—Ç—Å—è, –∞ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è).
**–ò—Ç–æ–≥:**

- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Å—Ç—è:
    - —Å–æ–∑–¥–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–µ `GuestCard` –Ω–∞ –∫–∞–∂–¥—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω —Å —Ç–µ–º –∂–µ –±–∞–ª–∞–Ω—Å–æ–º –∏ —É—Ä–æ–≤–Ω–µ–º;
    - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–æ–≥—É—Ç –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å—Å—è (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏) –∏–ª–∏ —Å—Å—ã–ª–∫–∞–µ—Ç—Å—è –Ω–∞ –∏—Å—Ö–æ–¥–Ω—É—é (—á–µ—Ä–µ–∑ `migration_id`).
- –ì–æ—Å—Ç—å –≤ Telegram –≤–∏–¥–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ä—Ç –∏ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è.
- –°—Ç–∞—Ä–∞—è UNIFIED-–∫–∞—Ä—Ç–∞ –ª–∏–±–æ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `MIGRATED`, –ª–∏–±–æ –æ—Å—Ç–∞—ë—Ç—Å—è ‚Äú–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π‚Äù (–Ω–æ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ω–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö).


### 12. –ú–∏–≥—Ä–∞—Ü–∏—è SEPARATE ‚Üí UNIFIED

**–û—Ç–≤–µ—Ç:** A ‚Äî –±–∞–ª–ª—ã —Å—É–º–º–∏—Ä—É—é—Ç—Å—è.
**–ò—Ç–æ–≥:**

- –ù–æ–≤—ã–π UNIFIED-–±–∞–ª–∞–Ω—Å = —Å—É–º–º–∞ –±–∞–ª–∞–Ω—Å–æ–≤ –ø–æ –≤—Å–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º.
- –£—Ä–æ–≤–µ–Ω—å = –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É—Ä–æ–≤–Ω–µ–π.
- –°—Ç–∞—Ä—ã–µ SEPARATE-–∫–∞—Ä—Ç—ã –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `MIGRATED`, –Ω–æ–≤–∞—è UNIFIED ‚Äî –∞–∫—Ç–∏–≤–Ω–∞—è.

***

## –ë–ª–æ–∫ 3. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–æ–º–æ

### 13. –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–º–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

**–û—Ç–≤–µ—Ç:** C ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ Admin.
**–ò—Ç–æ–≥:**

- –í —Å–∏—Å—Ç–µ–º–µ –µ—Å—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (`COMBINE_ALL`, `MAX_ONLY`, `FIRST_ONLY` –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥—Ä.).
- –î–ª—è –ø–∞—Ä/–≥—Ä—É–ø–ø –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–æ–º–æ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å override-–ø—Ä–∞–≤–∏–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ‚Äú–î–† + –ø–µ—Ä–≤—ã–π —á–µ–∫ = —Ç–æ–ª—å–∫–æ –î–†‚Äù).[^5_3]


### 14. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–æ–º–æ

**–û—Ç–≤–µ—Ç:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–π –≤—ã–±–æ—Ä.
**–ò—Ç–æ–≥:**

- –ö–∞–∂–¥–æ–µ –ø—Ä–æ–º–æ –∏–º–µ–µ—Ç `priority` (0‚Äì1000).
- –ü—Ä–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è—Ö —Ç–∏–ø–∞ `FIRST_ONLY` –ø—Ä–æ–º–æ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É.


### 15. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ-–∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

**–û—Ç–≤–µ—Ç:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–π –≤—ã–±–æ—Ä.
**–ò—Ç–æ–≥:**

- –í `PromoBallGranted` —Å–æ—Ö—Ä–∞–Ω—è–µ–º: –∫–∞–∫–∏–µ –ø—Ä–æ–º–æ —Å—Ä–∞–±–æ—Ç–∞–ª–∏, –∫–∞–∫—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø—Ä–∏–º–µ–Ω–∏–ª–∏, –∫–∞–∫–∞—è —Å—É–º–º–∞ –±—ã–ª–∞ –±—ã –æ—Ç–¥–µ–ª—å–Ω–æ –∏ –∫–∞–∫–∞—è —Å—Ç–∞–ª–∞ –∏—Ç–æ–≥–æ–≤–æ–π.
- –û—Ç—á—ë—Ç—ã –ø–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Analytics.

***

## –ë–ª–æ–∫ 4. –°–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –∏ —É—Ä–æ–≤–Ω–∏

### 16. –°–≥–æ—Ä–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤

**–û—Ç–≤–µ—Ç:** A ‚Äî –∫–∞–∂–¥—ã–π `BallTransaction` –∏–º–µ–µ—Ç —Å–≤–æ–π `expires_at`, –Ω–æ:

- –î–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∞–∫—Ü–∏–π —Å—Ä–æ–∫ —Å–≥–æ—Ä–∞–Ω–∏—è **–º–æ–∂–µ—Ç –±—ã—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–º**.
- –ü—Ä–∏–º–µ—Ä: –∫–∞—Å—Ç–æ–º–Ω–∞—è –∞–∫—Ü–∏—è ‚Äú–î–∞—Ä–∏–º 500 –±–∞–ª–ª–æ–≤ –Ω–∞ –î–µ–Ω—å –°–≤—è—Ç–æ–≥–æ –í–∞–ª–µ–Ω—Ç–∏–Ω–∞‚Äù, –≤–∞–ª–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –¥–µ–Ω—å –ø—Ä–∞–∑–¥–Ω–∏–∫–∞ –∏ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å.
    - –≠—Ç–∏ 500 –±–∞–ª–ª–æ–≤ —Å–≥–æ—Ä—è—Ç **–≤ –∫–æ–Ω—Ü–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è**,
    - –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–∞–ª–ª—ã –∫–∞—Ä—Ç—ã ‚Äî –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –ø—Ä–∞–≤–∏–ª—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ 90 –¥–Ω–µ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ / –æ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è).
**–ò—Ç–æ–≥:**
- –î–ª—è –æ–±—ã—á–Ω—ã—Ö –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 90 –¥–Ω–µ–π).
- –î–ª—è –ø—Ä–æ–º–æ ‚Äî —Å–≤–æ–π `expiration_days` –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞.
- –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ –¥–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (`expires_at`).[^5_1]


### 17. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–≥–æ—Ä–∞–Ω–∏–∏

**–û—Ç–≤–µ—Ç:**

- CRON –≤ 10:00.
- –ü–µ—Ä–∏–æ–¥—ã –∏ –∫–∞–Ω–∞–ª—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π **–ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç Admin**:
    - –º–æ–∂–µ—Ç –æ—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–≤—Å–µ–º,
    - –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è ‚Äú–æ—Å–Ω–æ–≤–Ω—ã—Ö‚Äù –±–∞–ª–ª–æ–≤,
    - –º–æ–∂–µ—Ç –≤—ã–∫–ª—é—á–∏—Ç—å –¥–ª—è ‚Äú–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö‚Äù –∏ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –∏ —Ç.–ø.
**–ò—Ç–æ–≥:**
- –í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
    - –ø–µ—Ä–µ—á–µ–Ω—å –ø–æ—Ä–æ–≥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä 1, 3, 7, 14 –¥–Ω–µ–π ‚Äî –∫–∞–∂–¥—ã–π –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å),
    - —Ñ–ª–∞–≥–∏ –ø–æ —Ç–∏–ø–∞–º –±–∞–ª–ª–æ–≤ (`notify_regular`, `notify_promo`),
    - –≤—ã–±–æ—Ä –∫–∞–Ω–∞–ª–æ–≤: Telegram, email, –æ–±–∞ –∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ.


### 18. –ü–µ—Ä–µ—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π

**–û—Ç–≤–µ—Ç:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–π –≤—ã–±–æ—Ä ‚Äî –Ω–æ—á–Ω–æ–π CRON.
**–ò—Ç–æ–≥ —Å —É—á—ë—Ç–æ–º –ø.7:**

- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç lifetime-—Å—É–º–º.
- –£—Ä–æ–≤–µ–Ω—å **–º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ç–∏**, –Ω–µ –ø–∞–¥–∞—Ç—å (–∫—Ä–æ–º–µ —Å–ø–µ—Ü. –æ–ø–µ—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è).


### 19. Downgrade —É—Ä–æ–≤–Ω–µ–π

**–û—Ç–≤–µ—Ç:** A ‚Äî **–±–µ–∑** downgrade (–æ–¥–∏–Ω —Ä–∞–∑ –ø–æ–¥–Ω—è–ª—Å—è ‚Äî –Ω–∞–∑–∞–¥ –Ω–µ –ø–∞–¥–∞–µ—Ç).
**–ò—Ç–æ–≥:**

- `allow_downgrade = false` –∂—ë—Å—Ç–∫–æ.
- –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± ‚Äú–ø–æ–Ω–∏–∑–∏—Ç—å‚Äù ‚Äî –∞–¥–º–∏–Ω —É–¥–∞–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å –∏ —è–≤–Ω—ã–º –æ–±—Ä–∞–∑–æ–º —Ä–µ—à–∞–µ—Ç, –∫—É–¥–∞ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –≥–æ—Å—Ç–µ–π (–≤—ã—à–µ/–Ω–∏–∂–µ).

***

## –ë–ª–æ–∫ 5. –õ–∏–º–∏—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

### 20. –ú–∞–∫—Å–∏–º—É–º –±–∞–ª–ª–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ

**–û—Ç–≤–µ—Ç:** A ‚Äî –±–µ–∑–ª–∏–º–∏—Ç.
**–ò—Ç–æ–≥:**

- `max_balls_per_guest` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = ‚Äú–Ω–µ—Ç –ª–∏–º–∏—Ç–∞‚Äù.
- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É, –Ω–æ —Å–µ–π—á–∞—Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞: –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –±–µ–∑ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–ª–∫–∞.[^5_4]


### 21. –ú–∏–Ω–∏–º—É–º/–º–∞–∫—Å–∏–º—É–º —Å–ø–∏—Å–∞–Ω–∏—è

**–û—Ç–≤–µ—Ç:**

- –ú–∏–Ω–∏–º—É–º: 1 –±–∞–ª–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –Ω–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è?).
- –ú–∞–∫—Å–∏–º—É–º: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20% –æ—Ç —Å—É–º–º—ã —á–µ–∫–∞, Admin –º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç 10% –¥–æ 100%.
- –ú–∏–Ω–∏–º—É–º —á–µ–∫–∞: 50 —Ä—É–±–ª–µ–π, –º–µ–Ω—è—Ç—å –Ω–µ–ª—å–∑—è.
**–ò—Ç–æ–≥:**
- –í –∫–æ–Ω—Ñ–∏–≥–µ Loyalty System:
    - `min_balls_to_redeem = 1` (–∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞),
    - `min_check_amount_for_redeem = 50` (–∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞),
    - `max_percent_to_redeem` ‚Äî –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω [10; 100].


### 22. –°—Ç–æ–∏–º–æ—Å—Ç—å –±–∞–ª–ª–∞ –∏ –ø–æ—Ä—è–¥–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è —Ç–∏–ø–æ–≤ –±–∞–ª–ª–æ–≤

**–û—Ç–≤–µ—Ç:**

- 1 –±–∞–ª–ª –≤—Å–µ–≥–¥–∞ = 1 —Ä—É–±–ª—é ‚Äî **–≥–ª–æ–±–∞–ª—å–Ω–æ–µ –∏ –Ω–µ–∏–∑–º–µ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ**.
- –ü–æ–∫–∞ –±–∞–ª–ª—ã –Ω–µ —Å–≥–æ—Ä–µ–ª–∏, –≥–æ—Å—Ç—å –º–æ–∂–µ—Ç –∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.
- –ü—Ä–∏ **—Å–ø–∏—Å–∞–Ω–∏–∏** –≤—Å–µ–≥–¥–∞ —Å–Ω–∞—á–∞–ª–∞ —Ç—Ä–∞—Ç—è—Ç—Å—è **–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –±–∞–ª–ª—ã**, –∑–∞—Ç–µ–º **–æ—Å–Ω–æ–≤–Ω—ã–µ**.
- –ü—Ä–∏ **—á–µ–∫–µ**:
    - –≥–æ—Å—Ç—å –º–æ–∂–µ—Ç –æ–ø–ª–∞—Ç–∏—Ç—å –±–∞–ª–ª–∞–º–∏ –¥–æ `max_percent_to_redeem` –æ—Ç —Å—É–º–º—ã;
    - –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Äú–∏ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è, –∏ –∫–æ–ø—è—Ç—Å—è‚Äù –±–∞–ª–ª—ã:
        - –ø—Ä–∏–º–µ—Ä:
            - Silver, –∫–µ—à–±—ç–∫ 10%;
            - 5000 –æ—Å–Ω–æ–≤–Ω—ã—Ö, 1000 –∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö;
            - —á–µ–∫ 10 000 —Ä—É–±, –ª–∏–º–∏—Ç 20% = 2000 –±–∞–ª–ª–æ–≤;
            - —Å–ø–∏—à–µ—Ç—Å—è 1000 –∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö + 1000 –æ—Å–Ω–æ–≤–Ω—ã—Ö;
            - –Ω–∞—á–∏—Å–ª–∏—Ç—Å—è 1000 –Ω–æ–≤—ã—Ö (10% –æ—Ç 10 000);
            - –∏—Ç–æ–≥: ‚àí2000 (—Å–ø–∏—Å–∞–Ω–∏–µ) +1000 (–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ) = ‚àí1000 —á–∏—Å—Ç—ã–º–∏, –ø—Ä–∏ —ç—Ç–æ–º —Å–∫–∏–¥–∫–∞ –ø–æ —á–µ–∫—É 2000 —Ä—É–±.
**–ò—Ç–æ–≥:**
- –ü—Ä–∏ —Ä–µ–¥–µ–º–ø—à–µ–Ω–µ:
    - –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤–æ–∑–º–æ–∂–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É,
    - —Å–Ω–∞—á–∞–ª–∞ –ø–æ–≥–∞—à–∞–µ–º `promo`-–±–∞–ª–ª—ã (—Å–≥–æ—Ä–∞—é—â–∏–µ), –∑–∞—Ç–µ–º `regular`.
- –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤—Å–µ–≥–¥–∞ —Å –∏—Å—Ö–æ–¥–Ω–æ–π —Å—É–º–º—ã —á–µ–∫–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, —Å–∫–æ–ª—å–∫–æ —Å–ø–∏—Å–∞–Ω–æ –±–∞–ª–ª–∞–º–∏.


### 23. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ / ROI –ø—Ä–æ–º–æ

**–û—Ç–≤–µ—Ç:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–π –≤—ã–±–æ—Ä.
**–ò—Ç–æ–≥:**

- ROI –ø—Ä–æ–º–æ —Å—á–∏—Ç–∞–µ–º –≤ —Ä—É–±–ª—è—Ö (—Ç–∞–∫ –∫–∞–∫ 1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å, –≤—Å—ë –ª–∏–Ω–µ–π–Ω–æ):
    - cost = –≤—ã–¥–∞–Ω–Ω—ã–µ –∏ —Ä–µ–∞–ª—å–Ω–æ –ø–æ–≥–∞—à–µ–Ω–Ω—ã–µ –±–∞–ª–ª—ã;
    - revenue = –ø–æ–∫—É–ø–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–º–æ;
    - ROI = (revenue ‚àí cost) / cost.

***

## –ë–ª–æ–∫ 6. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### 24. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–µ—à

**–û—Ç–≤–µ—Ç:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–π –≤—ã–±–æ—Ä, ‚Äú–∑–∞–¥–µ—Ä–∂–µ–∫ –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ‚Äù.
**–ò—Ç–æ–≥:**

- Redis-–∫–µ—à –¥–ª—è –±–∞–ª–∞–Ω—Å–∞, —É—Ä–æ–≤–Ω—è, –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–æ –∏ –ø—Ä–∞–≤–∏–ª.
- –ò–Ω–¥–µ–∫—Å—ã –≤ –ë–î –ø–æ –≥–æ—Å—Ç—è–º, —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º, –¥–∞—Ç–∞–º.
- –ë—é–¥–∂–µ—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —á–µ–∫ ~150‚Äì200 –º—Å end-to-end.


### 25. –¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è —Ä–∞—Å—á—ë—Ç–∞

**–û—Ç–≤–µ—Ç:** –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–π –≤—ã–±–æ—Ä ‚Äî \< 200 –º—Å.
**–ò—Ç–æ–≥:**

- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –∫–µ—à–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É—é—Ç—Å—è –ø–æ–¥ —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ.

***

## –ë–ª–æ–∫ 7. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ edge cases

### 26. GDPR / —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Å—Ç—è

**–û—Ç–≤–µ—Ç:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–π –≤—ã–±–æ—Ä.
**–ò—Ç–æ–≥:**

- `GuestProfile`/`GuestCard` –ø–æ–ª—É—á–∞—é—Ç —Å—Ç–∞—Ç—É—Å `DELETED`.
- –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–∞—é—Ç—Å—è/—à–∏—Ñ—Ä—É—é—Ç—Å—è, –Ω–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ—Å—Ç–∞—ë—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞.
- –£—á–∞—Å—Ç–∏–µ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç—Å—è, –Ω–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤—ã—Ä—É—á–∫–µ –∏ —Å–ø–∏—Å–∞–Ω–∏—è–º —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –±–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.[^5_5]


### 27. Orphaned –±–∞–ª–ª—ã

**–û—Ç–≤–µ—Ç:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–π –≤—ã–±–æ—Ä.
**–ò—Ç–æ–≥:**

- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç –ø–æ ‚Äú–æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–º‚Äù –±–∞–ª–ª–∞–º –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–∞—Ö.
- Owner –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ, –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å/—Å–ø–∏—Å–∞—Ç—å.


### 28. –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞ –±–∞–ª–ª–æ–≤ —Å POS

**–û—Ç–≤–µ—Ç:** Reconciliation job + **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥ POS**.
**–ò—Ç–æ–≥:**

- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Å–≤–µ—Ä—è–µ—Ç –±–∞–ª–ª—ã –ø–æ —á–µ–∫–∞–º.
- –ï—Å–ª–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ, —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ –∑–Ω–∞—á–µ–Ω–∏–µ POS (POS —Å—á–∏—Ç–∞–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Å—É–º–º—ã –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤), –ø–ª—é—Å –ø–∏—à–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–µ.


### 29. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ –∫ –æ–¥–Ω–æ–º—É —á–µ–∫—É

**–û—Ç–≤–µ—Ç:** B ‚Äî –∑–∞–ø—Ä–µ—Ç–∏—Ç—å (unique).
**–ò—Ç–æ–≥:**

- –ù–∞ —É—Ä–æ–≤–Ω–µ –ë–î: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ `(post_transaction_id, loyalty_rule_id)`.
- –û–¥–Ω–æ –ø—Ä–∞–≤–∏–ª–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω–∏—Ç—å—Å—è –¥–≤–∞–∂–¥—ã –∫ –æ–¥–Ω–æ–º—É —á–µ–∫—É.

***

## –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ Loyalty System

- **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–∏–≥—Ä–∞—Ü–∏–∏, –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–æ–º–æ, —Å–≥–æ—Ä–∞–Ω–∏–µ, —É—Ä–æ–≤–Ω–∏, –ª–∏–º–∏—Ç—ã, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ GDPR ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã.**
- –ú–æ–¥–µ–ª—å —Å—Ç–∞–ª–∞ –µ—â—ë –±–æ–ª–µ–µ —á—ë—Ç–∫–æ–π –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π, —Å –∂—ë—Å—Ç–∫–∏–º–∏ –≥–∞—Ä–∞–Ω—Ç–∏—è–º–∏:
    - —É—Ä–æ–≤–Ω–∏ –Ω–µ –ø–∞–¥–∞—é—Ç,
    - 1 –±–∞–ª–ª = 1 —Ä—É–±–ª—å –≤—Å–µ–≥–¥–∞,
    - —Å–Ω–∞—á–∞–ª–∞ —Ç—Ä–∞—Ç—è—Ç—Å—è ‚Äú–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ‚Äù –±–∞–ª–ª—ã,
    - POS ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –ø—Ä–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è—Ö.

–ï—Å–ª–∏ –≤—Å—ë –≤—ã—à–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–≤–æ–∏–º –≤–∏–¥–µ–Ω–∏–µ–º, –º–æ–∂–µ–º –≤—ã–±–∏—Ä–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ (–∏–∑ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è: **Guests \& Loyalty Cards**, **Billing \& Subscriptions**, **Telegram Bot**, **Payments Integration**) –∏ —É–π—Ç–∏ –≤ —Ç–∞–∫–æ–π –∂–µ —É—Ä–æ–≤–µ–Ω—å –≥–ª—É–±–∏–Ω—ã.
<span style="display:none">[^5_10][^5_11][^5_12][^5_13][^5_14][^5_15][^5_16][^5_17][^5_18][^5_19][^5_6][^5_7][^5_8][^5_9]</span>
